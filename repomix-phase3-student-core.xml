This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
_components/
  BaseScoreCard.tsx
  DeletePlanButton.tsx
  DeleteScoreButton.tsx
  EmptyScoresState.tsx
  FilterBar.tsx
  GradeTabs.tsx
  MockExamTypeTabs.tsx
  MockMonthTabs.tsx
  MockScoreListTable.tsx
  PlanGroupActiveToggleDialog.tsx
  PlanGroupBulkDeleteDialog.tsx
  PlanGroupDeleteDialog.tsx
  PlanGroupList.tsx
  PlanGroupListItem.tsx
  PlanGroupListItemNew.tsx
  PlanGroupStatsCard.tsx
  ProgressInput.tsx
  RescheduleRecommendations.tsx
  ScoreCard.tsx
  ScoreCardGrid.tsx
  ScoreFilterBar.tsx
  ScoreForm.tsx
  ScoreFormModal.tsx
  ScoreListTable.tsx
  ScoreTypeTabs.tsx
  SemesterTabs.tsx
  SubjectGroupTabs.tsx
_shared/
  utils/
    contentTypeUtils.ts
    index.ts
    progressUtils.ts
  FilterBar.tsx
  index.ts
  PlanCard.tsx
  ProgressIndicator.tsx
  StatusBadge.tsx
[id]/
  edit/
    page.tsx
analysis/
  _components/
    AnalysisLayout.tsx
    InternalDetailAnalysis.tsx
    InternalGPAChart.tsx
    InternalSubjectTable.tsx
    MockComparisonTable.tsx
    MockDetailAnalysis.tsx
    MockTrendChart.tsx
  page.tsx
calendar/
  _components/
    CalendarPlanCard.tsx
    CalendarStats.tsx
    DayTimelineModal.tsx
    DayView.tsx
    MonthView.tsx
    PlanCalendarView.tsx
    StatCard.tsx
    TimelineItem.tsx
    WeekView.tsx
  _constants/
    contentIcons.ts
    timeBlocks.ts
  _types/
    plan.ts
  _utils/
    timelineUtils.ts
  page.tsx
dashboard/
  _components/
    CompareSection.tsx
    CourseAverageChart.tsx
    DashboardSubTabs.tsx
    InsightPanel.tsx
    IntegratedComparisonChart.tsx
    MockExamTrendSection.tsx
    ScoreConsistencyAnalysis.tsx
    ScoreTypeComparison.tsx
    SemesterChartsSection.tsx
    SemesterSummaryTable.tsx
    SubjectGradeHistoryChart.tsx
    SubjectTrendSection.tsx
    SummarySection.tsx
    WeakSubjectSection.tsx
    WeakSubjectsList.tsx
  _utils/
    scoreQueries.ts
  mock/
    _components/
      MockDetailedMetrics.tsx
      MockExamTypeComparisonChart.tsx
      MockInsightPanel.tsx
      MockPercentileDistributionChart.tsx
      MockSummarySection.tsx
      MockWeakSubjectSection.tsx
    page.tsx
  school/
    _components/
      SchoolDetailedMetrics.tsx
      SchoolGradeDistributionChart.tsx
      SchoolHeatmapChart.tsx
      SchoolInsightPanel.tsx
      SchoolSummarySection.tsx
      SchoolWeakSubjectSection.tsx
    page.tsx
  unified/
    _components/
      InfoMessage.tsx
      InternalAnalysisCard.tsx
      MetricCard.tsx
      MockAnalysisCard.tsx
      StrategyCard.tsx
      StudentProfileCard.tsx
    page.tsx
  _utils.ts
  page.tsx
generators/
  planDataPreparer.ts
group/
  [id]/
    _components/
      AutoRescheduleBanner.tsx
      ErrorBoundary.tsx
      GeneratePlansButton.tsx
      LogicalPlanList.tsx
      PlanGroupActionButtons.tsx
      PlanGroupCopyButton.tsx
      PlanGroupDeleteButton.tsx
      PlanGroupDetailTabs.tsx
      PlanGroupDetailView.tsx
      PlanGroupProgressCard.tsx
      PlanGroupStatusButtons.tsx
      PlanPreviewDialog.tsx
      PlanScheduleView.tsx
      RescheduleHistory.tsx
      ScheduleLoadingSkeleton.tsx
      TabLoadingSkeleton.tsx
    edit/
      page.tsx
    reschedule/
      _components/
        AdjustmentStep.tsx
        AffectedPlansList.tsx
        BatchAdjustmentPanel.tsx
        BeforeAfterComparison.tsx
        ConflictWarning.tsx
        ContentReplaceModal.tsx
        ContentSelectStep.tsx
        DateRangeSelector.tsx
        JobProgress.tsx
        PreviewStep.tsx
        RescheduleWizard.tsx
        RollbackButton.tsx
        SmartDateRangeSuggestions.tsx
      page.tsx
    page.tsx
input/
  _components/
    InternalScoreInput.tsx
    MockScoreInput.tsx
    ScoreInputLayout.tsx
  page.tsx
mock/
  [grade]/
    [month]/
      [exam-type]/
        _components/
          MockScoreCard.tsx
          MockScoreCardGrid.tsx
          MockScoreFormModal.tsx
          MockScoresTable.tsx
          MockScoresView.tsx
        page.tsx
new-group/
  _components/
    _panels/
      _modals/
        AcademyScheduleImportModal.tsx
        ExclusionImportModal.tsx
      AcademySchedulePanel.tsx
      ExclusionsPanel.tsx
      NonStudyTimeBlocksPanel.tsx
      SchedulePreviewPanel.tsx
      TimeConfigPanel.tsx
      TimeSettingsPanel.tsx
    _shared/
      hooks/
        useContentDetailsBatch.ts
      BlockSetTimeline.tsx
      ContentCard.tsx
      ContentRangeInput.tsx
      ContentSelectionProgress.tsx
      ContentSelector.tsx
      DateInput.tsx
      EditableField.tsx
      FieldError.tsx
      fieldErrorUtils.ts
      index.ts
      MasterContentsPanel.tsx
      RangeSettingModal.tsx
      RecommendedContentsPanel.tsx
      StudentContentsPanel.tsx
      UnifiedContentsView.tsx
    _summary/
      BasicInfoSummary.tsx
      CollapsibleSection.tsx
      ContentsSummary.tsx
      index.ts
      LearningVolumeSummary.tsx
      SectionSummary.tsx
      SubjectAllocationSummary.tsx
      SummaryCard.tsx
      TimeSettingsSummary.tsx
    hooks/
      usePlanPayloadBuilder.ts
      usePlanSubmission.ts
      useWizardValidation.ts
    Step1BasicInfo/
      hooks/
        useBlockSetManagement.ts
        usePeriodCalculation.ts
      BlockSetSection.tsx
      index.ts
      PeriodSection.tsx
      Step1BasicInfo.tsx
      WeekdaySelector.tsx
    Step3Contents/
      components/
        AddedContentList.tsx
        ContentItem.tsx
        ContentList.tsx
        ContentRangeSelector.tsx
        SelectionProgress.tsx
      hooks/
        useBatchContentDetails.ts
        useContentSelection.ts
      index.ts
      Step3Contents.tsx
      types.ts
      utils.ts
    Step4RecommendedContents/
      components/
        AddedContentsList.tsx
        RecommendationRequestForm.tsx
        RecommendedContentCard.tsx
        RecommendedContentsList.tsx
        RequiredSubjectItem.tsx
        RequiredSubjectsSection.tsx
      hooks/
        useContentSelection.ts
        useRangeEditor.ts
        useRecommendations.ts
        useRequiredSubjects.ts
      constants.ts
      Step4RecommendedContentsRefactored.tsx
      types.ts
    Step6FinalReview/
      hooks/
        useContentDetails.ts
        useContentInfos.ts
        useContentTotals.ts
        useInitialRanges.ts
        useRecommendedRanges.ts
      ComparisonTable.tsx
      ContentAllocationUI.tsx
      ContentList.tsx
      index.ts
      Step6FinalReview.tsx
      SubjectAllocationUI.tsx
      types.ts
    Step7ScheduleResult/
      MeasureRow.tsx
      PlanTable.tsx
      ScheduleItem.tsx
      ScheduleListByWeek.tsx
      ScheduleTableView.tsx
      scheduleTypes.ts
      scheduleUtils.ts
      TimelineBar.tsx
      TimeSlotsWithPlans.tsx
      WeekSection.tsx
    utils/
      fieldLockUtils.ts
      modeUtils.ts
      scheduleTransform.ts
      validationUtils.ts
    ContentMasterSearch.tsx
    PlanGroupActivationDialog.tsx
    PlanGroupWizard.tsx
    Step2TimeSettings.tsx
    Step3ContentSelection.tsx
    Step3SchedulePreview.tsx
    Step4RecommendedContents.tsx
    Step6Simplified.tsx
    Step7ScheduleResult.tsx
  page.tsx
school/
  [grade]/
    [semester]/
      _components/
        SchoolScoresTable.tsx
        SchoolScoresView.tsx
      [subject-group]/
        _components/
          DeleteSchoolScoreButton.tsx
        [id]/
          edit/
            _components/
              SchoolScoreEditForm.tsx
            page.tsx
        new/
          _components/
            SchoolScoreForm.tsx
      page.tsx
1730TimetableLogic.ts
admissionStrategy.ts
assignPlanTimes.ts
blocks.ts
calc.ts
contentResolver.ts
getGoalStatus.ts
getHistoryPattern.ts
getPlanCompletion.ts
getScoreTrend.ts
getStudyTime.ts
getWeakSubjects.ts
gradeColors.ts
gradeScoreUtils.ts
internalAnalysis.ts
mockAnalysis.ts
page.tsx
planDataLoader.ts
queries.ts
rangeRecommendation.ts
scheduleProcessor.ts
scheduler.ts
statusManager.ts
streak.ts
studyTime.ts
todayProgress.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="_components/DeletePlanButton.tsx">
"use client";

import { useTransition } from "react";
import { useRouter } from "next/navigation";
import { deleteStudentPlan } from "@/app/(student)/actions/planActions";

type DeletePlanButtonProps = {
  planId: string;
};

export function DeletePlanButton({ planId }: DeletePlanButtonProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  const handleDelete = () => {
    if (!confirm("ì •ë§ë¡œ ì´ í”Œëœì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      return;
    }

    startTransition(async () => {
      try {
        await deleteStudentPlan(planId);
        router.refresh();
      } catch (err) {
        alert(
          err instanceof Error ? err.message : "í”Œëœ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  return (
    <button
      type="button"
      onClick={handleDelete}
      disabled={isPending}
      className="inline-flex items-center justify-center rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-semibold text-red-700 transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"
    >
      {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
    </button>
  );
}
</file>

<file path="_components/FilterBar.tsx">
"use client";

import { FilterBar as SharedFilterBar, planPurposeFilter, sortOrderFilter } from "../_shared/FilterBar";

type FilterBarProps = {
  currentPlanPurpose?: string;
  currentSortOrder?: string;
};

export function FilterBar({ currentPlanPurpose, currentSortOrder = "desc" }: FilterBarProps) {
  return (
    <SharedFilterBar
      filters={[planPurposeFilter, sortOrderFilter]}
      basePath="/plan"
    />
  );
}
</file>

<file path="_components/PlanGroupActiveToggleDialog.tsx">
"use client";

import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";

type PlanGroupActiveToggleDialogProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  groupName: string | null;
  isActive: boolean;
  onConfirm: () => void;
  isPending: boolean;
};

export function PlanGroupActiveToggleDialog({
  open,
  onOpenChange,
  groupName,
  isActive,
  onConfirm,
  isPending,
}: PlanGroupActiveToggleDialogProps) {
  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title={isActive ? "í”Œëœ ê·¸ë£¹ ë¹„í™œì„±í™”" : "í”Œëœ ê·¸ë£¹ í™œì„±í™”"}
      description={
        groupName
          ? `"${groupName}" í”Œëœ ê·¸ë£¹ì„ ${isActive ? "ë¹„í™œì„±í™”" : "í™œì„±í™”"}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          : `ì´ í”Œëœ ê·¸ë£¹ì„ ${isActive ? "ë¹„í™œì„±í™”" : "í™œì„±í™”"}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      }
    >
      <DialogContent>
        <div className="flex flex-col gap-4">
          {isActive ? (
            <p className="text-sm text-gray-700">
              í”Œëœ ê·¸ë£¹ì„ ë¹„í™œì„±í™”í•˜ë©´ ì¼ì‹œì •ì§€ ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          ) : (
            <div className="flex flex-col gap-2">
              <p className="text-sm text-gray-700">
                í”Œëœ ê·¸ë£¹ì„ í™œì„±í™”í•˜ë©´ í˜„ì¬ í™œì„±í™”ëœ ë‹¤ë¥¸ í”Œëœ ê·¸ë£¹ì´ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
              </p>
              <p className="text-xs text-yellow-700">
                âš ï¸ í•œ ë²ˆì— í•˜ë‚˜ì˜ í”Œëœ ê·¸ë£¹ë§Œ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          )}
        </div>
      </DialogContent>
      <DialogFooter>
        <button
          type="button"
          onClick={() => onOpenChange(false)}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="button"
          onClick={onConfirm}
          disabled={isPending}
          className={`inline-flex items-center justify-center rounded-lg border px-4 py-2 text-sm font-semibold text-white transition disabled:cursor-not-allowed disabled:opacity-50 ${
            isActive
              ? "border-orange-300 bg-orange-600 hover:bg-orange-700"
              : "border-green-300 bg-green-600 hover:bg-green-700"
          }`}
        >
          {isPending ? "ì²˜ë¦¬ ì¤‘..." : isActive ? "ë¹„í™œì„±í™”" : "í™œì„±í™”"}
        </button>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="_components/PlanGroupBulkDeleteDialog.tsx">
"use client";

import { useTransition } from "react";
import { useRouter } from "next/navigation";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { deletePlanGroupAction } from "@/app/(student)/actions/planGroupActions";
import { useToast } from "@/components/ui/ToastProvider";

type PlanGroupBulkDeleteDialogProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  groupIds: string[];
  groupNames: (string | null)[];
};

export function PlanGroupBulkDeleteDialog({
  open,
  onOpenChange,
  groupIds,
  groupNames,
}: PlanGroupBulkDeleteDialogProps) {
  const router = useRouter();
  const toast = useToast();
  const [isPending, startTransition] = useTransition();

  const handleDelete = () => {
    if (groupIds.length === 0) {
      return;
    }

    startTransition(async () => {
      try {
        // ì—¬ëŸ¬ í”Œëœ ê·¸ë£¹ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ
        const results = await Promise.allSettled(
          groupIds.map((id) => deletePlanGroupAction(id))
        );

        const successCount = results.filter((r) => r.status === "fulfilled").length;
        const failureCount = results.filter((r) => r.status === "rejected").length;

        if (failureCount === 0) {
          toast.showSuccess(`${successCount}ê°œì˜ í”Œëœ ê·¸ë£¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else if (successCount > 0) {
          toast.showInfo(`${successCount}ê°œëŠ” ì‚­ì œë˜ì—ˆê³ , ${failureCount}ê°œëŠ” ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
        } else {
          toast.showError("í”Œëœ ê·¸ë£¹ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }

        onOpenChange(false);
        router.push("/plan", { scroll: true });
        router.refresh();
      } catch (error) {
        toast.showError(
          error instanceof Error
            ? error.message
            : "í”Œëœ ê·¸ë£¹ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title="í”Œëœ ê·¸ë£¹ ë‹¤ì¤‘ ì‚­ì œ"
      description={`${groupIds.length}ê°œì˜ í”Œëœ ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`}
      variant="destructive"
    >
      <DialogContent>
        <div className="flex flex-col gap-4">
          <p className="text-sm text-gray-700">
            ì„ íƒí•œ í”Œëœ ê·¸ë£¹ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </p>
          
          {groupNames.length > 0 && (
            <div className="max-h-48 overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-3">
              <ul className="flex flex-col gap-1">
                {groupNames.map((name, index) => (
                  <li key={index} className="text-sm text-gray-700">
                    â€¢ {name || "í”Œëœ ê·¸ë£¹"}
                  </li>
                ))}
              </ul>
            </div>
          )}

          <p className="text-xs text-red-600">
            âš ï¸ í”Œëœ ê·¸ë£¹ê³¼ ê´€ë ¨ëœ ëª¨ë“  í”Œëœì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.
          </p>
        </div>
      </DialogContent>
      <DialogFooter>
        <button
          type="button"
          onClick={() => onOpenChange(false)}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="button"
          onClick={handleDelete}
          disabled={isPending || groupIds.length === 0}
          className="inline-flex items-center justify-center rounded-lg border border-red-300 bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isPending ? "ì‚­ì œ ì¤‘..." : `${groupIds.length}ê°œ ì‚­ì œ`}
        </button>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="_components/PlanGroupDeleteDialog.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { deletePlanGroupAction } from "@/app/(student)/actions/planGroupActions";
import { useToast } from "@/components/ui/ToastProvider";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { PlanStatus } from "@/lib/types/plan";

type PlanGroupDeleteDialogProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  groupId: string;
  groupName: string | null;
  groupStatus?: PlanStatus;
  isCampPlan?: boolean;
};

export function PlanGroupDeleteDialog({
  open,
  onOpenChange,
  groupId,
  groupName,
  groupStatus,
  isCampPlan = false,
}: PlanGroupDeleteDialogProps) {
  const router = useRouter();
  const toast = useToast();
  const [isPending, startTransition] = useTransition();

  // ìº í”„ í”Œëœì€ ì‚­ì œ ë¶ˆê°€
  const canDeleteByStatus = groupStatus
    ? PlanStatusManager.canDelete(groupStatus)
    : true; // ìƒíƒœ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì‹œë„ (ì„œë²„ì—ì„œ ì²´í¬)
  const canDelete = !isCampPlan && canDeleteByStatus;

  const handleDelete = () => {
    if (isCampPlan) {
      toast.showError("ìº í”„ í”„ë¡œê·¸ë¨ í”Œëœì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìº í”„ ì°¸ì—¬ ë©”ë‰´ì—ì„œ ê´€ë¦¬í•´ì£¼ì„¸ìš”.");
      onOpenChange(false);
      return;
    }
    
    if (!canDelete && groupStatus) {
      toast.showError(
        `${PlanStatusManager.getConstraints(groupStatus).description}ì—ì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
      );
      onOpenChange(false);
      return;
    }

    startTransition(async () => {
      try {
        await deletePlanGroupAction(groupId);
        toast.showSuccess("í”Œëœ ê·¸ë£¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        onOpenChange(false);
        // ì‚­ì œ í›„ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™ ë° ìƒˆë¡œê³ ì¹¨
        router.push("/plan", { scroll: true });
        router.refresh();
      } catch (error) {
        toast.showError(
          error instanceof Error
            ? error.message
            : "í”Œëœ ê·¸ë£¹ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title="í”Œëœ ê·¸ë£¹ ì‚­ì œ"
      description={
        groupName
          ? `"${groupName}" í”Œëœ ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          : "ì´ í”Œëœ ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
      }
      variant="destructive"
    >
      <DialogContent>
        <div className="flex flex-col gap-4">
          {isCampPlan && (
            <div className="rounded-lg border border-orange-200 bg-orange-50 p-3">
              <p className="text-sm font-medium text-orange-800">
                ìº í”„ í”„ë¡œê·¸ë¨ í”Œëœì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </p>
              <p className="text-xs text-orange-700">
                ìº í”„ ì°¸ì—¬ ë©”ë‰´ì—ì„œ í”Œëœì„ ê´€ë¦¬í•´ì£¼ì„¸ìš”. ì œì¶œ ì „ê¹Œì§€ëŠ” ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
              </p>
            </div>
          )}
          {!canDelete && !isCampPlan && groupStatus && (
            <div className="flex flex-col gap-1 rounded-lg border border-yellow-200 bg-yellow-50 p-3">
              <p className="text-sm font-medium text-yellow-800">
                í˜„ì¬ ìƒíƒœì—ì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </p>
              <p className="text-xs text-yellow-700">
                {PlanStatusManager.getConstraints(groupStatus).description}
              </p>
            </div>
          )}
          {!isCampPlan && (
            <p className="text-sm text-gray-700">
              ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”Œëœ ê·¸ë£¹ê³¼ ê´€ë ¨ëœ ëª¨ë“  í”Œëœì´ í•¨ê»˜
              ì‚­ì œë©ë‹ˆë‹¤.
            </p>
          )}
        </div>
      </DialogContent>
      <DialogFooter>
        <button
          type="button"
          onClick={() => onOpenChange(false)}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="button"
          onClick={handleDelete}
          disabled={isPending || !canDelete}
          className="inline-flex items-center justify-center rounded-lg border border-red-300 bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
        </button>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="_components/PlanGroupList.tsx">
"use client";

import { useState } from "react";
import Link from "next/link";
import { EmptyState } from "@/components/molecules/EmptyState";
import { Trash2, CheckSquare, Square } from "lucide-react";
import { PlanGroup } from "@/lib/types/plan";
import { PlanGroupListItem } from "./PlanGroupListItem";
import { PlanGroupBulkDeleteDialog } from "./PlanGroupBulkDeleteDialog";

type PlanGroupListProps = {
  groups: PlanGroup[];
  planCounts: Map<string, number>; // groupId -> í”Œëœ ê°œìˆ˜
  planProgressData: Map<string, { completedCount: number; totalCount: number }>; // groupId -> ì§„í–‰ ìƒí™©
};

export function PlanGroupList({ groups, planCounts, planProgressData }: PlanGroupListProps) {
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [bulkDeleteDialogOpen, setBulkDeleteDialogOpen] = useState(false);

  const handleToggleSelect = (groupId: string) => {
    // ìº í”„ í”Œëœì€ ì„ íƒ ë¶ˆê°€
    const group = groups.find((g) => g.id === groupId);
    if (group && group.plan_type === "camp" && group.camp_invitation_id) {
      return;
    }
    
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(groupId)) {
        next.delete(groupId);
      } else {
        next.add(groupId);
      }
      return next;
    });
  };

  // ìº í”„ í”Œëœ ì œì™¸í•œ ê·¸ë£¹ ëª©ë¡
  const selectableGroups = groups.filter(
    (g) => !(g.plan_type === "camp" && g.camp_invitation_id)
  );
  const selectableGroupIds = new Set(selectableGroups.map((g) => g.id));
  const allSelectableSelected = 
    selectableGroups.length > 0 && 
    selectableGroups.every((g) => selectedIds.has(g.id));

  const handleSelectAll = () => {
    if (allSelectableSelected) {
      // ì „ì²´ í•´ì œ
      setSelectedIds(new Set());
    } else {
      // ìº í”„ í”Œëœ ì œì™¸í•˜ê³  ì „ì²´ ì„ íƒ
      setSelectedIds(new Set(selectableGroupIds));
    }
  };

  const handleBulkDelete = () => {
    if (selectedIds.size === 0) {
      return;
    }
    setBulkDeleteDialogOpen(true);
  };

  const handleBulkDeleteComplete = () => {
    setSelectedIds(new Set());
    setBulkDeleteDialogOpen(false);
  };

  const selectedGroups = groups.filter((g) => selectedIds.has(g.id));
  const selectedGroupNames = selectedGroups.map((g) => g.name);

  if (groups.length === 0) {
    return (
      <EmptyState
        icon="ğŸ“‹"
        title="ë“±ë¡ëœ í”Œëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤"
        description="ìƒˆë¡œìš´ í”Œëœ ê·¸ë£¹ì„ ë§Œë“¤ì–´ ê¸°ê°„ë³„ í•™ìŠµ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”."
        actionLabel="í”Œëœ ê·¸ë£¹ ìƒì„±í•˜ê¸°"
        actionHref="/plan/new-group"
      />
    );
  }

  const allSelected = allSelectableSelected;

  return (
    <>
      {/* ë‹¤ì¤‘ ì„ íƒ í—¤ë” */}
      {groups.length > 0 && (
        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-4 py-3">
          <button
            type="button"
            onClick={handleSelectAll}
            className="inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-100"
            title={allSelected ? "ì „ì²´ í•´ì œ" : "ì „ì²´ ì„ íƒ"}
            aria-label={allSelected ? "ì „ì²´ í•´ì œ" : "ì „ì²´ ì„ íƒ"}
          >
            {allSelected ? (
              <CheckSquare className="h-4 w-4" />
            ) : (
              <Square className="h-4 w-4" />
            )}
            <span>{allSelected ? "ì „ì²´ í•´ì œ" : "ì „ì²´ ì„ íƒ"}</span>
          </button>

          {selectedIds.size > 0 && (
            <div className="flex items-center gap-3">
              <span className="text-sm text-gray-600">
                {selectedIds.size}ê°œ ì„ íƒë¨
              </span>
              <button
                type="button"
                onClick={handleBulkDelete}
                className="inline-flex items-center gap-2 rounded-lg border border-red-300 bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700"
                title="ì„ íƒ ì‚­ì œ"
                aria-label="ì„ íƒí•œ í”Œëœ ê·¸ë£¹ ì‚­ì œ"
              >
                <Trash2 className="h-4 w-4" />
                ì„ íƒ ì‚­ì œ
              </button>
            </div>
          )}
        </div>
      )}

      <ul className="flex flex-col gap-4">
        {groups.map((group) => {
          const planCount = planCounts.get(group.id) || 0;
          const hasPlans = planCount > 0;
          const isSelected = selectedIds.has(group.id);
          const progressData = planProgressData.get(group.id);
          const completedCount = progressData?.completedCount || 0;
          const totalCount = progressData?.totalCount || planCount;
          
          return (
            <PlanGroupListItem
              key={group.id}
              group={group}
              planCount={planCount}
              hasPlans={hasPlans}
              completedCount={completedCount}
              totalCount={totalCount}
              isSelected={isSelected}
              onToggleSelect={() => handleToggleSelect(group.id)}
            />
          );
        })}
      </ul>

      <PlanGroupBulkDeleteDialog
        open={bulkDeleteDialogOpen}
        onOpenChange={(open) => {
          setBulkDeleteDialogOpen(open);
          if (!open) {
            setSelectedIds(new Set());
          }
        }}
        groupIds={Array.from(selectedIds)}
        groupNames={selectedGroupNames}
      />
    </>
  );
}
</file>

<file path="_components/PlanGroupListItem.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { Trash2, CheckSquare, Square, Eye } from "lucide-react";
import { PlanGroup } from "@/lib/types/plan";
import { PlanStatus } from "@/lib/types/plan";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { updatePlanGroupStatus } from "@/app/(student)/actions/planGroupActions";
import { useToast } from "@/components/ui/ToastProvider";
import { PlanGroupDeleteDialog } from "./PlanGroupDeleteDialog";
import { PlanGroupActiveToggleDialog } from "./PlanGroupActiveToggleDialog";
import { Badge } from "@/components/atoms/Badge";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import Button from "@/components/atoms/Button";
import { cn } from "@/lib/cn";
import {
  planPurposeLabels,
  schedulerTypeLabels,
} from "@/lib/constants/planLabels";

type PlanGroupListItemProps = {
  group: PlanGroup;
  planCount: number;
  hasPlans: boolean; // í”Œëœì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
  completedCount?: number; // ì™„ë£Œëœ í”Œëœ ê°œìˆ˜
  totalCount?: number; // ì „ì²´ í”Œëœ ê°œìˆ˜
  isSelected?: boolean;
  onToggleSelect?: () => void;
};

export function PlanGroupListItem({
  group,
  planCount,
  hasPlans,
  completedCount = 0,
  totalCount = 0,
  isSelected = false,
  onToggleSelect,
}: PlanGroupListItemProps) {
  const router = useRouter();
  const toast = useToast();
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [toggleDialogOpen, setToggleDialogOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  const isActive = group.status === "active";
  const isCompleted = group.status === "completed";

  // ìº í”„ í”Œëœ ì—¬ë¶€ í™•ì¸
  const isCampPlan = !!(group.plan_type === "camp" && group.camp_invitation_id);

  // í”Œëœì´ ìƒì„±ë˜ê³ , ì™„ë£Œ ìƒíƒœê°€ ì•„ë‹Œ ê²½ìš°ë§Œ í† ê¸€ ê°€ëŠ¥
  const canToggle = hasPlans && planCount > 0 && !isCompleted;

  // ìº í”„ í”Œëœì€ ì‚­ì œ ë¶ˆê°€ (ì œì¶œ ì „ê¹Œì§€ëŠ” ìˆ˜ì • ê°€ëŠ¥)
  const canDelete = !isCampPlan;

  const handleToggleActiveClick = () => {
    if (!canToggle) {
      if (!hasPlans || planCount === 0) {
        toast.showInfo("í”Œëœì´ ìƒì„±ëœ í›„ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      } else if (isCompleted) {
        toast.showInfo("ì™„ë£Œëœ í”Œëœ ê·¸ë£¹ì€ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
      return;
    }

    // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
    setToggleDialogOpen(true);
  };

  const handleToggleActiveConfirm = () => {
    // í™œì„± ìƒíƒœë©´ ì¼ì‹œì •ì§€ë¡œ, ì•„ë‹ˆë©´ í™œì„±ìœ¼ë¡œ ë³€ê²½
    const newStatus: PlanStatus = isActive ? "paused" : "active";

    // ìƒíƒœ ì „ì´ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    const currentStatus = group.status as PlanStatus;
    if (!PlanStatusManager.canTransition(currentStatus, newStatus)) {
      // ì €ì¥ë¨ì´ë‚˜ ì´ˆì•ˆ ìƒíƒœì—ì„œ activeë¡œ ì§ì ‘ ì „ì´ê°€ ì•ˆ ë˜ëŠ” ê²½ìš°
      if (currentStatus === "draft" || currentStatus === "saved") {
        // ì €ì¥ë¨ì´ë‚˜ ì´ˆì•ˆì—ì„œë„ activeë¡œ ì „ì´ ê°€ëŠ¥í•˜ë„ë¡ í—ˆìš©
        if (newStatus === "active") {
          // í—ˆìš©
        } else {
          toast.showError("ì´ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          setToggleDialogOpen(false);
          return;
        }
      } else {
        toast.showError("ì´ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        setToggleDialogOpen(false);
        return;
      }
    }

    startTransition(async () => {
      try {
        await updatePlanGroupStatus(group.id, newStatus);
        toast.showSuccess(
          isActive
            ? "í”Œëœ ê·¸ë£¹ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
            : "í”Œëœ ê·¸ë£¹ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
        );
        setToggleDialogOpen(false);
        router.refresh();
      } catch (error) {
        toast.showError(
          error instanceof Error ? error.message : "ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
        setToggleDialogOpen(false);
      }
    });
  };

  // ìƒì„¸ë³´ê¸° ì´ë™
  const handleViewClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    e.preventDefault();
    router.push(`/plan/group/${group.id}`, { scroll: true });
  };

  // í‘œì‹œí•  ìƒíƒœ ê²°ì • (ì™„ë£Œ ìƒíƒœë§Œ)
  const displayStatus = isCompleted
    ? { label: "ì™„ë£Œ", variant: "success" as const }
    : null;

  return (
    <li
      className={`group relative rounded-xl border bg-white p-4 shadow-sm transition-all duration-200 ${
        isSelected
          ? "border-blue-500 bg-blue-50 shadow-md ring-2 ring-blue-200"
          : "border-gray-200 hover:border-gray-300 hover:shadow-lg hover:-translate-y-0.5"
      }`}
    >
      <div className="flex flex-col gap-3">
        {/* 1ì¤„: ì²´í¬ë°•ìŠ¤ + ë±ƒì§€ (ì¢Œì¸¡) / ì•„ì´ì½˜ë“¤ (ìš°ì¸¡) */}
        <div className="flex items-center justify-between gap-3">
          {/* ì¢Œì¸¡: ì²´í¬ë°•ìŠ¤ + ë±ƒì§€ */}
          <div className="flex items-center gap-2">
            {onToggleSelect && !isCampPlan && (
              <button
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  e.preventDefault();
                  onToggleSelect();
                }}
                className="inline-flex items-center justify-center rounded-lg p-1 text-gray-700 transition hover:bg-gray-100 hover:text-gray-900 relative z-20"
                title={isSelected ? "ì„ íƒ í•´ì œ" : "ì„ íƒ"}
                aria-label={isSelected ? "ì„ íƒ í•´ì œ" : "ì„ íƒ"}
              >
                {isSelected ? (
                  <CheckSquare className="h-5 w-5 text-blue-600" />
                ) : (
                  <Square className="h-5 w-5" />
                )}
              </button>
            )}
            {onToggleSelect && isCampPlan && (
              <div className="inline-flex items-center justify-center rounded-lg p-1 text-gray-300 cursor-not-allowed">
                <Square className="h-5 w-5" />
              </div>
            )}
            <div className="flex flex-wrap items-center gap-1.5">
              {/* ìº í”„ í”Œëœ ë±ƒì§€ */}
              {isCampPlan && (
                <Badge variant="warning" size="sm">
                  ìº í”„ í”„ë¡œê·¸ë¨
                </Badge>
              )}
              {/* í”Œëœ ìƒì„± ì™„ë£Œ ë±ƒì§€ */}
              {hasPlans && planCount > 0 && (
                <Badge variant="info" size="sm">
                  í”Œëœ ìƒì„± ì™„ë£Œ
                </Badge>
              )}
            </div>
          </div>

          {/* ìš°ì¸¡: ë²„íŠ¼ë“¤ */}
          <div className="flex shrink-0 items-center gap-3 relative z-20">
            {/* ë³´ê¸° ë²„íŠ¼ */}
            <Button
              variant="ghost"
              size="sm"
              onClick={handleViewClick}
              className="text-gray-700 hover:text-gray-900 hover:bg-gray-100"
            >
              <div className="flex items-center gap-1">
                <Eye className="h-4 w-4" />
                <span>ë³´ê¸°</span>
              </div>
            </Button>

            {/* ì‚­ì œ ë²„íŠ¼ */}
            {canDelete ? (
              <Button
                variant="ghost"
                size="sm"
                onClick={(e) => {
                  e.stopPropagation();
                  e.preventDefault();
                  setDeleteDialogOpen(true);
                }}
                className="text-gray-700 hover:text-red-600 hover:bg-red-50"
              >
                <div className="flex items-center gap-1">
                  <Trash2 className="h-4 w-4" />
                  <span>ì‚­ì œ</span>
                </div>
              </Button>
            ) : (
              <Button
                variant="ghost"
                size="sm"
                disabled
                className="text-gray-300 cursor-not-allowed"
                title="ìº í”„ í”Œëœì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              >
                <div className="flex items-center gap-1">
                  <Trash2 className="h-4 w-4" />
                  <span>ì‚­ì œ</span>
                </div>
              </Button>
            )}

            {/* í™œì„±/ë¹„í™œì„± í† ê¸€ ìŠ¤ìœ„ì¹˜ */}
            <div className="group relative">
              <button
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  e.preventDefault();
                  handleToggleActiveClick();
                }}
                disabled={isPending || !canToggle}
                className={cn(
                  "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:cursor-not-allowed disabled:opacity-50",
                  isActive ? "bg-green-600" : "bg-gray-200"
                )}
                aria-label={isActive ? "ë¹„í™œì„±í™”" : "í™œì„±í™”"}
                title={
                  !canToggle
                    ? "í”Œëœì´ ìƒì„±ëœ í›„ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
                    : isActive
                    ? "ë¹„í™œì„±í™”"
                    : "í™œì„±í™”"
                }
              >
                <span
                  className={cn(
                    "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                    isActive ? "translate-x-6" : "translate-x-1"
                  )}
                />
              </button>
              
              {/* ë¹„í™œì„±í™” ìƒíƒœì¼ ë•Œ íˆ´íŒ í‘œì‹œ */}
              {!canToggle && (
                <div className="pointer-events-none absolute bottom-full right-0 hidden w-48 rounded-lg bg-gray-900 px-3 py-2 text-xs text-white opacity-0 shadow-lg transition-opacity group-hover:block group-hover:opacity-100 z-50" style={{ marginBottom: '0.5rem' }}>
                  <div className="whitespace-normal break-words">
                    {!hasPlans || planCount === 0
                      ? "í”Œëœì´ ìƒì„±ëœ í›„ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
                      : isCompleted
                      ? "ì™„ë£Œëœ í”Œëœ ê·¸ë£¹ì€ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                      : "í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}
                  </div>
                  {/* íˆ´íŒ í™”ì‚´í‘œ */}
                  <div className="absolute bottom-0 right-4 translate-y-full">
                    <div className="border-4 border-transparent border-t-gray-900"></div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* ì œëª© ì˜ì—­: ì œëª© (ì¢Œì¸¡) + ìƒíƒœ ë±ƒì§€ (ìš°ì¸¡) */}
        <div className="flex items-center justify-between gap-3">
          <h3 className="break-words text-base font-semibold text-gray-900">
            {group.name || "í”Œëœ ê·¸ë£¹"}
          </h3>
          {/* ìƒíƒœ ë±ƒì§€ (ì™„ë£Œ ë˜ëŠ” í™œì„± ìƒíƒœë§Œ í‘œì‹œ) */}
          {displayStatus && (
            <Badge variant={displayStatus.variant} size="sm">
              {displayStatus.label}
            </Badge>
          )}
        </div>

        {/* ì½˜í…ì¸  ì˜ì—­ */}
        <div className="flex flex-col gap-3">

          <div className="flex flex-col gap-3">
            {/* ì§„í–‰ë¥  */}
            {hasPlans && planCount > 0 && totalCount > 0 && (
              <div className="rounded-lg border border-gray-100 bg-gray-50 p-2.5">
                <div className="flex flex-col gap-2">
                  <div className="flex items-center justify-between gap-2">
                    <span className="text-xs font-medium text-gray-600">
                      ì§„í–‰ë¥ 
                    </span>
                    <span className="text-xs font-semibold text-gray-900">
                      {completedCount}/{totalCount}ê°œ ì™„ë£Œ
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="flex-1">
                      <ProgressBar
                        value={Math.round((completedCount / totalCount) * 100)}
                        size="sm"
                        variant={
                          completedCount === totalCount
                            ? "success"
                            : completedCount > 0
                            ? "default"
                            : "warning"
                        }
                      />
                    </div>
                    <span className="text-xs font-medium text-gray-600">
                      {Math.round((completedCount / totalCount) * 100)}%
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* ëª©ì  */}
            <div className="break-words text-sm text-gray-600">
              <span className="text-gray-800">ëª©ì : </span>
              <span className="font-medium text-gray-900">
                {group.plan_purpose
                  ? planPurposeLabels[group.plan_purpose] || group.plan_purpose
                  : "â€”"}
              </span>
            </div>

            {/* ìŠ¤ì¼€ì¤„ëŸ¬ */}
            <div className="break-words text-sm text-gray-600">
              <span className="text-gray-800">ìŠ¤ì¼€ì¤„ëŸ¬: </span>
              <span className="font-medium text-gray-900">
                {group.scheduler_type
                  ? schedulerTypeLabels[group.scheduler_type] ||
                    group.scheduler_type
                  : "â€”"}
              </span>
            </div>

            {/* ê¸°ê°„ */}
            <div className="break-words text-sm text-gray-600">
              <span className="text-gray-800">ê¸°ê°„: </span>
              <span className="font-medium text-gray-900">
                {group.period_start && group.period_end
                  ? `${new Date(group.period_start).toLocaleDateString(
                      "ko-KR",
                      { year: "numeric", month: "long", day: "numeric" }
                    )} ~ ${new Date(group.period_end).toLocaleDateString(
                      "ko-KR",
                      { year: "numeric", month: "long", day: "numeric" }
                    )}`
                  : "â€”"}
              </span>
            </div>

            {/* í•˜ë‹¨ ë©”íƒ€ ì •ë³´ */}
            <div className="flex items-center justify-between border-t border-gray-100 pt-2">
              <p className="text-xs text-gray-800">
                {group.created_at
                  ? new Date(group.created_at).toLocaleDateString("ko-KR", {
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                    })
                  : "â€”"}
              </p>
              {hasPlans && planCount > 0 && totalCount === 0 && (
                <span className="text-xs text-gray-800">
                  {planCount}ê°œ í”Œëœ
                </span>
              )}
            </div>
          </div>
        </div>
      </div>

      <PlanGroupDeleteDialog
        open={deleteDialogOpen}
        onOpenChange={setDeleteDialogOpen}
        groupId={group.id}
        groupName={group.name}
        groupStatus={group.status as any}
        isCampPlan={isCampPlan}
      />

      <PlanGroupActiveToggleDialog
        open={toggleDialogOpen}
        onOpenChange={setToggleDialogOpen}
        groupName={group.name}
        isActive={isActive}
        onConfirm={handleToggleActiveConfirm}
        isPending={isPending}
      />
    </li>
  );
}
</file>

<file path="_components/PlanGroupListItemNew.tsx">
"use client";

import { useState, useTransition } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Trash2, Eye, Power, PowerOff, CheckSquare, Square } from "lucide-react";
import { PlanGroup } from "@/lib/types/plan";
import { PlanStatus } from "@/lib/types/plan";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { updatePlanGroupStatus } from "@/app/(student)/actions/planGroupActions";
import { useToast } from "@/components/ui/ToastProvider";
import { PlanGroupCard } from "../_shared/PlanCard";
import { StatusBadge } from "../_shared/StatusBadge";
import { PlanGroupDeleteDialog } from "./PlanGroupDeleteDialog";
import { PlanGroupActiveToggleDialog } from "./PlanGroupActiveToggleDialog";
import {
  planPurposeLabels,
  schedulerTypeLabels,
} from "@/lib/constants/planLabels";

type PlanGroupListItemProps = {
  group: PlanGroup;
  planCount: number;
  hasPlans: boolean;
  completedCount?: number;
  totalCount?: number;
  isSelected?: boolean;
  onToggleSelect?: () => void;
};

export function PlanGroupListItem({ 
  group, 
  planCount, 
  hasPlans,
  completedCount = 0,
  totalCount = 0,
  isSelected = false,
  onToggleSelect,
}: PlanGroupListItemProps) {
  const router = useRouter();
  const toast = useToast();
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [toggleDialogOpen, setToggleDialogOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  const isActive = group.status === "active";
  const isCompleted = group.status === "completed";
  const isCancelled = group.status === "cancelled";
  
  const isCampPlan = !!(group.plan_type === "camp" && group.camp_invitation_id);
  const canToggle = hasPlans && planCount > 0 && !isCompleted && !isCancelled;
  const canDelete = !isCampPlan;

  const handleToggleActiveClick = () => {
    if (!canToggle) {
      if (!hasPlans || planCount === 0) {
        toast.showInfo("í”Œëœì´ ìƒì„±ëœ í›„ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      } else {
        toast.showInfo("ì™„ë£Œ ë˜ëŠ” ì¤‘ë‹¨ëœ í”Œëœ ê·¸ë£¹ì€ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
      return;
    }
    setToggleDialogOpen(true);
  };

  const handleToggleActiveConfirm = () => {
    const newStatus: PlanStatus = isActive ? "paused" : "active";
    const currentStatus = group.status as PlanStatus;
    
    if (!PlanStatusManager.canTransition(currentStatus, newStatus)) {
      if (currentStatus === "draft" || currentStatus === "saved") {
        if (newStatus !== "active") {
          toast.showError("ì´ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          setToggleDialogOpen(false);
          return;
        }
      } else {
        toast.showError("ì´ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        setToggleDialogOpen(false);
        return;
      }
    }

    startTransition(async () => {
      try {
        await updatePlanGroupStatus(group.id, newStatus);
        toast.showSuccess(
          isActive 
            ? "í”Œëœ ê·¸ë£¹ì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤." 
            : "í”Œëœ ê·¸ë£¹ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
        );
        setToggleDialogOpen(false);
        router.refresh();
      } catch (error) {
        toast.showError(
          error instanceof Error
            ? error.message
            : "ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
        setToggleDialogOpen(false);
      }
    });
  };

  // Prepare badges
  const badges = [];
  if (isCampPlan) {
    badges.push({ label: "ìº í”„ í”„ë¡œê·¸ë¨", variant: "warning" as const });
  }
  if (hasPlans && planCount > 0) {
    badges.push({ label: "í”Œëœ ìƒì„± ì™„ë£Œ", variant: "info" as const });
  }

  // Prepare metadata
  const metadata = [
    { 
      label: "ëª©ì ", 
      value: group.plan_purpose ? planPurposeLabels[group.plan_purpose] || group.plan_purpose : "â€”" 
    },
    { 
      label: "ìŠ¤ì¼€ì¤„ëŸ¬", 
      value: group.scheduler_type ? schedulerTypeLabels[group.scheduler_type] || group.scheduler_type : "â€”" 
    },
    {
      label: "ê¸°ê°„",
      value: group.period_start && group.period_end
        ? `${new Date(group.period_start).toLocaleDateString("ko-KR", { 
            year: "numeric", month: "long", day: "numeric" 
          })} ~ ${new Date(group.period_end).toLocaleDateString("ko-KR", { 
            year: "numeric", month: "long", day: "numeric" 
          })}`
        : "â€”"
    },
  ];

  // Prepare actions
  const actions = (
    <>
      <Link
        href={`/plan/group/${group.id}`}
        className="inline-flex items-center justify-center rounded-lg p-1.5 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600"
        aria-label="í”Œëœ ê·¸ë£¹ ìƒì„¸ ë³´ê¸°"
        title="ìƒì„¸ ë³´ê¸°"
      >
        <Eye className="h-4 w-4" />
      </Link>
      {canToggle && (
        <button
          type="button"
          onClick={handleToggleActiveClick}
          disabled={isPending}
          className={`inline-flex items-center justify-center rounded-lg p-1.5 transition disabled:cursor-not-allowed disabled:opacity-50 ${
            isActive
              ? "text-green-600 hover:bg-green-50"
              : "text-gray-400 hover:bg-gray-100 hover:text-gray-600"
          }`}
          aria-label={isActive ? "í”Œëœ ê·¸ë£¹ ë¹„í™œì„±í™”" : "í”Œëœ ê·¸ë£¹ í™œì„±í™”"}
          title={isActive ? "ë¹„í™œì„±í™”" : "í™œì„±í™”"}
        >
          {isActive ? <PowerOff className="h-4 w-4" /> : <Power className="h-4 w-4" />}
        </button>
      )}
      {canDelete ? (
        <button
          type="button"
          onClick={() => setDeleteDialogOpen(true)}
          className="inline-flex items-center justify-center rounded-lg p-1.5 text-gray-400 transition hover:bg-red-50 hover:text-red-600"
          aria-label="í”Œëœ ê·¸ë£¹ ì‚­ì œ"
          title="ì‚­ì œ"
        >
          <Trash2 className="h-4 w-4" />
        </button>
      ) : (
        <button
          type="button"
          disabled
          className="inline-flex items-center justify-center rounded-lg p-1.5 text-gray-300 cursor-not-allowed"
          aria-label="ìº í”„ í”Œëœì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          title="ìº í”„ í”Œëœì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        >
          <Trash2 className="h-4 w-4" />
        </button>
      )}
    </>
  );

  const shouldShowStatus = 
    group.status === "active" || 
    group.status === "paused" || 
    group.status === "completed" ||
    group.status === "cancelled";

  return (
    <>
      <li>
        <PlanGroupCard
          title={group.name || "í”Œëœ ê·¸ë£¹"}
          status={shouldShowStatus ? group.status : undefined}
          badges={badges}
          progress={hasPlans && totalCount > 0 ? { completed: completedCount, total: totalCount } : undefined}
          metadata={metadata}
          createdAt={group.created_at}
          actions={actions}
          isSelected={isSelected}
        >
          {/* Checkbox for selection */}
          {onToggleSelect && (
            <div className="flex items-center gap-2">
              {!isCampPlan ? (
                <button
                  type="button"
                  onClick={onToggleSelect}
                  className="inline-flex items-center justify-center rounded-lg p-1 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600"
                  title={isSelected ? "ì„ íƒ í•´ì œ" : "ì„ íƒ"}
                  aria-label={isSelected ? "ì„ íƒ í•´ì œ" : "ì„ íƒ"}
                >
                  {isSelected ? (
                    <CheckSquare className="h-5 w-5 text-blue-600" />
                  ) : (
                    <Square className="h-5 w-5" />
                  )}
                </button>
              ) : (
                <div className="inline-flex items-center justify-center rounded-lg p-1 text-gray-300 cursor-not-allowed">
                  <Square className="h-5 w-5" />
                </div>
              )}
            </div>
          )}

          {/* Extra info if no progress */}
          {hasPlans && planCount > 0 && totalCount === 0 && (
            <p className="text-xs text-gray-500">{planCount}ê°œ í”Œëœ</p>
          )}
        </PlanGroupCard>
      </li>

      <PlanGroupDeleteDialog
        open={deleteDialogOpen}
        onOpenChange={setDeleteDialogOpen}
        groupId={group.id}
        groupName={group.name}
        groupStatus={group.status as any}
        isCampPlan={isCampPlan}
      />

      <PlanGroupActiveToggleDialog
        open={toggleDialogOpen}
        onOpenChange={setToggleDialogOpen}
        groupName={group.name}
        isActive={isActive}
        onConfirm={handleToggleActiveConfirm}
        isPending={isPending}
      />
    </>
  );
}
</file>

<file path="_components/PlanGroupStatsCard.tsx">
"use client";

type PlanGroupStatsCardProps = {
  totalGroups: number;
  activeCount: number;
  pausedCount: number;
  completedCount: number;
};

export function PlanGroupStatsCard({
  totalGroups,
  activeCount,
  pausedCount,
  completedCount,
}: PlanGroupStatsCardProps) {
  if (totalGroups === 0) {
    return null;
  }

  return (
    <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div className="grid grid-cols-2 gap-4 sm:grid-cols-4">
        <div className="flex flex-col gap-1">
          <dt className="text-xs font-medium text-gray-500">ì „ì²´</dt>
          <dd className="text-2xl font-semibold text-gray-900">{totalGroups}ê°œ</dd>
        </div>
        <div className="flex flex-col gap-1">
          <dt className="text-xs font-medium text-gray-500">í™œì„±</dt>
          <dd className="text-2xl font-semibold text-green-600">{activeCount}ê°œ</dd>
        </div>
        <div className="flex flex-col gap-1">
          <dt className="text-xs font-medium text-gray-500">ì¼ì‹œì •ì§€</dt>
          <dd className="text-2xl font-semibold text-yellow-600">{pausedCount}ê°œ</dd>
        </div>
        <div className="flex flex-col gap-1">
          <dt className="text-xs font-medium text-gray-500">ì™„ë£Œ</dt>
          <dd className="text-2xl font-semibold text-purple-600">{completedCount}ê°œ</dd>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="_components/ProgressInput.tsx">
"use client";

import { useTransition, useState } from "react";
import { useRouter } from "next/navigation";
import { updatePlanProgress } from "@/app/actions/progress";

type ProgressInputProps = {
  planId: string;
  contentType: "book" | "lecture" | "custom";
  currentProgress: number | null;
  startPageOrTime: number | null;
  endPageOrTime: number | null;
  unitLabel: string;
};

export function ProgressInput({
  planId,
  contentType,
  currentProgress,
  startPageOrTime,
  endPageOrTime,
  unitLabel,
}: ProgressInputProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  const [isExpanded, setIsExpanded] = useState(false);
  const [inputMode, setInputMode] = useState<"percentage" | "range">("range");

  const handleSubmit = async (formData: FormData) => {
    setError(null);
    startTransition(async () => {
      try {
        formData.set("plan_id", planId);
        await updatePlanProgress(formData);
        router.refresh();
        setIsExpanded(false);
      } catch (err) {
        setError(
          err instanceof Error
            ? err.message
            : "ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  const progressValue = currentProgress ?? 0;
  const isCompleted = progressValue >= 100;

  return (
    <div className="flex flex-col gap-2">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span
            className={`text-sm font-medium ${
              isCompleted ? "text-green-700" : "text-gray-700"
            }`}
          >
            ì§„í–‰ë¥ : {progressValue}%
          </span>
          <span
            className={`rounded-full px-2 py-0.5 text-xs font-medium ${
              isCompleted
                ? "bg-green-100 text-green-800"
                : "bg-blue-100 text-blue-800"
            }`}
          >
            {isCompleted ? "ì™„ë£Œ" : "ì§„í–‰ì¤‘"}
          </span>
        </div>
        <button
          type="button"
          onClick={() => setIsExpanded(!isExpanded)}
          className="text-sm text-gray-600 hover:text-gray-900"
        >
          {isExpanded ? "ì ‘ê¸°" : "ìˆ˜ì •"}
        </button>
      </div>

      {isExpanded && (
        <form
          action={handleSubmit}
          onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.currentTarget);
            handleSubmit(formData);
          }}
          className="rounded-lg border border-gray-200 bg-gray-50 p-4 flex flex-col gap-4"
        >
          {error && (
            <div className="rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-800">
              {error}
            </div>
          )}

          <div className="flex flex-col gap-2">
            <label className="block text-xs font-medium text-gray-700">
              ì…ë ¥ ë°©ì‹
            </label>
            <div className="flex gap-4">
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="input_mode"
                  value="range"
                  checked={inputMode === "range"}
                  onChange={() => setInputMode("range")}
                  className="h-3 w-3"
                />
                <span className="text-xs text-gray-700">
                  ì‹œì‘/ì¢…ë£Œ {unitLabel}
                </span>
              </label>
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="input_mode"
                  value="percentage"
                  checked={inputMode === "percentage"}
                  onChange={() => setInputMode("percentage")}
                  className="h-3 w-3"
                />
                <span className="text-xs text-gray-700">ì§„í–‰ë¥  (%)</span>
              </label>
            </div>
          </div>

          {inputMode === "percentage" ? (
            <div className="flex flex-col gap-1">
              <label
                htmlFor={`progress-${planId}`}
                className="block text-xs font-medium text-gray-700"
              >
                ì§„í–‰ë¥  (%)
              </label>
              <input
                type="number"
                id={`progress-${planId}`}
                name="progress"
                min="0"
                max="100"
                step="0.1"
                required
                defaultValue={currentProgress ?? undefined}
                className="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-gray-900 focus:outline-none"
                placeholder="0-100"
              />
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-3">
              <div className="flex flex-col gap-1">
                <label
                  htmlFor={`start-${planId}`}
                  className="block text-xs font-medium text-gray-700"
                >
                  ì‹œì‘ {unitLabel}
                </label>
                <input
                  type="number"
                  id={`start-${planId}`}
                  name="start_page_or_time"
                  min="0"
                  step="1"
                  required
                  defaultValue={startPageOrTime ?? undefined}
                  className="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-gray-900 focus:outline-none"
                  placeholder="ì‹œì‘"
                />
              </div>
              <div className="flex flex-col gap-1">
                <label
                  htmlFor={`end-${planId}`}
                  className="block text-xs font-medium text-gray-700"
                >
                  ì¢…ë£Œ {unitLabel}
                </label>
                <input
                  type="number"
                  id={`end-${planId}`}
                  name="end_page_or_time"
                  min="0"
                  step="1"
                  required
                  defaultValue={endPageOrTime ?? undefined}
                  className="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-gray-900 focus:outline-none"
                  placeholder="ì¢…ë£Œ"
                />
              </div>
            </div>
          )}

          <div className="flex gap-2">
            <button
              type="submit"
              disabled={isPending}
              className="flex-1 rounded-lg bg-gray-900 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50"
            >
              {isPending ? "ì €ì¥ ì¤‘..." : "ì €ì¥"}
            </button>
            <button
              type="button"
              onClick={() => setIsExpanded(false)}
              className="rounded-lg border border-gray-300 px-3 py-1.5 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              ì·¨ì†Œ
            </button>
          </div>
        </form>
      )}
    </div>
  );
}
</file>

<file path="_components/RescheduleRecommendations.tsx">
/**
 * ì¬ì¡°ì • ì¶”ì²œ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì •ì´ í•„ìš”í•œ í”Œëœ ê·¸ë£¹ì„ ì¶”ì²œí•˜ê³  ì›í´ë¦­ ì¬ì¡°ì •ì„ ì œê³µí•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { detectRescheduleNeeds } from "@/lib/reschedule/patternAnalyzer";
import { createSupabaseBrowserClient } from "@/lib/supabase/client";
import { useToast } from "@/components/ui/ToastProvider";
import { AlertCircle, ArrowRight, RefreshCw } from "lucide-react";
import type { RescheduleRecommendation } from "@/lib/reschedule/patternAnalyzer";

type RescheduleRecommendationsProps = {
  studentId: string;
};

export function RescheduleRecommendations({
  studentId,
}: RescheduleRecommendationsProps) {
  const router = useRouter();
  const toast = useToast();
  const [loading, setLoading] = useState(true);
  const [recommendations, setRecommendations] = useState<
    RescheduleRecommendation[]
  >([]);

  useEffect(() => {
    loadRecommendations();
  }, [studentId]);

  const loadRecommendations = async () => {
    setLoading(true);
    try {
      const supabase = createSupabaseBrowserClient();
      const recs = await detectRescheduleNeeds(supabase, studentId);
      setRecommendations(recs);
    } catch (error) {
      console.error("[RescheduleRecommendations] ì¶”ì²œ ë¡œë“œ ì‹¤íŒ¨:", error);
      toast.showError("ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setLoading(false);
    }
  };

  const handleQuickReschedule = (groupId: string) => {
    router.push(`/plan/group/${groupId}/reschedule`);
  };

  if (loading) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <div className="flex items-center justify-center py-8">
          <div className="flex flex-col gap-2 text-center">
            <div className="inline-block h-6 w-6 animate-spin rounded-full border-2 border-solid border-blue-600 border-r-transparent"></div>
            <p className="text-sm text-gray-600">ì¶”ì²œì„ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>
    );
  }

  if (recommendations.length === 0) {
    return null; // ì¶”ì²œì´ ì—†ìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
  }

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case "high":
        return "bg-red-50 border-red-200";
      case "medium":
        return "bg-yellow-50 border-yellow-200";
      case "low":
        return "bg-blue-50 border-blue-200";
      default:
        return "bg-gray-50 border-gray-200";
    }
  };

  const getPriorityLabel = (priority: string) => {
    switch (priority) {
      case "high":
        return "ë†’ìŒ";
      case "medium":
        return "ë³´í†µ";
      case "low":
        return "ë‚®ìŒ";
      default:
        return priority;
    }
  };

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <AlertCircle className="h-5 w-5 text-blue-600" />
          <h3 className="text-lg font-semibold text-gray-900">
            ì¬ì¡°ì • ì¶”ì²œ
          </h3>
        </div>
        <button
          onClick={loadRecommendations}
          className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          <RefreshCw className="h-4 w-4" />
        </button>
      </div>

      <p className="text-sm text-gray-600">
        ë‹¤ìŒ í”Œëœ ê·¸ë£¹ì˜ ì¬ì¡°ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      </p>

      <div className="flex flex-col gap-3">
        {recommendations.map((rec) => (
          <div
            key={rec.groupId}
            className={`rounded-lg border p-4 ${getPriorityColor(rec.priority)}`}
          >
            <div className="flex items-start justify-between gap-4">
              <div className="flex flex-1 flex-col gap-2">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium text-gray-900">
                    {rec.groupName || "ì´ë¦„ ì—†ìŒ"}
                  </span>
                  <span
                    className={`rounded px-2 py-0.5 text-xs font-medium ${
                      rec.priority === "high"
                        ? "bg-red-100 text-red-700"
                        : rec.priority === "medium"
                        ? "bg-yellow-100 text-yellow-700"
                        : "bg-blue-100 text-blue-700"
                    }`}
                  >
                    {getPriorityLabel(rec.priority)}
                  </span>
                </div>
                <p className="text-sm text-gray-700">{rec.reason}</p>
                <div className="text-xs text-gray-600">
                  ì˜í–¥ë°›ëŠ” í”Œëœ: {rec.estimatedImpact.plansAffected}ê°œ
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Link
                  href={`/plan/group/${rec.groupId}`}
                  className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
                >
                  ìƒì„¸ ë³´ê¸°
                </Link>
                <button
                  onClick={() => handleQuickReschedule(rec.groupId)}
                  className="inline-flex items-center gap-1 rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white transition hover:bg-blue-700"
                >
                  ì¬ì¡°ì •
                  <ArrowRight className="h-4 w-4" />
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="_shared/utils/contentTypeUtils.ts">
/**
 * Content Type Utilities
 * 
 * Shared content type icons, labels, and helper functions
 * used across the plan directory components.
 */

export const CONTENT_TYPE_ICONS = {
  book: "ğŸ“š",
  lecture: "ğŸ§",
  custom: "ğŸ“",
} as const;

export const CONTENT_TYPE_LABELS = {
  book: "êµì¬",
  lecture: "ê°•ì˜",
  custom: "ì»¤ìŠ¤í…€",
} as const;

export type ContentType = keyof typeof CONTENT_TYPE_ICONS;

/**
 * Get the icon for a content type
 */
export function getContentTypeIcon(type: string): string {
  return CONTENT_TYPE_ICONS[type as ContentType] || "ğŸ“‹";
}

/**
 * Get the label for a content type
 */
export function getContentTypeLabel(type: string): string {
  return CONTENT_TYPE_LABELS[type as ContentType] || type;
}

/**
 * Format content range display string
 */
export function formatContentRange(
  contentType: string,
  startRange: number | null,
  endRange: number | null
): string {
  if (startRange === null || endRange === null) {
    return "";
  }

  if (contentType === "book") {
    return `${startRange}-${endRange}í˜ì´ì§€`;
  } else if (contentType === "lecture") {
    if (startRange === endRange) {
      return `${startRange}ê°•`;
    }
    return `${startRange}-${endRange}ê°•`;
  }
  
  return `${startRange}-${endRange}`;
}
</file>

<file path="_shared/utils/index.ts">
/**
 * Plan Shared Utilities
 * 
 * Re-export all utility functions from a single entry point.
 */

export {
  CONTENT_TYPE_ICONS,
  CONTENT_TYPE_LABELS,
  type ContentType,
  getContentTypeIcon,
  getContentTypeLabel,
  formatContentRange,
} from "./contentTypeUtils";

export {
  type ProgressColor,
  calculateProgressPercentage,
  getProgressColor,
  getProgressStatusText,
  formatProgressDisplay,
} from "./progressUtils";
</file>

<file path="_shared/utils/progressUtils.ts">
/**
 * Progress Utilities
 * 
 * Shared progress calculation functions used across
 * the plan directory components.
 */

export type ProgressColor = "green" | "blue" | "orange" | "red";

/**
 * Calculate percentage from completed and total counts
 */
export function calculateProgressPercentage(completed: number, total: number): number {
  return total > 0 ? Math.round((completed / total) * 100) : 0;
}

/**
 * Get the appropriate color for a progress indicator
 */
export function getProgressColor(completed: number, total: number): ProgressColor {
  if (completed === total && total > 0) return "green";
  if (completed > 0) return "blue";
  return "orange";
}

/**
 * Get progress status text
 */
export function getProgressStatusText(completed: number, total: number): string {
  const percentage = calculateProgressPercentage(completed, total);
  
  if (completed === 0) {
    return "ì‹œì‘ ì „";
  } else if (completed >= total) {
    return "ì™„ë£Œ";
  } else if (percentage >= 50) {
    return "ì§„í–‰ ì¤‘";
  } else {
    return "ì‹œì‘ë¨";
  }
}

/**
 * Format progress display string
 */
export function formatProgressDisplay(
  completed: number, 
  total: number, 
  options: { showPercentage?: boolean; showCount?: boolean } = {}
): string {
  const { showPercentage = true, showCount = true } = options;
  const percentage = calculateProgressPercentage(completed, total);
  
  const parts: string[] = [];
  
  if (showCount) {
    parts.push(`${completed}/${total}`);
  }
  
  if (showPercentage) {
    parts.push(`${percentage}%`);
  }
  
  return parts.join(" ");
}
</file>

<file path="_shared/FilterBar.tsx">
"use client";

import { ReactNode } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { cn } from "@/lib/cn";

export interface FilterOption {
  value: string;
  label: string;
}

export interface FilterConfig {
  name: string;
  label: string;
  options: FilterOption[];
  type?: "select" | "toggle";
}

interface FilterBarProps {
  filters: FilterConfig[];
  basePath?: string;
  className?: string;
  onFilterChange?: (filterName: string, value: string) => void;
  children?: ReactNode;
}

export function FilterBar({
  filters,
  basePath = "",
  className,
  onFilterChange,
  children,
}: FilterBarProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const createQueryString = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams?.toString() || "");
    if (value) {
      params.set(key, value);
    } else {
      params.delete(key);
    }
    return params.toString();
  };

  const handleSelectChange = (filterName: string, value: string) => {
    const queryString = createQueryString(filterName, value);
    const newPath = `${basePath}${queryString ? `?${queryString}` : ""}`;
    
    if (onFilterChange) {
      onFilterChange(filterName, value);
    }
    
    router.push(newPath, { scroll: true });
  };

  const getCurrentValue = (filterName: string) => {
    return searchParams?.get(filterName) || "";
  };

  return (
    <form className={cn(
      "flex flex-wrap items-center gap-3 rounded-xl border border-gray-200 bg-white px-4 py-3 shadow-sm",
      className
    )}>
      {filters.map((filter) => {
        const currentValue = getCurrentValue(filter.name);

        if (filter.type === "toggle") {
          // Toggle buttons (e.g., sorting)
          return (
            <div key={filter.name} className="flex items-center gap-2">
              <span className="text-sm font-medium text-gray-600">{filter.label}</span>
              <div className="flex gap-2">
                {filter.options.map((option) => (
                  <Link
                    key={option.value}
                    href={`${basePath}?${createQueryString(filter.name, option.value)}`}
                    className={cn(
                      "inline-flex items-center justify-center rounded-lg border px-3 py-1.5 text-sm font-semibold transition hover:shadow-sm",
                      currentValue === option.value || (!currentValue && option.value === filter.options[0].value)
                        ? "border-gray-900 bg-gray-900 text-white hover:bg-gray-800"
                        : "border-gray-300 bg-white text-gray-700 hover:bg-gray-50 hover:border-gray-400"
                    )}
                  >
                    {option.label}
                  </Link>
                ))}
              </div>
            </div>
          );
        }

        // Default: select dropdown
        return (
          <label key={filter.name} className="flex items-center gap-2 text-sm text-gray-600">
            <span className="font-medium">{filter.label}</span>
            <select
              name={filter.name}
              className="rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-gray-900 focus:outline-none"
              value={currentValue}
              onChange={(e) => handleSelectChange(filter.name, e.target.value)}
            >
              {filter.options.map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </label>
        );
      })}
      {children}
    </form>
  );
}

// Preset filter configurations
export const planPurposeFilter: FilterConfig = {
  name: "planPurpose",
  label: "í”Œëœ ëª©ì ",
  type: "select",
  options: [
    { value: "", label: "ì „ì²´" },
    { value: "ë‚´ì‹ ëŒ€ë¹„", label: "ë‚´ì‹ ëŒ€ë¹„" },
    { value: "ëª¨ì˜ê³ ì‚¬", label: "ëª¨ì˜ê³ ì‚¬" },
    { value: "ìˆ˜ëŠ¥", label: "ìˆ˜ëŠ¥" },
    { value: "ê¸°íƒ€", label: "ê¸°íƒ€" },
  ],
};

export const sortOrderFilter: FilterConfig = {
  name: "sortOrder",
  label: "ìƒì„±ì¼ ì •ë ¬",
  type: "toggle",
  options: [
    { value: "desc", label: "ìµœì‹ ìˆœ" },
    { value: "asc", label: "ì˜¤ë˜ëœìˆœ" },
  ],
};

export const templateStatusFilter: FilterConfig = {
  name: "status",
  label: "ìƒíƒœ",
  type: "select",
  options: [
    { value: "", label: "ì „ì²´" },
    { value: "draft", label: "ì´ˆì•ˆ" },
    { value: "active", label: "í™œì„±" },
    { value: "archived", label: "ë³´ê´€" },
  ],
};

export const templateProgramTypeFilter: FilterConfig = {
  name: "program_type",
  label: "í”„ë¡œê·¸ë¨ ìœ í˜•",
  type: "select",
  options: [
    { value: "", label: "ì „ì²´" },
    { value: "ìœˆí„°ìº í”„", label: "ìœˆí„°ìº í”„" },
    { value: "ì¸ë¨¸ìº í”„", label: "ì¸ë¨¸ìº í”„" },
    { value: "íŒŒì´ë„ìº í”„", label: "íŒŒì´ë„ìº í”„" },
    { value: "ê¸°íƒ€", label: "ê¸°íƒ€" },
  ],
};
</file>

<file path="_shared/index.ts">
export { StatusBadge, getStatusVariant, statusLabels } from "./StatusBadge";
export type { StatusVariant, StatusSize } from "./StatusBadge";

export { ProgressIndicator, StepProgress } from "./ProgressIndicator";

export {
  PlanCard,
  TemplateCard,
  CampCard,
  PlanGroupCard,
} from "./PlanCard";
export type { CardVariant } from "./PlanCard";

export {
  FilterBar,
  planPurposeFilter,
  sortOrderFilter,
  templateStatusFilter,
  templateProgramTypeFilter,
} from "./FilterBar";
export type { FilterOption, FilterConfig } from "./FilterBar";
</file>

<file path="_shared/PlanCard.tsx">
"use client";

import { ReactNode, memo } from "react";
import Link from "next/link";
import { cn } from "@/lib/cn";
import { StatusBadge, getStatusVariant, statusLabels } from "./StatusBadge";
import { ProgressIndicator } from "./ProgressIndicator";

export type CardVariant = "default" | "template" | "camp" | "plan";

interface PlanCardProps {
  variant?: CardVariant;
  title: string;
  subtitle?: string | null;
  description?: string | null;
  href?: string;
  status?: string;
  createdAt?: string | Date;
  badges?: Array<{ label: string; variant?: "info" | "warning" | "success" | "error" | "default" }>;
  progress?: {
    completed: number;
    total: number;
  };
  metadata?: Array<{ label: string; value: string }>;
  actions?: ReactNode;
  onClick?: (e: React.MouseEvent<HTMLDivElement>) => void;
  className?: string;
  children?: ReactNode;
  isSelected?: boolean;
}

export const PlanCard = memo(function PlanCard({
  variant = "default",
  title,
  subtitle,
  description,
  href,
  status,
  createdAt,
  badges = [],
  progress,
  metadata = [],
  actions,
  onClick,
  className,
  children,
  isSelected = false,
}: PlanCardProps) {
  const cardContent = (
    <div className="flex flex-col gap-3">
      {/* Header: badges + actions */}
      <div className="flex items-center justify-between gap-3">
        <div className="flex flex-wrap items-center gap-1.5">
          {status && (
            <StatusBadge variant={getStatusVariant(status)} size="sm">
              {statusLabels[status] || status}
            </StatusBadge>
          )}
          {badges.map((badge, index) => (
            <StatusBadge
              key={index}
              variant={badge.variant || "default"}
              size="sm"
            >
              {badge.label}
            </StatusBadge>
          ))}
        </div>
        {actions && <div className="flex shrink-0 items-center gap-1">{actions}</div>}
      </div>

      {/* Title & Subtitle */}
      <div className="flex flex-col gap-1">
        <h3 className="break-words text-base font-semibold text-gray-900">
          {title}
        </h3>
        {subtitle && (
          <p className="text-sm text-gray-600">{subtitle}</p>
        )}
        {description && (
          <p className="text-sm text-gray-500 line-clamp-2">{description}</p>
        )}
      </div>

      {/* Progress */}
      {progress && progress.total > 0 && (
        <ProgressIndicator
          completedCount={progress.completed}
          totalCount={progress.total}
        />
      )}

      {/* Metadata */}
      {metadata.length > 0 && (
        <div className="flex flex-col gap-2">
          {metadata.map((item, index) => (
            <div key={index} className="break-words text-sm text-gray-600">
              <span className="text-gray-500">{item.label}: </span>
              <span className="font-medium text-gray-900">{item.value}</span>
            </div>
          ))}
        </div>
      )}

      {/* Custom children */}
      {children}

      {/* Footer: created date */}
      {createdAt && (
        <div className="flex items-center justify-between border-t border-gray-100 pt-2">
          <p className="text-xs text-gray-500">
            {typeof createdAt === "string"
              ? new Date(createdAt).toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })
              : createdAt.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
          </p>
        </div>
      )}
    </div>
  );

  const baseClasses = cn(
    "rounded-xl border bg-white p-4 shadow-sm transition-all duration-200",
    isSelected
      ? "border-blue-500 bg-blue-50 shadow-md ring-2 ring-blue-200"
      : "border-gray-200 hover:border-gray-300 hover:shadow-lg hover:-translate-y-0.5",
    onClick && "cursor-pointer",
    className
  );

  if (href && !onClick) {
    return (
      <Link href={href} className={baseClasses}>
        {cardContent}
      </Link>
    );
  }

  return (
    <div
      onClick={onClick}
      className={baseClasses}
    >
      {cardContent}
    </div>
  );
});

// Specialized card variants
export const TemplateCard = memo(function TemplateCard(props: Omit<PlanCardProps, "variant">) {
  return <PlanCard {...props} variant="template" />;
});

export const CampCard = memo(function CampCard(props: Omit<PlanCardProps, "variant">) {
  return <PlanCard {...props} variant="camp" />;
});

export const PlanGroupCard = memo(function PlanGroupCard(props: Omit<PlanCardProps, "variant">) {
  return <PlanCard {...props} variant="plan" />;
});
</file>

<file path="_shared/ProgressIndicator.tsx">
import { memo } from "react";
import { cn } from "@/lib/cn";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import { calculateProgressPercentage, getProgressColor } from "./utils";

interface ProgressIndicatorProps {
  completedCount: number;
  totalCount: number;
  className?: string;
  showPercentage?: boolean;
  compact?: boolean;
}

export const ProgressIndicator = memo(function ProgressIndicator({
  completedCount,
  totalCount,
  className,
  showPercentage = true,
  compact = false,
}: ProgressIndicatorProps) {
  const percentage = calculateProgressPercentage(completedCount, totalCount);
  
  const progressColor = getProgressColor(completedCount, totalCount);

  if (compact) {
    return (
      <div className={cn("flex items-center gap-2", className)}>
        <div className="flex-1">
          <ProgressBar
            value={percentage}
            height="sm"
            color={progressColor}
          />
        </div>
        <span className="text-xs font-medium text-gray-600 whitespace-nowrap">
          {showPercentage ? `${percentage}%` : `${completedCount}/${totalCount}`}
        </span>
      </div>
    );
  }

  return (
    <div className={cn("rounded-lg border border-gray-100 bg-gray-50 p-2.5", className)}>
      <div className="flex flex-col gap-2">
        <div className="flex items-center justify-between gap-2">
          <span className="text-xs font-medium text-gray-600">ì§„í–‰ë¥ </span>
          <span className="text-xs font-semibold text-gray-900">
            {completedCount}/{totalCount}ê°œ ì™„ë£Œ
          </span>
        </div>
        <div className="flex items-center gap-2">
          <div className="flex-1">
            <ProgressBar
              value={percentage}
              height="sm"
              color={progressColor}
            />
          </div>
          {showPercentage && (
            <span className="text-xs font-medium text-gray-600">
              {percentage}%
            </span>
          )}
        </div>
      </div>
    </div>
  );
});

// Helper component for step progress (e.g., "â‘  ì°¸ì—¬ ì •ë³´ ì œì¶œ â†’ â‘¡ í”Œëœ ìƒì„± â†’ â‘¢ í•™ìŠµ ì‹œì‘")
interface StepProgressProps {
  steps: Array<{
    label: string;
    isActive: boolean;
    isCompleted: boolean;
  }>;
  className?: string;
}

export const StepProgress = memo(function StepProgress({ steps, className }: StepProgressProps) {
  return (
    <div className={cn("flex items-center gap-2 text-xs", className)}>
      {steps.map((step, index) => (
        <>
          <span
            key={`step-${index}`}
            className={cn(
              "transition-colors",
              step.isActive && "font-medium text-indigo-600",
              step.isCompleted && !step.isActive && "text-gray-700",
              !step.isCompleted && !step.isActive && "text-gray-500"
            )}
          >
            {step.label}
          </span>
          {index < steps.length - 1 && (
            <span key={`arrow-${index}`} className="text-gray-400">
              â†’
            </span>
          )}
        </>
      ))}
    </div>
  );
});
</file>

<file path="_shared/StatusBadge.tsx">
import { memo } from "react";
import { cn } from "@/lib/cn";

export type StatusVariant =
  | "draft"
  | "active"
  | "paused"
  | "completed"
  | "cancelled"
  | "pending"
  | "accepted"
  | "info"
  | "success"
  | "warning"
  | "error"
  | "default";

export type StatusSize = "sm" | "md" | "lg";

interface StatusBadgeProps {
  variant: StatusVariant;
  size?: StatusSize;
  children: React.ReactNode;
  className?: string;
}

const variantStyles: Record<StatusVariant, string> = {
  draft: "bg-gray-100 text-gray-800",
  active: "bg-green-100 text-green-800",
  paused: "bg-yellow-100 text-yellow-800",
  completed: "bg-purple-100 text-purple-800",
  cancelled: "bg-red-100 text-red-800",
  pending: "bg-yellow-100 text-yellow-800",
  accepted: "bg-blue-100 text-blue-800",
  info: "bg-blue-100 text-blue-800",
  success: "bg-green-100 text-green-800",
  warning: "bg-yellow-100 text-yellow-800",
  error: "bg-red-100 text-red-800",
  default: "bg-gray-100 text-gray-800",
};

const sizeStyles: Record<StatusSize, string> = {
  sm: "px-2 py-0.5 text-xs",
  md: "px-2.5 py-1 text-xs",
  lg: "px-3 py-1.5 text-sm",
};

export const StatusBadge = memo(function StatusBadge({
  variant,
  size = "md",
  children,
  className,
}: StatusBadgeProps) {
  return (
    <span
      className={cn(
        "inline-flex items-center rounded-full font-medium",
        variantStyles[variant],
        sizeStyles[size],
        className
      )}
    >
      {children}
    </span>
  );
});

// Helper function to get status label
export const statusLabels: Record<string, string> = {
  draft: "ì´ˆì•ˆ",
  active: "í™œì„±",
  paused: "ì¼ì‹œì •ì§€",
  completed: "ì™„ë£Œ",
  cancelled: "ì¤‘ë‹¨",
  pending: "ëŒ€ê¸° ì¤‘",
  accepted: "ìŠ¹ì¸ë¨",
  saved: "ì €ì¥ë¨",
};

// Helper function to map status to variant
export function getStatusVariant(status: string): StatusVariant {
  const statusMap: Record<string, StatusVariant> = {
    draft: "draft",
    active: "active",
    paused: "paused",
    completed: "completed",
    cancelled: "cancelled",
    pending: "pending",
    accepted: "accepted",
    saved: "info",
  };
  return statusMap[status] || "default";
}
</file>

<file path="calendar/_components/CalendarPlanCard.tsx">
"use client";

import { Clock, Link2 } from "lucide-react";
import type { PlanWithContent } from "../_types/plan";
import { getContentTypeIcon } from "../../_shared/utils";
import { ProgressBar } from "@/components/atoms/ProgressBar";

type PlanCardProps = {
  plan: PlanWithContent;
  compact?: boolean;
  showTime?: boolean;
  showProgress?: boolean;
  // ì—°ê²° ìƒíƒœ (ê°™ì€ plan_numberë¥¼ ê°€ì§„ ìª¼ê°œì§„ í”Œëœë“¤)
  isConnected?: boolean;
  isFirst?: boolean;
  isLast?: boolean;
  isMiddle?: boolean;
};

/**
 * CalendarPlanCard - Calendar-specific plan card component
 * 
 * Specialized for displaying plans within calendar views (day, week, month).
 * Includes features like:
 * - Compact mode for timeline displays
 * - Connection indicators for split plans
 * - Time-based styling and progress display
 * 
 * For generic plan group cards, use _shared/PlanCard instead.
 */
export function CalendarPlanCard({ 
  plan, 
  compact = false, 
  showTime = true, 
  showProgress = true,
  isConnected = false,
  isFirst = false,
  isLast = false,
  isMiddle = false,
}: PlanCardProps) {
  const contentTypeIcon = getContentTypeIcon(plan.content_type);
  const isCompleted = plan.progress != null && plan.progress >= 100;
  const isActive = plan.actual_start_time && !plan.actual_end_time;
  const progressPercentage = plan.progress != null ? Math.round(plan.progress) : null;

  if (compact) {
    // ì—°ê²°ì„  ìŠ¤íƒ€ì¼ ê²°ì •
    const connectionClasses = isConnected
      ? isFirst
        ? "rounded-t-md rounded-b-none" // ì²« ë²ˆì§¸: ìœ„ìª½ë§Œ ë‘¥ê¸€ê²Œ
        : isLast
        ? "rounded-b-md rounded-t-none" // ë§ˆì§€ë§‰: ì•„ë˜ìª½ë§Œ ë‘¥ê¸€ê²Œ
        : "rounded-none" // ì¤‘ê°„: ë‘¥ê¸€ê²Œ ì—†ìŒ
      : "rounded-md";
    
    const borderColorClass = isCompleted
      ? "border-green-300"
      : isActive
      ? "border-blue-300"
      : "border-gray-200";
    
    const bgColorClass = isCompleted
      ? "bg-green-50"
      : isActive
      ? "bg-blue-50"
      : "bg-white";
    
    // ì—°ê²°ëœ ê²½ìš° border ì¡°ì •
    const borderClasses = isConnected
      ? isFirst
        ? "border-b-0" // ì²« ë²ˆì§¸: ì•„ë˜ border ì œê±°
        : isLast
        ? "border-t-0" // ë§ˆì§€ë§‰: ìœ„ border ì œê±°
        : "border-t-0 border-b-0" // ì¤‘ê°„: ìœ„ì•„ë˜ border ì œê±°
      : "";
    
    return (
      <div
        className={`group border p-1 py-0.5 text-xs transition-all duration-200 hover:scale-[1.02] hover:shadow-md relative ${connectionClasses} ${borderColorClass} ${bgColorClass} ${borderClasses}`}
      >
        {/* ì—°ê²°ì„  í‘œì‹œ (ì•„ë˜ìª½ì— ì—°ê²°ì„ ) */}
        {isConnected && !isLast && (
          <div 
            className={`absolute left-0 right-0 bottom-0 h-[3px] translate-y-[6px] z-10 ${isCompleted ? "bg-green-300" : isActive ? "bg-blue-300" : "bg-gray-200"}`} 
          />
        )}
        <div className="flex items-center gap-0.5 min-w-0">
          <span className="text-xs shrink-0">{contentTypeIcon}</span>
          <span className="truncate font-medium text-gray-900 min-w-0 flex-1 text-[10px] leading-tight">
            {plan.contentSubjectCategory || plan.contentSubject || "-"}
          </span>
          {plan.contentEpisode && (
            <span className="shrink-0 text-[10px] text-gray-600">
              {plan.contentEpisode}
            </span>
          )}
          {isCompleted && (
            <span className="shrink-0 rounded-full bg-green-500 px-1 py-0.5 text-[10px] font-semibold text-white">
              âœ…
            </span>
          )}
          {isActive && !isCompleted && (
            <span className="shrink-0 rounded-full bg-blue-500 px-1 py-0.5 text-[10px] font-semibold text-white">
              â±ï¸
            </span>
          )}
        </div>
      </div>
    );
  }

  return (
    <div
      className={`group rounded-lg border-2 p-4 md:p-5 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg relative ${
        isCompleted
          ? "border-green-300 bg-green-50"
          : isActive
          ? "border-blue-300 bg-blue-50"
          : "border-gray-200 bg-white"
      }`}
    >
      <div className="flex items-start justify-between gap-4">
        {/* ì™¼ìª½: ì½˜í…ì¸  ì •ë³´ */}
        <div className="flex-1 min-w-0 flex flex-col gap-2 md:gap-2.5">
          {/* 1í–‰: ìƒíƒœ ë±ƒì§€ + ì‹œê°„ í‘œê¸° + êµê³¼ ê³¼ëª© */}
          <div className="flex items-center gap-2 flex-wrap">
            {/* ìƒíƒœ ë±ƒì§€ */}
            {isCompleted && (
              <span className="shrink-0 rounded-full bg-green-500 px-3 py-1 text-xs font-bold text-white shadow-sm">
                âœ… ì™„ë£Œ
              </span>
            )}
            {isActive && !isCompleted && (
              <span className="shrink-0 rounded-full bg-blue-500 px-3 py-1 text-xs font-bold text-white shadow-sm">
                â±ï¸ í•™ìŠµ ì¤‘
              </span>
            )}
            {!isCompleted && !isActive && (
              <span className="shrink-0 rounded-full bg-gray-400 px-3 py-1 text-xs font-bold text-white shadow-sm">
                â¸ï¸ ëŒ€ê¸°
              </span>
            )}
            {/* ì‹œê°„ í‘œê¸° */}
            {showTime && plan.start_time && plan.end_time && (
              <span className="flex items-center gap-1.5 rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold text-blue-700">
                <Clock className="h-3.5 w-3.5" aria-hidden="true" />
                {plan.start_time} ~ {plan.end_time}
              </span>
            )}
            {/* êµê³¼ ê³¼ëª© */}
            {plan.contentSubjectCategory && (
              <span className="shrink-0 rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700">
                {plan.contentSubjectCategory}
              </span>
            )}
            {plan.contentSubject && (
              <span className="shrink-0 text-xs font-medium text-gray-600">
                {plan.contentSubject}
              </span>
            )}
          </div>

          {/* 2í–‰: êµì¬ëª…(ë˜ëŠ” ê°•ì˜ëª…) íšŒì°¨ */}
          <div className="flex items-center gap-2 flex-wrap min-w-0">
            <span className="text-xl md:text-2xl shrink-0">{contentTypeIcon}</span>
            <h3 className="truncate text-base md:text-lg font-semibold text-gray-900 min-w-0 flex-1">{plan.contentTitle}</h3>
            {plan.contentEpisode && (
              <span className="shrink-0 text-sm font-medium text-gray-600">
                {plan.contentEpisode}
              </span>
            )}
          </div>

          {/* 3í–‰: í•™ìŠµ ë²”ìœ„ */}
          {plan.planned_start_page_or_time !== null && plan.planned_end_page_or_time !== null && (
            <div className="text-xs md:text-sm text-gray-500">
              {plan.content_type === "book" ? (
                <>ğŸ“– {plan.planned_start_page_or_time}-{plan.planned_end_page_or_time}í˜ì´ì§€</>
              ) : (
                <>ğŸ§ {plan.planned_start_page_or_time}ê°•</>
              )}
              {plan.chapter && <span className="pl-1">({plan.chapter})</span>}
            </div>
          )}
        </div>

        {/* ì˜¤ë¥¸ìª½: ì§„í–‰ë¥  */}
        {showProgress && progressPercentage !== null && (
          <div className="flex shrink-0 flex-col items-end gap-1.5">
            <span className={`text-base md:text-lg font-bold ${
              isCompleted ? "text-green-600" : isActive ? "text-blue-600" : "text-gray-600"
            }`}>
              {progressPercentage}%
            </span>
            <div className="w-20 md:w-24">
              <ProgressBar
                value={progressPercentage}
                variant={isCompleted ? "success" : isActive ? "default" : undefined}
                color={isCompleted ? undefined : isActive ? "blue" : undefined}
                size="sm"
                className="shadow-inner"
              />
            </div>
          </div>
        )}
      </div>
      {/* ì—°ê²° ì•„ì´ì½˜ (ì˜¤ë¥¸ìª½ ìƒë‹¨) */}
      {isConnected && (
        <div className="absolute top-3 right-3 md:top-4 md:right-4">
          <Link2 
            size={16} 
            className="text-indigo-500 opacity-70" 
            strokeWidth={2}
          />
        </div>
      )}
    </div>
  );
}
</file>

<file path="calendar/_components/CalendarStats.tsx">
"use client";

import { StatCard } from "./StatCard";
import type { PlanWithContent } from "../_types/plan";

type CalendarStatsProps = {
  plans: PlanWithContent[];
};

export function CalendarStats({ plans }: CalendarStatsProps) {
  const totalPlans = plans.length;
  const completedPlans = plans.filter((p) => p.progress != null && p.progress >= 100).length;
  const activePlans = plans.filter((p) => p.actual_start_time && !p.actual_end_time).length;
  const averageProgress =
    totalPlans > 0
      ? Math.round(plans.reduce((sum, p) => sum + (p.progress || 0), 0) / totalPlans)
      : 0;

  return (
    <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-white p-4">
      <h3 className="text-sm font-semibold text-gray-700">í•™ìŠµ í†µê³„</h3>
      <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
        <StatCard label="ì´ í”Œëœ" value={totalPlans} color="gray" />
        <StatCard label="ì™„ë£Œ" value={completedPlans} color="green" />
        <StatCard label="ì§„í–‰ì¤‘" value={activePlans} color="blue" />
        <StatCard label="í‰ê·  ì§„í–‰ë¥ " value={`${averageProgress}%`} color="indigo" />
      </div>
    </div>
  );
}
</file>

<file path="calendar/_components/DayTimelineModal.tsx">
"use client";

import { Dialog } from "@/components/ui/Dialog";
import type { PlanWithContent } from "../_types/plan";
import type { PlanExclusion, AcademySchedule, DailyScheduleInfo } from "@/lib/types/plan";
import { formatDateFull, formatDateString } from "@/lib/date/calendarUtils";
import { buildTimelineSlots, getTimeSlotColorClass, getTimeSlotIcon, timeToMinutes } from "../_utils/timelineUtils";
import { CalendarPlanCard } from "./CalendarPlanCard";
import { StatCard } from "./StatCard";
import { DAY_TYPE_INFO } from "@/lib/date/calendarDayTypes";
import type { DayTypeInfo } from "@/lib/date/calendarDayTypes";

type DayTimelineModalProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  date: Date;
  plans: PlanWithContent[];
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  dayTypeInfo?: DayTypeInfo;
  dailySchedule?: DailyScheduleInfo;
};

export function DayTimelineModal({
  open,
  onOpenChange,
  date,
  plans,
  exclusions,
  academySchedules,
  dayTypeInfo,
  dailySchedule,
}: DayTimelineModalProps) {
  const dateStr = formatDateString(date);
  
  // í•´ë‹¹ ë‚ ì§œì˜ í•™ì›ì¼ì • (ìš”ì¼ ê¸°ë°˜)
  const dayOfWeek = date.getDay();
  const dayAcademySchedules = academySchedules.filter(
    (schedule) => schedule.day_of_week === dayOfWeek
  );

  // í•´ë‹¹ ë‚ ì§œì˜ íœ´ì¼
  const dayExclusions = exclusions.filter(
    (exclusion) => exclusion.exclusion_date === dateStr
  );

  // íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ìƒì„±
  const timelineSlots = buildTimelineSlots(
    dateStr,
    dailySchedule,
    plans,
    dayAcademySchedules,
    dayExclusions
  );

  // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬
  const sortedSlots = [...timelineSlots].sort((a, b) => {
    const aStart = timeToMinutes(a.start);
    const bStart = timeToMinutes(b.start);
    return aStart - bStart;
  });

  // í†µê³„ ê³„ì‚°
  const totalPlans = plans.length;
  const completedPlans = plans.filter((p) => p.progress != null && p.progress >= 100).length;
  const activePlans = plans.filter((p) => p.actual_start_time && !p.actual_end_time).length;
  const averageProgress =
    totalPlans > 0
      ? Math.round(plans.reduce((sum, p) => sum + (p.progress || 0), 0) / totalPlans)
      : 0;

  const dayType = dayTypeInfo?.type || "normal";
  const isHoliday = dayType === "ì§€ì •íœ´ì¼" || dayType === "íœ´ê°€" || dayType === "ê°œì¸ì¼ì •" || dayExclusions.length > 0;
  const isStudyDay = dayType === "í•™ìŠµì¼";
  const isReviewDay = dayType === "ë³µìŠµì¼";

  const bgColorClass = isHoliday
    ? "border-red-300 bg-red-50"
    : isStudyDay
    ? "border-blue-300 bg-blue-50"
    : isReviewDay
    ? "border-amber-300 bg-amber-50"
    : "border-gray-200 bg-white";

  const dayTypeBadgeClass = isHoliday
    ? "bg-red-100 text-red-800"
    : isStudyDay
    ? "bg-blue-100 text-blue-800"
    : isReviewDay
    ? "bg-amber-100 text-amber-800"
    : "bg-gray-100 text-gray-800";

  const description = dayTypeInfo && dayType !== "normal" ? (
    <div className="flex items-center gap-2">
      <span className={`rounded-full px-3 py-1 text-sm font-medium ${dayTypeBadgeClass}`}>
        {dayTypeInfo.icon} {dayTypeInfo.label}
      </span>
      {dayExclusions.length > 0 && dayExclusions[0].exclusion_type && (
        <span className="text-sm text-gray-700">
          ({dayExclusions[0].exclusion_type})
        </span>
      )}
    </div>
  ) : undefined;

  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title={formatDateFull(date)}
      maxWidth="4xl"
    >
      <div className="flex w-full max-h-[90vh] flex-col gap-6 overflow-hidden px-6 py-4">
          {/* í†µê³„ */}
          {(totalPlans > 0 || dayAcademySchedules.length > 0) && (
            <div className="grid grid-cols-2 gap-3 md:grid-cols-4">
              {totalPlans > 0 && (
                <>
                  <StatCard label="ì´ í”Œëœ" value={totalPlans} color="gray" />
                  <StatCard label="ì™„ë£Œ" value={completedPlans} color="green" />
                  {activePlans > 0 && (
                    <StatCard label="ì§„í–‰ì¤‘" value={activePlans} color="blue" />
                  )}
                  {averageProgress > 0 && (
                    <StatCard label="í‰ê·  ì§„í–‰ë¥ " value={`${averageProgress}%`} color="indigo" />
                  )}
                </>
              )}
              {dayAcademySchedules.length > 0 && (
                <StatCard label="í•™ì› ì¼ì •" value={dayAcademySchedules.length} color="purple" />
              )}
            </div>
          )}

          {/* íƒ€ì„ë¼ì¸ ì½˜í…ì¸  */}
          <div className="max-h-[calc(90vh-200px)] overflow-y-auto p-6">
            <div className="flex flex-col gap-3">
              {sortedSlots.length === 0 ? (
                plans.length === 0 ? (
                  <div className="flex flex-col gap-2 py-12 text-center text-gray-400">
                    <div className="text-4xl">ğŸ“…</div>
                    <div className="text-lg font-medium">ì´ ë‚ ì§œì—ëŠ” í”Œëœì´ ì—†ìŠµë‹ˆë‹¤</div>
                  </div>
                ) : (
                  // plansëŠ” ìˆì§€ë§Œ íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ì´ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš° (ì‹œê°„ ì •ë³´ê°€ ì—†ëŠ” í”Œëœ)
                  <div className="flex flex-col gap-3">
                    {plans.map((plan) => (
                      <CalendarPlanCard
                        key={plan.id}
                        plan={plan}
                        compact={false}
                        showTime={true}
                        showProgress={true}
                      />
                    ))}
                  </div>
                )
              ) : (
                sortedSlots.map((slot, index) => {
                  // í•™ì›ì¼ì • í‘œì‹œ
                  if (slot.type === "í•™ì›ì¼ì •" && slot.academy) {
                    const colorClass = getTimeSlotColorClass(slot.type);
                    const icon = getTimeSlotIcon(slot.type);

                    return (
                      <div
                        key={`slot-${index}-academy`}
                        className={`rounded-lg border-2 p-4 ${colorClass}`}
                      >
                        <div className="flex items-center gap-3">
                          <span className="text-2xl">{icon}</span>
                          <div className="flex flex-1 flex-col gap-1">
                            <div className="font-semibold text-gray-900">
                              {slot.academy.academy_name || "í•™ì›"}
                            </div>
                            <div className="text-sm text-gray-600">
                              {slot.start} ~ {slot.end}
                            </div>
                            {slot.academy.subject && (
                              <div className="text-sm text-gray-500">
                                {slot.academy.subject}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  }

                  // í•™ìŠµì‹œê°„ì¸ ê²½ìš° í”Œëœ í‘œì‹œ
                  if (slot.type === "í•™ìŠµì‹œê°„") {
                    if (slot.plans && slot.plans.length > 0) {
                      return (
                        <div
                          key={`slot-${index}-study`}
                          className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4"
                        >
                          <div className="flex items-center justify-between">
                            <div className="font-semibold text-gray-900">
                              {slot.start} ~ {slot.end}
                            </div>
                            <span className="rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                              í•™ìŠµì‹œê°„
                            </span>
                          </div>
                          <div className="flex flex-col gap-3">
                            {slot.plans
                              .sort((a, b) => a.block_index - b.block_index)
                              .map((plan) => (
                                <CalendarPlanCard
                                  key={plan.id}
                                  plan={plan}
                                  compact={false}
                                  showTime={true}
                                  showProgress={true}
                                />
                              ))}
                          </div>
                        </div>
                      );
                    } else {
                      return (
                        <div
                          key={`slot-${index}-study-empty`}
                          className="rounded-lg border border-gray-200 bg-gray-50 p-4"
                        >
                          <div className="flex items-center justify-between">
                            <div className="font-medium text-gray-700">
                              {slot.start} ~ {slot.end}
                            </div>
                            <span className="text-sm text-gray-400">í”Œëœ ì—†ìŒ</span>
                          </div>
                        </div>
                      );
                    }
                  }

                  // ì ì‹¬ì‹œê°„, ì´ë™ì‹œê°„, ììœ¨í•™ìŠµ ë“± íŠ¹ìˆ˜ íƒ€ì„ìŠ¬ë¡¯ í‘œì‹œ
                  // (í•™ìŠµì‹œê°„ê³¼ í•™ì›ì¼ì •ì€ ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
                  {
                    const colorClass = getTimeSlotColorClass(slot.type);
                    const icon = getTimeSlotIcon(slot.type);

                    return (
                      <div
                        key={`slot-${index}-${slot.type}`}
                        className={`rounded-lg border p-4 ${colorClass}`}
                      >
                        <div className="flex items-center gap-3">
                          <span className="text-2xl">{icon}</span>
                          <div className="flex flex-1 flex-col gap-1">
                            <div className="font-semibold">{slot.label || slot.type}</div>
                            <div className="text-sm opacity-75">
                              {slot.start} ~ {slot.end}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  }

                  return null;
                })
              )}
            </div>
          </div>
      </div>
    </Dialog>
  );
}
</file>

<file path="calendar/_components/DayView.tsx">
"use client";

import React, { useMemo, memo } from "react";
import type { PlanWithContent } from "../_types/plan";
import type { PlanExclusion, AcademySchedule } from "@/lib/types/plan";
import { CONTENT_TYPE_EMOJIS } from "../_constants/contentIcons";
import { formatDateString, formatDateFull, isToday } from "@/lib/date/calendarUtils";
import { DAY_TYPE_INFO } from "@/lib/date/calendarDayTypes";
import type { DayTypeInfo } from "@/lib/date/calendarDayTypes";
import type { DailyScheduleInfo } from "@/lib/types/plan";
import { buildTimelineSlots, getTimeSlotColorClass, getTimeSlotIcon, timeToMinutes, type TimeSlotType } from "../_utils/timelineUtils";
import { StatCard } from "./StatCard";
import { CalendarPlanCard } from "./CalendarPlanCard";
import { TimelineItem } from "./TimelineItem";
import { ProgressBar } from "@/components/atoms/ProgressBar";

type PlanConnection = {
  planIds: string[];
  groupKey: string;
};

type DayViewProps = {
  plans: PlanWithContent[];
  currentDate: Date;
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  dayTypes: Map<string, DayTypeInfo>;
  dailyScheduleMap: Map<string, DailyScheduleInfo>;
  showOnlyStudyTime?: boolean;
};

function DayViewComponent({ plans, currentDate, exclusions, academySchedules, dayTypes, dailyScheduleMap, showOnlyStudyTime = false }: DayViewProps) {
  const dateStr = formatDateString(currentDate);
  const dayTypeInfo = dayTypes.get(dateStr);
  const dayType = dayTypeInfo?.type || "normal";
  
  // í•´ë‹¹ ë‚ ì§œì˜ daily_schedule ê°€ì ¸ì˜¤ê¸°
  const dailySchedule = dailyScheduleMap.get(dateStr);
  
  // í•´ë‹¹ ë‚ ì§œì˜ í”Œëœë§Œ í•„í„°ë§ (ë©”ëª¨ì´ì œì´ì…˜)
  const dayPlans = useMemo(
    () => plans.filter((plan) => plan.plan_date === dateStr),
    [plans, dateStr]
  );

  // ê°™ì€ í”Œëœì˜ ë™ì¼ íšŒì°¨ë¥¼ ê·¸ë£¹í™” (plan_number ë˜ëŠ” content_id + sequence ê¸°ì¤€)
  const planConnections = useMemo(() => {
    const connectionMap = new Map<string, PlanConnection>();
    
    plans.forEach((plan) => {
      // ê·¸ë£¹ í‚¤ ìƒì„±: plan_numberê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ content_id + sequence ì¡°í•©
      const groupKey = plan.plan_number !== null && plan.plan_number !== undefined
        ? `plan_number_${plan.plan_number}`
        : plan.sequence !== null && plan.sequence !== undefined
        ? `content_${plan.content_id}_seq_${plan.sequence}`
        : null;
      
      if (!groupKey) return;
      
      if (!connectionMap.has(groupKey)) {
        connectionMap.set(groupKey, {
          planIds: [],
          groupKey,
        });
      }
      
      connectionMap.get(groupKey)!.planIds.push(plan.id);
    });
    
    // 2ê°œ ì´ìƒì˜ í”Œëœì´ ìˆëŠ” ê·¸ë£¹ë§Œ ë°˜í™˜
    return Array.from(connectionMap.values()).filter(
      (conn) => conn.planIds.length >= 2
    );
  }, [plans]);

  // ì—°ê²°ëœ í”Œëœ ID Set ìƒì„± (ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•´)
  const connectedPlanIds = useMemo(() => {
    const ids = new Set<string>();
    planConnections.forEach((conn) => {
      conn.planIds.forEach((id) => ids.add(id));
    });
    return ids;
  }, [planConnections]);

  // í•´ë‹¹ ë‚ ì§œì˜ í•™ì›ì¼ì • (ìš”ì¼ ê¸°ë°˜)
  const dayAcademySchedules = useMemo(() => {
    const dayOfWeek = currentDate.getDay();
    return academySchedules.filter((schedule) => schedule.day_of_week === dayOfWeek);
  }, [academySchedules, currentDate]);

  // í•´ë‹¹ ë‚ ì§œì˜ íœ´ì¼
  const dayExclusions = useMemo(
    () => exclusions.filter((exclusion) => exclusion.exclusion_date === dateStr),
    [exclusions, dateStr]
  );

  // íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ìƒì„±
  const timelineSlots = useMemo(() => {
    return buildTimelineSlots(
      dateStr,
      dailySchedule,
      dayPlans,
      dayAcademySchedules,
      dayExclusions
    );
  }, [dateStr, dailySchedule, dayPlans, dayAcademySchedules, dayExclusions]);

  // TIME_BLOCKSì™€ plansByBlock ìƒì„± (íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ê¸°ë°˜)
  // ëª¨ë“  íƒ€ì„ìŠ¬ë¡¯ì„ ì‹œê°„ ìˆœì„œëŒ€ë¡œ í¬í•¨ (í•™ìŠµì‹œê°„, ì ì‹¬ì‹œê°„, í•™ì›ì¼ì • ë“±)
  // showOnlyStudyTimeì´ trueë©´ í•™ìŠµì‹œê°„ë§Œ í•„í„°ë§
  // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (íƒ€ì… ë¬´ê´€)
  const { TIME_BLOCKS, plansByBlock, slotTypes, academyByBlock } = useMemo(() => {
    // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (start ì‹œê°„ ê¸°ì¤€)
    const sortedSlots = [...timelineSlots].sort((a, b) => {
      const aStart = timeToMinutes(a.start);
      const bStart = timeToMinutes(b.start);
      return aStart - bStart;
    });
    
    const filteredSlots = showOnlyStudyTime
      ? sortedSlots.filter((slot) => slot.type === "í•™ìŠµì‹œê°„")
      : sortedSlots;
    
    const blocks = filteredSlots.map((slot, index) => ({
      index,
      label: slot.label || `${slot.start} ~ ${slot.end}`,
      time: `${slot.start} ~ ${slot.end}`,
      startTime: slot.start,
      endTime: slot.end,
    }));

    const plansMap = new Map<number, PlanWithContent[]>();
    const typesMap = new Map<number, TimeSlotType>();
    const academyMap = new Map<number, AcademySchedule>();
    
    filteredSlots.forEach((slot, index) => {
      typesMap.set(index, slot.type);
      if (slot.type === "í•™ìŠµì‹œê°„" && slot.plans && slot.plans.length > 0) {
        plansMap.set(index, slot.plans);
      }
      if (slot.type === "í•™ì›ì¼ì •" && slot.academy) {
        academyMap.set(index, slot.academy);
      }
    });

    return {
      TIME_BLOCKS: blocks,
      plansByBlock: plansMap,
      slotTypes: typesMap,
      academyByBlock: academyMap,
    };
  }, [timelineSlots, showOnlyStudyTime]);

  // dayType ê¸°ë°˜ìœ¼ë¡œ ìŠ¤íƒ€ì¼ ê²°ì •
  const isHoliday = dayType === "ì§€ì •íœ´ì¼" || dayType === "íœ´ê°€" || dayType === "ê°œì¸ì¼ì •" || dayExclusions.length > 0;
  const isStudyDay = dayType === "í•™ìŠµì¼";
  const isReviewDay = dayType === "ë³µìŠµì¼";
  const isTodayDate = isToday(currentDate);

  // ë°°ê²½ìƒ‰ ê²°ì •
  const bgColorClass = isHoliday
    ? "border-red-300 bg-red-50"
    : isTodayDate
    ? "border-indigo-300 bg-indigo-50"
    : isStudyDay
    ? "border-blue-300 bg-blue-50"
    : isReviewDay
    ? "border-amber-300 bg-amber-50"
    : "border-gray-200 bg-white";

  // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì •
  const textColorClass = isHoliday
    ? "text-red-900"
    : isTodayDate
    ? "text-indigo-900"
    : isStudyDay
    ? "text-blue-900"
    : isReviewDay
    ? "text-amber-900"
    : "text-gray-900";

  const subtitleColorClass = isHoliday
    ? "text-red-700"
    : isStudyDay
    ? "text-blue-700"
    : isReviewDay
    ? "text-amber-700"
    : "text-gray-700";

  // í”Œëœ í†µê³„ ê³„ì‚°
  const totalPlans = dayPlans.length;
  const completedPlans = dayPlans.filter((p) => p.progress != null && p.progress >= 100).length;
  const activePlans = dayPlans.filter((p) => p.actual_start_time && !p.actual_end_time).length;
  const averageProgress = totalPlans > 0
    ? Math.round(
        dayPlans.reduce((sum, p) => sum + (p.progress || 0), 0) / totalPlans
      )
    : 0;

  // ë‚ ì§œ íƒ€ì… ë°°ì§€ ìŠ¤íƒ€ì¼
  const dayTypeBadgeClass = isHoliday
    ? "bg-red-100 text-red-800"
    : isStudyDay
    ? "bg-blue-100 text-blue-800"
    : isReviewDay
    ? "bg-amber-100 text-amber-800"
    : "bg-gray-100 text-gray-800";

  return (
    <div className="flex w-full flex-col gap-6">
      {/* ë‚ ì§œ í—¤ë” ë° ìš”ì•½ ì •ë³´ */}
      <div className={`rounded-xl border-2 p-6 shadow-lg ${bgColorClass}`}>
        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div className="flex flex-col gap-3">
            <h2 className={`text-3xl font-bold ${textColorClass}`}>
              {formatDateFull(currentDate)}
            </h2>
            {/* ë‚ ì§œ íƒ€ì… ë°°ì§€ */}
            {dayTypeInfo && dayType !== "normal" && (
              <div className="flex items-center gap-2 flex-wrap">
                <span className={`rounded-full px-4 py-1.5 text-sm font-bold border-2 shadow-sm ${dayTypeBadgeClass}`}>
                  {dayTypeInfo.icon} {dayTypeInfo.label}
                </span>
                {dayExclusions.length > 0 && dayExclusions[0].exclusion_type && (
                  <span className="text-sm font-medium text-gray-600">
                    ({dayExclusions[0].exclusion_type})
                  </span>
                )}
                {dayExclusions.length > 0 && dayExclusions[0].reason && (
                  <span className="text-sm font-medium text-gray-600">- {dayExclusions[0].reason}</span>
                )}
              </div>
            )}
          </div>

          {/* í†µê³„ ëŒ€ì‹œë³´ë“œ */}
          {(totalPlans > 0 || dayAcademySchedules.length > 0) && (
            <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
              {totalPlans > 0 && (
                <>
                  <StatCard label="ì´ í”Œëœ" value={totalPlans} color="gray" />
                  <StatCard label="ì™„ë£Œ" value={completedPlans} color="green" />
                  {activePlans > 0 && (
                    <StatCard label="ì§„í–‰ì¤‘" value={activePlans} color="blue" />
                  )}
                  {averageProgress > 0 && (
                    <StatCard label="í‰ê·  ì§„í–‰ë¥ " value={`${averageProgress}%`} color="indigo" />
                  )}
                </>
              )}
              {dayAcademySchedules.length > 0 && (
                <StatCard label="í•™ì› ì¼ì •" value={dayAcademySchedules.length} color="purple" />
              )}
            </div>
          )}
        </div>
      </div>

      {/* íƒ€ì„ë¼ì¸ ë·° (ì‹œê°„ ìˆœì„œëŒ€ë¡œ) */}
      <div className="rounded-xl border-2 border-gray-200 bg-white shadow-md">
        <div className="border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white px-6 py-4">
          <h3 className="text-xl font-bold text-gray-900">í•™ìŠµ í”Œëœ íƒ€ì„ë¼ì¸</h3>
        </div>
        <div className="p-6">
          {TIME_BLOCKS.length === 0 ? (
            <div className="flex flex-col gap-2 py-12 text-center text-gray-400">
              <div className="text-4xl">ğŸ“…</div>
              <div className="text-lg font-medium">ì´ ë‚ ì§œì—ëŠ” í”Œëœì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          ) : (
            <div className="flex flex-col gap-4">
              {TIME_BLOCKS.map((block, index) => {
                const slotType = slotTypes.get(block.index);
                const blockPlans = (plansByBlock.get(block.index) || [])
                  .sort((a, b) => a.block_index - b.block_index);
                const blockAcademy = academyByBlock.get(block.index);

                // íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ìƒì„±
                const slot = {
                  start: block.startTime,
                  end: block.endTime,
                  type: slotType || "í•™ìŠµì‹œê°„",
                  label: block.label,
                  plans: slotType === "í•™ìŠµì‹œê°„" ? blockPlans : undefined,
                  academy: slotType === "í•™ì›ì¼ì •" ? blockAcademy : undefined,
                };

                return (
                  <TimelineItem
                    key={block.index}
                    slot={slot}
                    isLast={index === TIME_BLOCKS.length - 1}
                    connectedPlanIds={connectedPlanIds}
                  />
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* ê¸°ì¡´ í…Œì´ë¸” ë·° (ìˆ¨ê¹€ ì²˜ë¦¬ - í•„ìš”ì‹œ ì£¼ì„ í•´ì œ) */}
      {false && (
      <div className="rounded-lg border border-gray-200 bg-white">
        <div className="border-b border-gray-200 bg-gray-50 px-4 py-3">
          <h3 className="text-lg font-semibold text-gray-900">í•™ìŠµ í”Œëœ</h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr className="border-b-2 border-gray-200 bg-gray-50">
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì‹œê°„ëŒ€</th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì½˜í…ì¸ </th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">êµê³¼/ê³¼ëª©</th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">ë²”ìœ„/ì‹œê°„</th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">ìƒíƒœ</th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì§„í–‰ë¥ /ì‹œê°„</th>
              </tr>
            </thead>
            <tbody>
              {TIME_BLOCKS.map((block) => {
                const slotType = slotTypes.get(block.index);
                const blockPlans = (plansByBlock.get(block.index) || [])
                  .sort((a, b) => a.block_index - b.block_index);
                const blockAcademy = academyByBlock.get(block.index);

                // í•™ì›ì¼ì • ì²˜ë¦¬
                if (slotType === "í•™ì›ì¼ì •" && blockAcademy) {
                  const colorClass = getTimeSlotColorClass(slotType);
                  const icon = getTimeSlotIcon(slotType);
                  
                  return (
                    <tr key={block.index} className={`border-b border-gray-100 ${colorClass}`}>
                      <td className="px-4 py-3 text-sm font-medium">
                        <div className="flex flex-col gap-0.5">
                          <span>{block.label}</span>
                          <span className="text-xs opacity-75">{block.time}</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-sm font-medium">
                        <div className="flex items-center gap-2">
                          <span>{icon}</span>
                          <span>{blockAcademy.academy_name || "í•™ì›"}</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-700">
                        {blockAcademy.subject || "-"}
                      </td>
                      <td colSpan={3} className="px-4 py-3 text-center text-sm text-gray-400">
                        í•™ì›ì¼ì •
                      </td>
                    </tr>
                  );
                }

                // ì ì‹¬ì‹œê°„, ì´ë™ì‹œê°„, ììœ¨í•™ìŠµ ë“± íŠ¹ìˆ˜ íƒ€ì„ìŠ¬ë¡¯ ì²˜ë¦¬
                if (slotType && slotType !== "í•™ìŠµì‹œê°„" && slotType !== "í•™ì›ì¼ì •") {
                  const colorClass = getTimeSlotColorClass(slotType);
                  const icon = getTimeSlotIcon(slotType);
                  
                  return (
                    <tr key={block.index} className={`border-b border-gray-100 ${colorClass}`}>
                      <td className="px-4 py-3 text-sm font-medium">
                        <div className="flex flex-col gap-0.5">
                          <span>{block.label}</span>
                          <span className="text-xs opacity-75">{block.time}</span>
                        </div>
                      </td>
                      <td colSpan={5} className="px-4 py-3 text-center text-sm font-medium">
                        <div className="flex items-center justify-center gap-2">
                          <span>{icon}</span>
                          <span>{slotType}</span>
                        </div>
                      </td>
                    </tr>
                  );
                }

                // í•™ìŠµì‹œê°„ ì²˜ë¦¬
                return (
                  <React.Fragment key={block.index}>
                    {/* í”Œëœ í–‰ë“¤ */}
                    {blockPlans.length > 0 ? (
                      blockPlans.map((plan, planIndex) => {
                        const contentTypeIcon = CONTENT_TYPE_EMOJIS[plan.content_type];
                        const isCompleted = plan.progress != null && plan.progress >= 100;
                        const isActive = plan.actual_start_time && !plan.actual_end_time;
                        const progressPercentage = plan.progress != null ? Math.round(plan.progress) : null;

                        return (
                          <tr
                            key={plan.id}
                            className={`border-b border-gray-100 hover:bg-gray-50 ${
                              isCompleted
                                ? "bg-green-50/50"
                                : isActive
                                ? "bg-blue-50/50"
                                : ""
                            }`}
                          >
                            {/* ì‹œê°„ëŒ€ (ì²« ë²ˆì§¸ í”Œëœë§Œ í‘œì‹œ) */}
                            {planIndex === 0 && (
                              <td
                                className="px-4 py-3 align-top text-sm font-medium text-gray-700"
                                rowSpan={blockPlans.length}
                              >
                                <div className="flex flex-col gap-0.5">
                                  <span>{block.label}</span>
                                  <span className="text-xs text-gray-500">{block.time}</span>
                                </div>
                              </td>
                            )}
                            {/* ì½˜í…ì¸  */}
                            <td className="px-4 py-3 align-top">
                              <div className="flex items-center gap-2">
                                <span className="text-base">{contentTypeIcon}</span>
                                <div className="flex flex-col gap-0.5">
                                  <span className="font-medium text-gray-900">
                                    {plan.contentTitle}
                                  </span>
                                  {plan.contentCategory && (
                                    <span className="text-xs text-gray-500">
                                      {plan.contentCategory}
                                    </span>
                                  )}
                                </div>
                              </div>
                            </td>
                            {/* êµê³¼/ê³¼ëª© */}
                            <td className="px-4 py-3 align-top text-sm text-gray-700">
                              <div className="flex flex-col gap-1">
                                {plan.contentSubjectCategory && (
                                  <span className="inline-block rounded bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-700">
                                    {plan.contentSubjectCategory}
                                  </span>
                                )}
                                {plan.contentSubject && (
                                  <span className="text-xs text-gray-600">
                                    {plan.contentSubject}
                                  </span>
                                )}
                                {!plan.contentSubjectCategory && !plan.contentSubject && (
                                  <span className="text-xs text-gray-400">-</span>
                                )}
                              </div>
                            </td>
                            {/* ë²”ìœ„ */}
                            <td className="px-4 py-3 align-top text-sm text-gray-700">
                              <div className="flex flex-col gap-1">
                                {plan.planned_start_page_or_time !== null &&
                                plan.planned_end_page_or_time !== null ? (
                                  <>
                                    {plan.content_type === "book" ? (
                                      <span>ğŸ“– {plan.planned_start_page_or_time}-{plan.planned_end_page_or_time}í˜ì´ì§€</span>
                                    ) : (
                                      <span>ğŸ§ {plan.planned_start_page_or_time}ê°•</span>
                                    )}
                                    {plan.chapter && (
                                      <span className="text-xs text-gray-500">
                                        ì±•í„°: {plan.chapter}
                                      </span>
                                    )}
                                  </>
                                ) : (
                                  <span className="text-xs text-gray-400">-</span>
                                )}
                                {/* ì‹œê°„ ì •ë³´ */}
                                {plan.start_time && plan.end_time && (
                                  <div className="flex items-center gap-1 text-xs text-blue-600">
                                    <span>â°</span>
                                    <span>{plan.start_time} ~ {plan.end_time}</span>
                                  </div>
                                )}
                                {/* ë¸”ë¡ ì¸ë±ìŠ¤ */}
                                <div className="text-xs text-gray-400">
                                  ë¸”ë¡ {plan.block_index}
                                </div>
                              </div>
                            </td>
                            {/* ìƒíƒœ */}
                            <td className="px-4 py-3 align-top">
                              <div className="flex flex-col gap-1">
                                {isCompleted && (
                                  <span className="inline-block w-fit rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
                                    âœ… ì™„ë£Œ
                                  </span>
                                )}
                                {isActive && (
                                  <span className="inline-block w-fit rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                                    â±ï¸ í•™ìŠµ ì¤‘
                                  </span>
                                )}
                                {!isCompleted && !isActive && (
                                  <span className="text-xs text-gray-400">ëŒ€ê¸°</span>
                                )}
                              </div>
                            </td>
                            {/* ì§„í–‰ë¥  */}
                            <td className="px-4 py-3 align-top">
                              <div className="flex flex-col gap-1">
                                {progressPercentage !== null ? (
                                  <>
                                    <span className="text-sm font-medium text-gray-700">
                                      {progressPercentage}%
                                    </span>
                                    <div className="w-20">
                                      <ProgressBar
                                        value={progressPercentage}
                                        variant={isCompleted ? "success" : isActive ? "default" : undefined}
                                        color={isCompleted ? undefined : isActive ? "blue" : undefined}
                                        size="xs"
                                      />
                                    </div>
                                  </>
                                ) : (
                                  <span className="text-xs text-gray-400">-</span>
                                )}
                                {/* ì™„ë£ŒëŸ‰ */}
                                {plan.completed_amount !== null && plan.planned_end_page_or_time !== null && (
                                  <div className="text-xs text-gray-500">
                                    ì™„ë£Œ: {plan.completed_amount} / {plan.planned_end_page_or_time}
                                  </div>
                                )}
                                {/* ì‹¤ì œ ì‹œê°„ ì •ë³´ */}
                                {plan.actual_start_time && (
                                  <div className="text-xs text-gray-500">
                                    ì‹œì‘: {new Date(plan.actual_start_time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                                  </div>
                                )}
                                {plan.actual_end_time && (
                                  <div className="text-xs text-gray-500">
                                    ì¢…ë£Œ: {new Date(plan.actual_end_time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                                  </div>
                                )}
                                {/* ì†Œìš” ì‹œê°„ */}
                                {plan.total_duration_seconds != null && (
                                  <div className="text-xs text-gray-500">
                                    ì†Œìš”: {Math.floor(plan.total_duration_seconds / 60)}ë¶„
                                  </div>
                                )}
                              </div>
                            </td>
                          </tr>
                        );
                      })
                    ) : (
                      // í”Œëœì´ ì—†ëŠ” í•™ìŠµì‹œê°„ëŒ€
                      <tr className="border-b border-gray-100">
                        <td className="px-4 py-3 text-sm font-medium text-gray-700">
                          <div className="flex flex-col gap-0.5">
                            <span>{block.label}</span>
                            <span className="text-xs text-gray-500">{block.time}</span>
                          </div>
                        </td>
                        <td colSpan={5} className="px-4 py-3 text-center text-sm text-gray-400">
                          í”Œëœ ì—†ìŒ
                        </td>
                      </tr>
                    )}
                  </React.Fragment>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
      )}

      {/* í”Œëœì´ ì—†ëŠ” ê²½ìš° */}
      {dayPlans.length === 0 && dayAcademySchedules.length === 0 && (
        <div className="rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-12 text-center">
          <div className="flex flex-col gap-4">
            <div className="text-4xl">ğŸ“…</div>
            <div className="flex flex-col gap-2">
              <div className="text-lg font-semibold text-gray-900">
                ì´ ë‚ ì§œì—ëŠ” í”Œëœì´ ì—†ìŠµë‹ˆë‹¤
              </div>
              <div className="text-sm text-gray-600">
                ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œìš´ í”Œëœì„ ì¶”ê°€í•´ì£¼ì„¸ìš”
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export const DayView = memo(DayViewComponent, (prevProps, nextProps) => {
  // currentDate ë¹„êµ (ë‚ ì§œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ)
  const prevDateStr = prevProps.currentDate.toISOString().slice(0, 10);
  const nextDateStr = nextProps.currentDate.toISOString().slice(0, 10);
  
  // plans ë°°ì—´ì˜ ê¸¸ì´ ë¹„êµ
  if (prevProps.plans.length !== nextProps.plans.length) {
    return false;
  }
  
  // í•´ë‹¹ ë‚ ì§œì˜ í”Œëœë§Œ ë¹„êµ
  const prevDayPlans = prevProps.plans.filter(p => p.plan_date === prevDateStr);
  const nextDayPlans = nextProps.plans.filter(p => p.plan_date === nextDateStr);
  
  if (prevDayPlans.length !== nextDayPlans.length) {
    return false;
  }
  
  return (
    prevDateStr === nextDateStr &&
    prevProps.showOnlyStudyTime === nextProps.showOnlyStudyTime &&
    prevProps.exclusions.length === nextProps.exclusions.length &&
    prevProps.academySchedules.length === nextProps.academySchedules.length &&
    prevProps.dayTypes.size === nextProps.dayTypes.size &&
    prevProps.dailyScheduleMap.size === nextProps.dailyScheduleMap.size
  );
});
</file>

<file path="calendar/_components/MonthView.tsx">
"use client";

import { useMemo, useState } from "react";
import type { PlanWithContent } from "../_types/plan";
import type { PlanExclusion, DailyScheduleInfo, AcademySchedule } from "@/lib/types/plan";
import { formatDateString, isToday } from "@/lib/date/calendarUtils";
import { DAY_TYPE_INFO } from "@/lib/date/calendarDayTypes";
import type { DayTypeInfo } from "@/lib/date/calendarDayTypes";
import { buildTimelineSlots, timeToMinutes } from "../_utils/timelineUtils";
import { CalendarPlanCard } from "./CalendarPlanCard";
import { DayTimelineModal } from "./DayTimelineModal";
import { getDayTypeColor } from "@/lib/constants/colors";

type MonthViewProps = {
  plans: PlanWithContent[];
  currentDate: Date;
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  dayTypes: Map<string, DayTypeInfo>;
  dailyScheduleMap: Map<string, DailyScheduleInfo>;
  showOnlyStudyTime?: boolean;
};

export function MonthView({ plans, currentDate, exclusions, academySchedules, dayTypes, dailyScheduleMap, showOnlyStudyTime = false }: MonthViewProps) {
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  // ì›”ì˜ ì²« ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();

  // ìš”ì¼ ë ˆì´ë¸”
  const weekdays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];

  // ë‚ ì§œë³„ í”Œëœ ê·¸ë£¹í™” (ë©”ëª¨ì´ì œì´ì…˜)
  const plansByDate = useMemo(() => {
    const map = new Map<string, PlanWithContent[]>();
    plans.forEach((plan) => {
      const date = plan.plan_date;
      if (!map.has(date)) {
        map.set(date, []);
      }
      map.get(date)!.push(plan);
    });
    return map;
  }, [plans]);

  // ê°™ì€ plan_numberë¥¼ ê°€ì§„ í”Œëœë“¤ì˜ ì—°ê²° ìƒíƒœ ê³„ì‚°
  const getPlanConnectionState = useMemo(() => {
    const connectionMap = new Map<string, {
      isConnected: boolean;
      isFirst: boolean;
      isLast: boolean;
      isMiddle: boolean;
    }>();
    
    // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
    plansByDate.forEach((dayPlans, date) => {
      // ê°™ì€ plan_numberë¥¼ ê°€ì§„ í”Œëœë“¤ì„ ê·¸ë£¹í™”
      const planNumberGroups = new Map<number | null, PlanWithContent[]>();
      
      dayPlans.forEach((plan) => {
        const planNumber = plan.plan_number ?? null;
        if (!planNumberGroups.has(planNumber)) {
          planNumberGroups.set(planNumber, []);
        }
        planNumberGroups.get(planNumber)!.push(plan);
      });
      
      // ê° ê·¸ë£¹ì—ì„œ 2ê°œ ì´ìƒì¸ ê²½ìš° ì—°ê²° ìƒíƒœ ê³„ì‚°
      planNumberGroups.forEach((groupPlans, planNumber) => {
        if (groupPlans.length >= 2 && planNumber !== null) {
          // block_index ìˆœìœ¼ë¡œ ì •ë ¬
          const sortedPlans = [...groupPlans].sort((a, b) => a.block_index - b.block_index);
          
          sortedPlans.forEach((plan, index) => {
            const isFirst = index === 0;
            const isLast = index === sortedPlans.length - 1;
            const isMiddle = !isFirst && !isLast;
            
            connectionMap.set(`${date}-${plan.id}`, {
              isConnected: true,
              isFirst,
              isLast,
              isMiddle,
            });
          });
        }
      });
    });
    
    return (date: string, planId: string) => {
      return connectionMap.get(`${date}-${planId}`) || {
        isConnected: false,
        isFirst: false,
        isLast: false,
        isMiddle: false,
      };
    };
  }, [plansByDate]);

  // ë‚ ì§œë³„ íœ´ì¼ ê·¸ë£¹í™” (ë©”ëª¨ì´ì œì´ì…˜)
  const exclusionsByDate = useMemo(() => {
    const map = new Map<string, PlanExclusion[]>();
    exclusions.forEach((exclusion) => {
      const date = exclusion.exclusion_date;
      if (!map.has(date)) {
        map.set(date, []);
      }
      map.get(date)!.push(exclusion);
    });
    return map;
  }, [exclusions]);

  // ë‚ ì§œ ì…€ ë Œë”ë§
  const renderDayCell = (day: number) => {
    const date = new Date(year, month, day);
    const dateStr = formatDateString(date);
    const dayPlans = plansByDate.get(dateStr) || [];
    const dayExclusions = exclusionsByDate.get(dateStr) || [];
    const dayTypeInfo = dayTypes.get(dateStr);
    const dayType = dayTypeInfo?.type || "normal";
    
    // dayType ê¸°ë°˜ìœ¼ë¡œ ìŠ¤íƒ€ì¼ ê²°ì •
    const isHoliday = dayType === "ì§€ì •íœ´ì¼" || dayType === "íœ´ê°€" || dayType === "ê°œì¸ì¼ì •" || dayExclusions.length > 0;
    const isTodayDate = isToday(date);
    
    // ë‚ ì§œ íƒ€ì… ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
    const dayTypeColor = getDayTypeColor(
      isHoliday ? "ì§€ì •íœ´ì¼" : dayType,
      isTodayDate
    );

    const bgColorClass = `${dayTypeColor.border} ${dayTypeColor.bg}`;
    const textColorClass = dayTypeColor.text;
    const dayTypeBadgeClass = dayTypeColor.badge;

    const handleDateClick = () => {
      setSelectedDate(date);
      setIsModalOpen(true);
    };

    return (
      <div
        key={day}
        className={`min-h-[120px] cursor-pointer rounded-lg border-2 p-2 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg ${bgColorClass}`}
        onClick={handleDateClick}
      >
        {/* ë‚ ì§œ í—¤ë” */}
        <div className="flex flex-col gap-1.5">
          <div className="flex items-center justify-between">
            <div className={`text-lg font-bold ${textColorClass}`}>
              {day}
            </div>
            {/* ë‚ ì§œ íƒ€ì… ë°°ì§€ - ì•„ì´ì½˜ë§Œ í‘œì‹œ */}
            {dayTypeInfo && dayType !== "normal" && (
              <span 
                className={`rounded-full p-1 text-sm border shadow-sm ${dayTypeBadgeClass}`}
                title={dayTypeInfo.label}
              >
                {dayTypeInfo.icon}
              </span>
            )}
          </div>
          <div className="flex flex-col gap-1.5">
          {/* íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ê¸°ë°˜ìœ¼ë¡œ í”Œëœ ë° ê¸°íƒ€ ìŠ¬ë¡¯ í‘œì‹œ */}
          {(() => {
            const dailySchedule = dailyScheduleMap.get(dateStr);
            const dayExclusions = exclusionsByDate.get(dateStr) || [];
            
            // í•´ë‹¹ ë‚ ì§œì˜ í•™ì›ì¼ì • (ìš”ì¼ ê¸°ë°˜)
            const dayOfWeek = date.getDay();
            const dayAcademySchedules = academySchedules.filter(
              (schedule) => schedule.day_of_week === dayOfWeek
            );
            
            // íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ìƒì„± (ì£¼ë³„/ì¼ë³„ê³¼ ë™ì¼í•œ ë°©ì‹)
            const timelineSlots = buildTimelineSlots(
              dateStr,
              dailySchedule,
              dayPlans,
              dayAcademySchedules,
              dayExclusions
            );
            
            // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            const sortedSlots = [...timelineSlots].sort((a, b) => {
              const aStart = timeToMinutes(a.start);
              const bStart = timeToMinutes(b.start);
              return aStart - bStart;
            });
            
            // showOnlyStudyTime í•„í„°ë§
            const filteredSlots = showOnlyStudyTime
              ? sortedSlots.filter((slot) => slot.type === "í•™ìŠµì‹œê°„")
              : sortedSlots;
            
            const items: React.ReactElement[] = [];
            const addedPlanIds = new Set<string>();
            
            // ìµœëŒ€ 6ê°œê¹Œì§€ë§Œ í‘œì‹œ (ê³µê°„ ì œì•½)
            let displayedCount = 0;
            const maxDisplay = 6;
            
            filteredSlots.forEach((slot) => {
              if (displayedCount >= maxDisplay) return;
              
              // í•™ì›ì¼ì • í‘œì‹œ
              if (slot.type === "í•™ì›ì¼ì •" && slot.academy) {
                if (displayedCount < maxDisplay) {
                  items.push(
                    <div
                      key={`slot-${slot.start}-${slot.end}-academy`}
                      className="truncate rounded bg-purple-100 px-1.5 py-0.5 text-xs text-purple-800"
                      title={`${slot.academy.academy_name || "í•™ì›"}: ${slot.start} ~ ${slot.end}`}
                    >
                      ğŸ« {slot.academy.academy_name || "í•™ì›"}
                    </div>
                  );
                  displayedCount++;
                }
                return;
              }
              
              // ì ì‹¬ì‹œê°„, ì´ë™ì‹œê°„, ììœ¨í•™ìŠµ í‘œì‹œ
              if (slot.type !== "í•™ìŠµì‹œê°„") {
                if (displayedCount < maxDisplay && !showOnlyStudyTime) {
                  const icon = slot.type === "ì ì‹¬ì‹œê°„" ? "ğŸ½ï¸" : slot.type === "ì´ë™ì‹œê°„" ? "ğŸš¶" : slot.type === "ììœ¨í•™ìŠµ" ? "ğŸ“–" : "â°";
                  // ììœ¨í•™ìŠµì€ ì´ˆë¡ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” ì£¼í™©ìƒ‰
                  const colorClass = slot.type === "ììœ¨í•™ìŠµ" 
                    ? "bg-green-100 text-green-800"
                    : "bg-orange-100 text-orange-800";
                  items.push(
                    <div
                      key={`slot-${slot.start}-${slot.end}-${slot.type}`}
                      className={`truncate rounded px-1.5 py-0.5 text-xs ${colorClass}`}
                      title={`${slot.type}: ${slot.start} ~ ${slot.end}`}
                    >
                      {icon} {slot.type}
                    </div>
                  );
                  displayedCount++;
                }
                return;
              }
              
              // í•™ìŠµì‹œê°„ì¸ ê²½ìš° í”Œëœ í‘œì‹œ
              if (slot.type === "í•™ìŠµì‹œê°„" && slot.plans && slot.plans.length > 0) {
                slot.plans
                  .sort((a, b) => {
                    // ì‹œê°„ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‹œê°„ ìˆœ, ì—†ìœ¼ë©´ block_index ìˆœ
                    if (a.start_time && b.start_time) {
                      return timeToMinutes(a.start_time) - timeToMinutes(b.start_time);
                    }
                    return a.block_index - b.block_index;
                  })
                  .forEach((plan) => {
                    if (displayedCount >= maxDisplay || addedPlanIds.has(plan.id)) {
                      return;
                    }
                    addedPlanIds.add(plan.id);
                    
                    // ì—°ê²° ìƒíƒœ ê³„ì‚°
                    const connectionState = getPlanConnectionState(dateStr, plan.id);
                    
                    items.push(
                      <CalendarPlanCard
                        key={plan.id}
                        plan={plan}
                        compact={true}
                        showTime={false}
                        showProgress={false}
                        isConnected={connectionState.isConnected}
                        isFirst={connectionState.isFirst}
                        isLast={connectionState.isLast}
                        isMiddle={connectionState.isMiddle}
                      />
                    );
                    displayedCount++;
                  });
              }
            });
            
            // í”Œëœì´ íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ì— ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° (ì‹œê°„ ì •ë³´ê°€ ì—†ëŠ” ê¸°ì¡´ í”Œëœ)
            const unmatchedPlans = dayPlans.filter((plan) => !addedPlanIds.has(plan.id));
            if (unmatchedPlans.length > 0 && displayedCount < maxDisplay) {
              unmatchedPlans
                .sort((a, b) => a.block_index - b.block_index)
                .slice(0, maxDisplay - displayedCount)
                .forEach((plan) => {
                  // ì—°ê²° ìƒíƒœ ê³„ì‚°
                  const connectionState = getPlanConnectionState(dateStr, plan.id);
                  
                  items.push(
                    <CalendarPlanCard
                      key={plan.id}
                      plan={plan}
                      compact={true}
                      showTime={false}
                      showProgress={false}
                      isConnected={connectionState.isConnected}
                      isFirst={connectionState.isFirst}
                      isLast={connectionState.isLast}
                      isMiddle={connectionState.isMiddle}
                    />
                  );
                  displayedCount++;
                });
            }
            
            // ì´ ê°œìˆ˜ í‘œì‹œ
            const totalItems = filteredSlots.reduce((count, slot) => {
              if (slot.type === "í•™ìŠµì‹œê°„" && slot.plans) {
                return count + slot.plans.length;
              }
              return count + 1;
            }, 0) + unmatchedPlans.length;
            
            return (
              <div className="flex flex-col gap-1">
                {items}
                {totalItems > maxDisplay && (
                  <div 
                    className="flex items-center justify-center rounded-md bg-gray-100 px-1.5 py-1 text-gray-600"
                    title={`${totalItems - maxDisplay}ê°œ ë” ìˆìŒ`}
                  >
                    <span className="text-xs">â‹¯</span>
                  </div>
                )}
              </div>
            );
          })()}
          </div>
        </div>
      </div>
    );
  };

  // ë¹ˆ ì…€ ë Œë”ë§
  const renderEmptyCell = (key: string) => (
    <div key={key} className="min-h-[100px] border border-gray-200 bg-gray-50" />
  );

  // ìº˜ë¦°ë” ê·¸ë¦¬ë“œ ìƒì„±
  const cells: (React.ReactElement | null)[] = [];
  
  // ì²« ì£¼ì˜ ë¹ˆ ì…€
  for (let i = 0; i < startingDayOfWeek; i++) {
    cells.push(renderEmptyCell(`empty-${i}`));
  }

  // ë‚ ì§œ ì…€
  for (let day = 1; day <= daysInMonth; day++) {
    cells.push(renderDayCell(day));
  }

  // ë§ˆì§€ë§‰ ì£¼ì˜ ë¹ˆ ì…€ (ì´ 42ê°œ ì…€ ìœ ì§€)
  const totalCells = 42;
  const remainingCells = totalCells - cells.length;
  for (let i = 0; i < remainingCells; i++) {
    cells.push(renderEmptyCell(`empty-end-${i}`));
  }

  return (
    <>
      <div className="w-full">
        {/* ìš”ì¼ í—¤ë” */}
        <div className="grid grid-cols-7 gap-1">
          {weekdays.map((day) => (
            <div
              key={day}
              className="py-2 text-center text-sm font-semibold text-gray-700"
            >
              {day}
            </div>
          ))}
        </div>

        {/* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ */}
        <div className="grid grid-cols-7 gap-1">{cells}</div>
      </div>

      {/* íƒ€ì„ë¼ì¸ ëª¨ë‹¬ */}
      {selectedDate && (() => {
        const selectedDateStr = formatDateString(selectedDate);
        const selectedDatePlans = plans.filter((plan) => plan.plan_date === selectedDateStr);
        
        return (
          <DayTimelineModal
            open={isModalOpen}
            onOpenChange={setIsModalOpen}
            date={selectedDate}
            plans={selectedDatePlans}
            exclusions={exclusions.filter((ex) => ex.exclusion_date === selectedDateStr)}
            academySchedules={academySchedules}
            dayTypeInfo={dayTypes.get(selectedDateStr)}
            dailySchedule={dailyScheduleMap.get(selectedDateStr)}
          />
        );
      })()}
    </>
  );
}
</file>

<file path="calendar/_components/PlanCalendarView.tsx">
"use client";

import { useState } from "react";
import { ChevronLeft, ChevronRight, Calendar as CalendarIcon, Filter } from "lucide-react";
import { MonthView } from "./MonthView";
import { WeekView } from "./WeekView";
import { DayView } from "./DayView";
import type { PlanWithContent } from "../_types/plan";
import type { PlanExclusion, AcademySchedule } from "@/lib/types/plan";
import { formatMonthYear, formatWeekRangeShort, formatDay, parseDateString } from "@/lib/date/calendarUtils";
import { buildDayTypesFromDailySchedule } from "@/lib/date/calendarDayTypes";
import { useMemo } from "react";
import type { DailyScheduleInfo } from "@/lib/types/plan";

type PlanCalendarViewProps = {
  plans: PlanWithContent[];
  view: "month" | "week" | "day";
  minDate: string;
  maxDate: string;
  initialDate: string;
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  dailySchedules: DailyScheduleInfo[][]; // í”Œëœ ê·¸ë£¹ë“¤ì˜ daily_schedule ë°°ì—´
};

/**
 * ë‚ ì§œë³„ daily_schedule ë§µ ìƒì„±
 * ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ í”Œëœ ê·¸ë£¹ì´ ìˆìœ¼ë©´ í•©ì¹˜ê¸° (ìš°ì„ ìˆœìœ„ ë°˜ì˜)
 */
function buildDailyScheduleMap(
  dailySchedules: DailyScheduleInfo[][]
): Map<string, DailyScheduleInfo> {
  const map = new Map<string, DailyScheduleInfo>();

  // ëª¨ë“  daily_scheduleì„ ìˆœíšŒí•˜ë©° ë‚ ì§œë³„ë¡œ í•©ì¹˜ê¸°
  dailySchedules.forEach((scheduleArray) => {
    scheduleArray.forEach((daily) => {
      const dateStr = daily.date.slice(0, 10);
      const existing = map.get(dateStr);

      // ê¸°ì¡´ í•­ëª©ì´ ì—†ê±°ë‚˜, ë” ë‚˜ì¤‘ì— ìƒì„±ëœ í•­ëª©ì´ ìš°ì„ 
      // (ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ í”Œëœ ê·¸ë£¹ì´ ìˆìœ¼ë©´ ë‚˜ì¤‘ ê²ƒì„ ìš°ì„ )
      if (!existing) {
        map.set(dateStr, daily);
      } else {
        // time_slotsê°€ ë” ë§ì€ ê²ƒì„ ìš°ì„ 
        if (daily.time_slots && daily.time_slots.length > 0) {
          map.set(dateStr, daily);
        }
      }
    });
  });

  return map;
}

export function PlanCalendarView({
  plans,
  view: initialView,
  minDate,
  maxDate,
  initialDate,
  exclusions,
  academySchedules,
  dailySchedules,
}: PlanCalendarViewProps) {
  // initialDateë¥¼ Date ê°ì²´ë¡œ ë³€í™˜ (YYYY-MM-DD í˜•ì‹)
  // ë¡œì»¬ íƒ€ì„ì¡´ ê¸°ì¤€ìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ ë‚ ì§œê°€ ë³€ê²½ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
  const initialDateObj = parseDateString(initialDate);
  const [currentDate, setCurrentDate] = useState(initialDateObj);
  const [view, setView] = useState<"month" | "week" | "day">(initialView);
  const [showOnlyStudyTime, setShowOnlyStudyTime] = useState(false);

  // í”Œëœ ê·¸ë£¹ì˜ daily_scheduleì—ì„œ ë‚ ì§œë³„ ì¼ì • íƒ€ì… ì •ë³´ ìƒì„±
  // Step7ì—ì„œ ìƒì„±ëœ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¬ê³„ì‚° ë¶ˆí•„ìš”)
  // ë‹¨, ì œì™¸ì¼ì€ ì‹¤ì œ ì œì™¸ì¼ ëª©ë¡(exclusions)ì— ìˆëŠ” ê²ƒë§Œ í‘œì‹œ
  const dayTypes = useMemo(() => {
    return buildDayTypesFromDailySchedule(dailySchedules, exclusions);
  }, [dailySchedules, exclusions]);

  // ë‚ ì§œë³„ daily_schedule ë§µ ìƒì„± (íƒ€ì„ë¼ì¸ ì •ë³´ í¬í•¨)
  const dailyScheduleMap = useMemo(() => {
    return buildDailyScheduleMap(dailySchedules);
  }, [dailySchedules]);

  const goToPrevious = () => {
    const newDate = new Date(currentDate);
    if (view === "month") {
      newDate.setMonth(newDate.getMonth() - 1);
    } else if (view === "week") {
      newDate.setDate(newDate.getDate() - 7);
    } else {
      newDate.setDate(newDate.getDate() - 1);
    }
    setCurrentDate(newDate);
  };

  const goToNext = () => {
    const newDate = new Date(currentDate);
    if (view === "month") {
      newDate.setMonth(newDate.getMonth() + 1);
    } else if (view === "week") {
      newDate.setDate(newDate.getDate() + 7);
    } else {
      newDate.setDate(newDate.getDate() + 1);
    }
    setCurrentDate(newDate);
  };

  const goToToday = () => {
    setCurrentDate(new Date());
  };

  return (
    <div className="rounded-xl border-2 border-gray-200 bg-white shadow-lg">
      {/* í—¤ë” */}
      <div className="border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white px-6 py-5">
        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          {/* ì™¼ìª½: ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="flex items-center gap-3">
            <button
              onClick={goToPrevious}
              aria-label="ì´ì „ ê¸°ê°„ìœ¼ë¡œ ì´ë™"
              className="rounded-lg p-2 text-gray-600 transition-all duration-200 hover:bg-gray-100 hover:scale-110 active:scale-95"
            >
              <ChevronLeft className="h-5 w-5" />
            </button>
            <h2 className="text-2xl font-bold text-gray-900">
              {view === "month"
                ? formatMonthYear(currentDate)
                : view === "week"
                ? formatWeekRangeShort(currentDate)
                : formatDay(currentDate)}
            </h2>
            <button
              onClick={goToNext}
              aria-label="ë‹¤ìŒ ê¸°ê°„ìœ¼ë¡œ ì´ë™"
              className="rounded-lg p-2 text-gray-600 transition-all duration-200 hover:bg-gray-100 hover:scale-110 active:scale-95"
            >
              <ChevronRight className="h-5 w-5" />
            </button>
            <button
              onClick={goToToday}
              aria-label="ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ë™"
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-bold text-white shadow-md transition-all duration-200 hover:bg-indigo-700 hover:shadow-lg active:scale-95"
            >
              ì˜¤ëŠ˜
            </button>
          </div>

          {/* ì˜¤ë¥¸ìª½: ë·° ì „í™˜ ë° í•„í„° */}
          <div className="flex items-center gap-3">
            {/* ë·° ì „í™˜ ë²„íŠ¼ ê·¸ë£¹ */}
            <div className="flex rounded-lg border-2 border-gray-200 bg-gray-50 p-1 shadow-sm">
              <button
                onClick={() => setView("month")}
                className={`rounded-md px-4 py-2 text-sm font-semibold transition-all duration-200 ${
                  view === "month"
                    ? "bg-white text-indigo-600 shadow-md scale-105"
                    : "text-gray-700 hover:text-gray-900 hover:bg-gray-100"
                }`}
              >
                <CalendarIcon className="inline h-4 w-4" />
                ì›”ë³„
              </button>
              <button
                onClick={() => setView("week")}
                className={`rounded-md px-4 py-2 text-sm font-semibold transition-all duration-200 ${
                  view === "week"
                    ? "bg-white text-indigo-600 shadow-md scale-105"
                    : "text-gray-700 hover:text-gray-900 hover:bg-gray-100"
                }`}
              >
                ì£¼ë³„
              </button>
              <button
                onClick={() => setView("day")}
                className={`rounded-md px-4 py-2 text-sm font-semibold transition-all duration-200 ${
                  view === "day"
                    ? "bg-white text-indigo-600 shadow-md scale-105"
                    : "text-gray-700 hover:text-gray-900 hover:bg-gray-100"
                }`}
              >
                ì¼ë³„
              </button>
            </div>

            {/* í•„í„° ë²„íŠ¼ */}
            <button
              onClick={() => setShowOnlyStudyTime(!showOnlyStudyTime)}
              className={`flex items-center gap-2 rounded-lg border-2 bg-white px-4 py-2 text-sm font-semibold transition-all duration-200 hover:shadow-md active:scale-95 ${
                showOnlyStudyTime 
                  ? "border-indigo-400 bg-indigo-50 text-indigo-700 shadow-sm" 
                  : "border-gray-200 text-gray-700 hover:bg-gray-50"
              }`}
              title={showOnlyStudyTime ? "ëª¨ë“  íƒ€ì„ìŠ¬ë¡¯ í‘œì‹œ" : "í•™ìŠµì‹œê°„ë§Œ í‘œì‹œ"}
            >
              <Filter className="h-4 w-4" />
              <span>{showOnlyStudyTime ? "ì „ì²´" : "í•™ìŠµì‹œê°„ë§Œ"}</span>
            </button>
          </div>
        </div>
      </div>

      {/* ìº˜ë¦°ë” ë·° */}
      <div className="p-4">
        {view === "month" ? (
          <MonthView plans={plans} currentDate={currentDate} exclusions={exclusions} academySchedules={academySchedules} dayTypes={dayTypes} dailyScheduleMap={dailyScheduleMap} showOnlyStudyTime={showOnlyStudyTime} />
        ) : view === "week" ? (
          <WeekView plans={plans} currentDate={currentDate} exclusions={exclusions} academySchedules={academySchedules} dayTypes={dayTypes} dailyScheduleMap={dailyScheduleMap} showOnlyStudyTime={showOnlyStudyTime} />
        ) : (
          <DayView plans={plans} currentDate={currentDate} exclusions={exclusions} academySchedules={academySchedules} dayTypes={dayTypes} dailyScheduleMap={dailyScheduleMap} showOnlyStudyTime={showOnlyStudyTime} />
        )}
      </div>
    </div>
  );
}
</file>

<file path="calendar/_components/StatCard.tsx">
"use client";

type StatCardProps = {
  label: string;
  value: string | number;
  color?: "gray" | "green" | "blue" | "indigo" | "red" | "amber" | "purple";
  icon?: React.ReactNode;
};

export function StatCard({ label, value, color = "gray", icon }: StatCardProps) {
  const colorClasses = {
    gray: "bg-gray-100 text-gray-900",
    green: "bg-green-100 text-green-900",
    blue: "bg-blue-100 text-blue-900",
    indigo: "bg-indigo-100 text-indigo-900",
    red: "bg-red-100 text-red-900",
    amber: "bg-amber-100 text-amber-900",
    purple: "bg-purple-100 text-purple-900",
  };

  return (
    <div className={`rounded-lg p-4 ${colorClasses[color]}`}>
      <div className="flex flex-col gap-1">
        <div className="flex items-center gap-2">
          {icon && <span className="text-base">{icon}</span>}
          <div className="text-xs font-medium opacity-75">{label}</div>
        </div>
        <div className="text-2xl font-bold">{value}</div>
      </div>
    </div>
  );
}
</file>

<file path="calendar/_components/TimelineItem.tsx">
"use client";

import type { PlanWithContent } from "../_types/plan";
import type { AcademySchedule } from "@/lib/types/plan";
import { getTimeSlotColorClass, getTimeSlotIcon } from "../_utils/timelineUtils";
import { CalendarPlanCard } from "./CalendarPlanCard";

type TimelineSlot = {
  start: string;
  end: string;
  type: string;
  label?: string;
  plans?: PlanWithContent[];
  academy?: AcademySchedule;
};

type TimelineItemProps = {
  slot: TimelineSlot;
  isLast?: boolean;
  connectedPlanIds?: Set<string>;
};

export function TimelineItem({ slot, isLast = false, connectedPlanIds }: TimelineItemProps) {
  const colorClass = getTimeSlotColorClass(slot.type as "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ");
  const icon = getTimeSlotIcon(slot.type as "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ");

  // ì‹œê°„ì—ì„œ ì‹œ(hour)ë§Œ ì¶”ì¶œ (ì˜ˆ: "10:00" -> "10ì‹œ")
  const startHour = slot.start.split(":")[0];
  const endHour = slot.end.split(":")[0];

  return (
    <div className="relative flex gap-4">
      {/* ì‹œê°„ëŒ€ ë¼ì¸ */}
      <div className="flex flex-col items-center gap-2">
        <div className="rounded-lg bg-white px-4 py-2 text-base font-bold text-gray-900 shadow-md border-2 border-gray-300">
          {startHour}ì‹œ
        </div>
        {!isLast && (
          <div className="h-full min-h-[60px] w-1 bg-gradient-to-b from-gray-300 to-gray-200"></div>
        )}
      </div>

      {/* ì½˜í…ì¸  ì˜ì—­ */}
      <div className="flex-1 pb-4">
        <div className={`flex flex-col gap-4 rounded-lg border-2 p-5 transition-all duration-200 hover:scale-[1.01] hover:shadow-lg ${colorClass}`}>
          {/* íƒ€ì… í—¤ë” */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-2xl">{icon}</span>
              {(slot.type === "í•™ìŠµì‹œê°„" || slot.type === "í•™ì›ì¼ì •") && (
                <span className="text-lg font-bold text-gray-900">
                  {slot.start} ~ {slot.end}
                </span>
              )}
            </div>
            <span className={`rounded-full px-4 py-1.5 text-xs font-bold shadow-sm ${
              slot.type === "í•™ìŠµì‹œê°„"
                ? "bg-blue-500 text-white"
                : slot.type === "í•™ì›ì¼ì •"
                ? "bg-purple-500 text-white"
                : slot.type === "ììœ¨í•™ìŠµ"
                ? "bg-green-500 text-white"
                : "bg-orange-500 text-white"
            }`}>
              {slot.type}
            </span>
          </div>

          {/* í•™ì›ì¼ì • í‘œì‹œ */}
          {slot.type === "í•™ì›ì¼ì •" && slot.academy && (
            <div className="flex flex-col gap-1 rounded-lg bg-white/60 p-3">
              <div className="font-medium text-gray-900">
                {slot.academy.academy_name || "í•™ì›"}
              </div>
              {slot.academy.subject && (
                <div className="text-sm text-gray-600">
                  {slot.academy.subject}
                </div>
              )}
            </div>
          )}

          {/* í”Œëœ ëª©ë¡ */}
          {slot.type === "í•™ìŠµì‹œê°„" && slot.plans && slot.plans.length > 0 && (
            <div className="flex flex-col gap-3">
              {slot.plans
                .sort((a, b) => {
                  // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ì‹œê°„ì´ ìˆìœ¼ë©´ ì‹œê°„ ìˆœ, ì—†ìœ¼ë©´ block_index ìˆœ)
                  if (a.start_time && b.start_time) {
                    const aTime = parseInt(a.start_time.replace(":", ""));
                    const bTime = parseInt(b.start_time.replace(":", ""));
                    return aTime - bTime;
                  }
                  return (a.block_index || 0) - (b.block_index || 0);
                })
                .map((plan) => (
                  <CalendarPlanCard
                    key={plan.id}
                    plan={plan}
                    compact={false}
                    showTime={true}
                    showProgress={true}
                    isConnected={connectedPlanIds?.has(plan.id) || false}
                  />
                ))}
            </div>
          )}

          {/* í”Œëœì´ ì—†ëŠ” í•™ìŠµì‹œê°„ */}
          {slot.type === "í•™ìŠµì‹œê°„" && (!slot.plans || slot.plans.length === 0) && (
            <div className="rounded-lg bg-white/60 p-3 text-center text-sm text-gray-400">
              í”Œëœ ì—†ìŒ
            </div>
          )}

          {/* íŠ¹ìˆ˜ íƒ€ì„ìŠ¬ë¡¯ (ì ì‹¬ì‹œê°„, ì´ë™ì‹œê°„, ììœ¨í•™ìŠµ ë“±) */}
          {slot.type !== "í•™ìŠµì‹œê°„" && slot.type !== "í•™ì›ì¼ì •" && (
            <div className="rounded-lg bg-white/60 p-3">
              {slot.type === "ì ì‹¬ì‹œê°„" ? (
                <div className="font-medium text-gray-900">ë§›ìˆëŠ” ì ì‹¬ì‹ì‚¬ ë“œì„¸ìš”.</div>
              ) : slot.type === "ììœ¨í•™ìŠµ" ? (
                <div className="font-medium text-gray-900">ì™„ë£Œí•˜ì§€ ëª»í•œ í•™ìŠµ ë˜ëŠ” ë³µìŠµì„ ì§„í–‰í•˜ì„¸ìš”.</div>
              ) : (
                <div className="font-medium">{slot.label || slot.type}</div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="calendar/_components/WeekView.tsx">
"use client";

import { useMemo, useState, memo } from "react";
import dynamic from "next/dynamic";
import { Link2 } from "lucide-react";
import type { PlanWithContent } from "../_types/plan";
import type { PlanExclusion, AcademySchedule, DailyScheduleInfo } from "@/lib/types/plan";
import { CONTENT_TYPE_EMOJIS } from "../_constants/contentIcons";
import { getWeekStart, formatDateString, isToday } from "@/lib/date/calendarUtils";
import { DAY_TYPE_INFO } from "@/lib/date/calendarDayTypes";
import type { DayTypeInfo } from "@/lib/date/calendarDayTypes";
import { buildTimelineSlots, getTimeSlotColorClass, getTimeSlotIcon, timeToMinutes, type TimeSlotType } from "../_utils/timelineUtils";
import { getDayTypeColor } from "@/lib/constants/colors";
import { LoadingSkeleton } from "@/components/ui/LoadingSkeleton";

// í° ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ëŠ” ë™ì  importë¡œ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…
const DayTimelineModal = dynamic(
  () => import("./DayTimelineModal").then((mod) => ({ default: mod.DayTimelineModal })),
  {
    loading: () => <LoadingSkeleton />,
    ssr: false,
  }
);

type WeekViewProps = {
  plans: PlanWithContent[];
  currentDate: Date;
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  dayTypes: Map<string, DayTypeInfo>;
  dailyScheduleMap: Map<string, DailyScheduleInfo>;
  showOnlyStudyTime?: boolean;
};

type PlanConnection = {
  planIds: string[];
  groupKey: string;
};

function WeekViewComponent({ plans, currentDate, exclusions, academySchedules, dayTypes, dailyScheduleMap, showOnlyStudyTime = false }: WeekViewProps) {
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // ì£¼ ì‹œì‘ì¼ ê³„ì‚° (ë©”ëª¨ì´ì œì´ì…˜)
  const weekStart = useMemo(() => getWeekStart(currentDate), [currentDate]);
  
  // ì£¼ì˜ 7ì¼ ìƒì„± (ë©”ëª¨ì´ì œì´ì…˜)
  const weekDays = useMemo(() => {
    const days: Date[] = [];
    for (let i = 0; i < 7; i++) {
      const date = new Date(weekStart);
      date.setDate(weekStart.getDate() + i);
      days.push(date);
    }
    return days;
  }, [weekStart]);

  const weekdays = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"];

  // ë‚ ì§œë³„ í”Œëœ ê·¸ë£¹í™” (ë©”ëª¨ì´ì œì´ì…˜)
  const plansByDate = useMemo(() => {
    const map = new Map<string, PlanWithContent[]>();
    plans.forEach((plan) => {
      const date = plan.plan_date;
      if (!map.has(date)) {
        map.set(date, []);
      }
      map.get(date)!.push(plan);
    });
    return map;
  }, [plans]);

  // ë‚ ì§œë³„ íœ´ì¼ ê·¸ë£¹í™” (ë©”ëª¨ì´ì œì´ì…˜)
  const exclusionsByDate = useMemo(() => {
    const map = new Map<string, PlanExclusion[]>();
    exclusions.forEach((exclusion) => {
      const date = exclusion.exclusion_date;
      if (!map.has(date)) {
        map.set(date, []);
      }
      map.get(date)!.push(exclusion);
    });
    return map;
  }, [exclusions]);

  // ë‚ ì§œë³„ í•™ì›ì¼ì • ê·¸ë£¹í™” (ë©”ëª¨ì´ì œì´ì…˜)
  const academySchedulesByDate = useMemo(() => {
    const map = new Map<string, AcademySchedule[]>();
    weekDays.forEach((date) => {
      const dateStr = formatDateString(date);
      const dayOfWeek = date.getDay();
      // ìš”ì¼ì´ ì¼ì¹˜í•˜ëŠ” í•™ì›ì¼ì • ì°¾ê¸° (0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼, ...)
      const daySchedules = academySchedules.filter(
        (schedule) => schedule.day_of_week === dayOfWeek
      );
      if (daySchedules.length > 0) {
        map.set(dateStr, daySchedules);
      }
    });
    return map;
  }, [academySchedules, weekDays]);

  const formatDate = (date: Date): string => {
    return `${date.getMonth() + 1}/${date.getDate()}`;
  };

  // ê°™ì€ í”Œëœì˜ ë™ì¼ íšŒì°¨ë¥¼ ê·¸ë£¹í™” (plan_number ë˜ëŠ” content_id + sequence ê¸°ì¤€)
  const planConnections = useMemo(() => {
    const connectionMap = new Map<string, PlanConnection>();
    
    plans.forEach((plan) => {
      // ê·¸ë£¹ í‚¤ ìƒì„±: plan_numberê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ content_id + sequence ì¡°í•©
      const groupKey = plan.plan_number !== null && plan.plan_number !== undefined
        ? `plan_number_${plan.plan_number}`
        : plan.sequence !== null && plan.sequence !== undefined
        ? `content_${plan.content_id}_seq_${plan.sequence}`
        : null;
      
      if (!groupKey) return;
      
      if (!connectionMap.has(groupKey)) {
        connectionMap.set(groupKey, {
          planIds: [],
          groupKey,
        });
      }
      
      connectionMap.get(groupKey)!.planIds.push(plan.id);
    });
    
    // 2ê°œ ì´ìƒì˜ í”Œëœì´ ìˆëŠ” ê·¸ë£¹ë§Œ ë°˜í™˜
    return Array.from(connectionMap.values()).filter(
      (conn) => conn.planIds.length >= 2
    );
  }, [plans]);

  // ì—°ê²°ëœ í”Œëœ ID Set ìƒì„± (ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•´)
  const connectedPlanIds = useMemo(() => {
    const ids = new Set<string>();
    planConnections.forEach((conn) => {
      conn.planIds.forEach((id) => ids.add(id));
    });
    return ids;
  }, [planConnections]);

  return (
    <>
      <div className="w-full flex flex-col gap-2">
        {/* ìš”ì¼ í—¤ë” (ì¹´ë“œ ì˜ì—­ ë°– ìƒë‹¨) */}
        <div className="grid grid-cols-7 gap-2">
          {weekdays.map((day, index) => (
            <div key={index} className="text-center">
              <div className="text-sm font-semibold text-gray-700">
                {day}
              </div>
            </div>
          ))}
        </div>

        {/* ë‚ ì§œ ì¹´ë“œë“¤ */}
        <div className="grid grid-cols-7 gap-2">
          {weekDays.map((date, index) => {
          const dateStr = formatDateString(date);
          const dayPlans = plansByDate.get(dateStr) || [];
          const dayExclusions = exclusionsByDate.get(dateStr) || [];
          const dayAcademySchedules = academySchedulesByDate.get(dateStr) || [];
          const dayTypeInfo = dayTypes.get(dateStr);
          const dayType = dayTypeInfo?.type || "normal";
          
          // dayType ê¸°ë°˜ìœ¼ë¡œ ìŠ¤íƒ€ì¼ ê²°ì •
          const isHoliday = dayType === "ì§€ì •íœ´ì¼" || dayType === "íœ´ê°€" || dayType === "ê°œì¸ì¼ì •" || dayExclusions.length > 0;
          const isTodayDate = isToday(date);
          const isStudyDay = dayType === "í•™ìŠµì¼";
          const isReviewDay = dayType === "ë³µìŠµì¼";
          
          // ë‚ ì§œ íƒ€ì… ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
          const dayTypeColor = getDayTypeColor(
            isHoliday ? "ì§€ì •íœ´ì¼" : dayType,
            isTodayDate
          );

          const bgColorClass = `${dayTypeColor.border} ${dayTypeColor.bg}`;
          const textColorClass = dayTypeColor.text;
          const boldTextColorClass = dayTypeColor.boldText;
          const dayTypeBadgeClass = dayTypeColor.badge;

          const completedPlans = dayPlans.filter((p) => p.progress != null && p.progress >= 100).length;

          const handleDateClick = () => {
            setSelectedDate(date);
            setIsModalOpen(true);
          };

          return (
            <div
              key={dateStr}
              className={`cursor-pointer rounded-lg border-2 p-2 transition hover:shadow-lg ${bgColorClass}`}
              onClick={handleDateClick}
            >
              {/* ë‚ ì§œ í—¤ë” */}
              <div className="flex flex-col gap-1.5">
                <div className="flex items-center justify-between">
                  <div className={`text-lg font-bold ${boldTextColorClass}`}>
                    {formatDate(date)}
                  </div>
                  {/* í•™ìŠµì¼/ë³µìŠµì¼ì¼ ë•Œ ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ í‘œì‹œ */}
                  {(isStudyDay || isReviewDay) && dayTypeInfo && (
                    <div className="flex items-center gap-1">
                      <span className="text-xs">{dayTypeInfo.icon}</span>
                      <span className={`text-xs font-medium ${textColorClass}`}>
                        {dayTypeInfo.label}
                      </span>
                    </div>
                  )}
                </div>

                {/* í”Œëœ ë° í•™ì›ì¼ì • í†µê³„ */}
                {(dayPlans.length > 0 || dayAcademySchedules.length > 0) && (
                  <div className="rounded-lg bg-white/60 p-2">
                    <div className="grid grid-cols-2 gap-1 text-xs">
                      <div className="text-center">
                        <div className="font-bold text-gray-900">{dayPlans.length}</div>
                        <div className="text-gray-500">í”Œëœ</div>
                      </div>
                      <div className="text-center">
                        <div className="font-bold text-green-600">
                          {dayPlans.filter((p) => p.progress != null && p.progress >= 100).length}
                        </div>
                        <div className="text-gray-500">ì™„ë£Œ</div>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div className="flex flex-col gap-1.5">
                {/* íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ í‘œì‹œ (ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬) */}
                {(() => {
                  const dailySchedule = dailyScheduleMap.get(dateStr);
                  const timelineSlots = buildTimelineSlots(
                    dateStr,
                    dailySchedule,
                    dayPlans,
                    dayAcademySchedules,
                    dayExclusions
                  );
                  
                  // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (start ì‹œê°„ ê¸°ì¤€)
                  const sortedSlots = [...timelineSlots].sort((a, b) => {
                    const aStart = timeToMinutes(a.start);
                    const bStart = timeToMinutes(b.start);
                    return aStart - bStart;
                  });
                  
                  // showOnlyStudyTime í•„í„°ë§
                  const filteredSlots = showOnlyStudyTime
                    ? sortedSlots.filter((slot) => slot.type === "í•™ìŠµì‹œê°„")
                    : sortedSlots;
                  
                  if (filteredSlots.length === 0 && dayPlans.length === 0) {
                    return (
                      <div className="py-4 text-center text-xs text-gray-400">
                        í”Œëœ ì—†ìŒ
                      </div>
                    );
                  }
                  
                  const items: React.ReactElement[] = [];
                  const addedPlanIds = new Set<string>(); // ì´ë¯¸ ì¶”ê°€ëœ í”Œëœ ID ì¶”ì 
                  
                  filteredSlots.forEach((slot, slotIndex) => {
                    // í•™ì›ì¼ì • í‘œì‹œ
                    if (slot.type === "í•™ì›ì¼ì •" && slot.academy) {
                      items.push(
                        <div
                          key={`${dateStr}-academy-${slotIndex}-${slot.academy.id}`}
                          className="rounded border-2 border-purple-200 bg-purple-50 p-2 text-xs"
                        >
                          <div className="flex items-center gap-1">
                            <span className="text-sm">ğŸ«</span>
                            <div className="flex-1">
                              <div className="font-medium text-gray-900">
                                {slot.academy.academy_name || "í•™ì›"}
                              </div>
                              <div className="text-gray-600">
                                {slot.start} ~ {slot.end}
                              </div>
                              {slot.academy.subject && (
                                <div className="text-gray-500">{slot.academy.subject}</div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                      return;
                    }
                    
                    // í•™ìŠµì‹œê°„ì¸ ê²½ìš° í”Œëœ í‘œì‹œ
                    if (slot.type === "í•™ìŠµì‹œê°„") {
                      if (slot.plans && slot.plans.length > 0) {
                        slot.plans
                          .sort((a, b) => a.block_index - b.block_index)
                          .forEach((plan) => {
                            // ì´ë¯¸ ì¶”ê°€ëœ í”Œëœì€ ê±´ë„ˆë›°ê¸°
                            if (addedPlanIds.has(plan.id)) {
                              return;
                            }
                            addedPlanIds.add(plan.id);

                            const contentTypeIcon = CONTENT_TYPE_EMOJIS[plan.content_type] || "ğŸ“š";
                            const isCompleted = plan.progress != null && plan.progress >= 100;
                            const isActive = plan.actual_start_time && !plan.actual_end_time;
                            
                            // í”Œëœ ì¹´ë“œ ìŠ¤íƒ€ì¼
                            const cardBorderClass = isCompleted
                              ? "border-green-300 bg-green-50"
                              : isActive
                              ? "border-blue-300 bg-blue-50"
                              : "border-gray-200 bg-white";

                            // ì—°ê²°ëœ í”Œëœì¸ì§€ í™•ì¸
                            const isConnected = connectedPlanIds.has(plan.id);
                            
                            items.push(
                              <div
                                key={`${dateStr}-plan-${plan.id}`}
                                className={`rounded border p-2 text-xs relative ${cardBorderClass}`}
                              >
                                <div className="flex flex-col gap-1">
                                  {/* 1í–‰: í”Œëœ ì‹œì‘ì‹œê°„ */}
                                  {plan.start_time && (
                                    <div className="font-semibold text-gray-900">
                                      {plan.start_time}
                                    </div>
                                  )}
                                  {/* 2í–‰: ì•„ì´ì½˜ + êµê³¼ + íšŒì°¨ */}
                                  <div className="flex items-center gap-1">
                                  <span className="text-sm">{contentTypeIcon}</span>
                                  {plan.contentSubjectCategory && (
                                    <span className="font-medium text-gray-700">
                                      {plan.contentSubjectCategory}
                                    </span>
                                  )}
                                  {plan.contentEpisode && (
                                    <span className="text-gray-600">
                                      {plan.contentEpisode}
                                    </span>
                                  )}
                                  </div>
                                </div>
                                {/* 3í–‰: ê³¼ëª© */}
                                {plan.contentSubject && (
                                  <div className="text-gray-600">
                                    {plan.contentSubject}
                                  </div>
                                )}
                                {/* ì—°ê²° ì•„ì´ì½˜ (ì˜¤ë¥¸ìª½ ìƒë‹¨) */}
                                {isConnected && (
                                  <div className="absolute top-1.5 right-1.5">
                                    <Link2 
                                      size={14} 
                                      className="text-indigo-500 opacity-70" 
                                      strokeWidth={2}
                                    />
                                  </div>
                                )}
                              </div>
                            );
                          });
                      } else {
                        // í•™ìŠµì‹œê°„ì´ì§€ë§Œ í”Œëœì´ ì—†ëŠ” ê²½ìš°
                        items.push(
                          <div
                            key={`${dateStr}-study-empty-${slotIndex}`}
                            className="rounded border border-gray-200 bg-gray-50 p-2 text-xs"
                          >
                            <div className="text-center text-gray-400">
                              {slot.start} ~ {slot.end} í•™ìŠµì‹œê°„
                            </div>
                          </div>
                        );
                      }
                      return;
                    }
                    
                    // ì ì‹¬ì‹œê°„, ì´ë™ì‹œê°„, ììœ¨í•™ìŠµ ë“± íŠ¹ìˆ˜ íƒ€ì„ìŠ¬ë¡¯ í‘œì‹œ
                    // (í•™ìŠµì‹œê°„ê³¼ í•™ì›ì¼ì •ì€ ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
                    {
                      const colorClass = getTimeSlotColorClass(slot.type);
                      const icon = getTimeSlotIcon(slot.type);
                      
                      items.push(
                        <div
                          key={`${dateStr}-slot-${slotIndex}`}
                          className={`rounded border p-2 text-xs ${colorClass}`}
                        >
                          <div className="flex items-center gap-1">
                            <span className="text-sm">{icon}</span>
                            <div className="flex-1">
                              <div className="font-medium">
                                {slot.label || slot.type}
                              </div>
                              <div className="text-xs opacity-75">
                                {slot.start} ~ {slot.end}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    }
                  });
                  
                  return items;
                })()}
              </div>
            </div>
          );
        })}
      </div>
    </div>

      {/* íƒ€ì„ë¼ì¸ ëª¨ë‹¬ */}
      {selectedDate && (() => {
        const selectedDateStr = formatDateString(selectedDate);
        const selectedDatePlans = plans.filter((plan) => plan.plan_date === selectedDateStr);
        
        return (
          <DayTimelineModal
            open={isModalOpen}
            onOpenChange={setIsModalOpen}
            date={selectedDate}
            plans={selectedDatePlans}
            exclusions={exclusions.filter((ex) => ex.exclusion_date === selectedDateStr)}
            academySchedules={academySchedules}
            dayTypeInfo={dayTypes.get(selectedDateStr)}
            dailySchedule={dailyScheduleMap.get(selectedDateStr)}
          />
        );
      })()}
    </>
  );
}

export const WeekView = memo(WeekViewComponent, (prevProps, nextProps) => {
  // currentDate ë¹„êµ (ë‚ ì§œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ)
  const prevDateStr = prevProps.currentDate.toISOString().slice(0, 10);
  const nextDateStr = nextProps.currentDate.toISOString().slice(0, 10);
  
  // plans ë°°ì—´ì˜ ê¸¸ì´ ë¹„êµ
  if (prevProps.plans.length !== nextProps.plans.length) {
    return false;
  }
  
  return (
    prevDateStr === nextDateStr &&
    prevProps.showOnlyStudyTime === nextProps.showOnlyStudyTime &&
    prevProps.exclusions.length === nextProps.exclusions.length &&
    prevProps.academySchedules.length === nextProps.academySchedules.length &&
    prevProps.dayTypes.size === nextProps.dayTypes.size &&
    prevProps.dailyScheduleMap.size === nextProps.dailyScheduleMap.size
  );
});
</file>

<file path="calendar/_constants/contentIcons.ts">
/**
 * ì½˜í…ì¸  íƒ€ì…ë³„ ì•„ì´ì½˜/ì´ëª¨ì§€ ìƒìˆ˜
 */

export const CONTENT_TYPE_EMOJIS = {
  book: "ğŸ“š",
  lecture: "ğŸ§",
  custom: "ğŸ“",
} as const;

export type ContentType = keyof typeof CONTENT_TYPE_EMOJIS;
</file>

<file path="calendar/_constants/timeBlocks.ts">
/**
 * ì‹œê°„ëŒ€ ë¸”ë¡ ìƒìˆ˜
 */

export const TIME_BLOCKS = [
  { index: 0, label: "ì˜¤ì „ 1êµì‹œ", time: "09:00" },
  { index: 1, label: "ì˜¤ì „ 2êµì‹œ", time: "10:00" },
  { index: 2, label: "ì˜¤ì „ 3êµì‹œ", time: "11:00" },
  { index: 3, label: "ì˜¤í›„ 1êµì‹œ", time: "13:00" },
  { index: 4, label: "ì˜¤í›„ 2êµì‹œ", time: "14:00" },
  { index: 5, label: "ì˜¤í›„ 3êµì‹œ", time: "15:00" },
  { index: 6, label: "ì˜¤í›„ 4êµì‹œ", time: "16:00" },
  { index: 7, label: "ì €ë… 1êµì‹œ", time: "18:00" },
  { index: 8, label: "ì €ë… 2êµì‹œ", time: "19:00" },
  { index: 9, label: "ì €ë… 3êµì‹œ", time: "20:00" },
] as const;
</file>

<file path="calendar/_types/plan.ts">
import type { Plan } from "@/lib/data/studentPlans";

export type PlanWithContent = Plan & {
  contentTitle: string;
  contentSubject: string | null;
  contentSubjectCategory: string | null; // êµê³¼ (êµ­ì–´, ìˆ˜í•™ ë“±)
  contentCategory: string | null; // ìœ í˜• (ê°œë…ì„œ, ë¬¸ì œì§‘ ë“±)
  contentEpisode?: string | null; // ì½˜í…ì¸  íšŒì°¨ (ì˜ˆ: "1ê°•", "2íšŒì°¨" ë“±)
};
</file>

<file path="calendar/_utils/timelineUtils.ts">
/**
 * íƒ€ì„ë¼ì¸ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 */

import type { DailyScheduleInfo } from "@/lib/types/plan";
import type { PlanWithContent } from "../_types/plan";
import type { PlanExclusion, AcademySchedule } from "@/lib/types/plan";

/**
 * íƒ€ì„ìŠ¬ë¡¯ íƒ€ì…
 */
export type TimeSlotType = "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";

export type TimelineSlot = {
  type: TimeSlotType;
  start: string; // HH:mm
  end: string; // HH:mm
  label?: string;
  plans?: PlanWithContent[]; // í•™ìŠµì‹œê°„ì¸ ê²½ìš° í”Œëœ ëª©ë¡
  academy?: AcademySchedule; // í•™ì›ì¼ì •ì¸ ê²½ìš°
};

/**
 * ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
 */
export function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

/**
 * ë¶„ì„ ì‹œê°„ ë¬¸ìì—´ë¡œ ë³€í™˜
 */
export function minutesToTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}

/**
 * ë‚ ì§œë³„ íƒ€ì„ë¼ì¸ ìŠ¬ë¡¯ ìƒì„±
 * daily_scheduleì˜ time_slotsì™€ í”Œëœ, í•™ì›ì¼ì •ì„ ê²°í•©
 * í”Œëœì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ íƒ€ì„ë¼ì¸ëŒ€ë¡œ ë°°ì¹˜
 */
export function buildTimelineSlots(
  dateStr: string,
  dailySchedule: DailyScheduleInfo | null | undefined,
  plans: PlanWithContent[],
  academySchedules: AcademySchedule[],
  exclusions: PlanExclusion[]
): TimelineSlot[] {
  const slots: TimelineSlot[] = [];
  
  // í•´ë‹¹ ë‚ ì§œì˜ í”Œëœë§Œ í•„í„°ë§
  const dayPlans = plans.filter((plan) => plan.plan_date === dateStr);
  
  // í”Œëœì— ì‹œê°„ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
  const plansWithTime = dayPlans
    .filter((plan) => plan.start_time && plan.end_time)
    .sort((a, b) => {
      if (a.start_time && b.start_time) {
        return timeToMinutes(a.start_time) - timeToMinutes(b.start_time);
      }
      return a.block_index - b.block_index;
    });
  
  // í”Œëœì— ì‹œê°„ ì •ë³´ê°€ ì—†ìœ¼ë©´ block_index ìˆœìœ¼ë¡œ ì •ë ¬
  const plansWithoutTime = dayPlans
    .filter((plan) => !plan.start_time || !plan.end_time)
    .sort((a, b) => a.block_index - b.block_index);

  // time_slotsê°€ ìˆìœ¼ë©´ ì‚¬ìš©
  if (dailySchedule?.time_slots && dailySchedule.time_slots.length > 0) {
    // time_slotsë¥¼ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedTimeSlots = [...dailySchedule.time_slots].sort((a, b) => {
      return timeToMinutes(a.start) - timeToMinutes(b.start);
    });

    // ê° íƒ€ì„ìŠ¬ë¡¯ì— í”Œëœ ë§¤ì¹­
    sortedTimeSlots.forEach((slot) => {
      const timelineSlot: TimelineSlot = {
        type: slot.type as TimeSlotType,
        start: slot.start,
        end: slot.end,
        label: slot.label,
      };

      // í•™ìŠµì‹œê°„ì¸ ê²½ìš° í”Œëœ ë§¤ì¹­
      if (slot.type === "í•™ìŠµì‹œê°„") {
        const slotStart = timeToMinutes(slot.start);
        const slotEnd = timeToMinutes(slot.end);

        const matchingPlans: PlanWithContent[] = [];
        
        // 1. ì‹œê°„ ì •ë³´ê°€ ìˆëŠ” í”Œëœ: ì‹œê°„ ë²”ìœ„ê°€ ê²¹ì¹˜ê±°ë‚˜ ì¼ì¹˜í•˜ëŠ” í”Œëœ ì°¾ê¸°
        plansWithTime.forEach((plan) => {
          if (plan.start_time && plan.end_time) {
            const planStart = timeToMinutes(plan.start_time);
            const planEnd = timeToMinutes(plan.end_time);
            // ì‹œê°„ ë²”ìœ„ê°€ ê²¹ì¹˜ê±°ë‚˜ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
            if (
              (planStart >= slotStart && planStart < slotEnd) ||
              (planEnd > slotStart && planEnd <= slotEnd) ||
              (planStart <= slotStart && planEnd >= slotEnd)
            ) {
              matchingPlans.push(plan);
            }
          }
        });
        
        // 2. ì‹œê°„ ì •ë³´ê°€ ì—†ëŠ” í”Œëœ: block_index ê¸°ë°˜ìœ¼ë¡œ ë§¤ì¹­ (fallback)
        // í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì˜ ìˆœì„œë¥¼ ê³„ì‚° (block_indexì™€ ë§¤ì¹­)
        const studyTimeSlotIndex = sortedTimeSlots
          .slice(0, sortedTimeSlots.indexOf(slot) + 1)
          .filter((s) => s.type === "í•™ìŠµì‹œê°„").length;
        
        plansWithoutTime.forEach((plan) => {
          if (plan.block_index === studyTimeSlotIndex) {
            matchingPlans.push(plan);
          }
        });
        
        // ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬ (ì‹œê°„ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‹œê°„ ìˆœ, ì—†ìœ¼ë©´ block_index ìˆœ)
        matchingPlans.sort((a, b) => {
          if (a.start_time && b.start_time) {
            return timeToMinutes(a.start_time) - timeToMinutes(b.start_time);
          }
          return a.block_index - b.block_index;
        });

        timelineSlot.plans = matchingPlans;
      }

      // í•™ì›ì¼ì •ì¸ ê²½ìš° í•™ì›ì¼ì • ë§¤ì¹­
      if (slot.type === "í•™ì›ì¼ì •") {
        const slotStart = timeToMinutes(slot.start);
        const slotEnd = timeToMinutes(slot.end);

        const matchingAcademy = academySchedules.find((academy) => {
          const academyStart = timeToMinutes(academy.start_time);
          const academyEnd = timeToMinutes(academy.end_time);
          return (
            academyStart >= slotStart &&
            academyEnd <= slotEnd &&
            Math.abs(academyStart - slotStart) < 30 // 30ë¶„ ì´ë‚´ ì°¨ì´
          );
        });

        if (matchingAcademy) {
          timelineSlot.academy = matchingAcademy;
        }
      }

      slots.push(timelineSlot);
    });
    
    // ì‹œê°„ ì •ë³´ê°€ ìˆëŠ” í”Œëœ ì¤‘ íƒ€ì„ìŠ¬ë¡¯ì— ë§¤ì¹­ë˜ì§€ ì•Šì€ í”Œëœì„ ë³„ë„ ìŠ¬ë¡¯ìœ¼ë¡œ ì¶”ê°€
    const matchedPlanIds = new Set<string>();
    slots.forEach((slot) => {
      if (slot.plans) {
        slot.plans.forEach((plan) => matchedPlanIds.add(plan.id));
      }
    });
    
    plansWithTime.forEach((plan) => {
      if (!matchedPlanIds.has(plan.id) && plan.start_time && plan.end_time) {
        // í”Œëœì˜ ì‹œê°„ ì •ë³´ë¡œ ì§ì ‘ íƒ€ì„ìŠ¬ë¡¯ ìƒì„±
        slots.push({
          type: "í•™ìŠµì‹œê°„",
          start: plan.start_time,
          end: plan.end_time,
          label: `${plan.start_time} ~ ${plan.end_time}`,
          plans: [plan],
        });
      }
    });
    
    // ì‹œê°„ ìˆœìœ¼ë¡œ ë‹¤ì‹œ ì •ë ¬
    slots.sort((a, b) => {
      return timeToMinutes(a.start) - timeToMinutes(b.start);
    });
  } else {
    // time_slotsê°€ ì—†ìœ¼ë©´ í”Œëœì˜ ì‹œê°„ ì •ë³´ë¡œ íƒ€ì„ë¼ì¸ ìƒì„±
    if (plansWithTime.length > 0) {
      plansWithTime.forEach((plan) => {
        if (plan.start_time && plan.end_time) {
          slots.push({
            type: "í•™ìŠµì‹œê°„",
            start: plan.start_time,
            end: plan.end_time,
            label: `${plan.start_time} ~ ${plan.end_time}`,
            plans: [plan],
          });
        }
      });
    }
    
    // ì‹œê°„ ì •ë³´ê°€ ì—†ëŠ” í”Œëœì€ block_index ìˆœìœ¼ë¡œ í‘œì‹œ
    if (plansWithoutTime.length > 0) {
      plansWithoutTime.forEach((plan) => {
        slots.push({
          type: "í•™ìŠµì‹œê°„",
          start: "00:00",
          end: "23:59",
          label: `ë¸”ë¡ ${plan.block_index}`,
          plans: [plan],
        });
      });
    }
  }

  return slots;
}

/**
 * íƒ€ì„ìŠ¬ë¡¯ ìƒ‰ìƒ í´ë˜ìŠ¤ ë°˜í™˜
 */
export function getTimeSlotColorClass(type: TimeSlotType): string {
  switch (type) {
    case "í•™ìŠµì‹œê°„":
      return "bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200";
    case "ì ì‹¬ì‹œê°„":
      return "bg-orange-50 dark:bg-orange-900/30 border-orange-200 dark:border-orange-800 text-orange-800 dark:text-orange-200";
    case "í•™ì›ì¼ì •":
      return "bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800 text-purple-800 dark:text-purple-200";
    case "ì´ë™ì‹œê°„":
      return "bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200";
    case "ììœ¨í•™ìŠµ":
      return "bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200";
    default:
      return "bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200";
  }
}

/**
 * íƒ€ì„ìŠ¬ë¡¯ ì•„ì´ì½˜ ë°˜í™˜
 */
export function getTimeSlotIcon(type: TimeSlotType): string {
  switch (type) {
    case "í•™ìŠµì‹œê°„":
      return "â°"; // ì½˜í…ì¸  ì•„ì´ì½˜(ğŸ“š, ğŸ§, ğŸ“)ê³¼ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì‹œê³„ ì•„ì´ì½˜ ì‚¬ìš©
    case "ì ì‹¬ì‹œê°„":
      return "ğŸ½ï¸";
    case "í•™ì›ì¼ì •":
      return "ğŸ«";
    case "ì´ë™ì‹œê°„":
      return "ğŸš¶";
    case "ììœ¨í•™ìŠµ":
      return "ğŸ“–";
    default:
      return "â°";
  }
}
</file>

<file path="calendar/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import {
  getPlanGroupsForStudent,
  getPlanExclusions,
  getAcademySchedules,
} from "@/lib/data/planGroups";
import { getPlansForStudent } from "@/lib/data/studentPlans";
import { PlanCalendarView } from "./_components/PlanCalendarView";
import type { PlanExclusion, AcademySchedule } from "@/lib/types/plan";
import { requireTenantContext } from "@/lib/tenant/requireTenantContext";
import { formatDateString } from "@/lib/date/calendarUtils";
import { getContainerClass } from "@/lib/constants/layout";

type PlanCalendarPageProps = {
  searchParams: Promise<{ view?: string }>;
};

export default async function PlanCalendarPage({
  searchParams,
}: PlanCalendarPageProps) {
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  const params = await searchParams;
  const view =
    params.view === "week" ? "week" : params.view === "day" ? "day" : "month";

  // í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ
  const tenantContext = await requireTenantContext();

  try {
    // í™œì„±í™”ëœ í”Œëœ ê·¸ë£¹ ì¡°íšŒ
    const allActivePlanGroups = await getPlanGroupsForStudent({
      studentId: user.id,
      status: "active",
    });

    // ìº í”„ í…œí”Œë¦¿ í”Œëœ ì œì™¸ (ìº í”„ ê´€ë ¨ í”Œëœì€ /camp ê²½ë¡œì—ì„œë§Œ í™•ì¸)
    const activePlanGroups = allActivePlanGroups.filter(
      (group) => !group.camp_template_id && !group.camp_invitation_id
    );

    if (activePlanGroups.length === 0) {
      return (
        <section className={getContainerClass("LIST", "md")}>
          <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-10 text-center">
            <div className="mx-auto flex max-w-md flex-col gap-4">
              <div className="text-6xl">ğŸ“…</div>
              <h3 className="text-lg font-semibold text-gray-900">
                í™œì„±í™”ëœ í”Œëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤
              </h3>
              <p className="text-sm text-gray-500">
                í”Œëœ ê·¸ë£¹ì„ ìƒì„±í•˜ê³  í™œì„±í™”í•´ì£¼ì„¸ìš”.
              </p>
            </div>
          </div>
        </section>
      );
    }

    // í™œì„± í”Œëœ ê·¸ë£¹ì˜ ê¸°ê°„ ë²”ìœ„ ê³„ì‚°
    // period_startì™€ period_endë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (YYYY-MM-DD í˜•ì‹)
    const dateRanges = activePlanGroups.map((group) => {
      // Date ê°ì²´ì´ë©´ ë¬¸ìì—´ë¡œ ë³€í™˜, ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      const startStr =
        typeof group.period_start === "string"
          ? group.period_start.slice(0, 10)
          : group.period_start
          ? String(group.period_start).slice(0, 10)
          : "";

      const endStr =
        typeof group.period_end === "string"
          ? group.period_end.slice(0, 10)
          : group.period_end
          ? String(group.period_end).slice(0, 10)
          : "";

      return {
        start: startStr,
        end: endStr,
      };
    });

    // ë‚ ì§œ ë²”ìœ„ê°€ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³  ìµœì†Œ/ìµœëŒ€ ë‚ ì§œ ê³„ì‚°
    const validRanges = dateRanges.filter(
      (range) => range.start && range.end && range.start <= range.end
    );

    if (validRanges.length === 0) {
      // ì˜ëª»ëœ ë‚ ì§œ ë²”ìœ„ê°€ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
      console.error("[calendar] ì˜ëª»ëœ ë‚ ì§œ ë²”ìœ„ë¥¼ ê°€ì§„ í”Œëœ ê·¸ë£¹ì´ ìˆìŠµë‹ˆë‹¤.");
      // ìœ íš¨í•˜ì§€ ì•Šì€ ë²”ìœ„ê°€ ìˆì–´ë„ ë¹ˆ ë²”ìœ„ë¡œ ì§„í–‰ (ì—ëŸ¬ UIëŠ” catchì—ì„œ ì²˜ë¦¬)
    }

    const today = formatDateString(new Date());
    
    // ë‚ ì§œ ë¹„êµë¥¼ ìœ„í•´ ë¬¸ìì—´ë¡œ ë³€í™˜ëœ ë‚ ì§œë“¤ë§Œ ì‚¬ìš©
    const minDate =
      validRanges.length > 0
        ? validRanges
            .map((range) => range.start)
            .filter((date): date is string => typeof date === "string" && date.length === 10)
            .sort()[0] || today
        : today;
    
    const maxDate =
      validRanges.length > 0
        ? validRanges
            .map((range) => range.end)
            .filter((date): date is string => typeof date === "string" && date.length === 10)
            .sort((a, b) => b.localeCompare(a))[0] || today
        : today;
    
    // ìµœì¢…ì ìœ¼ë¡œ ë¬¸ìì—´ë¡œ ë³€í™˜ ë³´ì¥
    const minDateStr = typeof minDate === "string" ? minDate : formatDateString(new Date(minDate));
    const maxDateStr = typeof maxDate === "string" ? maxDate : formatDateString(new Date(maxDate));

    // í™œì„± í”Œëœ ê·¸ë£¹ ID ëª©ë¡
    const activeGroupIds = activePlanGroups.map((g) => g.id);

    // í™œì„± í”Œëœ ê·¸ë£¹ì— ì†í•œ í”Œëœë§Œ ì¡°íšŒ (ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ í•„í„°ë§)
    // ë‚ ì§œ í˜•ì‹ì´ ë¬¸ìì—´(YYYY-MM-DD)ì„ì„ ë³´ì¥
    const filteredPlans = await getPlansForStudent({
      studentId: user.id,
      dateRange: {
        start: minDateStr,
        end: maxDateStr,
      },
      planGroupIds: activeGroupIds, // ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ í•„í„°ë§
    });

    // í”Œëœ ê·¸ë£¹ ë¶ˆì¼ì¹˜ í™•ì¸
    const planGroupIdsInPlans = [...new Set(filteredPlans.map((p) => p.plan_group_id).filter(Boolean))];
    const unmatchedGroupIds = planGroupIdsInPlans.filter((id): id is string => id != null && !activeGroupIds.includes(id));
    const hasUnmatchedPlans = unmatchedGroupIds.length > 0 || filteredPlans.some((p) => !p.plan_group_id);

    // êµê³¼ ì •ë³´ ë˜ëŠ” ì œëª©ì´ ì—†ëŠ” í”Œëœì˜ ì½˜í…ì¸  ID ìˆ˜ì§‘
    const missingContentIds = new Map<"book" | "lecture" | "custom", Set<string>>();
    missingContentIds.set("book", new Set());
    missingContentIds.set("lecture", new Set());
    missingContentIds.set("custom", new Set());
    
    filteredPlans.forEach((plan) => {
      const needsFetch = 
        (!plan.content_subject_category && !plan.content_subject) || 
        !plan.content_title;
      if (needsFetch && plan.content_id) {
        const contentType = plan.content_type;
        if (contentType && missingContentIds.has(contentType)) {
          missingContentIds.get(contentType)!.add(plan.content_id);
        }
      }
    });
    
    // ì½˜í…ì¸  í…Œì´ë¸”ì—ì„œ êµê³¼ ì •ë³´ ë° ì œëª© ì¡°íšŒ
    const contentSubjectMap = new Map<string, { subjectCategory: string | null; subject: string | null; title: string | null }>();
    
    for (const [contentType, contentIds] of missingContentIds.entries()) {
      if (contentIds.size === 0) continue;
      
      try {
        const tableName = contentType === "book" ? "books" : contentType === "lecture" ? "lectures" : "student_custom_contents";
        const selectField = contentType === "book" ? "id,subject_category,subject,title" : contentType === "lecture" ? "id,subject_category,subject,title" : "id,subject_category,subject,title";
        
        const { data, error } = await supabase
          .from(tableName)
          .select(selectField)
          .in("id", Array.from(contentIds));
        
        if (!error && data) {
          data.forEach((content: any) => {
            contentSubjectMap.set(content.id, {
              subjectCategory: content.subject_category || null,
              subject: content.subject || null,
              title: content.title || null,
            });
          });
        }
      } catch (error) {
        console.error(`[calendar] ${contentType} êµê³¼ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨`, error);
      }
    }
    
    // í”Œëœì— ì½˜í…ì¸  ì •ë³´ ì¶”ê°€ (denormalized í•„ë“œ ì‚¬ìš© + ì¡°íšŒí•œ ì •ë³´ ë³´ì™„)
    const plansWithContent = filteredPlans.map((plan) => {
      // êµê³¼ ì •ë³´ (denormalized í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ ì¡°íšŒí•œ ì •ë³´ ì‚¬ìš©, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ null)
      const contentSubjectInfo = plan.content_id ? contentSubjectMap.get(plan.content_id) : null;
      const contentSubjectCategory = plan.content_subject_category || contentSubjectInfo?.subjectCategory || null;
      const contentSubject = plan.content_subject || contentSubjectInfo?.subject || null;
      
      // í”Œëœ íšŒì°¨ ì •ë³´ (sequence ì‚¬ìš©)
      let contentEpisode: string | null = null;
      if (plan.sequence !== null && plan.sequence !== undefined) {
        contentEpisode = `${plan.sequence}íšŒì°¨`;
      }
      
      return {
        ...plan,
        contentTitle: plan.content_title || contentSubjectInfo?.title || "ì œëª© ì—†ìŒ",
        contentSubject,
        contentSubjectCategory, // êµê³¼ (í•­ìƒ ì¼ê´€ë˜ê²Œ í‘œì‹œ)
        contentCategory: plan.content_category || null, // ìœ í˜•
        contentEpisode, // í”Œëœ íšŒì°¨
      };
    });

    // ì²« í”Œëœ ë‚ ì§œ ê³„ì‚° (í”Œëœì´ ìˆìœ¼ë©´ ì²« í”Œëœ ë‚ ì§œ, ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ)
    const firstPlanDate =
      plansWithContent.length > 0
        ? plansWithContent
            .map((plan) => plan.plan_date)
            .filter((date): date is string => date !== null)
            .sort()[0] || formatDateString(new Date())
        : new Date().toISOString().slice(0, 10);

    // ì œì™¸ì¼ ì¡°íšŒ (í”Œëœ ê·¸ë£¹ë³„ ê´€ë¦¬)
    // í™œì„± í”Œëœ ê·¸ë£¹ë“¤ì˜ ì œì™¸ì¼ ì¡°íšŒ í›„ ë³‘í•©
    const exclusionsPromises = activePlanGroups.map((group) =>
      getPlanExclusions(group.id, tenantContext.tenantId)
    );
    const exclusionsArrays = await Promise.all(exclusionsPromises);
    
    // ì¤‘ë³µ ì œê±°: exclusion_date:exclusion_type ì¡°í•©ì´ ê°™ì€ ê²ƒì€ í•˜ë‚˜ë§Œ í‘œì‹œ
    const exclusionsMap = new Map();
    for (const exclusions of exclusionsArrays) {
      for (const exclusion of exclusions) {
        const key = `${exclusion.exclusion_date}:${exclusion.exclusion_type}`;
        if (!exclusionsMap.has(key)) {
          exclusionsMap.set(key, exclusion);
        }
      }
    }
    const exclusions = Array.from(exclusionsMap.values());

    // í•™ì›ì¼ì • ì¡°íšŒ (í”Œëœ ê·¸ë£¹ë³„ ê´€ë¦¬)
    // Phase 2: í™œì„± í”Œëœ ê·¸ë£¹ë“¤ì˜ í•™ì› ì¼ì • ì¡°íšŒ í›„ ë³‘í•©
    const academySchedulesPromises = activePlanGroups.map((group) =>
      getAcademySchedules(group.id, tenantContext.tenantId)
    );
    const academySchedulesArrays = await Promise.all(academySchedulesPromises);
    
    // ì¤‘ë³µ ì œê±°: day_of_week:start_time:end_time ì¡°í•©ì´ ê°™ì€ ê²ƒì€ í•˜ë‚˜ë§Œ í‘œì‹œ
    const academySchedulesMap = new Map();
    for (const schedules of academySchedulesArrays) {
      for (const schedule of schedules) {
        const key = `${schedule.day_of_week}:${schedule.start_time}:${schedule.end_time}`;
        if (!academySchedulesMap.has(key)) {
          academySchedulesMap.set(key, schedule);
        }
      }
    }
    const academySchedules = Array.from(academySchedulesMap.values());

    // í”Œëœ ê·¸ë£¹ì˜ daily_scheduleì—ì„œ ë‚ ì§œë³„ ì¼ì • íƒ€ì… ì •ë³´ ì¶”ì¶œ
    // Step7ì—ì„œ ìƒì„±ëœ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¬ê³„ì‚° ë¶ˆí•„ìš”)
    const dailySchedules = activePlanGroups
      .map((group) => group.daily_schedule)
      .filter((schedule): schedule is NonNullable<typeof schedule> => 
        schedule !== null && schedule !== undefined && Array.isArray(schedule)
      );

    // í†µê³„ ê³„ì‚°
    const totalPlans = plansWithContent.length;
    const completedPlans = plansWithContent.filter((p) => p.progress != null && p.progress >= 100).length;
    const activePlans = plansWithContent.filter((p) => p.actual_start_time && !p.actual_end_time).length;
    const averageProgress = totalPlans > 0
      ? Math.round(
          plansWithContent.reduce((sum, p) => sum + (p.progress || 0), 0) / totalPlans
        )
      : 0;

    return (
      <section className={getContainerClass("LIST", "md")}>
        <div className="flex flex-col gap-6">
          {/* í˜ì´ì§€ í—¤ë” - ì¹´ë“œ ìŠ¤íƒ€ì¼ */}
          <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
            <div className="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
              <div className="flex flex-col gap-3 flex-1">
                <h1 className="text-3xl font-bold text-gray-900">í”Œëœ ìº˜ë¦°ë”</h1>
                <p className="text-sm text-gray-600">
                  í™œì„±í™”ëœ í”Œëœ ê·¸ë£¹ì˜ í”Œëœì„ ìº˜ë¦°ë” í˜•ì‹ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”
                </p>
                {/* í™œì„± í”Œëœ ê·¸ë£¹ ì •ë³´ í‘œì‹œ */}
                {activePlanGroups.length > 0 && (
                  <div className="flex flex-wrap items-center gap-2">
                    <span className="text-xs font-semibold text-gray-500">í™œì„± í”Œëœ:</span>
                    {activePlanGroups.map((group) => (
                      <span
                        key={group.id}
                        className="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1.5 text-xs font-semibold text-indigo-800 border border-indigo-200"
                      >
                        <span className="h-2 w-2 rounded-full bg-indigo-600"></span>
                        {group.name || group.id.slice(0, 8)}
                      </span>
                    ))}
                  </div>
                )}
              </div>
              
              {/* í†µê³„ ìš”ì•½ */}
              <div className="flex flex-wrap gap-3 md:flex-nowrap">
                <div className="flex flex-col items-center gap-1 rounded-lg bg-gray-50 px-4 py-3 border border-gray-200 min-w-[80px]">
                  <span className="text-xs font-medium text-gray-500">ì´ í”Œëœ</span>
                  <span className="text-2xl font-bold text-gray-900">{totalPlans}</span>
                </div>
                <div className="flex flex-col items-center gap-1 rounded-lg bg-green-50 px-4 py-3 border border-green-200 min-w-[80px]">
                  <span className="text-xs font-medium text-green-700">ì™„ë£Œ</span>
                  <span className="text-2xl font-bold text-green-600">{completedPlans}</span>
                </div>
                {activePlans > 0 && (
                  <div className="flex flex-col items-center gap-1 rounded-lg bg-blue-50 px-4 py-3 border border-blue-200 min-w-[80px]">
                    <span className="text-xs font-medium text-blue-700">ì§„í–‰ì¤‘</span>
                    <span className="text-2xl font-bold text-blue-600">{activePlans}</span>
                  </div>
                )}
                {averageProgress > 0 && (
                  <div className="flex flex-col items-center gap-1 rounded-lg bg-indigo-50 px-4 py-3 border border-indigo-200 min-w-[80px]">
                    <span className="text-xs font-medium text-indigo-700">í‰ê·  ì§„í–‰ë¥ </span>
                    <span className="text-2xl font-bold text-indigo-600">{averageProgress}%</span>
                  </div>
                )}
              </div>
            </div>
            {/* ë¶ˆì¼ì¹˜ ê²½ê³  */}
            {hasUnmatchedPlans && (
              <div className="flex flex-col gap-4 rounded-lg border-2 border-yellow-300 bg-yellow-50 p-4 text-sm text-yellow-800 shadow-sm">
                <div className="font-bold">âš ï¸ í”Œëœ ê·¸ë£¹ ë¶ˆì¼ì¹˜ ê°ì§€</div>
                <div className="flex flex-col gap-1 text-xs">
                  {unmatchedGroupIds.length > 0 && (
                    <div>
                      í™œì„±í™”ë˜ì§€ ì•Šì€ í”Œëœ ê·¸ë£¹ì˜ í”Œëœì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: {unmatchedGroupIds.length}ê°œ
                    </div>
                  )}
                  {filteredPlans.some((p) => !p.plan_group_id) && (
                    <div>
                      í”Œëœ ê·¸ë£¹ì´ ì—†ëŠ” í”Œëœì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: {filteredPlans.filter((p) => !p.plan_group_id).length}ê°œ
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          <PlanCalendarView
            plans={plansWithContent}
            view={view}
            minDate={minDateStr}
            maxDate={maxDateStr}
            initialDate={firstPlanDate}
            exclusions={exclusions}
            academySchedules={academySchedules}
            dailySchedules={dailySchedules}
          />
        </div>
      </section>
    );
  } catch (error) {
    console.error("[calendar] í”Œëœ ìº˜ë¦°ë” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", error);
    
    // ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    return (
      <section className={getContainerClass("LIST", "md")}>
        <div className="rounded-xl border border-red-200 bg-red-50 p-10 text-center">
          <div className="mx-auto flex max-w-md flex-col gap-4">
            <div className="text-6xl">âš ï¸</div>
            <h3 className="text-lg font-semibold text-red-900">
              ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤
            </h3>
            <p className="text-sm text-red-700">
              ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
            </p>
          </div>
        </div>
      </section>
    );
  }
}
</file>

<file path="group/[id]/_components/AutoRescheduleBanner.tsx">
/**
 * ìë™ ì¬ì¡°ì • ì œì•ˆ ë°°ë„ˆ ì»´í¬ë„ŒíŠ¸
 * 
 * í•™ìŠµ ì§€ì—°ì´ ê°ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ì¬ì¡°ì •ì„ ì œì•ˆí•˜ëŠ” ë°°ë„ˆë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { AlertCircle, X, ChevronRight } from "lucide-react";
import { analyzeDelay } from "@/lib/reschedule/delayDetector";
import { generateRescheduleSuggestions } from "@/lib/reschedule/autoSuggester";
import type { Plan } from "@/lib/data/studentPlans";
import type { PlanContent } from "@/lib/types/plan";
import type { RescheduleSuggestion } from "@/lib/reschedule/autoSuggester";

type AutoRescheduleBannerProps = {
  groupId: string;
  plans: Plan[];
  contents: PlanContent[];
  startDate: string; // YYYY-MM-DD
  endDate: string; // YYYY-MM-DD
};

export function AutoRescheduleBanner({
  groupId,
  plans,
  contents,
  startDate,
  endDate,
}: AutoRescheduleBannerProps) {
  const router = useRouter();
  const [dismissed, setDismissed] = useState(false);
  const [suggestions, setSuggestions] = useState<RescheduleSuggestion[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // ì§€ì—° ë¶„ì„ ë° ì œì•ˆ ìƒì„±
    const delayAnalysis = analyzeDelay({
      plans,
      startDate,
      endDate,
    });

    // ì§€ì—°ì´ ì—†ê±°ë‚˜ ë‚®ìœ¼ë©´ ë°°ë„ˆë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
    if (
      delayAnalysis.severity === "none" ||
      delayAnalysis.severity === "low"
    ) {
      setLoading(false);
      return;
    }

    const generatedSuggestions = generateRescheduleSuggestions({
      delayAnalysis,
      contents,
      startDate,
      endDate,
    });

    setSuggestions(generatedSuggestions);
    setLoading(false);
  }, [plans, contents, startDate, endDate]);

  const handleDismiss = () => {
    setDismissed(true);
  };

  const handleApplySuggestion = (suggestion: RescheduleSuggestion) => {
    // ì¬ì¡°ì • í˜ì´ì§€ë¡œ ì´ë™ (ì œì•ˆ ì •ë³´ë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬)
    const params = new URLSearchParams({
      suggestion: suggestion.type,
      priority: suggestion.priority.toString(),
    });

    if (suggestion.affectedDateRange) {
      params.set("from", suggestion.affectedDateRange.from);
      params.set("to", suggestion.affectedDateRange.to);
    }

    router.push(`/plan/group/${groupId}/reschedule?${params.toString()}`);
  };

  if (loading || dismissed || suggestions.length === 0) {
    return null;
  }

  const topSuggestion = suggestions[0];

  return (
    <div className="rounded-lg border border-orange-200 bg-orange-50 p-4">
      <div className="flex items-start justify-between">
        <div className="flex items-start gap-3 flex-1">
          <AlertCircle className="h-5 w-5 text-orange-600 flex-shrink-0" />
          <div className="flex flex-1 flex-col gap-1">
            <h3 className="font-semibold text-orange-900">
              í•™ìŠµ ì§€ì—° ê°ì§€ - ì¬ì¡°ì • ì œì•ˆ
            </h3>
            <p className="text-sm text-orange-800">
              {topSuggestion.description}
            </p>
            <p className="text-xs text-orange-700">
              {topSuggestion.reason}
            </p>

            {/* ì¶”ê°€ ì œì•ˆì´ ìˆìœ¼ë©´ í‘œì‹œ */}
            {suggestions.length > 1 && (
              <div className="flex flex-col gap-2">
                <p className="text-xs font-medium text-orange-900">
                  ë‹¤ë¥¸ ì œì•ˆ ({suggestions.length - 1}ê°œ):
                </p>
                {suggestions.slice(1, 3).map((suggestion, index) => (
                  <button
                    key={index}
                    type="button"
                    onClick={() => handleApplySuggestion(suggestion)}
                    className="text-left rounded-lg border border-orange-200 bg-white p-2 text-xs text-orange-800 transition hover:bg-orange-100"
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium">{suggestion.title}</span>
                      <ChevronRight className="h-3 w-3" />
                    </div>
                    <p className="text-orange-600">{suggestion.description}</p>
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>

        <div className="flex items-start gap-2">
          <button
            type="button"
            onClick={() => handleApplySuggestion(topSuggestion)}
            className="rounded-lg bg-orange-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-orange-700"
          >
            ì œì•ˆ ì ìš©
          </button>
          <button
            type="button"
            onClick={handleDismiss}
            className="rounded p-1 text-orange-600 transition hover:bg-orange-100"
            aria-label="ë‹«ê¸°"
          >
            <X className="h-4 w-4" />
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/_components/ErrorBoundary.tsx">
"use client";

import { Component, ReactNode } from "react";
import { AlertCircle } from "lucide-react";

interface ErrorBoundaryProps {
  children: ReactNode;
  fallback?: ReactNode;
  onError?: (error: Error, errorInfo: React.ErrorInfo) => void;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // ì—ëŸ¬ ë¡œê¹…
    console.error("ErrorBoundary caught an error:", error, errorInfo);
    
    // ê°œë°œ í™˜ê²½ì—ì„œë§Œ ìƒì„¸ ì—ëŸ¬ ì •ë³´ í‘œì‹œ
    if (process.env.NODE_ENV === "development") {
      console.error("Error details:", errorInfo);
    }

    // onError ì½œë°± í˜¸ì¶œ
    if (this.props.onError) {
      this.props.onError(error, errorInfo);
    }
  }

  handleReset = () => {
    this.setState({ hasError: false, error: null });
  };

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="flex flex-col gap-4 rounded-lg border border-red-200 bg-red-50 p-6">
          <div className="flex items-start gap-3">
            <AlertCircle className="h-5 w-5 text-red-600 flex-shrink-0" />
            <div className="flex flex-1 flex-col gap-1">
              <h3 className="text-sm font-semibold text-red-800">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
              <p className="text-sm text-red-700">
                í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
              </p>
              {process.env.NODE_ENV === "development" && this.state.error && (
                <details className="flex flex-col gap-2">
                  <summary className="cursor-pointer text-xs text-red-600 hover:text-red-800">
                    ê°œë°œì ì •ë³´ (ê°œë°œ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ)
                  </summary>
                  <pre className="overflow-auto rounded bg-red-100 p-2 text-xs text-red-900">
                    {this.state.error.toString()}
                    {this.state.error.stack && `\n\n${this.state.error.stack}`}
                  </pre>
                </details>
              )}
              <div className="flex gap-2">
                <button
                  onClick={this.handleReset}
                  className="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                >
                  ë‹¤ì‹œ ì‹œë„
                </button>
                <button
                  onClick={() => window.location.reload()}
                  className="rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-medium text-red-700 transition-colors hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                >
                  í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}
</file>

<file path="group/[id]/_components/GeneratePlansButton.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import dynamic from "next/dynamic";
import { getPlansByGroupIdAction } from "@/app/(student)/actions/planGroupActions";
import { PlanStatus } from "@/lib/types/plan";
import { LoadingSkeleton } from "@/components/ui/LoadingSkeleton";

// í° ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ëŠ” ë™ì  importë¡œ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…
const PlanPreviewDialog = dynamic(
  () => import("./PlanPreviewDialog").then((mod) => ({ default: mod.PlanPreviewDialog })),
  {
    loading: () => <LoadingSkeleton />,
    ssr: false,
  }
);

type GeneratePlansButtonProps = {
  groupId: string;
  currentStatus: PlanStatus;
  onPlansGenerated?: () => void;
};

export function GeneratePlansButton({
  groupId,
  currentStatus,
  onPlansGenerated,
}: GeneratePlansButtonProps) {
  const router = useRouter();
  const [hasPlans, setHasPlans] = useState<boolean | null>(null);
  const [previewOpen, setPreviewOpen] = useState(false);

  const canGenerate = currentStatus === "saved" || currentStatus === "active";

  // í”Œëœì´ ì´ë¯¸ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
  useEffect(() => {
    const checkPlans = async () => {
      try {
        const result = await getPlansByGroupIdAction(groupId);
        setHasPlans(result.plans.length > 0);
      } catch (error) {
        console.error("í”Œëœ í™•ì¸ ì‹¤íŒ¨:", error);
        setHasPlans(false);
      }
    };

    if (canGenerate) {
      checkPlans();
    }
  }, [groupId, canGenerate]);

  const handlePreviewClick = () => {
    if (!canGenerate) {
      alert("í”Œëœ ê·¸ë£¹ì´ ì €ì¥ë˜ê±°ë‚˜ í™œì„±í™”ëœ ìƒíƒœì—ì„œë§Œ í”Œëœì„ ë¯¸ë¦¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return;
    }
    setPreviewOpen(true);
  };

  const handlePlansGenerated = () => {
    // ì‹¤ì œ í”Œëœ ìƒì„±ì´ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í˜¸ì¶œë¨ (ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” í˜¸ì¶œë˜ì§€ ì•ŠìŒ)
    setHasPlans(true);
    router.refresh();
    onPlansGenerated?.();
  };

  if (!canGenerate) {
    return null;
  }

  const isDisabled = hasPlans === true;

  return (
    <>
      <div className="space-y-2">
        <button
          type="button"
          onClick={handlePreviewClick}
          disabled={isDisabled}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
        >
          í”Œëœ ë¯¸ë¦¬ë³´ê¸° ë° ìƒì„±
        </button>
        {hasPlans && (
          <p className="text-sm text-gray-800">
            í”Œëœì´ ì´ë¯¸ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í”Œëœì„ ë§Œë“¤ë ¤ë©´ í”Œëœ ê·¸ë£¹ì„ ë³µì‚¬í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”.
          </p>
        )}
      </div>
      <PlanPreviewDialog
        groupId={groupId}
        open={previewOpen}
        onOpenChange={setPreviewOpen}
        onPlansGenerated={handlePlansGenerated}
      />
    </>
  );
}
</file>

<file path="group/[id]/_components/LogicalPlanList.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { Plus, Edit2, Trash2, Book, Video, FileText, GripVertical } from "lucide-react";
import type { PlanGroupItem, PlanGroupItemInput } from "@/lib/types/plan";
import {
  createLogicalPlan,
  updateLogicalPlan,
  deleteLogicalPlan,
} from "@/app/(student)/actions/plan-groups/items";

type LogicalPlanListProps = {
  planGroupId: string;
  tenantId: string | null;
  initialItems?: PlanGroupItem[];
  readOnly?: boolean;
  onItemsChange?: (items: PlanGroupItem[]) => void;
};

const contentTypeIcons = {
  book: Book,
  lecture: Video,
  custom: FileText,
};

const contentTypeLabels = {
  book: "êµì¬",
  lecture: "ê°•ì˜",
  custom: "ì»¤ìŠ¤í…€",
};

export function LogicalPlanList({
  planGroupId,
  tenantId,
  initialItems = [],
  readOnly = false,
  onItemsChange,
}: LogicalPlanListProps) {
  const router = useRouter();
  const [items, setItems] = useState<PlanGroupItem[]>(initialItems);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [editingItem, setEditingItem] = useState<PlanGroupItem | null>(null);
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);

  useEffect(() => {
    onItemsChange?.(items);
  }, [items, onItemsChange]);

  const handleCreate = async (input: PlanGroupItemInput) => {
    setIsLoading(true);
    setError(null);

    const result = await createLogicalPlan(planGroupId, input);

    if (result.success && result.itemId) {
      // ìƒˆë¡œ ìƒì„±ëœ ì•„ì´í…œì„ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•¨ (ë˜ëŠ” ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
      // ì¼ë‹¨ ì„±ê³µí•˜ë©´ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì´ ì•ˆì „
      router.refresh();
      setIsAddModalOpen(false);
    } else {
      setError(result.error || "ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    setIsLoading(false);
  };

  const handleUpdate = async (itemId: string, input: Partial<PlanGroupItemInput>) => {
    setIsLoading(true);
    setError(null);

    const result = await updateLogicalPlan(itemId, input);

    if (result.success) {
      // ì—…ë°ì´íŠ¸ ì„±ê³µ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      router.refresh();
      setEditingItem(null);
    } else {
      setError(result.error || "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    setIsLoading(false);
  };

  const handleDelete = async (itemId: string) => {
    if (!confirm("ì´ ë…¼ë¦¬ í”Œëœì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    setIsLoading(true);
    setError(null);

    const result = await deleteLogicalPlan(itemId);

    if (result.success) {
      setItems((prev) => prev.filter((item) => item.id !== itemId));
    } else {
      setError(result.error || "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    setIsLoading(false);
  };

  if (items.length === 0 && readOnly) {
    return (
      <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
        <div className="mx-auto flex flex-col gap-2">
          <FileText className="mx-auto h-12 w-12 text-gray-400" />
          <h3 className="text-sm font-medium text-gray-900">
            ë…¼ë¦¬ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤
          </h3>
          <p className="text-sm text-gray-500">
            ì´ í”Œëœ ê·¸ë£¹ì—ëŠ” ë…¼ë¦¬ í”Œëœì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {/* í—¤ë” */}
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-lg font-semibold text-gray-900">ë…¼ë¦¬ í”Œëœ ëª©ë¡</h3>
          <p className="text-sm text-gray-500">
            ì½˜í…ì¸ ë³„ í•™ìŠµ ê³„íš ë‹¨ìœ„ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
          </p>
        </div>
        {!readOnly && (
          <button
            onClick={() => setIsAddModalOpen(true)}
            disabled={isLoading}
            className="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700 disabled:opacity-50"
          >
            <Plus className="h-4 w-4" />
            ì¶”ê°€
          </button>
        )}
      </div>

      {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
      {error && (
        <div className="rounded-lg bg-red-50 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* ëª©ë¡ */}
      <div className="space-y-2">
        {items
          .sort((a, b) => a.display_order - b.display_order)
          .map((item) => {
            const Icon = contentTypeIcons[item.content_type];

            return (
              <div
                key={item.id}
                className="flex items-center gap-3 rounded-lg border border-gray-200 bg-white p-4 transition hover:border-gray-300"
              >
                {/* ë“œë˜ê·¸ í•¸ë“¤ (í–¥í›„ êµ¬í˜„) */}
                {!readOnly && (
                  <GripVertical className="h-5 w-5 cursor-grab text-gray-400" />
                )}

                {/* ì½˜í…ì¸  íƒ€ì… ì•„ì´ì½˜ */}
                <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-100">
                  <Icon className="h-5 w-5 text-gray-600" />
                </div>

                {/* ì •ë³´ */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-xs font-medium text-gray-500">
                      {contentTypeLabels[item.content_type]}
                    </span>
                    {item.is_review && (
                      <span className="rounded-full bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-700">
                        ë³µìŠµ
                      </span>
                    )}
                    {item.repeat_count > 1 && (
                      <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700">
                        {item.repeat_count}íšŒ
                      </span>
                    )}
                  </div>
                  <p className="truncate text-sm font-medium text-gray-900">
                    ì½˜í…ì¸  ID: {item.content_id.slice(0, 8)}...
                  </p>
                  {(item.target_start_page_or_time !== null ||
                    item.target_end_page_or_time !== null) && (
                    <p className="text-xs text-gray-500">
                      ë²”ìœ„: {item.target_start_page_or_time ?? 0} ~{" "}
                      {item.target_end_page_or_time ?? "ë"}
                    </p>
                  )}
                </div>

                {/* ìš°ì„ ìˆœìœ„ */}
                <div className="text-center">
                  <span className="text-xs text-gray-500">ìš°ì„ ìˆœìœ„</span>
                  <p className="text-sm font-semibold text-gray-900">
                    {item.priority}
                  </p>
                </div>

                {/* ì•¡ì…˜ ë²„íŠ¼ */}
                {!readOnly && (
                  <div className="flex items-center gap-1">
                    <button
                      onClick={() => setEditingItem(item)}
                      disabled={isLoading}
                      className="rounded p-1.5 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600"
                      title="ìˆ˜ì •"
                    >
                      <Edit2 className="h-4 w-4" />
                    </button>
                    <button
                      onClick={() => handleDelete(item.id)}
                      disabled={isLoading}
                      className="rounded p-1.5 text-gray-400 transition hover:bg-red-50 hover:text-red-600"
                      title="ì‚­ì œ"
                    >
                      <Trash2 className="h-4 w-4" />
                    </button>
                  </div>
                )}
              </div>
            );
          })}
      </div>

      {/* ë¹ˆ ìƒíƒœ (ì¶”ê°€ ê°€ëŠ¥) */}
      {items.length === 0 && !readOnly && (
        <div className="rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
          <div className="mx-auto flex flex-col gap-4">
            <div className="mx-auto flex flex-col gap-2">
              <FileText className="mx-auto h-12 w-12 text-gray-400" />
              <h3 className="text-sm font-medium text-gray-900">
                ë…¼ë¦¬ í”Œëœ ì¶”ê°€
              </h3>
              <p className="text-sm text-gray-500">
                í•™ìŠµí•  ì½˜í…ì¸ ì™€ ë²”ìœ„ë¥¼ ì •ì˜í•˜ì„¸ìš”.
              </p>
            </div>
            <button
              onClick={() => setIsAddModalOpen(true)}
              className="mx-auto inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700"
            >
              <Plus className="h-4 w-4" />
              ì²« ë…¼ë¦¬ í”Œëœ ì¶”ê°€
            </button>
          </div>
        </div>
      )}

      {/* ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ (ê°„ë‹¨í•œ í¼) */}
      {(isAddModalOpen || editingItem) && (
        <LogicalPlanFormModal
          item={editingItem}
          onSubmit={(input) => {
            if (editingItem) {
              handleUpdate(editingItem.id, input);
            } else {
              handleCreate(input);
            }
          }}
          onClose={() => {
            setIsAddModalOpen(false);
            setEditingItem(null);
          }}
          isLoading={isLoading}
        />
      )}
    </div>
  );
}

// ê°„ë‹¨í•œ í¼ ëª¨ë‹¬
function LogicalPlanFormModal({
  item,
  onSubmit,
  onClose,
  isLoading,
}: {
  item: PlanGroupItem | null;
  onSubmit: (input: PlanGroupItemInput) => void;
  onClose: () => void;
  isLoading: boolean;
}) {
  const [contentType, setContentType] = useState<"book" | "lecture" | "custom">(
    item?.content_type || "book"
  );
  const [contentId, setContentId] = useState(item?.content_id || "");
  const [startRange, setStartRange] = useState<number | "">(
    item?.target_start_page_or_time ?? ""
  );
  const [endRange, setEndRange] = useState<number | "">(
    item?.target_end_page_or_time ?? ""
  );
  const [repeatCount, setRepeatCount] = useState(item?.repeat_count || 1);
  const [isReview, setIsReview] = useState(item?.is_review || false);
  const [priority, setPriority] = useState(item?.priority || 0);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (!contentId.trim()) {
      alert("ì½˜í…ì¸  IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    onSubmit({
      content_type: contentType,
      content_id: contentId.trim(),
      target_start_page_or_time: startRange === "" ? 0 : startRange,
      target_end_page_or_time: endRange === "" ? 0 : endRange,
      repeat_count: repeatCount,
      is_review: isReview,
      priority,
    });
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="w-full max-w-md rounded-xl bg-white p-6 shadow-xl">
        <h2 className="text-lg font-semibold text-gray-900">
          {item ? "ë…¼ë¦¬ í”Œëœ ìˆ˜ì •" : "ë…¼ë¦¬ í”Œëœ ì¶”ê°€"}
        </h2>

        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          {/* ì½˜í…ì¸  íƒ€ì… */}
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              ì½˜í…ì¸  ìœ í˜•
            </label>
            <select
              value={contentType}
              onChange={(e) =>
                setContentType(e.target.value as "book" | "lecture" | "custom")
              }
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            >
              <option value="book">êµì¬</option>
              <option value="lecture">ê°•ì˜</option>
              <option value="custom">ì»¤ìŠ¤í…€</option>
            </select>
          </div>

          {/* ì½˜í…ì¸  ID */}
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              ì½˜í…ì¸  ID
            </label>
            <input
              type="text"
              value={contentId}
              onChange={(e) => setContentId(e.target.value)}
              placeholder="UUID í˜•ì‹ì˜ ì½˜í…ì¸  ID"
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          {/* ë²”ìœ„ */}
          <div className="grid grid-cols-2 gap-4">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                ì‹œì‘ (í˜ì´ì§€/ë¶„)
              </label>
              <input
                type="number"
                value={startRange}
                onChange={(e) =>
                  setStartRange(e.target.value === "" ? "" : Number(e.target.value))
                }
                placeholder="0"
                min={0}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                ì¢…ë£Œ (í˜ì´ì§€/ë¶„)
              </label>
              <input
                type="number"
                value={endRange}
                onChange={(e) =>
                  setEndRange(e.target.value === "" ? "" : Number(e.target.value))
                }
                placeholder="100"
                min={0}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>
          </div>

          {/* ë°˜ë³µ íšŸìˆ˜ */}
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              ë°˜ë³µ íšŸìˆ˜
            </label>
            <input
              type="number"
              value={repeatCount}
              onChange={(e) => setRepeatCount(Number(e.target.value))}
              min={1}
              max={10}
              className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          {/* ë³µìŠµ ì—¬ë¶€ & ìš°ì„ ìˆœìœ„ */}
          <div className="grid grid-cols-2 gap-4">
            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                id="isReview"
                checked={isReview}
                onChange={(e) => setIsReview(e.target.checked)}
                className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <label htmlFor="isReview" className="text-sm text-gray-700">
                ë³µìŠµ í”Œëœ
              </label>
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                ìš°ì„ ìˆœìœ„
              </label>
              <input
                type="number"
                value={priority}
                onChange={(e) => setPriority(Number(e.target.value))}
                min={0}
                max={100}
                className="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>
          </div>

          {/* ë²„íŠ¼ */}
          <div className="flex justify-end gap-2 pt-4">
            <button
              type="button"
              onClick={onClose}
              disabled={isLoading}
              className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="submit"
              disabled={isLoading}
              className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700 disabled:opacity-50"
            >
              {isLoading ? "ì €ì¥ ì¤‘..." : item ? "ìˆ˜ì •" : "ì¶”ê°€"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/_components/PlanGroupActionButtons.tsx">
"use client";

import { useState, useTransition } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Pencil, Copy, Trash2, RefreshCw } from "lucide-react";
import { PlanStatus } from "@/lib/types/plan";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { deletePlanGroupAction, copyPlanGroupAction } from "@/app/(student)/actions/planGroupActions";
import { useToast } from "@/components/ui/ToastProvider";
import { PlanGroupDeleteDialog } from "@/app/(student)/plan/_components/PlanGroupDeleteDialog";

type PlanGroupActionButtonsProps = {
  groupId: string;
  groupName: string | null;
  groupStatus: PlanStatus;
  canEdit: boolean;
  canDelete: boolean;
};

export function PlanGroupActionButtons({
  groupId,
  groupName,
  groupStatus,
  canEdit,
  canDelete,
}: PlanGroupActionButtonsProps) {
  const router = useRouter();
  const toast = useToast();
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [copyPending, setCopyPending] = useState(false);
  const [isPending, startTransition] = useTransition();

  const handleCopy = () => {
    if (
      !confirm(
        "í”Œëœ ê·¸ë£¹ì„ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µì‚¬ëœ í”Œëœ ê·¸ë£¹ì€ ì´ˆì•ˆ ìƒíƒœë¡œ ìƒì„±ë˜ë©°, í”Œëœì€ ë³µì‚¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
      )
    ) {
      return;
    }

    setCopyPending(true);
    startTransition(async () => {
      try {
        const result = await copyPlanGroupAction(groupId);
        toast.showSuccess("í”Œëœ ê·¸ë£¹ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        router.push(`/plan/group/${result.groupId}/edit`, { scroll: true });
      } catch (error) {
        toast.showError(
          error instanceof Error
            ? error.message
            : "í”Œëœ ê·¸ë£¹ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
        setCopyPending(false);
      }
    });
  };

  return (
    <>
      <div className="flex items-center gap-2">
        {canEdit && (
          <>
            <Link
              href={`/plan/group/${groupId}/reschedule`}
              className="inline-flex items-center justify-center rounded-lg p-2 text-gray-700 transition hover:bg-gray-100 hover:text-gray-900"
              title="ì¬ì¡°ì •"
              aria-label="í”Œëœ ê·¸ë£¹ ì¬ì¡°ì •"
            >
              <RefreshCw className="h-4 w-4" />
            </Link>
            <Link
              href={`/plan/group/${groupId}/edit`}
              className="inline-flex items-center justify-center rounded-lg p-2 text-gray-700 transition hover:bg-gray-100 hover:text-gray-900"
              title="ìˆ˜ì •"
              aria-label="í”Œëœ ê·¸ë£¹ ìˆ˜ì •"
            >
              <Pencil className="h-4 w-4" />
            </Link>
          </>
        )}

        <button
          type="button"
          onClick={handleCopy}
          disabled={copyPending || isPending}
          className="inline-flex items-center justify-center rounded-lg p-2 text-gray-700 transition hover:bg-gray-100 hover:text-gray-900 disabled:cursor-not-allowed disabled:opacity-50"
          title="ë³µì‚¬í•˜ê¸°"
          aria-label="í”Œëœ ê·¸ë£¹ ë³µì‚¬í•˜ê¸°"
        >
          <Copy className="h-4 w-4" />
        </button>

        {canDelete && (
          <button
            type="button"
            onClick={() => setDeleteDialogOpen(true)}
            className="inline-flex items-center justify-center rounded-lg p-2 text-gray-700 transition hover:bg-red-50 hover:text-red-600"
            title="ì‚­ì œ"
            aria-label="í”Œëœ ê·¸ë£¹ ì‚­ì œ"
          >
            <Trash2 className="h-4 w-4" />
          </button>
        )}
      </div>

      <PlanGroupDeleteDialog
        open={deleteDialogOpen}
        onOpenChange={setDeleteDialogOpen}
        groupId={groupId}
        groupName={groupName}
        groupStatus={groupStatus}
      />
    </>
  );
}
</file>

<file path="group/[id]/_components/PlanGroupCopyButton.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { Copy } from "lucide-react";
import { copyPlanGroupAction } from "@/app/(student)/actions/planGroupActions";

type PlanGroupCopyButtonProps = {
  groupId: string;
};

export function PlanGroupCopyButton({ groupId }: PlanGroupCopyButtonProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);

  const handleCopy = () => {
    if (
      !confirm(
        "í”Œëœ ê·¸ë£¹ì„ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µì‚¬ëœ í”Œëœ ê·¸ë£¹ì€ ì´ˆì•ˆ ìƒíƒœë¡œ ìƒì„±ë˜ë©°, í”Œëœì€ ë³µì‚¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
      )
    ) {
      return;
    }

    setError(null);
    startTransition(async () => {
      try {
        const result = await copyPlanGroupAction(groupId);
        router.push(`/plan/group/${result.groupId}/edit`, { scroll: true });
      } catch (err) {
        setError(
          err instanceof Error ? err.message : "í”Œëœ ê·¸ë£¹ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  return (
    <div className="flex flex-col gap-2">
      <button
        type="button"
        onClick={handleCopy}
        disabled={isPending}
        className="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <Copy className="h-4 w-4" />
        {isPending ? "ë³µì‚¬ ì¤‘..." : "ë³µì‚¬í•˜ê¸°"}
      </button>
      {error && (
        <p className="text-sm text-red-600">{error}</p>
      )}
    </div>
  );
}
</file>

<file path="group/[id]/_components/PlanGroupDeleteButton.tsx">
"use client";

import { useTransition } from "react";
import { useRouter } from "next/navigation";
import { deletePlanGroupAction } from "@/app/(student)/actions/planGroupActions";

type PlanGroupDeleteButtonProps = {
  groupId: string;
};

export function PlanGroupDeleteButton({ groupId }: PlanGroupDeleteButtonProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  const handleDelete = () => {
    if (
      !confirm(
        "í”Œëœ ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      )
    ) {
      return;
    }

    startTransition(async () => {
      try {
        await deletePlanGroupAction(groupId);
        router.push("/plan", { scroll: true });
      } catch (error) {
        alert(
          error instanceof Error ? error.message : "í”Œëœ ê·¸ë£¹ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  return (
    <button
      type="button"
      onClick={handleDelete}
      disabled={isPending}
      className="inline-flex items-center justify-center rounded-lg border border-red-300 px-4 py-2 text-sm font-semibold text-red-700 hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"
    >
      {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
    </button>
  );
}
</file>

<file path="group/[id]/_components/PlanGroupDetailTabs.tsx">
"use client";

import { KeyboardEvent } from "react";

type Tab = {
  id: number;
  label: string;
  completed: boolean;
};

type PlanGroupDetailTabsProps = {
  currentTab: number;
  onTabChange: (tab: number) => void;
  tabs: Tab[];
};

export function PlanGroupDetailTabs({
  currentTab,
  onTabChange,
  tabs,
}: PlanGroupDetailTabsProps) {
  // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ í•¸ë“¤ëŸ¬
  const handleKeyDown = (e: KeyboardEvent<HTMLButtonElement>, tabId: number) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      onTabChange(tabId);
    } else if (e.key === "ArrowLeft") {
      e.preventDefault();
      const currentIndex = tabs.findIndex((t) => t.id === currentTab);
      const prevIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
      onTabChange(tabs[prevIndex].id);
    } else if (e.key === "ArrowRight") {
      e.preventDefault();
      const currentIndex = tabs.findIndex((t) => t.id === currentTab);
      const nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
      onTabChange(tabs[nextIndex].id);
    } else if (e.key === "Home") {
      e.preventDefault();
      onTabChange(tabs[0].id);
    } else if (e.key === "End") {
      e.preventDefault();
      onTabChange(tabs[tabs.length - 1].id);
    }
  };

  return (
    <div className="border-b border-gray-200">
      <nav
        className="-mb-px flex flex-wrap gap-2 pb-px"
        aria-label="í”Œëœ ê·¸ë£¹ ìƒì„¸ ì •ë³´ íƒ­"
        role="tablist"
      >
        {tabs.map((tab) => (
          <button
            key={tab.id}
            id={`tab-${tab.id}`}
            role="tab"
            aria-selected={currentTab === tab.id}
            aria-controls={`tabpanel-${tab.id}`}
            tabIndex={currentTab === tab.id ? 0 : -1}
            onClick={() => onTabChange(tab.id)}
            onKeyDown={(e) => handleKeyDown(e, tab.id)}
            className={`
              group relative inline-flex items-center rounded-t-lg border-b-2 px-3 py-3 text-sm font-semibold transition-all
              focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
              ${
                currentTab === tab.id
                  ? "border-blue-600 bg-blue-50 text-blue-700"
                  : "border-transparent text-gray-800 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-900"
              }
            `}
          >
            <span className="whitespace-nowrap">{tab.label}</span>
            {tab.completed && currentTab !== tab.id && (
              <span className="sr-only">ì™„ë£Œë¨</span>
            )}
            {currentTab === tab.id && (
              <>
                <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600" />
                <span className="sr-only">ì„ íƒëœ íƒ­</span>
              </>
            )}
          </button>
        ))}
      </nav>
    </div>
  );
}
</file>

<file path="group/[id]/_components/PlanGroupDetailView.tsx">
"use client";

import { useState, useRef, useMemo, useCallback, lazy, Suspense, memo } from "react";
import { PlanGroupDetailTabs } from "./PlanGroupDetailTabs";
import { GeneratePlansButton } from "./GeneratePlansButton";
import { LoadingSkeleton } from "@/components/ui/LoadingSkeleton";
import { ErrorBoundary } from "./ErrorBoundary";
import type { PlanGroup, PlanContent, PlanExclusion, AcademySchedule, PlanStatus } from "@/lib/types/plan";
import type { PlanScheduleViewRef } from "./PlanScheduleView";
import { planGroupToWizardData, contentsToWizardFormat } from "@/lib/utils/planGroupAdapters";

// ë™ì  ì„í¬íŠ¸ë¡œ ë ˆì´ì§€ ë¡œë”© - ìƒˆë¡œìš´ Step ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©
const Step1BasicInfo = lazy(() => 
  import("@/app/(student)/plan/new-group/_components/Step1BasicInfo").then(module => ({ default: module.Step1BasicInfo }))
);
const Step2TimeSettings = lazy(() => 
  import("@/app/(student)/plan/new-group/_components/Step2TimeSettings").then(module => ({ default: module.Step2TimeSettings }))
);
const Step3ContentSelection = lazy(() => 
  import("@/app/(student)/plan/new-group/_components/Step3ContentSelection").then(module => ({ default: module.Step3ContentSelection }))
);
const Step6Simplified = lazy(() => 
  import("@/app/(student)/plan/new-group/_components/Step6Simplified").then(module => ({ default: module.Step6Simplified }))
);
const Step7ScheduleResult = lazy(() => 
  import("@/app/(student)/plan/new-group/_components/Step7ScheduleResult").then(module => ({ default: module.Step7ScheduleResult }))
);


type PlanGroupDetailViewProps = {
  group: PlanGroup;
  contents: PlanContent[];
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  contentsWithDetails: Array<PlanContent & {
    contentTitle: string;
    contentSubtitle: string | null;
    isRecommended: boolean;
  }>;
  canEdit: boolean;
  groupId: string;
  hasPlans?: boolean;
  campSubmissionMode?: boolean;
  templateBlocks?: Array<{
    id: string;
    day_of_week: number;
    start_time: string;
    end_time: string;
  }>;
  templateBlockSetName?: string | null;
  templateBlockSetId?: string | null;
  blockSets?: Array<{
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  }>;
  campTemplateId?: string | null;

};

function PlanGroupDetailViewComponent({
  group,
  contents,
  exclusions,
  academySchedules,
  contentsWithDetails,
  canEdit,
  groupId,
  hasPlans = false,
  campSubmissionMode = false,
  templateBlocks = [],
  templateBlockSetName = null,
  templateBlockSetId = null,
  blockSets = [],
  campTemplateId = null,

}: PlanGroupDetailViewProps) {
  const scheduleViewRef = useRef<PlanScheduleViewRef | null>(null);

  // íƒ­ ì •ë³´ ë©”ëª¨ì´ì œì´ì…˜
  const allTabs = useMemo(() => [
    { id: 1, label: "ê¸°ë³¸ ì •ë³´", completed: !!group.name && !!group.plan_purpose && !!group.scheduler_type },
    { id: 2, label: "ë¸”ë¡ ë° ì œì™¸ì¼", completed: !!group.block_set_id },
    { id: 4, label: "ì½˜í…ì¸  ì„ íƒ", completed: contents.length > 0 }, // í•™ìƒ + ì¶”ì²œ í†µí•©
    { id: 6, label: "ìµœì¢… ê²€í† ", completed: true },
    { id: 7, label: "ìŠ¤ì¼€ì¤„ ê²°ê³¼", completed: hasPlans },
  ], [group.name, group.plan_purpose, group.scheduler_type, group.block_set_id, contents.length, hasPlans]);

  // ìº í”„ ì œì¶œ ëª¨ë“œì¼ ë•Œ íƒ­ í•„í„°ë§ (1, 2, 4ë§Œ í‘œì‹œ, ì¶”ì²œ ì½˜í…ì¸  ì œì™¸)
  const tabs = useMemo(() => {
    if (campSubmissionMode) {
      return allTabs.filter(tab => [1, 2, 4].includes(tab.id));
    }
    return allTabs;
  }, [allTabs, campSubmissionMode]);

  // í—ˆìš©ëœ íƒ­ ID ëª©ë¡
  const allowedTabIds = useMemo(() => {
    if (campSubmissionMode) {
      return [1, 2, 4];
    }
    return [1, 2, 4, 6, 7]; // Step 3, 5 ì œê±° (Step 2, 4ì— í†µí•©), ë…¼ë¦¬ í”Œëœ íƒ­(8) ì œê±° (ì¬ì¡°ì • ê¸°ëŠ¥ìœ¼ë¡œ í†µí•©)
  }, [campSubmissionMode]);

  // ì´ˆê¸° íƒ­ ì„¤ì • (í—ˆìš©ëœ íƒ­ ì¤‘ ì²« ë²ˆì§¸)
  const initialTab = useMemo(() => {
    return allowedTabIds[0];
  }, [allowedTabIds]);

  const [currentTab, setCurrentTab] = useState(initialTab);

  // í•„í„°ë§ëœ ì½˜í…ì¸  ë©”ëª¨ì´ì œì´ì…˜
  const studentContents = useMemo(() => 
    contentsWithDetails.filter(c => !c.isRecommended),
    [contentsWithDetails]
  );
  
  const recommendedContents = useMemo(() => 
    contentsWithDetails.filter(c => c.isRecommended),
    [contentsWithDetails]
  );

  // ìº í”„ ëª¨ë“œì¼ ë•Œ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ë¥¼ blockSetsì— ì¶”ê°€
  const enhancedBlockSets = useMemo(() => {
    if (campTemplateId && templateBlockSetId && templateBlockSetName && templateBlocks.length > 0) {
      // í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ê°€ ì´ë¯¸ blockSetsì— ìˆëŠ”ì§€ í™•ì¸
      const existingIndex = blockSets.findIndex(bs => bs.id === templateBlockSetId);
      
      if (existingIndex >= 0) {
        // ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
        const updated = [...blockSets];
        updated[existingIndex] = {
          id: templateBlockSetId,
          name: templateBlockSetName,
          blocks: templateBlocks,
        };
        return updated;
      } else {
        // ì—†ìœ¼ë©´ ë§¨ ì•ì— ì¶”ê°€
        return [
          {
            id: templateBlockSetId,
            name: templateBlockSetName,
            blocks: templateBlocks,
          },
          ...blockSets,
        ];
      }
    }
    return blockSets;
  }, [campTemplateId, templateBlockSetId, templateBlockSetName, templateBlocks, blockSets]);

  // WizardDataë¡œ ë³€í™˜ (ì½ê¸° ì „ìš© ëª¨ë“œìš©)
  const wizardData = useMemo(() => {
    const baseData = planGroupToWizardData(group, exclusions, academySchedules);
    const { studentContents: studentContentsFormatted, recommendedContents: recommendedContentsFormatted } = 
      contentsToWizardFormat(contentsWithDetails);
    
    // WizardDataëŠ” "book" | "lecture"ë§Œ í—ˆìš©í•˜ë¯€ë¡œ "custom" íƒ€ì… í•„í„°ë§
    const filteredStudentContents = studentContentsFormatted.filter(
      (c) => c.content_type === "book" || c.content_type === "lecture"
    ) as Array<{
      content_type: "book" | "lecture";
      content_id: string;
      start_range: number;
      end_range: number;
      subject_category?: string;
      title?: string;
    }>;
    
    const filteredRecommendedContents = recommendedContentsFormatted.filter(
      (c) => c.content_type === "book" || c.content_type === "lecture"
    ) as Array<{
      content_type: "book" | "lecture";
      content_id: string;
      start_range: number;
      end_range: number;
      subject_category?: string;
      title?: string;
      is_auto_recommended?: boolean;
    }>;
    
    // ìº í”„ ëª¨ë“œì¼ ë•Œ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ block_set_idë¡œ ì„¤ì •
    const blockSetId = campTemplateId && templateBlockSetId 
      ? templateBlockSetId 
      : baseData.block_set_id;
    
    return {
      ...baseData,
      block_set_id: blockSetId,
      student_contents: filteredStudentContents,
      recommended_contents: filteredRecommendedContents,
    };
  }, [group, exclusions, academySchedules, contentsWithDetails, campTemplateId, templateBlockSetId]);

  // contentsWithDetailsë¥¼ Step3ContentSelectionì— í•„ìš”í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const formattedContents = useMemo(() => {
    const books = contentsWithDetails
      .filter((c) => c.content_type === "book")
      .map((c) => ({
        id: c.content_id,
        title: c.contentTitle || "ì•Œ ìˆ˜ ì—†ìŒ",
        subtitle: c.contentSubtitle,
        master_content_id: (c as any).master_content_id || null,
      }));
    
    const lectures = contentsWithDetails
      .filter((c) => c.content_type === "lecture")
      .map((c) => ({
        id: c.content_id,
        title: c.contentTitle || "ì•Œ ìˆ˜ ì—†ìŒ",
        subtitle: c.contentSubtitle,
        master_content_id: (c as any).master_content_id || null,
      }));
    
    const custom = contentsWithDetails
      .filter((c) => c.content_type === "custom")
      .map((c) => ({
        id: c.content_id,
        title: c.contentTitle || "ì•Œ ìˆ˜ ì—†ìŒ",
        subtitle: c.contentSubtitle,
      }));
    
    return { books, lectures, custom };
  }, [contentsWithDetails]);

  // íƒ­ ë³€ê²½ í•¸ë“¤ëŸ¬ ë©”ëª¨ì´ì œì´ì…˜
  const handleTabChange = useCallback((tab: number) => {
    // ìº í”„ ì œì¶œ ëª¨ë“œì¼ ë•Œ í—ˆìš©ë˜ì§€ ì•Šì€ íƒ­ìœ¼ë¡œ ë³€ê²½ ì‹œë„ ì‹œ ë¬´ì‹œ
    if (campSubmissionMode && !allowedTabIds.includes(tab)) {
      setCurrentTab(initialTab);
      return;
    }
    setCurrentTab(tab);
  }, [campSubmissionMode, allowedTabIds, initialTab]);

  // ìŠ¤ì¼€ì¤„ ë·° ì¤€ë¹„ í•¸ë“¤ëŸ¬ ë©”ëª¨ì´ì œì´ì…˜
  const handleScheduleViewReady = useCallback((ref: PlanScheduleViewRef | null) => {
    scheduleViewRef.current = ref;
  }, []);

  // í”Œëœ ìƒì„± í›„ ì½œë°± ë©”ëª¨ì´ì œì´ì…˜
  const handlePlansGenerated = useCallback(() => {
    scheduleViewRef.current?.refresh();
  }, []);

  // ì½ê¸° ì „ìš© ëª¨ë“œì—ì„œ ëª¨ë“  ë³€ê²½ì„ ë§‰ëŠ” wrapper í•¨ìˆ˜
  const readOnlyUpdate = useCallback(() => {
    // ì½ê¸° ì „ìš© ëª¨ë“œì—ì„œëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
  }, []);

  const renderTabContent = () => {
    // ìº í”„ ì œì¶œ ëª¨ë“œì¼ ë•Œ í—ˆìš©ë˜ì§€ ì•Šì€ íƒ­ ì ‘ê·¼ ì‹œ ì²« ë²ˆì§¸ í—ˆìš©ëœ íƒ­ ì½˜í…ì¸  í‘œì‹œ
    const displayTab = campSubmissionMode && !allowedTabIds.includes(currentTab) 
      ? initialTab 
      : currentTab;

    switch (displayTab) {
      case 1:
        return (
          <div className={!canEdit ? "pointer-events-none opacity-75" : ""}>
            <Suspense fallback={<LoadingSkeleton variant="tab" />}>
              <Step1BasicInfo 
                data={wizardData}
                onUpdate={readOnlyUpdate} // ì½ê¸° ì „ìš© - ë³€ê²½ ë¶ˆê°€
                blockSets={enhancedBlockSets}
                editable={false} // ì™„ì „íˆ ì½ê¸° ì „ìš©
                isCampMode={!!campTemplateId} // ìº í”„ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ìº í”„ ëª¨ë“œ
              />
            </Suspense>
          </div>
        );
      case 2:
        return (
          <div className={!canEdit ? "pointer-events-none opacity-75" : ""}>
            <Suspense fallback={<LoadingSkeleton variant="tab" />}>
              <Step2TimeSettings 
                data={wizardData}
                onUpdate={readOnlyUpdate} // ì½ê¸° ì „ìš© - ë³€ê²½ ë¶ˆê°€
                periodStart={group.period_start}
                periodEnd={group.period_end}
                editable={false} // ì™„ì „íˆ ì½ê¸° ì „ìš©
                campMode={!!campTemplateId} // ìº í”„ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ìº í”„ ëª¨ë“œ
                isTemplateMode={false}
                studentId={group.student_id}
              />
            </Suspense>
          </div>
        );
      case 4:
        // ì½˜í…ì¸  ì„ íƒ (í•™ìƒ + ì¶”ì²œ í†µí•©)
        return (
          <div className={!canEdit ? "pointer-events-none opacity-75" : ""}>
            <Suspense fallback={<LoadingSkeleton variant="tab" />}>
              <Step3ContentSelection 
                data={wizardData}
                onUpdate={readOnlyUpdate} // ì½ê¸° ì „ìš© - ë³€ê²½ ë¶ˆê°€
                contents={formattedContents}
                isCampMode={!!campTemplateId} // ìº í”„ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ìº í”„ ëª¨ë“œ
                isEditMode={false}
                studentId={group.student_id}
                editable={false} // ì™„ì „íˆ ì½ê¸° ì „ìš©
              />
            </Suspense>
          </div>
        );
      case 6:
        return (
          <div className={!canEdit ? "pointer-events-none opacity-75" : ""}>
            <Suspense fallback={<LoadingSkeleton variant="tab" />}>
              <Step6Simplified 
                data={wizardData}
                onEditStep={() => {}} // ì½ê¸° ì „ìš© ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
                editable={false} // ì™„ì „íˆ ì½ê¸° ì „ìš©
                isCampMode={!!campTemplateId} // ìº í”„ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ìº í”„ ëª¨ë“œ
                isTemplateMode={false}
                studentId={group.student_id}
              />
            </Suspense>
          </div>
        );
      case 7:
        return (
          <Suspense fallback={<LoadingSkeleton variant="tab" />}>
            <Step7ScheduleResult
              groupId={groupId}
              onComplete={() => {}}
            />
          </Suspense>
        );

      default:
        return (
          <div className={!canEdit ? "pointer-events-none opacity-75" : ""}>
            <Suspense fallback={<LoadingSkeleton variant="tab" />}>
              <Step1BasicInfo 
                data={wizardData}
                onUpdate={readOnlyUpdate} // ì½ê¸° ì „ìš© - ë³€ê²½ ë¶ˆê°€
                blockSets={enhancedBlockSets}
                editable={false} // ì™„ì „íˆ ì½ê¸° ì „ìš©
                isCampMode={!!campTemplateId} // ìº í”„ í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ìº í”„ ëª¨ë“œ
              />
            </Suspense>
          </div>
        );
    }
  };

  return (
    <div className="flex flex-col gap-6">
      <PlanGroupDetailTabs
        currentTab={currentTab}
        onTabChange={handleTabChange}
        tabs={tabs}
      />
      
      <div>
        <ErrorBoundary>
          <div
            role="tabpanel"
            id={`tabpanel-${currentTab}`}
            aria-labelledby={`tab-${currentTab}`}
          >
            {renderTabContent()}
          </div>
        </ErrorBoundary>
      </div>

      {/* í”Œëœ ìƒì„±ì€ Step 7ì—ì„œë§Œ í‘œì‹œ (ì½ê¸° ì „ìš© ëª¨ë“œì—ì„œëŠ” ìˆ¨ê¹€) */}
      {currentTab === 7 && canEdit && (
        <div className="border-t border-gray-200 pt-8">
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-6">
            <div className="flex flex-col gap-4">
              <h2 className="text-lg font-semibold text-gray-900">í”Œëœ ìƒì„±</h2>
              <p className="text-sm text-gray-800">
                í”Œëœ ê·¸ë£¹ ì„¤ì •ì„ ê¸°ë°˜ìœ¼ë¡œ ê°œë³„ í•™ìŠµ í”Œëœì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
              </p>
              <GeneratePlansButton
                groupId={groupId}
                currentStatus={group.status as PlanStatus}
                onPlansGenerated={handlePlansGenerated}
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export const PlanGroupDetailView = memo(PlanGroupDetailViewComponent, (prevProps, nextProps) => {
  // groupì˜ ì£¼ìš” ì†ì„± ë¹„êµ
  const prevGroup = prevProps.group;
  const nextGroup = nextProps.group;
  
  return (
    prevProps.groupId === nextProps.groupId &&
    prevGroup.id === nextGroup.id &&
    prevGroup.name === nextGroup.name &&
    prevGroup.status === nextGroup.status &&
    prevGroup.plan_purpose === nextGroup.plan_purpose &&
    prevGroup.scheduler_type === nextGroup.scheduler_type &&
    prevProps.canEdit === nextProps.canEdit &&
    prevProps.hasPlans === nextProps.hasPlans &&
    prevProps.campSubmissionMode === nextProps.campSubmissionMode &&
    prevProps.contents.length === nextProps.contents.length &&
    prevProps.exclusions.length === nextProps.exclusions.length &&
    prevProps.academySchedules.length === nextProps.academySchedules.length &&
    prevProps.contentsWithDetails.length === nextProps.contentsWithDetails.length &&
    (prevProps.blockSets ?? []).length === (nextProps.blockSets ?? []).length &&
    (prevProps.templateBlocks ?? []).length === (nextProps.templateBlocks ?? []).length &&
    prevProps.templateBlockSetId === nextProps.templateBlockSetId &&
    prevProps.templateBlockSetName === nextProps.templateBlockSetName &&
    prevProps.campTemplateId === nextProps.campTemplateId
  );
});
</file>

<file path="group/[id]/_components/PlanGroupProgressCard.tsx">
"use client";

import { useMemo } from "react";
import { PlanGroup } from "@/lib/types/plan";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import { Card } from "@/components/molecules/Card";

type PlanGroupProgressCardProps = {
  group: PlanGroup;
  planCount: number;
  completedCount: number;
  hasPlans: boolean;
};

export function PlanGroupProgressCard({
  group,
  planCount,
  completedCount,
  hasPlans,
}: PlanGroupProgressCardProps) {
  // ì§„í–‰ë¥  ê³„ì‚° ë©”ëª¨ì´ì œì´ì…˜
  const progressPercentage = useMemo(() => {
    return planCount > 0 ? Math.round((completedCount / planCount) * 100) : 0;
  }, [planCount, completedCount]);

  // ì§„í–‰ ì¤‘ í”Œëœ ê°œìˆ˜ ë©”ëª¨ì´ì œì´ì…˜
  const inProgressCount = useMemo(() => {
    return planCount - completedCount;
  }, [planCount, completedCount]);

  if (!hasPlans || planCount === 0) {
    return (
      <Card>
        <div className="flex items-center justify-between">
          <div className="flex flex-col gap-1">
            <h3 className="text-sm font-medium text-gray-800">í”Œëœ ì§„í–‰ ìƒí™©</h3>
            <p className="text-2xl font-semibold text-gray-900">0ê°œ</p>
            <p className="text-sm text-gray-800">í”Œëœì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </Card>
    );
  }

  return (
    <Card>
      <div className="flex flex-col gap-4">
        <div className="flex items-start justify-between">
          <div className="flex-1 flex flex-col gap-3">
            <h3 className="text-sm font-medium text-gray-800">í”Œëœ ì§„í–‰ ìƒí™©</h3>
            <div className="flex items-baseline gap-2">
              <p className="text-2xl font-semibold text-gray-900">{completedCount}</p>
              <p className="text-lg text-gray-800">/ {planCount}ê°œ</p>
            </div>
            <p className="text-sm text-gray-800">ì™„ë£Œëœ í”Œëœ</p>
          </div>
          <div className="text-right flex flex-col gap-1">
            <p className="text-2xl font-semibold text-blue-600">{progressPercentage}%</p>
            <p className="text-xs text-gray-800">ì§„í–‰ë¥ </p>
          </div>
        </div>
        
        {/* ì§„í–‰ë¥  ë°” */}
        <ProgressBar
          value={progressPercentage}
          max={100}
          color="blue"
          size="sm"
        />

        {/* ìƒì„¸ ì •ë³´ */}
        <div className="grid grid-cols-3 gap-4 border-t border-gray-100 pt-4">
          <div className="flex flex-col gap-1">
            <p className="text-xs text-gray-800">ì™„ë£Œ</p>
            <p className="text-lg font-semibold text-green-600">
              {completedCount}ê°œ
            </p>
          </div>
          <div className="flex flex-col gap-1">
            <p className="text-xs text-gray-800">ì§„í–‰ ì¤‘</p>
            <p className="text-lg font-semibold text-orange-600">
              {inProgressCount}ê°œ
            </p>
          </div>
          <div className="flex flex-col gap-1">
            <p className="text-xs text-gray-800">ì „ì²´</p>
            <p className="text-lg font-semibold text-gray-900">
              {planCount}ê°œ
            </p>
          </div>
        </div>
      </div>
    </Card>
  );
}
</file>

<file path="group/[id]/_components/PlanGroupStatusButtons.tsx">
"use client";

import { useTransition } from "react";
import { useRouter } from "next/navigation";
import { updatePlanGroupStatus, checkPlansExistAction } from "@/app/(student)/actions/planGroupActions";
import { PlanStatus } from "@/lib/types/plan";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { cn } from "@/lib/cn";

type PlanGroupStatusButtonsProps = {
  groupId: string;
  currentStatus: PlanStatus;
  canEdit: boolean;
};

// ìƒíƒœë³„ ë²„íŠ¼ ë¼ë²¨ (í˜„ì¬ ìƒíƒœì—ì„œ ì „ì´ ê°€ëŠ¥í•œ ìƒíƒœì˜ ë¼ë²¨)
const getStatusButtonLabel = (fromStatus: PlanStatus, toStatus: PlanStatus): string => {
  const labels: Record<string, string> = {
    "draft->saved": "ì €ì¥",
    "draft->paused": "ì¤‘ë‹¨", // ì¼ì‹œì •ì§€ë¡œ í†µí•©
    "saved->active": "í™œì„±í™”",
    "saved->draft": "ì´ˆì•ˆìœ¼ë¡œ ë³€ê²½", // ì €ì¥ëœ í”Œëœì„ ë‹¤ì‹œ ìˆ˜ì • ê°€ëŠ¥í•œ ì´ˆì•ˆ ìƒíƒœë¡œ ë˜ëŒë¦¼
    "saved->paused": "ì¤‘ë‹¨", // ì¼ì‹œì •ì§€ë¡œ í†µí•©
    "active->paused": "ì¼ì‹œì •ì§€",
    "active->completed": "ì™„ë£Œ",
    "paused->active": "ì¬ê°œ",
    "cancelled->active": "ì¬ê°œ", // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±
  };
  
  return labels[`${fromStatus}->${toStatus}`] || toStatus;
};

export function PlanGroupStatusButtons({
  groupId,
  currentStatus,
  canEdit,
}: PlanGroupStatusButtonsProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  const availableTransitions = PlanStatusManager.getAvailableTransitions(currentStatus);

  const handleStatusChange = (newStatus: PlanStatus) => {
    // ìƒíƒœ ì „ì´ëŠ” canEditê³¼ ë¬´ê´€í•˜ê²Œ ê°€ëŠ¥ (ìƒíƒœ ì „ì´ ê·œì¹™ë§Œ í™•ì¸)
    if (!PlanStatusManager.canTransition(currentStatus, newStatus)) {
      alert("ì´ ìƒíƒœë¡œ ì „ì´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const buttonLabel = getStatusButtonLabel(currentStatus, newStatus);
    if (
      !confirm(
        `í”Œëœ ê·¸ë£¹ ìƒíƒœë¥¼ "${buttonLabel}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      )
    ) {
      return;
    }

    startTransition(async () => {
      try {
        // í™œì„±í™” ì‹œ í”Œëœì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (newStatus === "active") {
          const checkResult = await checkPlansExistAction(groupId);
          if (!checkResult.hasPlans) {
            alert("í”Œëœì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”Œëœì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.");
            return;
          }
        }

        await updatePlanGroupStatus(groupId, newStatus);
        router.refresh();
        // í™œì„±í™” ì„±ê³µ ì‹œ í”Œëœ ê·¸ë£¹ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (newStatus === "active") {
          router.push(`/plan/group/${groupId}`, { scroll: true });
        }
      } catch (error) {
        alert(
          error instanceof Error
            ? error.message
            : "ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  if (availableTransitions.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 p-4">
        <p className="text-sm text-gray-800 dark:text-gray-200">
          í˜„ì¬ ìƒíƒœì—ì„œëŠ” ìƒíƒœ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-wrap gap-3">
      {availableTransitions.map((status) => {
        const buttonLabel = getStatusButtonLabel(currentStatus, status);
        const isDestructive = status === "cancelled";
        
        return (
          <button
            key={status}
            type="button"
            onClick={() => handleStatusChange(status)}
            disabled={isPending}
            className={cn(
              "inline-flex items-center justify-center rounded-lg border px-4 py-2 text-sm font-semibold transition disabled:cursor-not-allowed disabled:opacity-50",
              isDestructive
                ? "border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/30"
                : status === "active"
                ? "border-green-300 dark:border-green-700 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-900/40"
                : "border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800"
            )}
          >
            {isPending ? "ì²˜ë¦¬ ì¤‘..." : buttonLabel}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="group/[id]/_components/PlanPreviewDialog.tsx">
"use client";

import { useState, useTransition, useMemo } from "react";
import { X } from "lucide-react";
import { previewPlansFromGroupAction, generatePlansFromGroupAction, checkPlansExistAction } from "@/app/(student)/actions/planGroupActions";

type PlanPreview = {
  plan_date: string;
  block_index: number;
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  content_title: string | null;
  content_subject: string | null;
  content_subject_category: string | null;
  content_category: string | null;
  planned_start_page_or_time: number;
  planned_end_page_or_time: number;
  chapter: string | null;
  start_time: string | null;
  end_time: string | null;
  day_type: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •" | null;
  week: number | null;
  day: number | null;
  is_partial: boolean;
  is_continued: boolean;
  plan_number: number | null;
};

type PlanPreviewDialogProps = {
  groupId: string;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onPlansGenerated?: () => void;
  isRegenerateMode?: boolean; // ì´ë¯¸ í”Œëœì´ ìƒì„±ë˜ì–´ ìˆëŠ” ê²½ìš° true
};

const contentTypeLabels: Record<string, string> = {
  book: "êµì¬",
  lecture: "ê°•ì˜",
  custom: "ì»¤ìŠ¤í…€",
};

// ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

// ë¶„ì„ ì‹œê°„ ë¬¸ìì—´ë¡œ ë³€í™˜
function formatTime(minutes: number): string {
  if (minutes === 0) return "0ë¶„";
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (hours > 0 && mins > 0) {
    return `${hours}ì‹œê°„ ${mins}ë¶„`;
  } else if (hours > 0) {
    return `${hours}ì‹œê°„`;
  } else {
    return `${mins}ë¶„`;
  }
}

// í•™ìŠµ ë¶„ëŸ‰ í¬ë§·íŒ…
function formatLearningAmount(plan: PlanPreview): string {
  if (
    plan.planned_start_page_or_time === null ||
    plan.planned_end_page_or_time === null
  ) {
    return "-";
  }

  if (plan.content_type === "book") {
    return `${plan.planned_start_page_or_time}-${plan.planned_end_page_or_time}p`;
  } else if (plan.content_type === "lecture") {
    return `${plan.planned_start_page_or_time}ê°•`;
  }

  return `${plan.planned_start_page_or_time}-${plan.planned_end_page_or_time}`;
}

// íšŒì°¨ ê³„ì‚° ìµœì í™”: ëª¨ë“  í”Œëœì˜ íšŒì°¨ë¥¼ í•œ ë²ˆì— ê³„ì‚°
// ê°™ì€ plan_numberë¥¼ ê°€ì§„ í”Œëœë“¤ì€ ê°™ì€ íšŒì°¨ë¥¼ ê°€ì§
function calculateAllSequences(plans: PlanPreview[]): Map<string, number> {
  const sequenceMap = new Map<string, number>();
  
  // 1. content_idë³„ë¡œ ê·¸ë£¹í™”
  const plansByContent = new Map<string, PlanPreview[]>();
  plans.forEach((plan) => {
    if (!plansByContent.has(plan.content_id)) {
      plansByContent.set(plan.content_id, []);
    }
    plansByContent.get(plan.content_id)!.push(plan);
  });
  
  // 2. ê° content_idë³„ë¡œ íšŒì°¨ ê³„ì‚°
  plansByContent.forEach((contentPlans, contentId) => {
    // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
    const sorted = [...contentPlans].sort((a, b) => {
      if (a.plan_date !== b.plan_date) {
        return a.plan_date.localeCompare(b.plan_date);
      }
      return (a.block_index || 0) - (b.block_index || 0);
    });
    
    // plan_numberë³„ ê·¸ë£¹í™”
    const planNumberGroups = new Map<number | null, PlanPreview[]>();
    sorted.forEach(plan => {
      const key = plan.plan_number;
      if (!planNumberGroups.has(key)) {
        planNumberGroups.set(key, []);
      }
      planNumberGroups.get(key)!.push(plan);
    });
    
    // íšŒì°¨ ê³„ì‚° (plan_number ê·¸ë£¹ ë‹¨ìœ„)
    let sequence = 1;
    planNumberGroups.forEach((group, planNumber) => {
      // ê°™ì€ plan_numberë¥¼ ê°€ì§„ ê·¸ë£¹ì˜ ëª¨ë“  í”Œëœì— ê°™ì€ íšŒì°¨ í• ë‹¹
      group.forEach(plan => {
        const key = `${plan.plan_date}-${plan.block_index}-${plan.content_id}`;
        sequenceMap.set(key, sequence);
      });
      sequence++;
    });
  });
  
  return sequenceMap;
}

export function PlanPreviewDialog({
  groupId,
  open,
  onOpenChange,
  onPlansGenerated,
  isRegenerateMode = false,
}: PlanPreviewDialogProps) {
  const [plans, setPlans] = useState<PlanPreview[]>([]);
  const [loading, setLoading] = useState(false);
  const [isGenerating, startGenerateTransition] = useTransition();

  const handlePreview = async () => {
    setLoading(true);
    try {
      // ë¯¸ë¦¬ë³´ê¸°ëŠ” ì‹¤ì œ í”Œëœì„ ìƒì„±í•˜ì§€ ì•ŠìŒ (ë°ì´í„°ë§Œ ë°˜í™˜)
      const result = await previewPlansFromGroupAction(groupId);
      setPlans(result.plans);
      // ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” onPlansGeneratedë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ (ì‹¤ì œ ìƒì„±ì´ ì•„ë‹ˆë¯€ë¡œ)
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "í”Œëœ ë¯¸ë¦¬ë³´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    } finally {
      setLoading(false);
    }
  };

  const handleGenerate = () => {
    const message = isRegenerateMode
      ? "í”Œëœì„ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ í”Œëœì´ ì‚­ì œë˜ê³  ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤."
      : "í”Œëœì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ í”Œëœì´ ìˆë‹¤ë©´ ì‚­ì œë˜ê³  ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤.";
    
    if (!confirm(message)) {
      return;
    }

    startGenerateTransition(async () => {
      try {
        // ì‹¤ì œ í”Œëœ ìƒì„±
        const result = await generatePlansFromGroupAction(groupId);
        
        // í”Œëœì´ ì‹¤ì œë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        const checkResult = await checkPlansExistAction(groupId);
        if (!checkResult.hasPlans) {
          alert("í”Œëœ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í”Œëœì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          return;
        }
        
        alert(`${result.count}ê°œì˜ í”Œëœì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        // ì‹¤ì œ í”Œëœ ìƒì„±ì´ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ ì½œë°± í˜¸ì¶œ
        onPlansGenerated?.();
        onOpenChange(false);
      } catch (error) {
        alert(
          error instanceof Error
            ? error.message
            : "í”Œëœ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
        // ì—ëŸ¬ ë°œìƒ ì‹œ ì½œë°± í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
      }
    });
  };

  // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™” (useMemoë¡œ ìµœì í™”)
  const plansByDate = useMemo(() => {
    const map = new Map<string, PlanPreview[]>();
    plans.forEach((plan) => {
      if (!map.has(plan.plan_date)) {
        map.set(plan.plan_date, []);
      }
      map.get(plan.plan_date)!.push(plan);
    });
    return map;
  }, [plans]);

  // ë‚ ì§œë³„ë¡œ ì •ë ¬ (useMemoë¡œ ìµœì í™”)
  const sortedPlans = useMemo(() => {
    return [...plans].sort((a, b) => {
      if (a.plan_date !== b.plan_date) {
        return a.plan_date.localeCompare(b.plan_date);
      }
      // ê°™ì€ ë‚ ì§œë©´ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
      if (a.start_time && b.start_time) {
        return timeToMinutes(a.start_time) - timeToMinutes(b.start_time);
      }
      return a.block_index - b.block_index;
    });
  }, [plans]);

  const sortedDates = useMemo(() => {
    return Array.from(plansByDate.keys()).sort();
  }, [plansByDate]);

  // íšŒì°¨ ê³„ì‚° (useMemoë¡œ ìµœì í™”)
  const sequenceMap = useMemo(() => {
    return calculateAllSequences(sortedPlans);
  }, [sortedPlans]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="relative w-full max-w-6xl max-h-[90vh] overflow-hidden rounded-lg border border-gray-200 bg-white shadow-xl">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between border-b border-gray-200 bg-gray-50 px-6 py-4">
          <div className="flex flex-col gap-1">
            <h2 className="text-xl font-semibold text-gray-900">í”Œëœ ë¯¸ë¦¬ë³´ê¸°</h2>
            <p className="text-sm text-gray-800">
              ìƒì„±ë  í”Œëœ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”. ì´ {plans.length}ê°œì˜ í”Œëœì´ ìƒì„±ë©ë‹ˆë‹¤.
            </p>
          </div>
          <button
            type="button"
            onClick={() => onOpenChange(false)}
            className="rounded-lg p-1 text-gray-700 hover:bg-gray-100 hover:text-gray-900"
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* ì»¨í…ì¸  */}
        <div className="flex flex-col gap-4 p-6">
          {/* ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ */}
          <div className="flex items-center justify-between">
            <button
              type="button"
              onClick={handlePreview}
              disabled={loading}
              className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
            >
              {loading ? "ë¡œë”© ì¤‘..." : "ë¯¸ë¦¬ë³´ê¸°"}
            </button>
            {plans.length > 0 && (
              <button
                type="button"
                onClick={handleGenerate}
                disabled={isGenerating}
                className="inline-flex items-center justify-center rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-700 disabled:cursor-not-allowed disabled:bg-green-400"
              >
                {isGenerating ? "ìƒì„± ì¤‘..." : isRegenerateMode ? "ì¬ìƒì„±í•˜ê¸°" : "í”Œëœ ìƒì„±í•˜ê¸°"}
              </button>
            )}
          </div>

          {/* í”Œëœ í…Œì´ë¸” */}
          {plans.length > 0 && (
            <div className="overflow-auto max-h-[60vh] rounded-lg border border-blue-200">
              <table className="w-full text-xs border-collapse border border-blue-200">
                <thead className="sticky top-0 bg-blue-100">
                  <tr>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      í”Œëœë²ˆí˜¸
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ì£¼ì°¨
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ì¼ì°¨
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ë‚ ì§œ
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ë‚ ì§œ ìœ í˜•
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ìƒíƒœë±ƒì§€
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ì‹œì‘ì‹œê°„
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ì¢…ë£Œì‹œê°„
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      êµê³¼
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ê³¼ëª©
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ìœ í˜•
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ì´ë¦„
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      í•™ìŠµë‚´ì—­
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      íšŒì°¨
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      í•™ìŠµ ë¶„ëŸ‰
                    </th>
                    <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-900">
                      ì†Œìš”ì‹œê°„
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {sortedPlans.map((plan, index) => {
                    const duration = plan.start_time && plan.end_time
                      ? timeToMinutes(plan.end_time) - timeToMinutes(plan.start_time)
                      : 0;
                    const sequenceKey = `${plan.plan_date}-${plan.block_index}-${plan.content_id}`;
                    const sequence = sequenceMap.get(sequenceKey) || 1;
                    const dateObj = new Date(plan.plan_date);
                    const formattedDate = dateObj.toLocaleDateString("ko-KR", {
                      month: "short",
                      day: "numeric",
                      weekday: "short",
                    });

                    return (
                      <tr
                        key={`${plan.plan_date}-${plan.block_index}-${index}`}
                        className={`hover:bg-blue-50 ${
                          plan.is_continued ? "bg-blue-100" : ""
                        }`}
                      >
                        <td className="px-3 py-2 border border-blue-200 text-blue-700 text-center">
                          {plan.plan_number !== null ? plan.plan_number : "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700 text-center">
                          {plan.week !== null ? `${plan.week}ì£¼ì°¨` : "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700 text-center">
                          {plan.day !== null ? `${plan.day}ì¼ì°¨` : "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {formattedDate}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {plan.day_type || "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          <div className="flex items-center gap-1">
                            {plan.is_continued && (
                              <span className="text-blue-600 font-semibold text-[10px]">[ì´ì–´ì„œ]</span>
                            )}
                            {plan.is_partial && (
                              <span className="text-blue-600 text-[10px]">(ì¼ë¶€)</span>
                            )}
                            {!plan.is_continued && !plan.is_partial && (
                              <span className="text-gray-700">-</span>
                            )}
                          </div>
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {plan.start_time || "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {plan.end_time || "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {plan.content_subject_category || "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {plan.content_subject || "-"}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {contentTypeLabels[plan.content_type] || plan.content_type}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          <div className="max-w-[200px] truncate" title={plan.content_title || ""}>
                            {plan.content_title || "-"}
                          </div>
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          <div className="max-w-[200px] truncate" title={plan.chapter || ""}>
                            {plan.chapter || "-"}
                          </div>
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700 text-center">
                          {sequence}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {formatLearningAmount(plan)}
                        </td>
                        <td className="px-3 py-2 border border-blue-200 text-blue-700">
                          {duration > 0 ? formatTime(duration) : "-"}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}

          {plans.length === 0 && !loading && (
            <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
              <p className="text-sm text-gray-800">
                "í”Œëœ ë¯¸ë¦¬ë³´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒì„±ë  í”Œëœì„ í™•ì¸í•˜ì„¸ìš”.
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/_components/PlanScheduleView.tsx">
"use client";

import { useImperativeHandle, forwardRef } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { AlertCircle } from "lucide-react";
import { getScheduleResultDataAction } from "@/app/(student)/actions/planGroupActions";
import { ScheduleTableView } from "@/app/(student)/plan/new-group/_components/Step7ScheduleResult/ScheduleTableView";
import { LoadingSkeleton } from "@/components/ui/LoadingSkeleton";
import type {
  ContentData,
  BlockData,
} from "@/app/(student)/plan/new-group/_components/utils/scheduleTransform";

type PlanScheduleViewProps = {
  groupId: string;
};

export type PlanScheduleViewRef = {
  refresh: () => void;
};

export const PlanScheduleView = forwardRef<PlanScheduleViewRef, PlanScheduleViewProps>(
  ({ groupId }, ref) => {
  const queryClient = useQueryClient();

  // React Queryë¥¼ ì‚¬ìš©í•œ ë°ì´í„° í˜ì¹­
  const {
    data,
    isLoading,
    error,
    refetch,
  } = useQuery({
    queryKey: ["planSchedule", groupId],
    queryFn: async () => {
      const result = await getScheduleResultDataAction(groupId);

      if (result.plans.length === 0) {
        throw new Error("ìƒì„±ëœ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.");
      }

      // contents ë°°ì—´ì„ Mapìœ¼ë¡œ ë³€í™˜
      const contentsMap = new Map(
        result.contents.map((c) => [c.id, c])
      );

      return {
        dailySchedule: result.dailySchedule || [],
        plans: result.plans || [],
        contents: contentsMap,
        blocks: result.blocks || [],
      };
    },
    staleTime: 1000 * 60 * 5, // 5ë¶„ê°„ ìºì‹œ ìœ ì§€
    gcTime: 1000 * 60 * 10, // 10ë¶„ê°„ ë©”ëª¨ë¦¬ ìœ ì§€
    refetchOnWindowFocus: false, // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œ ìë™ ì¬ìš”ì²­ ë°©ì§€
    refetchOnMount: false, // ë§ˆìš´íŠ¸ ì‹œ ìë™ ì¬ìš”ì²­ ë°©ì§€ (ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©)
    refetchOnReconnect: false, // ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²° ì‹œ ìë™ ì¬ìš”ì²­ ë°©ì§€
  });

  // refë¥¼ í†µí•´ ì™¸ë¶€ì—ì„œ refresh í•¨ìˆ˜ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡
  useImperativeHandle(ref, () => ({
    refresh: () => {
      queryClient.invalidateQueries({ queryKey: ["planSchedule", groupId] });
    },
  }));

  if (isLoading) {
    return <LoadingSkeleton variant="schedule" />;
  }

  if (error) {
    const errorMessage = error instanceof Error ? error.message : "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    return (
      <div className="rounded-lg border border-red-200 bg-red-50 p-6">
        <div className="flex items-start gap-3">
          <AlertCircle className="h-5 w-5 flex-shrink-0 text-red-600" />
          <div className="flex flex-1 flex-col gap-1">
            <h3 className="text-sm font-semibold text-red-800">ì˜¤ë¥˜ ë°œìƒ</h3>
            <p className="text-sm text-red-700">{errorMessage}</p>
            <button
              onClick={() => refetch()}
              className="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
            >
              ë‹¤ì‹œ ì‹œë„
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (!data) {
    return null;
  }

  const { dailySchedule, plans, contents, blocks } = data;

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <p className="text-sm text-gray-800">
          ì´ {plans.length}ê°œì˜ í”Œëœì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
        </p>
      </div>
      <ScheduleTableView
        dailySchedule={dailySchedule}
        plans={plans}
        contents={contents}
        blocks={blocks}
      />
    </div>
  );
  }
);

PlanScheduleView.displayName = "PlanScheduleView";
</file>

<file path="group/[id]/_components/RescheduleHistory.tsx">
/**
 * ì¬ì¡°ì • íˆìŠ¤í† ë¦¬ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì • ì´ë ¥ì„ í‘œì‹œí•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect } from "react";
import { format } from "date-fns";
import { History, TrendingUp, AlertCircle, CheckCircle, XCircle, RotateCcw } from "lucide-react";
import { getRescheduleHistory } from "@/app/(student)/actions/plan-groups/rescheduleHistory";
import { analyzeReschedulePatterns, analyzeRescheduleEffects } from "@/lib/reschedule/patternAnalyzer";
import type { RescheduleHistoryResult } from "@/app/(student)/actions/plan-groups/rescheduleHistory";
import type { ReschedulePatternAnalysis, RescheduleEffectAnalysis } from "@/lib/reschedule/patternAnalyzer";

type RescheduleHistoryProps = {
  groupId: string;
};

export function RescheduleHistory({ groupId }: RescheduleHistoryProps) {
  const [loading, setLoading] = useState(true);
  const [history, setHistory] = useState<RescheduleHistoryResult | null>(null);
  const [patternAnalysis, setPatternAnalysis] = useState<ReschedulePatternAnalysis | null>(null);
  const [effectAnalysis, setEffectAnalysis] = useState<RescheduleEffectAnalysis | null>(null);

  useEffect(() => {
    loadHistory();
  }, [groupId]);

  const loadHistory = async () => {
    setLoading(true);
    try {
      const result = await getRescheduleHistory(groupId);
      setHistory(result);

      // íŒ¨í„´ ë¶„ì„
      const patterns = analyzeReschedulePatterns(result.logs);
      setPatternAnalysis(patterns);

      // íš¨ê³¼ ë¶„ì„
      const effects = analyzeRescheduleEffects(result.logs);
      setEffectAnalysis(effects);
    } catch (error) {
      console.error("ì¬ì¡°ì • íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="flex flex-col gap-4 text-center">
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"></div>
          <p className="text-sm text-gray-600">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  if (!history || history.logs.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-6 text-center">
        <div className="mx-auto flex flex-col gap-4">
          <History className="mx-auto h-12 w-12 text-gray-400" />
          <p className="text-sm text-gray-600">ì¬ì¡°ì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "completed":
        return <CheckCircle className="h-4 w-4 text-green-600" />;
      case "failed":
        return <XCircle className="h-4 w-4 text-red-600" />;
      case "rolled_back":
        return <RotateCcw className="h-4 w-4 text-orange-600" />;
      default:
        return <AlertCircle className="h-4 w-4 text-yellow-600" />;
    }
  };

  const getStatusLabel = (status: string) => {
    switch (status) {
      case "completed":
        return "ì™„ë£Œ";
      case "failed":
        return "ì‹¤íŒ¨";
      case "rolled_back":
        return "ë¡¤ë°±ë¨";
      default:
        return "ëŒ€ê¸° ì¤‘";
    }
  };

  return (
    <div className="flex flex-col gap-6">
      {/* í†µê³„ ì¹´ë“œ */}
      <div className="grid grid-cols-1 gap-4 md:grid-cols-4">
        <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-xs text-gray-600">ì´ ì¬ì¡°ì •</p>
          <p className="text-2xl font-bold text-gray-900">
            {history.statistics.totalReschedules}
          </p>
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-green-200 bg-green-50 p-4">
          <p className="text-xs text-green-700">ì„±ê³µ</p>
          <p className="text-2xl font-bold text-green-600">
            {history.statistics.successfulReschedules}
          </p>
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-xs text-red-700">ì‹¤íŒ¨</p>
          <p className="text-2xl font-bold text-red-600">
            {history.statistics.failedReschedules}
          </p>
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-orange-200 bg-orange-50 p-4">
          <p className="text-xs text-orange-700">ë¡¤ë°±</p>
          <p className="text-2xl font-bold text-orange-600">
            {history.statistics.rolledBackReschedules}
          </p>
        </div>
      </div>

      {/* íš¨ê³¼ ë¶„ì„ */}
      {effectAnalysis && (
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
          <h3 className="flex items-center gap-2 font-semibold text-gray-900">
            <TrendingUp className="h-5 w-5" />
            ì¬ì¡°ì • íš¨ê³¼ ë¶„ì„
          </h3>
          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div className="flex flex-col gap-1">
              <p className="text-xs text-gray-600">ì„±ê³µë¥ </p>
              <p className="text-2xl font-bold text-gray-900">
                {effectAnalysis.successRate}%
              </p>
            </div>
            <div className="flex flex-col gap-1">
              <p className="text-xs text-gray-600">ë¡¤ë°±ë¥ </p>
              <p className="text-2xl font-bold text-gray-900">
                {effectAnalysis.rollbackRate}%
              </p>
            </div>
            <div className="flex flex-col gap-1">
              <p className="text-xs text-gray-600">í‰ê·  ê°„ê²©</p>
              <p className="text-2xl font-bold text-gray-900">
                {effectAnalysis.averageIntervalDays}ì¼
              </p>
            </div>
          </div>
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-3">
            <p className="text-sm text-gray-700">
              {effectAnalysis.effectivenessDescription}
            </p>
          </div>
        </div>
      )}

      {/* íŒ¨í„´ ë¶„ì„ */}
      {patternAnalysis && patternAnalysis.suggestions.length > 0 && (
        <div className="flex flex-col gap-4 rounded-lg border border-blue-200 bg-blue-50 p-6">
          <h3 className="font-semibold text-blue-900">ê°œì„  ì œì•ˆ</h3>
          <div className="flex flex-col gap-3">
            {patternAnalysis.suggestions.map((suggestion, index) => (
              <div
                key={index}
                className="rounded-lg border border-blue-300 bg-white p-4"
              >
                <div className="flex items-start justify-between">
                  <div className="flex flex-1 flex-col gap-1">
                    <h4 className="font-medium text-gray-900">
                      {suggestion.title}
                    </h4>
                    <p className="text-sm text-gray-600">
                      {suggestion.description}
                    </p>
                    <p className="text-xs text-gray-500">
                      {suggestion.reason}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ì´ë ¥ ëª©ë¡ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <h3 className="font-semibold text-gray-900">ì¬ì¡°ì • ì´ë ¥</h3>
        <div className="flex flex-col gap-3">
          {history.logs.map((log) => (
            <div
              key={log.id}
              className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-4"
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    {getStatusIcon(log.status)}
                    <span className="font-medium text-gray-900">
                      {getStatusLabel(log.status)}
                    </span>
                    <span className="text-xs text-gray-500">
                      {format(new Date(log.created_at), "yyyyë…„ Mì›” dì¼ HH:mm")}
                    </span>
                  </div>
                  <div className="grid grid-cols-2 gap-2 text-sm text-gray-600 md:grid-cols-4">
                    <div>
                      <span className="text-xs">ê¸°ì¡´ í”Œëœ:</span>{" "}
                      <span className="font-medium">{log.plans_before_count}ê°œ</span>
                    </div>
                    <div>
                      <span className="text-xs">ë³€ê²½ í›„:</span>{" "}
                      <span className="font-medium text-blue-600">
                        {log.plans_after_count}ê°œ
                      </span>
                    </div>
                    <div>
                      <span className="text-xs">ë³€í™”:</span>{" "}
                      <span
                        className={`font-medium ${
                          log.plans_after_count - log.plans_before_count >= 0
                            ? "text-green-600"
                            : "text-red-600"
                        }`}
                      >
                        {log.plans_after_count - log.plans_before_count >= 0
                          ? "+"
                          : ""}
                        {log.plans_after_count - log.plans_before_count}ê°œ
                      </span>
                    </div>
                    {log.affected_dates && log.affected_dates.length > 0 && (
                      <div>
                        <span className="text-xs">ì˜í–¥ ë‚ ì§œ:</span>{" "}
                        <span className="font-medium">
                          {log.affected_dates.length}ì¼
                        </span>
                      </div>
                    )}
                  </div>
                  {log.error_message && (
                    <div className="rounded-lg border border-red-200 bg-red-50 p-2">
                      <p className="text-xs text-red-800">{log.error_message}</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/_components/ScheduleLoadingSkeleton.tsx">
"use client";

export function ScheduleLoadingSkeleton() {
  return (
    <div className="flex flex-col gap-4">
      <div className="h-6 w-48 animate-pulse rounded bg-gray-200" />
      <div className="flex flex-col rounded-lg border border-gray-200 bg-white">
        <div className="border-b border-gray-200 bg-gray-50 px-4 py-3">
          <div className="h-5 w-32 animate-pulse rounded bg-gray-200" />
        </div>
        <div className="flex max-h-[600px] flex-col gap-2 overflow-y-auto p-4">
          {[1, 2, 3, 4, 5].map((i) => (
            <div key={i} className="flex flex-col gap-2 border-b border-gray-100 pb-4 last:border-b-0">
              <div className="h-12 w-full animate-pulse rounded bg-gray-100" />
              <div className="flex flex-col gap-2 pl-4">
                <div className="h-16 w-full animate-pulse rounded bg-gray-50" />
                <div className="h-16 w-full animate-pulse rounded bg-gray-50" />
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/_components/TabLoadingSkeleton.tsx">
"use client";

export function TabLoadingSkeleton() {
  return (
    <div className="space-y-4">
      <div className="h-8 w-48 animate-pulse rounded bg-gray-200" />
      <div className="space-y-3">
        <div className="h-32 w-full animate-pulse rounded-lg bg-gray-200" />
        <div className="h-64 w-full animate-pulse rounded-lg bg-gray-200" />
        <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div className="h-24 w-full animate-pulse rounded-lg bg-gray-200" />
          <div className="h-24 w-full animate-pulse rounded-lg bg-gray-200" />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/edit/page.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { redirect, notFound } from "next/navigation";
import { PlanGroupWizard } from "@/app/(student)/plan/new-group/_components/PlanGroupWizard";
import { getPlanGroupWithDetails } from "@/lib/data/planGroups";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { fetchAllStudentContents } from "@/lib/data/planContents";
import { ScrollToTop } from "@/components/ScrollToTop";
import { getContainerClass } from "@/lib/constants/layout";

type EditPlanGroupPageProps = {
  params: Promise<{ id: string }>;
};

export default async function EditPlanGroupPage({ params }: EditPlanGroupPageProps) {
  const { id } = await params;

  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  // í”Œëœ ê·¸ë£¹ ë° ê´€ë ¨ ë°ì´í„° ì¡°íšŒ
  const { group, contents, exclusions, academySchedules } = await getPlanGroupWithDetails(
    id,
    user.id
  );

  if (!group) {
    notFound();
  }

  // ìˆ˜ì • ê¶Œí•œ í™•ì¸
  if (!PlanStatusManager.canEdit(group.status as any)) {
    redirect(`/plan/group/${id}`);
  }

  // ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ì¡°íšŒ (í†µí•© í•¨ìˆ˜ ì‚¬ìš©)
  const { fetchBlockSetsWithBlocks } = await import("@/lib/data/blockSets");
  const blockSets = await fetchBlockSetsWithBlocks(user.id);

  // ì½˜í…ì¸  ëª©ë¡ ì¡°íšŒ (í†µí•© í•¨ìˆ˜ ì‚¬ìš©)
  const { books, lectures, custom } = await fetchAllStudentContents(user.id);

  // ë°ì´í„° ë³€í™˜ í•¨ìˆ˜ ì‚¬ìš©
  const { transformPlanGroupToWizardData } = await import("@/lib/utils/planGroupTransform");
  const initialData = await transformPlanGroupToWizardData(
    group,
    contents,
    exclusions,
    academySchedules,
    user.id
  );

  return (
    <>
      <ScrollToTop />
      <section className={`${getContainerClass("LIST", "lg")} flex flex-col gap-8`}>
        <div>
          <div className="flex flex-col gap-2">
            <p className="text-sm font-medium text-gray-800">í•™ìŠµ í”Œëœ</p>
            <h1 className="text-h1 text-gray-900">
              í”Œëœ ê·¸ë£¹ ìˆ˜ì •
            </h1>
            <p className="text-sm text-gray-800">
              í”Œëœ ê·¸ë£¹ì˜ ì„¤ì •ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
        </div>

      <PlanGroupWizard
        initialBlockSets={blockSets || []}
        initialContents={{
          books,
          lectures,
          custom,
        }}
        initialData={initialData as any}
        isEditMode={true}
      />
    </section>
    </>
  );
}
</file>

<file path="group/[id]/reschedule/_components/AdjustmentStep.tsx">
/**
 * Step 2: ìƒì„¸ ì¡°ì • ì»´í¬ë„ŒíŠ¸
 * 
 * ì„ íƒëœ ì½˜í…ì¸ ì˜ ë²”ìœ„ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì½˜í…ì¸ ë¥¼ êµì²´í•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useMemo, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { ChevronDown, ChevronUp } from "lucide-react";
import type { PlanContent } from "@/lib/types/plan";
import type { AdjustmentInput } from "@/lib/reschedule/scheduleEngine";
import { BatchAdjustmentPanel } from "./BatchAdjustmentPanel";
import { ContentReplaceModal } from "./ContentReplaceModal";
import { DateRangeSelector } from "./DateRangeSelector";
import { getTodayDateString } from "@/lib/reschedule/periodCalculator";

type DateRange = {
  from: string | null; // YYYY-MM-DD
  to: string | null; // YYYY-MM-DD
};

type AdjustmentStepProps = {
  contents: PlanContent[];
  selectedContentIds: Set<string>;
  adjustments: AdjustmentInput[];
  onComplete: (adjustments: AdjustmentInput[], placementDateRange: DateRange | null) => void;
  onBack: () => void;
  studentId: string;
  groupPeriodEnd: string; // YYYY-MM-DD
  existingPlans?: Array<{
    id: string;
    plan_date: string; // YYYY-MM-DD
    status: string | null;
    is_active: boolean | null;
  }>;
};

export function AdjustmentStep({
  contents,
  selectedContentIds,
  adjustments: initialAdjustments,
  onComplete,
  onBack,
  studentId,
  groupPeriodEnd,
  existingPlans = [],
}: AdjustmentStepProps) {
  const toast = useToast();
  const today = getTodayDateString();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];
  
  const [localAdjustments, setLocalAdjustments] = useState<
    Map<string, AdjustmentInput>
  >(() => {
    const map = new Map();
    initialAdjustments.forEach((adj) => {
      map.set(adj.plan_content_id, adj);
    });
    return map;
  });
  const [batchMode, setBatchMode] = useState(false);
  const [replaceModalOpen, setReplaceModalOpen] = useState(false);
  const [replacingContentId, setReplacingContentId] = useState<string | null>(null);
  const [replaceRange, setReplaceRange] = useState<{ start: number; end: number } | null>(null);
  const [validationErrors, setValidationErrors] = useState<
    Map<string, string>
  >(new Map());
  const [rangeInputs, setRangeInputs] = useState<
    Map<string, { start: string; end: string }>
  >(new Map());
  
  // ë°°ì¹˜ ë²”ìœ„ ì„ íƒ ê´€ë ¨ state
  const [placementMode, setPlacementMode] = useState<"auto" | "manual">("auto");
  const [placementDateRange, setPlacementDateRange] = useState<DateRange>({
    from: tomorrowStr,
    to: groupPeriodEnd,
  });
  const [placementRangeExpanded, setPlacementRangeExpanded] = useState(false);

  const selectedContents = useMemo(() => {
    return contents.filter(
      (c) => selectedContentIds.has(c.id || c.content_id)
    );
  }, [contents, selectedContentIds]);

  // ë¬¸ìì—´ ìƒíƒœ ì´ˆê¸°í™”
  useEffect(() => {
    const newMap = new Map();
    selectedContents.forEach((content) => {
      const contentId = content.id || content.content_id;
      const adjustment = localAdjustments.get(contentId);
      const currentRange = adjustment?.after.range || {
        start: content.start_range,
        end: content.end_range,
      };
      newMap.set(contentId, {
        start: String(currentRange.start),
        end: String(currentRange.end),
      });
    });
    setRangeInputs(newMap);
  }, [selectedContents, localAdjustments]);

  const handleRangeChange = (
    contentId: string,
    field: "start" | "end",
    value: number
  ) => {
    const content = contents.find((c) => (c.id || c.content_id) === contentId);
    if (!content) return;

    const existing = localAdjustments.get(contentId);
    const before: AdjustmentInput["before"] = existing?.before || {
      content_id: content.content_id,
      content_type: content.content_type,
      range: {
        start: content.start_range,
        end: content.end_range,
      },
    };

    const afterRange = existing?.after.range || { ...before.range };
    const newValue = Math.max(0, value); // ìŒìˆ˜ ë°©ì§€
    afterRange[field] = newValue;

    // ê²€ì¦: ì‹œì‘ <= ë
    if (field === "start" && newValue > afterRange.end) {
      const errorMsg = "ì‹œì‘ ë²”ìœ„ëŠ” ë ë²”ìœ„ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.";
      setValidationErrors(new Map(validationErrors.set(contentId, errorMsg)));
      toast.showError(errorMsg);
      return;
    }
    if (field === "end" && newValue < afterRange.start) {
      const errorMsg = "ë ë²”ìœ„ëŠ” ì‹œì‘ ë²”ìœ„ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.";
      setValidationErrors(new Map(validationErrors.set(contentId, errorMsg)));
      toast.showError(errorMsg);
      return;
    }

    // ê²€ì¦ í†µê³¼ ì‹œ ì—ëŸ¬ ì œê±°
    const newErrors = new Map(validationErrors);
    newErrors.delete(contentId);
    setValidationErrors(newErrors);

    const adjustment: AdjustmentInput = {
      plan_content_id: contentId,
      change_type: "range",
      before,
      after: {
        ...before,
        range: afterRange,
      },
    };

    setLocalAdjustments(new Map(localAdjustments.set(contentId, adjustment)));
  };

  // ë²”ìœ„ ì…ë ¥ í•¸ë“¤ëŸ¬ (ë¬¸ìì—´ ì²˜ë¦¬)
  const handleRangeInputChange = (
    contentId: string,
    field: "start" | "end",
    value: string
  ) => {
    const newMap = new Map(rangeInputs);
    const current = newMap.get(contentId) || { start: "", end: "" };
    newMap.set(contentId, { ...current, [field]: value });
    setRangeInputs(newMap);
  };

  // ë²”ìœ„ blur í•¸ë“¤ëŸ¬ (ìˆ«ì ë³€í™˜ ë° ê²€ì¦)
  const handleRangeBlur = (
    contentId: string,
    field: "start" | "end"
  ) => {
    const inputValue = rangeInputs.get(contentId)?.[field] ?? "";
    const trimmedValue = inputValue.trim();

    if (trimmedValue === "") {
      // ë¹ˆ ê°’ì´ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
      const content = contents.find((c) => (c.id || c.content_id) === contentId);
      if (content) {
        const adjustment = localAdjustments.get(contentId);
        const defaultValue = adjustment?.after.range?.[field] ??
          (field === "start" ? content.start_range : content.end_range);

        const newMap = new Map(rangeInputs);
        const current = newMap.get(contentId) || { start: "", end: "" };
        newMap.set(contentId, { ...current, [field]: String(defaultValue) });
        setRangeInputs(newMap);

        handleRangeChange(contentId, field, defaultValue);
      }
      return;
    }

    const numValue = parseInt(trimmedValue, 10);
    if (!isNaN(numValue) && numValue >= 0) {
      handleRangeChange(contentId, field, numValue);
    }
  };

  // êµì²´ëœ ì½˜í…ì¸  ë²”ìœ„ ì…ë ¥ í•¸ë“¤ëŸ¬
  const handleReplacedRangeInputChange = (
    contentId: string,
    field: "start" | "end",
    value: string
  ) => {
    // ë¬¸ìì—´ ìƒíƒœ ì—…ë°ì´íŠ¸
    const newMap = new Map(rangeInputs);
    const current = newMap.get(contentId) || { start: "", end: "" };
    newMap.set(contentId, { ...current, [field]: value });
    setRangeInputs(newMap);

    // ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë²”ìœ„ ì—…ë°ì´íŠ¸ (ë¹ˆ ê°’ì´ ì•„ë‹ ë•Œë§Œ)
    if (value.trim() !== "") {
      const numValue = parseInt(value, 10);
      if (!isNaN(numValue) && numValue >= 0) {
        const content = contents.find((c) => (c.id || c.content_id) === contentId);
        const existing = localAdjustments.get(contentId);
        const currentRange = existing?.after.range || (content ? {
          start: content.start_range,
          end: content.end_range,
        } : { start: 0, end: 0 });
        const newRange = {
          ...currentRange,
          [field]: numValue,
        };

        // replaceRange ë° localAdjustments ì—…ë°ì´íŠ¸
        if (replacingContentId === contentId) {
          setReplaceRange(newRange);
        }
        if (existing && existing.change_type === "replace") {
          const updated: AdjustmentInput = {
            ...existing,
            after: {
              ...existing.after,
              range: newRange,
            },
          };
          setLocalAdjustments(
            new Map(localAdjustments.set(contentId, updated))
          );
        }
      }
    }
  };

  // êµì²´ëœ ì½˜í…ì¸  ë²”ìœ„ blur í•¸ë“¤ëŸ¬
  const handleReplacedRangeBlur = (
    contentId: string,
    field: "start" | "end"
  ) => {
    const inputValue = rangeInputs.get(contentId)?.[field] ?? "";
    const trimmedValue = inputValue.trim();

    if (trimmedValue === "") {
      // ë¹ˆ ê°’ì´ë©´ í˜„ì¬ ë²”ìœ„ ê°’ìœ¼ë¡œ ë³µì›
      const existing = localAdjustments.get(contentId);
      if (existing && existing.change_type === "replace") {
        const currentRange = existing.after.range;
        const defaultValue = currentRange[field];

        const newMap = new Map(rangeInputs);
        const current = newMap.get(contentId) || { start: "", end: "" };
        newMap.set(contentId, { ...current, [field]: String(defaultValue) });
        setRangeInputs(newMap);
      }
    }
  };

  const handleReplaceClick = (contentId: string) => {
    setReplacingContentId(contentId);
    const content = contents.find((c) => (c.id || c.content_id) === contentId);
    if (content) {
      // ê¸°ì¡´ ë²”ìœ„ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      const adjustment = localAdjustments.get(contentId);
      const currentRange = adjustment?.after.range || {
        start: content.start_range,
        end: content.end_range,
      };
      setReplaceRange(currentRange);
      // rangeInputsë„ í•¨ê»˜ ì´ˆê¸°í™”
      const newMap = new Map(rangeInputs);
      newMap.set(contentId, {
        start: String(currentRange.start),
        end: String(currentRange.end),
      });
      setRangeInputs(newMap);
    }
    setReplaceModalOpen(true);
  };

  const [replacedContentInfo, setReplacedContentInfo] = useState<
    Map<string, { title: string; total_page_or_time: number | null }>
  >(new Map());

  const handleReplace = (
    contentId: string,
    newContent: {
      content_id: string;
      content_type: "book" | "lecture" | "custom";
      title: string;
      total_page_or_time: number | null;
      range: { start: number; end: number };
    }
  ) => {
    const range = newContent.range;
    const content = contents.find((c) => (c.id || c.content_id) === contentId);
    if (!content) return;

    // ë²”ìœ„ ê²€ì¦
    if (newContent.total_page_or_time !== null) {
      if (range.start < 1 || range.end > newContent.total_page_or_time || range.start > range.end) {
        alert(
          `ë²”ìœ„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (1 ~ ${newContent.total_page_or_time} ì‚¬ì´, ì‹œì‘ <= ë)`
        );
        return;
      }
    }

    const existing = localAdjustments.get(contentId);
    const before: AdjustmentInput["before"] = existing?.before || {
      content_id: content.content_id,
      content_type: content.content_type,
      range: {
        start: content.start_range,
        end: content.end_range,
      },
    };

    const adjustment: AdjustmentInput = {
      plan_content_id: contentId,
      change_type: "replace",
      before,
      after: {
        content_id: newContent.content_id,
        content_type: newContent.content_type,
        range,
      },
    };

    setLocalAdjustments(new Map(localAdjustments.set(contentId, adjustment)));
    setReplacedContentInfo(
      new Map(
        replacedContentInfo.set(contentId, {
          title: newContent.title,
          total_page_or_time: newContent.total_page_or_time,
        })
      )
    );
    // rangeInputsë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
    const newMap = new Map(rangeInputs);
    newMap.set(contentId, {
      start: String(range.start),
      end: String(range.end),
    });
    setRangeInputs(newMap);
    setReplaceModalOpen(false);
    setReplacingContentId(null);
    setReplaceRange(null);
  };

  const handleReplaceCancel = () => {
    setReplaceModalOpen(false);
    setReplacingContentId(null);
    setReplaceRange(null);
  };

  const handleNext = () => {
    const adjustmentsArray = Array.from(localAdjustments.values());
    
    // ë°°ì¹˜ ë²”ìœ„ ê²°ì •
    let finalPlacementRange: DateRange | null = null;
    if (placementMode === "auto") {
      // ìë™ ëª¨ë“œ: ì˜¤ëŠ˜ ì´í›„ ~ í”Œëœ ê·¸ë£¹ ì¢…ë£Œì¼
      finalPlacementRange = {
        from: tomorrowStr,
        to: groupPeriodEnd,
      };
    } else {
      // ìˆ˜ë™ ëª¨ë“œ: ì‚¬ìš©ìê°€ ì„ íƒí•œ ë²”ìœ„
      if (placementDateRange.from && placementDateRange.to) {
        finalPlacementRange = placementDateRange;
      } else {
        alert("ë°°ì¹˜ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
    }
    
    onComplete(adjustmentsArray, finalPlacementRange);
  };

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-bold text-gray-900">ìƒì„¸ ì¡°ì •</h2>
        <p className="text-sm text-gray-600">
          ì„ íƒí•œ ì½˜í…ì¸ ì˜ ë²”ìœ„ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì½˜í…ì¸ ë¥¼ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      </div>

      {/* ì¼ê´„ ì¡°ì • ëª¨ë“œ ì•ˆë‚´ ë°°ë„ˆ */}
      {selectedContents.length > 1 && !batchMode && (
        <div className="flex flex-col gap-2 rounded-lg border border-blue-200 bg-blue-50 p-4">
          <div className="flex items-start gap-3">
            <div className="flex flex-1 flex-col gap-1">
              <div className="flex items-center gap-2">
                <span className="text-lg">ğŸ’¡</span>
                <h3 className="font-medium text-blue-900">
                  ì¼ê´„ ì¡°ì • ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                </h3>
              </div>
              <p className="text-sm text-blue-700">
                {selectedContents.length}ê°œì˜ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì¼ê´„ ì¡°ì • ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë©´
                ëª¨ë“  ì½˜í…ì¸ ë¥¼ í•œ ë²ˆì— ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
              <div className="text-xs text-blue-600">
                ì˜ˆì‹œ: ëª¨ë“  ì½˜í…ì¸ ì˜ ë²”ìœ„ë¥¼ 10% ì¦ê°€ì‹œí‚¤ê±°ë‚˜, ëª¨ë“  ì½˜í…ì¸ ì— +5í˜ì´ì§€ ì¶”ê°€
              </div>
            </div>
            <button
              onClick={() => setBatchMode(true)}
              className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700"
            >
              ì¼ê´„ ì¡°ì • ì‹œì‘
            </button>
          </div>
        </div>
      )}

      {/* ì¼ê´„ ì¡°ì • ëª¨ë“œ í† ê¸€ */}
      {selectedContents.length > 1 && (
        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex flex-col gap-1">
            <h3 className="font-medium text-gray-900">ì¼ê´„ ì¡°ì • ëª¨ë“œ</h3>
            <p className="text-xs text-gray-600">
              ì—¬ëŸ¬ ì½˜í…ì¸ ë¥¼ í•œ ë²ˆì— ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
          <label className="flex cursor-pointer items-center gap-2">
            <input
              type="checkbox"
              checked={batchMode}
              onChange={(e) => setBatchMode(e.target.checked)}
              className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <span className="text-sm font-medium text-gray-700">ì¼ê´„ ì¡°ì • í™œì„±í™”</span>
          </label>
        </div>
      )}

      {/* ì¼ê´„ ì¡°ì • íŒ¨ë„ */}
      {batchMode && selectedContents.length > 1 && (
        <BatchAdjustmentPanel
          contents={selectedContents}
          selectedContentIds={selectedContentIds}
          onApply={(adjustments) => {
            const newMap = new Map(localAdjustments);
            adjustments.forEach((adj) => {
              newMap.set(adj.plan_content_id, adj);
            });
            setLocalAdjustments(newMap);
            setBatchMode(false);
          }}
          onCancel={() => setBatchMode(false)}
        />
      )}

      <div className="flex flex-col gap-4">
        {selectedContents.map((content) => {
          const contentId = content.id || content.content_id;
          const adjustment = localAdjustments.get(contentId);
          const isReplaced = adjustment?.change_type === "replace";
          const currentRange = adjustment?.after.range || {
            start: content.start_range,
            end: content.end_range,
          };

          // êµì²´ëœ ì½˜í…ì¸  ì •ë³´
          const replacedContent = isReplaced
            ? {
                content_id: adjustment.after.content_id,
                content_type: adjustment.after.content_type,
                info: replacedContentInfo.get(contentId),
              }
            : null;

          return (
            <div
              key={contentId}
              className={`rounded-lg border p-4 ${
                isReplaced
                  ? "border-blue-300 bg-blue-50"
                  : "border-gray-200 bg-white"
              }`}
            >
              <div className="flex flex-col gap-3">
                <div className="flex items-center gap-2">
                  <h3 className="font-medium text-gray-900">
                    {content.content_type === "book"
                      ? "ğŸ“š êµì¬"
                      : content.content_type === "lecture"
                      ? "ğŸ¥ ê°•ì˜"
                      : "ğŸ“ ì»¤ìŠ¤í…€"}
                  </h3>
                  {isReplaced && (
                    <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700">
                      êµì²´ë¨
                    </span>
                  )}
                </div>
                {isReplaced && replacedContent ? (
                  <div className="flex flex-col gap-2 text-sm">
                    <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-gray-50 p-2">
                      <div className="text-xs text-gray-500">êµì²´ ì „</div>
                      <div className="text-gray-700">
                        {content.content_type === "book"
                          ? "ğŸ“š êµì¬"
                          : content.content_type === "lecture"
                          ? "ğŸ¥ ê°•ì˜"
                          : "ğŸ“ ì»¤ìŠ¤í…€"}{" "}
                        {content.start_range} ~ {content.end_range}
                      </div>
                    </div>
                    <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-2">
                      <div className="text-xs text-blue-700">êµì²´ í›„</div>
                      <div className="font-medium text-blue-900">
                        {replacedContent.content_type === "book"
                          ? "ğŸ“š êµì¬"
                          : replacedContent.content_type === "lecture"
                          ? "ğŸ¥ ê°•ì˜"
                          : "ğŸ“ ì»¤ìŠ¤í…€"}
                        {replacedContent.info?.title && (
                          <span className="pl-2">{replacedContent.info.title}</span>
                        )}
                      </div>
                      <div className="text-blue-700">
                        ë²”ìœ„: {currentRange.start} ~ {currentRange.end}
                        {replacedContent.info?.total_page_or_time !== null && replacedContent.info?.total_page_or_time !== undefined && (
                          <span className="pl-2 text-xs text-blue-600">
                            (ì´{" "}
                            {replacedContent.content_type === "book"
                              ? `${replacedContent.info.total_page_or_time}í˜ì´ì§€`
                              : replacedContent.content_type === "lecture"
                              ? `${replacedContent.info.total_page_or_time}ë¶„`
                              : `${replacedContent.info.total_page_or_time}`}
                            )
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                ) : (
                  <p className="text-sm text-gray-600">
                    {content.start_range} ~ {content.end_range}
                  </p>
                )}
              </div>

              <div className="flex flex-col gap-3">
                {!isReplaced && (
                  <>
                    <div className="flex flex-col gap-2">
                      <div className="flex items-center gap-4">
                        <label className="text-sm font-medium text-gray-700">
                          ì‹œì‘ ë²”ìœ„:
                        </label>
                      <input
                        type="number"
                        value={rangeInputs.get(contentId)?.start ?? String(currentRange.start)}
                        onChange={(e) =>
                          handleRangeInputChange(contentId, "start", e.target.value)
                        }
                        onBlur={() => handleRangeBlur(contentId, "start")}
                        className={`rounded-lg border px-3 py-1.5 text-sm focus:outline-none focus:ring-1 ${
                          validationErrors.has(contentId)
                            ? "border-red-500 focus:border-red-500 focus:ring-red-500"
                            : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                        }`}
                        min={1}
                        aria-label="ì‹œì‘ ë²”ìœ„ ì…ë ¥"
                        aria-invalid={validationErrors.has(contentId)}
                        aria-describedby={validationErrors.has(contentId) ? `error-${contentId}` : undefined}
                      />
                        <span className="text-xs text-gray-500">
                          {content.content_type === "book"
                            ? "í˜ì´ì§€"
                            : content.content_type === "lecture"
                            ? "íšŒì°¨"
                            : ""}
                        </span>
                      </div>

                      <div className="flex items-center gap-4">
                        <label className="text-sm font-medium text-gray-700">
                          ë ë²”ìœ„:
                        </label>
                      <input
                        type="number"
                        value={rangeInputs.get(contentId)?.end ?? String(currentRange.end)}
                        onChange={(e) =>
                          handleRangeInputChange(contentId, "end", e.target.value)
                        }
                        onBlur={() => handleRangeBlur(contentId, "end")}
                        className={`rounded-lg border px-3 py-1.5 text-sm focus:outline-none focus:ring-1 ${
                          validationErrors.has(contentId)
                            ? "border-red-500 focus:border-red-500 focus:ring-red-500"
                            : "border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                        }`}
                        min={currentRange.start}
                        aria-label="ë ë²”ìœ„ ì…ë ¥"
                        aria-invalid={validationErrors.has(contentId)}
                        aria-describedby={validationErrors.has(contentId) ? `error-${contentId}` : undefined}
                      />
                        <span className="text-xs text-gray-500">
                          {content.content_type === "book"
                            ? "í˜ì´ì§€"
                            : content.content_type === "lecture"
                            ? "íšŒì°¨"
                            : ""}
                        </span>
                      </div>

                      {/* ë²”ìœ„ ë¯¸ë¦¬ë³´ê¸° */}
                      <div className="rounded-lg border border-gray-200 bg-gray-50 p-2 text-xs text-gray-600">
                        ë²”ìœ„: {currentRange.start} ~ {currentRange.end} (
                        {currentRange.end - currentRange.start + 1}
                        {content.content_type === "book"
                          ? "í˜ì´ì§€"
                          : content.content_type === "lecture"
                          ? "íšŒì°¨"
                          : ""}
                        )
                      </div>

                      {/* ê²€ì¦ ì˜¤ë¥˜ ë©”ì‹œì§€ */}
                      {validationErrors.has(contentId) && (
                        <div 
                          id={`error-${contentId}`}
                          className="rounded-lg border border-red-200 bg-red-50 p-2 text-xs text-red-700"
                          role="alert"
                          aria-live="polite"
                        >
                          âš ï¸ {validationErrors.get(contentId)}
                        </div>
                      )}
                    </div>
                  </>
                )}

                {isReplaced && (
                  <div className="flex items-center gap-4">
                    <label className="text-sm font-medium text-gray-700">
                      ì‹œì‘ ë²”ìœ„:
                    </label>
                    <input
                      type="number"
                      value={rangeInputs.get(contentId)?.start ?? String(currentRange.start)}
                      onChange={(e) =>
                        handleReplacedRangeInputChange(contentId, "start", e.target.value)
                      }
                      onBlur={() => handleReplacedRangeBlur(contentId, "start")}
                      className="rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                      min={1}
                    />
                  </div>
                )}

                {isReplaced && (
                  <div className="flex items-center gap-4">
                    <label className="text-sm font-medium text-gray-700">
                      ë ë²”ìœ„:
                    </label>
                    <input
                      type="number"
                      value={rangeInputs.get(contentId)?.end ?? String(currentRange.end)}
                      onChange={(e) =>
                        handleReplacedRangeInputChange(contentId, "end", e.target.value)
                      }
                      onBlur={() => handleReplacedRangeBlur(contentId, "end")}
                      className="rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                      min={currentRange.start}
                    />
                  </div>
                )}

                <div className="flex items-center gap-3">
                  <button
                    onClick={() => handleReplaceClick(contentId)}
                    className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
                  >
                    {isReplaced ? "ë‹¤ì‹œ êµì²´" : "ì½˜í…ì¸  êµì²´"}
                  </button>
                  {isReplaced && (
                    <button
                      onClick={() => {
                        // êµì²´ ì·¨ì†Œ
                        const newMap = new Map(localAdjustments);
                        newMap.delete(contentId);
                        setLocalAdjustments(newMap);
                        const newInfoMap = new Map(replacedContentInfo);
                        newInfoMap.delete(contentId);
                        setReplacedContentInfo(newInfoMap);
                      }}
                      className="rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-medium text-red-700 transition hover:bg-red-50"
                    >
                      êµì²´ ì·¨ì†Œ
                    </button>
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* ì¬ì¡°ì • í”Œëœ ë°°ì¹˜ ë²”ìœ„ ì„ íƒ */}
      <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex flex-col gap-1">
          <h3 className="text-sm font-semibold text-gray-900">
            ì¬ì¡°ì • í”Œëœ ë°°ì¹˜ ë²”ìœ„ ì„ íƒ
          </h3>
          <p className="text-xs text-gray-600">
            ìƒˆë¡œ ìƒì„±ëœ í”Œëœì„ ì–´ë–¤ ë‚ ì§œ ë²”ìœ„ì— ë°°ì¹˜í• ì§€ ì„ íƒí•©ë‹ˆë‹¤ (ì˜¤ëŠ˜ ì´í›„ë§Œ ê°€ëŠ¥)
          </p>
        </div>
        <div className="flex flex-col gap-3">
          <label
            className="flex cursor-pointer items-center gap-3 rounded-lg border p-3 transition hover:bg-gray-50"
            aria-label="ìë™ ë°°ì¹˜ ëª¨ë“œ ì„ íƒ"
          >
            <input
              type="radio"
              name="placementMode"
              value="auto"
              checked={placementMode === "auto"}
              onChange={() => {
                setPlacementMode("auto");
                setPlacementRangeExpanded(false);
              }}
              className="h-4 w-4 text-blue-600 focus:ring-blue-500"
              aria-label="ìë™ ë°°ì¹˜"
            />
            <div className="flex-1">
              <div className="font-medium text-gray-900">ìë™</div>
              <div className="text-xs text-gray-600">
                ì˜¤ëŠ˜ ì´í›„ ~ í”Œëœ ê·¸ë£¹ ì¢…ë£Œì¼ ({tomorrowStr} ~ {groupPeriodEnd})
              </div>
            </div>
          </label>
          <label
            className="flex cursor-pointer items-center gap-3 rounded-lg border p-3 transition hover:bg-gray-50"
            aria-label="ìˆ˜ë™ ì„ íƒ ëª¨ë“œ ì„ íƒ"
          >
            <input
              type="radio"
              name="placementMode"
              value="manual"
              checked={placementMode === "manual"}
              onChange={() => {
                setPlacementMode("manual");
                setPlacementRangeExpanded(true);
              }}
              className="h-4 w-4 text-blue-600 focus:ring-blue-500"
              aria-label="ìˆ˜ë™ ì„ íƒ"
            />
            <div className="flex-1">
              <div className="font-medium text-gray-900">ìˆ˜ë™ ì„ íƒ</div>
              <div className="text-xs text-gray-600">
                ì›í•˜ëŠ” ë‚ ì§œ ë²”ìœ„ë¥¼ ì§ì ‘ ì„ íƒí•©ë‹ˆë‹¤ (ì˜¤ëŠ˜ ì´í›„ë§Œ ì„ íƒ ê°€ëŠ¥)
              </div>
            </div>
          </label>
        </div>

        {/* ë°°ì¹˜ ë²”ìœ„ ì„ íƒ UI (ì ‘ì´ì‹ íŒ¨ë„) */}
        {placementMode === "manual" && (
          <div>
            <button
              type="button"
              onClick={() => setPlacementRangeExpanded(!placementRangeExpanded)}
              className="flex w-full items-center justify-between rounded-lg border border-gray-300 bg-gray-50 p-3 transition hover:bg-gray-100"
              aria-expanded={placementRangeExpanded}
              aria-controls="placement-range-panel"
            >
              <span className="text-sm font-medium text-gray-900">
                ë°°ì¹˜ ë²”ìœ„ ì„ íƒ
              </span>
              {placementRangeExpanded ? (
                <ChevronUp
                  className="h-5 w-5 text-gray-600"
                  aria-hidden="true"
                />
              ) : (
                <ChevronDown
                  className="h-5 w-5 text-gray-600"
                  aria-hidden="true"
                />
              )}
            </button>

            {placementRangeExpanded && (
              <div
                id="placement-range-panel"
                className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4"
                role="region"
                aria-label="ë°°ì¹˜ ë²”ìœ„ ì„ íƒ íŒ¨ë„"
              >
                {/* ë‚ ì§œ ë²”ìœ„ ì„ íƒ ìº˜ë¦°ë” */}
                <DateRangeSelector
                  groupPeriodStart={tomorrowStr}
                  groupPeriodEnd={groupPeriodEnd}
                  existingPlans={existingPlans}
                  onRangeChange={setPlacementDateRange}
                  initialRange={placementDateRange}
                  minDate={tomorrowStr}
                />
              </div>
            )}
          </div>
        )}

        {/* ì„ íƒí•œ ë°°ì¹˜ ë²”ìœ„ ìš”ì•½ */}
        {placementMode === "auto" ? (
          <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-3">
            <div className="text-sm font-medium text-blue-900">
              ìë™ ë°°ì¹˜ ë²”ìœ„
            </div>
            <div className="text-sm text-blue-700">
              {tomorrowStr} ~ {groupPeriodEnd}
            </div>
          </div>
        ) : (
          placementDateRange.from &&
          placementDateRange.to && (
            <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-3">
              <div className="text-sm font-medium text-blue-900">
                ì„ íƒí•œ ë°°ì¹˜ ë²”ìœ„
              </div>
              <div className="text-sm text-blue-700">
                {placementDateRange.from} ~ {placementDateRange.to}
              </div>
            </div>
          )
        )}
      </div>

      {/* ë³€ê²½ ì‚¬í•­ ìš”ì•½ */}
      <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
        <h3 className="text-sm font-semibold text-gray-900">
          ë³€ê²½ ì‚¬í•­ ìš”ì•½
        </h3>
        {localAdjustments.size === 0 ? (
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-3 text-center text-sm text-gray-600">
            ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë²”ìœ„ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì½˜í…ì¸ ë¥¼ êµì²´í•´ì£¼ì„¸ìš”.
          </div>
        ) : (
          <div className="flex flex-col gap-3">
            <div className="grid grid-cols-1 gap-3 md:grid-cols-3">
              <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-gray-50 p-3">
                <div className="text-xs text-gray-600">ë²”ìœ„ ìˆ˜ì •</div>
                <div className="text-lg font-bold text-gray-900">
                  {
                    Array.from(localAdjustments.values()).filter(
                      (adj) => adj.change_type === "range"
                    ).length
                  }
                  ê°œ
                </div>
              </div>
              <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-3">
                <div className="text-xs text-blue-700">ì½˜í…ì¸  êµì²´</div>
                <div className="text-lg font-bold text-blue-600">
                  {
                    Array.from(localAdjustments.values()).filter(
                      (adj) => adj.change_type === "replace"
                    ).length
                  }
                  ê°œ
                </div>
              </div>
              <div className="flex flex-col gap-1 rounded-lg border border-green-200 bg-green-50 p-3">
                <div className="text-xs text-green-700">ì „ì²´ ì¬ìƒì„±</div>
                <div className="text-lg font-bold text-green-600">
                  {
                    Array.from(localAdjustments.values()).filter(
                      (adj) => adj.change_type === "full"
                    ).length
                  }
                  ê°œ
                </div>
              </div>
            </div>

            {/* ë³€ê²½ ë‚´ì—­ ìƒì„¸ (ì ‘ì´ì‹) */}
            <details className="rounded-lg border border-gray-200 bg-gray-50">
              <summary className="cursor-pointer px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">
                ë³€ê²½ ë‚´ì—­ ìƒì„¸ ë³´ê¸° ({localAdjustments.size}ê°œ)
              </summary>
              <div className="border-t border-gray-200 p-3">
                <div className="flex flex-col gap-2 text-xs">
                  {Array.from(localAdjustments.values()).map((adj, index) => {
                    const content = contents.find(
                      (c) => (c.id || c.content_id) === adj.plan_content_id
                    );
                    const contentName =
                      content?.content_type === "book"
                        ? "ğŸ“š êµì¬"
                        : content?.content_type === "lecture"
                        ? "ğŸ¥ ê°•ì˜"
                        : "ğŸ“ ì»¤ìŠ¤í…€";

                    return (
                      <div
                        key={index}
                        className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-2"
                      >
                        <div className="flex items-center gap-2">
                          <span className="font-medium text-gray-900">
                            {contentName}
                          </span>
                          <span className="text-gray-600">
                            {adj.change_type === "range"
                              ? "ë²”ìœ„ ìˆ˜ì •"
                              : adj.change_type === "replace"
                              ? "ì½˜í…ì¸  êµì²´"
                              : "ì „ì²´ ì¬ìƒì„±"}
                          </span>
                        </div>
                        <div className="text-gray-600">
                          {adj.before.range.start}~{adj.before.range.end} â†’{" "}
                          {adj.after.range.start}~{adj.after.range.end}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </details>
          </div>
        )}
      </div>

      {/* ì½˜í…ì¸  êµì²´ ëª¨ë‹¬ */}
      {replaceModalOpen && replacingContentId && replaceRange && (
        <ContentReplaceModal
          isOpen={replaceModalOpen}
          onClose={handleReplaceCancel}
          onSelect={(newContent) => {
            handleReplace(replacingContentId, newContent);
          }}
          studentId={studentId}
          currentContentType={
            contents.find((c) => (c.id || c.content_id) === replacingContentId)
              ?.content_type
          }
          initialRange={replaceRange}
        />
      )}

      <div className="flex justify-end gap-3">
        <button
          onClick={onBack}
          className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          ë’¤ë¡œê°€ê¸°
        </button>
        <button
          onClick={handleNext}
          className="rounded-lg bg-blue-600 px-6 py-2 text-sm font-medium text-white transition hover:bg-blue-700"
        >
          ë‹¤ìŒ
        </button>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/AffectedPlansList.tsx">
/**
 * ì˜í–¥ë°›ëŠ” í”Œëœ ëª©ë¡ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì •ìœ¼ë¡œ ì˜í–¥ë°›ëŠ” í”Œëœ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.
 */

"use client";

import { useMemo, useState } from "react";
import { format } from "date-fns";
import { ChevronDown, ChevronUp } from "lucide-react";
import type { ReschedulePreviewResult } from "@/app/(student)/actions/plan-groups/reschedule";
import type { AdjustmentInput } from "@/lib/reschedule/scheduleEngine";

type AffectedPlansListProps = {
  preview: ReschedulePreviewResult;
  adjustments: AdjustmentInput[];
  dateRange?: { from: string; to: string } | null;
};

type PlanGroupByDate = {
  date: string;
  beforeCount: number;
  afterCount: number;
  change: number;
  beforePlans: Array<{
    id: string;
    content_id: string;
    content_type: string;
    planned_start_page_or_time: number | null;
    planned_end_page_or_time: number | null;
    start_time: string | null;
    end_time: string | null;
  }>;
  afterPlans: Array<{
    plan_date: string;
    content_id: string;
    content_type: string;
    planned_start_page_or_time: number;
    planned_end_page_or_time: number;
    start_time?: string;
    end_time?: string;
  }>;
};

export function AffectedPlansList({
  preview,
  adjustments,
  dateRange,
}: AffectedPlansListProps) {
  const [expandedDates, setExpandedDates] = useState<Set<string>>(new Set());
  const [sortBy, setSortBy] = useState<"date" | "change">("date");
  const [filter, setFilter] = useState<"all" | "increase" | "decrease">("all");

  // ë‚ ì§œë³„ ê·¸ë£¹í™” (ì‹¤ì œ í”Œëœ ë°ì´í„° ì‚¬ìš©)
  const plansByDate = useMemo(() => {
    const dateMap = new Map<string, PlanGroupByDate>();

    // ëª¨ë“  ë‚ ì§œ ìˆ˜ì§‘ (ê¸°ì¡´ í”Œëœê³¼ ìƒˆ í”Œëœ ëª¨ë‘)
    const allDates = new Set<string>();
    preview.plans_before.forEach((plan) => allDates.add(plan.plan_date));
    preview.plans_after.forEach((plan) => allDates.add(plan.plan_date));

    // ë‚ ì§œë³„ë¡œ ë°ì´í„° ì´ˆê¸°í™”
    allDates.forEach((date) => {
      if (dateRange && (date < dateRange.from || date > dateRange.to)) {
        return; // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
      }

      dateMap.set(date, {
        date,
        beforeCount: 0,
        afterCount: 0,
        change: 0,
        beforePlans: [],
        afterPlans: [],
      });
    });

    // ê¸°ì¡´ í”Œëœì„ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
    preview.plans_before.forEach((plan) => {
      const item = dateMap.get(plan.plan_date);
      if (item) {
        item.beforeCount++;
        item.beforePlans.push({
          id: plan.id,
          content_id: plan.content_id,
          content_type: plan.content_type,
          planned_start_page_or_time: plan.planned_start_page_or_time,
          planned_end_page_or_time: plan.planned_end_page_or_time,
          start_time: plan.start_time,
          end_time: plan.end_time,
        });
      }
    });

    // ìƒˆ í”Œëœì„ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
    preview.plans_after.forEach((plan) => {
      const item = dateMap.get(plan.plan_date);
      if (item) {
        item.afterCount++;
        item.afterPlans.push({
          plan_date: plan.plan_date,
          content_id: plan.content_id,
          content_type: plan.content_type,
          planned_start_page_or_time: plan.planned_start_page_or_time,
          planned_end_page_or_time: plan.planned_end_page_or_time,
          start_time: plan.start_time,
          end_time: plan.end_time,
        });
      }
    });

    // ë³€í™” ê³„ì‚°
    dateMap.forEach((item) => {
      item.change = item.afterCount - item.beforeCount;
    });

    return Array.from(dateMap.values());
  }, [preview, dateRange]);

  // ì •ë ¬ ë° í•„í„°ë§
  const filteredAndSorted = useMemo(() => {
    let filtered = plansByDate;

    // í•„í„°ë§
    if (filter === "increase") {
      filtered = filtered.filter((item) => item.change > 0);
    } else if (filter === "decrease") {
      filtered = filtered.filter((item) => item.change < 0);
    }

    // ì •ë ¬
    if (sortBy === "date") {
      filtered.sort((a, b) => a.date.localeCompare(b.date));
    } else {
      filtered.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    }

    return filtered;
  }, [plansByDate, sortBy, filter]);

  const toggleDate = (date: string) => {
    const newExpanded = new Set(expandedDates);
    if (newExpanded.has(date)) {
      newExpanded.delete(date);
    } else {
      newExpanded.add(date);
    }
    setExpandedDates(newExpanded);
  };

  if (filteredAndSorted.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">
          ì˜í–¥ë°›ëŠ” í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex items-center justify-between">
        <h3 className="font-semibold text-gray-900">ì˜í–¥ë°›ëŠ” í”Œëœ ëª©ë¡</h3>
        <div className="flex items-center gap-3">
          {/* í•„í„° */}
          <select
            value={filter}
            onChange={(e) =>
              setFilter(e.target.value as "all" | "increase" | "decrease")
            }
            className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="all">ì „ì²´</option>
            <option value="increase">ì¦ê°€</option>
            <option value="decrease">ê°ì†Œ</option>
          </select>

          {/* ì •ë ¬ */}
          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value as "date" | "change")}
            className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="date">ë‚ ì§œìˆœ</option>
            <option value="change">ë³€í™”ìˆœ</option>
          </select>
        </div>
      </div>

      <div className="flex flex-col gap-2">
        {filteredAndSorted.map((item) => {
          const isExpanded = expandedDates.has(item.date);
          const weekday = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][
            new Date(item.date).getDay()
          ];

          return (
            <div
              key={item.date}
              className="rounded-lg border border-gray-200 bg-white transition hover:border-gray-300 hover:shadow-sm"
            >
              <button
                type="button"
                onClick={() => toggleDate(item.date)}
                className="w-full px-4 py-3 text-left"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    {isExpanded ? (
                      <ChevronUp className="h-4 w-4 text-gray-400" />
                    ) : (
                      <ChevronDown className="h-4 w-4 text-gray-400" />
                    )}
                    <div className="flex flex-col gap-1">
                      <div className="font-medium text-gray-900">
                        {format(new Date(item.date), "yyyyë…„ Mì›” dì¼")} ({weekday})
                      </div>
                      <div className="flex items-center gap-4 text-xs text-gray-600">
                        <span>
                          ê¸°ì¡´: {item.beforeCount}ê°œ
                        </span>
                        <span className="text-blue-600">
                          ë³€ê²½ í›„: {item.afterCount}ê°œ
                        </span>
                        <span
                          className={
                            item.change >= 0 ? "text-green-600" : "text-red-600"
                          }
                        >
                          {item.change >= 0 ? "+" : ""}
                          {item.change}ê°œ
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </button>

              {isExpanded && (
                <div className="border-t border-gray-200 bg-gray-50 px-4 py-3">
                  <div className="flex flex-col gap-4">
                    {/* ìš”ì•½ ì •ë³´ */}
                    <div className="flex flex-col gap-2 text-sm text-gray-600">
                      <div className="flex justify-between">
                        <span>ê¸°ì¡´ í”Œëœ ìˆ˜:</span>
                        <span className="font-medium text-gray-900">
                          {item.beforeCount}ê°œ
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span>ë³€ê²½ í›„ í”Œëœ ìˆ˜:</span>
                        <span className="font-medium text-blue-600">
                          {item.afterCount}ê°œ
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span>ë³€í™”:</span>
                        <span
                          className={`font-medium ${
                            item.change >= 0 ? "text-green-600" : "text-red-600"
                          }`}
                        >
                          {item.change >= 0 ? "+" : ""}
                          {item.change}ê°œ
                        </span>
                      </div>
                    </div>

                    {/* ê¸°ì¡´ í”Œëœ ëª©ë¡ */}
                    {item.beforePlans.length > 0 && (
                      <div className="flex flex-col gap-2 border-t border-gray-200 pt-3">
                        <h4 className="text-sm font-semibold text-gray-900">
                          ê¸°ì¡´ í”Œëœ ({item.beforePlans.length}ê°œ)
                        </h4>
                        <div className="flex flex-col gap-2">
                          {item.beforePlans.map((plan) => (
                            <div
                              key={plan.id}
                              className="rounded-lg border border-gray-200 bg-white p-2 text-xs"
                            >
                              <div className="flex items-center justify-between">
                                <span className="font-medium text-gray-900">
                                  {plan.content_type === "book"
                                    ? "ğŸ“š êµì¬"
                                    : plan.content_type === "lecture"
                                    ? "ğŸ¥ ê°•ì˜"
                                    : "ğŸ“ ì»¤ìŠ¤í…€"}
                                </span>
                                {plan.start_time && plan.end_time && (
                                  <span className="text-gray-600">
                                    {plan.start_time} ~ {plan.end_time}
                                  </span>
                                )}
                              </div>
                              {plan.planned_start_page_or_time !== null &&
                                plan.planned_end_page_or_time !== null && (
                                  <div className="text-gray-600">
                                    {plan.planned_start_page_or_time} ~{" "}
                                    {plan.planned_end_page_or_time}
                                    {plan.content_type === "book"
                                      ? "í˜ì´ì§€"
                                      : plan.content_type === "lecture"
                                      ? "ë¶„"
                                      : ""}
                                  </div>
                                )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* ìƒˆ í”Œëœ ëª©ë¡ */}
                    {item.afterPlans.length > 0 && (
                      <div className="flex flex-col gap-2 border-t border-gray-200 pt-3">
                        <h4 className="text-sm font-semibold text-blue-900">
                          ë³€ê²½ í›„ í”Œëœ ({item.afterPlans.length}ê°œ)
                        </h4>
                        <div className="flex flex-col gap-2">
                          {item.afterPlans.map((plan, index) => (
                            <div
                              key={`${plan.plan_date}-${plan.content_id}-${index}`}
                              className="rounded-lg border border-blue-200 bg-blue-50 p-2 text-xs"
                            >
                              <div className="flex items-center justify-between">
                                <span className="font-medium text-blue-900">
                                  {plan.content_type === "book"
                                    ? "ğŸ“š êµì¬"
                                    : plan.content_type === "lecture"
                                    ? "ğŸ¥ ê°•ì˜"
                                    : "ğŸ“ ì»¤ìŠ¤í…€"}
                                </span>
                                {plan.start_time && plan.end_time && (
                                  <span className="text-blue-700">
                                    {plan.start_time} ~ {plan.end_time}
                                  </span>
                                )}
                              </div>
                              <div className="text-blue-700">
                                {plan.planned_start_page_or_time} ~{" "}
                                {plan.planned_end_page_or_time}
                                {plan.content_type === "book"
                                  ? "í˜ì´ì§€"
                                  : plan.content_type === "lecture"
                                  ? "ë¶„"
                                  : ""}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* ìš”ì•½ */}
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">ì´ ì˜í–¥ë°›ëŠ” ë‚ ì§œ:</span>
          <span className="font-medium text-gray-900">
            {filteredAndSorted.length}ì¼
          </span>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/BatchAdjustmentPanel.tsx">
/**
 * ì¼ê´„ ì¡°ì • íŒ¨ë„ ì»´í¬ë„ŒíŠ¸
 * 
 * ì—¬ëŸ¬ ì½˜í…ì¸ ë¥¼ í•œ ë²ˆì— ì¡°ì •í•  ìˆ˜ ìˆëŠ” UIë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useMemo } from "react";
import { applyBatchAdjustment, previewBatchAdjustment, type BatchAdjustmentConfig } from "@/lib/reschedule/batchAdjuster";
import type { PlanContent } from "@/lib/types/plan";
import type { AdjustmentInput } from "@/lib/reschedule/scheduleEngine";

type BatchAdjustmentPanelProps = {
  contents: PlanContent[];
  selectedContentIds: Set<string>;
  onApply: (adjustments: AdjustmentInput[]) => void;
  onCancel: () => void;
};

export function BatchAdjustmentPanel({
  contents,
  selectedContentIds,
  onApply,
  onCancel,
}: BatchAdjustmentPanelProps) {
  const [adjustmentType, setAdjustmentType] = useState<"ratio" | "absolute">("ratio");
  const [ratio, setRatio] = useState<string>("1.0");
  const [absoluteChange, setAbsoluteChange] = useState<string>("0");

  const selectedContents = useMemo(() => {
    return contents.filter(
      (c) => selectedContentIds.has(c.id || c.content_id)
    );
  }, [contents, selectedContentIds]);

  // ë¯¸ë¦¬ë³´ê¸° ê³„ì‚°
  const preview = useMemo(() => {
    if (selectedContents.length === 0) {
      return null;
    }

    try {
      const config: BatchAdjustmentConfig = {
        type: adjustmentType,
        ratio: adjustmentType === "ratio" ? parseFloat(ratio) : undefined,
        absoluteChange: adjustmentType === "absolute" ? parseInt(absoluteChange) : undefined,
      };

      return previewBatchAdjustment(selectedContents, config);
    } catch (error) {
      return null;
    }
  }, [selectedContents, adjustmentType, ratio, absoluteChange]);

  const handleApply = () => {
    if (selectedContents.length === 0) {
      return;
    }

    try {
      const config: BatchAdjustmentConfig = {
        type: adjustmentType,
        ratio: adjustmentType === "ratio" ? parseFloat(ratio) : undefined,
        absoluteChange: adjustmentType === "absolute" ? parseInt(absoluteChange) : undefined,
      };

      const adjustments = applyBatchAdjustment(selectedContents, config);
      onApply(adjustments);
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "ì¼ê´„ ì¡°ì • ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    }
  };

  if (selectedContents.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-blue-200 bg-blue-50 p-4">
      <div className="flex flex-col gap-1">
        <h3 className="font-semibold text-blue-900">ì¼ê´„ ì¡°ì •</h3>
        <p className="text-xs text-blue-700">
          ì„ íƒí•œ {selectedContents.length}ê°œì˜ ì½˜í…ì¸ ë¥¼ í•œ ë²ˆì— ì¡°ì •í•©ë‹ˆë‹¤.
        </p>
      </div>

      {/* ì¡°ì • íƒ€ì… ì„ íƒ */}
      <div className="flex flex-col gap-3">
        <div className="flex items-center gap-3">
          <label className="flex cursor-pointer items-center gap-2">
            <input
              type="radio"
              name="batchType"
              value="ratio"
              checked={adjustmentType === "ratio"}
              onChange={() => setAdjustmentType("ratio")}
              className="h-4 w-4 text-blue-600 focus:ring-blue-500"
            />
            <span className="text-sm font-medium text-gray-900">ë¹„ìœ¨ ì¡°ì •</span>
          </label>
          <label className="flex cursor-pointer items-center gap-2">
            <input
              type="radio"
              name="batchType"
              value="absolute"
              checked={adjustmentType === "absolute"}
              onChange={() => setAdjustmentType("absolute")}
              className="h-4 w-4 text-blue-600 focus:ring-blue-500"
            />
            <span className="text-sm font-medium text-gray-900">ì ˆëŒ€ê°’ ì¡°ì •</span>
          </label>
        </div>

        {/* ë¹„ìœ¨ ì¡°ì • ì…ë ¥ */}
        {adjustmentType === "ratio" && (
          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-gray-700">
              ì¡°ì • ë¹„ìœ¨ (ì˜ˆ: 1.1 = 10% ì¦ê°€, 0.9 = 10% ê°ì†Œ)
            </label>
            <input
              type="number"
              step="0.1"
              min="0.1"
              max="2.0"
              value={ratio}
              onChange={(e) => setRatio(e.target.value)}
              className="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="1.0"
            />
            <p className="text-xs text-gray-600">
              í˜„ì¬ ë¹„ìœ¨: {ratio} ({((parseFloat(ratio) - 1) * 100).toFixed(1)}%)
            </p>
          </div>
        )}

        {/* ì ˆëŒ€ê°’ ì¡°ì • ì…ë ¥ */}
        {adjustmentType === "absolute" && (
          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-gray-700">
              ì ˆëŒ€ê°’ ë³€í™” (ì–‘ìˆ˜ = ì¦ê°€, ìŒìˆ˜ = ê°ì†Œ)
            </label>
            <input
              type="number"
              value={absoluteChange}
              onChange={(e) => setAbsoluteChange(e.target.value)}
              className="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="0"
            />
            <p className="text-xs text-gray-600">
              í˜„ì¬ ë³€í™”: {absoluteChange >= "0" ? "+" : ""}
              {absoluteChange}
            </p>
          </div>
        )}
      </div>

      {/* ë¯¸ë¦¬ë³´ê¸° */}
      {preview && (
        <div className="flex flex-col gap-2 rounded-lg border border-blue-300 bg-white p-3">
          <h4 className="text-sm font-semibold text-gray-900">ë¯¸ë¦¬ë³´ê¸°</h4>
          <div className="flex flex-col gap-1 text-xs text-gray-600">
            <div className="flex justify-between">
              <span>ì˜í–¥ë°›ëŠ” ì½˜í…ì¸ :</span>
              <span className="font-medium text-gray-900">
                {preview.affectedCount}ê°œ
              </span>
            </div>
            <div className="flex justify-between">
              <span>ê¸°ì¡´ ì´ ë²”ìœ„:</span>
              <span className="font-medium text-gray-900">
                {preview.totalRangeBefore}
              </span>
            </div>
            <div className="flex justify-between">
              <span>ë³€ê²½ í›„ ì´ ë²”ìœ„:</span>
              <span className="font-medium text-blue-600">
                {preview.totalRangeAfter}
              </span>
            </div>
            <div className="flex justify-between">
              <span>ë³€í™”:</span>
              <span
                className={`font-medium ${
                  preview.rangeChange >= 0 ? "text-green-600" : "text-red-600"
                }`}
              >
                {preview.rangeChange >= 0 ? "+" : ""}
                {preview.rangeChange}
              </span>
            </div>
          </div>

          {/* ìƒ˜í”Œ ì¡°ì • ë‚´ì—­ */}
          {preview.sampleAdjustments.length > 0 && (
            <div className="flex flex-col gap-2 border-t border-gray-200 pt-3">
              <p className="text-xs font-medium text-gray-700">ìƒ˜í”Œ ì¡°ì • ë‚´ì—­:</p>
              <div className="flex flex-col gap-1 text-xs text-gray-600">
                {preview.sampleAdjustments.map((sample, index) => (
                  <div key={index} className="flex justify-between">
                    <span>ì½˜í…ì¸  {index + 1}:</span>
                    <span>
                      {sample.before.start}~{sample.before.end} â†’{" "}
                      {sample.after.start}~{sample.after.end}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* ì•¡ì…˜ ë²„íŠ¼ */}
      <div className="flex justify-end gap-2">
        <button
          type="button"
          onClick={onCancel}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="button"
          onClick={handleApply}
          disabled={!preview}
          className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700 disabled:bg-gray-300 disabled:text-gray-500"
        >
          ì¼ê´„ ì ìš©
        </button>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/BeforeAfterComparison.tsx">
/**
 * ë³€ê²½ ì „/í›„ ë¹„êµ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì • ì „í›„ì˜ í”Œëœì„ ë‚˜ë€íˆ ë¹„êµí•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.
 */

"use client";

import { useMemo } from "react";
import { format } from "date-fns";
import type { ReschedulePreviewResult } from "@/app/(student)/actions/plan-groups/reschedule";
import type { AdjustmentInput } from "@/lib/reschedule/scheduleEngine";

type BeforeAfterComparisonProps = {
  preview: ReschedulePreviewResult;
  adjustments: AdjustmentInput[];
  dateRange?: { from: string; to: string } | null;
};

type ComparisonItem = {
  date: string;
  before: {
    count: number;
    totalHours: number;
  };
  after: {
    count: number;
    totalHours: number;
  };
  change: {
    count: number;
    hours: number;
  };
};

export function BeforeAfterComparison({
  preview,
  adjustments,
  dateRange,
}: BeforeAfterComparisonProps) {
  // ë‚ ì§œë³„ ë¹„êµ ë°ì´í„° ìƒì„± (ì‹¤ì œ í”Œëœ ë°ì´í„° ì‚¬ìš©)
  const comparisonData = useMemo(() => {
    const dateMap = new Map<string, ComparisonItem>();

    // ëª¨ë“  ë‚ ì§œ ìˆ˜ì§‘ (ê¸°ì¡´ í”Œëœê³¼ ìƒˆ í”Œëœ ëª¨ë‘)
    const allDates = new Set<string>();
    preview.plans_before.forEach((plan) => allDates.add(plan.plan_date));
    preview.plans_after.forEach((plan) => allDates.add(plan.plan_date));

    // ë‚ ì§œë³„ë¡œ ë°ì´í„° ì´ˆê¸°í™”
    allDates.forEach((date) => {
      dateMap.set(date, {
        date,
        before: {
          count: 0,
          totalHours: 0,
        },
        after: {
          count: 0,
          totalHours: 0,
        },
        change: {
          count: 0,
          hours: 0,
        },
      });
    });

    // ê¸°ì¡´ í”Œëœ ë°ì´í„°ë¡œ ë‚ ì§œë³„ í†µê³„ ê³„ì‚°
    preview.plans_before.forEach((plan) => {
      const item = dateMap.get(plan.plan_date);
      if (item) {
        item.before.count++;
        if (plan.start_time && plan.end_time) {
          const [startHour, startMin] = plan.start_time.split(":").map(Number);
          const [endHour, endMin] = plan.end_time.split(":").map(Number);
          const startMinutes = startHour * 60 + startMin;
          const endMinutes = endHour * 60 + endMin;
          item.before.totalHours += (endMinutes - startMinutes) / 60;
        }
      }
    });

    // ìƒˆ í”Œëœ ë°ì´í„°ë¡œ ë‚ ì§œë³„ í†µê³„ ê³„ì‚°
    preview.plans_after.forEach((plan) => {
      const item = dateMap.get(plan.plan_date);
      if (item) {
        item.after.count++;
        if (plan.start_time && plan.end_time) {
          const [startHour, startMin] = plan.start_time.split(":").map(Number);
          const [endHour, endMin] = plan.end_time.split(":").map(Number);
          const startMinutes = startHour * 60 + startMin;
          const endMinutes = endHour * 60 + endMin;
          item.after.totalHours += (endMinutes - startMinutes) / 60;
        }
      }
    });

    // ë³€í™” ê³„ì‚° ë° ì‹œê°„ ë°˜ì˜¬ë¦¼
    dateMap.forEach((item) => {
      item.before.totalHours = Math.round(item.before.totalHours * 10) / 10;
      item.after.totalHours = Math.round(item.after.totalHours * 10) / 10;
      item.change.count = item.after.count - item.before.count;
      item.change.hours = Math.round((item.after.totalHours - item.before.totalHours) * 10) / 10;
    });

    return Array.from(dateMap.values()).sort((a, b) =>
      a.date.localeCompare(b.date)
    );
  }, [preview]);

  // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
  const filteredData = useMemo(() => {
    if (!dateRange) {
      return comparisonData;
    }
    return comparisonData.filter(
      (item) =>
        item.date >= dateRange.from && item.date <= dateRange.to
    );
  }, [comparisonData, dateRange]);

  if (filteredData.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">
          ë¹„êµí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6">
      <h3 className="font-semibold text-gray-900">ë³€ê²½ ì „/í›„ ë¹„êµ</h3>

      {/* ìš”ì•½ ì¹´ë“œ */}
      <div className="grid grid-cols-1 gap-3 sm:gap-4 sm:grid-cols-2 md:grid-cols-3">
        <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-gray-50 p-4">
          <p className="text-xs text-gray-600">ê¸°ì¡´ í”Œëœ</p>
          <p className="text-2xl font-bold text-gray-900">
            {preview.plans_before_count}ê°œ
          </p>
          <p className="text-sm text-gray-600">
            {preview.estimated_hours}ì‹œê°„
          </p>
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-4">
          <p className="text-xs text-blue-700">ìƒˆ í”Œëœ</p>
          <p className="text-2xl font-bold text-blue-600">
            {preview.plans_after_count}ê°œ
          </p>
          <p className="text-sm text-blue-700">
            {preview.estimated_hours}ì‹œê°„
          </p>
        </div>
        <div
          className={`flex flex-col gap-1 rounded-lg border p-4 ${
            preview.plans_after_count - preview.plans_before_count >= 0
              ? "border-green-200 bg-green-50"
              : "border-red-200 bg-red-50"
          }`}
        >
          <p className="text-xs text-gray-600">ë³€í™”</p>
          <p
            className={`text-2xl font-bold ${
              preview.plans_after_count - preview.plans_before_count >= 0
                ? "text-green-600"
                : "text-red-600"
            }`}
          >
            {preview.plans_after_count - preview.plans_before_count >= 0
              ? "+"
              : ""}
            {preview.plans_after_count - preview.plans_before_count}ê°œ
          </p>
          <p className="text-sm text-gray-600">ë³€í™” ì—†ìŒ</p>
        </div>
      </div>

      {/* ë‚ ì§œë³„ ìƒì„¸ ë¹„êµ */}
      <div className="overflow-x-auto px-6">
        <table className="w-full text-sm min-w-[600px]">
          <thead>
            <tr className="border-b border-gray-200">
              <th className="px-2 py-3 text-left font-semibold text-gray-900 sm:px-4">
                ë‚ ì§œ
              </th>
              <th className="px-2 py-3 text-center font-semibold text-gray-900 sm:px-4">
                ê¸°ì¡´
              </th>
              <th className="px-2 py-3 text-center font-semibold text-gray-900 sm:px-4">
                ë³€ê²½ í›„
              </th>
              <th className="px-2 py-3 text-center font-semibold text-gray-900 sm:px-4">
                ë³€í™”
              </th>
            </tr>
          </thead>
          <tbody>
            {filteredData.map((item) => (
              <tr
                key={item.date}
                className="border-b border-gray-100 transition hover:bg-gray-50"
              >
                <td className="px-2 py-3 font-medium text-gray-900 sm:px-4">
                  <div className="text-xs sm:text-sm">
                    {format(new Date(item.date), "yyyyë…„ Mì›” dì¼ (E)", {
                      locale: undefined,
                    }).replace(
                      /\([^)]*\)/,
                      `(${["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][new Date(item.date).getDay()]})`
                    )}
                  </div>
                </td>
                <td className="px-2 py-3 text-center text-gray-700 sm:px-4">
                  <div className="flex flex-col">
                    <span className="font-medium text-xs sm:text-sm">{item.before.count}ê°œ</span>
                    <span className="text-xs text-gray-500">
                      {item.before.totalHours}ì‹œê°„
                    </span>
                  </div>
                </td>
                <td className="px-2 py-3 text-center text-blue-700 sm:px-4">
                  <div className="flex flex-col">
                    <span className="font-medium text-xs sm:text-sm">{item.after.count}ê°œ</span>
                    <span className="text-xs text-blue-600">
                      {item.after.totalHours}ì‹œê°„
                    </span>
                  </div>
                </td>
                <td className="px-2 py-3 text-center sm:px-4">
                  <div className="flex flex-col">
                    <span
                      className={`font-medium ${
                        item.change.count >= 0
                          ? "text-green-600"
                          : "text-red-600"
                      }`}
                    >
                      {item.change.count >= 0 ? "+" : ""}
                      {item.change.count}ê°œ
                    </span>
                    <span className="text-xs text-gray-500">
                      {item.change.hours >= 0 ? "+" : ""}
                      {item.change.hours}ì‹œê°„
                    </span>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* ì¡°ì • ë‚´ì—­ ìš”ì•½ */}
      {adjustments.length > 0 && (
        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-4">
          <h4 className="text-sm font-semibold text-gray-900">
            ì¡°ì • ë‚´ì—­
          </h4>
          <div className="flex flex-col gap-1 text-xs text-gray-600">
            {adjustments.map((adj, index) => (
              <div key={index} className="flex items-center gap-2">
                <span className="font-medium">
                  {adj.change_type === "range"
                    ? "ë²”ìœ„ ìˆ˜ì •"
                    : adj.change_type === "replace"
                    ? "ì½˜í…ì¸  êµì²´"
                    : "ì „ì²´ ì¬ìƒì„±"}
                </span>
                <span className="text-gray-500">
                  {adj.before.range.start}~{adj.before.range.end} â†’{" "}
                  {adj.after.range.start}~{adj.after.range.end}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/ConflictWarning.tsx">
/**
 * ì¶©ëŒ ê²½ê³  ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì • ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¶©ëŒì„ í‘œì‹œí•©ë‹ˆë‹¤.
 */

"use client";

import { useMemo } from "react";
import { format } from "date-fns";
import { AlertTriangle, X } from "lucide-react";
import { useState } from "react";
import type { Conflict } from "@/lib/reschedule/conflictDetector";

type ConflictWarningProps = {
  conflicts: Conflict[];
};

export function ConflictWarning({ conflicts }: ConflictWarningProps) {
  const [dismissed, setDismissed] = useState<Set<string>>(new Set());

  // ì‹¬ê°ë„ë³„ë¡œ ê·¸ë£¹í™”
  const conflictsBySeverity = useMemo(() => {
    const high: Conflict[] = [];
    const medium: Conflict[] = [];
    const low: Conflict[] = [];

    conflicts
      .filter((c) => !dismissed.has(`${c.type}-${c.date}`))
      .forEach((conflict) => {
        if (conflict.severity === "high") {
          high.push(conflict);
        } else if (conflict.severity === "medium") {
          medium.push(conflict);
        } else {
          low.push(conflict);
        }
      });

    return { high, medium, low };
  }, [conflicts, dismissed]);

  const handleDismiss = (conflict: Conflict) => {
    const newDismissed = new Set(dismissed);
    newDismissed.add(`${conflict.type}-${conflict.date}`);
    setDismissed(newDismissed);
  };

  const allConflicts = [
    ...conflictsBySeverity.high,
    ...conflictsBySeverity.medium,
    ...conflictsBySeverity.low,
  ];

  if (allConflicts.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-col gap-3">
      {conflictsBySeverity.high.length > 0 && (
        <div className="flex flex-col gap-2 rounded-lg border border-red-200 bg-red-50 p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-red-600" />
              <h4 className="font-semibold text-red-900">
                ë†’ì€ ì‹¬ê°ë„ ì¶©ëŒ ({conflictsBySeverity.high.length}ê°œ)
              </h4>
            </div>
          </div>
          <div className="flex flex-col gap-2">
            {conflictsBySeverity.high.map((conflict, index) => (
              <div
                key={`${conflict.type}-${conflict.date}-${index}`}
                className="flex items-start justify-between rounded-lg border border-red-300 bg-white p-3"
              >
                <div className="flex flex-1 flex-col gap-1">
                  <p className="text-sm font-medium text-red-900">
                    {conflict.message}
                  </p>
                  {conflict.details && (
                    <div className="text-xs text-red-700">
                      {conflict.details.overlappingPlans && (
                        <p>
                          ê²¹ì¹˜ëŠ” í”Œëœ:{" "}
                          {conflict.details.overlappingPlans.length}ê°œ
                        </p>
                      )}
                      {conflict.details.totalHours && (
                        <p>
                          ì´ í•™ìŠµ ì‹œê°„: {conflict.details.totalHours.toFixed(1)}
                          ì‹œê°„
                        </p>
                      )}
                    </div>
                  )}
                </div>
                <button
                  type="button"
                  onClick={() => handleDismiss(conflict)}
                  className="pl-2 rounded p-1 text-red-600 transition hover:bg-red-100"
                >
                  <X className="h-4 w-4" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {conflictsBySeverity.medium.length > 0 && (
        <div className="flex flex-col gap-2 rounded-lg border border-yellow-200 bg-yellow-50 p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-yellow-600" />
              <h4 className="font-semibold text-yellow-900">
                ì¤‘ê°„ ì‹¬ê°ë„ ì¶©ëŒ ({conflictsBySeverity.medium.length}ê°œ)
              </h4>
            </div>
          </div>
          <div className="flex flex-col gap-2">
            {conflictsBySeverity.medium.map((conflict, index) => (
              <div
                key={`${conflict.type}-${conflict.date}-${index}`}
                className="flex items-start justify-between rounded-lg border border-yellow-300 bg-white p-3"
              >
                <div className="flex-1">
                  <p className="text-sm font-medium text-yellow-900">
                    {conflict.message}
                  </p>
                </div>
                <button
                  type="button"
                  onClick={() => handleDismiss(conflict)}
                  className="pl-2 rounded p-1 text-yellow-600 transition hover:bg-yellow-100"
                >
                  <X className="h-4 w-4" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {conflictsBySeverity.low.length > 0 && (
        <div className="flex flex-col gap-2 rounded-lg border border-blue-200 bg-blue-50 p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-blue-600" />
              <h4 className="font-semibold text-blue-900">
                ë‚®ì€ ì‹¬ê°ë„ ì¶©ëŒ ({conflictsBySeverity.low.length}ê°œ)
              </h4>
            </div>
          </div>
          <div className="flex flex-col gap-2">
            {conflictsBySeverity.low.map((conflict, index) => (
              <div
                key={`${conflict.type}-${conflict.date}-${index}`}
                className="flex items-start justify-between rounded-lg border border-blue-300 bg-white p-3"
              >
                <div className="flex-1">
                  <p className="text-sm font-medium text-blue-900">
                    {conflict.message}
                  </p>
                </div>
                <button
                  type="button"
                  onClick={() => handleDismiss(conflict)}
                  className="pl-2 rounded p-1 text-blue-600 transition hover:bg-blue-100"
                >
                  <X className="h-4 w-4" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/ContentReplaceModal.tsx">
/**
 * ì½˜í…ì¸  êµì²´ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
 * 
 * í•™ìƒ ì½˜í…ì¸  ëª©ë¡ì„ ì¡°íšŒí•˜ê³  ì„ íƒí•  ìˆ˜ ìˆëŠ” ëª¨ë‹¬ì…ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect, useMemo } from "react";
import { createSupabaseBrowserClient } from "@/lib/supabase/client";

type ContentReplaceModalProps = {
  isOpen: boolean;
  onClose: () => void;
  onSelect: (content: {
    content_id: string;
    content_type: "book" | "lecture" | "custom";
    title: string;
    total_page_or_time: number | null;
    range: { start: number; end: number };
  }) => void;
  studentId: string;
  currentContentType?: "book" | "lecture" | "custom";
  initialRange?: { start: number; end: number } | null;
};

type TabKey = "books" | "lectures" | "custom";

type ContentWithTotal = {
  id: string;
  title: string;
  subtitle: string | null;
  total_page_or_time: number | null;
};

export function ContentReplaceModal({
  isOpen,
  onClose,
  onSelect,
  studentId,
  currentContentType,
  initialRange,
}: ContentReplaceModalProps) {
  const [activeTab, setActiveTab] = useState<TabKey>(
    currentContentType === "book"
      ? "books"
      : currentContentType === "lecture"
      ? "lectures"
      : "custom"
  );
  const [contents, setContents] = useState<{
    books: ContentWithTotal[];
    lectures: ContentWithTotal[];
    custom: ContentWithTotal[];
  }>({
    books: [],
    lectures: [],
    custom: [],
  });
  const [loading, setLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedContent, setSelectedContent] = useState<ContentWithTotal | null>(null);
  const [range, setRange] = useState<{ start: number; end: number }>({
    start: initialRange?.start ?? 1,
    end: initialRange?.end ?? 1,
  });

  // ì½˜í…ì¸  ëª©ë¡ ì¡°íšŒ
  useEffect(() => {
    if (!isOpen) return;

    const loadContents = async () => {
      setLoading(true);
      try {
        const supabase = createSupabaseBrowserClient();

        // ì±… ëª©ë¡ ì¡°íšŒ
        const { data: booksData } = await supabase
          .from("books")
          .select("id, title, subject, total_pages")
          .eq("student_id", studentId)
          .order("created_at", { ascending: false });

        const books: ContentWithTotal[] =
          booksData?.map((book) => ({
            id: book.id,
            title: book.title || "ì œëª© ì—†ìŒ",
            subtitle: book.subject || null,
            total_page_or_time: book.total_pages ?? null,
          })) || [];

        // ê°•ì˜ ëª©ë¡ ì¡°íšŒ
        const { data: lecturesData } = await supabase
          .from("lectures")
          .select("id, title, subject, duration")
          .eq("student_id", studentId)
          .order("created_at", { ascending: false });

        const lectures: ContentWithTotal[] =
          lecturesData?.map((lecture) => ({
            id: lecture.id,
            title: lecture.title || "ì œëª© ì—†ìŒ",
            subtitle: lecture.subject || null,
            total_page_or_time: lecture.duration ?? null,
          })) || [];

        // ì»¤ìŠ¤í…€ ì½˜í…ì¸  ëª©ë¡ ì¡°íšŒ
        const { data: customData } = await supabase
          .from("student_custom_contents")
          .select("id, title, content_type, total_page_or_time")
          .eq("student_id", studentId)
          .order("created_at", { ascending: false });

        const custom: ContentWithTotal[] =
          customData?.map((customContent) => ({
            id: customContent.id,
            title: customContent.title || "ì»¤ìŠ¤í…€ ì½˜í…ì¸ ",
            subtitle: customContent.content_type || null,
            total_page_or_time: customContent.total_page_or_time ?? null,
          })) || [];

        setContents({
          books,
          lectures,
          custom,
        });
      } catch (error) {
        console.error("[ContentReplaceModal] ì½˜í…ì¸  ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", error);
      } finally {
        setLoading(false);
      }
    };

    loadContents();
  }, [isOpen, studentId]);

  // í˜„ì¬ íƒ­ì˜ ì½˜í…ì¸  ëª©ë¡
  const currentContents = useMemo(() => {
    const list = contents[activeTab];
    if (!searchQuery.trim()) return list;

    const query = searchQuery.toLowerCase();
    return list.filter(
      (content) =>
        content.title.toLowerCase().includes(query) ||
        content.subtitle?.toLowerCase().includes(query)
    );
  }, [contents, activeTab, searchQuery]);

  // ì½˜í…ì¸  ì„ íƒ í•¸ë“¤ëŸ¬
  const handleContentClick = (content: ContentWithTotal) => {
    setSelectedContent(content);
    // ê¸°ë³¸ ë²”ìœ„ ì„¤ì •
    if (content.total_page_or_time !== null) {
      setRange({
        start: 1,
        end: Math.min(content.total_page_or_time, initialRange?.end ?? content.total_page_or_time),
      });
    } else {
      setRange({
        start: initialRange?.start ?? 1,
        end: initialRange?.end ?? 1,
      });
    }
  };

  const handleConfirm = () => {
    if (!selectedContent) return;

    const contentType =
      activeTab === "books"
        ? "book"
        : activeTab === "lectures"
        ? "lecture"
        : "custom";

    // ë²”ìœ„ ê²€ì¦
    if (selectedContent.total_page_or_time !== null) {
      if (
        range.start < 1 ||
        range.end > selectedContent.total_page_or_time ||
        range.start > range.end
      ) {
        alert(
          `ë²”ìœ„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (1 ~ ${selectedContent.total_page_or_time} ì‚¬ì´, ì‹œì‘ <= ë)`
        );
        return;
      }
    }

    onSelect({
      content_id: selectedContent.id,
      content_type: contentType,
      title: selectedContent.title,
      total_page_or_time: selectedContent.total_page_or_time,
      range,
    });
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="w-full max-w-2xl rounded-lg border border-gray-200 bg-white shadow-lg px-4">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
          <h2 className="text-xl font-bold text-gray-900">ì½˜í…ì¸  êµì²´</h2>
          <button
            onClick={onClose}
            className="rounded-lg p-1 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600"
          >
            <svg
              className="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        {/* íƒ­ ë° ê²€ìƒ‰ */}
        <div className="flex flex-col gap-4 border-b border-gray-200 px-6 py-4">
          <div className="flex gap-2">
            <button
              onClick={() => setActiveTab("books")}
              className={`rounded-lg px-4 py-2 text-sm font-medium transition ${
                activeTab === "books"
                  ? "bg-blue-100 text-blue-700"
                  : "bg-gray-100 text-gray-700 hover:bg-gray-200"
              }`}
            >
              ğŸ“š êµì¬ ({contents.books.length})
            </button>
            <button
              onClick={() => setActiveTab("lectures")}
              className={`rounded-lg px-4 py-2 text-sm font-medium transition ${
                activeTab === "lectures"
                  ? "bg-blue-100 text-blue-700"
                  : "bg-gray-100 text-gray-700 hover:bg-gray-200"
              }`}
            >
              ğŸ¥ ê°•ì˜ ({contents.lectures.length})
            </button>
            <button
              onClick={() => setActiveTab("custom")}
              className={`rounded-lg px-4 py-2 text-sm font-medium transition ${
                activeTab === "custom"
                  ? "bg-blue-100 text-blue-700"
                  : "bg-gray-100 text-gray-700 hover:bg-gray-200"
              }`}
            >
              ğŸ“ ì»¤ìŠ¤í…€ ({contents.custom.length})
            </button>
          </div>

          <input
            type="text"
            placeholder="ì½˜í…ì¸  ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          />
        </div>

        {/* ì½˜í…ì¸  ëª©ë¡ */}
        <div className="max-h-96 overflow-y-auto px-6 py-4">
          {loading ? (
            <div className="py-8 text-center text-sm text-gray-500">
              ì½˜í…ì¸  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
          ) : currentContents.length === 0 ? (
            <div className="py-8 text-center text-sm text-gray-500">
              {searchQuery.trim()
                ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."
                : "ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤."}
            </div>
          ) : (
            <div className="flex flex-col gap-2">
              {currentContents.map((content) => (
                <button
                  key={content.id}
                  onClick={() => handleContentClick(content)}
                  className={`flex items-center justify-between rounded-lg border p-3 text-left transition ${
                    selectedContent?.id === content.id
                      ? "border-blue-500 bg-blue-50"
                      : "border-gray-200 hover:border-blue-300 hover:bg-blue-50"
                  }`}
                >
                  <div className="flex flex-1 flex-col gap-1">
                    <div className="font-medium text-gray-900">
                      {content.title}
                    </div>
                    {content.subtitle && (
                      <div className="text-xs text-gray-500">
                        {content.subtitle}
                      </div>
                    )}
                  </div>
                  <div className="text-sm text-gray-600">
                    {content.total_page_or_time !== null
                      ? activeTab === "books"
                        ? `${content.total_page_or_time}í˜ì´ì§€`
                        : `${content.total_page_or_time}ë¶„`
                      : "ì •ë³´ ì—†ìŒ"}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        {/* ë²”ìœ„ ì…ë ¥ (ì½˜í…ì¸  ì„ íƒ ì‹œ) */}
        {selectedContent && (
          <div className="flex flex-col gap-3 border-t border-gray-200 px-6 py-4">
            <div className="flex flex-col gap-1">
              <h3 className="text-sm font-medium text-gray-900">
                ì„ íƒëœ ì½˜í…ì¸ : {selectedContent.title}
              </h3>
              {selectedContent.total_page_or_time !== null && (
                <p className="text-xs text-gray-500">
                  ì´ëŸ‰:{" "}
                  {activeTab === "books"
                    ? `${selectedContent.total_page_or_time}í˜ì´ì§€`
                    : `${selectedContent.total_page_or_time}ë¶„`}
                </p>
              )}
            </div>
            <div className="flex flex-col gap-3">
              <div className="flex items-center gap-4">
                <label className="text-sm font-medium text-gray-700">
                  ì‹œì‘ ë²”ìœ„:
                </label>
                <input
                  type="number"
                  value={range.start}
                  onChange={(e) =>
                    setRange({
                      ...range,
                      start: parseInt(e.target.value) || 1,
                    })
                  }
                  className="rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  min={1}
                  max={selectedContent.total_page_or_time ?? undefined}
                />
              </div>
              <div className="flex items-center gap-4">
                <label className="text-sm font-medium text-gray-700">
                  ë ë²”ìœ„:
                </label>
                <input
                  type="number"
                  value={range.end}
                  onChange={(e) =>
                    setRange({
                      ...range,
                      end: parseInt(e.target.value) || 1,
                    })
                  }
                  className="rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  min={range.start}
                  max={selectedContent.total_page_or_time ?? undefined}
                />
              </div>
            </div>
          </div>
        )}

        {/* í‘¸í„° */}
        <div className="border-t border-gray-200 px-6 py-4">
          <div className="flex justify-end gap-3">
            <button
              onClick={onClose}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
            >
              ì·¨ì†Œ
            </button>
            <button
              onClick={handleConfirm}
              disabled={!selectedContent}
              className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700 disabled:bg-gray-300 disabled:text-gray-500"
            >
              í™•ì¸
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/ContentSelectStep.tsx">
/**
 * Step 1: ì½˜í…ì¸  ì„ íƒ ì»´í¬ë„ŒíŠ¸
 *
 * ì¬ì¡°ì • ëŒ€ìƒ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ê³  ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useMemo } from "react";
import { ChevronDown, ChevronUp } from "lucide-react";
import { isReschedulable, isCompletedPlan } from "@/lib/utils/planStatusUtils";
import type { PlanContent, PlanGroup } from "@/lib/types/plan";
import { DateRangeSelector } from "./DateRangeSelector";
import { SmartDateRangeSuggestions } from "./SmartDateRangeSuggestions";
import { getTodayDateString, getNextDayString, isDateBefore } from "@/lib/reschedule/periodCalculator";

type DateRange = {
  from: string | null; // YYYY-MM-DD
  to: string | null; // YYYY-MM-DD
};

type ContentSelectStepProps = {
  group: PlanGroup;
  contents: PlanContent[];
  existingPlans: Array<{
    id: string;
    status: string | null;
    is_active: boolean | null;
    content_id: string;
    plan_date: string; // YYYY-MM-DD
  }>;
  onComplete: (
    selectedContentIds: Set<string>,
    rescheduleDateRange: DateRange | null,
    includeToday: boolean
  ) => void;
  initialDateRange?: { from: string; to: string } | null;
};

export function ContentSelectStep({
  group,
  contents,
  existingPlans,
  onComplete,
  initialDateRange,
}: ContentSelectStepProps) {
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [rescheduleMode, setRescheduleMode] = useState<"full" | "range">(
    initialDateRange ? "range" : "full"
  );
  const [rescheduleDateRange, setRescheduleDateRange] = useState<DateRange>(
    initialDateRange
      ? {
          from: initialDateRange.from,
          to: initialDateRange.to,
        }
      : {
          from: null,
          to: null,
        }
  );
  const [dateRangeExpanded, setDateRangeExpanded] = useState(false);
  const [includeToday, setIncludeToday] = useState(false);

  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°„ë‹¨íˆ ê³„ì‚° (ì„œë²„ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ)
  const calculateAdjustedRange = (
    dateRange: DateRange,
    today: string,
    groupEnd: string,
    includeTodayValue: boolean
  ): DateRange | null => {
    if (!dateRange.from || !dateRange.to) {
      return null;
    }
    const startDate = includeTodayValue ? today : getNextDayString(today);
    const adjustedStart = isDateBefore(dateRange.from, startDate) 
      ? startDate 
      : dateRange.from;
    const adjustedEnd = isDateBefore(groupEnd, dateRange.to) 
      ? groupEnd 
      : dateRange.to;
    return { from: adjustedStart, to: adjustedEnd };
  };

  // ì½˜í…ì¸ ë³„ í”Œëœ ìƒíƒœ ê³„ì‚° ë° ì˜í–¥ ë²”ìœ„ ê³„ì‚°
  const contentStatusMap = useMemo(() => {
    const map = new Map<
      string,
      {
        total: number;
        reschedulable: number;
        completed: number;
        status: "available" | "partial" | "unavailable";
        affectedDates: string[];
        affectedDaysCount: number;
        unavailableReason?: string;
      }
    >();

    contents.forEach((content) => {
      const plans = existingPlans.filter(
        (p) => p.content_id === content.content_id
      );

      const reschedulable = plans.filter((p) =>
        isReschedulable({
          status: (p.status as any) || "pending",
          is_active: p.is_active ?? true,
        })
      );

      const completed = plans.filter((p) =>
        isCompletedPlan({
          status: (p.status as any) || "pending",
        })
      ).length;

      let status: "available" | "partial" | "unavailable" = "unavailable";
      let unavailableReason: string | undefined;

      if (reschedulable.length > 0) {
        status =
          reschedulable.length === plans.length ? "available" : "partial";
        // ì˜í–¥ë°›ëŠ” ë‚ ì§œ ê³„ì‚°
        const affectedDates = new Set<string>();
        reschedulable.forEach((plan) => {
          affectedDates.add(plan.plan_date);
        });
        map.set(content.id || content.content_id, {
          total: plans.length,
          reschedulable: reschedulable.length,
          completed,
          status,
          affectedDates: Array.from(affectedDates).sort(),
          affectedDaysCount: affectedDates.size,
        });
      } else {
        // ì¬ì¡°ì • ë¶ˆê°€ ì´ìœ  ì„¤ì •
        if (plans.length === 0) {
          unavailableReason = "í”Œëœì´ ì—†ìŠµë‹ˆë‹¤";
        } else if (completed === plans.length) {
          unavailableReason = "ëª¨ë“  í”Œëœì´ ì™„ë£Œë˜ì–´ ì¬ì¡°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
        } else {
          unavailableReason = "ì¬ì¡°ì • ê°€ëŠ¥í•œ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤";
        }
        map.set(content.id || content.content_id, {
          total: plans.length,
          reschedulable: 0,
          completed,
          status,
          affectedDates: [],
          affectedDaysCount: 0,
          unavailableReason,
        });
      }
    });

    return map;
  }, [contents, existingPlans]);

  const handleToggle = (contentId: string) => {
    const status = contentStatusMap.get(contentId);
    if (!status || status.status === "unavailable") {
      return; // ì„ íƒ ë¶ˆê°€
    }

    const newSet = new Set(selectedIds);
    if (newSet.has(contentId)) {
      newSet.delete(contentId);
    } else {
      newSet.add(contentId);
    }
    setSelectedIds(newSet);
  };

  const handleNext = () => {
    if (selectedIds.size === 0) {
      alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    if (rescheduleMode === "range") {
      if (!rescheduleDateRange.from || !rescheduleDateRange.to) {
        alert("ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
    }

    onComplete(selectedIds, rescheduleMode === "range" ? rescheduleDateRange : null, includeToday);
  };

  const availableCount = Array.from(contentStatusMap.values()).filter(
    (s) => s.status !== "unavailable"
  ).length;

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-bold text-gray-900">ì½˜í…ì¸  ì„ íƒ</h2>
        <p className="text-sm text-gray-600">
          ì¬ì¡°ì •í•  ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ì™„ë£Œëœ í”Œëœì€ ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.
        </p>
      </div>

      {availableCount === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-6 text-center">
          <p className="text-sm text-gray-600">
            ì¬ì¡°ì • ê°€ëŠ¥í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.
            <br />
            ëª¨ë“  í”Œëœì´ ì™„ë£Œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      ) : (
        <>
          <div className="flex flex-col gap-3">
            {contents.map((content) => {
              const contentId = content.id || content.content_id;
              const status = contentStatusMap.get(contentId);
              const isSelected = selectedIds.has(contentId);
              const isDisabled = !status || status.status === "unavailable";

              return (
                <label
                  key={contentId}
                  className={`flex cursor-pointer items-center gap-4 rounded-lg border p-4 transition ${
                    isSelected
                      ? "border-blue-500 bg-blue-50"
                      : isDisabled
                      ? "border-gray-200 bg-gray-50 opacity-50"
                      : "border-gray-200 bg-white hover:border-gray-300"
                  }`}
                  aria-label={`${
                    content.content_type === "book"
                      ? "êµì¬"
                      : content.content_type === "lecture"
                      ? "ê°•ì˜"
                      : "ì»¤ìŠ¤í…€"
                  } ì½˜í…ì¸  ì„ íƒ`}
                >
                  <input
                    type="checkbox"
                    checked={isSelected}
                    onChange={() => handleToggle(contentId)}
                    disabled={isDisabled}
                    className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    aria-label={`${
                      content.content_type === "book"
                        ? "êµì¬"
                        : content.content_type === "lecture"
                        ? "ê°•ì˜"
                        : "ì»¤ìŠ¤í…€"
                    } ì½˜í…ì¸  ${isSelected ? "ì„ íƒ í•´ì œ" : "ì„ íƒ"}`}
                  />
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <span className="font-medium text-gray-900">
                        {content.content_type === "book"
                          ? "ğŸ“š êµì¬"
                          : content.content_type === "lecture"
                          ? "ğŸ¥ ê°•ì˜"
                          : "ğŸ“ ì»¤ìŠ¤í…€"}
                      </span>
                      <span className="text-sm text-gray-600">
                        {content.start_range} ~ {content.end_range}
                      </span>
                    </div>
                    {status && (
                      <div className="flex flex-col gap-1">
                        <div className="flex items-center gap-2 text-xs text-gray-500">
                          <span
                            className={`rounded px-2 py-0.5 ${
                              status.status === "available"
                                ? "bg-green-100 text-green-700"
                                : status.status === "partial"
                                ? "bg-yellow-100 text-yellow-700"
                                : "bg-gray-100 text-gray-700"
                            }`}
                          >
                            {status.status === "available"
                              ? "ì¬ì¡°ì • ê°€ëŠ¥"
                              : status.status === "partial"
                              ? "ë¶€ë¶„ ì¬ì¡°ì •"
                              : "ì¬ì¡°ì • ë¶ˆê°€"}
                          </span>
                          <span>
                            ì´ {status.total}ê°œ / ì¬ì¡°ì • ê°€ëŠ¥{" "}
                            {status.reschedulable}ê°œ / ì™„ë£Œ {status.completed}ê°œ
                          </span>
                        </div>
                        {status.status === "unavailable" &&
                          status.unavailableReason && (
                            <div className="text-xs text-red-600">
                              âš ï¸ {status.unavailableReason}
                            </div>
                          )}
                        {isSelected && status.affectedDaysCount > 0 && (
                          <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-2 text-xs">
                            <div className="font-medium text-blue-900">
                              ğŸ’¡ ì˜í–¥ ë²”ìœ„ ë¯¸ë¦¬ë³´ê¸°
                            </div>
                            <div className="text-blue-700">
                              ì´ ì½˜í…ì¸ ëŠ” {status.affectedDaysCount}ì¼ê°„ì˜
                              í”Œëœì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤
                            </div>
                            {status.affectedDates.length > 0 &&
                              status.affectedDates.length <= 5 && (
                                <div className="text-blue-600">
                                  ì˜í–¥ë°›ëŠ” ë‚ ì§œ:{" "}
                                  {status.affectedDates.join(", ")}
                                </div>
                              )}
                            {status.affectedDates.length > 5 && (
                              <div className="text-blue-600">
                                ì˜í–¥ë°›ëŠ” ë‚ ì§œ:{" "}
                                {status.affectedDates.slice(0, 3).join(", ")} ì™¸{" "}
                                {status.affectedDates.length - 3}ì¼
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </label>
              );
            })}
          </div>

          {/* ì„ íƒí•œ ë‚ ì§œ ë²”ìœ„ ìš”ì•½ (ë‚ ì§œ ë²”ìœ„ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) */}
          {rescheduleMode === "range" && rescheduleDateRange.from && rescheduleDateRange.to && (
            <div className="sticky top-0 z-10 rounded-lg border border-blue-200 bg-blue-50 p-4">
              <div className="flex items-center justify-between">
                <div className="flex flex-col gap-1">
                  <div className="text-sm font-medium text-blue-900">
                    ì„ íƒí•œ ë‚ ì§œ ë²”ìœ„
                  </div>
                  <div className="text-sm text-blue-700">
                    {rescheduleDateRange.from} ~ {rescheduleDateRange.to}
                  </div>
                </div>
                <button
                  type="button"
                  onClick={() => {
                    setRescheduleDateRange({ from: null, to: null });
                  }}
                  className="rounded-lg px-3 py-1.5 text-xs font-medium text-blue-700 hover:bg-blue-100 transition"
                >
                  ì´ˆê¸°í™”
                </button>
              </div>
            </div>
          )}

          {/* ì¬ì¡°ì •í•  í”Œëœ ë²”ìœ„ ì„ íƒ */}
          <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
            <h3 className="text-sm font-semibold text-gray-900">
              ì¬ì¡°ì •í•  í”Œëœ ë²”ìœ„ ì„ íƒ
            </h3>
            <div className="flex flex-col gap-3">
              <label
                className="flex cursor-pointer items-center gap-3 rounded-lg border p-3 transition hover:bg-gray-50"
                aria-label="ì „ì²´ ì¬ìƒì„± ëª¨ë“œ ì„ íƒ"
              >
                <input
                  type="radio"
                  name="rescheduleMode"
                  value="full"
                  checked={rescheduleMode === "full"}
                  onChange={() => {
                    setRescheduleMode("full");
                    setDateRangeExpanded(false);
                  }}
                  className="h-4 w-4 text-blue-600 focus:ring-blue-500"
                  aria-label="ì „ì²´ ì¬ìƒì„±"
                />
                <div className="flex-1">
                  <div className="font-medium text-gray-900">ì „ì²´ ê¸°ê°„</div>
                  <div className="text-xs text-gray-600">
                    ëª¨ë“  ê¸°ê°„ì˜ í”Œëœì„ ì¬ì¡°ì •í•©ë‹ˆë‹¤ (ì™„ë£Œëœ í”Œëœ ì œì™¸)
                  </div>
                </div>
              </label>
              <label
                className="flex cursor-pointer items-center gap-3 rounded-lg border p-3 transition hover:bg-gray-50"
                aria-label="ë‚ ì§œ ë²”ìœ„ ì„ íƒ ëª¨ë“œ ì„ íƒ"
              >
                <input
                  type="radio"
                  name="rescheduleMode"
                  value="range"
                  checked={rescheduleMode === "range"}
                  onChange={() => {
                    setRescheduleMode("range");
                    setDateRangeExpanded(true);
                  }}
                  className="h-4 w-4 text-blue-600 focus:ring-blue-500"
                  aria-label="ë‚ ì§œ ë²”ìœ„ ì„ íƒ"
                />
                <div className="flex-1">
                  <div className="font-medium text-gray-900">
                    ë‚ ì§œ ë²”ìœ„ ì„ íƒ
                  </div>
                  <div className="text-xs text-gray-600">
                    ì–´ë–¤ ë‚ ì§œì˜ ê¸°ì¡´ í”Œëœì„ ì¬ì¡°ì •í• ì§€ ì„ íƒí•©ë‹ˆë‹¤ (ê³¼ê±° ë‚ ì§œ í¬í•¨ ê°€ëŠ¥)
                  </div>
                </div>
              </label>
            </div>

            {/* ë‚ ì§œ ë²”ìœ„ ì„ íƒ UI (ì ‘ì´ì‹ íŒ¨ë„) */}
            {rescheduleMode === "range" && (
              <div>
                <button
                  type="button"
                  onClick={() => setDateRangeExpanded(!dateRangeExpanded)}
                  className="flex w-full items-center justify-between rounded-lg border border-gray-300 bg-gray-50 p-3 transition hover:bg-gray-100"
                  aria-expanded={dateRangeExpanded}
                  aria-controls="date-range-panel"
                >
                  <span className="text-sm font-medium text-gray-900">
                    ë‚ ì§œ ë²”ìœ„ ì„ íƒ
                  </span>
                  {dateRangeExpanded ? (
                    <ChevronUp
                      className="h-5 w-5 text-gray-600"
                      aria-hidden="true"
                    />
                  ) : (
                    <ChevronDown
                      className="h-5 w-5 text-gray-600"
                      aria-hidden="true"
                    />
                  )}
                </button>

                {dateRangeExpanded && (
                  <div
                    id="date-range-panel"
                    className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4"
                    role="region"
                    aria-label="ë‚ ì§œ ë²”ìœ„ ì„ íƒ íŒ¨ë„"
                  >
                    {/* ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ */}
                    {selectedIds.size > 0 && (
                      <SmartDateRangeSuggestions
                        group={group}
                        contents={contents}
                        selectedContentIds={selectedIds}
                        existingPlans={existingPlans}
                        onSelectRange={(range) => {
                          setRescheduleDateRange(range);
                        }}
                      />
                    )}

                    {/* ë‚ ì§œ ë²”ìœ„ ì„ íƒ ìº˜ë¦°ë” */}
                    <DateRangeSelector
                      groupPeriodStart={group.period_start}
                      groupPeriodEnd={group.period_end}
                      existingPlans={existingPlans}
                      onRangeChange={setRescheduleDateRange}
                      initialRange={rescheduleDateRange}
                    />
                  </div>
                )}
              </div>
            )}

            {/* ìë™ ì¡°ì • ì•ˆë‚´ */}
            {rescheduleMode === "range" && rescheduleDateRange.from && rescheduleDateRange.to && (
              <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-3">
                <div className="flex items-start gap-2">
                  <span className="text-blue-600">ğŸ’¡</span>
                  <div className="flex flex-1 flex-col gap-1">
                    <div className="text-sm font-medium text-blue-900">
                      ìë™ ì¡°ì • ì•ˆë‚´
                    </div>
                    <div className="text-xs text-blue-700">
                      {(() => {
                        const today = getTodayDateString();
                        const tomorrow = getNextDayString(today);
                        const isPastDate = isDateBefore(rescheduleDateRange.from!, tomorrow);
                        
                        if (isPastDate) {
                          return `ê³¼ê±° ë‚ ì§œë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì¬ì¡°ì • í”Œëœì€ ìë™ìœ¼ë¡œ ${tomorrow}ë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤.`;
                        }
                        return "ì„ íƒí•œ ë‚ ì§œ ë²”ìœ„ì— ë”°ë¼ ì¬ì¡°ì •ì´ ì§„í–‰ë©ë‹ˆë‹¤.";
                      })()}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ì‹¤ì œ ì¡°ì •ëœ ë²”ìœ„ ë¯¸ë¦¬ë³´ê¸° */}
            {rescheduleMode === "range" && rescheduleDateRange.from && rescheduleDateRange.to && (
              <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-3">
                <div className="text-xs text-gray-600">
                  <div className="font-medium text-gray-700">ì‹¤ì œ ì¬ì¡°ì • ë²”ìœ„</div>
                  <div className="text-gray-600">
                    {(() => {
                      const today = getTodayDateString();
                      const adjustedRange = calculateAdjustedRange(
                        rescheduleDateRange,
                        today,
                        group.period_end,
                        includeToday
                      );
                      if (adjustedRange && adjustedRange.from && adjustedRange.to) {
                        return `${adjustedRange.from} ~ ${adjustedRange.to}`;
                      }
                      return "ê³„ì‚° ì¤‘...";
                    })()}
                  </div>
                </div>
              </div>
            )}

            {/* ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨ ì˜µì…˜ */}
            <div className="rounded-lg border border-gray-200 bg-white p-4">
              <label className="flex cursor-pointer items-start gap-3">
                <input
                  type="checkbox"
                  checked={includeToday}
                  onChange={(e) => setIncludeToday(e.target.checked)}
                  className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  aria-label="ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨"
                />
                <div className="flex flex-1 flex-col gap-1">
                  <div className="font-medium text-gray-900">ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨</div>
                  <div className="text-xs text-gray-600">
                    ì˜¤ëŠ˜ ë‚ ì§œì˜ í”Œëœë„ ì¬ì¡°ì • ëŒ€ìƒì— í¬í•¨ë©ë‹ˆë‹¤. ì´ë¯¸ ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ í”Œëœì€ ì œì™¸ë©ë‹ˆë‹¤.
                  </div>
                </div>
              </label>
            </div>
          </div>

          {/* ì„ íƒí•œ ì½˜í…ì¸  ìš”ì•½ ì¹´ë“œ */}
          {selectedIds.size > 0 && (
            <div className="sticky bottom-0 rounded-lg border border-blue-200 bg-blue-50 p-4">
              <div className="flex items-center justify-between">
                <div className="flex flex-col gap-1">
                  <div className="font-medium text-blue-900">
                    ì„ íƒí•œ ì½˜í…ì¸  ìš”ì•½
                  </div>
                  <div className="text-sm text-blue-700">
                    {selectedIds.size}ê°œì˜ ì½˜í…ì¸ ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤
                  </div>
                  <div className="text-xs text-blue-600">
                    ì´ ì˜í–¥ë°›ëŠ” ë‚ ì§œ:{" "}
                    {(() => {
                      const allDates = new Set<string>();
                      selectedIds.forEach((id) => {
                        const status = contentStatusMap.get(id);
                        if (status) {
                          status.affectedDates.forEach((date) =>
                            allDates.add(date)
                          );
                        }
                      });
                      return allDates.size;
                    })()}
                    ì¼
                  </div>
                </div>
                <button
                  onClick={() => setSelectedIds(new Set())}
                  className="rounded-lg border border-blue-300 bg-white px-3 py-1.5 text-xs font-medium text-blue-700 transition hover:bg-blue-100"
                >
                  ëª¨ë‘ í•´ì œ
                </button>
              </div>
            </div>
          )}

          <div className="flex justify-end gap-3">
            <button
              onClick={handleNext}
              disabled={
                selectedIds.size === 0 ||
                (rescheduleMode === "range" &&
                  (!rescheduleDateRange.from || !rescheduleDateRange.to))
              }
              className="rounded-lg bg-blue-600 px-6 py-2 text-sm font-medium text-white transition hover:bg-blue-700 disabled:bg-gray-300 disabled:text-gray-500"
              aria-label={`ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ (${selectedIds.size}ê°œ ì½˜í…ì¸  ì„ íƒë¨)`}
            >
              ë‹¤ìŒ ({selectedIds.size}ê°œ ì„ íƒë¨)
            </button>
          </div>
        </>
      )}
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/DateRangeSelector.tsx">
/**
 * ë‚ ì§œ ë²”ìœ„ ì„ íƒ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì •í•  ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
 * ì™„ë£Œëœ í”Œëœì´ ìˆëŠ” ë‚ ì§œëŠ” ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.
 */

"use client";

import { useState, useMemo } from "react";
import { format, parseISO, isAfter, isBefore, isSameDay, startOfMonth, endOfMonth, eachDayOfInterval } from "date-fns";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { isCompletedPlan } from "@/lib/utils/planStatusUtils";

type DateRange = {
  from: string | null; // YYYY-MM-DD
  to: string | null; // YYYY-MM-DD
};

type DateRangeSelectorProps = {
  groupPeriodStart: string; // YYYY-MM-DD
  groupPeriodEnd: string; // YYYY-MM-DD
  existingPlans: Array<{
    id: string;
    plan_date: string; // YYYY-MM-DD
    status: string | null;
    is_active: boolean | null;
  }>;
  onRangeChange: (range: DateRange) => void;
  initialRange?: DateRange;
  minDate?: string; // YYYY-MM-DD, ìµœì†Œ ì„ íƒ ê°€ëŠ¥ ë‚ ì§œ
};

export function DateRangeSelector({
  groupPeriodStart,
  groupPeriodEnd,
  existingPlans,
  onRangeChange,
  initialRange,
  minDate,
}: DateRangeSelectorProps) {
  const [currentMonth, setCurrentMonth] = useState(() => {
    const start = parseISO(groupPeriodStart);
    return new Date(start.getFullYear(), start.getMonth(), 1);
  });
  const [selectedRange, setSelectedRange] = useState<DateRange>(
    initialRange || { from: null, to: null }
  );
  const [selectingStart, setSelectingStart] = useState(true);

  // ì™„ë£Œëœ í”Œëœì´ ìˆëŠ” ë‚ ì§œ ëª©ë¡
  const completedPlanDates = useMemo(() => {
    const dates = new Set<string>();
    existingPlans.forEach((plan) => {
      if (isCompletedPlan({ status: plan.status as any })) {
        dates.add(plan.plan_date);
      }
    });
    return dates;
  }, [existingPlans]);

  // í”Œëœ ê·¸ë£¹ ê¸°ê°„ ë‚´ì˜ ëª¨ë“  ë‚ ì§œ
  const periodDates = useMemo(() => {
    const start = parseISO(groupPeriodStart);
    const end = parseISO(groupPeriodEnd);
    return eachDayOfInterval({ start, end });
  }, [groupPeriodStart, groupPeriodEnd]);

  // ë‚ ì§œê°€ ì„ íƒ ê°€ëŠ¥í•œì§€ í™•ì¸
  const isDateSelectable = (date: Date): boolean => {
    const dateStr = format(date, "yyyy-MM-dd");
    
    // minDate ì²´í¬: minDateê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ ì´ì „ì€ ì„ íƒ ë¶ˆê°€
    if (minDate && isBefore(date, parseISO(minDate))) {
      return false;
    }
    
    // ì™„ë£Œëœ í”Œëœì´ ìˆëŠ” ë‚ ì§œëŠ” ì„ íƒ ë¶ˆê°€
    if (completedPlanDates.has(dateStr)) {
      return false;
    }
    // í”Œëœ ê·¸ë£¹ ê¸°ê°„ ë‚´ì˜ ë‚ ì§œë§Œ ì„ íƒ ê°€ëŠ¥
    const dateInPeriod = periodDates.some((d) => isSameDay(d, date));
    return dateInPeriod;
  };

  // ë‚ ì§œ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleDateClick = (date: Date) => {
    if (!isDateSelectable(date)) {
      return;
    }

    const dateStr = format(date, "yyyy-MM-dd");

    if (selectingStart || !selectedRange.from) {
      // ì‹œì‘ ë‚ ì§œ ì„ íƒ
      setSelectedRange({ from: dateStr, to: null });
      setSelectingStart(false);
      onRangeChange({ from: dateStr, to: null });
    } else {
      // ì¢…ë£Œ ë‚ ì§œ ì„ íƒ
      const fromDate = parseISO(selectedRange.from!);
      
      if (isBefore(date, fromDate)) {
        // ì¢…ë£Œ ë‚ ì§œê°€ ì‹œì‘ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ë©´ ì‹œì‘ ë‚ ì§œë¡œ ë³€ê²½
        setSelectedRange({ from: dateStr, to: null });
        setSelectingStart(false);
        onRangeChange({ from: dateStr, to: null });
      } else {
        // ì •ìƒì ì¸ ë²”ìœ„ ì„ íƒ
        const toDateStr = format(date, "yyyy-MM-dd");
        setSelectedRange({ from: selectedRange.from, to: toDateStr });
        setSelectingStart(true);
        onRangeChange({ from: selectedRange.from, to: toDateStr });
      }
    }
  };

  // ë‚ ì§œê°€ ì„ íƒëœ ë²”ìœ„ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
  const isDateInRange = (date: Date): boolean => {
    if (!selectedRange.from) return false;
    const dateStr = format(date, "yyyy-MM-dd");
    const fromDate = parseISO(selectedRange.from);
    
    if (!selectedRange.to) {
      return isSameDay(date, fromDate);
    }
    
    const toDate = parseISO(selectedRange.to);
    return (
      (isAfter(date, fromDate) || isSameDay(date, fromDate)) &&
      (isBefore(date, toDate) || isSameDay(date, toDate))
    );
  };

  // ë‚ ì§œê°€ ë²”ìœ„ì˜ ì‹œì‘/ì¢…ë£Œì¸ì§€ í™•ì¸
  const isRangeStart = (date: Date): boolean => {
    if (!selectedRange.from) return false;
    return isSameDay(date, parseISO(selectedRange.from));
  };

  const isRangeEnd = (date: Date): boolean => {
    if (!selectedRange.to) return false;
    return isSameDay(date, parseISO(selectedRange.to));
  };

  // ì´ì „ ë‹¬ë¡œ ì´ë™
  const goToPreviousMonth = () => {
    setCurrentMonth((prev) => {
      const newMonth = new Date(prev.getFullYear(), prev.getMonth() - 1, 1);
      const periodStart = parseISO(groupPeriodStart);
      if (isBefore(newMonth, startOfMonth(periodStart))) {
        return startOfMonth(periodStart);
      }
      return newMonth;
    });
  };

  // ë‹¤ìŒ ë‹¬ë¡œ ì´ë™
  const goToNextMonth = () => {
    setCurrentMonth((prev) => {
      const newMonth = new Date(prev.getFullYear(), prev.getMonth() + 1, 1);
      const periodEnd = parseISO(groupPeriodEnd);
      if (isAfter(newMonth, endOfMonth(periodEnd))) {
        return endOfMonth(periodEnd);
      }
      return newMonth;
    });
  };

  // ìº˜ë¦°ë” ë Œë”ë§
  const renderCalendar = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const weekdays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    const days: (Date | null)[] = [];

    // ì²« ì£¼ì˜ ë¹ˆ ì…€
    for (let i = 0; i < startDayOfWeek; i++) {
      days.push(null);
    }

    // ë‚ ì§œ ì…€
    for (let day = 1; day <= daysInMonth; day++) {
      days.push(new Date(year, month, day));
    }

    return (
      <div className="flex w-full flex-col gap-2">
        {/* ìš”ì¼ í—¤ë” */}
        <div className="grid grid-cols-7 gap-1">
          {weekdays.map((day) => (
            <div
              key={day}
              className="py-2 text-center text-sm font-semibold text-gray-700"
            >
              {day}
            </div>
          ))}
        </div>

        {/* ë‚ ì§œ ê·¸ë¦¬ë“œ */}
        <div className="grid grid-cols-7 gap-1 sm:gap-2">
          {days.map((date, index) => {
            if (!date) {
              return <div key={`empty-${index}`} className="h-8 sm:h-10" />;
            }

            const dateStr = format(date, "yyyy-MM-dd");
            const isSelectable = isDateSelectable(date);
            const inRange = isDateInRange(date);
            const isStart = isRangeStart(date);
            const isEnd = isRangeEnd(date);
            const isCompleted = completedPlanDates.has(dateStr);
            const isToday = isSameDay(date, new Date());
            const isOutsidePeriod = !periodDates.some((d) => isSameDay(d, date));
            const isBeforeMinDate = minDate ? isBefore(date, parseISO(minDate)) : false;

            return (
              <button
                key={dateStr}
                type="button"
                onClick={() => handleDateClick(date)}
                disabled={!isSelectable}
                className={`
                  h-8 sm:h-10 rounded-lg text-xs sm:text-sm font-medium transition
                  ${!isSelectable || isOutsidePeriod || isBeforeMinDate
                    ? "bg-gray-50 text-gray-300 cursor-not-allowed"
                    : isCompleted
                    ? "bg-gray-100 text-gray-400 cursor-not-allowed"
                    : inRange
                    ? isStart || isEnd
                      ? "bg-blue-600 text-white hover:bg-blue-700"
                      : "bg-blue-100 text-blue-700 hover:bg-blue-200"
                    : isToday
                    ? "bg-gray-200 text-gray-900 hover:bg-gray-300"
                    : "bg-white text-gray-900 hover:bg-gray-100 border border-gray-200"
                  }
                `}
                title={
                  isCompleted
                    ? "ì™„ë£Œëœ í”Œëœì´ ìˆì–´ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                    : isBeforeMinDate
                    ? "ìµœì†Œ ì„ íƒ ê°€ëŠ¥ ë‚ ì§œ ì´ì „ì…ë‹ˆë‹¤"
                    : isOutsidePeriod
                    ? "í”Œëœ ê·¸ë£¹ ê¸°ê°„ ë°–ì…ë‹ˆë‹¤"
                    : undefined
                }
              >
                {date.getDate()}
              </button>
            );
          })}
        </div>
      </div>
    );
  };

  return (
    <div className="flex flex-col gap-4">
      {/* ì„ íƒëœ ë²”ìœ„ í‘œì‹œ */}
      {selectedRange.from && (
        <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-blue-900">ì„ íƒëœ ë‚ ì§œ ë²”ìœ„</p>
              <p className="text-sm text-blue-700">
                {selectedRange.from}
                {selectedRange.to ? ` ~ ${selectedRange.to}` : " (ì¢…ë£Œ ë‚ ì§œ ì„ íƒ ì¤‘...)"}
              </p>
            </div>
            <button
              type="button"
              onClick={() => {
                setSelectedRange({ from: null, to: null });
                setSelectingStart(true);
                onRangeChange({ from: null, to: null });
              }}
              className="rounded-lg px-3 py-1 text-sm font-medium text-blue-700 hover:bg-blue-100 transition"
            >
              ì´ˆê¸°í™”
            </button>
          </div>
        </div>
      )}

      {/* ìº˜ë¦°ë” */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4">
        {/* ì›” ë„¤ë¹„ê²Œì´ì…˜ */}
        <div className="flex items-center justify-between">
          <button
            type="button"
            onClick={goToPreviousMonth}
            className="rounded-lg p-2 hover:bg-gray-100 transition"
            disabled={
              isSameDay(
                startOfMonth(currentMonth),
                startOfMonth(parseISO(groupPeriodStart))
              )
            }
          >
            <ChevronLeft className="h-5 w-5 text-gray-600" />
          </button>
          <h3 className="text-lg font-semibold text-gray-900">
            {format(currentMonth, "yyyyë…„ Mì›”")}
          </h3>
          <button
            type="button"
            onClick={goToNextMonth}
            className="rounded-lg p-2 hover:bg-gray-100 transition"
            disabled={
              isSameDay(
                endOfMonth(currentMonth),
                endOfMonth(parseISO(groupPeriodEnd))
              )
            }
          >
            <ChevronRight className="h-5 w-5 text-gray-600" />
          </button>
        </div>

        {renderCalendar()}
      </div>

      {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <p className="text-xs text-gray-600">
          ğŸ’¡ ì‹œì‘ ë‚ ì§œë¥¼ í´ë¦­í•œ í›„ ì¢…ë£Œ ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ë‚ ì§œ ë²”ìœ„ê°€ ì„ íƒë©ë‹ˆë‹¤.
          <br />
          ì™„ë£Œëœ í”Œëœì´ ìˆëŠ” ë‚ ì§œëŠ” íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë©° ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/JobProgress.tsx">
/**
 * ì¬ì¡°ì • Job ì§„í–‰ ìƒí™© UI ì»´í¬ë„ŒíŠ¸
 * 
 * ë¹„ë™ê¸° ì¬ì¡°ì • ì‘ì—…ì˜ ì§„í–‰ ìƒí™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { getRescheduleJobStatus } from "@/lib/reschedule/jobQueue";
import { useToast } from "@/components/ui/ToastProvider";
import type { RescheduleJob } from "@/lib/reschedule/jobQueue";
import { ProgressBar } from "@/components/atoms/ProgressBar";

type JobProgressProps = {
  jobId: string;
  groupId: string;
};

export function JobProgress({ jobId, groupId }: JobProgressProps) {
  const router = useRouter();
  const toast = useToast();
  const [job, setJob] = useState<RescheduleJob | null>(null);
  const [loading, setLoading] = useState(true);
  const [polling, setPolling] = useState(true);

  useEffect(() => {
    if (!polling) return;

    const pollJobStatus = async () => {
      try {
        const status = await getRescheduleJobStatus(jobId);
        setJob(status);
        setLoading(false);

        if (status) {
          // ì™„ë£Œ ë˜ëŠ” ì‹¤íŒ¨ ì‹œ í´ë§ ì¤‘ì§€
          if (status.status === "completed" || status.status === "failed") {
            setPolling(false);

            if (status.status === "completed") {
              toast.showSuccess("ì¬ì¡°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
              router.push(`/plan/group/${groupId}`);
            } else {
              toast.showError(status.error || "ì¬ì¡°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          }
        }
      } catch (error) {
        console.error("[JobProgress] ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:", error);
        setLoading(false);
        setPolling(false);
      }
    };

    // ì´ˆê¸° ì¡°íšŒ
    pollJobStatus();

    // 2ì´ˆë§ˆë‹¤ í´ë§ (ì§„í–‰ ì¤‘ì¸ ê²½ìš°)
    const interval = setInterval(() => {
      if (polling) {
        pollJobStatus();
      }
    }, 2000);

    return () => clearInterval(interval);
  }, [jobId, groupId, polling, router, toast]);

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="flex flex-col gap-4 text-center">
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"></div>
          <p className="text-sm text-gray-600">ì‘ì—… ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  if (!job) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-6 text-center">
        <p className="text-sm text-gray-600">ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  const getStatusLabel = (status: string) => {
    switch (status) {
      case "pending":
        return "ëŒ€ê¸° ì¤‘";
      case "processing":
        return "ì²˜ë¦¬ ì¤‘";
      case "completed":
        return "ì™„ë£Œ";
      case "failed":
        return "ì‹¤íŒ¨";
      default:
        return status;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "pending":
        return "bg-gray-100 text-gray-700";
      case "processing":
        return "bg-blue-100 text-blue-700";
      case "completed":
        return "bg-green-100 text-green-700";
      case "failed":
        return "bg-red-100 text-red-700";
      default:
        return "bg-gray-100 text-gray-700";
    }
  };

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex flex-col gap-1">
        <h3 className="text-lg font-semibold text-gray-900">ì¬ì¡°ì • ì§„í–‰ ìƒí™©</h3>
        <p className="text-sm text-gray-600">ì‘ì—… ID: {jobId}</p>
      </div>

      <div className="flex flex-col gap-4">
        {/* ìƒíƒœ */}
        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-gray-700">ìƒíƒœ</span>
            <span
              className={`rounded px-2 py-1 text-xs font-medium ${getStatusColor(
                job.status
              )}`}
            >
              {getStatusLabel(job.status)}
            </span>
          </div>
        </div>

        {/* ì§„í–‰ë¥  */}
        {job.status === "processing" && (
          <div className="flex flex-col gap-2">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium text-gray-700">ì§„í–‰ë¥ </span>
              <span className="text-sm text-gray-600">{job.progress}%</span>
            </div>
            <ProgressBar
              value={job.progress}
              color="blue"
              size="sm"
            />
          </div>
        )}

        {/* ì˜ˆìƒ ì†Œìš” ì‹œê°„ */}
        {job.estimatedDuration && job.status === "processing" && (
          <div className="text-sm text-gray-600">
            ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ {Math.ceil(job.estimatedDuration / 60)}ë¶„
          </div>
        )}

        {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
        {job.status === "failed" && job.error && (
          <div className="rounded-lg border border-red-200 bg-red-50 p-4">
            <p className="text-sm text-red-800">{job.error}</p>
          </div>
        )}

        {/* ê²°ê³¼ */}
        {job.status === "completed" && job.result && (
          <div className="flex flex-col gap-1 rounded-lg border border-green-200 bg-green-50 p-4">
            <p className="text-sm font-medium text-green-800">
              ì¬ì¡°ì • ì™„ë£Œ
            </p>
            <p className="text-xs text-green-700">
              ê¸°ì¡´ í”Œëœ: {job.result.plans_before_count}ê°œ â†’ ìƒˆ í”Œëœ:{" "}
              {job.result.plans_after_count}ê°œ
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/PreviewStep.tsx">
/**
 * Step 3: ë¯¸ë¦¬ë³´ê¸° & í™•ì¸ ì»´í¬ë„ŒíŠ¸
 *
 * ì¬ì¡°ì • ê²°ê³¼ë¥¼ ë¯¸ë¦¬ë³´ê³  ìµœì¢… í™•ì¸í•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect, useMemo, useCallback, useRef } from "react";
import { useRouter } from "next/navigation";
import {
  getReschedulePreview,
  rescheduleContents,
} from "@/app/(student)/actions/plan-groups/reschedule";
import { useToast } from "@/components/ui/ToastProvider";
import type { AdjustmentInput } from "@/lib/reschedule/scheduleEngine";
import type { ReschedulePreviewResult } from "@/app/(student)/actions/plan-groups/reschedule";
import { BeforeAfterComparison } from "./BeforeAfterComparison";
import { AffectedPlansList } from "./AffectedPlansList";
import { ConflictWarning } from "./ConflictWarning";
import {
  detectAllConflicts,
  type PlanWithTime,
} from "@/lib/reschedule/conflictDetector";

type PreviewStepProps = {
  groupId: string;
  adjustments: AdjustmentInput[];
  rescheduleDateRange?: { from: string; to: string } | null;
  placementDateRange?: { from: string; to: string } | null;
  includeToday?: boolean;
  onLoad: (preview: ReschedulePreviewResult) => void;
  previewResult: ReschedulePreviewResult | null;
};

export function PreviewStep({
  groupId,
  adjustments,
  rescheduleDateRange,
  placementDateRange,
  includeToday = false,
  onLoad,
  previewResult: initialPreview,
}: PreviewStepProps) {
  const router = useRouter();
  const toast = useToast();
  const [loading, setLoading] = useState(!initialPreview);
  const [preview, setPreview] = useState<ReschedulePreviewResult | null>(
    initialPreview
  );
  const [executing, setExecuting] = useState(false);
  const [confirmDialogOpen, setConfirmDialogOpen] = useState(false);
  const loadAttemptedRef = useRef(false); // ë¡œë“œ ì‹œë„ ì—¬ë¶€ ì¶”ì 
  const isLoadingRef = useRef(false); // ë¡œë”© ìƒíƒœë¥¼ refë¡œ ì¶”ì 
  const adjustmentsRef = useRef(adjustments); // ìµœì‹  adjustments ê°’ì„ ì €ì¥
  const dateRangeRef = useRef(rescheduleDateRange || placementDateRange || null); // ìµœì‹  dateRange ê°’ì„ ì €ì¥

  // adjustmentsì™€ dateRange ë³€ê²½ ì‹œ ref ì—…ë°ì´íŠ¸
  useEffect(() => {
    adjustmentsRef.current = adjustments;
    // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ rescheduleDateRange ë˜ëŠ” placementDateRangeë¥¼ dateRangeRefì— ì €ì¥
    dateRangeRef.current = rescheduleDateRange || placementDateRange || null;
  }, [adjustments, rescheduleDateRange, placementDateRange]);

  // ì¶©ëŒ ê°ì§€ (ì‹¤ì œ í”Œëœ ë°ì´í„° ì‚¬ìš©)
  const conflicts = useMemo(() => {
    if (!preview || !preview.plans_after || preview.plans_after.length === 0) {
      return [];
    }

    // í”Œëœ ë°ì´í„°ë¥¼ PlanWithTime í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const plansWithTime: PlanWithTime[] = preview.plans_after.map((plan) => ({
      id: `${plan.plan_date}-${plan.content_id}-${plan.planned_start_page_or_time}`,
      plan_date: plan.plan_date,
      start_time: plan.start_time || null,
      end_time: plan.end_time || null,
      content_id: plan.content_id,
      content_type: plan.content_type,
    }));

    // ë‚ ì§œë³„ í”Œëœ í†µê³„ ë§µ ìƒì„±
    const datePlansMap = new Map<
      string,
      { totalHours: number; planCount: number }
    >();

    preview.plans_after.forEach((plan) => {
      if (!datePlansMap.has(plan.plan_date)) {
        datePlansMap.set(plan.plan_date, {
          totalHours: 0,
          planCount: 0,
        });
      }

      const dateData = datePlansMap.get(plan.plan_date)!;
      dateData.planCount++;

      if (plan.start_time && plan.end_time) {
        const [startHour, startMin] = plan.start_time.split(":").map(Number);
        const [endHour, endMin] = plan.end_time.split(":").map(Number);
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;
        dateData.totalHours += (endMinutes - startMinutes) / 60;
      }
    });

    // ì¶©ëŒ ê°ì§€
    return detectAllConflicts(plansWithTime, datePlansMap, 12); // ìµœëŒ€ 12ì‹œê°„
  }, [preview]);

  const loadPreview = useCallback(async () => {
    // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ (ref ì‚¬ìš©)
    if (isLoadingRef.current) {
      console.log(
        "[PreviewStep] loadPreview: ì´ë¯¸ ë¡œë”© ì¤‘ì´ë¯€ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€"
      );
      return;
    }

    isLoadingRef.current = true;
    setLoading(true);
    loadAttemptedRef.current = true; // ì‹œë„ í‘œì‹œ

    try {
      // refì—ì„œ ìµœì‹  ê°’ ê°€ì ¸ì˜¤ê¸°
      const currentAdjustments = adjustmentsRef.current;
      const currentRescheduleRange = rescheduleDateRange;
      const currentPlacementRange = placementDateRange;

      console.log("[PreviewStep] loadPreview í˜¸ì¶œ:", {
        groupId,
        adjustmentsCount: currentAdjustments.length,
        rescheduleDateRange: currentRescheduleRange,
        placementDateRange: currentPlacementRange,
      });
      const result = await getReschedulePreview(
        groupId,
        currentAdjustments,
        currentRescheduleRange || null,
        currentPlacementRange || null,
        includeToday
      );
      console.log("[PreviewStep] loadPreview ì„±ê³µ:", {
        plansBeforeCount: result.plans_before_count,
        plansAfterCount: result.plans_after_count,
        affectedDates: result.affected_dates.length,
      });
      setPreview(result);
      onLoad(result);
    } catch (error) {
      console.error("[PreviewStep] loadPreview ì‹¤íŒ¨:", error);
      toast.showError(
        error instanceof Error
          ? error.message
          : "ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
      // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ previewë¥¼ nullë¡œ ìœ ì§€í•˜ì—¬ ì¬ì‹œë„ ê°€ëŠ¥í•˜ê²Œ í•¨
    } finally {
      isLoadingRef.current = false;
      setLoading(false);
    }
  }, [
    groupId,
    onLoad,
    toast,
    rescheduleDateRange,
    placementDateRange,
    includeToday,
  ]); // ê°ì²´/ë°°ì—´ ì œê±°, í•¨ìˆ˜ ì°¸ì¡°ë§Œ í¬í•¨

  useEffect(() => {
    // ì´ë¯¸ ë¯¸ë¦¬ë³´ê¸°ê°€ ìˆê±°ë‚˜, ë¡œë”© ì¤‘ì´ê±°ë‚˜, ì´ë¯¸ ì‹œë„í–ˆìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    // previewëŠ” ì˜ì¡´ì„±ì—ì„œ ì œê±° (ê²°ê³¼ê°’ì´ë¯€ë¡œ)
    if (preview || isLoadingRef.current || loadAttemptedRef.current) {
      console.log("[PreviewStep] useEffect: ì¡°ê±´ ë¶ˆë§Œì¡±ìœ¼ë¡œ ì‹¤í–‰ ì•ˆ í•¨", {
        hasPreview: !!preview,
        isLoading: isLoadingRef.current,
        loadAttempted: loadAttemptedRef.current,
      });
      return;
    }

    // adjustmentsê°€ ìˆê±°ë‚˜ dateRangeê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
    // adjustments.lengthì™€ dateRange?.from, dateRange?.toë¥¼ ì§ì ‘ ë¹„êµ
    const hasAdjustments = adjustments.length > 0;
    const hasRescheduleRange = !!(
      rescheduleDateRange?.from && rescheduleDateRange?.to
    );
    const hasPlacementRange = !!(
      placementDateRange?.from && placementDateRange?.to
    );

    if (
      hasAdjustments ||
      hasRescheduleRange ||
      hasPlacementRange ||
      includeToday
    ) {
      console.log("[PreviewStep] useEffect: loadPreview í˜¸ì¶œ ì‹œë„", {
        hasAdjustments,
        hasRescheduleRange,
        hasPlacementRange,
      });
      loadPreview();
    } else {
      console.log("[PreviewStep] useEffect: ì¡°ê±´ ë¶ˆë§Œì¡±", {
        adjustmentsLength: adjustments.length,
        rescheduleDateRange,
        placementDateRange,
        includeToday,
      });
    }
  }, [
    adjustments,
    rescheduleDateRange,
    placementDateRange,
    includeToday,
    loadPreview,
  ]); // preview ì œê±°

  // adjustmentsë‚˜ dateRangeê°€ ë³€ê²½ë˜ë©´ ì¬ì‹œë„ í—ˆìš©
  useEffect(() => {
    if (preview) {
      loadAttemptedRef.current = false;
    }
  }, [
    adjustments,
    rescheduleDateRange,
    placementDateRange,
    includeToday,
    preview,
  ]);

  const handleExecute = async () => {
    if (!confirmDialogOpen) {
      setConfirmDialogOpen(true);
      return;
    }

    setExecuting(true);
    try {
      const result = await rescheduleContents(
        groupId,
        adjustments,
        undefined,
        rescheduleDateRange || null,
        placementDateRange || null,
        includeToday
      );
      if (result.success) {
        toast.showSuccess("ì¬ì¡°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        router.push(`/plan/group/${groupId}`);
      } else {
        toast.showError(result.error || "ì¬ì¡°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      toast.showError(
        error instanceof Error ? error.message : "ì¬ì¡°ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    } finally {
      setExecuting(false);
      setConfirmDialogOpen(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="flex flex-col gap-4 text-center">
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"></div>
          <p className="text-sm text-gray-600">
            ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </p>
        </div>
      </div>
    );
  }

  if (!preview) {
    // adjustmentsì™€ dateRangeê°€ ëª¨ë‘ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    const hasRescheduleRange = !!(
      rescheduleDateRange?.from && rescheduleDateRange?.to
    );
    const hasPlacementRange = !!(
      placementDateRange?.from && placementDateRange?.to
    );
    if (adjustments.length === 0 && !hasRescheduleRange && !hasPlacementRange) {
      return (
        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-6 text-center">
          <p className="text-sm text-gray-600">
            ì¡°ì • ì‚¬í•­ì´ ì—†ê±°ë‚˜ ë‚ ì§œ ë²”ìœ„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
          </p>
          <p className="text-xs text-gray-500">
            ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ê°€ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ê³  ë‚ ì§œ ë²”ìœ„ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.
          </p>
        </div>
      );
    }

    // ê·¸ ì™¸ì˜ ê²½ìš° ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ í‘œì‹œ
    return (
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-gray-50 p-6 text-center">
        <p className="text-sm text-gray-600">
          ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <button
          onClick={loadPreview}
          className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700"
        >
          ë‹¤ì‹œ ì‹œë„
        </button>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-bold text-gray-900">ë¯¸ë¦¬ë³´ê¸° & í™•ì¸</h2>
        <p className="text-sm text-gray-600">
          ì¬ì¡°ì • ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”.
        </p>
      </div>

      {/* ë³€ê²½ ìš”ì•½ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <h3 className="font-semibold text-gray-900">ë³€ê²½ ìš”ì•½</h3>
        <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
          <div>
            <p className="text-sm text-gray-600">ê¸°ì¡´ í”Œëœ ìˆ˜</p>
            <p className="text-2xl font-bold text-gray-900">
              {preview.plans_before_count}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-600">ìƒˆ í”Œëœ ìˆ˜</p>
            <p className="text-2xl font-bold text-blue-600">
              {preview.plans_after_count}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-600">ì˜í–¥ë°›ëŠ” ë‚ ì§œ</p>
            <p className="text-2xl font-bold text-gray-900">
              {preview.affected_dates.length}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-600">ì˜ˆìƒ ì‹œê°„</p>
            <p className="text-2xl font-bold text-gray-900">
              {preview.estimated_hours}ì‹œê°„
            </p>
          </div>
        </div>
      </div>

      {/* ë‚ ì§œ ë²”ìœ„ ì •ë³´ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <h3 className="font-semibold text-gray-900">ë‚ ì§œ ë²”ìœ„ ì •ë³´</h3>
        <div className="flex flex-col gap-4">
          <div className="flex flex-col gap-1">
            <p className="text-sm font-medium text-gray-700">
              ì„ íƒí•œ ì¬ì¡°ì • ë²”ìœ„
            </p>
            <p className="text-sm text-gray-600">
              {rescheduleDateRange?.from && rescheduleDateRange?.to
                ? `${rescheduleDateRange.from} ~ ${rescheduleDateRange.to}`
                : "ì „ì²´ ê¸°ê°„"}
            </p>
            <p className="text-xs text-gray-500">
              ì–´ë–¤ ë‚ ì§œì˜ ê¸°ì¡´ í”Œëœì„ ì¬ì¡°ì •í• ì§€ ì„ íƒí•œ ë²”ìœ„ì…ë‹ˆë‹¤
            </p>
          </div>
          <div className="flex flex-col gap-2">
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-700">ì‹¤ì œ ì ìš© ë²”ìœ„</p>
              <p className="text-sm text-gray-600">
                {placementDateRange?.from && placementDateRange?.to
                  ? `${placementDateRange.from} ~ ${placementDateRange.to}`
                  : "ìë™ ê³„ì‚°ë¨ (ì˜¤ëŠ˜ ì´í›„ ~ í”Œëœ ê·¸ë£¹ ì¢…ë£Œì¼)"}
              </p>
              <p className="text-xs text-gray-500">
                ì‹¤ì œë¡œ ì¬ì¡°ì •ì´ ì ìš©ë˜ëŠ” ë‚ ì§œ ë²”ìœ„ì…ë‹ˆë‹¤. ê¸°ì¡´ í”Œëœ í•„í„°ë§ê³¼ ìƒˆ
                í”Œëœ ìƒì„±ì´ ì´ ë²”ìœ„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
              </p>
            </div>
            {/* ìë™ ì¡°ì • ì•ˆë‚´ */}
            {rescheduleDateRange?.from &&
              rescheduleDateRange?.to &&
              placementDateRange?.from &&
              placementDateRange?.to &&
              (rescheduleDateRange.from !== placementDateRange.from ||
                rescheduleDateRange.to !== placementDateRange.to) && (
                <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
                  <p className="text-xs text-blue-800">
                    ğŸ’¡ ì„ íƒí•œ ë²”ìœ„ê°€ ìë™ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ê³¼ê±° ë‚ ì§œëŠ”
                    ì œì™¸ë˜ê³  ì˜¤ëŠ˜ ì´í›„ ë²”ìœ„ë§Œ ì ìš©ë©ë‹ˆë‹¤.
                  </p>
                </div>
              )}
            {/* placementDateRangeê°€ ì—†ê³  rescheduleDateRangeê°€ ê³¼ê±° ë‚ ì§œë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš° */}
            {rescheduleDateRange?.from &&
              rescheduleDateRange?.to &&
              !placementDateRange?.from &&
              !placementDateRange?.to && (
                <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
                  <p className="text-xs text-blue-800">
                    ğŸ’¡ ì„ íƒí•œ ë²”ìœ„ì— ê³¼ê±° ë‚ ì§œê°€ í¬í•¨ë˜ì–´ ìˆì–´ ìë™ìœ¼ë¡œ ì˜¤ëŠ˜
                    ì´í›„ ë²”ìœ„ë¡œ ì¡°ì •ë©ë‹ˆë‹¤.
                  </p>
                </div>
              )}
          </div>
          <div className="flex flex-col gap-1">
            <p className="text-sm font-medium text-gray-700">ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨</p>
            <p className="text-sm text-gray-600">
              {includeToday ? "í¬í•¨ë¨" : "ì œì™¸ë¨"}
            </p>
            <p className="text-xs text-gray-500">
              {includeToday
                ? "ì˜¤ëŠ˜ ë‚ ì§œì˜ í”Œëœë„ ì¬ì¡°ì • ëŒ€ìƒì— í¬í•¨ë©ë‹ˆë‹¤"
                : "ì˜¤ëŠ˜ ë‚ ì§œì˜ í”Œëœì€ ì¬ì¡°ì • ëŒ€ìƒì—ì„œ ì œì™¸ë©ë‹ˆë‹¤"}
            </p>
          </div>
        </div>
      </div>

      {/* ë³€ê²½ ì „/í›„ ë¹„êµ */}
      <BeforeAfterComparison
        preview={preview}
        adjustments={adjustments}
        dateRange={rescheduleDateRange || placementDateRange || null}
      />

      {/* ì˜í–¥ë°›ëŠ” í”Œëœ ëª©ë¡ */}
      <AffectedPlansList
        preview={preview}
        adjustments={adjustments}
        dateRange={rescheduleDateRange || placementDateRange || null}
      />

      {/* ì¡°ì • ìš”ì•½ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <h3 className="font-semibold text-gray-900">ì¡°ì • ë‚´ì—­</h3>
        <div className="flex flex-col gap-2 text-sm">
          <div className="flex justify-between">
            <span className="text-gray-600">ë²”ìœ„ ìˆ˜ì •:</span>
            <span className="font-medium text-gray-900">
              {preview.adjustments_summary.range_changes}ê°œ
            </span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">ì½˜í…ì¸  êµì²´:</span>
            <span className="font-medium text-gray-900">
              {preview.adjustments_summary.replacements}ê°œ
            </span>
          </div>
          <div className="flex justify-between">
            <span className="text-gray-600">ì „ì²´ ì¬ìƒì„±:</span>
            <span className="font-medium text-gray-900">
              {preview.adjustments_summary.full_regenerations}ê°œ
            </span>
          </div>
        </div>
      </div>

      {/* ì¶©ëŒ ê²½ê³  */}
      {conflicts.length > 0 && <ConflictWarning conflicts={conflicts} />}

      {/* ê²½ê³  ë©”ì‹œì§€ */}
      {preview.plans_before_count > 0 && (
        <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-4">
          <p className="text-sm text-yellow-800">
            âš ï¸ ì´ {preview.plans_before_count}ê°œì˜ ê¸°ì¡´ í”Œëœì´ ë¹„í™œì„±í™”ë˜ê³ ,{" "}
            {preview.plans_after_count}ê°œì˜ ìƒˆ í”Œëœì´ ìƒì„±ë©ë‹ˆë‹¤.
            <br />
            ì™„ë£Œëœ í”Œëœì€ ìœ ì§€ë˜ë©°, ë¡¤ë°±ì€ ìµœëŒ€ 24ì‹œê°„ ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </p>
        </div>
      )}

      {/* í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */}
      {confirmDialogOpen && preview && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
          <div className="flex flex-col gap-4 rounded-lg bg-white p-6 shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 className="text-lg font-semibold text-gray-900">
              ì¬ì¡°ì • ì‹¤í–‰ í™•ì¸
            </h3>

            {/* ë³€ê²½ ìš”ì•½ */}
            <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
              <h4 className="text-sm font-semibold text-gray-900">
                ë³€ê²½ ìš”ì•½
              </h4>
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <span className="text-gray-600">ê¸°ì¡´ í”Œëœ:</span>
                  <span className="pl-2 font-medium text-gray-900">
                    {preview.plans_before_count}ê°œ
                  </span>
                </div>
                <div>
                  <span className="text-gray-600">ìƒˆ í”Œëœ:</span>
                  <span className="pl-2 font-medium text-blue-600">
                    {preview.plans_after_count}ê°œ
                  </span>
                </div>
                <div>
                  <span className="text-gray-600">ì˜í–¥ë°›ëŠ” ë‚ ì§œ:</span>
                  <span className="pl-2 font-medium text-gray-900">
                    {preview.affected_dates.length}ì¼
                  </span>
                </div>
                <div>
                  <span className="text-gray-600">ì˜ˆìƒ ì‹œê°„:</span>
                  <span className="pl-2 font-medium text-gray-900">
                    {preview.estimated_hours}ì‹œê°„
                  </span>
                </div>
              </div>
            </div>

            {/* ì˜í–¥ë°›ëŠ” ë‚ ì§œ ëª©ë¡ (ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ) */}
            {preview.affected_dates.length > 0 && (
              <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
                <h4 className="text-sm font-semibold text-gray-900">
                  ì˜í–¥ë°›ëŠ” ë‚ ì§œ
                </h4>
                <div className="max-h-32 overflow-y-auto">
                  <div className="flex flex-wrap gap-2 text-xs">
                    {preview.affected_dates.slice(0, 10).map((date) => (
                      <span
                        key={date}
                        className="rounded-full border border-gray-300 bg-gray-50 px-2 py-1 text-gray-700"
                      >
                        {date}
                      </span>
                    ))}
                    {preview.affected_dates.length > 10 && (
                      <span className="rounded-full border border-gray-300 bg-gray-50 px-2 py-1 text-gray-700">
                        +{preview.affected_dates.length - 10}ì¼
                      </span>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* ì¡°ì • ë‚´ì—­ */}
            <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
              <h4 className="text-sm font-semibold text-gray-900">
                ì¡°ì • ë‚´ì—­
              </h4>
              <div className="flex flex-col gap-1 text-xs text-gray-600">
                <div className="flex justify-between">
                  <span>ë²”ìœ„ ìˆ˜ì •:</span>
                  <span className="font-medium text-gray-900">
                    {preview.adjustments_summary.range_changes}ê°œ
                  </span>
                </div>
                <div className="flex justify-between">
                  <span>ì½˜í…ì¸  êµì²´:</span>
                  <span className="font-medium text-gray-900">
                    {preview.adjustments_summary.replacements}ê°œ
                  </span>
                </div>
                <div className="flex justify-between">
                  <span>ì „ì²´ ì¬ìƒì„±:</span>
                  <span className="font-medium text-gray-900">
                    {preview.adjustments_summary.full_regenerations}ê°œ
                  </span>
                </div>
              </div>
            </div>

            {/* ê²½ê³  ë©”ì‹œì§€ */}
            <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-4">
              <p className="text-sm text-yellow-800">
                âš ï¸ ì´ {preview.plans_before_count}ê°œì˜ ê¸°ì¡´ í”Œëœì´ ë¹„í™œì„±í™”ë˜ê³ ,{" "}
                {preview.plans_after_count}ê°œì˜ ìƒˆ í”Œëœì´ ìƒì„±ë©ë‹ˆë‹¤.
                <br />
                ì™„ë£Œëœ í”Œëœì€ ìœ ì§€ë˜ë©°, ë¡¤ë°±ì€ ìµœëŒ€ 24ì‹œê°„ ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
              </p>
            </div>

            <div className="flex justify-end gap-3">
              <button
                onClick={() => setConfirmDialogOpen(false)}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleExecute}
                disabled={executing}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-red-700 disabled:bg-gray-300"
              >
                {executing ? "ì‹¤í–‰ ì¤‘..." : "ì‹¤í–‰"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ì•¡ì…˜ ë²„íŠ¼ */}
      <div className="flex justify-end gap-3">
        <button
          onClick={() => router.back()}
          className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          ì·¨ì†Œ
        </button>
        <button
          onClick={handleExecute}
          disabled={executing}
          className="rounded-lg bg-blue-600 px-6 py-2 text-sm font-medium text-white transition hover:bg-blue-700 disabled:bg-gray-300"
        >
          {executing ? "ì‹¤í–‰ ì¤‘..." : "ì¬ì¡°ì • ì‹¤í–‰"}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/RescheduleWizard.tsx">
/**
 * ì¬ì¡°ì • Wizard ì»´í¬ë„ŒíŠ¸
 *
 * 3ë‹¨ê³„ Wizardë¡œ ì¬ì¡°ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.
 */

"use client";

import { useState } from "react";
import { Check } from "lucide-react";
import { ContentSelectStep } from "./ContentSelectStep";
import { AdjustmentStep } from "./AdjustmentStep";
import { PreviewStep } from "./PreviewStep";
import type { PlanGroup, PlanContent } from "@/lib/types/plan";
import type { AdjustmentInput } from "@/lib/reschedule/scheduleEngine";
import { ProgressBar } from "@/components/atoms/ProgressBar";

type RescheduleWizardProps = {
  groupId: string;
  group: PlanGroup;
  contents: PlanContent[];
  existingPlans: Array<{
    id: string;
    status: string | null;
    is_active: boolean | null;
    content_id: string;
  }>;
  initialDateRange?: { from: string; to: string } | null;
};

type WizardStep = 1 | 2 | 3;

type DateRange = {
  from: string | null;
  to: string | null;
};

export function RescheduleWizard({
  groupId,
  group,
  contents,
  existingPlans,
  initialDateRange,
}: RescheduleWizardProps) {
  const [currentStep, setCurrentStep] = useState<WizardStep>(1);
  const [selectedContentIds, setSelectedContentIds] = useState<Set<string>>(
    new Set()
  );
  const [rescheduleDateRange, setRescheduleDateRange] = useState<DateRange | null>(
    initialDateRange || null
  );
  const [placementDateRange, setPlacementDateRange] = useState<DateRange | null>(null);
  const [includeToday, setIncludeToday] = useState(false);
  const [adjustments, setAdjustments] = useState<AdjustmentInput[]>([]);
  const [previewResult, setPreviewResult] = useState<any>(null);
  const [completedSteps, setCompletedSteps] = useState<Set<WizardStep>>(
    new Set()
  );

  // Step 1 ì™„ë£Œ í•¸ë“¤ëŸ¬
  const handleStep1Complete = (
    contentIds: Set<string>,
    selectedRescheduleRange: DateRange | null,
    includeTodayValue: boolean
  ) => {
    setSelectedContentIds(contentIds);
    setRescheduleDateRange(selectedRescheduleRange);
    setIncludeToday(includeTodayValue);
    setCompletedSteps(new Set([1]));
    setCurrentStep(2);
  };

  // Step 2 ì™„ë£Œ í•¸ë“¤ëŸ¬
  const handleStep2Complete = (
    newAdjustments: AdjustmentInput[],
    selectedPlacementRange: DateRange | null
  ) => {
    setAdjustments(newAdjustments);
    setPlacementDateRange(selectedPlacementRange);
    setCompletedSteps(new Set([1, 2]));
    setCurrentStep(3);
  };

  // Step 3 ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
  const handleStep3Load = async (preview: any) => {
    setPreviewResult(preview);
  };

  // ë’¤ë¡œê°€ê¸° í•¸ë“¤ëŸ¬
  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep((prev) => (prev - 1) as WizardStep);
    }
  };

  // ì§„í–‰ë¥  ê³„ì‚°
  const progressPercentage = ((currentStep - 1) / 2) * 100;

  return (
    <div className="rounded-lg border border-gray-200 bg-white shadow-sm">
      {/* ì§„í–‰ í‘œì‹œ */}
      <div className="flex flex-col gap-4 border-b border-gray-200 px-4 py-4 sm:px-6">
        {/* ì§„í–‰ë¥  ë°” */}
        <div className="flex flex-col gap-1">
          <div className="flex items-center justify-between text-xs text-gray-600">
            <span>ì§„í–‰ë¥ </span>
            <span>{Math.round(progressPercentage)}%</span>
          </div>
          <ProgressBar
            value={progressPercentage}
            color="blue"
            size="sm"
          />
        </div>

        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex items-center gap-2 sm:gap-4 overflow-x-auto pb-2 sm:pb-0">
            {[1, 2, 3].map((step) => {
              const isCompleted = completedSteps.has(step as WizardStep);
              const isCurrent = currentStep === step;
              const isPast = currentStep > step;

              return (
                <div
                  key={step}
                  className="flex items-center gap-2"
                  role="progressbar"
                  aria-valuenow={step}
                  aria-valuemin={1}
                  aria-valuemax={3}
                  aria-label={`${
                    step === 1
                      ? "ì½˜í…ì¸  ì„ íƒ"
                      : step === 2
                      ? "ìƒì„¸ ì¡°ì •"
                      : "ë¯¸ë¦¬ë³´ê¸° & í™•ì¸"
                  } ë‹¨ê³„${isCompleted ? " ì™„ë£Œ" : isCurrent ? " ì§„í–‰ ì¤‘" : ""}`}
                >
                  <div
                    className={`flex h-7 w-7 sm:h-8 sm:w-8 items-center justify-center rounded-full text-xs sm:text-sm font-semibold transition flex-shrink-0 ${
                      isCurrent
                        ? "bg-blue-600 text-white"
                        : isCompleted || isPast
                        ? "bg-green-100 text-green-700"
                        : "bg-gray-100 text-gray-600"
                    }`}
                  >
                    {isCompleted ? (
                      <Check className="h-4 w-4 sm:h-5 sm:w-5" />
                    ) : (
                      step
                    )}
                  </div>
                  <span
                    className={`text-xs sm:text-sm font-medium whitespace-nowrap ${
                      isCurrent
                        ? "text-blue-600"
                        : isCompleted || isPast
                        ? "text-green-700"
                        : "text-gray-600"
                    }`}
                  >
                    {step === 1
                      ? "ì½˜í…ì¸  ì„ íƒ"
                      : step === 2
                      ? "ìƒì„¸ ì¡°ì •"
                      : "ë¯¸ë¦¬ë³´ê¸° & í™•ì¸"}
                  </span>
                  {step < 3 && (
                    <svg
                      className="h-3 w-3 sm:h-4 sm:w-4 text-gray-400 flex-shrink-0"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  )}
                </div>
              );
            })}
          </div>
          {currentStep > 1 && (
            <button
              onClick={handleBack}
              className="rounded-lg px-3 py-2 text-xs sm:text-sm font-medium text-gray-700 transition hover:bg-gray-100 whitespace-nowrap"
            >
              ë’¤ë¡œê°€ê¸°
            </button>
          )}
        </div>
      </div>

      {/* Step ì»¨í…ì¸  */}
      <div className="p-4 sm:p-6">
        {currentStep === 1 && (
          <ContentSelectStep
            group={group}
            contents={contents}
            existingPlans={existingPlans.map((p) => ({
              ...p,
              plan_date: (p as any).plan_date || "",
            }))}
            onComplete={handleStep1Complete}
            initialDateRange={initialDateRange}
          />
        )}
        {currentStep === 2 && (
          <AdjustmentStep
            contents={contents}
            selectedContentIds={selectedContentIds}
            adjustments={adjustments}
            onComplete={handleStep2Complete}
            onBack={handleBack}
            studentId={group.student_id}
            groupPeriodEnd={group.period_end}
            existingPlans={existingPlans.map((p) => ({
              ...p,
              plan_date: (p as any).plan_date || "",
            }))}
          />
        )}
        {currentStep === 3 && (
          <PreviewStep
            groupId={groupId}
            adjustments={adjustments}
            rescheduleDateRange={
              rescheduleDateRange && rescheduleDateRange.from && rescheduleDateRange.to
                ? { from: rescheduleDateRange.from, to: rescheduleDateRange.to }
                : null
            }
            placementDateRange={
              placementDateRange && placementDateRange.from && placementDateRange.to
                ? { from: placementDateRange.from, to: placementDateRange.to }
                : null
            }
            includeToday={includeToday}
            onLoad={handleStep3Load}
            previewResult={previewResult}
          />
        )}
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/_components/RollbackButton.tsx">
/**
 * ë¡¤ë°± ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì •ì„ ë¡¤ë°±í•  ìˆ˜ ìˆëŠ” ë²„íŠ¼ê³¼ ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */

"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { rollbackReschedule } from "@/app/(student)/actions/plan-groups/rollback";
import { validateRollback } from "@/lib/reschedule/rollbackValidator";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { useToast } from "@/components/ui/ToastProvider";
import { RotateCcw } from "lucide-react";

type RollbackButtonProps = {
  rescheduleLogId: string;
  groupId: string;
};

export function RollbackButton({
  rescheduleLogId,
  groupId,
}: RollbackButtonProps) {
  const router = useRouter();
  const toast = useToast();
  const [loading, setLoading] = useState(false);
  const [validating, setValidating] = useState(true);
  const [canRollback, setCanRollback] = useState(false);
  const [reason, setReason] = useState<string | null>(null);
  const [confirmDialogOpen, setConfirmDialogOpen] = useState(false);
  const [executing, setExecuting] = useState(false);

  useEffect(() => {
    checkRollbackStatus();
  }, [rescheduleLogId]);

  const checkRollbackStatus = async () => {
    setValidating(true);
    try {
      // TODO: Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ë°©ë²• ìˆ˜ì • í•„ìš”
      // í˜„ì¬ëŠ” í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì´ë¯€ë¡œ API routeë¥¼ í†µí•´ ê²€ì¦í•´ì•¼ í•  ìˆ˜ ìˆìŒ
      // ì¼ë‹¨ ê°„ë‹¨í•˜ê²Œ ì„œë²„ ì•¡ì…˜ìœ¼ë¡œ ê²€ì¦í•˜ë„ë¡ ìˆ˜ì •
      const response = await fetch(
        `/api/reschedule/${rescheduleLogId}/validate-rollback`
      );
      if (response.ok) {
        const data = await response.json();
        setCanRollback(data.canRollback);
        setReason(data.reason || null);
      }
    } catch (error) {
      console.error("[RollbackButton] ë¡¤ë°± ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
      setCanRollback(false);
      setReason("ë¡¤ë°± ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    } finally {
      setValidating(false);
    }
  };

  const handleRollback = async () => {
    if (!confirmDialogOpen) {
      setConfirmDialogOpen(true);
      return;
    }

    setExecuting(true);
    try {
      const result = await rollbackReschedule(rescheduleLogId);
      if (result.success) {
        toast.showSuccess(
          `ë¡¤ë°±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ë³µì›: ${result.restoredPlans}ê°œ, ì·¨ì†Œ: ${result.canceledPlans}ê°œ)`
        );
        router.refresh();
        router.push(`/plan/group/${groupId}`);
      } else {
        toast.showError(result.error || "ë¡¤ë°±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      toast.showError(
        error instanceof Error ? error.message : "ë¡¤ë°±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    } finally {
      setExecuting(false);
      setConfirmDialogOpen(false);
    }
  };

  if (validating) {
    return (
      <button
        disabled
        className="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-gray-500"
      >
        <RotateCcw className="h-4 w-4 animate-spin" />
        í™•ì¸ ì¤‘...
      </button>
    );
  }

  if (!canRollback) {
    return (
      <div className="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm text-gray-500">
        <RotateCcw className="h-4 w-4" />
        <span>ë¡¤ë°± ë¶ˆê°€</span>
        {reason && (
          <span className="pl-2 text-xs text-gray-400" title={reason}>
            (?) {reason}
          </span>
        )}
      </div>
    );
  }

  return (
    <>
      <button
        onClick={() => setConfirmDialogOpen(true)}
        className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
      >
        <RotateCcw className="h-4 w-4" />
        ë¡¤ë°±
      </button>

      {/* í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */}
      {confirmDialogOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="flex flex-col gap-4 rounded-lg bg-white p-6 shadow-lg max-w-md w-full px-4">
            <h3 className="text-lg font-semibold text-gray-900">
              ì¬ì¡°ì • ë¡¤ë°± í™•ì¸
            </h3>
            <p className="text-sm text-gray-600">
              ì •ë§ë¡œ ì´ ì¬ì¡°ì •ì„ ë¡¤ë°±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
              <br />
              ìƒˆë¡œ ìƒì„±ëœ í”Œëœì´ ì·¨ì†Œë˜ê³ , ì´ì „ í”Œëœì´ ë³µì›ë©ë‹ˆë‹¤.
            </p>
            {reason && (
              <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-3">
                <p className="text-xs text-yellow-800">{reason}</p>
              </div>
            )}
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setConfirmDialogOpen(false)}
                disabled={executing}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleRollback}
                disabled={executing}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-red-700 disabled:bg-gray-300"
              >
                {executing ? "ë¡¤ë°± ì¤‘..." : "ë¡¤ë°± ì‹¤í–‰"}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
</file>

<file path="group/[id]/reschedule/_components/SmartDateRangeSuggestions.tsx">
/**
 * ìŠ¤ë§ˆíŠ¸ ë‚ ì§œ ë²”ìœ„ ì¶”ì²œ ì»´í¬ë„ŒíŠ¸
 * 
 * ì¬ì¡°ì • ëŒ€ìƒ ì½˜í…ì¸ ì˜ ì˜í–¥ë°›ëŠ” ë‚ ì§œë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ì¶”ì²œ ë‚ ì§œ ë²”ìœ„ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */

"use client";

import { useMemo } from "react";
import { format } from "date-fns";
import { generateDateRangeSuggestions, type SuggestedDateRange } from "@/lib/reschedule/dateRangeAnalyzer";
import type { PlanGroup, PlanContent } from "@/lib/types/plan";

type SmartDateRangeSuggestionsProps = {
  group: PlanGroup;
  contents: PlanContent[];
  selectedContentIds: Set<string>;
  existingPlans: Array<{
    id: string;
    plan_date: string;
    status: string | null;
    is_active: boolean | null;
    content_id: string;
  }>;
  onSelectRange: (range: { from: string; to: string }) => void;
};

export function SmartDateRangeSuggestions({
  group,
  contents,
  selectedContentIds,
  existingPlans,
  onSelectRange,
}: SmartDateRangeSuggestionsProps) {
  // ì¶”ì²œ ë‚ ì§œ ë²”ìœ„ ìƒì„±
  const suggestions = useMemo(() => {
    if (selectedContentIds.size === 0) {
      return [];
    }

    return generateDateRangeSuggestions(
      selectedContentIds,
      contents,
      existingPlans.map((p) => ({
        id: p.id,
        plan_date: p.plan_date,
        status: p.status,
        is_active: p.is_active,
        content_id: p.content_id,
      })),
      group.period_start,
      group.period_end
    );
  }, [selectedContentIds, contents, existingPlans, group.period_start, group.period_end]);

  if (suggestions.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-col gap-3 rounded-lg border border-blue-200 bg-blue-50 p-4">
      <div className="flex flex-col gap-1">
        <h4 className="text-sm font-semibold text-blue-900">
          ğŸ’¡ ì¶”ì²œ ë‚ ì§œ ë²”ìœ„
        </h4>
        <p className="text-xs text-blue-700">
          ì„ íƒí•œ ì½˜í…ì¸ ì˜ ì˜í–¥ë°›ëŠ” ë‚ ì§œë¥¼ ë¶„ì„í•˜ì—¬ ì¶”ì²œí•©ë‹ˆë‹¤.
        </p>
      </div>

      <div className="flex flex-col gap-2">
        {suggestions.slice(0, 3).map((suggestion, index) => (
          <button
            key={`${suggestion.range.from}-${suggestion.range.to}-${index}`}
            type="button"
            onClick={() => onSelectRange(suggestion.range)}
            className="flex items-center justify-between rounded-lg border border-blue-300 bg-white p-3 text-left transition hover:bg-blue-50 hover:shadow-sm"
          >
            <div className="flex flex-1 flex-col gap-1">
              <div className="flex items-center gap-2">
                <span className="text-sm font-medium text-gray-900">
                  {suggestion.range.from === suggestion.range.to
                    ? format(new Date(suggestion.range.from), "yyyyë…„ Mì›” dì¼")
                    : `${format(new Date(suggestion.range.from), "Mì›” dì¼")} ~ ${format(new Date(suggestion.range.to), "Mì›” dì¼")}`}
                </span>
                {index === 0 && (
                  <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700">
                    ì¶”ì²œ
                  </span>
                )}
              </div>
              <p className="text-xs text-gray-600">{suggestion.reason}</p>
              <p className="text-xs text-gray-500">
                ì˜í–¥ë°›ëŠ” í”Œëœ: {suggestion.affectedPlansCount}ê°œ
              </p>
            </div>
            <div className="pl-3">
              <svg
                className="h-5 w-5 text-blue-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </div>
          </button>
        ))}
      </div>

      {suggestions.length > 3 && (
        <p className="text-xs text-blue-600">
          + {suggestions.length - 3}ê°œì˜ ì¶”ê°€ ì¶”ì²œì´ ìˆìŠµë‹ˆë‹¤
        </p>
      )}
    </div>
  );
}
</file>

<file path="group/[id]/reschedule/page.tsx">
/**
 * í”Œëœ ê·¸ë£¹ ì¬ì¡°ì • í˜ì´ì§€
 *
 * 3ë‹¨ê³„ Wizard í˜•íƒœë¡œ ì¬ì¡°ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.
 * - Step 1: ì½˜í…ì¸  ì„ íƒ
 * - Step 2: ìƒì„¸ ì¡°ì •
 * - Step 3: ë¯¸ë¦¬ë³´ê¸° & í™•ì¸
 */

import { redirect, notFound } from "next/navigation";
import Link from "next/link";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getPlanGroupWithDetails } from "@/lib/data/planGroups";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { RescheduleWizard } from "./_components/RescheduleWizard";
import { getContainerClass } from "@/lib/constants/layout";

type ReschedulePageProps = {
  params: Promise<{ id: string }>;
  searchParams: Promise<{
    from?: string;
    to?: string;
    suggestion?: string;
    priority?: string;
  }>;
};

export default async function ReschedulePage({
  params,
  searchParams,
}: ReschedulePageProps) {
  const { id } = await params;
  const searchParamsData = await searchParams;

  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  // tenantId ì¡°íšŒ
  const tenantContext = await getTenantContext();

  // í”Œëœ ê·¸ë£¹ ë° ê´€ë ¨ ë°ì´í„° ì¡°íšŒ
  const { group, contents } = await getPlanGroupWithDetails(
    id,
    user.id,
    tenantContext?.tenantId || null
  );

  if (!group) {
    notFound();
  }

  // ê¸°ì¡´ í”Œëœ ì¡°íšŒ (ì¬ì¡°ì • ëŒ€ìƒ í™•ì¸ìš©)
  const { data: existingPlans } = await supabase
    .from("student_plan")
    .select("id, status, is_active, content_id, plan_date")
    .eq("plan_group_id", id)
    .eq("student_id", user.id);

  // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ë‚ ì§œ ë²”ìœ„ íŒŒì‹±
  let initialDateRange: { from: string; to: string } | null = null;
  if (searchParamsData.from && searchParamsData.to) {
    // ë‚ ì§œ í˜•ì‹ ê²€ì¦ (YYYY-MM-DD)
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (
      dateRegex.test(searchParamsData.from) &&
      dateRegex.test(searchParamsData.to) &&
      searchParamsData.from <= searchParamsData.to
    ) {
      initialDateRange = {
        from: searchParamsData.from,
        to: searchParamsData.to,
      };
    }
  }

  return (
    <div className={getContainerClass("CAMP_PLAN", "md")}>
      <div className="flex flex-col gap-6">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link
              href={`/plan/group/${id}`}
              className="inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-100"
            >
              <svg
                className="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              í”Œëœ ê·¸ë£¹ ìƒì„¸ë¡œ ëŒì•„ê°€ê¸°
            </Link>
            <div className="flex flex-col gap-1">
              <h1 className="text-2xl font-bold text-gray-900">
                í”Œëœ ê·¸ë£¹ ì¬ì¡°ì •
              </h1>
              <p className="text-sm text-gray-600">
                {group.name || "ì´ë¦„ ì—†ìŒ"}
              </p>
            </div>
          </div>
        </div>

        {/* Wizard */}
        <RescheduleWizard
          groupId={id}
          group={group}
          contents={contents}
          existingPlans={existingPlans || []}
          initialDateRange={initialDateRange}
        />
      </div>
    </div>
  );
}
</file>

<file path="group/[id]/page.tsx">
import Link from "next/link";
import { redirect, notFound } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getPlanGroupWithDetails } from "@/lib/data/planGroups";

import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { PlanStatusManager } from "@/lib/plan/statusManager";
import { PlanGroupDetailView } from "./_components/PlanGroupDetailView";
import { PlanGroupActionButtons } from "./_components/PlanGroupActionButtons";
import { PlanGroupProgressCard } from "./_components/PlanGroupProgressCard";
import { AutoRescheduleBanner } from "./_components/AutoRescheduleBanner";
import { classifyPlanContents } from "@/lib/data/planContents";
import type { PlanStatus, Plan } from "@/lib/types/plan";
import {
  planPurposeLabels,
  schedulerTypeLabels,
  statusLabels,
  statusColors,
} from "@/lib/constants/planLabels";
import { ScrollToTop } from "@/components/ScrollToTop";
import { getContainerClass } from "@/lib/constants/layout";

type PlanGroupDetailPageProps = {
  params: Promise<{ id: string }>;
  searchParams?: Promise<{ camp?: string }>;
};

export default async function PlanGroupDetailPage({
  params,
  searchParams,
}: PlanGroupDetailPageProps) {
  const { id } = await params;

  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  // tenantId ì¡°íšŒ
  const tenantContext = await getTenantContext();

  // í”Œëœ ê·¸ë£¹ ë° ê´€ë ¨ ë°ì´í„° ì¡°íšŒ
  const { group, contents, exclusions, academySchedules } =
    await getPlanGroupWithDetails(id, user.id, tenantContext?.tenantId || null);

  if (!group) {
    notFound();
  }

  // ì½˜í…ì¸  ì •ë³´ ì¡°íšŒ ë° í•™ìƒ/ì¶”ì²œ êµ¬ë¶„ (í†µí•© í•¨ìˆ˜ ì‚¬ìš©)
  const { studentContents, recommendedContents } = await classifyPlanContents(
    contents,
    user.id
  );

  // ìƒì„¸ í˜ì´ì§€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const allContents = [...studentContents, ...recommendedContents];
  const contentsMap = new Map(allContents.map((c) => [c.content_id, c]));

  const contentsWithDetails = contents.map((content) => {
    const detail = contentsMap.get(content.content_id);
    if (!detail) {
      return {
        ...content,
        contentTitle: "ì•Œ ìˆ˜ ì—†ìŒ",
        contentSubtitle: null,
        isRecommended: false,
      };
    }

    return {
      ...content,
      contentTitle: detail.title || "ì•Œ ìˆ˜ ì—†ìŒ",
      contentSubtitle: detail.subject_category || null,
      isRecommended: detail.isRecommended,
    };
  });

  const canEdit = PlanStatusManager.canEdit(group.status as PlanStatus);
  const canDelete = PlanStatusManager.canDelete(group.status as PlanStatus);

  // ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ì¡°íšŒ (ì‹œê°„ ë¸”ë¡ ì •ë³´ í¬í•¨)
  const { fetchBlockSetsWithBlocks } = await import("@/lib/data/blockSets");
  const blockSets = await fetchBlockSetsWithBlocks(user.id);



  // í”Œëœ ë°ì´í„° ì¡°íšŒ (ìë™ ì¬ì¡°ì • ì œì•ˆì„ ìœ„í•´ ì „ì²´ í”Œëœ ì •ë³´ í•„ìš”)
  const { data: plans } = await supabase
    .from("student_plan")
    .select(
      "id,plan_date,planned_start_page_or_time,planned_end_page_or_time,completed_amount,status,actual_start_time,actual_end_time"
    )
    .eq("plan_group_id", id)
    .eq("student_id", user.id)
    .not("plan_group_id", "is", null);

  const planCount = plans?.length || 0;
  const hasPlans = planCount > 0;

  // ìë™ ì¬ì¡°ì • ì œì•ˆì„ ìœ„í•œ í”Œëœ ë°ì´í„° ë³€í™˜
  const plansForAnalysis: Plan[] = (plans || []).map((p) => ({
    id: p.id,
    plan_date: p.plan_date,
    planned_start_page_or_time: p.planned_start_page_or_time,
    planned_end_page_or_time: p.planned_end_page_or_time,
    completed_amount: p.completed_amount,
    status: p.status as "pending" | "in_progress" | "completed" | "cancelled",
    actual_start_time: p.actual_start_time,
    actual_end_time: p.actual_end_time,
    student_id: user.id,
    plan_group_id: id,
    content_type: "book" as const,
    content_id: "",
    block_index: 0,
    is_reschedulable: true,
  }));

  // ì™„ë£Œ ì—¬ë¶€ ë° ì™„ë£Œ ê°œìˆ˜ ê³„ì‚°
  let isCompleted = false;
  let completedCount = 0;

  if (plans && plans.length > 0) {
    const completedPlans = plans.filter((plan) => {
      if (!plan.planned_end_page_or_time) return false;
      return (
        plan.completed_amount !== null &&
        plan.completed_amount >= plan.planned_end_page_or_time
      );
    });
    completedCount = completedPlans.length;
    isCompleted = completedPlans.length === plans.length;
  }

  // í‘œì‹œí•  ìƒíƒœ ê²°ì • (ì €ì¥ë¨/ì´ˆì•ˆ ì œì™¸)
  const getDisplayStatus = () => {
    // ì™„ë£Œ ìƒíƒœëŠ” ìš°ì„  í‘œì‹œ
    if (isCompleted || group.status === "completed") {
      return { label: "ì™„ë£Œ", color: statusColors.completed };
    }

    // í™œì„±/ì¼ì‹œì •ì§€/ì¤‘ë‹¨ ìƒíƒœë§Œ í‘œì‹œ (ì €ì¥ë¨/ì´ˆì•ˆ ì œì™¸)
    if (statusLabels[group.status]) {
      return {
        label: statusLabels[group.status],
        color: statusColors[group.status],
      };
    }

    return null;
  };

  const displayStatus = getDisplayStatus();

  // ìº í”„ ëª¨ë“œ í™•ì¸
  // plan_typeì„ ìš°ì„ ìœ¼ë¡œ í•˜ë˜, URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë„ í™•ì¸í•˜ì—¬ ëª…ì‹œì ìœ¼ë¡œ ìº í”„ ëª¨ë“œ ê°•ì œ ê°€ëŠ¥
  const resolvedSearchParams = searchParams ? await searchParams : undefined;
  const campParam = resolvedSearchParams?.camp;
  const isCampMode = group.plan_type === "camp" || campParam === "true";

  // ìº í”„ ëª¨ë“œì¼ ë•Œ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ì •ë³´ ì¡°íšŒ
  let templateBlocks: Array<{
    id: string;
    day_of_week: number;
    start_time: string;
    end_time: string;
  }> = [];
  let templateBlockSetName: string | null = null;
  let templateBlockSetId: string | null = null;

  if (isCampMode && group.camp_template_id) {
    try {
      // í…œí”Œë¦¿ ì¡°íšŒ
      const { data: template, error: templateError } = await supabase
        .from("camp_templates")
        .select("template_data")
        .eq("id", group.camp_template_id)
        .maybeSingle();

      if (templateError) {
        // Supabase ì—ëŸ¬ ê°ì²´ì˜ ì£¼ìš” ì†ì„± ì¶”ì¶œ (ë” ì•ˆì „í•œ ì²˜ë¦¬)
        const errorInfo: Record<string, unknown> = {};
        
        try {
          if (templateError instanceof Error) {
            errorInfo.message = templateError.message;
            errorInfo.name = templateError.name;
            errorInfo.stack = templateError.stack;
          } else if (typeof templateError === "object" && templateError !== null) {
            Object.keys(templateError).forEach((key) => {
              try {
                errorInfo[key] = (templateError as unknown as Record<string, unknown>)[key];
              } catch {
                // ì†ì„± ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
              }
            });
          } else {
            errorInfo.value = String(templateError);
          }
          
          const standardKeys = ["message", "code", "details", "hint", "statusCode"];
          standardKeys.forEach((key) => {
            if (key in templateError) {
              try {
                errorInfo[key] = (templateError as unknown as Record<string, unknown>)[key];
              } catch {
                // ì†ì„± ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
              }
            }
          });
        } catch (extractError) {
          errorInfo.extractionError = String(extractError);
          errorInfo.rawError = String(templateError);
        }
        
        if (Object.keys(errorInfo).length === 0) {
          errorInfo.message = String(templateError);
        }
        
        console.error(
          "[PlanGroupDetailPage] í…œí”Œë¦¿ ì¡°íšŒ ì—ëŸ¬:",
          errorInfo,
          {
            camp_template_id: group.camp_template_id,
          },
          "ì›ë³¸ ì—ëŸ¬:",
          templateError
        );
      } else if (!template) {
        console.warn(
          "[PlanGroupDetailPage] í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:",
          group.camp_template_id
        );
      } else {
        // template_data ì•ˆì „í•˜ê²Œ íŒŒì‹±
        let templateData: any = null;
        if (template.template_data) {
          if (typeof template.template_data === "string") {
            try {
              templateData = JSON.parse(template.template_data);
            } catch (parseError) {
              console.error(
                "[PlanGroupDetailPage] template_data íŒŒì‹± ì—ëŸ¬:",
                parseError
              );
              templateData = null;
            }
          } else {
            templateData = template.template_data;
          }
        }

        // block_set_id ì°¾ê¸°: ì—¬ëŸ¬ ê²½ë¡œì—ì„œ í™•ì¸
        let blockSetId: string | null = null;

        // 1. scheduler_optionsì—ì„œ template_block_set_id í™•ì¸ (campActions.tsì—ì„œ ì €ì¥í•œ ê²½ë¡œ - ìš°ì„  í™•ì¸)
        if (group.scheduler_options) {
          let schedulerOptions: any = null;
          if (typeof group.scheduler_options === "string") {
            try {
              schedulerOptions = JSON.parse(group.scheduler_options);
            } catch (parseError) {
              console.error(
                "[PlanGroupDetailPage] scheduler_options íŒŒì‹± ì—ëŸ¬:",
                parseError
              );
            }
          } else {
            schedulerOptions = group.scheduler_options;
          }

          if (schedulerOptions?.template_block_set_id) {
            blockSetId = schedulerOptions.template_block_set_id;
            console.log(
              "[PlanGroupDetailPage] scheduler_optionsì—ì„œ template_block_set_id ë°œê²¬:",
              blockSetId
            );
          }
        }

        // 2. ì—°ê²° í…Œì´ë¸”ì—ì„œ block_set_id í™•ì¸ (ìƒˆë¡œìš´ ë°©ì‹)
        if (!blockSetId && group.camp_template_id) {
          const { data: templateBlockSetLink } = await supabase
            .from("camp_template_block_sets")
            .select("tenant_block_set_id")
            .eq("camp_template_id", group.camp_template_id)
            .maybeSingle();

          if (templateBlockSetLink) {
            blockSetId = templateBlockSetLink.tenant_block_set_id;
            console.log(
              "[PlanGroupDetailPage] ì—°ê²° í…Œì´ë¸”ì—ì„œ block_set_id ë°œê²¬:",
              blockSetId
            );
          }
        }

        // 3. template_dataì—ì„œ block_set_id í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±, ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°ì´í„°ìš©)
        if (!blockSetId && templateData?.block_set_id) {
          blockSetId = templateData.block_set_id;
          console.log(
            "[PlanGroupDetailPage] template_dataì—ì„œ block_set_id ë°œê²¬ (í•˜ìœ„ í˜¸í™˜ì„±):",
            blockSetId
          );
        }

        if (blockSetId) {
          // tenant_block_setsì—ì„œ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ (ì˜¬ë°”ë¥¸ í…Œì´ë¸” ì‚¬ìš©)
          console.log("[PlanGroupDetailPage] í…Œë„ŒíŠ¸ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ì‹œë„:", {
            block_set_id: blockSetId,
            template_id: group.camp_template_id,
            tenant_id: tenantContext?.tenantId,
          });

          if (!tenantContext?.tenantId) {
            console.warn("[PlanGroupDetailPage] tenant_idê°€ ì—†ì–´ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ë¶ˆê°€");
          } else {
            const { data: templateBlockSet, error: blockSetError } = await supabase
              .from("tenant_block_sets")
              .select("id, name")
              .eq("id", blockSetId)
              .eq("tenant_id", tenantContext.tenantId)
              .maybeSingle();

            console.log("[PlanGroupDetailPage] í…Œë„ŒíŠ¸ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ê²°ê³¼:", {
              hasError: !!blockSetError,
              hasData: !!templateBlockSet,
              block_set_id: blockSetId,
              tenant_id: tenantContext.tenantId,
            });

            if (blockSetError) {
              // ì—ëŸ¬ ê°ì²´ë¥¼ ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì§ë ¬í™” ì‹œë„
              let errorStringified = "";
              let errorSerialized = {};
              
              try {
                errorStringified = JSON.stringify(blockSetError, null, 2);
              } catch (stringifyError) {
                errorStringified = `JSON.stringify ì‹¤íŒ¨: ${String(stringifyError)}`;
              }
              
              try {
                // ìˆœí™˜ ì°¸ì¡° ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ Set
                const seen = new WeakSet();
                // ì§ë ¬í™” ê°€ëŠ¥í•œ ì†ì„±ë§Œ ì¶”ì¶œ
                errorSerialized = JSON.parse(JSON.stringify(blockSetError, (key, value) => {
                  // ìˆœí™˜ ì°¸ì¡° ë°©ì§€
                  if (typeof value === "object" && value !== null) {
                    if (seen.has(value)) {
                      return "[Circular]";
                    }
                    seen.add(value);
                  }
                  // í•¨ìˆ˜ëŠ” ë¬¸ìì—´ë¡œ ë³€í™˜
                  if (typeof value === "function") {
                    return `[Function: ${value.name || "anonymous"}]`;
                  }
                  return value;
                }));
              } catch (serializeError) {
                errorSerialized = { serializationError: String(serializeError) };
              }
              
              // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì—ëŸ¬ ì •ë³´ ì¶”ì¶œ
              const errorInfo: Record<string, unknown> = {
                // ê¸°ë³¸ ì •ë³´
                errorExists: !!blockSetError,
                errorType: typeof blockSetError,
                errorConstructor: blockSetError?.constructor?.name,
                
                // ì§ë ¬í™” ê²°ê³¼
                stringified: errorStringified,
                serialized: errorSerialized,
                
                // ì§ì ‘ ì ‘ê·¼
                directMessage: (blockSetError as any)?.message,
                directCode: (blockSetError as any)?.code,
                directDetails: (blockSetError as any)?.details,
                directHint: (blockSetError as any)?.hint,
                directStatusCode: (blockSetError as any)?.statusCode,
                
                // toString ì‹œë„
                toString: blockSetError?.toString?.(),
                
                // Object.keys ì‹œë„
                keys: blockSetError && typeof blockSetError === "object" ? Object.keys(blockSetError) : null,
                
                // ëª¨ë“  ì†ì„± ì‹œë„ (ì•ˆì „í•˜ê²Œ)
                allProperties: (() => {
                  if (blockSetError && typeof blockSetError === "object") {
                    const props: Record<string, unknown> = {};
                    try {
                      for (const key in blockSetError) {
                        try {
                          const value = (blockSetError as any)[key];
                          if (typeof value !== "function") {
                            props[key] = value;
                          }
                        } catch {
                          props[key] = "[ì ‘ê·¼ ë¶ˆê°€]";
                        }
                      }
                    } catch {
                      // ë¬´ì‹œ
                    }
                    return props;
                  }
                  return null;
                })(),
              };
              
              console.error(
                "[PlanGroupDetailPage] í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ì—ëŸ¬:",
                errorInfo,
                "\nì›ë³¸ ì—ëŸ¬ ê°ì²´:",
                blockSetError,
                "\nì—ëŸ¬ íƒ€ì…:",
                typeof blockSetError,
                "\nì—ëŸ¬ ìƒì„±ì:",
                blockSetError?.constructor?.name,
                "\nì¿¼ë¦¬ íŒŒë¼ë¯¸í„°:",
                {
                  block_set_id: blockSetId,
                  template_id: group.camp_template_id,
                }
              );
            } else if (templateBlockSet) {
              templateBlockSetId = templateBlockSet.id;
              templateBlockSetName = templateBlockSet.name;
              console.log("[PlanGroupDetailPage] í…Œë„ŒíŠ¸ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ì„±ê³µ:", {
                id: templateBlockSet.id,
                name: templateBlockSet.name,
              });

              // tenant_blocksì—ì„œ ë¸”ë¡ ì¡°íšŒ
              const { data: blocks, error: blocksError } = await supabase
                .from("tenant_blocks")
                .select("id, day_of_week, start_time, end_time")
                .eq("tenant_block_set_id", templateBlockSet.id)
                .order("day_of_week", { ascending: true })
                .order("start_time", { ascending: true });

              if (blocksError) {
                // Supabase ì—ëŸ¬ ê°ì²´ì˜ ì£¼ìš” ì†ì„± ì¶”ì¶œ (ë” ì•ˆì „í•œ ì²˜ë¦¬)
                const errorInfo: Record<string, unknown> = {};
                
                try {
                  if (blocksError instanceof Error) {
                    errorInfo.message = blocksError.message;
                    errorInfo.name = blocksError.name;
                    errorInfo.stack = blocksError.stack;
                  } else if (typeof blocksError === "object" && blocksError !== null) {
                    Object.keys(blocksError).forEach((key) => {
                      try {
                        errorInfo[key] = (blocksError as unknown as Record<string, unknown>)[key];
                      } catch {
                        // ì†ì„± ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                      }
                    });
                  } else {
                    errorInfo.value = String(blocksError);
                  }
                  
                  const standardKeys = ["message", "code", "details", "hint", "statusCode"];
                  standardKeys.forEach((key) => {
                    if (key in blocksError) {
                      try {
                        errorInfo[key] = (blocksError as unknown as Record<string, unknown>)[key];
                      } catch {
                        // ì†ì„± ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                      }
                    }
                  });
                } catch (extractError) {
                  errorInfo.extractionError = String(extractError);
                  errorInfo.rawError = String(blocksError);
                }
                
                if (Object.keys(errorInfo).length === 0) {
                  errorInfo.message = String(blocksError);
                }
                
                console.error(
                  "[PlanGroupDetailPage] í…œí”Œë¦¿ ë¸”ë¡ ì¡°íšŒ ì—ëŸ¬:",
                  errorInfo,
                  {
                    tenant_block_set_id: templateBlockSet.id,
                  },
                  "ì›ë³¸ ì—ëŸ¬:",
                  blocksError
                );
              } else if (blocks && blocks.length > 0) {
                templateBlocks = blocks.map((b) => ({
                  id: b.id,
                  day_of_week: b.day_of_week,
                  start_time: b.start_time,
                  end_time: b.end_time,
                }));
                console.log("[PlanGroupDetailPage] í…œí”Œë¦¿ ë¸”ë¡ ì¡°íšŒ ì„±ê³µ:", {
                  count: templateBlocks.length,
                  blocks: templateBlocks,
                });
              } else {
                console.warn("[PlanGroupDetailPage] í…œí”Œë¦¿ ë¸”ë¡ì´ ì—†ìŒ:", {
                  tenant_block_set_id: templateBlockSet.id,
                });
              }
            } else {
              console.warn(
                "[PlanGroupDetailPage] í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:",
                {
                  block_set_id: blockSetId,
                  template_id: group.camp_template_id,
                }
              );
            }
          }
        } else {
          console.warn("[PlanGroupDetailPage] block_set_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", {
            template_id: group.camp_template_id,
            template_data_has_block_set_id: !!templateData?.block_set_id,
            scheduler_options_has_template_block_set_id:
              !!(typeof group.scheduler_options === "object"
                ? (group.scheduler_options as any)?.template_block_set_id
                : null),
          });
        }
      }
    } catch (error) {
      console.error("[PlanGroupDetailPage] í…œí”Œë¦¿ ë¸”ë¡ ì¡°íšŒ ì¤‘ ì—ëŸ¬:", error);
    }
  }

  return (
    <>
      <ScrollToTop />
      <section className={getContainerClass("CAMP_PLAN", "md")}>
        <div className="flex flex-col gap-6">
        {/* ìƒë‹¨ ì•¡ì…˜ ë°” */}
        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
          <Link
            href={isCampMode ? "/camp" : "/plan"}
            className="inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-100"
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            {isCampMode ? "ìº í”„ ëª©ë¡ìœ¼ë¡œ" : "í”Œëœ ëª©ë¡ìœ¼ë¡œ"}
          </Link>

          <PlanGroupActionButtons
            groupId={id}
            groupName={group.name}
            groupStatus={
              isCompleted ? "completed" : (group.status as PlanStatus)
            }
            canEdit={canEdit}
            canDelete={canDelete || isCompleted}
          />
        </div>

        {/* ìº í”„ ëª¨ë“œ ì•ˆë‚´ */}
        {isCampMode && !hasPlans && (
          <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
            <div className="flex items-start gap-3">
              <div className="flex-shrink-0">
                <svg
                  className="h-5 w-5 text-blue-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div className="flex flex-col gap-1 flex-1">
                <h3 className="text-sm font-semibold text-blue-900">
                  ê´€ë¦¬ì ê²€í†  ì¤‘
                </h3>
                <p className="text-sm text-blue-700">
                  ìº í”„ ì°¸ì—¬ ì •ë³´ë¥¼ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ë‚¨ì€ ë‹¨ê³„ë¥¼ ì§„í–‰í•œ
                  í›„ í”Œëœì´ ìƒì„±ë©ë‹ˆë‹¤.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* í—¤ë” ì •ë³´ ì¹´ë“œ */}
        <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
          <div className="flex flex-col gap-4">
            {/* ìƒíƒœ ë±ƒì§€ë“¤ */}
            <div className="flex flex-wrap items-center gap-2">
              {hasPlans && (
                <span className="inline-block rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-semibold text-blue-800">
                  í”Œëœ ìƒì„± ì™„ë£Œ
                </span>
              )}
              {displayStatus && (
                <span
                  className={`inline-block rounded-full px-2.5 py-0.5 text-xs font-semibold ${displayStatus.color}`}
                >
                  {displayStatus.label}
                </span>
              )}
            </div>

            {/* í”Œëœ ê·¸ë£¹ ì´ë¦„ */}
            <div>
              <h1 className="text-h1 text-gray-900">
                {group.name || "í”Œëœ ê·¸ë£¹"}
              </h1>
            </div>

            {/* í•µì‹¬ ì •ë³´ */}
            <div className="grid gap-4 border-t border-gray-100 pt-4 sm:grid-cols-2 lg:grid-cols-3">
              <div className="flex flex-col gap-1">
                <dt className="text-xs font-medium text-gray-800">í”Œëœ ëª©ì </dt>
                <dd className="text-sm font-semibold text-gray-900">
                  {group.plan_purpose
                    ? planPurposeLabels[group.plan_purpose] ||
                      group.plan_purpose
                    : "â€”"}
                </dd>
              </div>
              <div className="flex flex-col gap-1">
                <dt className="text-xs font-medium text-gray-800">
                  ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•
                </dt>
                <dd className="text-sm font-semibold text-gray-900">
                  {group.scheduler_type
                    ? schedulerTypeLabels[group.scheduler_type] ||
                      group.scheduler_type
                    : "â€”"}
                </dd>
              </div>
              <div className="flex flex-col gap-1">
                <dt className="text-xs font-medium text-gray-800">í•™ìŠµ ê¸°ê°„</dt>
                <dd className="text-sm font-semibold text-gray-900">
                  {group.period_start && group.period_end
                    ? `${new Date(group.period_start).toLocaleDateString(
                        "ko-KR",
                        {
                          month: "short",
                          day: "numeric",
                        }
                      )} ~ ${new Date(group.period_end).toLocaleDateString(
                        "ko-KR",
                        {
                          month: "short",
                          day: "numeric",
                        }
                      )}`
                    : "â€”"}
                </dd>
              </div>
              {group.target_date && (
                <div className="flex flex-col gap-1">
                  <dt className="text-xs font-medium text-gray-800">
                    ëª©í‘œ ë‚ ì§œ
                  </dt>
                  <dd className="text-sm font-semibold text-gray-900">
                    {new Date(group.target_date).toLocaleDateString("ko-KR")}
                  </dd>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* ìë™ ì¬ì¡°ì • ì œì•ˆ ë°°ë„ˆ */}
        {hasPlans && (
          <AutoRescheduleBanner
            groupId={id}
            plans={plansForAnalysis}
            contents={contentsWithDetails}
            startDate={group.period_start}
            endDate={group.period_end}
          />
        )}

        {/* ì§„í–‰ ìƒí™© ì¹´ë“œ */}
        {hasPlans && (
          <PlanGroupProgressCard
            group={group}
            planCount={planCount}
            completedCount={completedCount}
            hasPlans={hasPlans}
          />
        )}

        {/* íƒ­ ì»¨í…ì¸  ì˜ì—­ */}
        <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
          <PlanGroupDetailView
            group={group}
            contents={contents}
            exclusions={exclusions}
            academySchedules={academySchedules}
            contentsWithDetails={contentsWithDetails}
            canEdit={canEdit}
            groupId={id}
            hasPlans={hasPlans}
            templateBlocks={templateBlocks}
            templateBlockSetName={templateBlockSetName}
            templateBlockSetId={templateBlockSetId}
            blockSets={blockSets}
            campTemplateId={isCampMode ? group.camp_template_id : null}

          />
        </div>
      </div>
    </section>
    </>
  );
}
</file>

<file path="new-group/_components/_panels/_modals/AcademyScheduleImportModal.tsx">
"use client";

import React, { useState, useMemo, useEffect } from "react";
import { Clock, AlertCircle, AlertTriangle, ChevronDown, ChevronRight } from "lucide-react";
import {
  validateAcademyScheduleOverlap,
  getScheduleDescription,
} from "@/lib/validation/scheduleValidator";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";

type AcademySchedule = {
  day_of_week: number;
  start_time: string;
  end_time: string;
  academy_name?: string;
  subject?: string;
  travel_time?: number;
  source?: "template" | "student" | "time_management";
  is_locked?: boolean;
};

type AcademyScheduleImportModalProps = {
  isOpen: boolean;
  onClose: () => void;
  availableSchedules: AcademySchedule[];
  existingSchedules: AcademySchedule[];
  onImport: (selectedSchedules: AcademySchedule[]) => void;
};

const weekdayLabels = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];

/**
 * í•™ì› ì¼ì • ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬
 * - ì „ì²´ í•™ì› ì¼ì • ëª©ë¡ í‘œì‹œ (ìš”ì¼ë³„ ê·¸ë£¹í™”)
 * - ì²´í¬ë°•ìŠ¤ë¡œ ë‹¤ì¤‘ ì„ íƒ
 * - ê²¹ì¹˜ëŠ” ì‹œê°„ëŒ€ ê²½ê³  í‘œì‹œ
 */
export function AcademyScheduleImportModal({
  isOpen,
  onClose,
  availableSchedules,
  existingSchedules,
  onImport,
}: AcademyScheduleImportModalProps) {
  const [selectedSchedules, setSelectedSchedules] = useState<Set<string>>(
    new Set()
  );
  const [expandedAcademies, setExpandedAcademies] = useState<Set<string>>(
    new Set()
  );

  // ì¼ì •ì„ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ê¸° ìœ„í•œ í‚¤ ìƒì„±
  const getScheduleKey = (schedule: AcademySchedule): string => {
    return `${schedule.day_of_week}-${schedule.start_time}-${schedule.end_time}-${schedule.academy_name || ""}-${schedule.subject || ""}`;
  };

  // ê¸°ì¡´ ì¼ì • í‚¤ Set
  const existingKeys = useMemo(() => {
    return new Set(existingSchedules.map(getScheduleKey));
  }, [existingSchedules]);

  // ìƒˆë¡œ ì¶”ê°€ ê°€ëŠ¥í•œ ì¼ì •
  const newSchedules = useMemo(() => {
    return availableSchedules.filter((s) => !existingKeys.has(getScheduleKey(s)));
  }, [availableSchedules, existingKeys]);

  // ìš”ì¼ë³„ë¡œ ê·¸ë£¹í™”
  const groupedSchedules = useMemo(() => {
    const grouped: Record<number, AcademySchedule[]> = {};
    for (let i = 0; i < 7; i++) {
      grouped[i] = [];
    }
    availableSchedules.forEach((schedule) => {
      grouped[schedule.day_of_week].push(schedule);
    });
    return grouped;
  }, [availableSchedules]);

  // í•™ì›ë³„ë¡œ ê·¸ë£¹í™”
  const groupedByAcademy = useMemo(() => {
    const grouped: Record<string, AcademySchedule[]> = {};
    availableSchedules.forEach((schedule) => {
      const academyKey = schedule.academy_name || "ê¸°íƒ€";
      if (!grouped[academyKey]) {
        grouped[academyKey] = [];
      }
      grouped[academyKey].push(schedule);
    });
    return grouped;
  }, [availableSchedules]);

  // ì„ íƒëœ ì¼ì •ë“¤ì˜ ê²¹ì¹¨ ê²€ì¦
  const conflictInfo = useMemo(() => {
    const selected = availableSchedules.filter((s) =>
      selectedSchedules.has(getScheduleKey(s))
    );

    const conflicts = new Map<string, AcademySchedule[]>();

    selected.forEach((schedule) => {
      // ìê¸° ìì‹ ì„ ì œì™¸í•œ ì¼ì • ëª©ë¡ìœ¼ë¡œ ê²€ì¦
      const otherSchedules = [
        ...existingSchedules,
        ...selected.filter((s) => getScheduleKey(s) !== getScheduleKey(schedule))
      ];
      
      const validation = validateAcademyScheduleOverlap(schedule, otherSchedules);
      if (!validation.isValid) {
        conflicts.set(getScheduleKey(schedule), validation.conflictSchedules);
      }
    });

    return conflicts;
  }, [selectedSchedules, availableSchedules, existingSchedules]);

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const handleSelectAll = () => {
    if (selectedSchedules.size === newSchedules.length) {
      setSelectedSchedules(new Set());
    } else {
      setSelectedSchedules(new Set(newSchedules.map(getScheduleKey)));
    }
  };

  // ê°œë³„ ì„ íƒ/í•´ì œ
  const handleToggle = (schedule: AcademySchedule) => {
    const key = getScheduleKey(schedule);
    const newSet = new Set(selectedSchedules);
    if (newSet.has(key)) {
      newSet.delete(key);
    } else {
      newSet.add(key);
    }
    setSelectedSchedules(newSet);
  };

  // í•™ì› ì ‘í˜/í¼ì¹¨ í† ê¸€
  const toggleAcademy = (academyName: string) => {
    const newSet = new Set(expandedAcademies);
    if (newSet.has(academyName)) {
      newSet.delete(academyName);
    } else {
      newSet.add(academyName);
    }
    setExpandedAcademies(newSet);
  };

  // í•™ì› ì „ì²´ ì„ íƒ/í•´ì œ
  const handleSelectAcademy = (academyName: string) => {
    const academySchedules = groupedByAcademy[academyName] || [];
    
    // ê¸°ì¡´ ì¼ì •ê³¼ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í•­ëª©ë§Œ í•„í„°ë§
    const selectableSchedules = academySchedules.filter(
      (s) => !existingKeys.has(getScheduleKey(s))
    );
    
    if (selectableSchedules.length === 0) return;
    
    const allSelected = selectableSchedules.every((s) =>
      selectedSchedules.has(getScheduleKey(s))
    );

    const newSet = new Set(selectedSchedules);
    if (allSelected) {
      // ëª¨ë‘ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
      selectableSchedules.forEach((s) => newSet.delete(getScheduleKey(s)));
    } else {
      // ì¼ë¶€ë§Œ ì„ íƒë˜ì–´ ìˆê±°ë‚˜ ëª¨ë‘ í•´ì œë˜ì–´ ìˆìœ¼ë©´ ì„ íƒ
      selectableSchedules.forEach((s) => newSet.add(getScheduleKey(s)));
    }
    setSelectedSchedules(newSet);
  };

  // ì²« ë²ˆì§¸ í•™ì› ê¸°ë³¸ í¼ì¹¨
  useEffect(() => {
    if (Object.keys(groupedByAcademy).length > 0 && expandedAcademies.size === 0) {
      const firstAcademy = Object.keys(groupedByAcademy)[0];
      setExpandedAcademies(new Set([firstAcademy]));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [groupedByAcademy]);

  // ë“±ë¡ ì²˜ë¦¬
  const handleImport = () => {
    if (conflictInfo.size > 0) {
      // ê²¹ì¹˜ëŠ” ì¼ì •ì´ ìˆìœ¼ë©´ ê²½ê³ 
      return;
    }

    const selected = availableSchedules.filter((s) =>
      selectedSchedules.has(getScheduleKey(s))
    );
    onImport(selected);
    setSelectedSchedules(new Set());
    onClose();
  };

  return (
    <Dialog
      open={isOpen}
      onOpenChange={onClose}
      title="í•™ì› ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°"
      maxWidth="4xl"
    >
      <DialogContent className="max-h-[60vh] overflow-y-auto">
          <div className="flex flex-col gap-4">
            {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
            <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
              <div className="flex items-start gap-2">
                <AlertCircle className="h-4 w-4 flex-shrink-0 text-blue-600" />
                <div className="flex flex-col gap-1 text-xs text-blue-800">
                  <p className="font-semibold">ì‹œê°„ ê´€ë¦¬ì— ë“±ë¡ëœ í•™ì› ì¼ì • ëª©ë¡ì…ë‹ˆë‹¤.</p>
                  <p>
                    ì„ íƒí•˜ì—¬ ë“±ë¡í•˜ì„¸ìš”. ê²¹ì¹˜ëŠ” ì‹œê°„ëŒ€ê°€ ìˆìœ¼ë©´ ê²½ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>

            {/* ì„ íƒ ìš”ì•½ ì •ë³´ */}
            {selectedSchedules.size > 0 && (
              <div className="rounded-lg border border-green-200 bg-green-50 p-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <AlertCircle className="h-4 w-4 text-green-600" />
                    <div className="flex flex-col gap-1 text-xs text-green-800">
                      <p className="font-semibold">
                        {selectedSchedules.size}ê°œ ì¼ì • ì„ íƒë¨
                      </p>
                      {Object.keys(groupedByAcademy).length > 0 && (
                        <p>
                          {Object.entries(groupedByAcademy).filter(([name, schedules]) => 
                            schedules.some(s => selectedSchedules.has(getScheduleKey(s)) && !existingKeys.has(getScheduleKey(s)))
                          ).length}ê°œ í•™ì›ì—ì„œ ì„ íƒ
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ê²¹ì¹¨ ê²½ê³  */}
            {conflictInfo.size > 0 && (
              <div className="rounded-lg border border-red-200 bg-red-50 p-3">
                <div className="flex items-start gap-2">
                  <AlertTriangle className="h-4 w-4 flex-shrink-0 text-red-600" />
                  <div className="flex flex-col gap-1 text-xs text-red-800">
                    <p className="font-semibold">
                      ì„ íƒí•œ ì¼ì • ì¤‘ {conflictInfo.size}ê°œì˜ ì¼ì •ì´ ê¸°ì¡´ ì¼ì •ê³¼ ê²¹ì¹©ë‹ˆë‹¤.
                    </p>
                    <p>
                      ê²¹ì¹˜ëŠ” ì¼ì •ì€ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„ íƒì„ í•´ì œí•˜ê±°ë‚˜ ê¸°ì¡´ ì¼ì •ì„
                      ìˆ˜ì •í•´ì£¼ì„¸ìš”.
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* í•™ì› ì¼ì • ëª©ë¡ */}
            {availableSchedules.length === 0 ? (
              <div className="rounded-lg border border-gray-200 bg-gray-50 p-8">
                <div className="flex flex-col items-center gap-2 text-center">
                  <Clock className="h-12 w-12 text-gray-400" />
                  <div className="flex flex-col gap-1">
                    <p className="text-sm font-medium text-gray-600">
                      ë“±ë¡ëœ í•™ì› ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤
                    </p>
                    <p className="text-xs text-gray-500">
                      ì‹œê°„ ê´€ë¦¬ ë©”ë‰´ì—ì„œ í•™ì› ì¼ì •ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
                    </p>
                  </div>
                </div>
              </div>
            ) : newSchedules.length === 0 ? (
              <div className="rounded-lg border border-gray-200 bg-gray-50 p-8">
                <div className="flex flex-col items-center gap-2 text-center">
                  <AlertCircle className="h-12 w-12 text-gray-400" />
                  <div className="flex flex-col gap-1">
                    <p className="text-sm font-medium text-gray-600">
                      ë¶ˆëŸ¬ì˜¬ ìƒˆë¡œìš´ í•™ì› ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤
                    </p>
                    <p className="text-xs text-gray-500">
                      ëª¨ë“  í•™ì› ì¼ì •ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                    </p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
              {/* ì „ì²´ ì„ íƒ ë° ëª¨ë‘ í¼ì¹˜ê¸°/ì ‘ê¸° */}
              <div className="flex items-center justify-between rounded-lg border border-gray-300 bg-gray-50 p-3">
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={selectedSchedules.size === newSchedules.length}
                    onChange={handleSelectAll}
                    className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900"
                  />
                  <span className="text-sm font-medium text-gray-900">
                    ì „ì²´ ì„ íƒ ({selectedSchedules.size} / {newSchedules.length})
                  </span>
                </div>
                {Object.keys(groupedByAcademy).length > 0 && (
                  <button
                    type="button"
                    onClick={() => {
                      if (expandedAcademies.size === Object.keys(groupedByAcademy).length) {
                        setExpandedAcademies(new Set());
                      } else {
                        setExpandedAcademies(new Set(Object.keys(groupedByAcademy)));
                      }
                    }}
                    className="text-xs font-medium text-gray-600 hover:text-gray-900"
                  >
                    {expandedAcademies.size === Object.keys(groupedByAcademy).length 
                      ? "ëª¨ë‘ ì ‘ê¸°" 
                      : "ëª¨ë‘ í¼ì¹˜ê¸°"}
                  </button>
                )}
              </div>

              {/* í•™ì›ë³„ ê·¸ë£¹ */}
              {Object.entries(groupedByAcademy).map(([academyName, academySchedules]) => {
                // ê¸°ì¡´ ì¼ì •ê³¼ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í•­ëª©ë§Œ í•„í„°ë§
                const selectableSchedules = academySchedules.filter(
                  (s) => !existingKeys.has(getScheduleKey(s))
                );
                
                if (selectableSchedules.length === 0) return null;
                
                const allSelected = selectableSchedules.every((s) =>
                  selectedSchedules.has(getScheduleKey(s))
                );

                const isExpanded = expandedAcademies.has(academyName);
                
                // í•™ì›ë³„ êµê³¼ ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
                const subjects = Array.from(
                  new Set(academySchedules.map(s => s.subject).filter(Boolean))
                ) as string[];
                
                // ì„ íƒëœ ì¼ì • ê°œìˆ˜
                const selectedCount = selectableSchedules.filter(s => 
                  selectedSchedules.has(getScheduleKey(s))
                ).length;

                // í•™ì›ë³„ ì¼ì •ì„ ìš”ì¼ë³„ë¡œ ê·¸ë£¹í™”
                const schedulesByDay = academySchedules.reduce((acc, schedule) => {
                  const day = schedule.day_of_week;
                  if (!acc[day]) {
                    acc[day] = [];
                  }
                  acc[day].push(schedule);
                  return acc;
                }, {} as Record<number, AcademySchedule[]>);

                return (
                  <div key={academyName} className="rounded-lg border border-gray-200 bg-white">
                    {/* í•™ì› í—¤ë” */}
                    <div className="flex w-full items-center justify-between gap-2 rounded-t-lg border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3">
                      {/* í´ë¦­ ê°€ëŠ¥í•œ ì˜ì—­ */}
                      <button
                        type="button"
                        onClick={() => toggleAcademy(academyName)}
                        className="flex flex-1 items-center gap-3 text-left hover:opacity-80 transition-opacity"
                      >
                        {/* ì ‘í˜/í¼ì¹¨ ì•„ì´ì½˜ */}
                        {isExpanded ? (
                          <ChevronDown className="h-4 w-4 text-gray-500 flex-shrink-0" />
                        ) : (
                          <ChevronRight className="h-4 w-4 text-gray-500 flex-shrink-0" />
                        )}
                        
                        {/* í•™ì› ì •ë³´ */}
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <h3 className="text-sm font-semibold text-gray-900">
                              {academyName}
                            </h3>
                            {subjects.length > 0 && (
                              <div className="flex gap-1">
                                {subjects.slice(0, 2).map((subject, idx) => (
                                  <span 
                                    key={idx}
                                    className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800"
                                  >
                                    {subject}
                                  </span>
                                ))}
                                {subjects.length > 2 && (
                                  <span className="text-xs text-gray-500">
                                    +{subjects.length - 2}
                                  </span>
                                )}
                              </div>
                            )}
                          </div>
                          <div className="flex items-center gap-3 text-xs text-gray-600">
                            <span>ì´ {academySchedules.length}ê°œ ì¼ì •</span>
                            {selectedCount > 0 && (
                              <span className="font-medium text-blue-700">
                                âœ“ {selectedCount}ê°œ ì„ íƒ
                              </span>
                            )}
                          </div>
                        </div>
                      </button>
                      
                      {/* ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼ */}
                      <button
                        type="button"
                        onClick={() => handleSelectAcademy(academyName)}
                        className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${
                          allSelected
                            ? "bg-gray-900 text-white hover:bg-gray-800"
                            : "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"
                        }`}
                      >
                        {allSelected ? "ì „ì²´ í•´ì œ" : "ì „ì²´ ì„ íƒ"}
                      </button>
                    </div>
                    
                    {/* ìš”ì¼ë³„ ì¼ì • ëª©ë¡ - ì ‘í˜ ìƒíƒœì— ë”°ë¼ í‘œì‹œ/ìˆ¨ê¹€ */}
                    {isExpanded && (
                      <div className="p-4 space-y-3">
                        {Object.entries(schedulesByDay).map(([dayOfWeek, daySchedules]) => {
                      const day = Number(dayOfWeek);
                      return (
                        <div key={day} className="space-y-2">
                          <h4 className="text-xs font-medium text-gray-600">
                            {weekdayLabels[day]}ìš”ì¼
                          </h4>
                          <div className="space-y-2">
                            {daySchedules.map((schedule) => {
                              const key = getScheduleKey(schedule);
                              const isExisting = existingKeys.has(key);
                              const isSelected = selectedSchedules.has(key);
                              const conflicts = conflictInfo.get(key);
                              const hasConflict = conflicts && conflicts.length > 0;

                              return (
                                <div
                                  key={key}
                                  className={`flex items-start gap-3 rounded-lg border p-3 transition-colors ${
                                    isExisting
                                      ? "border-gray-200 bg-gray-50 opacity-60"
                                      : hasConflict
                                      ? "border-red-300 bg-red-50"
                                      : isSelected
                                      ? "border-gray-900 bg-gray-50"
                                      : "border-gray-200 bg-white hover:bg-gray-50"
                                  }`}
                                >
                                  <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={() => handleToggle(schedule)}
                                    disabled={isExisting}
                                    className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-50"
                                  />
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <span className="font-medium text-gray-900">
                                        {schedule.start_time} ~ {schedule.end_time}
                                      </span>
                                      {isExisting && (
                                        <span className="rounded-full bg-gray-200 px-2 py-0.5 text-xs font-medium text-gray-600">
                                          ë“±ë¡ë¨
                                        </span>
                                      )}
                                      {hasConflict && (
                                        <span className="rounded-full bg-red-200 px-2 py-0.5 text-xs font-medium text-red-800">
                                          ì‹œê°„ ê²¹ì¹¨
                                        </span>
                                      )}
                                    </div>
                                    <div className="flex items-center gap-2 text-xs text-gray-600">
                                      {schedule.subject && (
                                        <span>{schedule.subject}</span>
                                      )}
                                      {schedule.travel_time && (
                                        <span className="text-gray-500">
                                          ì´ë™ì‹œê°„: {schedule.travel_time}ë¶„
                                        </span>
                                      )}
                                    </div>
                                    {hasConflict && (
                                      <div className="flex flex-col gap-1 rounded border border-red-200 bg-white p-2 text-xs text-red-700">
                                        <p className="font-semibold">ê²¹ì¹˜ëŠ” ì¼ì •:</p>
                                        {conflicts.map((conflictSchedule, idx) => (
                                          <p key={idx}>
                                            â€¢ {getScheduleDescription(conflictSchedule)}
                                          </p>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })}
                      </div>
                    )}
                  </div>
                );
              })}
              </div>
            )}
          </div>
      </DialogContent>
      <DialogFooter>
        <div className="flex w-full items-center justify-between">
          <p className="text-sm text-gray-600">
            ì„ íƒëœ í•­ëª©: <span className="font-semibold">{selectedSchedules.size}ê°œ</span>
            {conflictInfo.size > 0 && (
              <span className="text-red-600">
                (ê²¹ì¹¨: {conflictInfo.size}ê°œ)
              </span>
            )}
          </p>
          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={onClose}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              onClick={handleImport}
              disabled={selectedSchedules.size === 0 || conflictInfo.size > 0}
              className="rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50"
            >
              ì„ íƒ í•­ëª© ë“±ë¡
            </button>
          </div>
        </div>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="new-group/_components/_panels/_modals/ExclusionImportModal.tsx">
"use client";

import React, { useState, useMemo } from "react";
import { Calendar, AlertCircle } from "lucide-react";
import { format } from "date-fns";
import { ko } from "date-fns/locale";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";

type Exclusion = {
  exclusion_date: string;
  exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
  reason?: string;
  source?: "template" | "student" | "time_management";
  is_locked?: boolean;
};

type ExclusionImportModalProps = {
  isOpen: boolean;
  onClose: () => void;
  availableExclusions: Exclusion[];
  existingExclusions: Exclusion[];
  onImport: (selectedExclusions: Exclusion[]) => void;
  periodStart: string;
  periodEnd: string;
};

const exclusionTypeColors = {
  íœ´ê°€: "bg-blue-100 text-blue-800 border-blue-300",
  ê°œì¸ì‚¬ì •: "bg-purple-100 text-purple-800 border-purple-300",
  íœ´ì¼ì§€ì •: "bg-orange-100 text-orange-800 border-orange-300",
  ê¸°íƒ€: "bg-gray-100 text-gray-800 border-gray-300",
};

/**
 * ì œì™¸ì¼ ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬
 * - í”Œëœ ê¸°ê°„ ë‚´ ì œì™¸ì¼ ëª©ë¡ í‘œì‹œ
 * - ì²´í¬ë°•ìŠ¤ë¡œ ë‹¤ì¤‘ ì„ íƒ
 * - ì´ë¯¸ ë“±ë¡ëœ ì œì™¸ì¼ì€ ë¹„í™œì„±í™”
 */
export function ExclusionImportModal({
  isOpen,
  onClose,
  availableExclusions,
  existingExclusions,
  onImport,
  periodStart,
  periodEnd,
}: ExclusionImportModalProps) {
  const [selectedDates, setSelectedDates] = useState<Set<string>>(new Set());

  // ì œì™¸ì¼ ê³ ìœ  í‚¤ ìƒì„± í•¨ìˆ˜ (ë‚ ì§œ + ìœ í˜•)
  const getExclusionKey = (exclusion: Exclusion): string => {
    return `${exclusion.exclusion_date}-${exclusion.exclusion_type}`;
  };

  // ê¸°ì¡´ ì œì™¸ì¼ í‚¤ Set (ë‚ ì§œ+ìœ í˜• ì¡°í•©)
  const existingKeys = useMemo(() => {
    return new Set(existingExclusions.map(getExclusionKey));
  }, [existingExclusions]);

  // í”Œëœ ê¸°ê°„ ë‚´ ì œì™¸ì¼ í•„í„°ë§ ë° ì •ë ¬
  const filteredExclusions = useMemo(() => {
    const startDate = new Date(periodStart);
    startDate.setHours(0, 0, 0, 0);
    const endDate = new Date(periodEnd);
    endDate.setHours(23, 59, 59, 999);

    return availableExclusions
      .filter((e) => {
        const exclusionDate = new Date(e.exclusion_date);
        exclusionDate.setHours(0, 0, 0, 0);
        return exclusionDate >= startDate && exclusionDate <= endDate;
      })
      .sort((a, b) => a.exclusion_date.localeCompare(b.exclusion_date));
  }, [availableExclusions, periodStart, periodEnd]);

  // ìƒˆë¡œ ì¶”ê°€ ê°€ëŠ¥í•œ ì œì™¸ì¼ (ë‚ ì§œ+ìœ í˜• ì¡°í•©ìœ¼ë¡œ ì²´í¬)
  const newExclusions = useMemo(() => {
    return filteredExclusions.filter(
      (e) => !existingKeys.has(getExclusionKey(e))
    );
  }, [filteredExclusions, existingKeys]);

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const handleSelectAll = () => {
    if (selectedDates.size === newExclusions.length) {
      setSelectedDates(new Set());
    } else {
      setSelectedDates(new Set(newExclusions.map((e) => e.exclusion_date)));
    }
  };

  // ê°œë³„ ì„ íƒ/í•´ì œ
  const handleToggle = (date: string) => {
    const newSet = new Set(selectedDates);
    if (newSet.has(date)) {
      newSet.delete(date);
    } else {
      newSet.add(date);
    }
    setSelectedDates(newSet);
  };

  // ë“±ë¡ ì²˜ë¦¬
  const handleImport = () => {
    const selectedExclusions = filteredExclusions.filter((e) =>
      selectedDates.has(e.exclusion_date)
    );
    onImport(selectedExclusions);
    setSelectedDates(new Set());
    onClose();
  };

  return (
    <Dialog
      open={isOpen}
      onOpenChange={onClose}
      title="ì œì™¸ì¼ ë¶ˆëŸ¬ì˜¤ê¸°"
      maxWidth="3xl"
    >
      <DialogContent className="max-h-[60vh] overflow-y-auto">
          <div className="flex flex-col gap-4">
            {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
            <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
              <div className="flex items-start gap-2">
                <AlertCircle className="h-4 w-4 flex-shrink-0 text-blue-600" />
                <div className="flex flex-col gap-1 text-xs text-blue-800">
                  <p className="font-semibold">
                    í”Œëœ ê¸°ê°„: {format(new Date(periodStart), "yyyyë…„ Mì›” dì¼", { locale: ko })} ~{" "}
                    {format(new Date(periodEnd), "yyyyë…„ Mì›” dì¼", { locale: ko })}
                  </p>
                  <p>
                    í•´ë‹¹ ê¸°ê°„ ë‚´ ì‹œê°„ ê´€ë¦¬ì— ë“±ë¡ëœ ì œì™¸ì¼ ëª©ë¡ì…ë‹ˆë‹¤. ì„ íƒí•˜ì—¬ ë“±ë¡í•˜ì„¸ìš”.
                  </p>
                </div>
              </div>
            </div>

            {/* ì œì™¸ì¼ ëª©ë¡ */}
            {filteredExclusions.length === 0 ? (
              <div className="rounded-lg border border-gray-200 bg-gray-50 p-8">
                <div className="flex flex-col items-center gap-2 text-center">
                  <Calendar className="h-12 w-12 text-gray-400" />
                  <div className="flex flex-col gap-1">
                    <p className="text-sm font-medium text-gray-600">
                      í”Œëœ ê¸°ê°„ ë‚´ ë“±ë¡ëœ ì œì™¸ì¼ì´ ì—†ìŠµë‹ˆë‹¤
                    </p>
                    <p className="text-xs text-gray-500">
                      ì‹œê°„ ê´€ë¦¬ ë©”ë‰´ì—ì„œ ì œì™¸ì¼ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
                    </p>
                  </div>
                </div>
              </div>
            ) : newExclusions.length === 0 ? (
              <div className="rounded-lg border border-gray-200 bg-gray-50 p-8">
                <div className="flex flex-col items-center gap-2 text-center">
                  <AlertCircle className="h-12 w-12 text-gray-400" />
                  <div className="flex flex-col gap-1">
                    <p className="text-sm font-medium text-gray-600">
                      ë¶ˆëŸ¬ì˜¬ ìƒˆë¡œìš´ ì œì™¸ì¼ì´ ì—†ìŠµë‹ˆë‹¤
                    </p>
                    <p className="text-xs text-gray-500">
                      ëª¨ë“  ì œì™¸ì¼ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                    </p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="space-y-3">
              {/* ì „ì²´ ì„ íƒ */}
              <div className="flex items-center gap-2 rounded-lg border border-gray-300 bg-gray-50 p-3">
                <input
                  type="checkbox"
                  checked={selectedDates.size === newExclusions.length}
                  onChange={handleSelectAll}
                  className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900"
                />
                <span className="text-sm font-medium text-gray-900">
                  ì „ì²´ ì„ íƒ ({selectedDates.size} / {newExclusions.length})
                </span>
              </div>

              {/* ì œì™¸ì¼ í•­ëª© */}
              {filteredExclusions.map((exclusion) => {
                const exclusionKey = getExclusionKey(exclusion);
                const isExisting = existingKeys.has(exclusionKey);
                const isSelected = selectedDates.has(exclusion.exclusion_date);

                return (
                  <div
                    key={exclusionKey}
                    className={`flex items-start gap-3 rounded-lg border p-3 transition-colors ${
                      isExisting
                        ? "border-gray-200 bg-gray-50 opacity-60"
                        : isSelected
                        ? "border-gray-900 bg-gray-50"
                        : "border-gray-200 bg-white hover:bg-gray-50"
                    }`}
                  >
                    <input
                      type="checkbox"
                      checked={isSelected}
                      onChange={() => handleToggle(exclusion.exclusion_date)}
                      disabled={isExisting}
                      className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-50"
                    />
                    <div className="flex flex-col gap-1 flex-1">
                      <div className="flex items-center gap-2">
                        <span className="font-medium text-gray-900">
                          {format(new Date(exclusion.exclusion_date), "yyyyë…„ Mì›” dì¼ (E)", {
                            locale: ko,
                          })}
                        </span>
                        <span
                          className={`rounded-full border px-2 py-0.5 text-xs font-medium ${
                            exclusionTypeColors[exclusion.exclusion_type]
                          }`}
                        >
                          {exclusion.exclusion_type}
                        </span>
                        {isExisting && (
                          <span className="rounded-full bg-gray-200 px-2 py-0.5 text-xs font-medium text-gray-600">
                            ë“±ë¡ë¨
                          </span>
                        )}
                      </div>
                      {exclusion.reason && (
                        <p className="text-xs text-gray-600">
                          ì‚¬ìœ : {exclusion.reason}
                        </p>
                      )}
                    </div>
                  </div>
                );
              })}
              </div>
            )}
          </div>
      </DialogContent>
      <DialogFooter>
        <div className="flex w-full items-center justify-between">
          <p className="text-sm text-gray-600">
            ì„ íƒëœ í•­ëª©: <span className="font-semibold">{selectedDates.size}ê°œ</span>
          </p>
          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={onClose}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              onClick={handleImport}
              disabled={selectedDates.size === 0}
              className="rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50"
            >
              ì„ íƒ í•­ëª© ë“±ë¡
            </button>
          </div>
        </div>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="new-group/_components/_panels/AcademySchedulePanel.tsx">
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { RefreshCw, Lock, Clock, User } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { useToast } from "@/components/ui/ToastProvider";
import { syncTimeManagementAcademySchedulesAction } from "@/app/(student)/actions/planGroupActions";
import { AcademyScheduleImportModal } from "./_modals/AcademyScheduleImportModal";
import { validateAcademyScheduleOverlap } from "@/lib/validation/scheduleValidator";

type AcademySchedulePanelProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  groupId?: string;
  campMode?: boolean;
  isTemplateMode?: boolean;
  editable?: boolean;
  studentId?: string;
  isAdminMode?: boolean;
  isAdminContinueMode?: boolean;
};

const weekdayLabels = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"];

/**
 * í•™ì› ì¼ì • ê´€ë¦¬ íŒ¨ë„
 * - ìš”ì¼ë³„ í•™ì› ì¼ì • ì¶”ê°€
 * - ì‹œê°„ ê´€ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
 * - í…œí”Œë¦¿ í•™ì› ì¼ì • ê´€ë¦¬
 */
export const AcademySchedulePanel = React.memo(function AcademySchedulePanel({
  data,
  onUpdate,
  groupId,
  campMode = false,
  isTemplateMode = false,
  editable = true,
  studentId,
  isAdminMode = false,
  isAdminContinueMode = false,
}: AcademySchedulePanelProps) {
  const toast = useToast();
  
  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ í™•ì¸
  const lockedFields = data.templateLockedFields?.step2 || {};
  
  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•„ë“œ ì œì–´ í† ê¸€
  const toggleFieldControl = (fieldName: keyof typeof lockedFields) => {
    if (!isTemplateMode) return;
    
    const currentLocked = data.templateLockedFields?.step2 || {};
    const newLocked = {
      ...currentLocked,
      [fieldName]: !currentLocked[fieldName],
    };
    
    onUpdate({
      templateLockedFields: {
        ...data.templateLockedFields,
        step2: newLocked,
      },
    });
  };
  
  // í•™ìƒ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€
  const canStudentInputAcademySchedules = campMode
    ? (lockedFields.allow_student_academy_schedules !== false)
    : true;

  // ë¡œì»¬ ìƒíƒœ
  const [newAcademyDays, setNewAcademyDays] = useState<number[]>([]);
  const [newAcademyStartTime, setNewAcademyStartTime] = useState("09:00");
  const [newAcademyEndTime, setNewAcademyEndTime] = useState("10:00");
  const [newAcademyName, setNewAcademyName] = useState("");
  const [newAcademySubject, setNewAcademySubject] = useState("");
  const [newAcademyTravelTime, setNewAcademyTravelTime] = useState<number>(60);
  
  // ëª¨ë‹¬ ìƒíƒœ
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);
  const [availableSchedules, setAvailableSchedules] = useState<Array<{
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string;
    subject?: string;
    travel_time?: number;
    source?: "time_management";
  }>>([]);
  
  // ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆëŠ” í•™ì› ì¼ì • ê°œìˆ˜ ìƒíƒœ
  const [availableCount, setAvailableCount] = useState<number | null>(null);
  const [isLoadingCount, setIsLoadingCount] = useState(false);

  const toggleWeekday = (day: number) => {
    if (!editable) return;
    setNewAcademyDays((prev) =>
      prev.includes(day) ? prev.filter((d) => d !== day) : [...prev, day]
    );
  };

  // í•™ì› ì¼ì •ì„ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ê¸° ìœ„í•œ í‚¤ ìƒì„±
  const getScheduleKey = (schedule: {
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string;
    subject?: string;
  }): string => {
    return `${schedule.day_of_week}-${schedule.start_time}-${schedule.end_time}-${schedule.academy_name || ""}-${schedule.subject || ""}`;
  };

  // ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆëŠ” í•™ì› ì¼ì • ê°œìˆ˜ ì¡°íšŒ
  const loadAvailableCount = async () => {
    try {
      setIsLoadingCount(true);
      const targetStudentId = (isAdminMode || isAdminContinueMode) ? studentId : undefined;
      const result = await syncTimeManagementAcademySchedulesAction(groupId || null, targetStudentId);
      
      if (result.academySchedules && result.academySchedules.length > 0) {
        // ê¸°ì¡´ í•™ì› ì¼ì •ê³¼ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í•­ëª©ë§Œ í•„í„°ë§
        const existingKeys = new Set(data.academy_schedules.map(getScheduleKey));
        const newSchedules = result.academySchedules.filter(
          (s) => !existingKeys.has(getScheduleKey(s))
        );
        
        // ê¸°ì¡´ í•™ì› ì¼ì •ì˜ í•™ì›ëª… Set ìƒì„±
        const existingAcademyNames = new Set(
          data.academy_schedules
            .map((s) => s.academy_name || "")
            .filter((name) => name !== "")
        );
        
        // ê³ ìœ  í•™ì›ëª… Set ìƒì„± (í•™ì› ë‹¨ìœ„ ì¹´ìš´íŒ…)
        const uniqueAcademyNames = new Set(
          newSchedules
            .map((s) => s.academy_name || "")
            .filter((name) => name !== "" && !existingAcademyNames.has(name))
        );
        
        const newCount = uniqueAcademyNames.size;
        setAvailableCount(newCount);
      } else {
        setAvailableCount(0);
      }
    } catch (error) {
      console.error("í•™ì› ì¼ì • ê°œìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", error);
      setAvailableCount(null);
    } finally {
      setIsLoadingCount(false);
    }
  };

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë° ê¸°ì¡´ í•™ì› ì¼ì • ë³€ê²½ ì‹œ ê°œìˆ˜ ì¡°íšŒ
  useEffect(() => {
    if (editable) {
      loadAvailableCount();
    }
  }, [data.academy_schedules.length]);

  const addAcademySchedule = () => {
    if (!editable) return;
    if (newAcademyDays.length === 0) {
      toast.showError("ìš”ì¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!newAcademyStartTime || !newAcademyEndTime) {
      toast.showError("ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!newAcademyName.trim()) {
      toast.showError("í•™ì› ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!newAcademySubject.trim()) {
      toast.showError("ê³¼ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!newAcademyTravelTime || newAcademyTravelTime <= 0) {
      toast.showError("ì´ë™ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 1ë¶„ ì´ìƒ)");
      return;
    }

    // ì„ íƒëœ ìš”ì¼ë§ˆë‹¤ ì¼ì • ì¶”ê°€
    const newSchedules = newAcademyDays.map((day) => ({
      day_of_week: day,
      start_time: newAcademyStartTime,
      end_time: newAcademyEndTime,
      academy_name: newAcademyName.trim(),
      subject: newAcademySubject.trim(),
      travel_time: newAcademyTravelTime || 60,
      source: isTemplateMode ? ("template" as const) : ("student" as const),
      is_locked: isTemplateMode ? true : undefined,
    }));

    // ê²¹ì¹¨ ê²€ì¦
    for (const newSchedule of newSchedules) {
      const validation = validateAcademyScheduleOverlap(newSchedule, data.academy_schedules);
      if (!validation.isValid) {
        toast.showError(
          `${weekdayLabels[newSchedule.day_of_week]}ì— ê²¹ì¹˜ëŠ” í•™ì› ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤. ì‹œê°„ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.`
        );
        return;
      }
    }

    onUpdate({
      academy_schedules: [...data.academy_schedules, ...newSchedules],
    });

    // í¼ ì´ˆê¸°í™”
    setNewAcademyDays([]);
    setNewAcademyStartTime("09:00");
    setNewAcademyEndTime("10:00");
    setNewAcademyName("");
    setNewAcademySubject("");
    setNewAcademyTravelTime(60);
  };

  const removeAcademySchedule = (index: number) => {
    if (!editable) return;
    const schedule = data.academy_schedules[index];
    const isTemplateSchedule = schedule.is_locked || schedule.source === "template";
    
    if (campMode && isTemplateSchedule) {
      toast.showError("í…œí”Œë¦¿ì—ì„œ ì§€ì •ëœ í•™ì› ì¼ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    onUpdate({
      academy_schedules: data.academy_schedules.filter((_, i) => i !== index),
    });
  };

  const syncFromTimeManagement = async () => {
    try {
      const targetStudentId = (isAdminMode || isAdminContinueMode) ? studentId : undefined;
      const result = await syncTimeManagementAcademySchedulesAction(groupId || null, targetStudentId);
      
      if (result.academySchedules && result.academySchedules.length > 0) {
        // ëª¨ë‹¬ë¡œ ì„ íƒ ë“±ë¡ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
        setAvailableSchedules(result.academySchedules);
        setIsImportModalOpen(true);
      } else {
        toast.showInfo("ë“±ë¡ëœ í•™ì› ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      toast.showError(
        error instanceof Error
          ? error.message
          : "í•™ì› ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    }
  };

  const handleImportSchedules = (selectedSchedules: Array<{
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string;
    subject?: string;
    travel_time?: number;
    source?: "template" | "student" | "time_management";
    is_locked?: boolean;
  }>) => {
    const newSchedules = selectedSchedules.map((s) => ({
      ...s,
      source: "time_management" as const,
    }));
    
    onUpdate({
      academy_schedules: [...data.academy_schedules, ...newSchedules],
    });
    
    toast.showSuccess(`${newSchedules.length}ê°œì˜ í•™ì› ì¼ì •ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.`);
    
    // ë“±ë¡ í›„ ê°œìˆ˜ ë‹¤ì‹œ ì¡°íšŒ
    loadAvailableCount();
  };

  return (
    <>
      {/* í•™ì› ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ */}
      <AcademyScheduleImportModal
        isOpen={isImportModalOpen}
        onClose={() => setIsImportModalOpen(false)}
        availableSchedules={availableSchedules}
        existingSchedules={data.academy_schedules}
        onImport={handleImportSchedules}
      />

      {/* í—¤ë” */}
      <div className="flex items-center justify-end gap-2">
        <button
          type="button"
          onClick={syncFromTimeManagement}
          className="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-800 hover:bg-gray-50"
        >
          <RefreshCw className={`h-3 w-3 ${isLoadingCount ? "animate-spin" : ""}`} />
          ì‹œê°„ ê´€ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
        {availableCount !== null && availableCount > 0 && (
          <span className="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
            {availableCount}ê°œ
          </span>
        )}
      </div>

      {/* í•™ì› ì¼ì • ì¶”ê°€ í¼ */}
      {editable && (!campMode || canStudentInputAcademySchedules) && (
        <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
          {/* ìš”ì¼ ì„ íƒ */}
          <div className="flex flex-col gap-2">
            <label className="block text-xs font-medium text-gray-800">
              ìš”ì¼ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥) <span className="text-red-500">*</span>
            </label>
            <div className="flex flex-wrap gap-2">
              {weekdayLabels.map((label, index) => (
                <button
                  key={index}
                  type="button"
                  onClick={() => toggleWeekday(index)}
                  className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${
                    newAcademyDays.includes(index)
                      ? "bg-gray-900 text-white"
                      : "bg-white text-gray-800 hover:bg-gray-100"
                  }`}
                >
                  {label}
                </button>
              ))}
            </div>
            {newAcademyDays.length > 0 && (
              <p className="text-xs text-gray-600">
                {newAcademyDays.length}ê°œ ìš”ì¼ ì„ íƒë¨
              </p>
            )}
          </div>

          {/* ì‹œê°„ ì„¤ì • */}
          <div className="grid grid-cols-2 gap-3">
            <div className="flex flex-col gap-1">
              <label className="block text-xs font-medium text-gray-800">
                ì‹œì‘ ì‹œê°„ <span className="text-red-500">*</span>
              </label>
              <input
                type="time"
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                value={newAcademyStartTime}
                onChange={(e) => {
                  if (!editable) return;
                  setNewAcademyStartTime(e.target.value);
                }}
                disabled={!editable}
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-xs font-medium text-gray-800">
                ì¢…ë£Œ ì‹œê°„ <span className="text-red-500">*</span>
              </label>
              <input
                type="time"
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                value={newAcademyEndTime}
                onChange={(e) => {
                  if (!editable) return;
                  setNewAcademyEndTime(e.target.value);
                }}
                disabled={!editable}
              />
            </div>
          </div>

          {/* í•™ì› ì •ë³´ */}
          <div className="grid gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-1">
              <label className="block text-xs font-medium text-gray-800">
                í•™ì› ì´ë¦„ <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                placeholder="ì˜ˆ: ìˆ˜í•™ í•™ì›"
                value={newAcademyName}
                onChange={(e) => {
                  if (!editable) return;
                  setNewAcademyName(e.target.value);
                }}
                disabled={!editable}
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-xs font-medium text-gray-800">
                ê³¼ëª© <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                placeholder="ì˜ˆ: ìˆ˜í•™"
                value={newAcademySubject}
                onChange={(e) => {
                  if (!editable) return;
                  setNewAcademySubject(e.target.value);
                }}
                disabled={!editable}
              />
            </div>
          </div>

          {/* ì´ë™ì‹œê°„ */}
          <div className="flex flex-col gap-1">
            <label className="block text-xs font-medium text-gray-800">
              ì´ë™ì‹œê°„ (ë¶„) <span className="text-red-500">*</span>
            </label>
            <div className="flex items-center gap-2">
              <input
                type="number"
                min="0"
                max="300"
                step="15"
                required
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                placeholder="60"
                value={newAcademyTravelTime}
                onChange={(e) => {
                  if (!editable) return;
                  const value = parseInt(e.target.value) || 0;
                  setNewAcademyTravelTime(Math.max(0, Math.min(300, value)));
                }}
                disabled={!editable}
              />
              <span className="text-xs text-gray-600">ë¶„</span>
            </div>
            <p className="text-xs text-gray-600">
              ë¸”ë¡ ì‹œê°„ ë‚´ í•™ì› ì¼ì •ì´ ìˆëŠ” ê²½ìš°, í•™ì› ì „í›„ë¡œ ì´ë™ì‹œê°„ì„ ìë™ìœ¼ë¡œ ì œì™¸í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: 60ë¶„)
            </p>
          </div>

          <button
            type="button"
            onClick={addAcademySchedule}
            disabled={
              !editable ||
              newAcademyDays.length === 0 ||
              !newAcademyStartTime ||
              !newAcademyEndTime ||
              !newAcademyName.trim() ||
              !newAcademySubject.trim() ||
              !newAcademyTravelTime ||
              newAcademyTravelTime <= 0
            }
            className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
          >
            í•™ì› ì¼ì • ì¶”ê°€
          </button>
        </div>
      )}

      {/* í•™ì› ì¼ì • ëª©ë¡ */}
      {data.academy_schedules.length > 0 ? (
        <div className="flex flex-col gap-2">
          {data.academy_schedules.map((schedule, index) => (
            <div
              key={index}
              className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3"
            >
              <div className="flex flex-col gap-1 flex-1">
                <div className="text-sm font-medium text-gray-900">
                  {weekdayLabels[schedule.day_of_week]} {schedule.start_time} ~ {schedule.end_time}
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-600">
                  {schedule.academy_name && <span>{schedule.academy_name}</span>}
                  {schedule.subject && <span>Â· {schedule.subject}</span>}
                  <span>Â· ì´ë™ì‹œê°„: {schedule.travel_time || 60}ë¶„</span>
                  {schedule.source === "template" && (
                    <span className="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                      <Lock className="h-3 w-3" />
                      í…œí”Œë¦¿
                    </span>
                  )}
                  {schedule.source === "time_management" && (
                    <span className="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-800">
                      <Clock className="h-3 w-3" />
                      ì‹œê°„ ê´€ë¦¬
                    </span>
                  )}
                  {schedule.source === "student" && (
                    <span className="inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
                      <User className="h-3 w-3" />
                      ì§ì ‘ ì…ë ¥
                    </span>
                  )}
                </div>
              </div>
              <button
                type="button"
                onClick={() => removeAcademySchedule(index)}
                disabled={
                  !editable ||
                  (campMode && (schedule.is_locked || schedule.source === "template"))
                }
                className={`text-sm ${
                  !editable || (campMode && (schedule.is_locked || schedule.source === "template"))
                    ? "cursor-not-allowed text-gray-600"
                    : "text-red-600 hover:text-red-800"
                }`}
                title={
                  campMode && (schedule.is_locked || schedule.source === "template")
                    ? "í…œí”Œë¦¿ì—ì„œ ì§€ì •ëœ í•™ì› ì¼ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                    : "ì‚­ì œ"
                }
              >
                ì‚­ì œ
              </button>
            </div>
          ))}
        </div>
      ) : (
        <p className="text-sm text-gray-600">ë“±ë¡ëœ í•™ì› ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      )}
    </>
  );
});
</file>

<file path="new-group/_components/_panels/ExclusionsPanel.tsx">
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { Info, RefreshCw, Lock, Clock, User } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { useToast } from "@/components/ui/ToastProvider";
import { syncTimeManagementExclusionsAction } from "@/app/(student)/actions/planGroupActions";
import { ExclusionImportModal } from "./_modals/ExclusionImportModal";
import { formatDateFromDate, parseDateString } from "@/lib/utils/date";
import { DateInput } from "../_shared/DateInput";

type ExclusionsPanelProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  periodStart: string;
  periodEnd: string;
  groupId?: string;
  onNavigateToStep?: (step: number) => void;
  campMode?: boolean;
  isTemplateMode?: boolean;
  templateExclusions?: Array<{
    exclusion_date: string;
    exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
    reason?: string;
  }>;
  editable?: boolean;
};

type ExclusionInputType = "single" | "range" | "multiple";

const exclusionTypes = [
  { value: "íœ´ê°€", label: "íœ´ê°€" },
  { value: "ê°œì¸ì‚¬ì •", label: "ê°œì¸ì‚¬ì •" },
  { value: "íœ´ì¼ì§€ì •", label: "íœ´ì¼ì§€ì •" },
  { value: "ê¸°íƒ€", label: "ê¸°íƒ€" },
] as const;

/**
 * ì œì™¸ì¼ ê´€ë¦¬ íŒ¨ë„
 * - ë‹¨ì¼/ë²”ìœ„/ë‹¤ì¤‘ ë‚ ì§œ ì…ë ¥
 * - ì‹œê°„ ê´€ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
 * - í…œí”Œë¦¿ ì œì™¸ì¼ ê´€ë¦¬
 */
export const ExclusionsPanel = React.memo(function ExclusionsPanel({
  data,
  onUpdate,
  periodStart,
  periodEnd,
  groupId,
  onNavigateToStep,
  campMode = false,
  isTemplateMode = false,
  templateExclusions,
  editable = true,
}: ExclusionsPanelProps) {
  const toast = useToast();

  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ í™•ì¸
  const lockedFields = data.templateLockedFields?.step2 || {};

  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•„ë“œ ì œì–´ í† ê¸€
  const toggleFieldControl = (fieldName: keyof typeof lockedFields) => {
    if (!isTemplateMode) return;

    const currentLocked = data.templateLockedFields?.step2 || {};
    const newLocked = {
      ...currentLocked,
      [fieldName]: !currentLocked[fieldName],
    };

    onUpdate({
      templateLockedFields: {
        ...data.templateLockedFields,
        step2: newLocked,
      },
    });
  };

  // í•™ìƒ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€
  const canStudentInputExclusions = campMode
    ? lockedFields.allow_student_exclusions !== false
    : true;

  // ë¡œì»¬ ìƒíƒœ
  const [exclusionInputType, setExclusionInputType] =
    useState<ExclusionInputType>("single");
  const [newExclusionDate, setNewExclusionDate] = useState("");
  const [newExclusionStartDate, setNewExclusionStartDate] = useState("");
  const [newExclusionEndDate, setNewExclusionEndDate] = useState("");
  const [newExclusionDates, setNewExclusionDates] = useState<string[]>([]);
  const [newExclusionType, setNewExclusionType] = useState<
    "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€"
  >("íœ´ê°€");
  const [newExclusionReason, setNewExclusionReason] = useState("");

  // ëª¨ë‹¬ ìƒíƒœ
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);
  const [availableExclusions, setAvailableExclusions] = useState<
    Array<{
      exclusion_date: string;
      exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
      reason?: string;
      source?: "time_management";
    }>
  >([]);

  // ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆëŠ” ì œì™¸ì¼ ê°œìˆ˜ ìƒíƒœ
  const [availableCount, setAvailableCount] = useState<number | null>(null);
  const [isLoadingCount, setIsLoadingCount] = useState(false);

  const toggleExclusionDate = (date: string) => {
    if (!editable) return;
    setNewExclusionDates((prev) =>
      prev.includes(date) ? prev.filter((d) => d !== date) : [...prev, date]
    );
  };

  // ì œì™¸ì¼ ê³ ìœ  í‚¤ ìƒì„± í•¨ìˆ˜ (ë‚ ì§œ + ìœ í˜•)
  const getExclusionKey = (exclusion: {
    exclusion_date: string;
    exclusion_type: string;
  }): string => {
    return `${exclusion.exclusion_date}-${exclusion.exclusion_type}`;
  };

  // ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆëŠ” ì œì™¸ì¼ ê°œìˆ˜ ì¡°íšŒ
  const loadAvailableCount = async () => {
    try {
      setIsLoadingCount(true);
      // í…œí”Œë¦¿ ëª¨ë“œì¼ ë•ŒëŠ” studentId ì—†ì´ í˜¸ì¶œ (ë¹ˆ ê²°ê³¼ ë°˜í™˜)
      const result = await syncTimeManagementExclusionsAction(
        groupId || null,
        periodStart,
        periodEnd,
        undefined // studentIdëŠ” í…œí”Œë¦¿ ëª¨ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      );

      if (result.exclusions && result.exclusions.length > 0) {
        // ê¸°ì¡´ ì œì™¸ì¼ê³¼ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í•­ëª©ë§Œ ì¹´ìš´íŠ¸ (ë‚ ì§œ+ìœ í˜• ì¡°í•©)
        const existingKeys = new Set(data.exclusions.map(getExclusionKey));
        const newCount = result.exclusions.filter(
          (e) => !existingKeys.has(getExclusionKey(e))
        ).length;
        setAvailableCount(newCount);
      } else {
        setAvailableCount(0);
      }
    } catch (error) {
      console.error("ì œì™¸ì¼ ê°œìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", error);
      setAvailableCount(null);
    } finally {
      setIsLoadingCount(false);
    }
  };

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë° ê¸°ê°„/ê¸°ì¡´ ì œì™¸ì¼ ë³€ê²½ ì‹œ ê°œìˆ˜ ì¡°íšŒ
  useEffect(() => {
    if (editable && periodStart && periodEnd) {
      loadAvailableCount();
    }
  }, [periodStart, periodEnd, data.exclusions.length]);

  const generateDateRange = (start: string, end: string): string[] => {
    const dates: string[] = [];
    // YYYY-MM-DD í˜•ì‹ ë¬¸ìì—´ì„ ì§ì ‘ íŒŒì‹±í•˜ì—¬ íƒ€ì„ì¡´ ë¬¸ì œ ë°©ì§€
    const startParts = parseDateString(start);
    const endParts = parseDateString(end);
    const startDate = new Date(
      startParts.year,
      startParts.month - 1,
      startParts.day
    );
    const endDate = new Date(endParts.year, endParts.month - 1, endParts.day);
    const current = new Date(startDate);

    while (current <= endDate) {
      dates.push(formatDateFromDate(current));
      current.setDate(current.getDate() + 1);
    }

    return dates;
  };

  const addExclusion = () => {
    if (!editable) return;
    let datesToAdd: string[] = [];

    if (exclusionInputType === "single") {
      if (!newExclusionDate) {
        toast.showError("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      datesToAdd = [newExclusionDate];
    } else if (exclusionInputType === "range") {
      if (!newExclusionStartDate || !newExclusionEndDate) {
        toast.showError("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      if (new Date(newExclusionStartDate) > new Date(newExclusionEndDate)) {
        toast.showError("ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì•ì„œì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
      datesToAdd = generateDateRange(
        newExclusionStartDate,
        newExclusionEndDate
      );
    } else if (exclusionInputType === "multiple") {
      if (newExclusionDates.length === 0) {
        toast.showError("ë‚ ì§œë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      datesToAdd = [...newExclusionDates];
    }

    // ê¸°ì¡´ ì œì™¸ì¼ê³¼ ì¤‘ë³µ ì²´í¬ (ë‚ ì§œ+ìœ í˜• ì¡°í•©)
    const existingKeys = new Set(data.exclusions.map(getExclusionKey));
    const duplicates = datesToAdd.filter((date) =>
      existingKeys.has(
        getExclusionKey({
          exclusion_date: date,
          exclusion_type: newExclusionType,
        })
      )
    );

    if (duplicates.length > 0) {
      toast.showError(
        `ì´ë¯¸ ë“±ë¡ëœ ì œì™¸ì¼ì´ ìˆìŠµë‹ˆë‹¤: ${duplicates.join(", ")}`
      );
      return;
    }

    // ìƒˆ ì œì™¸ì¼ ì¶”ê°€
    const newExclusions = datesToAdd.map((date) => ({
      exclusion_date: date,
      exclusion_type: newExclusionType,
      reason: newExclusionReason || undefined,
      source: isTemplateMode ? ("template" as const) : ("student" as const),
      is_locked: isTemplateMode ? true : undefined,
    }));

    onUpdate({
      exclusions: [...data.exclusions, ...newExclusions],
    });

    // í¼ ì´ˆê¸°í™”
    setNewExclusionDate("");
    setNewExclusionStartDate("");
    setNewExclusionEndDate("");
    setNewExclusionDates([]);
    setNewExclusionReason("");
  };

  const removeExclusion = (index: number) => {
    if (!editable) return;
    const exclusion = data.exclusions[index];
    const isTemplateExclusion =
      exclusion.is_locked || exclusion.source === "template";

    if (campMode && isTemplateExclusion) {
      toast.showError("í…œí”Œë¦¿ì—ì„œ ì§€ì •ëœ ì œì™¸ì¼ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    onUpdate({
      exclusions: data.exclusions.filter((_, i) => i !== index),
    });
  };

  const syncFromTimeManagement = async () => {
    try {
      // í…œí”Œë¦¿ ëª¨ë“œì¼ ë•ŒëŠ” studentId ì—†ì´ í˜¸ì¶œ (ë¹ˆ ê²°ê³¼ ë°˜í™˜)
      const result = await syncTimeManagementExclusionsAction(
        groupId || null,
        periodStart,
        periodEnd,
        undefined // studentIdëŠ” í…œí”Œë¦¿ ëª¨ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      );

      if (result.exclusions && result.exclusions.length > 0) {
        // ëª¨ë‹¬ë¡œ ì„ íƒ ë“±ë¡ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
        setAvailableExclusions(result.exclusions);
        setIsImportModalOpen(true);
      } else {
        toast.showInfo("í”Œëœ ê¸°ê°„ ë‚´ ë“±ë¡ëœ ì œì™¸ì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      toast.showError(
        error instanceof Error
          ? error.message
          : "ì œì™¸ì¼ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    }
  };

  const handleImportExclusions = (
    selectedExclusions: Array<{
      exclusion_date: string;
      exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
      reason?: string;
      source?: "template" | "student" | "time_management";
      is_locked?: boolean;
    }>
  ) => {
    const newExclusions = selectedExclusions.map((e) => ({
      ...e,
      source: "time_management" as const,
    }));

    onUpdate({
      exclusions: [...data.exclusions, ...newExclusions],
    });

    toast.showSuccess(`${newExclusions.length}ê°œì˜ ì œì™¸ì¼ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.`);

    // ë“±ë¡ í›„ ê°œìˆ˜ ë‹¤ì‹œ ì¡°íšŒ
    loadAvailableCount();
  };

  return (
    <>
      {/* ì œì™¸ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ */}
      <ExclusionImportModal
        isOpen={isImportModalOpen}
        onClose={() => setIsImportModalOpen(false)}
        availableExclusions={availableExclusions}
        existingExclusions={data.exclusions}
        onImport={handleImportExclusions}
        periodStart={periodStart}
        periodEnd={periodEnd}
      />

      {/* í—¤ë” */}
      <div className="flex items-center justify-end gap-2">
        <button
          type="button"
          onClick={syncFromTimeManagement}
          disabled={!editable}
          className="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-800 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <RefreshCw
            className={`h-3 w-3 ${isLoadingCount ? "animate-spin" : ""}`}
          />
          ì‹œê°„ ê´€ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
        {availableCount !== null && availableCount > 0 && (
          <span className="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
            {availableCount}ê°œ
          </span>
        )}
      </div>

      {/* ì œì™¸ì¼ ì¶”ê°€ í¼ */}
      {editable && (!campMode || canStudentInputExclusions) && (
        <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
          {/* ì…ë ¥ ìœ í˜• ì„ íƒ */}
          <div className="flex gap-2">
            <button
              type="button"
              onClick={() => {
                if (!editable) return;
                setExclusionInputType("single");
              }}
              disabled={!editable}
              className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${
                exclusionInputType === "single"
                  ? "bg-gray-900 text-white"
                  : "bg-white text-gray-800 hover:bg-gray-100"
              } ${!editable ? "cursor-not-allowed opacity-60" : ""}`}
            >
              ë‹¨ì¼ ë‚ ì§œ
            </button>
            <button
              type="button"
              onClick={() => {
                if (!editable) return;
                setExclusionInputType("range");
              }}
              disabled={!editable}
              className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${
                exclusionInputType === "range"
                  ? "bg-gray-900 text-white"
                  : "bg-white text-gray-800 hover:bg-gray-100"
              } ${!editable ? "cursor-not-allowed opacity-60" : ""}`}
            >
              ì‹œì‘ì¼ ~ ì¢…ë£Œì¼
            </button>
            <button
              type="button"
              onClick={() => {
                if (!editable) return;
                setExclusionInputType("multiple");
              }}
              disabled={!editable}
              className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${
                exclusionInputType === "multiple"
                  ? "bg-gray-900 text-white"
                  : "bg-white text-gray-800 hover:bg-gray-100"
              } ${!editable ? "cursor-not-allowed opacity-60" : ""}`}
            >
              ë¹„ì—°ì† ë‹¤ì¤‘ ì„ íƒ
            </button>
          </div>

          {/* ë‚ ì§œ ì…ë ¥ */}
          {exclusionInputType === "single" && (
            <DateInput
              id="exclusion-single-date-input"
              label="ë‚ ì§œ"
              labelClassName="text-xs"
              value={newExclusionDate}
              onChange={(value) => {
                if (!editable) return;
                setNewExclusionDate(value);
              }}
              disabled={!editable}
              min={periodStart}
              max={periodEnd}
            />
          )}

          {exclusionInputType === "range" && (
            <div className="grid grid-cols-2 gap-3">
              <DateInput
                id="exclusion-range-start-date-input"
                label="ì‹œì‘ì¼"
                labelClassName="text-xs"
                value={newExclusionStartDate}
                onChange={(value) => {
                  if (!editable) return;
                  setNewExclusionStartDate(value);
                }}
                disabled={!editable}
                min={periodStart}
                max={periodEnd}
              />
              <DateInput
                id="exclusion-range-end-date-input"
                label="ì¢…ë£Œì¼"
                labelClassName="text-xs"
                value={newExclusionEndDate}
                onChange={(value) => {
                  if (!editable) return;
                  setNewExclusionEndDate(value);
                }}
                disabled={!editable}
                min={periodStart}
                max={periodEnd}
              />
            </div>
          )}

          {exclusionInputType === "multiple" && (
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-800">
                ë‚ ì§œ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)
              </label>
              <div className="max-h-48 flex flex-col gap-1 overflow-y-auto rounded-lg border border-gray-300 bg-white p-2">
                {(() => {
                  const dates: string[] = [];
                  // YYYY-MM-DD í˜•ì‹ ë¬¸ìì—´ì„ ì§ì ‘ íŒŒì‹±í•˜ì—¬ íƒ€ì„ì¡´ ë¬¸ì œ ë°©ì§€
                  const startParts = parseDateString(periodStart);
                  const endParts = parseDateString(periodEnd);
                  const start = new Date(
                    startParts.year,
                    startParts.month - 1,
                    startParts.day
                  );
                  const end = new Date(
                    endParts.year,
                    endParts.month - 1,
                    endParts.day
                  );
                  const current = new Date(start);

                  while (current <= end) {
                    dates.push(formatDateFromDate(current));
                    current.setDate(current.getDate() + 1);
                  }

                  return dates.map((date) => {
                    const isSelected = newExclusionDates.includes(date);
                    const isExcluded = data.exclusions.some(
                      (e) => e.exclusion_date === date
                    );
                    return (
                      <button
                        key={date}
                        type="button"
                        onClick={() => !isExcluded && toggleExclusionDate(date)}
                        disabled={!editable || isExcluded}
                        className={`w-full rounded px-2 py-1 text-left text-xs transition-colors ${
                          !editable || isExcluded
                            ? "cursor-not-allowed bg-gray-100 text-gray-600 line-through"
                          : isSelected
                          ? "bg-gray-900 text-white"
                          : "hover:bg-gray-100 text-gray-800"
                        }`}
                      >
                        {date} {isExcluded && "(ì´ë¯¸ ì œì™¸ë¨)"}
                      </button>
                    );
                  });
                })()}
              </div>
              {newExclusionDates.length > 0 && (
                <p className="text-xs text-gray-600">
                  {newExclusionDates.length}ê°œ ë‚ ì§œ ì„ íƒë¨
                </p>
              )}
            </div>
          )}

          {/* ìœ í˜• ë° ì‚¬ìœ  */}
          <div className="grid gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-1">
              <div className="flex items-center gap-1">
                <label className="block text-xs font-medium text-gray-800">
                  ìœ í˜•
                </label>
                {data.scheduler_type === "1730_timetable" && (
                  <div className="group relative">
                    <Info className="h-3.5 w-3.5 text-gray-600 hover:text-gray-800" />
                    <div className="absolute bottom-full left-1/2 z-10 hidden w-64 -translate-x-1/2 rounded-lg border border-gray-200 bg-white p-2 text-xs text-gray-600 shadow-lg group-hover:block">
                      <div className="flex flex-col gap-1">
                        <div className="font-semibold">ìœ í˜•ë³„ ì•ˆë‚´</div>
                        <div className="border-t border-gray-100 pt-1">
                          <div className="font-medium text-gray-900">
                            ì§€ì •íœ´ì¼:
                          </div>
                          <div className="text-gray-600">
                            í•™ìŠµ ë¶„ëŸ‰ì€ ë°°ì •ë˜ì§€ ì•Šì§€ë§Œ, ììœ¨ í•™ìŠµì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                          </div>
                        </div>
                        <div className="border-t border-gray-100 pt-1">
                          <div className="font-medium text-gray-900">
                            íœ´ê°€/ê°œì¸ì‚¬ì •:
                          </div>
                          <div className="text-gray-600">
                            í•™ìŠµì´ ë¶ˆê°€ëŠ¥í•œ ë‚ ì…ë‹ˆë‹¤.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              <select
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                value={newExclusionType}
                onChange={(e) => {
                  if (!editable) return;
                  setNewExclusionType(e.target.value as typeof newExclusionType);
                }}
                disabled={!editable}
              >
                {exclusionTypes.map((type) => (
                  <option key={type.value} value={type.value}>
                    {type.label}
                  </option>
                ))}
              </select>
              {newExclusionType === "íœ´ì¼ì§€ì •" &&
                data.scheduler_type === "1730_timetable" && (
                  <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
                    <div className="flex items-start gap-2">
                      <Info className="h-4 w-4 flex-shrink-0 text-blue-600" />
                      <div className="flex flex-col gap-1 text-xs text-blue-800">
                        <div className="font-semibold">ì§€ì •íœ´ì¼ ì•ˆë‚´</div>
                        <div className="text-blue-800">
                          â€¢ í•™ìŠµ ë¶„ëŸ‰ì€ ë°°ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                        </div>
                        <div className="text-blue-800">
                          â€¢ ììœ¨ í•™ìŠµì€ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ì„¤ì •ëœ ì‹œê°„ëŒ€)
                        </div>
                        <div className="text-blue-800">
                          â€¢ ì£¼ì°¨ ê³„ì‚°ì—ì„œ ì œì™¸ë˜ì–´ 7ì¼ ë‹¨ìœ„ í•™ìŠµ íŒ¨í„´ì— ì˜í–¥ì„
                          ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤
                        </div>
                      </div>
                    </div>
                  </div>
                )}
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-xs font-medium text-gray-800">
                ì‚¬ìœ  (ì„ íƒì‚¬í•­)
              </label>
              <input
                type="text"
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                placeholder="ì˜ˆ: ê°€ì¡± ì—¬í–‰"
                value={newExclusionReason}
                onChange={(e) => {
                  if (!editable) return;
                  setNewExclusionReason(e.target.value);
                }}
                disabled={!editable}
              />
            </div>
          </div>

          <button
            type="button"
            onClick={addExclusion}
            disabled={
              !editable ||
              (exclusionInputType === "single" && !newExclusionDate) ||
              (exclusionInputType === "range" &&
                (!newExclusionStartDate || !newExclusionEndDate)) ||
              (exclusionInputType === "multiple" &&
                newExclusionDates.length === 0)
            }
            className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
          >
            ì œì™¸ì¼ ì¶”ê°€
          </button>
        </div>
      )}

      {/* ì œì™¸ì¼ ëª©ë¡ */}
      {data.exclusions.length > 0 ? (
        <div className="space-y-2">
          {data.exclusions.map((exclusion, index) => (
            <div
              key={index}
              className={`rounded-lg border px-4 py-3 ${
                exclusion.exclusion_type === "íœ´ì¼ì§€ì •" &&
                data.scheduler_type === "1730_timetable"
                  ? "border-yellow-200 bg-yellow-50"
                  : "border-gray-200 bg-white"
              }`}
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <div className="text-sm font-medium text-gray-900">
                      {exclusion.exclusion_date}
                    </div>
                    {exclusion.exclusion_type === "íœ´ì¼ì§€ì •" &&
                      data.scheduler_type === "1730_timetable" && (
                        <span className="rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">
                          ììœ¨ í•™ìŠµ ê°€ëŠ¥
                        </span>
                      )}
                  </div>
                  <div className="flex items-center gap-2 text-xs text-gray-600">
                    <span>{exclusion.exclusion_type}</span>
                    {exclusion.reason && <span>Â· {exclusion.reason}</span>}
                    {exclusion.source === "template" && (
                      <span className="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                        <Lock className="h-3 w-3" />
                        í…œí”Œë¦¿
                      </span>
                    )}
                    {exclusion.source === "time_management" && (
                      <span className="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-800">
                        <Clock className="h-3 w-3" />
                        ì‹œê°„ ê´€ë¦¬
                      </span>
                    )}
                    {exclusion.source === "student" && (
                      <span className="inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
                        <User className="h-3 w-3" />
                        ì§ì ‘ ì…ë ¥
                      </span>
                    )}
                  </div>
                  {exclusion.exclusion_type === "íœ´ì¼ì§€ì •" &&
                    data.scheduler_type === "1730_timetable" && (
                      <div className="flex flex-col gap-1 rounded border border-yellow-200 bg-white p-2 text-xs text-yellow-800">
                        <div className="font-medium">ì§€ì •íœ´ì¼ ì•ˆë‚´</div>
                        <div className="text-yellow-700">
                          í•™ìŠµ ë¶„ëŸ‰ì€ ë°°ì •ë˜ì§€ ì•Šì§€ë§Œ, ììœ¨ í•™ìŠµì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                        </div>
                      </div>
                    )}
                </div>
                <button
                  type="button"
                  onClick={() => removeExclusion(index)}
                  disabled={
                    !editable ||
                    (campMode &&
                      (exclusion.is_locked || exclusion.source === "template"))
                  }
                  className={`text-sm ${
                    !editable ||
                    (campMode &&
                      (exclusion.is_locked || exclusion.source === "template"))
                      ? "cursor-not-allowed text-gray-600"
                      : "text-red-600 hover:text-red-800"
                  }`}
                  title={
                    campMode &&
                    (exclusion.is_locked || exclusion.source === "template")
                      ? "í…œí”Œë¦¿ì—ì„œ ì§€ì •ëœ ì œì™¸ì¼ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                      : "ì‚­ì œ"
                  }
                >
                  ì‚­ì œ
                </button>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <p className="text-sm text-gray-600">ë“±ë¡ëœ ì œì™¸ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      )}
    </>
  );
});
</file>

<file path="new-group/_components/_panels/NonStudyTimeBlocksPanel.tsx">
"use client";

import React, { useState } from "react";
import { Info } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { useToast } from "@/components/ui/ToastProvider";

type NonStudyTimeBlocksPanelProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  campMode?: boolean;
  isTemplateMode?: boolean;
  editable?: boolean;
};

const weekdayLabels = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"];

/**
 * í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª© íŒ¨ë„
 * - ì•„ì¹¨ì‹ì‚¬, ì €ë…ì‹ì‚¬, ìˆ˜ë©´ ë“± í•™ìŠµì—ì„œ ì œì™¸í•  ì‹œê°„ëŒ€ ê´€ë¦¬
 */
export const NonStudyTimeBlocksPanel = React.memo(function NonStudyTimeBlocksPanel({
  data,
  onUpdate,
  campMode = false,
  isTemplateMode = false,
  editable = true,
}: NonStudyTimeBlocksPanelProps) {
  const toast = useToast();
  
  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ í™•ì¸
  const lockedFields = data.templateLockedFields?.step2 || {};
  
  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•„ë“œ ì œì–´ í† ê¸€
  const toggleFieldControl = (fieldName: keyof typeof lockedFields) => {
    if (!isTemplateMode) return;
    
    const currentLocked = data.templateLockedFields?.step2 || {};
    const newLocked = {
      ...currentLocked,
      [fieldName]: !currentLocked[fieldName],
    };
    
    onUpdate({
      templateLockedFields: {
        ...data.templateLockedFields,
        step2: newLocked,
      },
    });
  };
  
  // í•™ìƒ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€
  const canStudentInputNonStudyTimeBlocks = campMode
    ? (lockedFields.allow_student_non_study_time_blocks !== false)
    : true;

  // ë¡œì»¬ ìƒíƒœ
  const [newNonStudyTimeBlock, setNewNonStudyTimeBlock] = useState<{
    type: "ì•„ì¹¨ì‹ì‚¬" | "ì €ë…ì‹ì‚¬" | "ìˆ˜ë©´" | "ê¸°íƒ€";
    start_time: string;
    end_time: string;
    day_of_week?: number[];
    description?: string;
  }>({
    type: "ì•„ì¹¨ì‹ì‚¬",
    start_time: "07:00",
    end_time: "08:00",
  });

  const addNonStudyTimeBlock = () => {
    if (!editable) return;
    if (!newNonStudyTimeBlock.start_time || !newNonStudyTimeBlock.end_time) {
      toast.showError("ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (newNonStudyTimeBlock.start_time >= newNonStudyTimeBlock.end_time) {
      toast.showError("ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ì•ì„œì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    const updated = [...(data.non_study_time_blocks || []), { ...newNonStudyTimeBlock }];
    onUpdate({ non_study_time_blocks: updated });
    
    // í¼ ì´ˆê¸°í™”
    setNewNonStudyTimeBlock({
      type: "ì•„ì¹¨ì‹ì‚¬",
      start_time: "07:00",
      end_time: "08:00",
    });
  };

  const removeNonStudyTimeBlock = (index: number) => {
    if (!editable) return;
    const updated = [...(data.non_study_time_blocks || [])];
    updated.splice(index, 1);
    onUpdate({ non_study_time_blocks: updated.length > 0 ? updated : undefined });
  };

  const toggleWeekday = (day: number) => {
    if (!editable) return;
    const currentDays = newNonStudyTimeBlock.day_of_week || [];
    const updatedDays = currentDays.includes(day)
      ? currentDays.filter((d) => d !== day)
      : [...currentDays, day];
    setNewNonStudyTimeBlock({
      ...newNonStudyTimeBlock,
      day_of_week: updatedDays.length > 0 ? updatedDays : undefined,
    });
  };

  return (
    <>
      {/* í—¤ë” */}
      <div className="flex items-center gap-2">
        <h3 className="text-sm font-semibold text-gray-900">í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª©</h3>
        <Info className="h-4 w-4 text-gray-600" />
      </div>

      <div className="flex flex-col gap-4">
          <p className="text-xs text-gray-600">
            í•™ìŠµ ì‹œê°„ ë‚´ì—ì„œ í”Œëœ ë°°ì •ì„ ì œì™¸í•  ì‹œê°„ëŒ€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ì‹ì‚¬ ì‹œê°„, ìˆ˜ë©´ ì‹œê°„ ë“±)
          </p>

          {/* ê¸°ì¡´ ì œì™¸ í•­ëª© ëª©ë¡ */}
          {data.non_study_time_blocks && data.non_study_time_blocks.length > 0 && (
            <div className="flex flex-col gap-2">
              {data.non_study_time_blocks.map((block, index) => (
                <div
                  key={index}
                  className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
                >
                  <div className="flex-1">
                    <div className="text-sm font-medium text-gray-900">{block.type}</div>
                    <div className="flex items-center gap-2 text-xs text-gray-600">
                      <span>{block.start_time} ~ {block.end_time}</span>
                      {block.day_of_week && block.day_of_week.length > 0 && (
                        <span>
                          ({block.day_of_week.map((d) => weekdayLabels[d]).join(", ")})
                        </span>
                      )}
                    </div>
                    {block.description && (
                      <div className="text-xs text-gray-600">{block.description}</div>
                    )}
                  </div>
                  <button
                    type="button"
                    onClick={() => removeNonStudyTimeBlock(index)}
                    disabled={!editable}
                    className={`text-xs ${
                      !editable
                        ? "cursor-not-allowed text-gray-600"
                        : "text-red-600 hover:text-red-800"
                    }`}
                  >
                    ì‚­ì œ
                  </button>
                </div>
              ))}
            </div>
          )}

          {/* ìƒˆ ì œì™¸ í•­ëª© ì¶”ê°€ í¼ */}
          {(!campMode || canStudentInputNonStudyTimeBlocks) && (
            <div className="flex flex-col gap-3 rounded-xl border border-gray-200 bg-gray-50 p-6">
              <h4 className="text-sm font-semibold text-gray-900">ìƒˆ ì œì™¸ í•­ëª© ì¶”ê°€</h4>
              
              <div className="flex flex-col gap-1">
                <label className="block text-xs font-medium text-gray-800">ì œì™¸ í•­ëª© ìœ í˜•</label>
                <select
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                  value={newNonStudyTimeBlock.type}
                  onChange={(e) => {
                    if (!editable) return;
                    setNewNonStudyTimeBlock({
                      ...newNonStudyTimeBlock,
                      type: e.target.value as any,
                    });
                  }}
                  disabled={!editable}
                >
                  <option value="ì•„ì¹¨ì‹ì‚¬">ì•„ì¹¨ì‹ì‚¬</option>
                  <option value="ì €ë…ì‹ì‚¬">ì €ë…ì‹ì‚¬</option>
                  <option value="ìˆ˜ë©´">ìˆ˜ë©´</option>
                  <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div className="flex flex-col gap-1">
                  <label className="block text-xs font-medium text-gray-800">ì‹œì‘ ì‹œê°„</label>
                  <input
                    type="time"
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                    value={newNonStudyTimeBlock.start_time}
                    onChange={(e) => {
                      if (!editable) return;
                      setNewNonStudyTimeBlock({
                        ...newNonStudyTimeBlock,
                        start_time: e.target.value,
                      });
                    }}
                    disabled={!editable}
                  />
                </div>
                <div className="flex flex-col gap-1">
                  <label className="block text-xs font-medium text-gray-800">ì¢…ë£Œ ì‹œê°„</label>
                  <input
                    type="time"
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                    value={newNonStudyTimeBlock.end_time}
                    onChange={(e) => {
                      if (!editable) return;
                      setNewNonStudyTimeBlock({
                        ...newNonStudyTimeBlock,
                        end_time: e.target.value,
                      });
                    }}
                    disabled={!editable}
                  />
                </div>
              </div>

              <div className="flex flex-col gap-1">
                <label className="block text-xs font-medium text-gray-800">ì ìš© ìš”ì¼ (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ ë§¤ì¼)</label>
                <div className="flex flex-wrap gap-2">
                  {weekdayLabels.map((label, day) => (
                    <button
                      key={day}
                      type="button"
                      onClick={() => toggleWeekday(day)}
                      className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors ${
                        (newNonStudyTimeBlock.day_of_week || []).includes(day)
                          ? "bg-gray-900 text-white"
                          : "bg-gray-100 text-gray-800 hover:bg-gray-200"
                      }`}
                    >
                      {label}
                    </button>
                  ))}
                </div>
              </div>

              <div className="flex flex-col gap-1">
                <label className="block text-xs font-medium text-gray-800">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                <input
                  type="text"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                  placeholder="ì˜ˆ: ì ì‹¬ ì‹ì‚¬ ì‹œê°„"
                  value={newNonStudyTimeBlock.description || ""}
                  onChange={(e) => {
                    if (!editable) return;
                    setNewNonStudyTimeBlock({
                      ...newNonStudyTimeBlock,
                      description: e.target.value || undefined,
                    });
                  }}
                  disabled={!editable}
                />
              </div>

              <button
                type="button"
                onClick={addNonStudyTimeBlock}
                disabled={!editable}
                className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
              >
                ì œì™¸ í•­ëª© ì¶”ê°€
              </button>
            </div>
          )}
      </div>
    </>
  );
});
</file>

<file path="new-group/_components/_panels/SchedulePreviewPanel.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback, useRef } from "react";
import {
  Calendar,
  Clock,
  AlertCircle,
  Loader2,
  ChevronDown,
  ChevronUp,
  XCircle,
  BookOpen,
  RotateCcw,
} from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { calculateScheduleAvailability } from "@/app/(student)/actions/calculateScheduleAvailability";
import {
  scheduleCache,
  type ScheduleCalculationParams,
} from "@/lib/utils/scheduleCache";
import type { Exclusion } from "@/lib/scheduler/calculateAvailableDates";
import type {
  ScheduleAvailabilityResult,
  DailySchedule,
} from "@/lib/scheduler/calculateAvailableDates";
import { getDefaultBlocks } from "@/lib/utils/defaultBlockSet";
import { formatNumber } from "@/lib/utils/formatNumber";
import { TimelineBar } from "../Step7ScheduleResult/TimelineBar";

type SchedulePreviewPanelProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  blockSets?: Array<{
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  }>;
  isTemplateMode?: boolean;
  isCampMode?: boolean;
  campTemplateId?: string;
};

const dayTypeLabels: Record<string, string> = {
  í•™ìŠµì¼: "í•™ìŠµì¼",
  ë³µìŠµì¼: "ë³µìŠµì¼",
  ì§€ì •íœ´ì¼: "ì§€ì •íœ´ì¼",
  íœ´ê°€: "íœ´ê°€",
  ê°œì¸ì¼ì •: "ê°œì¸ì¼ì •",
};

const dayTypeColors: Record<string, string> = {
  í•™ìŠµì¼: "bg-blue-100 text-blue-800 border-blue-200",
  ë³µìŠµì¼: "bg-green-100 text-green-800 border-green-200",
  ì§€ì •íœ´ì¼: "bg-yellow-100 text-yellow-800 border-yellow-200",
  íœ´ê°€: "bg-gray-100 text-gray-800 border-gray-200",
  ê°œì¸ì¼ì •: "bg-purple-100 text-purple-800 border-purple-200",
};

/**
 * ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ (ì‹¤ì‹œê°„ ë²„ì „)
 * - ì‹¤ì‹œê°„ ìŠ¤ì¼€ì¤„ ê³„ì‚°
 * - ìš”ì•½ í†µê³„
 * - ì£¼ì°¨ë³„ ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°
 * - ì¼ë³„ ìƒì„¸ ì •ë³´
 */
export const SchedulePreviewPanel = React.memo(function SchedulePreviewPanel({
  data,
  onUpdate,
  blockSets = [],
  isTemplateMode = false,
  isCampMode = false,
  campTemplateId,
}: SchedulePreviewPanelProps) {
  const [loading, setLoading] = useState(true);
  const [result, setResult] = useState<ScheduleAvailabilityResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [expandedWeeks, setExpandedWeeks] = useState<Set<number>>(new Set([0]));
  const [visibleWeeks, setVisibleWeeks] = useState<Set<number>>(new Set([0]));

  // onUpdateë¥¼ useRefë¡œ ì•ˆì •í™”í•˜ì—¬ í•¨ìˆ˜ ì¬ìƒì„± ë°©ì§€
  const onUpdateRef = useRef(onUpdate);
  useEffect(() => {
    onUpdateRef.current = onUpdate;
  }, [onUpdate]);

  // ì„ íƒëœ ë¸”ë¡ ì„¸íŠ¸ì˜ ë¸”ë¡ ë°ì´í„° ì¶”ì¶œ
  const selectedBlockSetBlocks = useMemo(() => {
    if (isTemplateMode && !data.block_set_id) {
      const defaultBlocks = getDefaultBlocks();
      return defaultBlocks.map((b) => ({
        day_of_week: b.day_of_week,
        start_time: b.start_time,
        end_time: b.end_time,
      }));
    }

    if (!data.block_set_id || !blockSets.length) {
      return undefined;
    }

    const selectedSet = blockSets.find((set) => set.id === data.block_set_id);
    if (!selectedSet || !selectedSet.blocks) {
      return undefined;
    }

    return selectedSet.blocks.map((b) => ({
      day_of_week: b.day_of_week,
      start_time: b.start_time,
      end_time: b.end_time,
    }));
  }, [data.block_set_id, blockSets, isTemplateMode]);

  // ìŠ¤ì¼€ì¤„ ê³„ì‚° íŒŒë¼ë¯¸í„° ë©”ëª¨ì´ì œì´ì…˜
  const scheduleParams = useMemo<ScheduleCalculationParams | null>(() => {
    if (
      !data.period_start ||
      !data.period_end ||
      !data.scheduler_type ||
      (!isTemplateMode && !data.block_set_id)
    ) {
      return null;
    }

    if (isCampMode && !campTemplateId) {
      return null;
    }

    // ì¶”ê°€ ê¸°ê°„ì´ ìˆìœ¼ë©´ ì¢…ë£Œì¼ì„ ì¶”ê°€ ê¸°ê°„ ì¢…ë£Œì¼ë¡œ í™•ì¥
    const effectiveEndDate =
      data.additional_period_reallocation?.period_end || data.period_end;

    return {
      periodStart: data.period_start,
      periodEnd: effectiveEndDate,
      schedulerType: data.scheduler_type as "1730_timetable",
      blockSetId: data.block_set_id || "default",
      exclusions: (data.exclusions || []).map((e) => ({
        exclusion_date: e.exclusion_date,
        exclusion_type: e.exclusion_type as Exclusion["exclusion_type"],
        reason: e.reason,
      })) as Exclusion[],
      academySchedules: data.academy_schedules || [],
      schedulerOptions: data.scheduler_options,
      timeSettings: data.time_settings,
    };
  }, [
    data.period_start,
    data.period_end,
    data.scheduler_type,
    data.block_set_id,
    data.exclusions,
    data.academy_schedules,
    data.time_settings,
    data.scheduler_options,
    data.additional_period_reallocation,
    isTemplateMode,
    isCampMode,
    campTemplateId,
  ]);

  // ìŠ¤ì¼€ì¤„ ê³„ì‚° (debounced)
  const calculateSchedule = useCallback(
    async (params: ScheduleCalculationParams) => {
      setLoading(true);
      setError(null);

      try {
        // ìºì‹œ í™•ì¸
        const cached = scheduleCache.get(params);
        if (cached) {
          setResult(cached);
          // ê°’ ë¹„êµ í›„ ì—…ë°ì´íŠ¸
          const hasChanged =
            JSON.stringify(cached.summary) !== JSON.stringify(data.schedule_summary) ||
            JSON.stringify(cached.daily_schedule) !== JSON.stringify(data.daily_schedule);
          
          if (hasChanged) {
            onUpdateRef.current({
              schedule_summary: cached.summary,
              daily_schedule: cached.daily_schedule,
            });
          }
          setLoading(false);
          return;
        }

        // ì„œë²„ ê³„ì‚° - calculateScheduleAvailabilityì— í•„ìš”í•œ ì¶”ê°€ í•„ë“œ í¬í•¨
        const calculatedResult = await calculateScheduleAvailability({
          ...params,
          exclusions: params.exclusions as Exclusion[],
          blocks: selectedBlockSetBlocks,
          isTemplateMode,
          isCampMode,
          campTemplateId: isCampMode ? campTemplateId : undefined,
        });

        // ê³„ì‚° ê²°ê³¼ ê²€ì¦
        if (!calculatedResult.success || !calculatedResult.data) {
          throw new Error(
            calculatedResult.error || "ìŠ¤ì¼€ì¤„ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }

        let result = calculatedResult.data;

        // ì¶”ê°€ ê¸°ê°„ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œë“¤ì„ ë³µìŠµì¼ë¡œ ë³€ê²½
        if (data.additional_period_reallocation) {
          const additionalStart =
            data.additional_period_reallocation.period_start;
          const additionalEnd = data.additional_period_reallocation.period_end;

          // daily_scheduleì—ì„œ ì¶”ê°€ ê¸°ê°„ ë‚ ì§œë“¤ì˜ day_typeì„ ë³µìŠµì¼ë¡œ ë³€ê²½
          const updatedDailySchedule = result.daily_schedule.map((day) => {
            if (
              day.date >= additionalStart &&
              day.date <= additionalEnd &&
              day.day_type !== "íœ´ê°€" &&
              day.day_type !== "ê°œì¸ì¼ì •" &&
              day.day_type !== "ì§€ì •íœ´ì¼"
            ) {
              return {
                ...day,
                day_type: "ë³µìŠµì¼" as const,
              };
            }
            return day;
          });

          // í†µê³„ ì¬ê³„ì‚°
          let totalStudyDays = 0;
          let totalReviewDays = 0;
          let totalStudyHours_í•™ìŠµì¼ = 0;
          let totalStudyHours_ë³µìŠµì¼ = 0;

          for (const day of updatedDailySchedule) {
            // í•™ìŠµ ì‹œê°„ ê³„ì‚°: timeSlotsì—ì„œ "í•™ìŠµì‹œê°„" íƒ€ì…ë§Œ ê³„ì‚°
            const studyHoursOnly = (day.time_slots || [])
              .filter((slot) => slot.type === "í•™ìŠµì‹œê°„")
              .reduce((sum, slot) => {
                const [startHour, startMin] = slot.start.split(":").map(Number);
                const [endHour, endMin] = slot.end.split(":").map(Number);
                const startMinutes = startHour * 60 + startMin;
                const endMinutes = endHour * 60 + endMin;
                return sum + (endMinutes - startMinutes) / 60;
              }, 0);

            if (day.day_type === "í•™ìŠµì¼") {
              totalStudyDays++;
              totalStudyHours_í•™ìŠµì¼ += studyHoursOnly;
            } else if (day.day_type === "ë³µìŠµì¼") {
              totalReviewDays++;
              totalStudyHours_ë³µìŠµì¼ += studyHoursOnly;
            }
          }

          // summary ì—…ë°ì´íŠ¸
          result = {
            ...result,
            daily_schedule: updatedDailySchedule,
            summary: {
              ...result.summary,
              total_study_days: totalStudyDays,
              total_review_days: totalReviewDays,
              total_study_hours_í•™ìŠµì¼: totalStudyHours_í•™ìŠµì¼,
              total_study_hours_ë³µìŠµì¼: totalStudyHours_ë³µìŠµì¼,
            },
          };
        }

        // ìºì‹œ ì €ì¥
        scheduleCache.set(params, result);

        setResult(result);
        // ê°’ ë¹„êµ í›„ ì—…ë°ì´íŠ¸
        const hasChanged =
          JSON.stringify(result.summary) !== JSON.stringify(data.schedule_summary) ||
          JSON.stringify(result.daily_schedule) !== JSON.stringify(data.daily_schedule);
        
        if (hasChanged) {
          onUpdateRef.current({
            schedule_summary: result.summary,
            daily_schedule: result.daily_schedule,
          });
        }
      } catch (err) {
        console.error("[SchedulePreviewPanel] ìŠ¤ì¼€ì¤„ ê³„ì‚° ì‹¤íŒ¨:", err);
        setError(
          err instanceof Error ? err.message : "ìŠ¤ì¼€ì¤„ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
        setResult(null);
      } finally {
        setLoading(false);
      }
    },
    [
      // onUpdate ì œê±° (onUpdateRef ì‚¬ìš©)
      selectedBlockSetBlocks,
      isTemplateMode,
      isCampMode,
      campTemplateId,
      data.schedule_summary, // ë¹„êµë¥¼ ìœ„í•´ ì¶”ê°€
      data.daily_schedule, // ë¹„êµë¥¼ ìœ„í•´ ì¶”ê°€
    ]
  );

  // íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ ì¬ê³„ì‚° (debounce 1000ms)
  useEffect(() => {
    if (!scheduleParams) {
      setLoading(false);
      setResult(null);
      setError(null);
      return;
    }

    const timer = setTimeout(() => {
      calculateSchedule(scheduleParams);
    }, 1000); // 500ms â†’ 1000msë¡œ ì¦ê°€

    return () => clearTimeout(timer);
  }, [scheduleParams, calculateSchedule]);

  // ì£¼ì°¨ë³„ ê·¸ë£¹í™” ë° í†µê³„ ê³„ì‚° (ë©”ëª¨ì´ì œì´ì…˜)
  const weeklySchedules = useMemo(() => {
    if (!result?.daily_schedule) return [];

    const weeks: DailySchedule[][] = [];
    let currentWeek: DailySchedule[] = [];

    result.daily_schedule.forEach((day, index) => {
      currentWeek.push(day);

      // 7ì¼ë§ˆë‹¤ ë˜ëŠ” ë§ˆì§€ë§‰ ë‚ ì— ì£¼ì°¨ ì™„ì„±
      if (
        currentWeek.length === 7 ||
        index === result.daily_schedule.length - 1
      ) {
        weeks.push([...currentWeek]);
        currentWeek = [];
      }
    });

    return weeks;
  }, [result?.daily_schedule]);

  // ì‹œê°„ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ (ë©”ëª¨ì´ì œì´ì…˜)
  const calculateTimeFromSlots = useCallback((
    timeSlots: Array<{ type: string; start: string; end: string }> | undefined,
    type: "í•™ìŠµì‹œê°„" | "ììœ¨í•™ìŠµ" | "ì´ë™ì‹œê°„" | "í•™ì›ì¼ì •"
  ): number => {
    if (!timeSlots) return 0;
    const minutes = timeSlots
      .filter((slot) => slot.type === type)
      .reduce((sum, slot) => {
        const [startHour, startMin] = slot.start.split(":").map(Number);
        const [endHour, endMin] = slot.end.split(":").map(Number);
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;
        return sum + (endMinutes - startMinutes);
      }, 0);
    return minutes / 60;
  }, []);

  const toggleWeek = useCallback((weekIndex: number) => {
    setExpandedWeeks((prev) => {
      const next = new Set(prev);
      if (next.has(weekIndex)) {
        next.delete(weekIndex);
      } else {
        next.add(weekIndex);
      }
      return next;
    });
    // í™•ì¥ ì‹œ visibleWeeksì—ë„ ì¶”ê°€
    setVisibleWeeks((prev) => {
      const next = new Set(prev);
      next.add(weekIndex);
      return next;
    });
  }, []);

  // Intersection Observerë¥¼ ì‚¬ìš©í•œ ì§€ì—° ë¡œë”©
  const weekRefs = useRef<Map<number, HTMLDivElement>>(new Map());

  useEffect(() => {
    if (!result || weeklySchedules.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const weekIndex = parseInt(
              entry.target.getAttribute("data-week-index") || "0"
            );
            setVisibleWeeks((prev) => {
              const next = new Set(prev);
              next.add(weekIndex);
              return next;
            });
          }
        });
      },
      { rootMargin: "200px" } // 200px ì „ì— ë¯¸ë¦¬ ë¡œë“œ
    );

    // ëª¨ë“  ì£¼ì°¨ ì„¹ì…˜ ê´€ì°°
    weekRefs.current.forEach((element) => {
      if (element) {
        observer.observe(element);
      }
    });

    return () => {
      observer.disconnect();
    };
  }, [result, weeklySchedules.length]);

  if (loading) {
    return (
      <div className="rounded-xl border border-gray-200 bg-white p-6">
        <div className="flex items-center justify-center gap-3 py-12">
          <Loader2 className="h-8 w-8 animate-spin text-gray-600" />
          <span className="text-sm text-gray-600">ìŠ¤ì¼€ì¤„ ê³„ì‚° ì¤‘...</span>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="rounded-xl border border-red-200 bg-red-50 p-6">
        <div className="flex items-start gap-3">
          <AlertCircle className="h-5 w-5 flex-shrink-0 text-red-600" />
          <div className="flex flex-col gap-1">
            <h3 className="font-semibold text-red-900">ìŠ¤ì¼€ì¤„ ê³„ì‚° ì˜¤ë¥˜</h3>
            <p className="text-sm text-red-700">{error}</p>
          </div>
        </div>
      </div>
    );
  }

  if (!result) {
    return (
      <div className="rounded-xl border border-gray-200 bg-gray-50 p-6">
        <div className="flex flex-col gap-1 text-center py-8">
          <Calendar className="mx-auto h-12 w-12 text-gray-600" />
          <p className="text-sm font-medium text-gray-600">
            ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°
          </p>
          <p className="text-xs text-gray-600">
            ê¸°ë³¸ ì •ë³´ì™€ ì‹œê°„ ì„¤ì •ì„ ì™„ë£Œí•˜ë©´ ìŠ¤ì¼€ì¤„ì´ í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      {/* í—¤ë” */}
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-semibold text-gray-900">ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°</h2>
        <p className="text-sm text-gray-600">
          ì„¤ì •í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê³„ì‚°ëœ ìŠ¤ì¼€ì¤„ ì •ë³´ì…ë‹ˆë‹¤.
        </p>
      </div>

      {/* ì¶”ê°€ ê¸°ê°„ ì•ˆë‚´ */}
      {data.additional_period_reallocation && (
        <div className="rounded-lg border border-purple-200 bg-purple-50 p-4">
          <div className="flex items-start gap-3">
            <RotateCcw className="h-5 w-5 flex-shrink-0 text-purple-600" />
            <div className="flex flex-col gap-1 flex-1">
              <h3 className="text-sm font-semibold text-purple-900">
                ì¶”ê°€ ê¸°ê°„ í•™ìŠµ ë²”ìœ„ ì¬ë°°ì¹˜ í¬í•¨
              </h3>
              <p className="text-xs text-purple-700">
                <strong>í•™ìŠµ ê¸°ê°„:</strong> {data.period_start} ~{" "}
                {data.period_end}
              </p>
              <p className="text-xs text-purple-700">
                <strong>ì¶”ê°€ ê¸°ê°„:</strong>{" "}
                {data.additional_period_reallocation.period_start} ~{" "}
                {data.additional_period_reallocation.period_end} (ë³µìŠµì¼ë¡œ
                ê³„ì‚°ë¨)
              </p>
            </div>
          </div>
        </div>
      )}

      {/* ìš”ì•½ í†µê³„ */}
      <div className="grid grid-cols-2 gap-4 md:grid-cols-5">
        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex items-center gap-2">
            <Calendar className="h-5 w-5 text-gray-600" />
            <span className="text-xs font-medium text-gray-600">ì´ ê¸°ê°„</span>
          </div>
          <p className="text-2xl font-bold text-gray-900">
            {result.summary.total_days}
          </p>
          <p className="text-xs text-gray-600">ì¼</p>
        </div>

        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex items-center gap-2">
            <XCircle className="h-5 w-5 text-red-400" />
            <span className="text-xs font-medium text-gray-600">ì œì™¸ì¼</span>
          </div>
          <p className="text-2xl font-bold text-gray-900">
            {result.summary.total_exclusion_days.íœ´ê°€ +
              result.summary.total_exclusion_days.ê°œì¸ì‚¬ì • +
              result.summary.total_exclusion_days.ì§€ì •íœ´ì¼}
          </p>
          <p className="text-xs text-gray-600">ì¼</p>
        </div>

        <div className="flex flex-col gap-2 rounded-lg border border-blue-200 bg-blue-50 p-4">
          <div className="flex items-center gap-2">
            <BookOpen className="h-5 w-5 text-blue-500" />
            <span className="text-xs font-medium text-blue-800">í•™ìŠµì¼</span>
          </div>
          <p className="text-2xl font-bold text-blue-800">
            {result.summary.total_study_days}
          </p>
          <p className="text-xs text-blue-800">ì¼</p>
        </div>

        <div className="flex flex-col gap-2 rounded-lg border border-green-200 bg-green-50 p-4">
          <div className="flex items-center gap-2">
            <RotateCcw className="h-5 w-5 text-green-500" />
            <span className="text-xs font-medium text-green-700">ë³µìŠµì¼</span>
          </div>
          <p className="text-2xl font-bold text-green-900">
            {result.summary.total_review_days}
          </p>
          <p className="text-xs text-green-600">ì¼</p>
        </div>

        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex items-center gap-2">
            <Clock className="h-5 w-5 text-blue-400" />
            <span className="text-xs font-medium text-gray-600">
              ì´ í•™ìŠµ ì‹œê°„
            </span>
          </div>
          <p className="text-2xl font-bold text-gray-900">
            {formatNumber(Math.round(result.summary.total_study_hours))}
          </p>
          <p className="text-xs text-gray-600">ì‹œê°„</p>
        </div>
      </div>

      {/* ì£¼ì°¨ë³„ ìŠ¤ì¼€ì¤„ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <h3 className="text-sm font-semibold text-gray-900">
          ì£¼ì°¨ë³„ ìŠ¤ì¼€ì¤„
        </h3>
        <div className="flex flex-col gap-3">
          {weeklySchedules.map((week, weekIndex) => {
            const isExpanded = expandedWeeks.has(weekIndex);
            const isVisible = visibleWeeks.has(weekIndex);
            const weekStart = week[0].date;
            const weekEnd = week[week.length - 1].date;

            return (
              <div
                key={weekIndex}
                ref={(el) => {
                  if (el) {
                    weekRefs.current.set(weekIndex, el);
                  } else {
                    weekRefs.current.delete(weekIndex);
                  }
                }}
                data-week-index={weekIndex}
                className="border border-gray-200 rounded-lg overflow-hidden"
              >
                {/* ì£¼ì°¨ í—¤ë” */}
                <button
                  type="button"
                  onClick={() => toggleWeek(weekIndex)}
                  className="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <Calendar className="h-4 w-4 text-gray-600" />
                    <span className="text-sm font-medium text-gray-900">
                      {weekIndex + 1}ì£¼ì°¨
                    </span>
                    <span className="text-xs text-gray-600">
                      {weekStart} ~ {weekEnd}
                    </span>
                  </div>
                  {isExpanded ? (
                    <ChevronUp className="h-5 w-5 text-gray-600" />
                  ) : (
                    <ChevronDown className="h-5 w-5 text-gray-600" />
                  )}
                </button>

                {/* ì£¼ì°¨ ìƒì„¸ - ì§€ì—° ë¡œë”©: í™•ì¥ë˜ì—ˆê±°ë‚˜ í™”ë©´ì— ë³´ì´ëŠ” ê²½ìš°ë§Œ ë Œë”ë§ */}
                {isExpanded && isVisible && (
                  <div className="p-4 space-y-2">
                    {week.map((day) => {
                      // ì‹œê°„ ìŠ¬ë¡¯ì—ì„œ ê° íƒ€ì…ë³„ ì‹œê°„ ê³„ì‚° (ë©”ëª¨ì´ì œì´ì…˜ëœ í•¨ìˆ˜ ì‚¬ìš©)
                      const isDesignatedHoliday = day.day_type === "ì§€ì •íœ´ì¼";
                      const studyHours = calculateTimeFromSlots(day.time_slots, "í•™ìŠµì‹œê°„");
                      const selfStudyHours = isDesignatedHoliday
                        ? day.study_hours
                        : calculateTimeFromSlots(day.time_slots, "ììœ¨í•™ìŠµ");
                      const travelHours = calculateTimeFromSlots(day.time_slots, "ì´ë™ì‹œê°„");
                      const academyHours = calculateTimeFromSlots(day.time_slots, "í•™ì›ì¼ì •");
                      const totalHours =
                        studyHours +
                        selfStudyHours +
                        travelHours +
                        academyHours;

                      // ì¶”ê°€ ê¸°ê°„ ì—¬ë¶€ í™•ì¸
                      const isAdditionalPeriod =
                        data.additional_period_reallocation &&
                        day.date >=
                          data.additional_period_reallocation.period_start &&
                        day.date <=
                          data.additional_period_reallocation.period_end;

                      return (
                        <div
                          key={day.date}
                          className={`flex flex-col gap-2 p-3 rounded-lg border ${
                            isAdditionalPeriod
                              ? "border-purple-300 bg-purple-50"
                              : "border-gray-200 bg-white"
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <div className="text-sm font-medium text-gray-900">
                                {day.date}
                              </div>
                              <div
                                className={`rounded-full px-2 py-0.5 text-xs font-medium border ${
                                  dayTypeColors[day.day_type] ||
                                  "bg-gray-100 text-gray-800 border-gray-200"
                                }`}
                              >
                                {dayTypeLabels[day.day_type] || day.day_type}
                              </div>
                              {isAdditionalPeriod && (
                                <div className="rounded-full px-2 py-0.5 text-xs font-medium border border-purple-300 bg-purple-100 text-purple-800">
                                  ì¶”ê°€ ê¸°ê°„
                                </div>
                              )}
                            </div>
                            <div className="flex items-center gap-2 text-xs text-gray-600">
                              <Clock className="h-3 w-3" />
                              <span>
                                {day.study_hours > 0
                                  ? `${Math.round(day.study_hours)}ì‹œê°„`
                                  : "í•™ìŠµ ì—†ìŒ"}
                              </span>
                            </div>
                          </div>

                          {/* íƒ€ì„ë¼ì¸ ë°” ê·¸ë˜í”„ */}
                          {day.time_slots && day.time_slots.length > 0 && (
                            <TimelineBar
                              timeSlots={day.time_slots}
                              totalHours={totalHours}
                            />
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
});
</file>

<file path="new-group/_components/_panels/TimeConfigPanel.tsx">
"use client";

import React from "react";
import { WizardData } from "../PlanGroupWizard";
import { TimeRangeInput } from "@/components/ui/TimeRangeInput";

type TimeConfigPanelProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  campMode?: boolean;
  isTemplateMode?: boolean;
  editable?: boolean;
};

/**
 * ì‹œê°„ ì„¤ì • íŒ¨ë„
 * - ì ì‹¬ì‹œê°„ ì„¤ì •
 * - ì§€ì •íœ´ì¼ ììœ¨í•™ìŠµ ì‹œê°„
 * - í•™ìŠµì¼/ë³µìŠµì¼ ììœ¨í•™ìŠµ ì‹œê°„
 */
export const TimeConfigPanel = React.memo(function TimeConfigPanel({
  data,
  onUpdate,
  campMode = false,
  isTemplateMode = false,
  editable = true,
}: TimeConfigPanelProps) {
  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ í™•ì¸
  const lockedFields = data.templateLockedFields?.step2 || {};
  
  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•„ë“œ ì œì–´ í† ê¸€
  const toggleFieldControl = (fieldName: keyof typeof lockedFields) => {
    if (!isTemplateMode) return;
    
    const currentLocked = data.templateLockedFields?.step2 || {};
    const newLocked = {
      ...currentLocked,
      [fieldName]: !currentLocked[fieldName],
    };
    
    onUpdate({
      templateLockedFields: {
        ...data.templateLockedFields,
        step2: newLocked,
      },
    });
  };
  
  // í•™ìƒ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€
  const canStudentInputTimeSettings = campMode
    ? (lockedFields.allow_student_time_settings !== false)
    : true;

  const updateTimeSetting = (
    key: "lunch_time" | "camp_study_hours" | "camp_self_study_hours" | "designated_holiday_hours",
    range: { start: string; end: string } | undefined
  ) => {
    if (!editable) return;
    onUpdate({
      time_settings: {
        ...data.time_settings,
        [key]: range,
      },
    });
  };

  return (
    <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
          {/* ì ì‹¬ì‹œê°„ */}
          {(!campMode || canStudentInputTimeSettings) && (
            <TimeRangeInput
              label="ì ì‹¬ì‹œê°„"
              description="ëª¨ë“  í•™ìŠµì¼ì—ì„œ ì œì™¸í•  ì ì‹¬ ì‹œê°„ëŒ€"
              value={data.time_settings?.lunch_time}
              onChange={(range) => updateTimeSetting("lunch_time", range)}
              defaultStart="12:00"
              defaultEnd="13:00"
              disabled={!editable}
            />
          )}

          {/* ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì • í† ê¸€ */}
          {(!campMode || canStudentInputTimeSettings) && (
            <div className="flex flex-col gap-3">
              {/* ì§€ì •íœ´ì¼ ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì •í•˜ê¸° í† ê¸€ */}
              <div className="flex items-center gap-2 rounded-lg border border-gray-200 bg-white p-3">
                <input
                  type="checkbox"
                  id="enable_self_study_for_holidays"
                  checked={data.time_settings?.enable_self_study_for_holidays ?? false}
                  onChange={(e) => {
                    if (!editable) return;
                    const enabled = e.target.checked;
                    onUpdate({
                      time_settings: {
                        ...data.time_settings,
                        enable_self_study_for_holidays: enabled,
                        designated_holiday_hours: enabled
                          ? data.time_settings?.designated_holiday_hours || { start: "13:00", end: "19:00" }
                          : undefined,
                      },
                    });
                  }}
                  disabled={!editable}
                  className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-60"
                />
                <label
                  htmlFor="enable_self_study_for_holidays"
                  className="flex flex-col gap-1 flex-1 cursor-pointer text-sm text-gray-800"
                >
                  <div className="font-medium">ì§€ì •íœ´ì¼ ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì •í•˜ê¸°</div>
                  <div className="text-xs text-gray-600">
                    ì§€ì •íœ´ì¼ì— ììœ¨í•™ìŠµ ì‹œê°„ì„ ë°°ì •í•©ë‹ˆë‹¤.
                  </div>
                </label>
              </div>

              {/* ì§€ì •íœ´ì¼ ì‹œê°„ ì„¤ì • */}
              {data.time_settings?.enable_self_study_for_holidays && (
                <div className="pl-7">
                  <TimeRangeInput
                    label="ì§€ì •íœ´ì¼ ììœ¨í•™ìŠµ ì‹œê°„"
                    description="ì§€ì •íœ´ì¼ì˜ ììœ¨í•™ìŠµ ì‹œê°„ëŒ€"
                    value={data.time_settings?.designated_holiday_hours}
                    onChange={(range) => updateTimeSetting("designated_holiday_hours", range)}
                    defaultStart="13:00"
                    defaultEnd="19:00"
                    disabled={!editable}
                  />
                </div>
              )}

              {/* í•™ìŠµì¼/ë³µìŠµì¼ ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì •í•˜ê¸° í† ê¸€ */}
              <div className="flex items-center gap-2 rounded-lg border border-gray-200 bg-white p-3">
                <input
                  type="checkbox"
                  id="enable_self_study_for_study_days"
                  checked={data.time_settings?.enable_self_study_for_study_days ?? false}
                  onChange={(e) => {
                    if (!editable) return;
                    const enabled = e.target.checked;
                    onUpdate({
                      time_settings: {
                        ...data.time_settings,
                        enable_self_study_for_study_days: enabled,
                        camp_self_study_hours: enabled
                          ? data.time_settings?.camp_self_study_hours || { start: "19:00", end: "22:00" }
                          : undefined,
                        use_self_study_with_blocks: enabled ? true : undefined,
                      },
                    });
                  }}
                  disabled={!editable}
                  className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-60"
                />
                <label
                  htmlFor="enable_self_study_for_study_days"
                  className="flex flex-col gap-1 flex-1 cursor-pointer text-sm text-gray-800"
                >
                  <div className="font-medium">í•™ìŠµì¼/ë³µìŠµì¼ ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì •í•˜ê¸°</div>
                  <div className="text-xs text-gray-600">
                    í•™ìŠµì¼ê³¼ ë³µìŠµì¼ì— ììœ¨í•™ìŠµ ì‹œê°„ì„ ë°°ì •í•©ë‹ˆë‹¤. ì‹œê°„ë¸”ë¡ì´ ìˆì–´ë„ ììœ¨í•™ìŠµ ì‹œê°„ì„ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </div>
                </label>
              </div>

              {/* í•™ìŠµì¼/ë³µìŠµì¼ ì‹œê°„ ì„¤ì • */}
              {data.time_settings?.enable_self_study_for_study_days && (
                <div className="pl-7">
                  <TimeRangeInput
                    label="í•™ìŠµì¼/ë³µìŠµì¼ ììœ¨í•™ìŠµ ì‹œê°„"
                    description="í•™ìŠµì¼ê³¼ ë³µìŠµì¼ì˜ ììœ¨í•™ìŠµ ì‹œê°„ëŒ€"
                    value={data.time_settings?.camp_self_study_hours}
                    onChange={(range) => updateTimeSetting("camp_self_study_hours", range)}
                    defaultStart="19:00"
                    defaultEnd="22:00"
                    disabled={!editable}
                  />
                </div>
              )}
            </div>
          )}
    </div>
  );
});
</file>

<file path="new-group/_components/_panels/TimeSettingsPanel.tsx">
"use client";

import React from "react";
import { Info } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { ExclusionsPanel } from "./ExclusionsPanel";
import { AcademySchedulePanel } from "./AcademySchedulePanel";
import { TimeConfigPanel } from "./TimeConfigPanel";
import { NonStudyTimeBlocksPanel } from "./NonStudyTimeBlocksPanel";
import { CollapsibleSection } from "../_summary/CollapsibleSection";

type TimeSettingsPanelProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  periodStart: string;
  periodEnd: string;
  groupId?: string;
  onNavigateToStep?: (step: number) => void;
  campMode?: boolean;
  isTemplateMode?: boolean;
  templateExclusions?: Array<{
    exclusion_date: string;
    exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
    reason?: string;
  }>;
  editable?: boolean;
  studentId?: string;
  isAdminMode?: boolean;
  isAdminContinueMode?: boolean;
};

/**
 * ì‹œê°„ ì„¤ì • íŒ¨ë„ (Step 2 í†µí•©)
 * - ì œì™¸ì¼ ê´€ë¦¬
 * - í•™ì› ì¼ì • ê´€ë¦¬
 * - ì‹œê°„ ì„¤ì • (ì ì‹¬ì‹œê°„, ììœ¨í•™ìŠµ ë“±)
 * - í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª©
 */
export const TimeSettingsPanel = React.memo(function TimeSettingsPanel({
  data,
  onUpdate,
  periodStart,
  periodEnd,
  groupId,
  onNavigateToStep,
  campMode = false,
  isTemplateMode = false,
  templateExclusions,
  editable = true,
  studentId,
  isAdminMode = false,
  isAdminContinueMode = false,
}: TimeSettingsPanelProps) {
  return (
    <div className="flex flex-col gap-6">
      {/* í—¤ë” */}
      <div className="flex flex-col gap-3">
        <div className="flex flex-col gap-1">
          <h2 className="text-xl font-semibold text-gray-900">ë¸”ë¡ ë° ì œì™¸ì¼ ì„¤ì •</h2>
          <p className="text-sm text-gray-600">
            í•™ìŠµ ì œì™¸ì¼ê³¼ í•™ì› ì¼ì •ì„ ì„¤ì •í•´ì£¼ì„¸ìš”. ì„¤ì •í•œ ë‚´ìš©ì€ ìš°ì¸¡ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <div className="rounded-xl border border-blue-200 bg-blue-50 p-4">
          <div className="flex items-start gap-2">
            <Info className="h-4 w-4 flex-shrink-0 text-blue-600" />
            <div className="flex flex-col gap-1 text-xs text-blue-800">
              <p className="font-semibold">í•™ì› ì¼ì •ê³¼ ì œì™¸ì¼ì€ í•™ìƒë³„ë¡œ ì „ì—­ ê´€ë¦¬ë©ë‹ˆë‹¤.</p>
              <p>
                ì…ë ¥í•œ í•™ì› ì¼ì •ê³¼ ì œì™¸ì¼ì€ ëª¨ë“  í”Œëœ ê·¸ë£¹ì—ì„œ ê³µìœ ë˜ë©°, ì¤‘ë³µ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* í•™ìŠµ ì œì™¸ì¼ */}
      <CollapsibleSection
        title="í•™ìŠµ ì œì™¸ì¼"
        defaultOpen={true}
        studentInputAllowed={data.templateLockedFields?.step2?.allow_student_exclusions === true}
        onStudentInputToggle={(enabled) => {
          if (!isTemplateMode) return;
          const currentLocked = data.templateLockedFields?.step2 || {};
          onUpdate({
            templateLockedFields: {
              ...data.templateLockedFields,
              step2: {
                ...currentLocked,
                allow_student_exclusions: enabled,
              },
            },
          });
        }}
        showStudentInputToggle={isTemplateMode}
      >
        <ExclusionsPanel
          data={data}
          onUpdate={onUpdate}
          periodStart={periodStart}
          periodEnd={periodEnd}
          groupId={groupId}
          onNavigateToStep={onNavigateToStep}
          campMode={campMode}
          isTemplateMode={isTemplateMode}
          templateExclusions={templateExclusions}
          editable={editable}
        />
      </CollapsibleSection>

      {/* í•™ì› ì¼ì • */}
      <CollapsibleSection
        title="í•™ì› ì¼ì •"
        defaultOpen={true}
        studentInputAllowed={data.templateLockedFields?.step2?.allow_student_academy_schedules === true}
        onStudentInputToggle={(enabled) => {
          if (!isTemplateMode) return;
          const currentLocked = data.templateLockedFields?.step2 || {};
          onUpdate({
            templateLockedFields: {
              ...data.templateLockedFields,
              step2: {
                ...currentLocked,
                allow_student_academy_schedules: enabled,
              },
            },
          });
        }}
        showStudentInputToggle={isTemplateMode}
      >
        <AcademySchedulePanel
          data={data}
          onUpdate={onUpdate}
          groupId={groupId}
          campMode={campMode}
          isTemplateMode={isTemplateMode}
          editable={editable}
          studentId={studentId}
          isAdminMode={isAdminMode}
          isAdminContinueMode={isAdminContinueMode}
        />
      </CollapsibleSection>

      {/* ì‹œê°„ ì„¤ì • */}
      <CollapsibleSection
        title="ì‹œê°„ ì„¤ì •"
        defaultOpen={true}
        studentInputAllowed={data.templateLockedFields?.step2?.allow_student_time_settings === true}
        onStudentInputToggle={(enabled) => {
          if (!isTemplateMode) return;
          const currentLocked = data.templateLockedFields?.step2 || {};
          onUpdate({
            templateLockedFields: {
              ...data.templateLockedFields,
              step2: {
                ...currentLocked,
                allow_student_time_settings: enabled,
              },
            },
          });
        }}
        showStudentInputToggle={isTemplateMode}
      >
        <TimeConfigPanel
          data={data}
          onUpdate={onUpdate}
          campMode={campMode}
          isTemplateMode={isTemplateMode}
          editable={editable}
        />
      </CollapsibleSection>

      {/* í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª© */}
      <CollapsibleSection
        title="í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª©"
        defaultOpen={true}
        studentInputAllowed={data.templateLockedFields?.step2?.allow_student_non_study_time_blocks === true}
        onStudentInputToggle={(enabled) => {
          if (!isTemplateMode) return;
          const currentLocked = data.templateLockedFields?.step2 || {};
          onUpdate({
            templateLockedFields: {
              ...data.templateLockedFields,
              step2: {
                ...currentLocked,
                allow_student_non_study_time_blocks: enabled,
              },
            },
          });
        }}
        showStudentInputToggle={isTemplateMode}
      >
        <NonStudyTimeBlocksPanel
          data={data}
          onUpdate={onUpdate}
          campMode={campMode}
          isTemplateMode={isTemplateMode}
          editable={editable}
        />
      </CollapsibleSection>
    </div>
  );
});
</file>

<file path="new-group/_components/_shared/hooks/useContentDetailsBatch.ts">
/**
 * useContentDetailsBatch Hook
 * ë°°ì¹˜ API í˜¸ì¶œ ë¡œì§ í†µí•©, ìºì‹± ë¡œì§ í†µí•©, ì—ëŸ¬ ì²˜ë¦¬ í†µí•©
 */

import { useState, useEffect, useRef, useMemo } from "react";
import {
  createBatchRequest,
  transformBatchResponse,
  getContentType,
  type ContentType,
  type ContentDetailsResponse,
} from "@/lib/utils/contentDetailsUtils";

type ContentDetailData = {
  details: Array<{
    id: string;
    page_number?: number;
    episode_number?: number;
    major_unit?: string | null;
    minor_unit?: string | null;
    title?: string | null;
  }>;
  type: "book" | "lecture";
  total_pages?: number | null;
  total_episodes?: number | null;
};

type ContentMetadata = {
  subject?: string | null;
  semester?: string | null;
  revision?: string | null;
  difficulty_level?: string | null;
  publisher?: string | null;
  platform?: string | null;
};

type UseContentDetailsBatchProps = {
  contentIds: string[];
  bookIdSet: Set<string>;
  lectureIdSet?: Set<string>;
  includeMetadata?: boolean;
  studentId?: string;
  enabled?: boolean;
};

type UseContentDetailsBatchReturn = {
  contentDetails: Map<string, ContentDetailData>;
  contentMetadata: Map<string, ContentMetadata>;
  loadingDetails: Set<string>;
  error: Error | null;
};

export function useContentDetailsBatch({
  contentIds,
  bookIdSet,
  lectureIdSet,
  includeMetadata = false,
  studentId,
  enabled = true,
}: UseContentDetailsBatchProps): UseContentDetailsBatchReturn {
  const [contentDetails, setContentDetails] = useState<
    Map<string, ContentDetailData>
  >(new Map());
  const [contentMetadata, setContentMetadata] = useState<
    Map<string, ContentMetadata>
  >(new Map());
  const [loadingDetails, setLoadingDetails] = useState<Set<string>>(new Set());
  const [error, setError] = useState<Error | null>(null);

  // ì´ë¯¸ ì¡°íšŒí•œ ì½˜í…ì¸  ìƒì„¸ ì •ë³´ë¥¼ ìºì‹œë¡œ ê´€ë¦¬
  const cachedDetailsRef = useRef<Map<string, ContentDetailData>>(new Map());
  const cachedMetadataRef = useRef<Map<string, ContentMetadata>>(new Map());

  // ì½˜í…ì¸  ëª©ë¡ì„ content_id í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const contents = useMemo(
    () => contentIds.map((id) => ({ content_id: id })),
    [contentIds]
  );

  useEffect(() => {
    if (!enabled || contentIds.length === 0) {
      setContentDetails(new Map());
      setContentMetadata(new Map());
      setLoadingDetails(new Set());
      setError(null);
      return;
    }

    const fetchAllDetails = async () => {
      const newDetails = new Map<string, ContentDetailData>();
      const newMetadata = new Map<string, ContentMetadata>();

      // 1. ìºì‹œëœ ì½˜í…ì¸  ë¨¼ì € ì²˜ë¦¬
      const contentIdsToFetch: string[] = [];
      for (const contentId of contentIds) {
        if (cachedDetailsRef.current.has(contentId)) {
          newDetails.set(
            contentId,
            cachedDetailsRef.current.get(contentId)!
          );
          if (cachedMetadataRef.current.has(contentId)) {
            newMetadata.set(
              contentId,
              cachedMetadataRef.current.get(contentId)!
            );
          }
        } else {
          contentIdsToFetch.push(contentId);
        }
      }

      // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë°ì´íŠ¸
      if (newDetails.size > 0) {
        setContentDetails(new Map(newDetails));
        if (newMetadata.size > 0) {
          setContentMetadata(new Map(newMetadata));
        }
      }

      // 2. ë‚˜ë¨¸ì§€ ì½˜í…ì¸ ë“¤ì„ ë°°ì¹˜ APIë¡œ ì¡°íšŒ
      if (contentIdsToFetch.length === 0) {
        return;
      }

      // ëª¨ë“  ì½˜í…ì¸ ë¥¼ ë¡œë”© ìƒíƒœë¡œ ì„¤ì •
      const initialLoadingSet = new Set(contentIdsToFetch);
      setLoadingDetails(new Set(initialLoadingSet));
      setError(null);

      try {
        // ë°°ì¹˜ ìš”ì²­ ìƒì„±
        const batchRequest = createBatchRequest(
          contentIdsToFetch.map((id) => ({ content_id: id })),
          bookIdSet,
          includeMetadata
        );

        // studentIdê°€ ìˆìœ¼ë©´ ìš”ì²­ì— ì¶”ê°€
        const requestBody: typeof batchRequest & { student_id?: string } = {
          ...batchRequest,
        };
        if (studentId) {
          requestBody.student_id = studentId;
        }

        // ë°°ì¹˜ API í˜¸ì¶œ
        const response = await fetch("/api/student-content-details/batch", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestBody),
        });

        if (response.ok) {
          const result = await response.json();
          const batchData = result.data;

          // ë°°ì¹˜ ì‘ë‹µ ê²°ê³¼ ì²˜ë¦¬
          contentIdsToFetch.forEach((contentId) => {
            const contentType = getContentType(
              contentId,
              bookIdSet,
              lectureIdSet
            );
            const transformed = transformBatchResponse(
              batchData,
              contentId,
              contentType
            );

            if (transformed) {
              const detailData: ContentDetailData =
                contentType === "book"
                  ? {
                      details: transformed.details || [],
                      type: "book",
                      total_pages: transformed.total_pages ?? null,
                    }
                  : {
                      details: transformed.episodes || [],
                      type: "lecture",
                      total_episodes: transformed.total_episodes ?? null,
                    };

              // ìºì‹œì— ì €ì¥
              cachedDetailsRef.current.set(contentId, detailData);
              newDetails.set(contentId, detailData);

              // ë©”íƒ€ë°ì´í„° ì €ì¥
              if (transformed.metadata) {
                cachedMetadataRef.current.set(contentId, transformed.metadata);
                newMetadata.set(contentId, transformed.metadata);
              }
            } else {
              // ì‘ë‹µì´ ì—†ìœ¼ë©´ ë¹ˆ ë°ì´í„°ë¡œ ì €ì¥
              const contentType = getContentType(
                contentId,
                bookIdSet,
                lectureIdSet
              );
              const emptyDetailData: ContentDetailData =
                contentType === "book"
                  ? { details: [], type: "book", total_pages: null }
                  : { details: [], type: "lecture", total_episodes: null };
              cachedDetailsRef.current.set(contentId, emptyDetailData);
              newDetails.set(contentId, emptyDetailData);
            }
          });

          if (process.env.NODE_ENV === "development") {
            console.log("[useContentDetailsBatch] ë°°ì¹˜ API ì„±ê³µ:", {
              count: contentIdsToFetch.length,
              fetched: newDetails.size,
            });
          }
        } else {
          // ë°°ì¹˜ API ì‹¤íŒ¨ ì‹œ ê°œë³„ APIë¡œ fallback
          console.warn(
            "[useContentDetailsBatch] ë°°ì¹˜ API ì‹¤íŒ¨, ê°œë³„ APIë¡œ fallback"
          );

          const fetchPromises = contentIdsToFetch.map(async (contentId) => {
            const contentType = getContentType(
              contentId,
              bookIdSet,
              lectureIdSet
            );
            try {
              const endpoint = `/api/student-content-details?contentType=${contentType}&contentId=${contentId}&includeMetadata=${includeMetadata}${studentId ? `&student_id=${studentId}` : ""}`;
              const res = await fetch(endpoint);
              if (res.ok) {
                const r = await res.json();
                const transformed = transformBatchResponse(
                  { [contentId]: r.data },
                  contentId,
                  contentType
                );

                if (transformed) {
                  const d: ContentDetailData =
                    contentType === "book"
                      ? {
                          details: transformed.details || [],
                          type: "book",
                          total_pages: transformed.total_pages ?? null,
                        }
                      : {
                          details: transformed.episodes || [],
                          type: "lecture",
                          total_episodes: transformed.total_episodes ?? null,
                        };

                  cachedDetailsRef.current.set(contentId, d);
                  if (transformed.metadata) {
                    cachedMetadataRef.current.set(
                      contentId,
                      transformed.metadata
                    );
                    newMetadata.set(contentId, transformed.metadata);
                  }
                  return { contentId, data: d };
                }
              }
            } catch (e) {
              console.error(
                `[useContentDetailsBatch] ê°œë³„ API í˜¸ì¶œ ì‹¤íŒ¨ (${contentId}):`,
                e
              );
            }
            return null;
          });

          const results = await Promise.all(fetchPromises);
          results.forEach((r) => {
            if (r) {
              newDetails.set(r.contentId, r.data);
            }
          });
        }
      } catch (error) {
        const errorMessage =
          error instanceof Error ? error.message : String(error);
        const errorObj = new Error(
          `ì½˜í…ì¸  ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${errorMessage}`
        );
        setError(errorObj);
        console.error("[useContentDetailsBatch] Error:", error);
      } finally {
        setLoadingDetails(new Set());
      }

      setContentDetails(new Map(newDetails));
      if (newMetadata.size > 0) {
        setContentMetadata(new Map(newMetadata));
      }
    };

    fetchAllDetails();
  }, [
    contentIds,
    bookIdSet,
    lectureIdSet,
    includeMetadata,
    studentId,
    enabled,
  ]);

  return { contentDetails, contentMetadata, loadingDetails, error };
}
</file>

<file path="new-group/_components/_shared/BlockSetTimeline.tsx">
"use client";

import { Calendar } from "lucide-react";
import { createPositionStyle, createHeightStyle } from "@/lib/utils/cssVariables";

interface Block {
  day_of_week: number;
  start_time: string; // "HH:mm"
  end_time: string;
  block_index: number;
}

interface BlockSetTimelineProps {
  blocks: Block[];
  name?: string;
}

export function BlockSetTimeline({ blocks, name }: BlockSetTimelineProps) {
  if (blocks.length === 0) {
    return (
      <div className="flex flex-col gap-3">
        <div className="flex items-center justify-between">
          <p className="text-sm font-semibold text-gray-900">
            {name || "ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"}
          </p>
        </div>
        <div className="rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-8">
          <div className="flex flex-col items-center gap-3 text-center">
            <Calendar className="h-12 w-12 text-gray-400" />
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-800">
                ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
              </p>
              <p className="text-xs text-gray-500">
                ì„ íƒí•˜ë©´ ìš”ì¼ë³„ í•™ìŠµ ì‹œê°„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
  const hours = Array.from({ length: 25 }, (_, i) => i); // 0-24ì‹œ

  // ìš”ì¼ë³„ë¡œ ê·¸ë£¹í™”
  const blocksByDay = blocks.reduce((acc, block) => {
    const day = block.day_of_week;
    if (!acc[day]) acc[day] = [];
    acc[day].push(block);
    return acc;
  }, {} as Record<number, Block[]>);

  // ì‹œê°„ì„ ìˆ«ìë¡œ ë³€í™˜ (HH:mm -> ì‹œê°„ì˜ ì†Œìˆ˜ì )
  const timeToNumber = (time: string): number => {
    const [hours, minutes] = time.split(":").map(Number);
    return hours + minutes / 60;
  };

  // ë¸”ë¡ì˜ ìœ„ì¹˜ì™€ ë†’ì´ ê³„ì‚° (0-24ì‹œ ê¸°ì¤€, ë°±ë¶„ìœ¨)
  const getBlockStyle = (block: Block) => {
    const startHour = timeToNumber(block.start_time);
    const endHour = timeToNumber(block.end_time);
    const top = (startHour / 24) * 100;
    const height = ((endHour - startHour) / 24) * 100;
    return { top, height }; // ìˆ«ì ë°˜í™˜
  };

  // ë¸”ë¡ ìƒ‰ìƒ (block_indexì— ë”°ë¼)
  const getBlockColor = (index: number | undefined | null) => {
    const colors = [
      "bg-blue-500",
      "bg-indigo-500",
      "bg-purple-500",
      "bg-pink-500",
      "bg-cyan-500",
    ];
    // indexê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒ ì‚¬ìš©
    const safeIndex = index ?? 0;
    return colors[safeIndex % colors.length];
  };

  // ì‹œê°„ì„ ì‹œ:ë¶„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (HH:mm:ss -> HH:mm)
  const formatTime = (time: string): string => {
    // HH:mm:ss í˜•ì‹ì´ë©´ ì‹œ:ë¶„ë§Œ ì¶”ì¶œ
    if (time.includes(":") && time.split(":").length === 3) {
      const [hours, minutes] = time.split(":");
      return `${hours}:${minutes}`;
    }
    // ì´ë¯¸ HH:mm í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    return time;
  };

  return (
    <div className="flex flex-col gap-3">
      <div className="flex items-center justify-between">
        <p className="text-sm font-semibold text-gray-900">
          {name || "ì„ íƒëœ ë¸”ë¡ ì„¸íŠ¸"}
        </p>
        <p className="text-xs font-medium text-gray-800">
          ë“±ë¡ëœ ì‹œê°„ ë¸”ë¡ ({blocks.length}ê°œ)
        </p>
      </div>

      {/* íƒ€ì„ë¼ì¸ ì‹œê°í™” */}
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex flex-col gap-3">
          <div className="flex gap-1">
          {/* ì‹œê°„ ì¶• (ì™¼ìª½) - 3ì‹œê°„ ê°„ê²© */}
          <div className="flex w-14 flex-col justify-between py-2 pr-2 text-right">
            {[0, 3, 6, 9, 12, 15, 18, 21, 24].map((hour) => (
              <div
                key={hour}
                className={`text-[10px] ${
                  hour === 12
                    ? "font-bold text-gray-900"
                    : hour === 0 || hour === 24
                    ? "font-medium text-gray-400"
                    : "font-medium text-gray-600"
                }`}
              >
                {hour}ì‹œ
              </div>
            ))}
          </div>

          {/* ìš”ì¼ë³„ íƒ€ì„ë¼ì¸ */}
          <div className="flex flex-1 gap-1">
            {[1, 2, 3, 4, 5, 6, 0].map((day) => {
              const dayBlocks = blocksByDay[day] || [];
              const hasBlocks = dayBlocks.length > 0;

              return (
                <div key={day} className="flex flex-1 flex-col items-center gap-1">
                  {/* ìš”ì¼ ë¼ë²¨ */}
                  <div
                    className={`text-xs font-semibold ${
                      hasBlocks ? "text-gray-900" : "text-gray-400"
                    }`}
                  >
                    {dayNames[day]}
                  </div>

                  {/* íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆ */}
                  <div className="relative h-64 w-full rounded border border-gray-200 bg-gray-50">
                    {/* ì‹œê°„ ê·¸ë¦¬ë“œ ë¼ì¸ - 1ì‹œê°„ ê°„ê²© */}
                    {/* ì˜ˆì™¸: ë™ì  ì‹œê°„ ê¸°ë°˜ ìœ„ì¹˜ ê³„ì‚°ì€ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ í•„ìš” (Tailwind í´ë˜ìŠ¤ë¡œ ë³€í™˜ ë¶ˆê°€) */}
                    {Array.from({ length: 25 }, (_, i) => (
                      <div
                        key={`grid-${i}`}
                        className={`pointer-events-none absolute left-0 right-0 ${
                          i === 12
                            ? "border-t-2 border-gray-400"
                            : i % 3 === 0
                            ? "border-t border-gray-300"
                            : "border-t border-dashed border-gray-200"
                        }`}
                        style={createPositionStyle((i / 24) * 100)}
                      />
                    ))}

                    {/* ì˜¤ì „/ì˜¤í›„ ë¼ë²¨ */}
                    <div className="absolute left-1/2 top-1 -translate-x-1/2 text-[9px] text-gray-400">
                      ì˜¤ì „
                    </div>
                    <div className="absolute bottom-1 left-1/2 -translate-x-1/2 text-[9px] text-gray-400">
                      ì˜¤í›„
                    </div>

                    {/* ë¸”ë¡ í‘œì‹œ */}
                    {dayBlocks.map((block, idx) => {
                      const blockStyle = getBlockStyle(block);
                      const colorClass = getBlockColor(block.block_index ?? 0);

                      return (
                        <div
                          key={idx}
                          className={`group absolute left-1 right-1 rounded ${
                            colorClass || "bg-blue-500"
                          } cursor-pointer opacity-80 transition-opacity hover:opacity-100 flex flex-col justify-between`}
                          style={{
                            ...createPositionStyle(blockStyle.top),
                            ...createHeightStyle(blockStyle.height),
                          }}
                          title={`${formatTime(block.start_time)} ~ ${formatTime(block.end_time)}`}
                        >
                          {/* ì‹œì‘ ì‹œê°„ - ìƒë‹¨ */}
                          <div className="flex items-center justify-center px-1 pt-0.5">
                            <div className="text-[9px] font-semibold text-white drop-shadow-[0_1px_2px_rgb(0_0_0/0.5)]">
                              {formatTime(block.start_time)}
                            </div>
                          </div>

                          {/* ì¢…ë£Œ ì‹œê°„ - í•˜ë‹¨ */}
                          <div className="flex items-center justify-center px-1 pb-0.5">
                            <div className="text-[9px] font-semibold text-white drop-shadow-[0_1px_2px_rgb(0_0_0/0.5)]">
                              {formatTime(block.end_time)}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/_shared/ContentCard.tsx">
"use client";

import React from "react";
import { Trash2, Edit, BookOpen, Video, Star } from "lucide-react";
import { ContentCardProps } from "@/lib/types/content-selection";
import { cn } from "@/lib/cn";

/**
 * ContentCard - ì½˜í…ì¸  ì¹´ë“œ ê³µí†µ ì»´í¬ë„ŒíŠ¸
 *
 * í•™ìƒ ì½˜í…ì¸ ì™€ ì¶”ì²œ ì½˜í…ì¸  ëª¨ë‘ì—ì„œ ì‚¬ìš©
 * Phase 3ì—ì„œ ì¤‘ë³µ ì½”ë“œ ì œê±°ë¥¼ ìœ„í•´ ìƒì„±
 */
export const ContentCard = React.memo(function ContentCard({
  content,
  selected,
  disabled = false,
  readOnly = false,
  range,
  recommended,
  onToggle,
  onRemove,
  onEditRange,
}: ContentCardProps) {
  const isBook = content.id.startsWith("book") || !content.platform;
  const isLecture = !isBook;

  return (
    <div
      className={cn(
        "flex flex-col gap-3 rounded-lg border p-4 transition-all",
        selected
          ? "border-blue-500 bg-blue-50"
          : "border-gray-200 bg-white hover:border-gray-300",
        disabled && "opacity-50 cursor-not-allowed"
      )}
    >
      {/* í—¤ë” */}
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-start gap-3 flex-1 min-w-0">
          {/* ì•„ì´ì½˜ */}
          <div
            className={cn(
              "flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg",
              isBook ? "bg-amber-100" : "bg-purple-100"
            )}
          >
            {isBook ? (
              <BookOpen className="h-5 w-5 text-amber-600" />
            ) : (
              <Video className="h-5 w-5 text-purple-600" />
            )}
          </div>

          {/* ì½˜í…ì¸  ì •ë³´ */}
          <div className="flex flex-1 flex-col gap-2 min-w-0">
            <div className="flex items-center gap-2">
              <h3 className="font-medium text-gray-900 truncate">
                {content.title}
              </h3>
              {recommended && (
                <div className="flex items-center gap-1 flex-shrink-0">
                  <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                  <span className="text-xs font-medium text-yellow-600">
                    ì¶”ì²œ {recommended.priority}
                  </span>
                </div>
              )}
            </div>

            {/* ë©”íƒ€ë°ì´í„° */}
            <div className="flex flex-wrap items-center gap-2 text-xs text-gray-600">
              {content.subject && (
                <span className="rounded bg-gray-100 px-2 py-0.5">
                  {content.subject}
                </span>
              )}
              {content.semester && (
                <span className="rounded bg-gray-100 px-2 py-0.5">
                  {content.semester}
                </span>
              )}
              {content.difficulty && (
                <span className="rounded bg-gray-100 px-2 py-0.5">
                  {content.difficulty}
                </span>
              )}
              {content.publisher && (
                <span className="text-gray-600">{content.publisher}</span>
              )}
              {content.platform && (
                <span className="text-gray-600">{content.platform}</span>
              )}
            </div>

            {/* ë²”ìœ„ ì •ë³´ */}
            {range && (
              <div className="flex items-center gap-2 text-sm">
                <span className="font-medium text-gray-800">ë²”ìœ„:</span>
                <span className="text-gray-600">
                  {range.start} ~ {range.end}
                </span>
              </div>
            )}

            {/* ì¶”ì²œ ì‚¬ìœ  */}
            {recommended && recommended.reason && (
              <div className="flex flex-col gap-0.5 rounded-lg bg-yellow-50 p-2 text-sm text-gray-600">
                <p className="font-medium text-yellow-800">ì¶”ì²œ ì´ìœ :</p>
                <p className="text-gray-600">{recommended.reason}</p>
              </div>
            )}

            {/* ì„±ì  ìƒì„¸ (ì¶”ì²œ ì½˜í…ì¸ ) */}
            {recommended && recommended.scoreDetails && (
              <div className="flex flex-wrap gap-2 text-xs">
                {recommended.scoreDetails.schoolGrade !== null && (
                  <span className="rounded bg-blue-100 px-2 py-0.5 text-blue-800">
                    ë‚´ì‹ : {recommended.scoreDetails.schoolGrade}ë“±ê¸‰
                  </span>
                )}
                {recommended.scoreDetails.mockGrade !== null && (
                  <span className="rounded bg-green-100 px-2 py-0.5 text-green-700">
                    ëª¨ì˜: {recommended.scoreDetails.mockGrade}ë“±ê¸‰
                  </span>
                )}
                {recommended.scoreDetails.riskScore !== undefined && (
                  <span
                    className={cn(
                      "rounded px-2 py-0.5",
                      recommended.scoreDetails.riskScore > 7
                        ? "bg-red-100 text-red-700"
                        : recommended.scoreDetails.riskScore > 4
                        ? "bg-yellow-100 text-yellow-700"
                        : "bg-green-100 text-green-700"
                    )}
                  >
                    ìœ„í—˜ë„: {recommended.scoreDetails.riskScore}/10
                  </span>
                )}
              </div>
            )}
          </div>
        </div>

        {/* ì•¡ì…˜ ë²„íŠ¼ */}
        {!readOnly && (
          <div className="flex flex-shrink-0 items-center gap-1">
            {/* ë²”ìœ„ ìˆ˜ì • ë²„íŠ¼ */}
            {selected && onEditRange && (
              <button
                type="button"
                onClick={onEditRange}
                disabled={disabled}
                className={cn(
                  "rounded p-2 transition-colors hover:bg-gray-100",
                  disabled && "cursor-not-allowed opacity-50"
                )}
                title="ë²”ìœ„ ìˆ˜ì •"
              >
                <Edit className="h-4 w-4 text-gray-600" />
              </button>
            )}

            {/* ì‚­ì œ ë²„íŠ¼ */}
            {selected && onRemove && (
              <button
                type="button"
                onClick={onRemove}
                disabled={disabled}
                className={cn(
                  "rounded p-2 transition-colors hover:bg-red-100",
                  disabled && "cursor-not-allowed opacity-50"
                )}
                title="ì‚­ì œ"
              >
                <Trash2 className="h-4 w-4 text-red-600" />
              </button>
            )}

            {/* ì„ íƒ/í•´ì œ ë²„íŠ¼ */}
            {!selected && onToggle && (
              <button
                type="button"
                onClick={onToggle}
                disabled={disabled}
                className={cn(
                  "rounded-lg border-2 border-blue-500 px-4 py-2 text-sm font-medium text-blue-600 transition-colors hover:bg-blue-50",
                  disabled && "cursor-not-allowed opacity-50 hover:bg-white"
                )}
              >
                ì„ íƒ
              </button>
            )}
          </div>
        )}
      </div>

      {/* ì½ê¸° ì „ìš© í‘œì‹œ */}
      {readOnly && selected && (
        <div className="rounded bg-gray-100 px-3 py-2 text-xs text-gray-600">
          ì„ íƒëœ ì½˜í…ì¸  (ì½ê¸° ì „ìš©)
        </div>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_shared/ContentRangeInput.tsx">
"use client";

import React, { useMemo, useRef, useCallback } from "react";
import { AlertCircle, BookOpen, Video } from "lucide-react";
import {
  ContentRangeInputProps,
  BookDetail,
  LectureEpisode,
} from "@/lib/types/content-selection";
import { cn } from "@/lib/cn";

/**
 * ContentRangeInput - ì½˜í…ì¸  ë²”ìœ„ ì„ íƒ ì…ë ¥
 *
 * - ì±…: í˜ì´ì§€ ë²ˆí˜¸ ì„ íƒ
 * - ê°•ì˜: ì—í”¼ì†Œë“œ ë²ˆí˜¸ ì„ íƒ
 * - ì‹œì‘/ë ë²”ìœ„ ê²€ì¦
 */
export const ContentRangeInput = React.memo(function ContentRangeInput({
  type,
  details,
  startDetailId,
  endDetailId,
  startRange,
  endRange,
  totalPages,
  totalEpisodes,
  onStartChange,
  onEndChange,
  onStartRangeChange,
  onEndRangeChange,
  loading = false,
  error = null,
}: ContentRangeInputProps) {
  const isBook = type === "book";
  const hasDetails = details.length > 0;
  const maxValue = isBook ? totalPages : totalEpisodes;

  // í¬ì»¤ìŠ¤ ê´€ë¦¬ ref
  const startInputRef = useRef<HTMLInputElement>(null);
  const endInputRef = useRef<HTMLInputElement>(null);

  // ì‹œì‘/ë ì¸ë±ìŠ¤
  const startIndex = useMemo(() => {
    return details.findIndex((d) => d.id === startDetailId);
  }, [details, startDetailId]);

  const endIndex = useMemo(() => {
    return details.findIndex((d) => d.id === endDetailId);
  }, [details, endDetailId]);

  // ë²”ìœ„ ê²€ì¦
  const isValidRange =
    startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex;

  // ì„ íƒ ê°€ëŠ¥í•œ ì¢…ë£Œ ì˜µì…˜ (ì‹œì‘ì  ì´í›„ë§Œ)
  const availableEndDetails = useMemo(() => {
    if (startIndex === -1) return details;
    return details.slice(startIndex);
  }, [details, startIndex]);

  // ì˜µì…˜ ë ˆì´ë¸” ìƒì„± (ë©”ëª¨ì´ì œì´ì…˜)
  const getOptionLabel = useCallback((detail: BookDetail | LectureEpisode) => {
    if (isBook) {
      const bookDetail = detail as BookDetail;
      return `p.${bookDetail.page_number}${
        bookDetail.major_unit ? ` - ${bookDetail.major_unit}` : ""
      }${bookDetail.minor_unit ? ` > ${bookDetail.minor_unit}` : ""}`;
    } else {
      const lectureDetail = detail as LectureEpisode;
      return `${lectureDetail.episode_number}ê°•${
        lectureDetail.episode_title ? ` - ${lectureDetail.episode_title}` : ""
      }`;
    }
  }, [isBook]);

  if (loading) {
    return (
      <div className="flex items-center justify-center gap-3 py-8">
        <div className="h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent" />
        <span className="text-sm text-gray-800">ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="rounded-lg border border-red-200 bg-red-50 p-4">
        <div className="flex items-start gap-2">
          <AlertCircle className="h-5 w-5 flex-shrink-0 text-red-600" />
          <div className="flex flex-col gap-1">
            <p className="font-medium text-red-900">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
            <p className="text-sm text-red-700">{error}</p>
          </div>
        </div>
      </div>
    );
  }

  // ìƒì„¸ ì •ë³´ê°€ ì—†ì„ ë•Œ ì§ì ‘ ì…ë ¥ ëª¨ë“œ
  if (!hasDetails) {
    // ë¡œê·¸ ì œê±° (RangeSettingModalì—ì„œ ì´ë¯¸ ë¡œê·¸ ì¶œë ¥)

    // ë¹ˆ ê°’ì„ í—ˆìš©í•˜ë„ë¡ ìˆ˜ì • (ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒ€ì²´í•˜ì§€ ì•ŠìŒ)
    const currentStart = startRange ?? "";
    const currentEnd = endRange ?? "";

    return (
      <div className="flex flex-col gap-4">
        {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
        <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-3">
          <p className="text-sm font-medium text-blue-800">
            ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤
          </p>
          <p className="text-xs text-blue-800">
            {isBook
              ? "í˜ì´ì§€ ë²”ìœ„ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”."
              : "íšŒì°¨ ë²”ìœ„ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”."}
          </p>
          {maxValue && (
            <p className="text-xs text-blue-800">
              {isBook
                ? `ì´ í˜ì´ì§€ìˆ˜: ${maxValue}í˜ì´ì§€`
                : `ì´ íšŒì°¨: ${maxValue}íšŒì°¨`}
            </p>
          )}
        </div>

        {/* ì‹œì‘ ë²”ìœ„ ì…ë ¥ */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-800">
            ì‹œì‘ {isBook ? "í˜ì´ì§€" : "íšŒì°¨"}
          </label>
          <input
            ref={startInputRef}
            type="number"
            min="1"
            max={maxValue || undefined}
            value={currentStart}
            onChange={(e) => {
              if (onStartRangeChange) {
                // ë¹ˆ ê°’ë„ í—ˆìš©
                onStartRangeChange(e.target.value);
              }
            }}
            onKeyDown={(e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                // ì¢…ë£Œ ë²”ìœ„ ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
                endInputRef.current?.focus();
              }
            }}
            className="block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 shadow-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            placeholder="ì˜ˆ: 1"
          />
        </div>

        {/* ì¢…ë£Œ ë²”ìœ„ ì…ë ¥ */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-800">
            ì¢…ë£Œ {isBook ? "í˜ì´ì§€" : "íšŒì°¨"}
          </label>
          <input
            ref={endInputRef}
            type="number"
            min="1"
            max={maxValue || undefined}
            value={currentEnd}
            onChange={(e) => {
              if (onEndRangeChange) {
                // ë¹ˆ ê°’ë„ í—ˆìš©
                onEndRangeChange(e.target.value);
              }
            }}
            onKeyDown={(e) => {
              if (e.key === "Enter") {
                e.preventDefault();
                // currentTargetì„ ì¦‰ì‹œ ì €ì¥ (null ì•ˆì „ì„±)
                const target = e.currentTarget;
                if (!target) return;
                
                // ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                const dialog = target.closest('[role="dialog"]');
                if (dialog) {
                  const saveButton = dialog.querySelector('button[type="button"]:last-child') as HTMLButtonElement;
                  if (saveButton && !saveButton.disabled) {
                    saveButton.focus();
                  } else {
                    // ì €ì¥ ë²„íŠ¼ì´ ì—†ê±°ë‚˜ ë¹„í™œì„±í™”ëœ ê²½ìš° í¬ì»¤ìŠ¤ ìœ ì§€
                    target.focus();
                  }
                }
              }
            }}
            className="block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 shadow-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            placeholder={maxValue ? `ì˜ˆ: ${maxValue}` : "ì˜ˆ: 100"}
          />
        </div>

        {/* ë²”ìœ„ ìš”ì•½ */}
        {currentStart &&
          currentEnd &&
          Number(currentStart) > 0 &&
          Number(currentEnd) > 0 && (
            <div className="flex flex-col gap-1 rounded-lg bg-blue-50 p-3">
              <p className="text-sm font-medium text-blue-800">ì„ íƒëœ ë²”ìœ„</p>
              <p className="text-sm text-blue-800">
                {isBook
                  ? `${currentStart}í˜ì´ì§€ ~ ${currentEnd}í˜ì´ì§€`
                  : `${currentStart}íšŒì°¨ ~ ${currentEnd}íšŒì°¨`}
              </p>
              {Number(currentStart) && Number(currentEnd) && (
                <p className="text-xs text-blue-800">
                  ì´ {Number(currentEnd) - Number(currentStart) + 1}
                  {isBook ? "í˜ì´ì§€" : "íšŒì°¨"}
                </p>
              )}
            </div>
          )}

        {/* ë²”ìœ„ ê²€ì¦ */}
        {currentStart &&
          currentEnd &&
          Number(currentStart) > 0 &&
          Number(currentEnd) > 0 &&
          Number(currentStart) > Number(currentEnd) && (
            <div className="flex items-start gap-2 rounded-lg bg-red-50 p-3">
              <AlertCircle className="h-4 w-4 flex-shrink-0 text-red-600" />
              <p className="text-sm text-red-800">
                ì‹œì‘ì´ ì¢…ë£Œë³´ë‹¤ ë’¤ì— ìˆìŠµë‹ˆë‹¤. ë²”ìœ„ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.
              </p>
            </div>
          )}
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {/* íƒ€ì… í‘œì‹œ */}
      <div className="flex items-center gap-2 text-sm text-gray-800">
        {isBook ? (
          <>
            <BookOpen className="h-4 w-4" />
            <span>êµì¬ í˜ì´ì§€ ë²”ìœ„</span>
          </>
        ) : (
          <>
            <Video className="h-4 w-4" />
            <span>ê°•ì˜ ì—í”¼ì†Œë“œ ë²”ìœ„</span>
          </>
        )}
      </div>

      {/* ì‹œì‘ ë²”ìœ„ */}
      <div className="flex flex-col gap-1">
        <label className="block text-sm font-medium text-gray-800">
          ì‹œì‘ {isBook ? "í˜ì´ì§€" : "ê°•"}
        </label>
        <select
          value={startDetailId || ""}
          onChange={(e) => onStartChange(e.target.value)}
          className={cn(
            "block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm transition-colors",
            "focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500",
            !startDetailId && "text-gray-600"
          )}
        >
          <option value="" disabled>
            {isBook ? "ì‹œì‘ í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”" : "ì‹œì‘ ê°•ì„ ì„ íƒí•˜ì„¸ìš”"}
          </option>
          {details.map((detail) => (
            <option key={detail.id} value={detail.id}>
              {getOptionLabel(detail)}
            </option>
          ))}
        </select>
      </div>

      {/* ì¢…ë£Œ ë²”ìœ„ */}
      <div className="flex flex-col gap-1">
        <label className="block text-sm font-medium text-gray-800">
          ì¢…ë£Œ {isBook ? "í˜ì´ì§€" : "ê°•"}
        </label>
        <select
          value={endDetailId || ""}
          onChange={(e) => onEndChange(e.target.value)}
          disabled={!startDetailId}
          className={cn(
            "block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm transition-colors",
            "focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500",
            !endDetailId && "text-gray-600",
            !startDetailId && "cursor-not-allowed opacity-50"
          )}
        >
          <option value="" disabled>
            {isBook ? "ì¢…ë£Œ í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”" : "ì¢…ë£Œ ê°•ì„ ì„ íƒí•˜ì„¸ìš”"}
          </option>
          {availableEndDetails.map((detail) => (
            <option key={detail.id} value={detail.id}>
              {getOptionLabel(detail)}
            </option>
          ))}
        </select>
        {!startDetailId && (
          <p className="text-xs text-gray-800">
            ë¨¼ì € ì‹œì‘ {isBook ? "í˜ì´ì§€" : "ê°•"}ë¥¼ ì„ íƒí•˜ì„¸ìš”
          </p>
        )}
      </div>

      {/* ë²”ìœ„ ìš”ì•½ */}
      {isValidRange && startDetailId && endDetailId && (
        <div className="flex flex-col gap-1 rounded-lg bg-blue-50 p-3">
          <p className="text-sm font-medium text-blue-900">ì„ íƒëœ ë²”ìœ„</p>
          <p className="text-sm text-blue-700">
            {getOptionLabel(details[startIndex])} ~{" "}
            {getOptionLabel(details[endIndex])}
          </p>
          {isBook && (
            <p className="text-xs text-blue-800">
              ì´{" "}
              {(details[endIndex] as BookDetail).page_number -
                (details[startIndex] as BookDetail).page_number +
                1}
              í˜ì´ì§€
            </p>
          )}
          {!isBook && (
            <p className="text-xs text-blue-800">
              ì´{" "}
              {(details[endIndex] as LectureEpisode).episode_number -
                (details[startIndex] as LectureEpisode).episode_number +
                1}
              ê°•
            </p>
          )}
        </div>
      )}

      {/* ë²”ìœ„ ì˜¤ë¥˜ */}
      {startDetailId && endDetailId && !isValidRange && (
        <div className="flex items-start gap-2 rounded-lg bg-red-50 p-3">
          <AlertCircle className="h-4 w-4 flex-shrink-0 text-red-600" />
          <p className="text-sm text-red-800">
            ì‹œì‘ì´ ì¢…ë£Œë³´ë‹¤ ë’¤ì— ìˆìŠµë‹ˆë‹¤. ë²”ìœ„ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.
          </p>
        </div>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_shared/ContentSelectionProgress.tsx">
"use client";

import React from "react";
import { AlertCircle, CheckCircle, XCircle } from "lucide-react";
import { ProgressIndicatorProps } from "@/lib/types/content-selection";
import { cn } from "@/lib/cn";
import { ProgressBar } from "@/components/atoms/ProgressBar";

/**
 * ContentSelectionProgress - ì½˜í…ì¸  ì„ íƒ ì§„í–‰ë¥  í‘œì‹œ
 * 
 * Content selection specific progress indicator with features:
 * - ì „ì²´ ì§„í–‰ë¥  (X/9)
 * - í•„ìˆ˜ ê³¼ëª© ì²´í¬ (êµ­/ìˆ˜/ì˜)
 * - ê²½ê³  ë©”ì‹œì§€ ë° ì´ˆê³¼ ê²½ê³ 
 * 
 * For simple progress bars, use _shared/ProgressIndicator instead.
 */
export const ContentSelectionProgress = React.memo(function ContentSelectionProgress({
  current,
  max,
  requiredSubjects = [],
  showWarning = false,
  warningMessage,
}: ProgressIndicatorProps) {
  const percentage = Math.round((current / max) * 100);
  const isComplete = current === max;
  const isOverLimit = current > max;

  // í•„ìˆ˜ ê³¼ëª© ì²´í¬ (ìº í”„ ëª¨ë“œì—ì„œë§Œ)
  const hasRequiredSubjects = requiredSubjects.length > 0;
  const allRequiredSelected =
    hasRequiredSubjects &&
    requiredSubjects.every((subj) => subj.selected);
  const someRequiredMissing =
    hasRequiredSubjects &&
    requiredSubjects.some((subj) => !subj.selected);

  return (
    <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-white p-6">
      {/* ì§„í–‰ë¥  í—¤ë” */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-gray-900">
          ì½˜í…ì¸  ì„ íƒ ì§„í–‰ë¥ 
        </h3>
        <div className="flex items-center gap-2">
          {isOverLimit ? (
            <XCircle className="h-5 w-5 text-red-500" />
          ) : isComplete ? (
            <CheckCircle className="h-5 w-5 text-green-500" />
          ) : (
            <div className="h-5 w-5" />
          )}
          <span
            className={cn(
              "text-2xl font-bold",
              isOverLimit
                ? "text-red-600"
                : isComplete
                ? "text-green-600"
                : "text-blue-600"
            )}
          >
            {current}
          </span>
          <span className="text-lg text-gray-400">/</span>
          <span className="text-lg font-medium text-gray-600">{max}</span>
        </div>
      </div>

      {/* ì§„í–‰ë¥  ë°” */}
      <div className="flex flex-col gap-2">
        <ProgressBar
          value={Math.min(percentage, 100)}
          variant={isOverLimit ? "error" : isComplete ? "success" : undefined}
          color={isOverLimit ? undefined : isComplete ? undefined : "blue"}
          size="sm"
        />
        <div className="flex items-center justify-between text-sm">
          <span className="text-gray-600">
            {current === 0
              ? "ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"
              : current < max
              ? `${max - current}ê°œ ë” ì„ íƒ ê°€ëŠ¥`
              : isOverLimit
              ? `${current - max}ê°œ ì´ˆê³¼`
              : "ì„ íƒ ì™„ë£Œ"}
          </span>
          <span className="font-medium text-gray-700">{percentage}%</span>
        </div>
      </div>

      {/* í•„ìˆ˜ ê³¼ëª© ì²´í¬ (ìº í”„ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */}
      {hasRequiredSubjects && (
        <div className="flex flex-col gap-2 rounded-lg bg-gray-50 p-4">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-gray-700">
              í•„ìˆ˜ ê³¼ëª©
            </span>
            {allRequiredSelected && (
              <CheckCircle className="h-4 w-4 text-green-500" />
            )}
          </div>
          <div className="flex flex-wrap gap-2">
            {requiredSubjects.map((subj) => (
              <div
                key={subj.subject}
                className={cn(
                  "flex items-center gap-1.5 rounded-full px-3 py-1 text-sm font-medium",
                  subj.selected
                    ? "bg-green-100 text-green-700"
                    : "bg-gray-200 text-gray-600"
                )}
              >
                {subj.selected ? (
                  <CheckCircle className="h-3.5 w-3.5" />
                ) : (
                  <XCircle className="h-3.5 w-3.5" />
                )}
                <span>{subj.subject}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ê²½ê³  ë©”ì‹œì§€ */}
      {showWarning && warningMessage && (
        <div className="flex items-start gap-2 rounded-lg bg-yellow-50 p-3">
          <AlertCircle className="h-5 w-5 flex-shrink-0 text-yellow-600" />
          <p className="text-sm text-yellow-800">{warningMessage}</p>
        </div>
      )}

      {/* ì´ˆê³¼ ê²½ê³  */}
      {isOverLimit && (
        <div className="flex items-start gap-2 rounded-lg bg-red-50 p-3">
          <AlertCircle className="h-5 w-5 flex-shrink-0 text-red-600" />
          <p className="text-sm text-red-800">
            ìµœëŒ€ {max}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. {current - max}ê°œë¥¼
            ì œê±°í•´ì£¼ì„¸ìš”.
          </p>
        </div>
      )}

      {/* í•„ìˆ˜ ê³¼ëª© ë¯¸ì„ íƒ ê²½ê³  (ìº í”„ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */}
      {hasRequiredSubjects && someRequiredMissing && current >= max && (
        <div className="flex items-start gap-2 rounded-lg bg-yellow-50 p-3">
          <AlertCircle className="h-5 w-5 flex-shrink-0 text-yellow-600" />
          <div className="flex flex-col gap-1 text-sm text-yellow-800">
            <p className="font-medium">í•„ìˆ˜ ê³¼ëª©ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            <p>
              {requiredSubjects
                .filter((s) => !s.selected)
                .map((s) => s.subject)
                .join(", ")}
              ê³¼ëª©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            </p>
          </div>
        </div>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_shared/ContentSelector.tsx">
"use client";

import React, { useState, useMemo } from "react";
import { Search, BookOpen, Video, Plus } from "lucide-react";
import { cn } from "@/lib/cn";

/**
 * ContentSelector - ì½˜í…ì¸  ì„ íƒê¸°
 * 
 * í•™ìƒì˜ êµì¬/ê°•ì˜/ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì„ íƒ
 */

type ContentItem = {
  id: string;
  title: string;
  subtitle?: string | null;
  master_content_id?: string | null;
};

type ContentSelectorProps = {
  // ì½˜í…ì¸  ëª©ë¡
  books: ContentItem[];
  lectures: ContentItem[];
  custom: ContentItem[];
  
  // ì´ë¯¸ ì„ íƒëœ ID
  selectedIds: Set<string>;
  
  // ì„ íƒ í•¸ë“¤ëŸ¬
  onSelect: (contentId: string, type: "book" | "lecture" | "custom") => void;
  
  // ìƒíƒœ
  disabled?: boolean;
  maxReached?: boolean;
};

export const ContentSelector = React.memo(function ContentSelector({
  books,
  lectures,
  custom,
  selectedIds,
  onSelect,
  disabled = false,
  maxReached = false,
}: ContentSelectorProps) {
  const [activeTab, setActiveTab] = useState<"book" | "lecture" | "custom">("book");
  const [searchQuery, setSearchQuery] = useState("");

  // í•„í„°ë§ëœ ì½˜í…ì¸ 
  const filteredContents = useMemo(() => {
    const currentList =
      activeTab === "book"
        ? books
        : activeTab === "lecture"
        ? lectures
        : custom;

    if (!searchQuery.trim()) return currentList;

    const query = searchQuery.toLowerCase();
    return currentList.filter(
      (item) =>
        item.title.toLowerCase().includes(query) ||
        item.subtitle?.toLowerCase().includes(query)
    );
  }, [activeTab, books, lectures, custom, searchQuery]);

  // ì„ íƒ ê°€ëŠ¥í•œ ì½˜í…ì¸  (ì´ë¯¸ ì„ íƒëœ ê²ƒ ì œì™¸)
  const availableContents = useMemo(() => {
    return filteredContents.filter((item) => !selectedIds.has(item.id));
  }, [filteredContents, selectedIds]);

  // íƒ­ë³„ ê°œìˆ˜
  const tabCounts = useMemo(() => {
    return {
      book: books.filter((b) => !selectedIds.has(b.id)).length,
      lecture: lectures.filter((l) => !selectedIds.has(l.id)).length,
      custom: custom.filter((c) => !selectedIds.has(c.id)).length,
    };
  }, [books, lectures, custom, selectedIds]);

  return (
    <div className="rounded-xl border border-gray-200 bg-white p-6">
      <div className="flex flex-col gap-4">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-900">
            ì½˜í…ì¸  ì¶”ê°€
          </h3>
          {maxReached && (
            <span className="text-sm font-medium text-red-600">
              ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬
            </span>
          )}
        </div>

        {/* íƒ­ */}
        <div className="flex gap-2">
        <button
          type="button"
          onClick={() => setActiveTab("book")}
          disabled={disabled}
          className={cn(
            "flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors",
            activeTab === "book"
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-800 hover:bg-gray-200",
            disabled && "cursor-not-allowed opacity-50"
          )}
        >
          <BookOpen className="h-4 w-4" />
          <span>êµì¬</span>
          <span
            className={cn(
              "rounded-full px-2 py-0.5 text-xs",
              activeTab === "book"
                ? "bg-blue-500 text-white"
                : "bg-gray-200 text-gray-600"
            )}
          >
            {tabCounts.book}
          </span>
        </button>

        <button
          type="button"
          onClick={() => setActiveTab("lecture")}
          disabled={disabled}
          className={cn(
            "flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors",
            activeTab === "lecture"
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-800 hover:bg-gray-200",
            disabled && "cursor-not-allowed opacity-50"
          )}
        >
          <Video className="h-4 w-4" />
          <span>ê°•ì˜</span>
          <span
            className={cn(
              "rounded-full px-2 py-0.5 text-xs",
              activeTab === "lecture"
                ? "bg-blue-500 text-white"
                : "bg-gray-200 text-gray-600"
            )}
          >
            {tabCounts.lecture}
          </span>
        </button>

        <button
          type="button"
          onClick={() => setActiveTab("custom")}
          disabled={disabled}
          className={cn(
            "flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors",
            activeTab === "custom"
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-800 hover:bg-gray-200",
            disabled && "cursor-not-allowed opacity-50"
          )}
        >
          <Plus className="h-4 w-4" />
          <span>ì»¤ìŠ¤í…€</span>
          <span
            className={cn(
              "rounded-full px-2 py-0.5 text-xs",
              activeTab === "custom"
                ? "bg-blue-500 text-white"
                : "bg-gray-200 text-gray-600"
            )}
          >
            {tabCounts.custom}
          </span>
        </button>
      </div>

      {/* ê²€ìƒ‰ */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
        <input
          type="text"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          placeholder="ì½˜í…ì¸  ê²€ìƒ‰..."
          disabled={disabled}
          className={cn(
            "w-full rounded-lg border border-gray-300 py-2 pl-10 pr-4 text-sm text-gray-900 placeholder:text-gray-500 transition-colors",
            "focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500",
            disabled && "cursor-not-allowed bg-gray-50 opacity-50"
          )}
        />
      </div>

      {/* ì½˜í…ì¸  ëª©ë¡ */}
      <div className="flex flex-col gap-4 max-h-96 overflow-y-auto">
        {availableContents.length === 0 ? (
          <div className="flex flex-col gap-1 items-center justify-center py-12 text-center">
            <div className="rounded-full bg-gray-100 p-3">
              {activeTab === "book" ? (
                <BookOpen className="h-6 w-6 text-gray-400" />
              ) : activeTab === "lecture" ? (
                <Video className="h-6 w-6 text-gray-400" />
              ) : (
                <Plus className="h-6 w-6 text-gray-400" />
              )}
            </div>
            <p className="text-sm font-medium text-gray-900">
              {searchQuery
                ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤"
                : "ì„ íƒ ê°€ëŠ¥í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤"}
            </p>
            <p className="text-sm text-gray-500">
              {searchQuery
                ? "ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”"
                : "ëª¨ë“  ì½˜í…ì¸ ê°€ ì´ë¯¸ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤"}
            </p>
          </div>
        ) : (
          availableContents.map((item) => (
            <button
              key={item.id}
              type="button"
              onClick={() => onSelect(item.id, activeTab)}
              disabled={disabled || maxReached}
              className={cn(
                "w-full rounded-lg border border-gray-200 bg-white p-3 text-left transition-all hover:border-blue-500 hover:bg-blue-50",
                (disabled || maxReached) &&
                  "cursor-not-allowed opacity-50 hover:border-gray-200 hover:bg-white"
              )}
            >
              <div className="flex items-start justify-between gap-3">
                <div className="flex flex-col gap-0.5 flex-1 min-w-0">
                  <h4 className="font-medium text-gray-900 truncate">
                    {item.title}
                  </h4>
                  {item.subtitle && (
                    <p className="text-sm text-gray-600 truncate">
                      {item.subtitle}
                    </p>
                  )}
                </div>
                <div
                  className={cn(
                    "flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-lg",
                    activeTab === "book"
                      ? "bg-amber-100"
                      : activeTab === "lecture"
                      ? "bg-purple-100"
                      : "bg-blue-100"
                  )}
                >
                  {activeTab === "book" ? (
                    <BookOpen className="h-4 w-4 text-amber-600" />
                  ) : activeTab === "lecture" ? (
                    <Video className="h-4 w-4 text-purple-600" />
                  ) : (
                    <Plus className="h-4 w-4 text-blue-600" />
                  )}
                </div>
              </div>
            </button>
          ))
        )}
      </div>
      </div>
    </div>
  );
});
</file>

<file path="new-group/_components/_shared/DateInput.tsx">
"use client";

import { useRef } from "react";
import { cn } from "@/lib/cn";

type DateInputProps = {
  id: string;
  label: string;
  value: string;
  onChange: (value: string) => void;
  disabled?: boolean;
  min?: string;
  max?: string;
  className?: string;
  labelClassName?: string;
  required?: boolean;
  ariaLabel?: string;
  ariaDescribedBy?: string;
  error?: string;
  dataFieldId?: string;
};

/**
 * showPicker ë©”ì„œë“œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” íƒ€ì… ê°€ë“œ í•¨ìˆ˜
 */
function hasShowPicker(
  input: HTMLInputElement
): input is HTMLInputElement & { showPicker: () => void } {
  return (
    input.type === "date" &&
    typeof (input as HTMLInputElement & { showPicker?: () => void }).showPicker === "function"
  );
}

/**
 * ë‚ ì§œ ì…ë ¥ í•„ë“œ ì»´í¬ë„ŒíŠ¸
 * ì „ì²´ ì˜ì—­ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ìµœì í™”ëœ ë‚ ì§œ ì„ íƒ í•„ë“œ
 */
export function DateInput({
  id,
  label,
  value,
  onChange,
  disabled = false,
  min,
  max,
  className,
  labelClassName,
  required = false,
  ariaLabel,
  ariaDescribedBy,
  error,
  dataFieldId,
}: DateInputProps) {
  const inputRef = useRef<HTMLInputElement>(null);

  /**
   * ë‹¬ë ¥ ì—´ê¸° í•¨ìˆ˜ (ê³µí†µ ë¡œì§)
   * setTimeoutì„ ì‚¬ìš©í•˜ì—¬ í¬ì»¤ìŠ¤ í›„ showPicker í˜¸ì¶œ íƒ€ì´ë° ë¬¸ì œ í•´ê²°
   */
  const openDatePicker = () => {
    if (disabled || !inputRef.current) return;

    const input = inputRef.current;

    // inputì„ í¬ì»¤ìŠ¤
    input.focus();

    // showPicker() í˜¸ì¶œ (íƒ€ì´ë° ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ setTimeout ì‚¬ìš©)
    setTimeout(() => {
      if (input === document.activeElement && hasShowPicker(input)) {
        try {
          input.showPicker();
        } catch (error) {
          // showPickerê°€ ì‹¤íŒ¨í•˜ë©´ ê¸°ë³¸ ë™ì‘(í¬ì»¤ìŠ¤)ë§Œ ìˆ˜í–‰
          if (process.env.NODE_ENV === "development") {
            console.debug("[DateInput] showPicker not supported or failed:", error);
          }
        }
      }
    }, 0);
  };

  const handleWrapperClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (disabled) return;
    e.stopPropagation();
    openDatePicker();
  };

  const handleInputClick = (e: React.MouseEvent<HTMLInputElement>) => {
    if (disabled) return;
    e.stopPropagation();
    openDatePicker();
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (disabled) return;
    // Enter í‚¤ë¡œ ë‹¬ë ¥ ì—´ê¸°
    if (e.key === "Enter" && e.currentTarget === document.activeElement) {
      e.preventDefault();
      openDatePicker();
    }
  };

  const errorId = error ? `${id}-error` : undefined;
  const describedBy = [ariaDescribedBy, errorId].filter(Boolean).join(" ") || undefined;

  return (
    <div className="flex flex-col gap-2" data-field-id={dataFieldId}>
      <label
        htmlFor={id}
        className={cn(
          "block text-sm font-medium text-gray-800",
          disabled ? "cursor-not-allowed opacity-60" : "cursor-pointer",
          labelClassName
        )}
      >
        {label}
        {required && <span className="text-red-500 ml-1">*</span>}
      </label>
      <div
        className={cn(
          "relative",
          !disabled && "cursor-pointer"
        )}
        onClick={handleWrapperClick}
      >
        <input
          ref={inputRef}
          id={id}
          type="date"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          onClick={handleInputClick}
          onKeyDown={handleKeyDown}
          disabled={disabled}
          min={min}
          max={max}
          aria-label={ariaLabel || label}
          aria-describedby={describedBy}
          aria-required={required}
          aria-invalid={error ? "true" : undefined}
          className={cn(
            "w-full rounded-lg border px-3 py-2.5 text-sm text-gray-900",
            error
              ? "border-red-500 focus:border-red-500 focus:ring-red-500"
              : "border-gray-300 focus:border-gray-900",
            "focus:outline-none",
            "disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60",
            // ì „ì²´ ì˜ì—­ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ìŠ¤íƒ€ì¼ ì ìš©
            !disabled && "cursor-pointer",
            // WebKit ë¸Œë¼ìš°ì €ì—ì„œ ë‹¬ë ¥ ì•„ì´ì½˜ì„ ë” í¬ê³  í´ë¦­í•˜ê¸° ì‰½ê²Œ ë§Œë“¤ê¸°
            !disabled && "[&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:w-6 [&::-webkit-calendar-picker-indicator]:h-6 [&::-webkit-calendar-picker-indicator]:ml-2",
            className
          )}
          style={{
            // Firefox ë° ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ìœ„í•œ ì „ì²´ ì˜ì—­ í´ë¦­ ê°€ëŠ¥ ì²˜ë¦¬
            cursor: disabled ? "not-allowed" : "pointer",
          }}
        />
      </div>
      {/* ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ì„œ í‘œì‹œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ */}
    </div>
  );
}
</file>

<file path="new-group/_components/_shared/EditableField.tsx">
"use client";

import React from "react";
import { cn } from "@/lib/cn";

/**
 * EditableField - í¸ì§‘/ì½ê¸° ëª¨ë“œ í†µí•© í•„ë“œ
 * 
 * Phase 5.2ì—ì„œ êµ¬í˜„
 * Step ì»´í¬ë„ŒíŠ¸ì—ì„œ modeì— ë”°ë¼ ë‹¤ë¥¸ UI í‘œì‹œ
 */

export type ViewMode = "edit" | "readonly";

export type EditableFieldProps = {
  label: string;
  value: string | number | null | undefined;
  mode?: ViewMode;
  onChange?: (value: string) => void;
  type?: "text" | "date" | "select" | "number";
  options?: Array<{ value: string; label: string }>;
  locked?: boolean;
  placeholder?: string;
  required?: boolean;
  description?: string;
  emptyText?: string;
};

export const EditableField = React.memo(function EditableField({
  label,
  value,
  mode = "edit",
  onChange,
  type = "text",
  options,
  locked = false,
  placeholder,
  required = false,
  description,
  emptyText = "â€”",
}: EditableFieldProps) {
  const displayValue = value ?? emptyText;

  // ì½ê¸° ì „ìš© ëª¨ë“œ
  if (mode === "readonly") {
    return (
      <div className="flex flex-col gap-1">
        <dt className="text-sm font-medium text-gray-500">{label}</dt>
        <dd className="text-lg text-gray-900">
          {type === "select" && options
            ? options.find((opt) => opt.value === value)?.label || displayValue
            : displayValue}
        </dd>
        {description && (
          <p className="text-sm text-gray-600">{description}</p>
        )}
      </div>
    );
  }

  // í¸ì§‘ ëª¨ë“œ
  return (
    <div className="flex flex-col gap-1">
      <label
        className={cn(
          "block text-sm font-medium text-gray-800",
          // ì˜ˆì™¸: CSS pseudo-elementì˜ marginì€ gapìœ¼ë¡œ ë³€í™˜ ë¶ˆê°€ (after:ml-0.5)
          required && "after:ml-0.5 after:text-red-500 after:content-['*']"
        )}
      >
        {label}
      </label>
        {description && (
          <p className="text-sm text-gray-600">{description}</p>
        )}
      {type === "select" && options ? (
        <select
          value={value ?? ""}
          onChange={(e) => onChange?.(e.target.value)}
          disabled={locked}
          className={cn(
            "block w-full rounded-md border-gray-300 text-gray-900 shadow-sm",
            "focus:border-blue-500 focus:ring-blue-500",
            locked && "cursor-not-allowed bg-gray-100 text-gray-600"
          )}
        >
          <option value="">{placeholder || "ì„ íƒí•˜ì„¸ìš”"}</option>
          {options.map((opt) => (
            <option key={opt.value} value={opt.value}>
              {opt.label}
            </option>
          ))}
        </select>
      ) : (
        <input
          type={type}
          value={value ?? ""}
          onChange={(e) => onChange?.(e.target.value)}
          disabled={locked}
          placeholder={placeholder}
          className={cn(
            "block w-full rounded-md border-gray-300 text-gray-900 placeholder:text-gray-600 shadow-sm",
            "focus:border-blue-500 focus:ring-blue-500",
            locked && "cursor-not-allowed bg-gray-100 text-gray-600"
          )}
        />
      )}
      {locked && (
        <p className="text-xs text-amber-600">
          ì´ í•„ë“œëŠ” í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤
        </p>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_shared/FieldError.tsx">
"use client";

type FieldErrorProps = {
  error?: string;
  id?: string;
};

/**
 * í•„ë“œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œë¥¼ ìœ„í•œ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸
 * ì¼ê´€ëœ ìŠ¤íƒ€ì¼ë§ ë° ì ‘ê·¼ì„± ì†ì„± ì ìš©
 */
export function FieldError({ error, id }: FieldErrorProps) {
  if (!error) return null;

  return (
    <p
      id={id}
      className="text-xs text-red-600 mt-1"
      role="alert"
      aria-live="polite"
    >
      {error}
    </p>
  );
}
</file>

<file path="new-group/_components/_shared/fieldErrorUtils.ts">
import { cn } from "@/lib/cn";

/**
 * í•„ë“œì— ì˜¤ë¥˜ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
 * ì¡°ê±´ë¶€ í´ë˜ìŠ¤ëª… ë³‘í•©
 */
export function getFieldErrorClasses(
  baseClasses: string,
  hasError: boolean
): string {
  return cn(
    baseClasses,
    hasError && "border-red-500 focus:border-red-500 focus:ring-red-500"
  );
}
</file>

<file path="new-group/_components/_shared/index.ts">
/**
 * ê³µìœ  ì»´í¬ë„ŒíŠ¸ ë°°ëŸ´ ìµìŠ¤í¬íŠ¸
 */

// Phase 3: ì½˜í…ì¸  ì„ íƒ ì»´í¬ë„ŒíŠ¸
export { ContentCard } from "./ContentCard";
export { RangeSettingModal } from "./RangeSettingModal";
export { ContentRangeInput } from "./ContentRangeInput";
export { ContentSelectionProgress } from "./ContentSelectionProgress";
export { ContentSelector } from "./ContentSelector";
export { StudentContentsPanel } from "./StudentContentsPanel";
export { RecommendedContentsPanel } from "./RecommendedContentsPanel";
export { MasterContentsPanel } from "./MasterContentsPanel";
export { UnifiedContentsView } from "./UnifiedContentsView";

// Phase 5: í¸ì§‘/ì½ê¸° ëª¨ë“œ í†µí•© ì»´í¬ë„ŒíŠ¸
export { EditableField } from "./EditableField";
export type { ViewMode, EditableFieldProps } from "./EditableField";

// ê³µí†µ ì…ë ¥ ì»´í¬ë„ŒíŠ¸
export { DateInput } from "./DateInput";
</file>

<file path="new-group/_components/_shared/MasterContentsPanel.tsx">
"use client";

import React, { useState, useCallback, useMemo, useEffect } from "react";
import { SelectedContent, ContentRange } from "@/lib/types/content-selection";
import { ContentMaster } from "@/lib/types/plan";
import { ContentCard } from "./ContentCard";
import { RangeSettingModal } from "./RangeSettingModal";
import { searchContentMastersAction } from "@/app/(student)/actions/contentMasterActions";
import { Package, Search, BookOpen, Headphones } from "lucide-react";
import { cn } from "@/lib/cn";

type MasterContentsPanelProps = {
  selectedContents: SelectedContent[];
  maxContents: number;
  currentTotal: number;
  onUpdate: (contents: SelectedContent[]) => void;
  editable?: boolean;
  isCampMode?: boolean;
};

/**
 * MasterContentsPanel - ë§ˆìŠ¤í„° ì½˜í…ì¸  ì„ íƒ íŒ¨ë„
 *
 * ë§ˆìŠ¤í„° ì½˜í…ì¸ ë¥¼ ê²€ìƒ‰í•˜ê³  ì„ íƒí•˜ì—¬ student_contentsì— ì¶”ê°€
 */
export function MasterContentsPanel({
  selectedContents,
  maxContents,
  currentTotal,
  onUpdate,
  editable = true,
  isCampMode = false,
}: MasterContentsPanelProps) {
  // ê²€ìƒ‰ ìƒíƒœ
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedContentType, setSelectedContentType] = useState<
    "book" | "lecture" | "all"
  >("all");
  const [curriculumRevisionId, setCurriculumRevisionId] = useState("");
  const [subjectGroupId, setSubjectGroupId] = useState("");
  const [subjectId, setSubjectId] = useState("");
  const [searchResults, setSearchResults] = useState<ContentMaster[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);
  const [curriculumRevisions, setCurriculumRevisions] = useState<Array<{ id: string; name: string }>>([]);
  const [subjectGroups, setSubjectGroups] = useState<Array<{ id: string; name: string }>>([]);
  // êµê³¼ë³„ ê³¼ëª©ì„ Mapìœ¼ë¡œ ê´€ë¦¬ (êµê³¼ ID â†’ ê³¼ëª© ëª©ë¡)
  const [subjectsMap, setSubjectsMap] = useState<Map<string, Array<{ id: string; name: string }>>>(new Map());
  const [loadingGroups, setLoadingGroups] = useState(false);
  const [loadingSubjects, setLoadingSubjects] = useState(false);

  // í˜„ì¬ ì„ íƒëœ êµê³¼ì˜ ê³¼ëª© ëª©ë¡
  const currentSubjects = subjectGroupId 
    ? subjectsMap.get(subjectGroupId) || []
    : [];

  // ë²”ìœ„ ì„¤ì • ëª¨ë‹¬
  const [rangeModalOpen, setRangeModalOpen] = useState(false);
  const [rangeModalContent, setRangeModalContent] = useState<{
    id: string;
    type: "book" | "lecture";
    title: string;
    masterContentId: string;
    currentRange?: ContentRange;
  } | null>(null);

  // ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬
  const maxReached = currentTotal >= maxContents;
  const canAddMore = !maxReached;
  const remaining = maxContents - currentTotal;

  // ì´ë¯¸ ì„ íƒëœ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ìˆ˜ì§‘ (ì¤‘ë³µ ì²´í¬ìš©)
  const selectedMasterIds = useMemo(() => {
    const ids = new Set<string>();
    selectedContents.forEach((c) => {
      if ((c as any).master_content_id) {
        ids.add((c as any).master_content_id);
      }
    });
    return ids;
  }, [selectedContents]);

  // ê°œì •êµìœ¡ê³¼ì • ëª©ë¡ ë¡œë“œ
  useEffect(() => {
    fetch("/api/curriculum-revisions")
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          setCurriculumRevisions(data.data || []);
        }
      })
      .catch((err) => {
        console.error("ê°œì •êµìœ¡ê³¼ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
      });
  }, []);


  // ê°œì •êµìœ¡ê³¼ì • ë³€ê²½ ì‹œ êµê³¼ì™€ ê³¼ëª© ëª©ë¡ ë³‘ë ¬ ë¡œë“œ
  useEffect(() => {
    if (curriculumRevisionId) {
      loadHierarchyData(curriculumRevisionId);
    } else {
      setSubjectGroups([]);
      setSubjectsMap(new Map());
      setSubjectGroupId("");
      setSubjectId("");
    }
  }, [curriculumRevisionId]);

  // êµê³¼ ë³€ê²½ ì‹œ ê³¼ëª© ì´ˆê¸°í™” (ì´ë¯¸ ë¡œë“œëœ ë°ì´í„° ì‚¬ìš©)
  useEffect(() => {
    // êµê³¼ê°€ ë³€ê²½ë˜ì—ˆëŠ”ë° í•´ë‹¹ êµê³¼ì˜ ê³¼ëª©ì´ subjectsMapì— ì—†ëŠ” ê²½ìš° ê°œë³„ ë¡œë“œ
    if (
      subjectGroupId &&
      !subjectsMap.has(subjectGroupId)
    ) {
      // ëª¨ë“  ê³¼ëª©ì´ ì´ë¯¸ ë¡œë“œë˜ì–´ì•¼ í•˜ëŠ”ë° ì—†ëŠ” ê²½ìš°ì—ë§Œ ê°œë³„ ë¡œë“œ
      setLoadingSubjects(true);
      fetch(`/api/subjects?subject_group_id=${subjectGroupId}`)
        .then((res) => res.json())
        .then((data) => {
          const newSubjects = data.data || [];
          setSubjectsMap((prev) => {
            const next = new Map(prev);
            next.set(subjectGroupId, newSubjects);
            return next;
          });
          setLoadingSubjects(false);
        })
        .catch((err) => {
          console.error("ê³¼ëª© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
          setLoadingSubjects(false);
        });
    }

    // êµê³¼ ë³€ê²½ ì‹œ ê³¼ëª© ì´ˆê¸°í™”
    if (subjectGroupId) {
      setSubjectId("");
    }
  }, [subjectGroupId, subjectsMap]);

  // ê³„ì¸µ êµ¬ì¡° ë°ì´í„° ë¡œë“œ (ë³‘ë ¬ ì²˜ë¦¬)
  const loadHierarchyData = async (curriculumRevisionId: string) => {
    setLoadingGroups(true);
    setLoadingSubjects(true);

    try {
      // êµê³¼ì™€ ê³¼ëª©ì„ í•¨ê»˜ ì¡°íšŒ (ë³‘ë ¬ ì²˜ë¦¬)
      const response = await fetch(
        `/api/subject-groups?curriculum_revision_id=${curriculumRevisionId}&include_subjects=true`
      );
      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
      }

      const groupsWithSubjects = result.data || [];
      const groups: Array<{ id: string; name: string }> = groupsWithSubjects.map(
        (group: { id: string; name: string; subjects?: Array<{ id: string; name: string }> }) => ({
          id: group.id,
          name: group.name,
        })
      );

      // êµê³¼ë³„ ê³¼ëª©ì„ Mapìœ¼ë¡œ ë³€í™˜
      const newSubjectsMap = new Map<string, Array<{ id: string; name: string }>>();
      groupsWithSubjects.forEach((group: { id: string; name: string; subjects?: Array<{ id: string; name: string }> }) => {
        if (group.subjects && group.subjects.length > 0) {
          newSubjectsMap.set(group.id, group.subjects);
        }
      });

      setSubjectGroups(groups);
      setSubjectsMap(newSubjectsMap);
      setSubjectGroupId("");
      setSubjectId("");
      setLoadingGroups(false);
      setLoadingSubjects(false);
    } catch (err) {
      console.error("ê³„ì¸µ êµ¬ì¡° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      setLoadingGroups(false);
      setLoadingSubjects(false);
      setSubjectGroups([]);
      setSubjectsMap(new Map());
    }
  };

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  ê²€ìƒ‰
  const handleSearch = useCallback(async () => {
    if (
      !searchQuery.trim() &&
      !curriculumRevisionId &&
      !subjectGroupId &&
      !subjectId &&
      selectedContentType === "all"
    ) {
      alert("ê²€ìƒ‰ì–´, í•„í„°, ë˜ëŠ” ì½˜í…ì¸  íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    setIsSearching(true);
    setHasSearched(true);

    try {
      // ì½˜í…ì¸  íƒ€ì…ë³„ë¡œ ê²€ìƒ‰
      const searchPromises: Promise<{
        data: ContentMaster[];
        total: number;
      }>[] = [];

      if (selectedContentType === "all" || selectedContentType === "book") {
        searchPromises.push(
          searchContentMastersAction({
            content_type: "book",
            curriculum_revision_id: curriculumRevisionId || undefined,
            subject_group_id: subjectGroupId || undefined,
            subject_id: subjectId || undefined,
            search: searchQuery.trim() || undefined,
            limit: 20,
          })
        );
      }

      if (selectedContentType === "all" || selectedContentType === "lecture") {
        searchPromises.push(
          searchContentMastersAction({
            content_type: "lecture",
            curriculum_revision_id: curriculumRevisionId || undefined,
            subject_group_id: subjectGroupId || undefined,
            subject_id: subjectId || undefined,
            search: searchQuery.trim() || undefined,
            limit: 20,
          })
        );
      }

      const results = await Promise.all(searchPromises);
      const allResults: ContentMaster[] = [];

      // ê° ê²€ìƒ‰ ê²°ê³¼ë¥¼ í•©ì¹˜ë©´ì„œ content_type í™•ì¸
      results.forEach((result, index) => {
        // searchContentMastersì—ì„œ ì´ë¯¸ content_typeì„ ì¶”ê°€í–ˆì§€ë§Œ,
        // í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê²€ì¦ ë° ì¶”ê°€
        const dataWithType = result.data.map((item: any) => {
          // content_typeì´ ì—†ìœ¼ë©´ ê²€ìƒ‰ íƒ€ì…ì— ë”°ë¼ ì¶”ê°€
          if (!item.content_type) {
            // ì²« ë²ˆì§¸ ê²°ê³¼ëŠ” book, ë‘ ë²ˆì§¸ëŠ” lecture (selectedContentType === "all"ì¸ ê²½ìš°)
            const contentType =
              selectedContentType === "book" ||
              (selectedContentType === "all" && index === 0)
                ? "book"
                : "lecture";
            return {
              ...item,
              content_type: contentType,
            };
          }
          return item;
        });

        allResults.push(...dataWithType);
      });

      // ë””ë²„ê¹…: ê²€ìƒ‰ ê²°ê³¼ì˜ content_type í™•ì¸
      if (process.env.NODE_ENV === "development") {
        console.log("[MasterContentsPanel] ê²€ìƒ‰ ê²°ê³¼:", {
          selectedContentType,
          resultsCount: allResults.length,
          contentTypes: allResults.map((r) => ({
            id: r.id,
            title: r.title,
            content_type: r.content_type,
          })),
        });
      }

      setSearchResults(allResults);
    } catch (error) {
      console.error("[MasterContentsPanel] ê²€ìƒ‰ ì‹¤íŒ¨:", error);
      alert(error instanceof Error ? error.message : "ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setIsSearching(false);
    }
  }, [searchQuery, curriculumRevisionId, subjectGroupId, subjectId, selectedContentType]);

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  ì„ íƒ
  const handleMasterContentSelect = useCallback(
    (masterContent: ContentMaster) => {
      if (!editable) return;

      // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
      if (maxReached) {
        alert(`í”Œëœ ëŒ€ìƒ ì½˜í…ì¸ ëŠ” ìµœëŒ€ ${maxContents}ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        return;
      }

      // ì¤‘ë³µ ì²´í¬
      if (selectedMasterIds.has(masterContent.id)) {
        alert("ì´ë¯¸ ì¶”ê°€ëœ ì½˜í…ì¸ ì…ë‹ˆë‹¤.");
        return;
      }

      // ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
      const contentType = masterContent.content_type;

      // content_typeì´ "book" ë˜ëŠ” "lecture"ì¸ì§€ í™•ì¸
      if (contentType !== "book" && contentType !== "lecture") {
        console.error("[MasterContentsPanel] ì˜ëª»ëœ content_type:", {
          id: masterContent.id,
          title: masterContent.title,
          content_type: contentType,
        });
        alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸  íƒ€ì…ì…ë‹ˆë‹¤.");
        return;
      }

      setRangeModalContent({
        id: masterContent.id,
        type: contentType as "book" | "lecture",
        title: masterContent.title,
        masterContentId: masterContent.id,
      });
      setRangeModalOpen(true);
    },
    [editable, maxReached, maxContents, selectedMasterIds]
  );

  // ì½˜í…ì¸  ì‚­ì œ
  const handleContentRemove = useCallback(
    (contentId: string) => {
      if (!editable) return;
      const updated = selectedContents.filter(
        (c) => c.content_id !== contentId
      );
      onUpdate(updated);
    },
    [selectedContents, onUpdate, editable]
  );

  // ë²”ìœ„ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
  const handleEditRange = useCallback(
    (content: SelectedContent) => {
      if (!editable) return;

      // custom íƒ€ì…ì€ ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ
      if (content.content_type === "custom") {
        alert("ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const masterContentId =
        (content as any).master_content_id || content.content_id;

      setRangeModalContent({
        id: masterContentId,
        type: content.content_type as "book" | "lecture",
        title: content.title || "ì œëª© ì—†ìŒ",
        masterContentId,
        currentRange: {
          start: String(content.start_range),
          end: String(content.end_range),
          start_detail_id: content.start_detail_id,
          end_detail_id: content.end_detail_id,
        },
      });
      setRangeModalOpen(true);
    },
    [editable]
  );

  // ë²”ìœ„ ì €ì¥
  const handleRangeSave = useCallback(
    async (range: ContentRange) => {
      if (!rangeModalContent) return;

      const { id, type, title, masterContentId } = rangeModalContent;

      // ê¸°ì¡´ ì½˜í…ì¸  ì°¾ê¸° (master_content_idë¡œ ê²€ìƒ‰)
      const existingIndex = selectedContents.findIndex(
        (c) => (c as any).master_content_id === masterContentId
      );

      const newContent: SelectedContent = {
        content_type: type,
        content_id: id, // ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ content_idë¡œ ì‚¬ìš©
        start_range: Number(range.start.replace(/[^\d]/g, "")),
        end_range: Number(range.end.replace(/[^\d]/g, "")),
        start_detail_id: range.start_detail_id,
        end_detail_id: range.end_detail_id,
        title,
        master_content_id: masterContentId, // ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ì €ì¥
      };

      let updated: SelectedContent[];
      if (existingIndex >= 0) {
        // ê¸°ì¡´ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
        updated = [...selectedContents];
        updated[existingIndex] = newContent;
      } else {
        // ìƒˆ ì½˜í…ì¸  ì¶”ê°€
        updated = [...selectedContents, newContent];
      }

      onUpdate(updated);
      setRangeModalOpen(false);
      setRangeModalContent(null);
    },
    [rangeModalContent, selectedContents, onUpdate]
  );

  // í•„í„°ë§ëœ ê²€ìƒ‰ ê²°ê³¼ (ì´ë¯¸ ì¶”ê°€ëœ ê²ƒ ì œì™¸)
  const filteredSearchResults = useMemo(() => {
    return searchResults.filter((result) => !selectedMasterIds.has(result.id));
  }, [searchResults, selectedMasterIds]);

  // ë§ˆìŠ¤í„° ì½˜í…ì¸ ì—ì„œ ì¶”ê°€ëœ ì½˜í…ì¸ ë§Œ í•„í„°ë§
  const masterContentsAdded = useMemo(() => {
    return selectedContents.filter((c) => (c as any).master_content_id);
  }, [selectedContents]);

  return (
    <div className="flex flex-col gap-6">
      {/* ê²€ìƒ‰ í¼ */}
      <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-white p-6">
        <div className="flex items-center gap-2">
          <Package className="h-5 w-5 text-gray-800" />
          <h3 className="text-lg font-semibold text-gray-900">
            ë§ˆìŠ¤í„° ì½˜í…ì¸  ê²€ìƒ‰
          </h3>
        </div>

        <div className="flex flex-col gap-4">
          {/* ì½˜í…ì¸  íƒ€ì… ì„ íƒ */}
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-800">
              ì½˜í…ì¸  íƒ€ì…
            </label>
            <div className="flex gap-2">
              <button
                type="button"
                onClick={() => setSelectedContentType("all")}
                className={cn(
                  "flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition-colors",
                  selectedContentType === "all"
                    ? "border-blue-600 bg-blue-50 text-blue-800"
                    : "border-gray-300 bg-white text-gray-800 hover:bg-gray-50"
                )}
              >
                ì „ì²´
              </button>
              <button
                type="button"
                onClick={() => setSelectedContentType("book")}
                className={cn(
                  "flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition-colors",
                  selectedContentType === "book"
                    ? "border-blue-600 bg-blue-50 text-blue-800"
                    : "border-gray-300 bg-white text-gray-800 hover:bg-gray-50"
                )}
              >
                <BookOpen className="h-4 w-4" />
                êµì¬
              </button>
              <button
                type="button"
                onClick={() => setSelectedContentType("lecture")}
                className={cn(
                  "flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition-colors",
                  selectedContentType === "lecture"
                    ? "border-blue-600 bg-blue-50 text-blue-800"
                    : "border-gray-300 bg-white text-gray-800 hover:bg-gray-50"
                )}
              >
                <Headphones className="h-4 w-4" />
                ê°•ì˜
              </button>
            </div>
          </div>

          {/* í•„í„° í•­ëª© (ê°€ë¡œí˜•) */}
          <div className="flex flex-wrap items-end gap-4">
            {/* ì œëª© ê²€ìƒ‰ */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                ì œëª© ê²€ìƒ‰
              </label>
              <input
                type="text"
                className="rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
                placeholder="êµì¬/ê°•ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter") {
                    handleSearch();
                  }
                }}
                disabled={!editable || isSearching}
              />
            </div>

            {/* ê°œì •êµìœ¡ê³¼ì • ì„ íƒ */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                ê°œì •êµìœ¡ê³¼ì •
              </label>
              <select
                value={curriculumRevisionId}
                onChange={(e) => {
                  setCurriculumRevisionId(e.target.value);
                  setSubjectGroupId("");
                  setSubjectId("");
                }}
                className="rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                disabled={!editable || isSearching}
              >
                <option value="">ì „ì²´</option>
                {curriculumRevisions.map((rev) => (
                  <option key={rev.id} value={rev.id}>
                    {rev.name}
                  </option>
                ))}
              </select>
            </div>

            {/* êµê³¼ ì„ íƒ */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                êµê³¼
              </label>
              <select
                value={subjectGroupId}
                onChange={(e) => {
                  setSubjectGroupId(e.target.value);
                  setSubjectId("");
                }}
                className="rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                disabled={!editable || isSearching || !curriculumRevisionId || loadingGroups}
              >
                <option value="">ì „ì²´</option>
                {loadingGroups ? (
                  <option value="">ë¡œë”© ì¤‘...</option>
                ) : (
                  subjectGroups.map((group) => (
                    <option key={group.id} value={group.id}>
                      {group.name}
                    </option>
                  ))
                )}
              </select>
            </div>

            {/* ê³¼ëª© ì„ íƒ */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                ê³¼ëª©
              </label>
              <select
                value={subjectId}
                onChange={(e) => setSubjectId(e.target.value)}
                className="rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                disabled={!editable || isSearching || !subjectGroupId || loadingSubjects}
              >
                <option value="">ì „ì²´</option>
                {loadingSubjects ? (
                  <option value="">ë¡œë”© ì¤‘...</option>
                ) : (
                  currentSubjects.map((subject) => (
                    <option key={subject.id} value={subject.id}>
                      {subject.name}
                    </option>
                  ))
                )}
              </select>
            </div>

            {/* ê²€ìƒ‰ ë²„íŠ¼ */}
            <button
              type="button"
              onClick={handleSearch}
              disabled={
                !editable ||
                isSearching ||
                (!searchQuery.trim() &&
                  !curriculumRevisionId &&
                  !subjectGroupId &&
                  !subjectId &&
                  selectedContentType === "all")
              }
              className="rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
            >
              {isSearching ? (
                <span className="flex items-center justify-center gap-2">
                  <span className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
                  ê²€ìƒ‰ ì¤‘...
                </span>
              ) : (
                <span className="flex items-center justify-center gap-2">
                  <Search className="h-4 w-4" />
                  ê²€ìƒ‰
                </span>
              )}
            </button>
          </div>
        </div>
      </div>

      {/* ê²€ìƒ‰ ê²°ê³¼ */}
      {hasSearched && (
        <div className="flex flex-col gap-3 rounded-xl border border-gray-200 bg-white p-6">
          <h3 className="text-sm font-semibold text-gray-900">
            ê²€ìƒ‰ ê²°ê³¼ ({filteredSearchResults.length}ê°œ)
          </h3>

          {isSearching ? (
            <div className="py-8 text-center text-sm text-gray-800">
              ê²€ìƒ‰ ì¤‘...
            </div>
          ) : filteredSearchResults.length > 0 ? (
            <div className="space-y-2">
              {filteredSearchResults.map((result) => (
                <div
                  key={result.id}
                  className="flex items-start justify-between rounded-lg border border-gray-200 bg-gray-50 p-4"
                >
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <h4 className="font-semibold text-gray-900">
                        {result.title}
                      </h4>
                      <span
                        className={cn(
                          "rounded-full px-2 py-0.5 text-xs font-medium",
                          result.content_type === "book"
                            ? "bg-blue-100 text-blue-800"
                            : "bg-purple-100 text-purple-700"
                        )}
                      >
                        {result.content_type === "book" ? "ğŸ“š êµì¬" : "ğŸ§ ê°•ì˜"}
                      </span>
                    </div>
                    <div className="flex flex-wrap gap-2 text-xs text-gray-800">
                      {result.publisher_or_academy && (
                        <span>{result.publisher_or_academy}</span>
                      )}
                      {result.subject && <span>Â· {result.subject}</span>}
                      {result.revision && <span>Â· {result.revision}</span>}
                      {result.total_pages && (
                        <span>Â· {result.total_pages}í˜ì´ì§€</span>
                      )}
                      {result.total_episodes && (
                        <span>Â· {result.total_episodes}íšŒì°¨</span>
                      )}
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => handleMasterContentSelect(result)}
                    disabled={
                      !editable ||
                      maxReached ||
                      selectedMasterIds.has(result.id)
                    }
                    className={cn(
                      "rounded-lg px-3 py-1.5 text-sm font-medium text-white transition-colors",
                      maxReached || selectedMasterIds.has(result.id)
                        ? "cursor-not-allowed bg-gray-400"
                        : "bg-indigo-600 hover:bg-indigo-700"
                    )}
                  >
                    {selectedMasterIds.has(result.id) ? "ì¶”ê°€ë¨" : "ì¶”ê°€"}
                  </button>
                </div>
              ))}
            </div>
          ) : (
            <div className="py-8 text-center text-sm text-gray-800">
              ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          )}
        </div>
      )}

      {/* ì¶”ê°€ëœ ë§ˆìŠ¤í„° ì½˜í…ì¸  ëª©ë¡ */}
      {masterContentsAdded.length > 0 && (
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold text-gray-900">
              ì¶”ê°€ëœ ë§ˆìŠ¤í„° ì½˜í…ì¸ 
            </h3>
            <span className="text-sm text-gray-800">
              {masterContentsAdded.length}ê°œ
            </span>
          </div>
          <div className="space-y-3">
            {masterContentsAdded.map((content) => {
              const masterId = (content as any).master_content_id;
              return (
                <ContentCard
                  key={masterId || content.content_id}
                  content={{
                    id: content.content_id,
                    title: content.title || "ì œëª© ì—†ìŒ",
                    subject: content.subject_category || undefined,
                  }}
                  selected={true}
                  readOnly={!editable}
                  range={{
                    start: String(content.start_range),
                    end: String(content.end_range),
                    start_detail_id: content.start_detail_id,
                    end_detail_id: content.end_detail_id,
                  }}
                  onRemove={() => handleContentRemove(content.content_id)}
                  onEditRange={() => handleEditRange(content)}
                />
              );
            })}
          </div>
        </div>
      )}

      {/* ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ */}
      {rangeModalContent && (
        <RangeSettingModal
          open={rangeModalOpen}
          onClose={() => {
            setRangeModalOpen(false);
            setRangeModalContent(null);
          }}
          content={{
            id: rangeModalContent.id,
            type: rangeModalContent.type,
            title: rangeModalContent.title,
          }}
          isRecommendedContent={true} // ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” ë§ˆìŠ¤í„° API ì‚¬ìš©
          currentRange={rangeModalContent.currentRange}
          onSave={handleRangeSave}
        />
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/_shared/RangeSettingModal.tsx">
"use client";

import React, { useState, useEffect, useRef, useMemo, useCallback } from "react";
import { RangeSettingModalProps, ContentDetail } from "@/lib/types/content-selection";
import { ContentRangeInput } from "./ContentRangeInput";
import { cn } from "@/lib/cn";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { validateRangeInput } from "@/lib/utils/rangeValidation";

/**
 * RangeSettingModal - ì½˜í…ì¸  ë²”ìœ„ ì„¤ì • ëª¨ë‹¬
 * 
 * - APIë¡œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
 * - ì‹œì‘/ë ë²”ìœ„ ì„ íƒ
 * - ê²€ì¦ ë° ì €ì¥
 */
export function RangeSettingModal({
  open,
  onClose,
  content,
  isRecommendedContent = false,
  currentRange,
  onSave,
  loading: externalLoading = false,
  error: externalError = null,
}: RangeSettingModalProps) {
  const [details, setDetails] = useState<ContentDetail[]>([]);
  const [startDetailId, setStartDetailId] = useState<string | null>(
    currentRange?.start_detail_id || null
  );
  const [endDetailId, setEndDetailId] = useState<string | null>(
    currentRange?.end_detail_id || null
  );
  // ì§ì ‘ ì…ë ¥ ê°’ (ìƒì„¸ ì •ë³´ê°€ ì—†ì„ ë•Œ) - ë¹ˆ ë¬¸ìì—´ë„ í—ˆìš©
  const [startRange, setStartRange] = useState<string | null>(
    currentRange?.start ? currentRange.start.replace(/[^\d]/g, "") : null
  );
  const [endRange, setEndRange] = useState<string | null>(
    currentRange?.end ? currentRange.end.replace(/[^\d]/g, "") : null
  );
  // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨
  const [totalPages, setTotalPages] = useState<number | null>(null);
  const [totalEpisodes, setTotalEpisodes] = useState<number | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hasChanges, setHasChanges] = useState(false);

  // ìºì‹œ ì°¸ì¡° (ì´ëŸ‰ ì •ë³´ë„ í•¨ê»˜ ì €ì¥)
  const cacheRef = useRef<Map<string, {
    details: ContentDetail[];
    totalPages?: number | null;
    totalEpisodes?: number | null;
  }>>(new Map());
  // ì¤‘ë³µ ë¡œê·¸ ë°©ì§€ë¥¼ ìœ„í•œ ref
  const hasLoggedNoDetails = useRef(false);
  // í¬ì»¤ìŠ¤ ìƒíƒœ ì¶”ì 
  const focusStateRef = useRef<{
    lastFocusedElement: HTMLElement | null;
    isInputFocused: boolean;
  }>({
    lastFocusedElement: null,
    isInputFocused: false,
  });

  // ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ (í†µí•©)
  const resetState = useCallback(() => {
    setStartDetailId(null);
    setEndDetailId(null);
    setStartRange(null);
    setEndRange(null);
    setTotalPages(null);
    setTotalEpisodes(null);
    setError(null);
    setHasChanges(false);
    hasLoggedNoDetails.current = false;
    focusStateRef.current = {
      lastFocusedElement: null,
      isInputFocused: false,
    };
  }, []);

  // ëª¨ë‹¬ì´ ë‹«í˜”ì„ ë•Œ ìƒíƒœ ì´ˆê¸°í™”
  useEffect(() => {
    if (!open) {
      resetState();
      return;
    }

    const fetchDetails = async () => {
      // custom íƒ€ì…ì€ ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ (ë°©ì–´ ì½”ë“œ)
      if ((content.type as string) === "custom") {
        const errorMessage = `[RangeSettingModal] custom íƒ€ì… ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. contentId: ${content.id}, title: ${content.title}`;
        console.error(errorMessage);
        setError("ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        setLoading(false);
        return;
      }

      // ìºì‹œ í™•ì¸
      const cached = cacheRef.current.get(content.id);
      if (cached) {
        setDetails(cached.details);
        if (content.type === "book") {
          setTotalPages(cached.totalPages ?? null);
        } else {
          setTotalEpisodes(cached.totalEpisodes ?? null);
        }
        return;
      }

      setLoading(true);
      setError(null);

      try {
        // ì¶”ì²œ ì½˜í…ì¸ ëŠ” ë§ˆìŠ¤í„° API, í•™ìƒ ì½˜í…ì¸ ëŠ” í•™ìƒ API í˜¸ì¶œ
        const apiPath = isRecommendedContent
          ? "/api/master-content-details"
          : "/api/student-content-details";

      // URL íŒŒë¼ë¯¸í„° ì•ˆì „í•˜ê²Œ ìƒì„±
      const params = new URLSearchParams({
        contentType: content.type,
        contentId: content.id,
      });
      const url = `${apiPath}?${params.toString()}`;

        const response = await fetch(url);

        // ì‘ë‹µ ì²˜ë¦¬ ë‹¨ìˆœí™”: .json() ì§ì ‘ ì‚¬ìš©
        let responseData: any;
        try {
          responseData = await response.json();
        } catch (e) {
          if (process.env.NODE_ENV === "development") {
            console.error("[RangeSettingModal] ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:", {
              status: response.status,
              statusText: response.statusText,
              url,
              error: e,
            });
          }
          throw new Error(
            response.status >= 500
              ? "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
              : "ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
        }

        // HTTP ìƒíƒœ ì½”ë“œ ì²´í¬
        if (!response.ok) {
          const errorMessage = 
            responseData?.error?.message || 
            responseData?.message ||
            (response.status >= 500
              ? "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
              : `ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${response.status})`);
          
          if (process.env.NODE_ENV === "development") {
            console.error(`[RangeSettingModal] API í˜¸ì¶œ ì‹¤íŒ¨: ${apiPath}`, {
              status: response.status,
              statusText: response.statusText,
              contentType: content.type,
              contentId: content.id,
              isRecommendedContent,
              url,
              responseData,
            });
          }
          throw new Error(errorMessage);
        }
        
        // API ì‘ë‹µ í˜•ì‹ ì²´í¬ (success í•„ë“œ)
        if (responseData && typeof responseData === 'object' && 'success' in responseData) {
          if (!responseData.success) {
            const errorMessage = 
              responseData.error?.message || 
              responseData.error?.code ||
              "ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            
            if (process.env.NODE_ENV === "development") {
              console.error(`[RangeSettingModal] API ì‘ë‹µ ì‹¤íŒ¨: ${apiPath}`, {
                contentType: content.type,
                contentId: content.id,
                isRecommendedContent,
                url,
                error: responseData.error || {},
                responseData,
              });
            }
            throw new Error(errorMessage);
          }
        }

        // ì½˜í…ì¸  íƒ€ì…ì— ë”°ë¼ details ë˜ëŠ” episodes ì‚¬ìš©
        const detailsData = 
          content.type === "book" 
            ? responseData.data.details || []
            : responseData.data.episodes || [];
        
        // ìƒì„¸ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ë¡œê¹… (ê°œë°œ í™˜ê²½ì—ì„œë§Œ, í•œ ë²ˆë§Œ)
        if (detailsData.length === 0) {
          if (process.env.NODE_ENV === "development" && !hasLoggedNoDetails.current) {
            hasLoggedNoDetails.current = true;
            console.debug("[RangeSettingModal] ìƒì„¸ì •ë³´ ì—†ìŒ (ì •ìƒ):", {
              type: "NO_DETAILS",
              contentType: content.type,
              contentId: content.id,
              title: content.title,
              isRecommendedContent,
              reason: "í•´ë‹¹ ì½˜í…ì¸ ì— ëª©ì°¨/íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ë²”ìœ„ë¥¼ ì§ì ‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.",
              apiPath: isRecommendedContent
                ? "/api/master-content-details"
                : "/api/student-content-details",
            });
          }
        } else {
          // ìƒì„¸ì •ë³´ê°€ ìˆìœ¼ë©´ ë¡œê·¸ í”Œë˜ê·¸ ë¦¬ì…‹ (ë‹¤ìŒì— ë‹¤ì‹œ ì—†ì„ ë•Œ ë¡œê·¸ ì¶œë ¥ ê°€ëŠ¥)
          hasLoggedNoDetails.current = false;
        }
        
        setDetails(detailsData);
        
        // ì´ëŸ‰ ì •ë³´ë¥¼ ìƒì„¸ ì •ë³´ API ì‘ë‹µì—ì„œ ì§ì ‘ ì‚¬ìš©
        const totalPagesValue = content.type === "book" 
          ? (responseData.data.total_pages || null)
          : null;
        const totalEpisodesValue = content.type === "lecture"
          ? (responseData.data.total_episodes || null)
          : null;

        if (content.type === "book") {
          setTotalPages(totalPagesValue);
        } else {
          setTotalEpisodes(totalEpisodesValue);
        }

        // ìºì‹œ ì €ì¥ (ì´ëŸ‰ ì •ë³´ë„ í•¨ê»˜ ì €ì¥)
        cacheRef.current.set(content.id, {
          details: detailsData,
          totalPages: totalPagesValue,
          totalEpisodes: totalEpisodesValue,
        });
      } catch (err) {
        const errorMessage = err instanceof Error
          ? err.message
          : "ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        
        // ì—ëŸ¬ íƒ€ì…ë³„ ìƒì„¸ ë¡œê¹…
        const errorDetails: Record<string, unknown> = {
          type: "API_ERROR",
          contentType: content.type,
          contentId: content.id,
          title: content.title,
          isRecommendedContent,
          apiPath: isRecommendedContent
            ? "/api/master-content-details"
            : "/api/student-content-details",
        };

        if (err instanceof Error) {
          errorDetails.errorMessage = err.message;
          errorDetails.errorStack = err.stack;
          errorDetails.errorName = err.name;
        } else {
          errorDetails.error = String(err);
        }

        if (process.env.NODE_ENV === "development") {
          console.error(
            "[RangeSettingModal] ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:",
            errorDetails
          );
        }
        
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    fetchDetails();
  }, [open, content.id, content.type, isRecommendedContent]);

  // í˜„ì¬ ë²”ìœ„ë¡œ ì´ˆê¸°í™” (ëª¨ë‹¬ì´ ì—´ë¦¬ê³  currentRangeê°€ ë³€ê²½ë  ë•Œë§Œ)
  useEffect(() => {
    if (open && currentRange) {
      setStartDetailId(currentRange.start_detail_id || null);
      setEndDetailId(currentRange.end_detail_id || null);
      
      // ì§ì ‘ ì…ë ¥ ê°’ ì´ˆê¸°í™” (ìƒì„¸ ì •ë³´ê°€ ì—†ì„ ë•Œ)
      if (!currentRange.start_detail_id && !currentRange.end_detail_id) {
        const startMatch = currentRange.start?.match(/\d+/);
        const endMatch = currentRange.end?.match(/\d+/);
        // ë¹ˆ ê°’ë„ í—ˆìš© (ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒ€ì²´í•˜ì§€ ì•ŠìŒ)
        setStartRange(startMatch ? startMatch[0] : "");
        setEndRange(endMatch ? endMatch[0] : "");
      } else {
        setStartRange(null);
        setEndRange(null);
      }
      
      setHasChanges(false);
    }
  }, [open, currentRange]);

  // ë³€ê²½ ê°ì§€
  useEffect(() => {
    const hasDetails = details.length > 0;
    let changed = false;
    
    if (hasDetails) {
      // ìƒì„¸ ì •ë³´ê°€ ìˆì„ ë•Œ
      changed =
        startDetailId !== (currentRange?.start_detail_id || null) ||
        endDetailId !== (currentRange?.end_detail_id || null);
    } else {
      // ìƒì„¸ ì •ë³´ê°€ ì—†ì„ ë•Œ (ì§ì ‘ ì…ë ¥)
      const currentStart = currentRange?.start ? currentRange.start.replace(/[^\d]/g, "") : "";
      const currentEnd = currentRange?.end ? currentRange.end.replace(/[^\d]/g, "") : "";
      // ë¹ˆ ê°’ë„ ë¹„êµì— í¬í•¨ (ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒ€ì²´í•˜ì§€ ì•ŠìŒ)
      changed =
        (startRange ?? "") !== currentStart ||
        (endRange ?? "") !== currentEnd;
    }
    
    setHasChanges(changed);
  }, [startDetailId, endDetailId, startRange, endRange, currentRange, details.length]);

  // ì €ì¥ ì²˜ë¦¬
  const handleSave = useCallback(() => {
    const hasDetails = details.length > 0;

    if (hasDetails) {
      // ìƒì„¸ ì •ë³´ê°€ ìˆì„ ë•Œ
      if (!startDetailId || !endDetailId) {
        setError("ì‹œì‘ê³¼ ì¢…ë£Œ ë²”ìœ„ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const startDetail = details.find((d) => d.id === startDetailId);
      const endDetail = details.find((d) => d.id === endDetailId);

      if (!startDetail || !endDetail) {
        setError("ì„ íƒí•œ ë²”ìœ„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // ë²”ìœ„ ë¬¸ìì—´ ìƒì„±
      const startStr =
        content.type === "book"
          ? `p.${(startDetail as any).page_number}`
          : `${(startDetail as any).episode_number}ê°•`;
      const endStr =
        content.type === "book"
          ? `p.${(endDetail as any).page_number}`
          : `${(endDetail as any).episode_number}ê°•`;

      onSave({
        start: startStr,
        end: endStr,
        start_detail_id: startDetailId,
        end_detail_id: endDetailId,
      });
    } else {
      // ìƒì„¸ ì •ë³´ê°€ ì—†ì„ ë•Œ (ì§ì ‘ ì…ë ¥)
      const maxValue = content.type === "book" ? totalPages : totalEpisodes;
      const validation = validateRangeInput(
        startRange,
        endRange,
        maxValue,
        content.type
      );

      if (!validation.valid) {
        setError(validation.error || "ìœ íš¨í•˜ì§€ ì•Šì€ ë²”ìœ„ì…ë‹ˆë‹¤.");
        return;
      }

      // ë²”ìœ„ ë¬¸ìì—´ ìƒì„±
      const startStr = content.type === "book" ? `p.${validation.startNum!}` : `${validation.startNum!}ê°•`;
      const endStr = content.type === "book" ? `p.${validation.endNum!}` : `${validation.endNum!}ê°•`;

      onSave({
        start: startStr,
        end: endStr,
        start_detail_id: null,
        end_detail_id: null,
      });
    }

    onClose();
  }, [details, startDetailId, endDetailId, startRange, endRange, totalPages, totalEpisodes, content.type, onSave, onClose]);

  // ëª¨ë‹¬ ë‹«ê¸°
  const handleClose = useCallback(() => {
    if (hasChanges) {
      if (
        !confirm(
          "ë³€ê²½ ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?"
        )
      ) {
        return;
      }
    }
    
    // ìƒíƒœ ì´ˆê¸°í™” (í†µí•© í•¨ìˆ˜ ì‚¬ìš©)
    resetState();
    
    onClose();
  }, [hasChanges, onClose, resetState]);

  const hasDetails = details.length > 0;
  const isValid = useMemo(() => {
    if (hasDetails) {
      return startDetailId && endDetailId;
    }
    return startRange && startRange.trim() !== "" && 
      endRange && endRange.trim() !== "" && 
      Number(startRange) > 0 && 
      Number(endRange) > 0 && 
      Number(startRange) <= Number(endRange);
  }, [hasDetails, startDetailId, endDetailId, startRange, endRange]);
  const isSaving = externalLoading;

  return (
    <Dialog
      open={open}
      onOpenChange={(newOpen) => {
        if (!newOpen) {
          handleClose();
        }
      }}
      title="ë²”ìœ„ ì„¤ì •"
      description={content.title}
      maxWidth="2xl"
    >
      <DialogContent className="max-h-[60vh] overflow-y-auto">
            {externalError ? (
              <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800">
                {externalError}
              </div>
            ) : (
              <ContentRangeInput
                type={content.type}
                details={details}
                startDetailId={startDetailId}
                endDetailId={endDetailId}
                startRange={startRange}
                endRange={endRange}
                totalPages={totalPages}
                totalEpisodes={totalEpisodes}
                onStartChange={setStartDetailId}
                onEndChange={setEndDetailId}
                onStartRangeChange={setStartRange}
                onEndRangeChange={setEndRange}
                loading={loading}
                error={error}
              />
            )}
      </DialogContent>
      <DialogFooter>
        <button
          type="button"
          onClick={handleClose}
          disabled={isSaving}
          className={cn(
            "rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-800 transition-colors hover:bg-gray-50",
            isSaving && "cursor-not-allowed opacity-50"
          )}
        >
          ì·¨ì†Œ
        </button>
        <button
          type="button"
          onClick={handleSave}
          disabled={!isValid || isSaving || !!error}
          className={cn(
            "rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-700",
            (!isValid || isSaving || !!error) &&
              "cursor-not-allowed opacity-50"
          )}
        >
          {isSaving ? (
            <span className="flex items-center gap-2">
              <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
              ì €ì¥ ì¤‘...
            </span>
          ) : (
            "ì €ì¥"
          )}
        </button>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="new-group/_components/_shared/RecommendedContentsPanel.tsx">
"use client";

import React, { useState, useCallback, useMemo, useRef } from "react";
import {
  RecommendedContentsPanelProps,
  SelectedContent,
  RecommendedContent,
  ContentRange,
} from "@/lib/types/content-selection";
import { ContentCard } from "./ContentCard";
import { RangeSettingModal } from "./RangeSettingModal";
import { Sparkles, AlertCircle, CheckCircle } from "lucide-react";
import { cn } from "@/lib/cn";

/**
 * RecommendedContentsPanel - ì¶”ì²œ ì½˜í…ì¸  ì„ íƒ íŒ¨ë„
 *
 * Phase 3.4ì—ì„œ êµ¬í˜„
 * Step4RecommendedContents.tsxì˜ ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ êµ¬í˜„
 */
export function RecommendedContentsPanel({
  recommendedContents,
  allRecommendedContents,
  selectedContents,
  selectedRecommendedIds,
  maxContents,
  currentTotal,
  settings,
  onSettingsChange,
  onUpdate,
  onRequestRecommendations,
  isEditMode = false,
  isCampMode = false,
  loading = false,
  hasRequestedRecommendations = false,
  hasScoreData = false,
  studentId,
  isAdminContinueMode = false,
  editable = true,
}: RecommendedContentsPanelProps) {
  // ë²”ìœ„ ì„¤ì • ëª¨ë‹¬
  const [rangeModalOpen, setRangeModalOpen] = useState(false);
  const [rangeModalContent, setRangeModalContent] = useState<{
    id: string;
    type: "book" | "lecture";
    title: string;
    recommendedContent?: RecommendedContent;
    currentRange?: ContentRange;
  } | null>(null);

  // ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬
  const maxReached = currentTotal >= maxContents;
  const canAddMore = !maxReached;
  const remaining = maxContents - currentTotal;

  // ì¶”ì²œ ë°›ê¸° ê°€ëŠ¥ ì—¬ë¶€
  const canRequestRecommendations = useMemo(() => {
    return (
      settings.selectedSubjects.size > 0 &&
      Array.from(settings.selectedSubjects).every(
        (subject) => (settings.recommendationCounts.get(subject) || 0) > 0
      )
    );
  }, [settings]);

  // ê³¼ëª© ì„ íƒ í† ê¸€
  const handleSubjectToggle = useCallback(
    (subject: string) => {
      if (!editable) return;
      const newSubjects = new Set(settings.selectedSubjects);
      if (newSubjects.has(subject)) {
        newSubjects.delete(subject);
        const newCounts = new Map(settings.recommendationCounts);
        newCounts.delete(subject);
        onSettingsChange({
          ...settings,
          selectedSubjects: newSubjects,
          recommendationCounts: newCounts,
        });
      } else {
        newSubjects.add(subject);
        const newCounts = new Map(settings.recommendationCounts);
        newCounts.set(subject, 1); // ê¸°ë³¸ê°’ 1ê°œ
        onSettingsChange({
          ...settings,
          selectedSubjects: newSubjects,
          recommendationCounts: newCounts,
        });
      }
    },
    [settings, onSettingsChange]
  );

  // ì¶”ì²œ ê°œìˆ˜ ë³€ê²½
  const handleCountChange = useCallback(
    (subject: string, count: number) => {
      if (!editable) return;
      const newCounts = new Map(settings.recommendationCounts);
      newCounts.set(subject, Math.max(1, Math.min(5, count)));
      onSettingsChange({
        ...settings,
        recommendationCounts: newCounts,
      });
    },
    [settings, onSettingsChange]
  );

  // ì¶”ì²œ ì½˜í…ì¸  ì„ íƒ
  const handleRecommendedSelect = useCallback(
    (content: RecommendedContent) => {
      if (!editable) return;
      if (!canAddMore) {
        alert(`í”Œëœ ëŒ€ìƒ ì½˜í…ì¸ ëŠ” ìµœëŒ€ ${maxContents}ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        return;
      }

      // contentType ê²€ì¦ (ì„œë²„ì—ì„œ ë³´ì¥ë˜ì§€ë§Œ ë°©ì–´ ì½”ë“œ)
      if (!content.contentType) {
        const errorMessage = `[RecommendedContentsPanel] contentTypeì´ ì—†ìŠµë‹ˆë‹¤. contentId: ${content.id}, title: ${content.title}`;
        console.error(errorMessage, {
          content,
          allKeys: Object.keys(content),
          contentType: content.contentType,
          content_type: (content as any).content_type,
        });
        alert("ì½˜í…ì¸  íƒ€ì… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
        return;
      }

      const contentType = content.contentType;

      // custom íƒ€ì…ì€ ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ (ë°©ì–´ ì½”ë“œ)
      if ((contentType as string) === "custom") {
        const errorMessage = `[RecommendedContentsPanel] custom íƒ€ì… ì¶”ì²œ ì½˜í…ì¸ ëŠ” ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. contentId: ${content.id}, title: ${content.title}, contentType: ${contentType}`;
        console.error(errorMessage, { content });
        return;
      }

      // íƒ€ì… ê²€ì¦
      if (contentType !== "book" && contentType !== "lecture") {
        const errorMessage = `[RecommendedContentsPanel] ì˜ëª»ëœ contentTypeì…ë‹ˆë‹¤. contentId: ${content.id}, contentType: ${contentType}`;
        console.error(errorMessage, { content });
        alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸  íƒ€ì…ì…ë‹ˆë‹¤.");
        return;
      }

      // ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
      const modalContent = {
        id: content.id,
        type: contentType as "book" | "lecture",
        title: content.title,
        recommendedContent: content,
      };

      console.log("[RecommendedContentsPanel] ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°:", {
        modalContent,
        originalContent: content,
      });

      setRangeModalContent(modalContent);
      setRangeModalOpen(true);
    },
    [canAddMore, maxContents, editable]
  );

  // ì¶”ì²œ ì½˜í…ì¸  ì‚­ì œ
  const handleRecommendedRemove = useCallback(
    (contentId: string) => {
      if (!editable) return;
      const updated = selectedContents.filter(
        (c) => c.content_id !== contentId
      );
      onUpdate(updated);
    },
    [selectedContents, onUpdate, editable]
  );

  // ë²”ìœ„ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
  const handleEditRange = useCallback(
    (content: SelectedContent) => {
      if (!editable) return;
      // custom íƒ€ì…ì€ ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ
      if (content.content_type === "custom") {
        const errorMessage = `[RecommendedContentsPanel] custom íƒ€ì… ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. contentId: ${content.content_id}, title: ${content.title}`;
        console.error(errorMessage, { content });
        alert("ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      // allRecommendedContentsì—ì„œ ì›ë³¸ ì •ë³´ ì°¾ê¸°
      const originalContent = allRecommendedContents.find(
        (c) => c.id === content.content_id
      );

      setRangeModalContent({
        id: content.content_id,
        type: content.content_type as "book" | "lecture",
        title: content.title || "ì œëª© ì—†ìŒ",
        recommendedContent: originalContent,
        currentRange: {
          start: String(content.start_range),
          end: String(content.end_range),
          start_detail_id: content.start_detail_id,
          end_detail_id: content.end_detail_id,
        },
      });
      setRangeModalOpen(true);
    },
    [allRecommendedContents, editable]
  );

  // ë²”ìœ„ ì €ì¥
  const handleRangeSave = useCallback(
    (range: ContentRange) => {
      if (!editable) return;
      if (!rangeModalContent) return;

      const { id, type, title, recommendedContent } = rangeModalContent;

      // ê¸°ì¡´ ì½˜í…ì¸  ì°¾ê¸°
      const existingIndex = selectedContents.findIndex(
        (c) => c.content_id === id
      );

      const newContent: SelectedContent = {
        content_type: type,
        content_id: id,
        start_range: Number(range.start.replace(/[^\d]/g, "")),
        end_range: Number(range.end.replace(/[^\d]/g, "")),
        start_detail_id: range.start_detail_id,
        end_detail_id: range.end_detail_id,
        title,
        subject_category: recommendedContent?.subject_category || undefined,
        master_content_id: id, // ì¶”ì²œ ì½˜í…ì¸ ëŠ” í•­ìƒ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID
        is_auto_recommended: false, // ìˆ˜ë™ ì„ íƒ í”Œë˜ê·¸
      };

      let updated: SelectedContent[];
      if (existingIndex >= 0) {
        // ê¸°ì¡´ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
        updated = [...selectedContents];
        updated[existingIndex] = newContent;
      } else {
        // ìƒˆ ì½˜í…ì¸  ì¶”ê°€
        updated = [...selectedContents, newContent];
      }

      onUpdate(updated);
      setRangeModalOpen(false);
      setRangeModalContent(null);
    },
    [rangeModalContent, selectedContents, onUpdate, editable]
  );

  // ì¶”ì²œ ìš”ì²­ í¼ í‘œì‹œ ì¡°ê±´: ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” í•­ìƒ í‘œì‹œ, ê·¸ ì™¸ì—ëŠ” ì¶”ì²œì„ ë°›ê¸° ì „ì´ê±°ë‚˜, ì¶”ì²œì„ ë°›ì•˜ì§€ë§Œ ëª©ë¡ì´ ë¹„ì–´ìˆì„ ë•Œ
  const shouldShowRecommendationForm =
    isAdminContinueMode || // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” í•­ìƒ í‘œì‹œ
    (!isEditMode && !hasRequestedRecommendations) ||
    (hasRequestedRecommendations &&
      recommendedContents.length === 0 &&
      !loading);

  return (
    <div className="space-y-6">
      {/* ì¶”ì²œ ë°›ê¸° ì„¤ì • */}
      {shouldShowRecommendationForm && (
        <div className="rounded-xl border border-gray-200 bg-white p-6">
          <div className="flex items-center gap-2">
            <Sparkles className="h-5 w-5 text-blue-600" />
            <h3 className="text-lg font-semibold text-gray-900">
              AI ì¶”ì²œ ì½˜í…ì¸  ë°›ê¸°
            </h3>
          </div>

          {/* ì„±ì  ë°ì´í„° ì•ˆë‚´ */}
          {!hasScoreData && (
            <div className="flex items-start gap-2 rounded-lg bg-yellow-50 p-3">
              <AlertCircle className="h-5 w-5 flex-shrink-0 text-yellow-600" />
              <div className="flex flex-col gap-0.5 text-sm text-yellow-800">
                <p className="font-medium">ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <p>
                  ì„±ì ì„ ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
              </div>
            </div>
          )}

          {/* ê³¼ëª© ì„ íƒ */}
          <div className="flex flex-col gap-2">
            <label className="block text-sm font-medium text-gray-800">
              ì¶”ì²œë°›ì„ ê³¼ëª© ì„ íƒ
            </label>
            <div className="flex flex-wrap gap-2">
              {["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ê³¼í•™", "ì‚¬íšŒ"].map((subject) => (
                <button
                  key={subject}
                  type="button"
                  onClick={() => handleSubjectToggle(subject)}
                  className={cn(
                    "rounded-lg border-2 px-4 py-2 text-sm font-medium transition-colors",
                    settings.selectedSubjects.has(subject)
                      ? "border-blue-500 bg-blue-50 text-blue-800"
                      : "border-gray-300 bg-white text-gray-800 hover:border-gray-400"
                  )}
                >
                  {subject}
                </button>
              ))}
            </div>
          </div>

          {/* ê³¼ëª©ë³„ ì¶”ì²œ ê°œìˆ˜ */}
          {settings.selectedSubjects.size > 0 && (
            <div className="flex flex-col gap-3">
              <label className="block text-sm font-medium text-gray-800">
                ê³¼ëª©ë³„ ì¶”ì²œ ê°œìˆ˜
              </label>
              {Array.from(settings.selectedSubjects).map((subject) => (
                <div key={subject} className="flex items-center gap-3">
                  <span className="w-16 text-sm font-medium text-gray-800">
                    {subject}
                  </span>
                  <input
                    type="number"
                    min="1"
                    max="5"
                    value={settings.recommendationCounts.get(subject) || 1}
                    onChange={(e) =>
                      handleCountChange(subject, Number(e.target.value))
                    }
                    className="w-20 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900"
                  />
                  <span className="text-sm text-gray-600">ê°œ</span>
                </div>
              ))}
            </div>
          )}

          {/* ìë™ ë°°ì • ì˜µì…˜ */}
          <div className="flex flex-col gap-1">
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={settings.autoAssignContents}
                onChange={(e) =>
                  onSettingsChange({
                    ...settings,
                    autoAssignContents: e.target.checked,
                  })
                }
                className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span className="text-sm font-medium text-gray-800">
                ì¶”ì²œ ì½˜í…ì¸  ìë™ ë°°ì • (ì „ì²´ ë²”ìœ„)
              </span>
            </label>
            <p className="pl-6 text-xs text-gray-600">
              ì²´í¬í•˜ë©´ ì¶”ì²œë°›ì€ ì½˜í…ì¸ ê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ (ë²”ìœ„: ì „ì²´)
            </p>
          </div>

          {/* ì¶”ì²œ ë°›ê¸° ë²„íŠ¼ */}
          <button
            type="button"
            onClick={() => {
              if (!editable) return;
              onRequestRecommendations();
            }}
            disabled={!editable || !canRequestRecommendations || loading || maxReached}
            className={cn(
              "w-full rounded-lg bg-blue-600 py-3 text-sm font-medium text-white transition-colors hover:bg-blue-700",
              (!editable || !canRequestRecommendations || loading || maxReached) &&
                "cursor-not-allowed opacity-50"
            )}
          >
            {loading ? (
              <span className="flex items-center justify-center gap-2">
                <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
                ì¶”ì²œ ë¶„ì„ ì¤‘...
              </span>
            ) : (
              <span className="flex items-center justify-center gap-2">
                <Sparkles className="h-4 w-4" />
                ì¶”ì²œ ë°›ê¸°
              </span>
            )}
          </button>
        </div>
      )}

      {/* ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ */}
      {hasRequestedRecommendations && recommendedContents.length > 0 && (
        <div className="rounded-xl border border-gray-200 bg-white p-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Sparkles className="h-5 w-5 text-blue-600" />
              <h3 className="text-lg font-semibold text-gray-900">
                ì¶”ì²œ ì½˜í…ì¸ 
              </h3>
            </div>
            <span className="text-sm text-gray-600">
              {recommendedContents.length}ê°œ
            </span>
          </div>

          <div className="flex flex-col gap-3">
            {recommendedContents.map((content) => (
              <ContentCard
                key={content.id}
                content={{
                  id: content.id,
                  title: content.title,
                  subject: content.subject,
                  semester: content.semester,
                  difficulty: content.difficulty_level,
                  publisher: content.publisher,
                  platform: content.platform,
                }}
                selected={false}
                recommended={{
                  priority: content.priority,
                  reason: content.reason,
                  scoreDetails: content.scoreDetails,
                }}
                onToggle={() => handleRecommendedSelect(content)}
                disabled={maxReached}
              />
            ))}
          </div>
        </div>
      )}

      {/* ì¶”ì²œ ì½˜í…ì¸  ì—†ìŒ */}
      {hasRequestedRecommendations && recommendedContents.length === 0 && (
        <div className="flex flex-col gap-1 rounded-xl border border-gray-200 bg-white p-12 text-center">
          <CheckCircle className="mx-auto h-12 w-12 text-green-500" />
          <p className="text-sm font-medium text-gray-900">
            ì¶”ì²œí•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤
          </p>
          <p className="text-sm text-gray-600">
            ì´ë¯¸ ëª¨ë“  ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ì…¨ê±°ë‚˜,
            <br />
            í˜„ì¬ ì¡°ê±´ì— ë§ëŠ” ì¶”ì²œì´ ì—†ìŠµë‹ˆë‹¤.
          </p>
        </div>
      )}

      {/* ì„ íƒëœ ì¶”ì²œ ì½˜í…ì¸  */}
      {selectedContents.length > 0 && (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold text-gray-900">
              ì„ íƒëœ ì¶”ì²œ ì½˜í…ì¸ 
            </h3>
            <span className="text-sm text-gray-600">
              {selectedContents.length}ê°œ
            </span>
          </div>
          <div className="space-y-3">
            {selectedContents.map((content, index) => {
              // allRecommendedContentsì—ì„œ ì°¾ì„ ë•Œ ë” ì •í™•í•œ ë§¤ì¹­
              // content_idë¡œ ë¨¼ì € ì°¾ê³ , ì—†ìœ¼ë©´ master_content_idë¡œ ì°¾ê¸°
              const originalContent = allRecommendedContents.find(
                (c) => c.id === content.content_id || 
                       (content.master_content_id && c.id === content.master_content_id)
              );

              return (
                <ContentCard
                  key={`${content.content_id}-${content.start_range}-${content.end_range}-${index}`}
                  content={{
                    id: content.content_id,
                    title: content.title || "ì œëª© ì—†ìŒ",
                    subject: originalContent?.subject,
                    semester: originalContent?.semester,
                    difficulty: originalContent?.difficulty_level,
                    publisher: originalContent?.publisher,
                    platform: originalContent?.platform,
                  }}
                  selected={true}
                  range={{
                    start: String(content.start_range),
                    end: String(content.end_range),
                    start_detail_id: content.start_detail_id,
                    end_detail_id: content.end_detail_id,
                  }}
                  recommended={
                    originalContent
                      ? {
                          priority: originalContent.priority,
                          reason: originalContent.reason,
                          scoreDetails: originalContent.scoreDetails,
                        }
                      : undefined
                  }
                  onRemove={() => handleRecommendedRemove(content.content_id)}
                  onEditRange={() => handleEditRange(content)}
                />
              );
            })}
          </div>
        </div>
      )}

      {/* ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ */}
      {rangeModalContent && (
        <RangeSettingModal
          open={rangeModalOpen}
          onClose={() => {
            setRangeModalOpen(false);
            setRangeModalContent(null);
          }}
          content={rangeModalContent}
          isRecommendedContent={true}
          currentRange={rangeModalContent.currentRange}
          onSave={handleRangeSave}
        />
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/_shared/StudentContentsPanel.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback, useRef } from "react";
import {
  StudentContentsPanelProps,
  SelectedContent,
  ContentMetadata,
  ContentRange,
} from "@/lib/types/content-selection";
import { ContentCard } from "./ContentCard";
import { ContentSelector } from "./ContentSelector";
import { RangeSettingModal } from "./RangeSettingModal";
import { fetchContentMetadataAction } from "@/app/(student)/actions/fetchContentMetadata";

/**
 * StudentContentsPanel - í•™ìƒ ì½˜í…ì¸  ì„ íƒ íŒ¨ë„
 * 
 * Phase 3.3ì—ì„œ êµ¬í˜„
 * Step3Contents.tsxì˜ ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ êµ¬í˜„
 */
export function StudentContentsPanel({
  contents,
  selectedContents,
  maxContents,
  currentTotal,
  onUpdate,
  editable = true,
  isCampMode = false,
}: StudentContentsPanelProps) {
  // ì„ íƒëœ ì½˜í…ì¸  ID ê´€ë¦¬
  const selectedIds = useMemo(() => {
    return new Set(selectedContents.map((c) => c.content_id));
  }, [selectedContents]);

  // ë©”íƒ€ë°ì´í„° ìºì‹œ
  const [metadataCache, setMetadataCache] = useState<Map<string, ContentMetadata>>(
    new Map()
  );

  // ë²”ìœ„ ì„¤ì • ëª¨ë‹¬
  const [rangeModalOpen, setRangeModalOpen] = useState(false);
  const [rangeModalContent, setRangeModalContent] = useState<{
    id: string;
    type: "book" | "lecture";
    title: string;
    currentRange?: ContentRange;
  } | null>(null);

  // ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬
  const maxReached = currentTotal >= maxContents;
  const canAddMore = !maxReached;

  // ì½˜í…ì¸  ì„ íƒ/í•´ì œ
  const handleContentSelect = useCallback(
    async (contentId: string, type: "book" | "lecture" | "custom") => {
      if (!editable) return;

      // ì´ë¯¸ ì„ íƒëœ ê²½ìš° ë¬´ì‹œ
      if (selectedIds.has(contentId)) return;

      // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
      if (maxReached) {
        alert(`í”Œëœ ëŒ€ìƒ ì½˜í…ì¸ ëŠ” ìµœëŒ€ ${maxContents}ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        return;
      }

      // ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ê¸°ë°˜ ì¤‘ë³µ ì²´í¬ (book, lectureë§Œ)
      if (type === "book" || type === "lecture") {
        const content =
          type === "book"
            ? contents.books.find((b) => b.id === contentId)
            : contents.lectures.find((l) => l.id === contentId);

        if (content?.master_content_id) {
          // ì´ë¯¸ ì„ íƒëœ ì½˜í…ì¸  ì¤‘ ê°™ì€ master_content_idë¥¼ ê°€ì§„ ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸
          const hasDuplicateMasterId = selectedContents.some(
            (c) => (c as any).master_content_id === content.master_content_id
          );

          if (hasDuplicateMasterId) {
            alert(
              "ê°™ì€ ë§ˆìŠ¤í„° ì½˜í…ì¸ ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì½˜í…ì¸ ê°€ ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            );
            return;
          }
        }
      }

      // ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì • ì—†ì´ ë°”ë¡œ ì¶”ê°€
      if (type === "custom") {
        const customContent = contents.custom.find((c) => c.id === contentId);
        if (!customContent) {
          console.error(`[StudentContentsPanel] custom ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. contentId: ${contentId}`);
          return;
        }

        // custom ì½˜í…ì¸ ëŠ” ê¸°ë³¸ ë²”ìœ„ ê°’ìœ¼ë¡œ ë°”ë¡œ ì¶”ê°€
        const newContent: SelectedContent = {
          content_type: "custom",
          content_id: contentId,
          start_range: 1,
          end_range: 1,
          title: customContent.title,
        };

        console.log(`[StudentContentsPanel] custom ì½˜í…ì¸  ì¶”ê°€: ${customContent.title} (${contentId})`);
        const updated = [...selectedContents, newContent];
        onUpdate(updated);
        return;
      }

      // ë©”íƒ€ë°ì´í„° ì¡°íšŒ (ì´ë¯¸ ìºì‹œì— ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
      let metadata = metadataCache.get(contentId);
      if (!metadata) {
        try {
          const result = await fetchContentMetadataAction(contentId, type);
          if (result.success && result.data) {
            metadata = result.data;
            setMetadataCache((prev) => new Map(prev).set(contentId, metadata!));
          }
        } catch (error) {
          console.error("[StudentContentsPanel] ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:", error);
        }
      }

      // ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
      const content =
        type === "book"
          ? contents.books.find((b) => b.id === contentId)
          : contents.lectures.find((l) => l.id === contentId);

      if (!content) return;

      setRangeModalContent({
        id: contentId,
        type,
        title: content.title,
      });
      setRangeModalOpen(true);
    },
    [
      contents,
      selectedIds,
      maxReached,
      maxContents,
      editable,
      metadataCache,
      selectedContents,
    ]
  );

  // ì½˜í…ì¸  ì‚­ì œ
  const handleContentRemove = useCallback(
    (contentId: string) => {
      if (!editable) return;

      const updated = selectedContents.filter((c) => c.content_id !== contentId);
      onUpdate(updated);
    },
    [selectedContents, onUpdate, editable]
  );

  // ë²”ìœ„ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
  const handleEditRange = useCallback(
    (content: SelectedContent) => {
      if (!editable) return;

      // custom íƒ€ì…ì€ ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ
      if (content.content_type === "custom") {
        const errorMessage = `[StudentContentsPanel] custom íƒ€ì… ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. contentId: ${content.content_id}, title: ${content.title}`;
        console.error(errorMessage, { content });
        alert("ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” ë²”ìœ„ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const contentInfo =
        content.content_type === "book"
          ? contents.books.find((b) => b.id === content.content_id)
          : contents.lectures.find((l) => l.id === content.content_id);

      setRangeModalContent({
        id: content.content_id,
        type: content.content_type,
        title: content.title || contentInfo?.title || "ì œëª© ì—†ìŒ",
        currentRange: {
          start: String(content.start_range),
          end: String(content.end_range),
          start_detail_id: content.start_detail_id,
          end_detail_id: content.end_detail_id,
        },
      });
      setRangeModalOpen(true);
    },
    [contents, editable]
  );

  // ë²”ìœ„ ì €ì¥
  const handleRangeSave = useCallback(
    (range: ContentRange) => {
      if (!rangeModalContent) return;

      const { id, type, title } = rangeModalContent;

      // ê¸°ì¡´ ì½˜í…ì¸  ì°¾ê¸°
      const existingIndex = selectedContents.findIndex(
        (c) => c.content_id === id
      );

      const metadata = metadataCache.get(id);

      const newContent: SelectedContent = {
        content_type: type,
        content_id: id,
        start_range: Number(range.start.replace(/[^\d]/g, "")),
        end_range: Number(range.end.replace(/[^\d]/g, "")),
        start_detail_id: range.start_detail_id,
        end_detail_id: range.end_detail_id,
        title,
        subject_category: metadata?.subject || undefined,
        master_content_id:
          type === "book"
            ? contents.books.find((b) => b.id === id)?.master_content_id
            : contents.lectures.find((l) => l.id === id)?.master_content_id,
      };

      let updated: SelectedContent[];
      if (existingIndex >= 0) {
        // ê¸°ì¡´ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
        updated = [...selectedContents];
        updated[existingIndex] = newContent;
      } else {
        // ìƒˆ ì½˜í…ì¸  ì¶”ê°€
        updated = [...selectedContents, newContent];
      }

      onUpdate(updated);
      setRangeModalOpen(false);
      setRangeModalContent(null);
    },
    [rangeModalContent, selectedContents, metadataCache, contents, onUpdate]
  );

  // ì½˜í…ì¸  ì¹´ë“œ ë Œë”ë§
  const renderContentCard = useCallback(
    (content: SelectedContent) => {
      const metadata = metadataCache.get(content.content_id);

      return (
        <ContentCard
          key={content.content_id}
          content={{
            id: content.content_id,
            title: content.title || "ì œëª© ì—†ìŒ",
            subject: metadata?.subject,
            semester: metadata?.semester,
            difficulty: metadata?.difficulty_level,
            publisher: metadata?.publisher,
            platform: metadata?.platform,
          }}
          selected={true}
          readOnly={!editable}
          range={{
            start: String(content.start_range),
            end: String(content.end_range),
            start_detail_id: content.start_detail_id,
            end_detail_id: content.end_detail_id,
          }}
          onRemove={() => handleContentRemove(content.content_id)}
          onEditRange={() => handleEditRange(content)}
        />
      );
    },
    [metadataCache, editable, handleContentRemove, handleEditRange]
  );

  return (
    <div className="space-y-6">
      {/* ì½˜í…ì¸  ì„ íƒê¸° */}
      {editable && (
        <ContentSelector
          books={contents.books}
          lectures={contents.lectures}
          custom={contents.custom}
          selectedIds={selectedIds}
          onSelect={handleContentSelect}
          disabled={!editable}
          maxReached={maxReached}
        />
      )}

      {/* ì„ íƒëœ ì½˜í…ì¸  ëª©ë¡ */}
      {selectedContents.length > 0 ? (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold text-gray-900">
              ì„ íƒëœ ì½˜í…ì¸ 
            </h3>
            <span className="text-sm text-gray-600">
              {selectedContents.length}ê°œ
            </span>
          </div>
          <div className="space-y-3">
            {selectedContents.map(renderContentCard)}
          </div>
        </div>
      ) : (
        <div className="rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-12 text-center">
          <p className="text-sm font-medium text-gray-900">
            ì„ íƒëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤
          </p>
          <p className="text-sm text-gray-500">
            ìœ„ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </p>
        </div>
      )}

      {/* ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ */}
      {rangeModalContent && (
        <RangeSettingModal
          open={rangeModalOpen}
          onClose={() => {
            setRangeModalOpen(false);
            setRangeModalContent(null);
          }}
          content={rangeModalContent}
          isRecommendedContent={false}
          currentRange={rangeModalContent.currentRange}
          onSave={handleRangeSave}
        />
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/_shared/UnifiedContentsView.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import { SelectedContent, RecommendedContent, ContentMetadata } from "@/lib/types/content-selection";
import { ContentCard } from "./ContentCard";
import { fetchContentMetadataAction } from "@/app/(student)/actions/fetchContentMetadata";

type UnifiedContentsViewProps = {
  studentContents: SelectedContent[];
  recommendedContents: SelectedContent[];
  contents: {
    books: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
    lectures: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
    custom: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
    }>;
  };
  allRecommendedContents?: RecommendedContent[];
  isCampMode?: boolean;
};

/**
 * UnifiedContentsView - ì½ê¸° ì „ìš© ëª¨ë“œìš© í†µí•© ì½˜í…ì¸  ë·°
 * 
 * í•™ìƒ ì½˜í…ì¸ ì™€ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ì„¹ì…˜ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
 */
export function UnifiedContentsView({
  studentContents,
  recommendedContents,
  contents,
  allRecommendedContents = [],
  isCampMode = false,
}: UnifiedContentsViewProps) {
  // ë©”íƒ€ë°ì´í„° ìºì‹œ
  const [metadataCache, setMetadataCache] = useState<Map<string, ContentMetadata>>(
    new Map()
  );

  // ëª¨ë“  ì½˜í…ì¸  ID ìˆ˜ì§‘
  const allContentIds = useMemo(() => {
    const ids = new Set<string>();
    studentContents.forEach((c) => ids.add(c.content_id));
    recommendedContents.forEach((c) => ids.add(c.content_id));
    return Array.from(ids);
  }, [studentContents, recommendedContents]);

  // ë©”íƒ€ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    const loadMetadata = async () => {
      if (allContentIds.length === 0) return;

      try {
        const metadataMap = new Map<string, ContentMetadata>();
        
        // ëª¨ë“  ì½˜í…ì¸ ì—ì„œ contentIdì™€ contentType ë§¤í•‘ ìƒì„±
        const contentTypeMap = new Map<string, "book" | "lecture">();
        [...studentContents, ...recommendedContents].forEach((content) => {
          if (content.content_type === "book" || content.content_type === "lecture") {
            contentTypeMap.set(content.content_id, content.content_type);
          }
        });
        
        // ê° ì½˜í…ì¸ ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ê°œë³„ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        await Promise.all(
          allContentIds.map(async (contentId) => {
            const contentType = contentTypeMap.get(contentId);
            // custom íƒ€ì…ì€ ë©”íƒ€ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ìŠ¤í‚µ
            if (!contentType) return;
            
            try {
              const result = await fetchContentMetadataAction(contentId, contentType);
              if (result.success && result.data) {
                metadataMap.set(contentId, result.data);
              }
            } catch (error) {
              console.error(`[UnifiedContentsView] ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (${contentId}):`, error);
            }
          })
        );

        setMetadataCache(metadataMap);
      } catch (error) {
        console.error("[UnifiedContentsView] ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
      }
    };

    loadMetadata();
  }, [allContentIds, studentContents, recommendedContents]);

  // í•™ìƒ ì½˜í…ì¸  ì¹´ë“œ ë Œë”ë§
  const renderStudentContentCard = useCallback(
    (content: SelectedContent) => {
      const metadata = metadataCache.get(content.content_id);

      return (
        <ContentCard
          key={content.content_id}
          content={{
            id: content.content_id,
            title: content.title || "ì œëª© ì—†ìŒ",
            subject: metadata?.subject || content.subject_category || undefined,
            semester: metadata?.semester,
            difficulty: metadata?.difficulty_level,
            publisher: metadata?.publisher,
            platform: metadata?.platform,
          }}
          selected={true}
          readOnly={true}
          range={{
            start: String(content.start_range),
            end: String(content.end_range),
            start_detail_id: content.start_detail_id,
            end_detail_id: content.end_detail_id,
          }}
        />
      );
    },
    [metadataCache]
  );

  // ì¶”ì²œ ì½˜í…ì¸  ì¹´ë“œ ë Œë”ë§
  const renderRecommendedContentCard = useCallback(
    (content: SelectedContent) => {
      const metadata = metadataCache.get(content.content_id);
      
      // allRecommendedContentsì—ì„œ ì›ë³¸ ì¶”ì²œ ì½˜í…ì¸  ì •ë³´ ì°¾ê¸°
      const originalContent = allRecommendedContents.find(
        (c) => c.id === content.content_id || 
               (content.master_content_id && c.id === content.master_content_id)
      );

      return (
        <ContentCard
          key={content.content_id}
          content={{
            id: content.content_id,
            title: content.title || "ì œëª© ì—†ìŒ",
            subject: originalContent?.subject || metadata?.subject || content.subject_category || undefined,
            semester: originalContent?.semester || metadata?.semester,
            difficulty: originalContent?.difficulty_level || metadata?.difficulty_level,
            publisher: originalContent?.publisher || metadata?.publisher,
            platform: originalContent?.platform || metadata?.platform,
          }}
          selected={true}
          readOnly={true}
          range={{
            start: String(content.start_range),
            end: String(content.end_range),
            start_detail_id: content.start_detail_id,
            end_detail_id: content.end_detail_id,
          }}
          recommended={
            originalContent
              ? {
                  priority: originalContent.priority,
                  reason: originalContent.reason,
                  scoreDetails: originalContent.scoreDetails,
                }
              : undefined
          }
        />
      );
    },
    [metadataCache, allRecommendedContents]
  );

  const hasStudentContents = studentContents.length > 0;
  const hasRecommendedContents = recommendedContents.length > 0;
  const hasAnyContents = hasStudentContents || hasRecommendedContents;

  return (
    <div className="space-y-6">
      {!hasAnyContents ? (
        <div className="rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-12 text-center">
          <p className="text-sm font-medium text-gray-900">
            ë“±ë¡ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤
          </p>
        </div>
      ) : (
        <>
          {/* í•™ìƒ ì½˜í…ì¸  ì„¹ì…˜ */}
          {hasStudentContents && (
            <div className="flex flex-col gap-3">
              <div className="flex items-center justify-between">
                <h3 className="text-sm font-semibold text-gray-900">
                  í•™ìƒ ì½˜í…ì¸ 
                </h3>
                <span className="text-xs text-gray-600">
                  {studentContents.length}ê°œ
                </span>
              </div>
              <div className="flex flex-col gap-3">
                {studentContents.map(renderStudentContentCard)}
              </div>
            </div>
          )}

          {/* ì¶”ì²œ ì½˜í…ì¸  ì„¹ì…˜ */}
          {hasRecommendedContents && (
            <div className="flex flex-col gap-3">
              <div className="flex items-center justify-between">
                <h3 className="text-sm font-semibold text-gray-900">
                  ì¶”ì²œ ì½˜í…ì¸ 
                </h3>
                <span className="text-xs text-gray-600">
                  {recommendedContents.length}ê°œ
                </span>
              </div>
              <div className="space-y-3">
                {recommendedContents.map(renderRecommendedContentCard)}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/_summary/BasicInfoSummary.tsx">
"use client";

import React, { useMemo } from "react";
import { Calendar, Target, Settings } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { SectionSummary } from "./SectionSummary";

/**
 * BasicInfoSummary - ê¸°ë³¸ ì •ë³´ ìš”ì•½
 * 
 * Phase 4.3ì—ì„œ êµ¬í˜„
 * Step 1ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ìš”ì•½í•˜ì—¬ í‘œì‹œ
 */

export type BasicInfoSummaryProps = {
  data: WizardData;
};

export const BasicInfoSummary = React.memo(function BasicInfoSummary({
  data,
}: BasicInfoSummaryProps) {
  // í•™ìŠµ ê¸°ê°„ ê³„ì‚°
  const periodDays = useMemo(() => {
    if (!data.period_start || !data.period_end) return 0;
    const start = new Date(data.period_start);
    const end = new Date(data.period_end);
    const diff = end.getTime() - start.getTime();
    return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
  }, [data.period_start, data.period_end]);

  // ë‚ ì§œ í¬ë§·
  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString("ko-KR", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  };

  // ëª©ì  í•œê¸€í™”
  const purposeLabel = {
    "ë‚´ì‹ ëŒ€ë¹„": "ë‚´ì‹  ëŒ€ë¹„",
    "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)": "ëª¨ì˜ê³ ì‚¬/ìˆ˜ëŠ¥ ëŒ€ë¹„",
    "": "ë¯¸ì„¤ì •",
  }[data.plan_purpose] || data.plan_purpose;

  // ìŠ¤ì¼€ì¤„ëŸ¬ íƒ€ì… í•œê¸€í™”
  const schedulerLabel = {
    "1730_timetable": "1730 íƒ€ì„í…Œì´ë¸”",
    "": "ë¯¸ì„¤ì •",
  }[data.scheduler_type] || data.scheduler_type;

  const items = [
    {
      label: "í”Œëœ ì´ë¦„",
      value: data.name || "ë¯¸ì„¤ì •",
      icon: <Settings className="h-4 w-4" />,
      highlight: !!data.name,
    },
    {
      label: "í•™ìŠµ ëª©ì ",
      value: purposeLabel,
      icon: <Target className="h-4 w-4" />,
    },
    {
      label: "í•™ìŠµ ê¸°ê°„",
      value: data.period_start && data.period_end
        ? `${formatDate(data.period_start)} ~ ${formatDate(data.period_end)}`
        : "ë¯¸ì„¤ì •",
      icon: <Calendar className="h-4 w-4" />,
    },
    {
      label: "ì´ ì¼ìˆ˜",
      value: periodDays > 0 ? `${periodDays}ì¼` : "ë¯¸ì„¤ì •",
    },
    {
      label: "ìŠ¤ì¼€ì¤„ëŸ¬",
      value: schedulerLabel,
    },
  ];

  // 1730 Timetable ì˜µì…˜
  if (data.scheduler_type === "1730_timetable" && data.scheduler_options) {
    if (data.scheduler_options.study_days) {
      items.push({
        label: "í•™ìŠµì¼ ìˆ˜",
        value: `${data.scheduler_options.study_days}ì¼`,
      });
    }
    if (data.scheduler_options.review_days) {
      items.push({
        label: "ë³µìŠµì¼ ìˆ˜",
        value: `${data.scheduler_options.review_days}ì¼`,
      });
    }
  }

  // ëª©í‘œì¼ (ì„ íƒ)
  if (data.target_date) {
    items.push({
      label: "ëª©í‘œì¼",
      value: formatDate(data.target_date),
      icon: <Target className="h-4 w-4" />,
    });
  }

  return (
    <div className="space-y-4">
      <SectionSummary items={items} />
    </div>
  );
});
</file>

<file path="new-group/_components/_summary/CollapsibleSection.tsx">
"use client";

import React, { useState } from "react";
import { ChevronRight, Edit } from "lucide-react";
import { cn } from "@/lib/cn";

/**
 * CollapsibleSection - ì ‘ê¸°/í¼ì¹˜ê¸° ì„¹ì…˜
 *
 * Phase 4.2ì—ì„œ êµ¬í˜„
 * Step6Simplifiedì—ì„œ ê° ì„¹ì…˜ì„ ì ‘ê¸°/í¼ì¹˜ê¸°ë¡œ í‘œì‹œ
 */

export type CollapsibleSectionProps = {
  // ì„¹ì…˜ ì œëª©
  title: string | React.ReactNode;

  // ê¸°ë³¸ í¼ì¹¨ ìƒíƒœ
  defaultOpen?: boolean;

  // ìˆ˜ì • ë²„íŠ¼
  onEdit?: () => void;
  editLabel?: string;

  // ë‚´ìš©
  children: React.ReactNode;

  // ë¹„í™œì„±í™”
  disabled?: boolean;

  // í•™ìƒ ì…ë ¥ í—ˆìš© (í…œí”Œë¦¿ ëª¨ë“œìš©)
  studentInputAllowed?: boolean;
  onStudentInputToggle?: (enabled: boolean) => void;
  showStudentInputToggle?: boolean; // í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œë§Œ true

  // í—¤ë” ì¶”ê°€ ì•¡ì…˜ (ì²´í¬ë°•ìŠ¤ ë“±)
  headerActions?: React.ReactNode;
};

export const CollapsibleSection = React.memo(function CollapsibleSection({
  title,
  defaultOpen = false,
  onEdit,
  editLabel = "ìˆ˜ì •",
  children,
  disabled = false,
  studentInputAllowed = false,
  onStudentInputToggle,
  showStudentInputToggle = false,
  headerActions,
}: CollapsibleSectionProps) {
  const [isOpen, setIsOpen] = useState(defaultOpen);

  return (
    <div className="rounded-xl border border-gray-200 bg-white overflow-hidden">
      {/* í—¤ë” */}
      <div
        onClick={() => !disabled && setIsOpen(!isOpen)}
        className={cn(
          "w-full flex items-center justify-between p-4 text-left transition-colors",
          disabled
            ? "cursor-not-allowed bg-gray-50"
            : "hover:bg-gray-50 cursor-pointer"
        )}
        role="button"
        tabIndex={disabled ? -1 : 0}
        onKeyDown={(e) => {
          if (!disabled && (e.key === "Enter" || e.key === " ")) {
            e.preventDefault();
            setIsOpen(!isOpen);
          }
        }}
        aria-expanded={isOpen}
        aria-disabled={disabled}
      >
        <div className="flex items-center gap-3">
          {/* í™”ì‚´í‘œ ì•„ì´ì½˜ */}
          <ChevronRight
            className={cn(
              "h-5 w-5 text-gray-600 transition-transform duration-200",
              isOpen && "rotate-90"
            )}
          />

          {/* ì œëª© */}
          <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
            {title}
          </h3>
        </div>

        {/* ì˜¤ë¥¸ìª½ ì˜ì—­: í—¤ë” ì•¡ì…˜ + í•™ìƒ ì…ë ¥ í—ˆìš© ì²´í¬ë°•ìŠ¤ + ìˆ˜ì • ë²„íŠ¼ */}
        <div className="flex items-center gap-3">
          {/* í—¤ë” ì¶”ê°€ ì•¡ì…˜ (ì²´í¬ë°•ìŠ¤ ë“±) */}
          {headerActions && (
            <div onClick={(e) => e.stopPropagation()}>{headerActions}</div>
          )}

          {/* í•™ìƒ ì…ë ¥ í—ˆìš© ì²´í¬ë°•ìŠ¤ */}
          {showStudentInputToggle && onStudentInputToggle && (
            <label
              className="flex items-center gap-2 text-xs text-gray-600"
              onClick={(e) => e.stopPropagation()}
            >
              <input
                type="checkbox"
                checked={studentInputAllowed}
                onChange={(e) => {
                  e.stopPropagation();
                  onStudentInputToggle(e.target.checked);
                }}
                className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900"
              />
              <span
                className={
                  !showStudentInputToggle || disabled ? "text-gray-600" : ""
                }
              >
                í•™ìƒ ì…ë ¥ í—ˆìš©
              </span>
            </label>
          )}

          {/* ìˆ˜ì • ë²„íŠ¼ */}
          {onEdit && !disabled && (
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                onEdit();
              }}
              className="flex items-center gap-2 rounded-lg border border-blue-500 px-4 py-2 text-sm font-medium text-blue-800 transition-colors hover:bg-blue-50"
            >
              <Edit className="h-4 w-4" />
              {editLabel}
            </button>
          )}
        </div>
      </div>

      {/* ë‚´ìš© */}
      {isOpen && (
        <div className="border-t border-gray-200 p-6 animate-in fade-in slide-in-from-top-2 duration-200">
          {children}
        </div>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_summary/ContentsSummary.tsx">
"use client";

import React, { useMemo } from "react";
import { BookOpen, Video, CheckCircle } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { SummaryCard } from "./SummaryCard";
import { SectionSummary } from "./SectionSummary";

/**
 * ContentsSummary - ì½˜í…ì¸  ìš”ì•½
 * 
 * Phase 4.3ì—ì„œ êµ¬í˜„
 * í•™ìƒ/ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ê³¼ëª©ë³„ë¡œ ìš”ì•½í•˜ì—¬ í‘œì‹œ
 */

export type ContentsSummaryProps = {
  data: WizardData;
  isCampMode?: boolean;
};

type SubjectGroup = {
  subject: string;
  studentCount: number;
  recommendedCount: number;
  totalVolume: number;
  books: number;
  lectures: number;
};

export const ContentsSummary = React.memo(function ContentsSummary({
  data,
  isCampMode = false,
}: ContentsSummaryProps) {
  // ê³¼ëª©ë³„ ê·¸ë£¹í•‘
  const subjectGroups = useMemo(() => {
    const groups = new Map<string, SubjectGroup>();

    // í•™ìƒ ì½˜í…ì¸ 
    data.student_contents.forEach((content) => {
      const subject = content.subject_category || "ê¸°íƒ€";
      if (!groups.has(subject)) {
        groups.set(subject, {
          subject,
          studentCount: 0,
          recommendedCount: 0,
          totalVolume: 0,
          books: 0,
          lectures: 0,
        });
      }

      const group = groups.get(subject)!;
      group.studentCount++;
      group.totalVolume += content.end_range - content.start_range + 1;
      
      if (content.content_type === "book") {
        group.books++;
      } else {
        group.lectures++;
      }
    });

    // ì¶”ì²œ ì½˜í…ì¸ 
    data.recommended_contents.forEach((content) => {
      const subject = content.subject_category || "ê¸°íƒ€";
      if (!groups.has(subject)) {
        groups.set(subject, {
          subject,
          studentCount: 0,
          recommendedCount: 0,
          totalVolume: 0,
          books: 0,
          lectures: 0,
        });
      }

      const group = groups.get(subject)!;
      group.recommendedCount++;
      group.totalVolume += content.end_range - content.start_range + 1;
      
      if (content.content_type === "book") {
        group.books++;
      } else {
        group.lectures++;
      }
    });

    // ê³¼ëª©ëª… ìˆœ ì •ë ¬
    return Array.from(groups.values()).sort((a, b) =>
      a.subject.localeCompare(b.subject)
    );
  }, [data.student_contents, data.recommended_contents]);

  // í•„ìˆ˜ ê³¼ëª© ì²´í¬ (ìº í”„ ëª¨ë“œì—ì„œë§Œ)
  const requiredSubjects = useMemo(() => {
    if (!isCampMode) return [];
    
    // í•„ìˆ˜ êµê³¼ ì„¤ì •ì—ì„œ ì§€ì •í•œ ê³¼ëª© ê°€ì ¸ì˜¤ê¸°
    const requiredSubjectCategories =
      data.subject_constraints?.required_subjects?.map(
        (req) => req.subject_category
      ) || [];
    
    // í•„ìˆ˜ êµê³¼ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
    if (requiredSubjectCategories.length === 0) {
      return [];
    }
    
    const subjects = subjectGroups.map((g) => g.subject);
    return requiredSubjectCategories.map((category) => ({
      name: category,
      selected: subjects.includes(category),
    }));
  }, [subjectGroups, data.subject_constraints?.required_subjects, isCampMode]);

  const totalStudent = data.student_contents.length;
  const totalRecommended = data.recommended_contents.length;
  const totalContents = totalStudent + totalRecommended;
  const allRequiredSelected = requiredSubjects.every((s) => s.selected);

  return (
    <div className="flex flex-col gap-6">
      {/* ì „ì²´ ìš”ì•½ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <SummaryCard
          title="ì´ ì½˜í…ì¸ "
          value={totalContents}
          subtitle={`ìµœëŒ€ 9ê°œ`}
          variant={totalContents >= 9 ? "success" : "default"}
        />
        <SummaryCard
          title="í•™ìƒ ì½˜í…ì¸ "
          value={totalStudent}
          icon={<BookOpen className="h-5 w-5" />}
          variant="primary"
        />
        <SummaryCard
          title="ì¶”ì²œ ì½˜í…ì¸ "
          value={totalRecommended}
          icon={<Video className="h-5 w-5" />}
          variant="primary"
        />
      </div>

      {/* í•„ìˆ˜ ê³¼ëª© ì²´í¬ (ìº í”„ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */}
      {isCampMode && requiredSubjects.length > 0 && (
        <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
          <div className="flex items-center justify-between">
            <h4 className="text-sm font-semibold text-gray-900">í•„ìˆ˜ ê³¼ëª©</h4>
            {allRequiredSelected && (
              <div className="flex items-center gap-1 text-green-600">
                <CheckCircle className="h-4 w-4" />
                <span className="text-xs font-medium">ëª¨ë‘ ì„ íƒë¨</span>
              </div>
            )}
          </div>
          <div className="flex flex-wrap gap-2">
            {requiredSubjects.map((subject) => (
              <div
                key={subject.name}
                className={`flex items-center gap-1.5 rounded-full px-3 py-1 text-sm font-medium ${
                  subject.selected
                    ? "bg-green-100 text-green-700"
                    : "bg-gray-200 text-gray-600"
                }`}
              >
                {subject.selected ? (
                  <CheckCircle className="h-3.5 w-3.5" />
                ) : (
                  <div className="h-3.5 w-3.5 rounded-full border-2 border-gray-400" />
                )}
                <span>{subject.name}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ê³¼ëª©ë³„ ìƒì„¸ */}
      {subjectGroups.length > 0 && (
        <div className="flex flex-col gap-3">
          <h4 className="text-sm font-semibold text-gray-900">
            ê³¼ëª©ë³„ ìƒì„¸
          </h4>
          <SectionSummary
            items={subjectGroups.map((group) => ({
              label: group.subject,
              value: `${group.studentCount + group.recommendedCount}ê°œ (${
                group.totalVolume
              }${group.books > 0 ? "p" : "ê°•"})`,
              icon:
                group.books > 0 ? (
                  <BookOpen className="h-4 w-4" />
                ) : (
                  <Video className="h-4 w-4" />
                ),
              highlight: isCampMode && requiredSubjects.some(
                (s) => s.name === group.subject && s.selected
              ),
            }))}
          />
        </div>
      )}

      {/* íƒ€ì…ë³„ ë¶„í¬ */}
      <div className="flex flex-col gap-3">
        <h4 className="text-sm font-semibold text-gray-900">íƒ€ì…ë³„ ë¶„í¬</h4>
        <div className="grid grid-cols-2 gap-3">
          <div className="rounded-lg border border-amber-200 bg-amber-50 p-3">
            <div className="flex items-center gap-2">
              <BookOpen className="h-5 w-5 text-amber-600" />
              <div>
                <div className="text-sm font-medium text-amber-900">êµì¬</div>
                <div className="text-xl font-bold text-amber-900">
                  {subjectGroups.reduce((sum, g) => sum + g.books, 0)}ê°œ
                </div>
              </div>
            </div>
          </div>
          <div className="rounded-lg border border-purple-200 bg-purple-50 p-3">
            <div className="flex items-center gap-2">
              <Video className="h-5 w-5 text-purple-600" />
              <div>
                <div className="text-sm font-medium text-purple-900">ê°•ì˜</div>
                <div className="text-xl font-bold text-purple-900">
                  {subjectGroups.reduce((sum, g) => sum + g.lectures, 0)}ê°œ
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ë¹ˆ ìƒíƒœ */}
      {totalContents === 0 && (
        <div className="flex flex-col gap-1 rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-8 text-center">
          <p className="text-sm font-medium text-gray-900">
            ì„ íƒëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤
          </p>
          <p className="text-sm text-gray-500">
            Step 3ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </p>
        </div>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_summary/index.ts">
/**
 * Phase 4: Summary ì»´í¬ë„ŒíŠ¸ ë°°ëŸ´ ìµìŠ¤í¬íŠ¸
 * 
 * Step6Simplifiedì—ì„œ ì‚¬ìš©í•˜ëŠ”
 * ê³µí†µ ìš”ì•½ ì»´í¬ë„ŒíŠ¸ë“¤
 */

// ê³µí†µ ì»´í¬ë„ŒíŠ¸ (Phase 4.2)
export { CollapsibleSection } from "./CollapsibleSection";
export type { CollapsibleSectionProps } from "./CollapsibleSection";

export { SummaryCard } from "./SummaryCard";
export type { SummaryCardProps } from "./SummaryCard";

export { SectionSummary } from "./SectionSummary";
export type { SectionSummaryProps, SectionSummaryItem } from "./SectionSummary";

// ì„¹ì…˜ë³„ Summary ì»´í¬ë„ŒíŠ¸ (Phase 4.3)
export { BasicInfoSummary } from "./BasicInfoSummary";
export type { BasicInfoSummaryProps } from "./BasicInfoSummary";

export { TimeSettingsSummary } from "./TimeSettingsSummary";
export type { TimeSettingsSummaryProps } from "./TimeSettingsSummary";

export { ContentsSummary } from "./ContentsSummary";
export type { ContentsSummaryProps } from "./ContentsSummary";

export { LearningVolumeSummary } from "./LearningVolumeSummary";
export type { LearningVolumeSummaryProps } from "./LearningVolumeSummary";

export { SubjectAllocationSummary } from "./SubjectAllocationSummary";
export type { SubjectAllocationSummaryProps } from "./SubjectAllocationSummary";
</file>

<file path="new-group/_components/_summary/LearningVolumeSummary.tsx">
"use client";

import React, { useMemo } from "react";
import { TrendingUp, TrendingDown, CheckCircle, AlertCircle } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { SummaryCard } from "./SummaryCard";

/**
 * LearningVolumeSummary - í•™ìŠµëŸ‰ ìš”ì•½
 * 
 * Phase 4.3ì—ì„œ êµ¬í˜„
 * í˜„ì¬ í•™ìŠµëŸ‰ê³¼ ì¶”ì²œ ë²”ìœ„ë¥¼ ë¹„êµí•˜ì—¬ í‘œì‹œ
 */

export type LearningVolumeSummaryProps = {
  data: WizardData;
};

export const LearningVolumeSummary = React.memo(function LearningVolumeSummary({
  data,
}: LearningVolumeSummaryProps) {
  // í˜„ì¬ í•™ìŠµëŸ‰ ê³„ì‚°
  const currentVolume = useMemo(() => {
    const allContents = [
      ...data.student_contents,
      ...data.recommended_contents,
    ];

    return allContents.reduce((sum, content) => {
      return sum + (content.end_range - content.start_range + 1);
    }, 0);
  }, [data.student_contents, data.recommended_contents]);

  // ì¶”ì²œ ë²”ìœ„ (Â±20%)
  const recommendedMin = useMemo(() => {
    return Math.floor(currentVolume * 0.8);
  }, [currentVolume]);

  const recommendedMax = useMemo(() => {
    return Math.ceil(currentVolume * 1.2);
  }, [currentVolume]);

  // ìƒíƒœ íŒì •
  const status = useMemo(() => {
    if (currentVolume === 0) return "empty";
    if (currentVolume < recommendedMin) return "low";
    if (currentVolume > recommendedMax) return "high";
    return "optimal";
  }, [currentVolume, recommendedMin, recommendedMax]);

  // ì°¨ì´ ê³„ì‚°
  const difference = useMemo(() => {
    if (status === "low") {
      return recommendedMin - currentVolume;
    }
    if (status === "high") {
      return currentVolume - recommendedMax;
    }
    return 0;
  }, [status, currentVolume, recommendedMin, recommendedMax]);

  // ìƒíƒœë³„ ë©”ì‹œì§€
  const statusMessage = {
    empty: "ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”",
    low: `ê¶Œì¥ í•™ìŠµëŸ‰ë³´ë‹¤ ${difference}í˜ì´ì§€ ë¶€ì¡±í•©ë‹ˆë‹¤`,
    high: `ê¶Œì¥ í•™ìŠµëŸ‰ë³´ë‹¤ ${difference}í˜ì´ì§€ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤`,
    optimal: "ì ì • í•™ìŠµëŸ‰ì…ë‹ˆë‹¤",
  }[status];

  // ìƒíƒœë³„ variant
  const statusVariant = {
    empty: "default",
    low: "warning",
    high: "warning",
    optimal: "success",
  }[status] as "default" | "warning" | "success";

  if (currentVolume === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-8">
        <div className="flex flex-col items-center gap-3 text-center">
          <AlertCircle className="h-12 w-12 text-gray-400" />
          <div className="flex flex-col gap-1">
            <p className="text-sm font-medium text-gray-900">
              í•™ìŠµëŸ‰ì„ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </p>
            <p className="text-sm text-gray-500">
              Step 3ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
            </p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* ìš”ì•½ ì¹´ë“œ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <SummaryCard
          title="í˜„ì¬ í•™ìŠµëŸ‰"
          value={currentVolume}
          subtitle="í˜ì´ì§€/ê°•"
          variant="primary"
        />
        <SummaryCard
          title="ê¶Œì¥ ìµœì†Œ"
          value={recommendedMin}
          subtitle="í˜ì´ì§€/ê°•"
          variant="default"
        />
        <SummaryCard
          title="ê¶Œì¥ ìµœëŒ€"
          value={recommendedMax}
          subtitle="í˜ì´ì§€/ê°•"
          variant="default"
        />
      </div>

      {/* ìƒíƒœ í‘œì‹œ */}
      <div
        className={`rounded-lg border p-4 ${
          status === "optimal"
            ? "border-green-200 bg-green-50"
            : status === "empty"
            ? "border-gray-200 bg-gray-50"
            : "border-yellow-200 bg-yellow-50"
        }`}
      >
        <div className="flex items-start gap-3">
          {status === "optimal" ? (
            <CheckCircle className="h-6 w-6 flex-shrink-0 text-green-600" />
          ) : status === "low" ? (
            <TrendingDown className="h-6 w-6 flex-shrink-0 text-yellow-600" />
          ) : status === "high" ? (
            <TrendingUp className="h-6 w-6 flex-shrink-0 text-yellow-600" />
          ) : (
            <AlertCircle className="h-6 w-6 flex-shrink-0 text-gray-600" />
          )}
          
          <div className="flex flex-col gap-1 flex-1">
            <h4
              className={`text-sm font-semibold ${
                status === "optimal"
                  ? "text-green-900"
                  : status === "empty"
                  ? "text-gray-900"
                  : "text-yellow-900"
              }`}
            >
              {status === "optimal" && "âœ… ì ì • í•™ìŠµëŸ‰"}
              {status === "low" && "âš ï¸ í•™ìŠµëŸ‰ ë¶€ì¡±"}
              {status === "high" && "âš ï¸ í•™ìŠµëŸ‰ ì´ˆê³¼"}
              {status === "empty" && "â„¹ï¸ í•™ìŠµëŸ‰ ë¯¸ì„¤ì •"}
            </h4>
            <p
              className={`text-sm ${
                status === "optimal"
                  ? "text-green-700"
                  : status === "empty"
                  ? "text-gray-700"
                  : "text-yellow-700"
              }`}
            >
              {statusMessage}
            </p>
            
            {status !== "empty" && status !== "optimal" && (
              <p
                className={`text-xs ${
                  (status as string) === "optimal"
                    ? "text-green-600"
                    : "text-yellow-600"
                }`}
              >
                ğŸ’¡ Step 3ìœ¼ë¡œ ëŒì•„ê°€ì„œ ì½˜í…ì¸  ë²”ìœ„ë¥¼ ì¡°ì •í•˜ê±°ë‚˜ ì½˜í…ì¸ ë¥¼
                ì¶”ê°€/ì œê±°í•´ì£¼ì„¸ìš”.
              </p>
            )}
          </div>
        </div>
      </div>

      {/* ì§„í–‰ë¥  ë°” */}
      {currentVolume > 0 && (
        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between text-sm">
            <span className="font-medium text-gray-700">í•™ìŠµëŸ‰ ë¹„ìœ¨</span>
            <span className="text-gray-600">
              {Math.round((currentVolume / recommendedMax) * 100)}%
            </span>
          </div>
          <div className="h-3 w-full overflow-hidden rounded-full bg-gray-200">
            <div
              className={`h-full transition-all duration-300 ${
                status === "optimal"
                  ? "bg-green-500"
                  : status === "low"
                  ? "bg-yellow-500"
                  : "bg-yellow-500"
              } w-[${Math.min((currentVolume / recommendedMax) * 100, 100)}%]`}
            />
          </div>
          <div className="flex items-center justify-between text-xs text-gray-500">
            <span>{recommendedMin}</span>
            <span>ê¶Œì¥ ë²”ìœ„</span>
            <span>{recommendedMax}</span>
          </div>
        </div>
      )}
    </div>
  );
});
</file>

<file path="new-group/_components/_summary/SectionSummary.tsx">
"use client";

import React from "react";
import { cn } from "@/lib/cn";

/**
 * SectionSummary - ì„¹ì…˜ ìš”ì•½ ë¦¬ìŠ¤íŠ¸
 * 
 * Phase 4.2ì—ì„œ êµ¬í˜„
 * í‚¤-ê°’ ìŒ í˜•íƒœì˜ ìš”ì•½ ì •ë³´ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ
 */

export type SectionSummaryItem = {
  label: string;
  value: string | number;
  highlight?: boolean;
  icon?: React.ReactNode;
};

export type SectionSummaryProps = {
  items: SectionSummaryItem[];
  variant?: "default" | "compact";
};

export const SectionSummary = React.memo(function SectionSummary({
  items,
  variant = "default",
}: SectionSummaryProps) {
  if (items.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center text-sm text-gray-500">
        ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤
      </div>
    );
  }

  return (
    <div
      className={cn(
        "space-y-3",
        variant === "compact" && "space-y-2"
      )}
    >
      {items.map((item, index) => (
        <div
          key={index}
          className={cn(
            "flex items-center justify-between",
            variant === "default" && "rounded-lg border border-gray-200 bg-gray-50 p-3",
            variant === "compact" && "py-1"
          )}
        >
          {/* Label */}
          <div className="flex items-center gap-2">
            {item.icon && (
              <div className="flex-shrink-0 text-gray-500">{item.icon}</div>
            )}
            <span
              className={cn(
                "text-sm font-medium text-gray-700",
                item.highlight && "font-semibold text-gray-900"
              )}
            >
              {item.label}
            </span>
          </div>

          {/* Value */}
          <span
            className={cn(
              "text-sm font-semibold text-gray-900",
              item.highlight && "text-blue-600"
            )}
          >
            {item.value}
          </span>
        </div>
      ))}
    </div>
  );
});
</file>

<file path="new-group/_components/_summary/SubjectAllocationSummary.tsx">
"use client";

import React, { useMemo } from "react";
import { Star, AlertTriangle } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { SectionSummary } from "./SectionSummary";

/**
 * SubjectAllocationSummary - ì „ëµ/ì·¨ì•½ ê³¼ëª© ìš”ì•½
 * 
 * Phase 4.3ì—ì„œ êµ¬í˜„
 * ìº í”„ ëª¨ë“œì—ì„œ ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì •ë³´ë¥¼ í‘œì‹œ
 */

export type SubjectAllocationSummaryProps = {
  data: WizardData;
};

export const SubjectAllocationSummary = React.memo(
  function SubjectAllocationSummary({ data }: SubjectAllocationSummaryProps) {
    // subject_allocations íŒŒì‹±
    const allocations = useMemo(() => {
      if (!data.subject_allocations) return [];

      return data.subject_allocations.map((alloc) => ({
        subject: alloc.subject_name,
        type: alloc.subject_type,
        days: alloc.weekly_days || 0,
      }));
    }, [data.subject_allocations]);

    // ì „ëµê³¼ëª©ê³¼ ì·¨ì•½ê³¼ëª© ë¶„ë¦¬
    const strategicSubjects = useMemo(() => {
      return allocations.filter((a) => a.type === "strategy");
    }, [allocations]);

    const weakSubjects = useMemo(() => {
      return allocations.filter((a) => a.type === "weakness");
    }, [allocations]);

    // ë¹ˆ ìƒíƒœ
    if (allocations.length === 0) {
      return (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
          <p className="text-sm text-gray-600">
            ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª©ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
          </p>
          <p className="text-xs text-gray-500">
            ëª¨ë“  ê³¼ëª©ì´ ë™ì¼í•˜ê²Œ ë°°ì •ë©ë‹ˆë‹¤
          </p>
        </div>
      );
    }

    const items = [];

    // ì „ëµê³¼ëª©
    if (strategicSubjects.length > 0) {
      items.push({
        label: "ì „ëµê³¼ëª©",
        value: `${strategicSubjects.length}ê°œ`,
        icon: <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />,
        highlight: true,
      });

      strategicSubjects.forEach((subject) => {
        items.push({
          label: `  â€¢ ${subject.subject}`,
          value: `ì£¼ ${subject.days}ì¼`,
        });
      });
    }

    // ì·¨ì•½ê³¼ëª©
    if (weakSubjects.length > 0) {
      items.push({
        label: "ì·¨ì•½ê³¼ëª©",
        value: `${weakSubjects.length}ê°œ`,
        icon: <AlertTriangle className="h-4 w-4 text-orange-500" />,
        highlight: true,
      });

      weakSubjects.forEach((subject) => {
        items.push({
          label: `  â€¢ ${subject.subject}`,
          value: "ì§‘ì¤‘ í•™ìŠµ",
        });
      });
    }

    return (
      <div className="flex flex-col gap-4">
        {/* ìš”ì•½ */}
        <div className="grid grid-cols-2 gap-4">
          <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-3">
            <div className="flex items-center gap-2">
              <Star className="h-5 w-5 fill-yellow-400 text-yellow-400" />
              <div>
                <div className="text-sm font-medium text-yellow-900">
                  ì „ëµê³¼ëª©
                </div>
                <div className="text-xl font-bold text-yellow-900">
                  {strategicSubjects.length}ê°œ
                </div>
              </div>
            </div>
          </div>

          <div className="rounded-lg border border-orange-200 bg-orange-50 p-3">
            <div className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-orange-500" />
              <div>
                <div className="text-sm font-medium text-orange-900">
                  ì·¨ì•½ê³¼ëª©
                </div>
                <div className="text-xl font-bold text-orange-900">
                  {weakSubjects.length}ê°œ
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* ìƒì„¸ */}
        <SectionSummary items={items} variant="compact" />

        {/* ì„¤ëª… */}
        <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
          <p className="text-xs text-blue-800">
            <strong>ì „ëµê³¼ëª©</strong>: ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜ë§Œí¼ ìš°ì„  ë°°ì •ë©ë‹ˆë‹¤
            <br />
            <strong>ì·¨ì•½ê³¼ëª©</strong>: ê°€ëŠ¥í•œ ë§ì€ ì‹œê°„ì„ ë°°ì •í•©ë‹ˆë‹¤
          </p>
        </div>
      </div>
    );
  }
);
</file>

<file path="new-group/_components/_summary/SummaryCard.tsx">
"use client";

import React from "react";
import { cn } from "@/lib/cn";

/**
 * SummaryCard - ìš”ì•½ ì •ë³´ ì¹´ë“œ
 *
 * Phase 4.2ì—ì„œ êµ¬í˜„
 * ìˆ«ì, ìƒíƒœ ë“± ìš”ì•½ ì •ë³´ë¥¼ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œ
 */

export type SummaryCardProps = {
  // ì œëª©
  title: string;

  // ê°’
  value: string | number;

  // ë¶€ì œëª© (ì˜µì…˜)
  subtitle?: string;

  // ì•„ì´ì½˜ (ì˜µì…˜)
  icon?: React.ReactNode;

  // ë³€í˜•
  variant?: "default" | "primary" | "success" | "warning" | "danger";
};

const variantStyles = {
  default: {
    container: "bg-gray-50 border-gray-200",
    title: "text-gray-800",
    value: "text-gray-900",
    icon: "text-gray-600",
  },
  primary: {
    container: "bg-blue-50 border-blue-200",
    title: "text-blue-800",
    value: "text-blue-800",
    icon: "text-blue-500",
  },
  success: {
    container: "bg-green-50 border-green-200",
    title: "text-green-600",
    value: "text-green-900",
    icon: "text-green-500",
  },
  warning: {
    container: "bg-yellow-50 border-yellow-200",
    title: "text-yellow-600",
    value: "text-yellow-900",
    icon: "text-yellow-500",
  },
  danger: {
    container: "bg-red-50 border-red-200",
    title: "text-red-600",
    value: "text-red-900",
    icon: "text-red-500",
  },
};

export const SummaryCard = React.memo(function SummaryCard({
  title,
  value,
  subtitle,
  icon,
  variant = "default",
}: SummaryCardProps) {
  const styles = variantStyles[variant];

  return (
    <div
      className={cn("rounded-lg border p-4 transition-all", styles.container)}
    >
      <div className="flex flex-col gap-1">
        {/* ì•„ì´ì½˜ (ì˜µì…˜) */}
        {icon && <div className={cn(styles.icon)}>{icon}</div>}

        {/* ì œëª© */}
        <div className={cn("text-sm font-medium", styles.title)}>{title}</div>

        {/* ê°’ */}
        <div className={cn("text-2xl font-bold", styles.value)}>{value}</div>

        {/* ë¶€ì œëª© (ì˜µì…˜) */}
        {subtitle && (
          <div className={cn("text-xs", styles.title)}>{subtitle}</div>
        )}
      </div>
    </div>
  );
});
</file>

<file path="new-group/_components/_summary/TimeSettingsSummary.tsx">
"use client";

import React, { useMemo } from "react";
import { Clock, Building2, CalendarX, Utensils } from "lucide-react";
import { WizardData } from "../PlanGroupWizard";
import { SummaryCard } from "./SummaryCard";
import { SectionSummary } from "./SectionSummary";

/**
 * TimeSettingsSummary - ì‹œê°„ ì„¤ì • ìš”ì•½
 * 
 * Phase 4.3ì—ì„œ êµ¬í˜„
 * Step 2ì˜ ì‹œê°„ ì„¤ì •ì„ ìš”ì•½í•˜ì—¬ í‘œì‹œ
 */

export type TimeSettingsSummaryProps = {
  data: WizardData;
};

export const TimeSettingsSummary = React.memo(function TimeSettingsSummary({
  data,
}: TimeSettingsSummaryProps) {
  // í•™ì› ì¼ì • ìš”ì¼ë³„ ê·¸ë£¹í•‘
  const academyByDay = useMemo(() => {
    const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    const grouped = new Map<number, number>();
    
    data.academy_schedules.forEach((schedule) => {
      grouped.set(schedule.day_of_week, (grouped.get(schedule.day_of_week) || 0) + 1);
    });

    return Array.from(grouped.entries())
      .sort(([a], [b]) => a - b)
      .map(([day, count]) => `${days[day]}(${count})`);
  }, [data.academy_schedules]);

  // ì œì™¸ì¼ íƒ€ì…ë³„ ê·¸ë£¹í•‘
  const exclusionsByType = useMemo(() => {
    const grouped = new Map<string, number>();
    
    data.exclusions.forEach((exclusion) => {
      grouped.set(
        exclusion.exclusion_type,
        (grouped.get(exclusion.exclusion_type) || 0) + 1
      );
    });

    return Array.from(grouped.entries());
  }, [data.exclusions]);

  const items = [];

  // í•™ì› ì¼ì •
  if (data.academy_schedules.length > 0) {
    items.push({
      label: "í•™ì› ì¼ì •",
      value: `${data.academy_schedules.length}ê°œ`,
      icon: <Building2 className="h-4 w-4" />,
    });
    
    if (academyByDay.length > 0) {
      items.push({
        label: "ìš”ì¼ë³„",
        value: academyByDay.join(", "),
      });
    }
  }

  // ì œì™¸ì¼
  if (data.exclusions.length > 0) {
    items.push({
      label: "ì œì™¸ì¼",
      value: `${data.exclusions.length}ì¼`,
      icon: <CalendarX className="h-4 w-4" />,
    });
    
    exclusionsByType.forEach(([type, count]) => {
      items.push({
        label: `  â€¢ ${type}`,
        value: `${count}ì¼`,
      });
    });
  }

  // ì‹œê°„ ì„¤ì •
  if (data.time_settings) {
    const ts = data.time_settings;

    if (ts.lunch_time) {
      items.push({
        label: "ì ì‹¬ ì‹œê°„",
        value: `${ts.lunch_time.start} ~ ${ts.lunch_time.end}`,
        icon: <Utensils className="h-4 w-4" />,
      });
    }

    if (ts.camp_study_hours) {
      items.push({
        label: "ìº í”„ í•™ìŠµ ì‹œê°„",
        value: `${ts.camp_study_hours.start} ~ ${ts.camp_study_hours.end}`,
        icon: <Clock className="h-4 w-4" />,
      });
    }

    if (ts.camp_self_study_hours) {
      items.push({
        label: "ììœ¨ í•™ìŠµ ì‹œê°„",
        value: `${ts.camp_self_study_hours.start} ~ ${ts.camp_self_study_hours.end}`,
      });
    }

    if (ts.designated_holiday_hours) {
      items.push({
        label: "ì§€ì • íœ´ì¼ ì‹œê°„",
        value: `${ts.designated_holiday_hours.start} ~ ${ts.designated_holiday_hours.end}`,
      });
    }
  }

  // ë¹ˆ ìƒíƒœ
  if (items.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">
          í•™ì› ì¼ì •ì´ë‚˜ ì œì™¸ì¼ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
        </p>
        <p className="text-xs text-gray-500">
          ëª¨ë“  ë‚ ì§œì— í•™ìŠµì´ ë°°ì •ë©ë‹ˆë‹¤
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {/* ìš”ì•½ ì¹´ë“œ */}
      <div className="grid grid-cols-2 gap-4">
        <SummaryCard
          title="í•™ì› ì¼ì •"
          value={data.academy_schedules.length}
          subtitle="ê°œ"
          icon={<Building2 className="h-5 w-5" />}
          variant={data.academy_schedules.length > 0 ? "primary" : "default"}
        />
        <SummaryCard
          title="ì œì™¸ì¼"
          value={data.exclusions.length}
          subtitle="ì¼"
          icon={<CalendarX className="h-5 w-5" />}
          variant={data.exclusions.length > 0 ? "warning" : "default"}
        />
      </div>

      {/* ìƒì„¸ ì •ë³´ */}
      <SectionSummary items={items} variant="compact" />
    </div>
  );
});
</file>

<file path="new-group/_components/hooks/usePlanPayloadBuilder.ts">
import { useMemo } from "react";
import { WizardData } from "../PlanGroupWizard";
import { PlanGroupCreationData, ContentType, PlanPurpose, PlanContentInput } from "@/lib/types/plan";
import { PlanGroupError, PlanGroupErrorCodes, ErrorUserMessages } from "@/lib/errors/planGroupErrors";
import { validateDataConsistency } from "@/lib/utils/planGroupDataSync";
import { mergeTimeSettingsSafely, mergeStudyReviewCycle } from "@/lib/utils/schedulerOptionsMerge";
import { validatePeriod } from "../utils/validationUtils";

/**
 * í™•ì¥ëœ PlanContentInput íƒ€ì… (ì¶”ì²œ ê´€ë ¨ í•„ë“œ í¬í•¨)
 */
type ExtendedPlanContentInput = PlanContentInput & {
  title?: string;
  subject_category?: string;
  subject?: string;
  is_auto_recommended?: boolean;
  recommendation_source?: "auto" | "admin" | "template" | null;
  recommendation_reason?: string | null;
  recommendation_metadata?: Record<string, unknown> | null;
  master_content_id?: string | null;
  display_order?: number;
};

type UsePlanPayloadBuilderOptions = {
  validateOnBuild?: boolean;
  isCampMode?: boolean;
};

type PayloadBuildResult = {
  payload: PlanGroupCreationData | null;
  isValid: boolean;
  errors: string[];
  warnings: string[];
  build: () => PlanGroupCreationData;
};

export function usePlanPayloadBuilder(
  wizardData: WizardData,
  options: UsePlanPayloadBuilderOptions = { validateOnBuild: false }
): PayloadBuildResult {
  const { payload, isValid, errors, warnings } = useMemo(() => {
    const errors: string[] = [];
    const warnings: string[] = [];

    // 1. Basic Field Validation
    if (!wizardData.name || wizardData.name.trim() === "") {
      errors.push("í”Œëœ ê·¸ë£¹ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    }
    
    // ê¸°ê°„ ê²€ì¦: ê³µí†µ ê²€ì¦ í•¨ìˆ˜ ì‚¬ìš©
    const periodValidation = validatePeriod(wizardData, options.isCampMode ?? false);
    if (!periodValidation.isValid && periodValidation.error) {
      errors.push(periodValidation.error);
    }
    if (!wizardData.block_set_id) {
       // Note: block_set_id might be missing in 'Draft' mode or early stages, 
       // but for a final build it is usually required. 
       // However, PlanGroupCreationData allows it to be nullable/optional in some contexts, 
       // but typically strictly required for 'Active' plans. 
       // We'll treat it as required if validateOnBuild is strict, but here we just check presence.
       // errors.push("ì‹œê°„í‘œ í…œí”Œë¦¿(Block Set)ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    // 2. Data Consistency Check (Using existing utility)
    const consistencyCheck = validateDataConsistency(wizardData);
    if (!consistencyCheck.valid) {
      errors.push(...consistencyCheck.errors);
    }

    // 3. Content Merging & Deduplication
    const allContents = [
      ...wizardData.student_contents,
      ...(wizardData.recommended_contents || []),
    ];

    const contentKeys = new Set<string>();
    // Relaxed type to allow extended properties during construction
    const uniqueContents: ExtendedPlanContentInput[] = [];
    const duplicateNames: string[] = [];

    allContents.forEach((c, idx) => {
      // Key by type + id
      const key = `${c.content_type}:${c.content_id}`;
      
        if (!contentKeys.has(key)) {
        contentKeys.add(key);
        // student_contentsì—ëŠ” ì¶”ì²œ í•„ë“œê°€ ì—†ê³ , recommended_contentsì—ë§Œ ìˆìœ¼ë¯€ë¡œ ì˜µì…”ë„ ì²´ì´ë‹ ì‚¬ìš©
        const contentWithExtras = c as typeof c & {
          is_auto_recommended?: boolean;
          recommendation_source?: "auto" | "admin" | "template" | null;
          recommendation_reason?: string | null;
          recommendation_metadata?: Record<string, unknown> | null;
          master_content_id?: string | null;
        };
        uniqueContents.push({ 
          ...contentWithExtras, 
          display_order: uniqueContents.length,
          title: contentWithExtras.title,
          subject_category: contentWithExtras.subject_category,
          subject: contentWithExtras.subject,
          is_auto_recommended: contentWithExtras.is_auto_recommended,
          recommendation_source: contentWithExtras.recommendation_source,
          recommendation_reason: contentWithExtras.recommendation_reason,
          recommendation_metadata: contentWithExtras.recommendation_metadata,
          master_content_id: contentWithExtras.master_content_id // Ensure master_content_id is included
        });
      } else {
        // Find existing to see if we should merge metadata
        // For now, simpler strategy: First come first serve (Student contents usually come first in the array concat)
        const existing = uniqueContents.find(u => `${u.content_type}:${u.content_id}` === key);
        if (existing) {
             // If the duplicate has specific recommendation reasons, maybe we want to keep them?
             // But usually student selection overrides or we just treat them as one.
             // We'll just warn.
             duplicateNames.push(c.title || c.content_id);
        }
      }
    });

    if (duplicateNames.length > 0) {
        // Technically this might not be a blocker for fetching, but for saving a plan it's better to be clean
        // warnings.push(`ì¤‘ë³µëœ ì½˜í…ì¸ ê°€ ê°ì§€ë˜ì–´ í•˜ë‚˜ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤: ${duplicateNames.slice(0, 3).join(", ")}...`);
    }

    if (uniqueContents.length === 0 && options.validateOnBuild) {
        // Only error if strict
        // errors.push("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì½˜í…ì¸ ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    }

    // 4. Construct Scheduler Options (Legacy Support & New Structure)
    // We try to flatten where possible but must respect PlanGroupCreationData structure.
    
    // Construct base scheduler options
    let schedulerOptions: Record<string, any> = {
      ...(wizardData.scheduler_options || {}),
    };

    // Merge high-level fields into scheduler_options if they exist, to ensure backend receives them
    // properly formatted as expected by the legacy logic if strictly needed, 
    // OR just rely on the new top-level fields if the backend supports them.
    // Based on `syncWizardDataToCreationData` logic:
    schedulerOptions = mergeStudyReviewCycle(
      schedulerOptions,
      wizardData.study_review_cycle
    );
    if (wizardData.student_level) {
      schedulerOptions.student_level = wizardData.student_level;
    }
    if (wizardData.subject_allocations) {
      schedulerOptions.subject_allocations = wizardData.subject_allocations;
    }
    if (wizardData.content_allocations) {
        schedulerOptions.content_allocations = wizardData.content_allocations;
    }
    // Time settings merge (ë³´í˜¸ í•„ë“œ ìë™ ë³´í˜¸)
    schedulerOptions = mergeTimeSettingsSafely(
      schedulerOptions,
      wizardData.time_settings
    );

    // 5. Construct Final Payload
    const finalPayload: PlanGroupCreationData = {
      name: wizardData.name || null,
      plan_purpose: (wizardData.plan_purpose as PlanPurpose) || "ë‚´ì‹ ëŒ€ë¹„",
      scheduler_type: (wizardData.scheduler_type as "1730_timetable" | "") || "1730_timetable",
      
      period_start: wizardData.period_start,
      period_end: wizardData.period_end,
      target_date: wizardData.target_date || null,
      block_set_id: wizardData.block_set_id || null, // Allow null for drafts

      contents: uniqueContents.map((c): ExtendedPlanContentInput => {
         // Determine master_content_id precedence
         let masterId = c.master_content_id;

         // If implicit from being a pure recommended content
         if (!masterId && c.is_auto_recommended) {
             // In auto recommendation, content_id is often the master id if it came from the master list
             masterId = c.content_id;
         }

         return {
            content_type: c.content_type,
            content_id: c.content_id,
            master_content_id: masterId || null,
            start_range: c.start_range,
            end_range: c.end_range,
            start_detail_id: c.start_detail_id ?? null,
            end_detail_id: c.end_detail_id ?? null,
            display_order: c.display_order,

            // Optional / Metadata fields that PlanGroupCreationData might accept
            // (Need to cast or ensure type definition supports them)
            // The type definition says PlanContentInput does NOT have these recommendation fields ??
            // However, the backend accepts these fields, so we include them with proper typing
            is_auto_recommended: c.is_auto_recommended,
            recommendation_source: c.recommendation_source,
            recommendation_reason: c.recommendation_reason,
            recommendation_metadata: c.recommendation_metadata
         };
      }) as unknown as PlanContentInput[], // Backend accepts extended fields but type definition is strict

      exclusions: (wizardData.exclusions || []).map(e => ({
          exclusion_date: e.exclusion_date,
          exclusion_type: e.exclusion_type,
          reason: e.reason || null
      })),

      academy_schedules: (wizardData.academy_schedules || []).map(s => ({
          day_of_week: s.day_of_week,
          start_time: s.start_time,
          end_time: s.end_time,
          academy_name: s.academy_name,
          subject: s.subject,
          travel_time: s.travel_time
      })),

      // Top Level Fields
      study_review_cycle: wizardData.study_review_cycle,
      student_level: wizardData.student_level,
      subject_allocations: wizardData.subject_allocations,
      additional_period_reallocation: wizardData.additional_period_reallocation,
      non_study_time_blocks: wizardData.non_study_time_blocks,
      
      // Scheduler Options (Legacy + Merged)
      scheduler_options: Object.keys(schedulerOptions).length > 0 ? schedulerOptions : null,

      // Constraints
      subject_constraints: wizardData.subject_constraints ? {
          ...wizardData.subject_constraints,
          required_subjects: wizardData.subject_constraints.required_subjects?.map(req => ({
              subject_category: req.subject_category,
              subject: req.subject_category, // fallback
              min_count: req.min_count,
              subjects_by_curriculum: req.subjects_by_curriculum?.filter(s => s.subject_id).map(s => ({
                  curriculum_revision_id: s.curriculum_revision_id,
                  subject_id: s.subject_id!,
                  subject_name: s.subject_name
              }))
          }))
      } : undefined,

      // Pre-calculated Daily Schedule (Step 2.5/6)
      daily_schedule: wizardData.daily_schedule || null,

      // Camp Props
      plan_type: wizardData.plan_type, 
      camp_template_id: wizardData.camp_template_id,
      camp_invitation_id: wizardData.camp_invitation_id,
    };

    return {
      payload: finalPayload,
      isValid: errors.length === 0,
      errors,
      warnings
    };
  }, [wizardData, options.validateOnBuild, options.isCampMode]);

  const build = () => {
    if (!isValid && options.validateOnBuild) {
        throw new PlanGroupError(
            `ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨: ${errors.join(", ")}`,
            PlanGroupErrorCodes.VALIDATION_FAILED,
            "ì…ë ¥ëœ ë°ì´í„°ì— ì˜¤ë¥˜ê°€ ìˆì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        );
    }
    if (!payload) {
         throw new PlanGroupError(
            "Payload ìƒì„± ì‹¤íŒ¨",
            PlanGroupErrorCodes.DATA_TRANSFORMATION_FAILED,
            ErrorUserMessages[PlanGroupErrorCodes.DATA_TRANSFORMATION_FAILED]
         );
    }
    return payload;
  };

  return { payload, isValid, errors, warnings, build };
}
</file>

<file path="new-group/_components/hooks/usePlanSubmission.ts">
import { useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import { useToast } from "@/components/ui/ToastProvider";
import { WizardData, WizardStep } from "../PlanGroupWizard";
import {
  toPlanGroupError,
  PlanGroupError,
  PlanGroupErrorCodes,
  ErrorUserMessages,
} from "@/lib/errors/planGroupErrors";
import {
  savePlanGroupDraftAction,
  updatePlanGroupDraftAction,
  createPlanGroupAction,
  updatePlanGroupStatus,
} from "@/app/(student)/actions/planGroupActions";
import { usePlanPayloadBuilder } from "./usePlanPayloadBuilder";
import { validatePeriod } from "../utils/validationUtils";

type UsePlanSubmissionProps = {
  wizardData: WizardData;
  draftGroupId: string | null;
  setDraftGroupId: (id: string) => void;
  currentStep: WizardStep;
  setCurrentStep: (step: WizardStep) => void;
  setValidationErrors: (errors: string[]) => void;
  isCampMode: boolean;
  campInvitationId?: string;
  initialData?: any;
  isAdminContinueMode: boolean;
  isAdminMode: boolean;
  onSaveRequest?: (saveFn: () => Promise<void>) => void;
};

export function usePlanSubmission({
  wizardData,
  draftGroupId,
  setDraftGroupId,
  currentStep,
  setCurrentStep,
  setValidationErrors,
  isCampMode,
  campInvitationId,
  initialData,
  isAdminContinueMode,
  isAdminMode,
}: UsePlanSubmissionProps) {
  const router = useRouter();
  const toast = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Payload Builder Hook
  const { build: buildPayload } = usePlanPayloadBuilder(wizardData, {
    validateOnBuild: true,
    isCampMode,
  });

  /* -------------------------------------------------------------------------- */
  /*                             Draft Save Logic                               */
  /* -------------------------------------------------------------------------- */
  const executeSave = useCallback(
    async (silent: boolean = false) => {
      try {
        setValidationErrors([]);
        
        // ê¸°ê°„ ê²€ì¦: ê³µí†µ ê²€ì¦ í•¨ìˆ˜ ì‚¬ìš©
        const periodValidation = validatePeriod(wizardData, isCampMode);
        if (!periodValidation.isValid && periodValidation.error) {
          setValidationErrors([periodValidation.error]);
          if (!silent) toast.showError(periodValidation.error);
          return;
        }
        
        let creationData;
        try {
           creationData = buildPayload();
        } catch (err: unknown) {
           console.error("Payload Build Error", err);
           const msg = err instanceof PlanGroupError 
             ? err.userMessage 
             : err instanceof Error 
             ? err.message 
             : "ë°ì´í„° ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
           setValidationErrors([msg]);
           if (!silent) toast.showError(msg);
           return;
        }

        // ìº í”„ ëª¨ë“œ/Draft ëª¨ë“œ íŠ¹ìˆ˜ ì²˜ë¦¬ (usePlanPayloadBuilderì—ì„œ ì²˜ë¦¬í–ˆì§€ë§Œ ì•ˆì „ì¥ì¹˜)
        if (isCampMode) {
          creationData.block_set_id = null;
          if (campInvitationId) creationData.camp_invitation_id = campInvitationId;
          if (initialData?.templateId) creationData.camp_template_id = initialData.templateId;
          creationData.plan_type = "camp";
        }

        if (draftGroupId) {
          await updatePlanGroupDraftAction(draftGroupId, creationData);
          if (!silent) toast.showSuccess("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          const result = await savePlanGroupDraftAction(creationData);
          if (result?.groupId) {
            setDraftGroupId(result.groupId);
            if (!silent) toast.showSuccess("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else {
            throw new PlanGroupError(
              "Draft ìƒì„± ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.",
              PlanGroupErrorCodes.DRAFT_SAVE_FAILED,
              "ì„ì‹œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
              true
            );
          }
        }
      } catch (error) {
        console.error("[usePlanSubmission] ì„ì‹œ ì €ì¥ ì‹¤íŒ¨:", error);
        const planGroupError = toPlanGroupError(error, PlanGroupErrorCodes.DRAFT_SAVE_FAILED);
        if (!silent) {
          setValidationErrors([planGroupError.userMessage]);
          toast.showError(planGroupError.userMessage);
        }
      }
    },
    [
      buildPayload,
      draftGroupId,
      setDraftGroupId,
      setValidationErrors,
      toast,
      isCampMode,
      campInvitationId,
      initialData,
      wizardData,
    ]
  );

  /* -------------------------------------------------------------------------- */
  /*                             Final Submit Logic                             */
  /* -------------------------------------------------------------------------- */
  const handleSubmit = useCallback(
    async (generatePlans: boolean = true) => {
      if (isSubmitting) return;
      setIsSubmitting(true);
      setValidationErrors([]);

      try {
        // 0. ê¸°ê°„ ê²€ì¦: ê³µí†µ ê²€ì¦ í•¨ìˆ˜ ì‚¬ìš©
        const periodValidation = validatePeriod(wizardData, isCampMode);
        if (!periodValidation.isValid && periodValidation.error) {
          setValidationErrors([periodValidation.error]);
          toast.showError(periodValidation.error);
          setIsSubmitting(false);
          return;
        }
        
        // 1. Payload Build
        let creationData;
        try {
            creationData = buildPayload();
        } catch (err: unknown) {
            console.error("Payload Build Error (Submit)", err);
            const msg = err instanceof PlanGroupError 
              ? err.userMessage 
              : err instanceof Error 
              ? err.message 
              : "ë°ì´í„° ë³€í™˜ ì˜¤ë¥˜";
            setValidationErrors([msg]);
            toast.showError(msg);
            setIsSubmitting(false);
            return;
        }

        // 2. Camp Mode Overrides
        if (isCampMode) {
            creationData.block_set_id = null;
            if (campInvitationId) creationData.camp_invitation_id = campInvitationId;
            if (initialData?.templateId) creationData.camp_template_id = initialData.templateId;
            creationData.plan_type = "camp";
        }
        
        let finalGroupId: string;

        // 3. Create or Update Plan Group
        if (draftGroupId) {
          await updatePlanGroupDraftAction(draftGroupId, creationData);
          finalGroupId = draftGroupId;
        } else {
          // ìº í”„ ëª¨ë“œ Step 4ì—ì„œ ì œì¶œ ì‹œ ì½˜í…ì¸  ê²€ì¦ ê±´ë„ˆë›°ê¸°
          const skipContentValidation = isCampMode && currentStep === 4 && !isAdminContinueMode;
          const result = await createPlanGroupAction(creationData, { skipContentValidation });
          
          if (!result?.groupId) {
            throw new PlanGroupError(
              "í”Œëœ ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨",
              PlanGroupErrorCodes.PLAN_GROUP_CREATE_FAILED,
              ErrorUserMessages[PlanGroupErrorCodes.PLAN_GROUP_CREATE_FAILED]
            );
          }
          finalGroupId = result.groupId;
        }

        // 4. Update Status to 'saved'
        try {
          await updatePlanGroupStatus(finalGroupId, "saved");
        } catch (error) {
          console.warn("[usePlanSubmission] Status update failed", error);
        }

        // 5. Handle Step Transitions (Create drafts only)
        if (currentStep === 4 && !generatePlans) { // Step 4 -> 5
             setDraftGroupId(finalGroupId);
             setCurrentStep(5);
             return;
        }
        if (currentStep === 5) { // Step 5 -> 6
            setDraftGroupId(finalGroupId);
            setCurrentStep(6);
            toast.showSuccess("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ í”Œëœì„ ìƒì„±í•©ë‹ˆë‹¤.");
            return;
        }
        if (currentStep === 6) { // Step 6 -> 7
            setDraftGroupId(finalGroupId);
            setCurrentStep(7);
            toast.showSuccess("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ í”Œëœì„ ìƒì„±í•©ë‹ˆë‹¤.");
            return;
        }

        // 6. Plan Generation (Generate Real Plans)
        if (generatePlans) {
             // ìº í”„ ë‚¨ì€ ë‹¨ê³„ ì§„í–‰ (ê´€ë¦¬ì)
             if (isAdminContinueMode && initialData?.templateId) {
                 const { continueCampStepsForAdmin } = await import("@/app/(admin)/actions/campTemplateActions");
                 await continueCampStepsForAdmin(
                     draftGroupId || (initialData?.groupId as string),
                     wizardData,
                     currentStep
                 );
                 toast.showSuccess("í”Œëœì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                 window.location.href = `/admin/camp-templates/${initialData.templateId}/participants`;
                 return;
             }

             // ìº í”„ ì°¸ì—¬ ì œì¶œ (í•™ìƒ)
             if (campInvitationId && !isAdminMode) {
                 const { submitCampParticipation } = await import("@/app/(student)/actions/campActions");
                 const result = await submitCampParticipation(campInvitationId, wizardData);
                 if (result.success && result.groupId) {
                     toast.showSuccess("ìº í”„ ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                     const targetPath = result.invitationId 
                        ? `/camp/${result.invitationId}/submitted`
                        : `/plan/group/${result.groupId}`;
                     router.push(targetPath, { scroll: true });
                 } else {
                     throw new Error(result.error || "ìº í”„ ì°¸ì—¬ ì‹¤íŒ¨");
                 }
                 return;
             }
             
             // ì¼ë°˜ í”Œëœ ìƒì„±
             // ì´ê³³ì—ì„œ ìƒì„± ë¡œì§ì´ ë” ë³µì¡í•˜ê²Œ ì–½í˜€ìˆì—ˆìœ¼ë‚˜, ì›ë˜ ë¡œì§ì´ Step 7ì—ì„œ í˜¸ì¶œë˜ê¸°ë„ í•˜ê³  ì—¬ê¸°ì„œ í˜¸ì¶œë˜ê¸°ë„ í•¨.
             // ì´ í•¨ìˆ˜ëŠ” 'handleSubmit'ìœ¼ë¡œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë¨.
             // Step 7 ì§„ì… ì „ì— ìƒì„±í•˜ëŠ” ê²½ìš° (Step 6 -> 7 ì „ ë‹¨ê³„ ì™„ë£Œ ì‹œ)
             
             // ... ì›ë˜ ì½”ë“œì—ì„œëŠ” Step 7 ScheduleResult ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ë©´ì„œ ìƒì„±ì„ íŠ¸ë¦¬ê±°í•˜ê±°ë‚˜,
             // ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ìƒì„±ì„ íŠ¸ë¦¬ê±°í•¨.
             // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ groupIdë¥¼ ë°˜í™˜í•˜ê³  ëë‚´ëŠ” ê²Œ ì•„ë‹ˆë¼ ì‹¤ì œ ìƒì„± ì•¡ì…˜ì„ í˜¸ì¶œí•´ì•¼ í•  ìˆ˜ë„ ìˆìŒ.
             // í•˜ì§€ë§Œ ê¸°ì¡´ ë¡œì§ì„ ë³´ë©´ Step 7 ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ onComplete ë“±ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°ë„ í•¨.
             
             // ë‹¤ë§Œ, "í”Œëœ ìƒì„±" ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œì˜ ë™ì‘ì€:
             // 1. draft ì €ì¥
             // 2. generatePlansFromGroupAction í˜¸ì¶œ (ë˜ëŠ” ì´ì— ì¤€í•˜ëŠ” ë™ì‘)
             // 
             // ê¸°ì¡´ PlanGroupWizard.handleSubmitì„ ë³´ë©´:
             // isAdminContinueMode ì—¬ë¶€ ë“±ì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬ë¨.
             // ì¼ë°˜ì ì¸ ê²½ìš°:
             // Step 7ì€ ê²°ê³¼ í™”ë©´ì¼ ë¿, ì‹¤ì œ ìƒì„±ì€ ì´ì „ ë‹¨ê³„ ì™„ë£Œì‹œ ì¼ì–´ë‚¨ ??
             // ì•„ë‹ˆë©´ Step 7ì—ì„œ useEffectë¡œ?
             
             // PlanGroupWizard.tsx:1159~ í™•ì¸í•´ë³´ë©´,
             // generatePlans === true ì´ë©´
             // handleGeneratePlans()ë¥¼ í˜¸ì¶œí•¨.
             
             if (!isAdminContinueMode && !campInvitationId) {
                 // ì¼ë°˜ í”Œëœ ìƒì„±
                 const { generatePlansFromGroupAction } = await import("@/app/(student)/actions/plan-groups/plans");
                 // this action throws on error, so if we get here, it succeeded.
                 const result = await generatePlansFromGroupAction(finalGroupId);
                 toast.showSuccess(`í”Œëœì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${result.count}ê°œ)`);
                 router.push(`/plan/group/${finalGroupId}`, { scroll: true });
             }
        }

      } catch (error) {
        console.error("[usePlanSubmission] Submit failed", error);
        const planGroupError = toPlanGroupError(error, PlanGroupErrorCodes.PLAN_GENERATION_FAILED);
        setValidationErrors([planGroupError.userMessage]);
        toast.showError(planGroupError.userMessage);
      } finally {
        setIsSubmitting(false);
      }
    },
    [
      isSubmitting, 
      buildPayload, 
      isCampMode, 
      campInvitationId, 
      initialData, 
      draftGroupId, 
      currentStep, 
      isAdminContinueMode, 
      isAdminMode, 
      setDraftGroupId, 
      setCurrentStep, 
      toast, 
      setValidationErrors, 
      wizardData, 
      router
    ]
  );
  
  return {
    isSubmitting,
    executeSave,
    handleSubmit
  };
}
</file>

<file path="new-group/_components/hooks/useWizardValidation.ts">
import { useState, useCallback } from "react";
import { WizardData, WizardStep } from "../PlanGroupWizard";
import { validateStep as validateStepUtil } from "../utils/validationUtils";

// í•„ë“œ IDë³„ ì˜¤ë¥˜ ë©”ì‹œì§€ ë§µ íƒ€ì…
export type FieldErrors = Map<string, string>;

// Stepë³„ í•„ë“œ ìˆœì„œ ì •ì˜ (í™”ë©´ì— í‘œì‹œë˜ëŠ” ìˆœì„œ)
const FIELD_ORDER_BY_STEP: Record<WizardStep, string[]> = {
  1: ["plan_name", "plan_purpose", "period_start", "scheduler_type"],
  2: [],
  3: [],
  4: ["content_selection"],
  5: [],
  6: [],
  7: [],
};

/**
 * ì²« ë²ˆì§¸ ì˜¤ë¥˜ í•„ë“œ IDë¥¼ ë°˜í™˜ (í™”ë©´ ìˆœì„œ ê¸°ì¤€)
 */
export function getFirstErrorFieldId(
  fieldErrors: FieldErrors,
  step: WizardStep
): string | undefined {
  if (fieldErrors.size === 0) return undefined;

  const fieldOrder = FIELD_ORDER_BY_STEP[step];
  if (!fieldOrder || fieldOrder.length === 0) {
    // í•„ë“œ ìˆœì„œê°€ ì •ì˜ë˜ì§€ ì•Šì€ ê²½ìš° Mapì˜ ì²« ë²ˆì§¸ í‚¤ ë°˜í™˜
    return Array.from(fieldErrors.keys())[0];
  }

  // í™”ë©´ ìˆœì„œì— ë”°ë¼ ì²« ë²ˆì§¸ ì˜¤ë¥˜ í•„ë“œ ì°¾ê¸°
  for (const fieldId of fieldOrder) {
    if (fieldErrors.has(fieldId)) {
      return fieldId;
    }
  }

  // ìˆœì„œì— ì—†ëŠ” í•„ë“œì¸ ê²½ìš° Mapì˜ ì²« ë²ˆì§¸ í‚¤ ë°˜í™˜
  return Array.from(fieldErrors.keys())[0];
}

type UseWizardValidationProps = {
  wizardData: WizardData;
  isTemplateMode: boolean;
  isCampMode?: boolean;
};

type UseWizardValidationReturn = {
  validationErrors: string[];
  validationWarnings: string[];
  fieldErrors: FieldErrors;
  setValidationErrors: (errors: string[]) => void;
  setValidationWarnings: (warnings: string[]) => void;
  validateStep: (step: WizardStep) => boolean;
  clearValidationState: () => void;
};

export function useWizardValidation({
  wizardData,
  isTemplateMode,
  isCampMode = false,
}: UseWizardValidationProps): UseWizardValidationReturn {
  const [validationErrors, setValidationErrors] = useState<string[]>([]);
  const [validationWarnings, setValidationWarnings] = useState<string[]>([]);
  const [fieldErrors, setFieldErrors] = useState<FieldErrors>(new Map());

  const clearValidationState = useCallback(() => {
    setValidationErrors([]);
    setValidationWarnings([]);
    setFieldErrors(new Map());
  }, []);

  const validateStep = useCallback(
    (step: WizardStep): boolean => {
      // ê³µí†µ ê²€ì¦ í•¨ìˆ˜ ì‚¬ìš©
      const result = validateStepUtil(
        wizardData,
        step,
        isTemplateMode,
        isCampMode
      );

      setValidationErrors(result.errors);
      setValidationWarnings(result.warnings);
      setFieldErrors(result.fieldErrors);
      return result.isValid;
    },
    [wizardData, isTemplateMode, isCampMode]
  );

  return {
    validationErrors,
    validationWarnings,
    fieldErrors,
    setValidationErrors,
    setValidationWarnings,
    validateStep,
    clearValidationState,
  };
}
</file>

<file path="new-group/_components/Step1BasicInfo/hooks/useBlockSetManagement.ts">
import { useState, useTransition, useEffect } from "react";
import {
  createBlockSet,
  getBlockSets,
  updateBlockSet,
} from "@/app/actions/blockSets";
import { addBlock, deleteBlock, addBlocksToMultipleDays } from "@/app/actions/blocks";
import {
  createTenantBlockSet,
  getTenantBlockSets,
  updateTenantBlockSet,
  addTenantBlock,
  addTenantBlocksToMultipleDays,
  deleteTenantBlock,
} from "@/app/(admin)/actions/tenantBlockSets";
import {
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";
import { WizardData } from "../../PlanGroupWizard";

type UseBlockSetManagementProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  blockSets: Array<{
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  }>;
  onBlockSetCreated?: (blockSet: { id: string; name: string }) => void;
  onBlockSetsLoaded?: (
    blockSets: Array<{
      id: string;
      name: string;
      blocks?: Array<{
        id: string;
        day_of_week: number;
        start_time: string;
        end_time: string;
      }>;
    }>
  ) => void;
  isTemplateMode?: boolean;
  isCampMode?: boolean;
  templateId?: string;
};

export function useBlockSetManagement({
  data,
  onUpdate,
  blockSets,
  onBlockSetCreated,
  onBlockSetsLoaded,
  isTemplateMode = false,
  isCampMode = false,
  templateId,
}: UseBlockSetManagementProps) {
  const [blockSetMode, setBlockSetMode] = useState<
    "select" | "create" | "edit"
  >("select");
  const [newBlockSetName, setNewBlockSetName] = useState("");
  const [editingBlockSetId, setEditingBlockSetId] = useState<string | null>(
    null
  );
  const [editingBlockSetName, setEditingBlockSetName] = useState("");
  const [isPending, startTransition] = useTransition();
  const [isLoadingBlockSets, setIsLoadingBlockSets] = useState(false);
  const [showBlockSetDescDialog, setShowBlockSetDescDialog] = useState(false);

  // í˜ì´ì§• ìƒíƒœ
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 5;

  // ì‹œê°„ ë¸”ë¡ ì¶”ê°€ ê´€ë ¨ ìƒíƒœ (ìƒì„± ë° ìˆ˜ì • ê³µí†µ)
  const [selectedWeekdays, setSelectedWeekdays] = useState<number[]>([]);
  const [blockStartTime, setBlockStartTime] = useState<string>("");
  const [blockEndTime, setBlockEndTime] = useState<string>("");
  const [addedBlocks, setAddedBlocks] = useState<
    Array<{ day: number; startTime: string; endTime: string }>
  >([]);

  // ì´ˆê¸° ë¡œë“œ ì‹œ ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ìë™ ë¡œë“œ
  useEffect(() => {
    if (
      blockSets.length === 0 &&
      !isLoadingBlockSets &&
      !isTemplateMode &&
      !templateId
    ) {
      handleLoadBlockSets();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ìë™ ì„ íƒ
  useEffect(() => {
    if (data.block_set_id && blockSets && blockSets.length > 0) {
      const selectedSet = blockSets.find((set) => set.id === data.block_set_id);
      if (!selectedSet && isCampMode) {
        console.log(
          "[Step1BasicInfo] í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:",
          data.block_set_id
        );
      }
    }
  }, [data.block_set_id, blockSets, isCampMode]);

  // ê³µí†µ: ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
  const refreshBlockSets = async () => {
    const latestBlockSets = isTemplateMode
      ? await getTenantBlockSets()
      : await getBlockSets();

    if (onBlockSetsLoaded) {
      onBlockSetsLoaded(latestBlockSets);
    }

    return latestBlockSets;
  };

  const toggleWeekday = (day: number) => {
    setSelectedWeekdays((prev) =>
      prev.includes(day) ? prev.filter((d) => d !== day) : [...prev, day]
    );
  };

  const selectAllWeekdays = () => {
    setSelectedWeekdays([0, 1, 2, 3, 4, 5, 6]);
  };

  const selectWeekdays = () => {
    setSelectedWeekdays([1, 2, 3, 4, 5]); // ì›”~ê¸ˆ
  };

  const selectWeekends = () => {
    setSelectedWeekdays([0, 6]); // ì¼, í† 
  };

  const handleAddBlock = () => {
    if (selectedWeekdays.length === 0) {
      alert("ì¶”ê°€í•  ìš”ì¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!blockStartTime || !blockEndTime) {
      alert("ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const newBlocks = selectedWeekdays.map((day) => ({
      day,
      startTime: blockStartTime,
      endTime: blockEndTime,
    }));
    setAddedBlocks([...addedBlocks, ...newBlocks]);
    setSelectedWeekdays([]);
    setBlockStartTime("");
    setBlockEndTime("");
  };

  const handleRemoveBlock = (index: number) => {
    setAddedBlocks(addedBlocks.filter((_, i) => i !== index));
  };

  const handleCreateBlockSet = () => {
    if (!newBlockSetName.trim()) {
      alert("ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
    if (isPending) {
      return;
    }

    startTransition(() => {
      (async () => {
        try {
          let blockSetId: string;
          let blockSetName: string;

          // 1. ë¸”ë¡ ì„¸íŠ¸ ìƒì„± (í…œí”Œë¦¿/ì¼ë°˜ ëª¨ë“œ ë¶„ê¸°)
          if (isTemplateMode) {
            const templateFormData = new FormData();
            templateFormData.append("name", newBlockSetName.trim());

            console.log("[Step1BasicInfo] í…Œë„ŒíŠ¸ ë¸”ë¡ ì„¸íŠ¸ ìƒì„±:", {
              name: newBlockSetName.trim(),
            });

            const templateResult = await createTenantBlockSet(templateFormData);
            blockSetId = templateResult.blockSetId;
            blockSetName = templateResult.name;

            console.log("[Step1BasicInfo] í…Œë„ŒíŠ¸ ë¸”ë¡ ì„¸íŠ¸ ìƒì„± ì„±ê³µ:", {
              block_set_id: blockSetId,
              name: blockSetName,
            });
          } else {
            const formData = new FormData();
            formData.append("name", newBlockSetName.trim());
            const result = await createBlockSet(formData);
            blockSetId = result.blockSetId;
            blockSetName = result.name;
          }

          // 2. ì‹œê°„ ë¸”ë¡ ì¶”ê°€ (ì¼ê´„ ì²˜ë¦¬ë¡œ ìµœì í™”)
          if (addedBlocks.length > 0) {
            // ê°™ì€ ì‹œê°„ëŒ€ë¥¼ ê°€ì§„ ë¸”ë¡ë“¤ì„ ê·¸ë£¹í™”
            const blocksByTime = addedBlocks.reduce((acc, block) => {
              const timeKey = `${block.startTime}-${block.endTime}`;
              if (!acc[timeKey]) {
                acc[timeKey] = {
                  startTime: block.startTime,
                  endTime: block.endTime,
                  days: [],
                };
              }
              acc[timeKey].days.push(block.day);
              return acc;
            }, {} as Record<string, { startTime: string; endTime: string; days: number[] }>);

            // ê° ì‹œê°„ëŒ€ë³„ë¡œ ì¼ê´„ ì¶”ê°€
            for (const timeKey in blocksByTime) {
              const { startTime, endTime, days } = blocksByTime[timeKey];
              
              try {
                if (isTemplateMode) {
                  const blockFormData = new FormData();
                  blockFormData.append("target_days", days.join(","));
                  blockFormData.append("start_time", startTime);
                  blockFormData.append("end_time", endTime);
                  blockFormData.append("block_set_id", blockSetId);
                  await addTenantBlocksToMultipleDays(blockFormData);
                } else {
                  const blockFormData = new FormData();
                  blockFormData.append("target_days", days.join(","));
                  blockFormData.append("start_time", startTime);
                  blockFormData.append("end_time", endTime);
                  blockFormData.append("block_set_id", blockSetId);
                  await addBlocksToMultipleDays(blockFormData);
                }
              } catch (error: unknown) {
                // INFO: ì ‘ë‘ì‚¬ê°€ ìˆëŠ” ê²½ìš° ë¶€ë¶„ ì„±ê³µ ë©”ì‹œì§€ë¡œ ì²˜ë¦¬
                const errorMessage = error instanceof Error ? error.message : String(error);
                if (errorMessage.startsWith("INFO:")) {
                  console.log("[Step1BasicInfo] ë¸”ë¡ ì¶”ê°€ ë¶€ë¶„ ì„±ê³µ:", errorMessage);
                  // ë¶€ë¶„ ì„±ê³µì€ ê³„ì† ì§„í–‰
                } else {
                  const planGroupError = toPlanGroupError(
                    error,
                    PlanGroupErrorCodes.BLOCK_SET_NOT_FOUND,
                    { days: days.join(",") }
                  );
                  console.error(
                    `[Step1BasicInfo] ë¸”ë¡ ì¶”ê°€ ì‹¤íŒ¨ (ìš”ì¼ ${days.join(",")}):`,
                    planGroupError
                  );
                  // ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ë¶€ë¶„ ì„±ê³µ í—ˆìš©)
                }
              }
            }
          }

          // 3. ìµœì‹  ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
          const latestBlockSets = await refreshBlockSets();

          // 4. ìƒˆ ë¸”ë¡ ì„¸íŠ¸ê°€ ëª©ë¡ì— í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ì„ íƒ
          const newBlockSet = latestBlockSets.find(set => set.id === blockSetId);
          if (newBlockSet) {
            // ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ í›„ ì•ˆì „í•˜ê²Œ ì„ íƒ
            onUpdate({ block_set_id: blockSetId });
          } else {
            console.warn("[Step1BasicInfo] ìƒˆë¡œ ìƒì„±ëœ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ëª©ë¡ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", blockSetId);
            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ì—†ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            alert("ë¸”ë¡ ì„¸íŠ¸ê°€ ìƒì„±ë˜ì—ˆì§€ë§Œ ëª©ë¡ì— ë°˜ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.");
          }

          // 5. í¼ ì´ˆê¸°í™” (ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬)
          startTransition(() => {
          setNewBlockSetName("");
          setBlockSetMode("select");
          setAddedBlocks([]);
          setBlockStartTime("");
          setBlockEndTime("");
          setSelectedWeekdays([]);
          setCurrentPage(1);
          });
        } catch (error) {
          alert(
            error instanceof Error
              ? error.message
              : "ë¸”ë¡ ì„¸íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }
      })();
    });
  };

  const handleLoadBlockSets = () => {
    setIsLoadingBlockSets(true);
    startTransition(() => {
      (async () => {
        try {
          await refreshBlockSets();
          setBlockSetMode("select");
          setCurrentPage(1);
        } catch (error) {
          alert(
            error instanceof Error
              ? error.message
              : "ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        } finally {
          setIsLoadingBlockSets(false);
        }
      })();
    });
  };

  const handleStartEdit = () => {
    if (!data.block_set_id) {
      alert("ë¨¼ì € ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!blockSets || blockSets.length === 0) {
      alert("ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const selectedSet = blockSets.find((set) => set.id === data.block_set_id);
    if (!selectedSet) {
      alert("ì„ íƒëœ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    setEditingBlockSetId(selectedSet.id);
    setEditingBlockSetName(selectedSet.name);
    setBlockSetMode("edit");
  };

  const handleAddBlocksToSet = () => {
    if (!editingBlockSetId) {
      alert("ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (selectedWeekdays.length === 0) {
      alert("ì¶”ê°€í•  ìš”ì¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!blockStartTime || !blockEndTime) {
      alert("ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    startTransition(() => {
      (async () => {
        try {
          // ë¸”ë¡ ì¼ê´„ ì¶”ê°€ (í…œí”Œë¦¿/ì¼ë°˜ ëª¨ë“œ ë¶„ê¸°)
          const blockFormData = new FormData();
          blockFormData.append("target_days", selectedWeekdays.join(","));
          blockFormData.append("start_time", blockStartTime);
          blockFormData.append("end_time", blockEndTime);
          blockFormData.append("block_set_id", editingBlockSetId);

          try {
            if (isTemplateMode) {
              await addTenantBlocksToMultipleDays(blockFormData);
            } else {
              await addBlocksToMultipleDays(blockFormData);
            }
          } catch (error: unknown) {
            // INFO: ì ‘ë‘ì‚¬ê°€ ìˆëŠ” ê²½ìš° ë¶€ë¶„ ì„±ê³µ ë©”ì‹œì§€ë¡œ ì²˜ë¦¬
            const errorMessage = error instanceof Error ? error.message : String(error);
            if (errorMessage.startsWith("INFO:")) {
              console.log("[Step1BasicInfo] ë¸”ë¡ ì¶”ê°€ ë¶€ë¶„ ì„±ê³µ:", errorMessage);
              // ë¶€ë¶„ ì„±ê³µì€ ê³„ì† ì§„í–‰
            } else {
              const planGroupError = toPlanGroupError(
                error,
                PlanGroupErrorCodes.BLOCK_SET_NOT_FOUND,
                { days: selectedWeekdays.join(",") }
              );
              console.error(
                `[Step1BasicInfo] ë¸”ë¡ ì¶”ê°€ ì‹¤íŒ¨ (ìš”ì¼ ${selectedWeekdays.join(",")}):`,
                planGroupError
              );
              // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
              alert(
                error instanceof Error
                  ? error.message
                  : "ë¸”ë¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              );
            }
          }

          // ìµœì‹  ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
          const latestBlockSets = await refreshBlockSets();
          
          // ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ í™•ì¸ (ë””ë²„ê¹…ìš©)
          const updatedSet = latestBlockSets.find(set => set.id === editingBlockSetId);
          if (!updatedSet) {
            console.warn("[Step1BasicInfo] ë¸”ë¡ ì¶”ê°€ í›„ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", editingBlockSetId);
          }

          setSelectedWeekdays([]);
          setBlockStartTime("");
          setBlockEndTime("");
        } catch (error) {
          alert(
            error instanceof Error ? error.message : "ë¸”ë¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }
      })();
    });
  };

  const handleDeleteBlock = async (blockId: string) => {
    if (!confirm("ì´ ì‹œê°„ ë¸”ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      return;
    }

    startTransition(() => {
      (async () => {
        try {
          const blockFormData = new FormData();
          blockFormData.append("id", blockId);

          // ë¸”ë¡ ì‚­ì œ (í…œí”Œë¦¿/ì¼ë°˜ ëª¨ë“œ ë¶„ê¸°)
          if (isTemplateMode) {
            await deleteTenantBlock(blockFormData);
          } else {
            await deleteBlock(blockFormData);
          }

          // ìµœì‹  ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
          const latestBlockSets = await refreshBlockSets();
          
          // ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ í™•ì¸ (ë””ë²„ê¹…ìš©)
          if (editingBlockSetId) {
            const updatedSet = latestBlockSets.find(set => set.id === editingBlockSetId);
            if (!updatedSet) {
              console.warn("[Step1BasicInfo] ë¸”ë¡ ì‚­ì œ í›„ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", editingBlockSetId);
            }
          }
        } catch (error) {
          alert(
            error instanceof Error ? error.message : "ë¸”ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }
      })();
    });
  };

  const handleUpdateBlockSetName = () => {
    if (!editingBlockSetId || !editingBlockSetName.trim()) {
      alert("ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    startTransition(() => {
      (async () => {
        try {
          const formData = new FormData();
          formData.append("id", editingBlockSetId);
          formData.append("name", editingBlockSetName.trim());

          // ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„ ì—…ë°ì´íŠ¸ (í…œí”Œë¦¿/ì¼ë°˜ ëª¨ë“œ ë¶„ê¸°)
          if (isTemplateMode) {
            await updateTenantBlockSet(formData);
          } else {
            await updateBlockSet(formData);
            }

          // ìµœì‹  ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
          const latestBlockSets = await refreshBlockSets();

          // ì—…ë°ì´íŠ¸ëœ ë¸”ë¡ ì„¸íŠ¸ ì°¾ì•„ì„œ ì„ íƒ ìœ ì§€
          const updatedSet = latestBlockSets.find(
            (set) => set.id === editingBlockSetId
          );
          if (updatedSet) {
            // ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ í›„ ì•ˆì „í•˜ê²Œ ì„ íƒ ìœ ì§€
            onUpdate({ block_set_id: updatedSet.id });
          } else {
            console.warn("[Step1BasicInfo] ì´ë¦„ ìˆ˜ì • í›„ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ëª©ë¡ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", editingBlockSetId);
            // ëª©ë¡ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ì–´ë„ ê³„ì† ì§„í–‰ (ì´ë¦„ì€ ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨)
          }

          setBlockSetMode("select");
          setEditingBlockSetId(null);
          setEditingBlockSetName("");
        } catch (error) {
          alert(
            error instanceof Error
              ? error.message
              : "ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }
      })();
    });
  };

  return {
    blockSetMode,
    setBlockSetMode,
    newBlockSetName,
    setNewBlockSetName,
    editingBlockSetId,
    setEditingBlockSetId,
    editingBlockSetName,
    setEditingBlockSetName,
    isPending,
    isLoadingBlockSets,
    showBlockSetDescDialog,
    setShowBlockSetDescDialog,
    currentPage,
    setCurrentPage,
    itemsPerPage,
    selectedWeekdays,
    setSelectedWeekdays,
    blockStartTime,
    setBlockStartTime,
    blockEndTime,
    setBlockEndTime,
    addedBlocks,
    setAddedBlocks,
    toggleWeekday,
    selectAllWeekdays,
    selectWeekdays,
    selectWeekends,
    handleAddBlock,
    handleRemoveBlock,
    handleCreateBlockSet,
    handleLoadBlockSets,
    handleStartEdit,
    handleAddBlocksToSet,
    handleDeleteBlock,
    handleUpdateBlockSetName,
  };
}
</file>

<file path="new-group/_components/Step1BasicInfo/hooks/usePeriodCalculation.ts">
import { useState, useEffect } from "react";
import { WizardData } from "../../PlanGroupWizard";
import {
  formatDateFromDate,
  parseDateString as parseDateStringUtil,
  getTodayParts,
  formatDateString,
} from "@/lib/utils/date";

export type PeriodInputType = "dday" | "direct" | "weeks";

type UsePeriodCalculationProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  editable: boolean;
};

export function usePeriodCalculation({
  data,
  onUpdate,
  editable,
}: UsePeriodCalculationProps) {
  const [periodInputType, setPeriodInputType] =
    useState<PeriodInputType>("direct");

  const [ddayState, setDdayState] = useState({ date: "", calculated: false });
  const [weeksState, setWeeksState] = useState({ startDate: "", weeks: 4 });
  const [directState, setDirectState] = useState(() => {
    return {
      start: data.period_start || "",
      end: data.period_end || "",
    };
  });

  // target_dateê°€ ìˆìœ¼ë©´ ddayState ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (data.target_date) {
      setDdayState({ date: data.target_date, calculated: true });
      setPeriodInputType("dday");
    }
  }, [data.target_date]);

  // weeksState ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (data.period_start && !data.target_date) {
      if (data.period_start && data.period_end) {
        const start = new Date(data.period_start);
        const end = new Date(data.period_end);
        const diffDays = Math.floor(
          (end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)
        );
        const weeks = Math.floor(diffDays / 7);

        if (diffDays % 7 === 0 && weeks >= 4) {
          setWeeksState({ startDate: data.period_start, weeks });
          setPeriodInputType("weeks");
        } else {
          setPeriodInputType("direct");
        }
      }
    }
  }, [data.period_start, data.period_end, data.target_date]);

  // í•™ìŠµê¸°ê°„ ë°ì´í„° ë³€ê²½ ì‹œ directState ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (data.period_start || data.period_end) {
      setDirectState((prev) => {
        if (
          prev.start !== (data.period_start || "") ||
          prev.end !== (data.period_end || "")
        ) {
          return {
            start: data.period_start || "",
            end: data.period_end || "",
          };
        }
        return prev;
      });
    }
  }, [data.period_start, data.period_end]);

  const handlePeriodTypeChange = (type: PeriodInputType) => {
    if (!editable) return;
    setPeriodInputType(type);

    if (type !== "dday") {
      setDdayState({ date: "", calculated: false });
      if (type !== "direct" && type !== "weeks") {
        onUpdate({ period_start: "", period_end: "", target_date: undefined });
      }
    }
    if (type !== "weeks") {
      setWeeksState({ startDate: "", weeks: 4 });
      if (type !== "direct" && type !== "dday") {
        onUpdate({ period_start: "", period_end: "" });
      }
    } else {
      setWeeksState({ startDate: "", weeks: 4 });
    }
    if (type !== "direct") {
      setDirectState({
        start: "",
        end: "",
      });
      if (type !== "dday" && type !== "weeks") {
        onUpdate({ period_start: "", period_end: "" });
      }
    }
  };

  const calculatePeriodFromWeeks = (weeks: number, startDate: string) => {
    if (!startDate) {
      onUpdate({ period_start: "", period_end: "" });
      return;
    }

    const startParts = parseDateStringUtil(startDate);
    const start = new Date(
      startParts.year,
      startParts.month - 1,
      startParts.day
    );

    const end = new Date(start);
    end.setDate(end.getDate() + weeks * 7);

    onUpdate({
      period_start: formatDateFromDate(start),
      period_end: formatDateFromDate(end),
    });
  };

  const calculatePeriodFromDday = (dday: string) => {
    if (!dday) {
      onUpdate({ period_start: "", period_end: "", target_date: undefined });
      return;
    }

    const targetParts = parseDateStringUtil(dday);
    const targetDate = new Date(
      targetParts.year,
      targetParts.month - 1,
      targetParts.day
    );

    const start = new Date(targetDate);
    start.setDate(start.getDate() - 30);

    onUpdate({
      period_start: formatDateFromDate(start),
      period_end: formatDateFromDate(targetDate),
      target_date: dday,
    });
  };

  return {
    periodInputType,
    ddayState,
    weeksState,
    directState,
    setPeriodInputType: handlePeriodTypeChange,
    setDdayState,
    setWeeksState,
    setDirectState,
    calculatePeriodFromWeeks,
    calculatePeriodFromDday,
  };
}
</file>

<file path="new-group/_components/Step1BasicInfo/BlockSetSection.tsx">
import { useMemo } from "react";
import { HelpCircle, RefreshCw, Plus, Pencil } from "lucide-react";
import { CollapsibleSection } from "../_summary/CollapsibleSection";
import { BlockSetTimeline } from "../_shared/BlockSetTimeline";
import { WizardData } from "../PlanGroupWizard";
import { Dialog } from "@/components/ui/Dialog";
import { useBlockSetManagement } from "./hooks/useBlockSetManagement";
import { WeekdaySelector } from "./WeekdaySelector";

type BlockSetSectionProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  blockSets: Array<{
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  }>;
  management: ReturnType<typeof useBlockSetManagement>;
  editable: boolean;
  isCampMode: boolean;
  isTemplateMode: boolean;
  toggleFieldControl: (fieldName: string) => void;
  canStudentInputBlockSetId: boolean;
  lockedFields: Record<string, boolean>;
};

export function BlockSetSection({
  data,
  onUpdate,
  blockSets,
  management,
  editable,
  isCampMode,
  isTemplateMode,
  toggleFieldControl,
  canStudentInputBlockSetId,
  lockedFields,
}: BlockSetSectionProps) {
  const {
    blockSetMode,
    setBlockSetMode,
    newBlockSetName,
    setNewBlockSetName,
    editingBlockSetId,
    setEditingBlockSetId,
    editingBlockSetName,
    setEditingBlockSetName,
    isPending,
    isLoadingBlockSets,
    showBlockSetDescDialog,
    setShowBlockSetDescDialog,
    currentPage,
    setCurrentPage,
    itemsPerPage,
    selectedWeekdays,
    blockStartTime,
    setBlockStartTime,
    blockEndTime,
    setBlockEndTime,
    addedBlocks,
    toggleWeekday,
    selectAllWeekdays,
    selectWeekdays,
    selectWeekends,
    handleAddBlock,
    handleRemoveBlock,
    handleCreateBlockSet,
    handleLoadBlockSets,
    handleStartEdit,
    handleAddBlocksToSet,
    handleDeleteBlock,
    handleUpdateBlockSetName,
    setSelectedWeekdays,
    setAddedBlocks,
  } = management;

  // ì¤‘ë³µëœ IDë¥¼ ê°€ì§„ ë¸”ë¡ ì„¸íŠ¸ ì œê±° (ì²« ë²ˆì§¸ í•­ëª©ë§Œ ìœ ì§€)
  const uniqueBlockSets = useMemo(() => {
    const seen = new Set<string>();
    return blockSets.filter((set) => {
      if (seen.has(set.id)) {
        return false;
      }
      seen.add(set.id);
      return true;
    });
  }, [blockSets]);

  return (
    <>
      <CollapsibleSection
        title={
          <>
            ë¸”ë¡ ì„¸íŠ¸ *
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                setShowBlockSetDescDialog(true);
              }}
              className="inline-flex items-center text-gray-800 hover:text-gray-900"
              title="ë¸”ë¡ ì„¸íŠ¸ ì„¤ëª…"
            >
              <HelpCircle className="h-4 w-4" />
            </button>
          </>
        }
        defaultOpen={true}
        studentInputAllowed={lockedFields.allow_student_block_set_id === true}
        onStudentInputToggle={(enabled) =>
          toggleFieldControl("allow_student_block_set_id")
        }
        showStudentInputToggle={isTemplateMode}
      >
        <div className="space-y-6">
          <div className="flex items-center justify-end">
            <div className="flex items-center gap-1">
              <button
                type="button"
                onClick={handleLoadBlockSets}
                disabled={isLoadingBlockSets}
                className="flex items-center gap-1 rounded p-1.5 text-xs text-gray-800 hover:bg-gray-100 hover:text-gray-900 disabled:cursor-not-allowed disabled:opacity-50"
                title="ëª©ë¡ ìƒˆë¡œê³ ì¹¨"
              >
                <RefreshCw
                  className={`h-4 w-4 ${
                    isLoadingBlockSets ? "animate-spin" : ""
                  }`}
                />
              </button>
              {blockSetMode === "select" && (
                <button
                  type="button"
                  onClick={() => {
                    if (isCampMode && !canStudentInputBlockSetId) return;
                    setBlockSetMode("create");
                  }}
                  disabled={isCampMode && !canStudentInputBlockSetId}
                  className={`flex items-center gap-1 rounded p-1.5 text-xs ${
                    isCampMode && !canStudentInputBlockSetId
                      ? "cursor-not-allowed text-gray-900 opacity-50"
                      : "text-gray-800 hover:bg-gray-100 hover:text-gray-900"
                  }`}
                  title="ìƒˆ ë¸”ë¡ ì„¸íŠ¸ ë§Œë“¤ê¸°"
                >
                  <Plus className="h-4 w-4" />
                </button>
              )}
            </div>
          </div>

          {/* ì„ íƒëœ ë¸”ë¡ ì„¸íŠ¸ì˜ ì‹œê°„ ë¸”ë¡ ì •ë³´ í‘œì‹œ (ëª©ë¡ ìœ„) - í•­ìƒ í‘œì‹œ (ì½ê¸° ì „ìš©) */}
          <div>
          {(() => {
            const selectedSet =
              data.block_set_id && uniqueBlockSets
                ? uniqueBlockSets.find((set) => set.id === data.block_set_id)
                : null;
            const rawBlocks = selectedSet?.blocks ?? [];
            const blocks = rawBlocks.map((block, index) => ({
              ...block,
              block_index: index,
            }));
            const name = selectedSet?.name || "ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”";

            return <BlockSetTimeline blocks={blocks} name={name} />;
          })()}
        </div>

        {/* ê¸°ì¡´ ë¸”ë¡ ì„¸íŠ¸ ì„ íƒ */}
        {blockSetMode === "select" && (
          <div
            className={`flex flex-col gap-2 ${
              !editable || (isCampMode && !canStudentInputBlockSetId)
                ? "opacity-60"
                : ""
            }`}
          >
            {uniqueBlockSets.length > 0 ? (
              <>
                {(() => {
                  const startIndex = (currentPage - 1) * itemsPerPage;
                  const endIndex = startIndex + itemsPerPage;
                  const paginatedBlockSets = uniqueBlockSets.slice(
                    startIndex,
                    endIndex
                  );
                  const totalPages = Math.ceil(uniqueBlockSets.length / itemsPerPage);

                  return (
                    <>
                      {paginatedBlockSets.map((set, index) => {
                        const blockCount = set.blocks?.length ?? 0;
                        const isSelected = data.block_set_id === set.id;
                        return (
                          <div
                            key={`${set.id}-${startIndex + index}`}
                            className={`flex items-center justify-between rounded-lg border px-3 py-2 transition-colors ${
                              isSelected
                                ? "border-gray-900 bg-gray-50"
                                : "border-gray-200 bg-white hover:border-gray-300"
                            }`}
                          >
                            <label
                              className={`flex flex-1 items-center gap-2 ${
                                !editable ||
                                (isCampMode && !canStudentInputBlockSetId)
                                  ? "cursor-not-allowed"
                                  : "cursor-pointer"
                              }`}
                            >
                              <input
                                type="radio"
                                name="block_set"
                                value={set.id}
                                checked={isSelected}
                                onChange={(e) => {
                                  if (
                                    !editable ||
                                    (isCampMode && !canStudentInputBlockSetId)
                                  )
                                    return;
                                  onUpdate({
                                    block_set_id: e.target.value || undefined,
                                  });
                                }}
                                disabled={
                                  !editable ||
                                  (isCampMode && !canStudentInputBlockSetId)
                                }
                                className="h-4 w-4 border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-60"
                              />
                              <div className="flex-1">
                                <div className="text-sm font-medium text-gray-900">
                                  {set.name}
                                </div>
                                <div className="text-xs text-gray-600">
                                  {blockCount > 0
                                    ? `${blockCount}ê°œ ë¸”ë¡`
                                    : "ë¸”ë¡ ì—†ìŒ"}
                                </div>
                              </div>
                            </label>
                            <button
                              type="button"
                              onClick={(e) => {
                                if (
                                  !editable ||
                                  (isCampMode && !canStudentInputBlockSetId)
                                )
                                  return;
                                e.stopPropagation();
                                setEditingBlockSetId(set.id);
                                setEditingBlockSetName(set.name);
                                setBlockSetMode("edit");
                              }}
                              disabled={
                                !editable ||
                                (isCampMode && !canStudentInputBlockSetId)
                              }
                              className={`flex items-center gap-1 rounded px-2 py-1 text-xs ${
                                isCampMode && !canStudentInputBlockSetId
                                  ? "cursor-not-allowed text-gray-900 opacity-50"
                                  : "text-gray-800 hover:bg-gray-100 hover:text-gray-900"
                              }`}
                              title="ìˆ˜ì •"
                            >
                              <Pencil className="h-3.5 w-3.5" />
                            </button>
                          </div>
                        );
                      })}

                      {/* í˜ì´ì§• ì»¨íŠ¸ë¡¤ */}
                      {totalPages > 1 && (
                        <div className="flex items-center justify-between pt-2">
                          <button
                            type="button"
                            onClick={() =>
                              setCurrentPage((prev) => Math.max(1, prev - 1))
                            }
                            disabled={currentPage === 1}
                            className="rounded px-3 py-1 text-xs text-gray-800 hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50"
                          >
                            ì´ì „
                          </button>
                          <span className="text-xs text-gray-900">
                            {currentPage} / {totalPages}
                          </span>
                          <button
                            type="button"
                            onClick={() =>
                              setCurrentPage((prev) =>
                                Math.min(totalPages, prev + 1)
                              )
                            }
                            disabled={currentPage === totalPages}
                            className="rounded px-3 py-1 text-xs text-gray-800 hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50"
                          >
                            ë‹¤ìŒ
                          </button>
                        </div>
                      )}
                    </>
                  );
                })()}
              </>
            ) : (
              <p className="text-xs text-gray-600">
                ë“±ë¡ëœ ë¸”ë¡ ì„¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. "+" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒì„±í•˜ì„¸ìš”.
              </p>
            )}
            {(!editable || (isCampMode && !canStudentInputBlockSetId)) && (
              <p className="text-xs text-gray-600">
                {!editable
                  ? "ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤."
                  : "ë¸”ë¡ ì„¸íŠ¸ëŠ” í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}
              </p>
            )}
          </div>
        )}

        {/* ë¸”ë¡ ì„¸íŠ¸ ìƒì„± í¼ */}
        {blockSetMode === "create" &&
          (!isCampMode || canStudentInputBlockSetId) && (
            <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
              {/* ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„ */}
              <div className="flex flex-col gap-2">
                <label className="block text-sm font-medium text-gray-900">
                  ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„
                </label>
                <input
                  type="text"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
                  placeholder="ì˜ˆ: í‰ì¼ í•™ìŠµ ë¸”ë¡"
                  value={newBlockSetName}
                  onChange={(e) => setNewBlockSetName(e.target.value)}
                />
              </div>

              {/* ì‹œê°„ ë¸”ë¡ ì¶”ê°€ */}
              <div className="flex flex-col gap-3 rounded-xl border border-gray-200 bg-white p-6">
                <h3 className="text-sm font-semibold text-gray-900">
                  ì‹œê°„ ë¸”ë¡ ì¶”ê°€
                </h3>

                <WeekdaySelector
                  selectedWeekdays={selectedWeekdays}
                  onToggle={toggleWeekday}
                  onSelectAll={selectAllWeekdays}
                  onSelectWeekdays={selectWeekdays}
                  onSelectWeekends={selectWeekends}
                />

                {/* ì‹œê°„ ì…ë ¥ */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="flex flex-col gap-1">
                    <label className="block text-xs font-medium text-gray-900">
                      ì‹œì‘ ì‹œê°„
                    </label>
                    <input
                      type="time"
                      className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
                      value={blockStartTime}
                      onChange={(e) => setBlockStartTime(e.target.value)}
                    />
                  </div>
                  <div className="flex flex-col gap-1">
                    <label className="block text-xs font-medium text-gray-900">
                      ì¢…ë£Œ ì‹œê°„
                    </label>
                    <input
                      type="time"
                      className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
                      value={blockEndTime}
                      onChange={(e) => setBlockEndTime(e.target.value)}
                    />
                  </div>
                </div>

                {/* ë¸”ë¡ ì¶”ê°€ ë²„íŠ¼ */}
                <button
                  type="button"
                  onClick={handleAddBlock}
                  disabled={
                    selectedWeekdays.length === 0 ||
                    !blockStartTime ||
                    !blockEndTime
                  }
                  className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
                >
                  ë¸”ë¡ ì¶”ê°€í•˜ê¸°
                </button>
              </div>

              {/* ì¶”ê°€ëœ ë¸”ë¡ ëª©ë¡ */}
              {addedBlocks.length > 0 && (
                <div className="rounded-xl border border-gray-200 bg-white p-6">
                  <div className="flex flex-col gap-2">
                    <h3 className="text-sm font-semibold text-gray-900">
                      ì¶”ê°€ëœ ë¸”ë¡ ({addedBlocks.length}ê°œ)
                    </h3>
                    <div className="space-y-2">
                    {addedBlocks.map((block, index) => {
                      const dayNames = [
                        "ì¼",
                        "ì›”",
                        "í™”",
                        "ìˆ˜",
                        "ëª©",
                        "ê¸ˆ",
                        "í† ",
                      ];
                      return (
                        <div
                          key={index}
                          className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
                        >
                          <span className="text-sm text-gray-600">
                            {dayNames[block.day]}ìš”ì¼ {block.startTime} ~{" "}
                            {block.endTime}
                          </span>
                          <button
                            type="button"
                            onClick={() => handleRemoveBlock(index)}
                            className="text-xs text-red-600 hover:text-red-800"
                          >
                            ì‚­ì œ
                          </button>
                        </div>
                      );
                    })}
                    </div>
                  </div>
                </div>
              )}

              {/* ìƒì„± ë²„íŠ¼ */}
              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={() => {
                    setBlockSetMode("select");
                    setNewBlockSetName("");
                    setAddedBlocks([]);
                    setBlockStartTime("");
                    setBlockEndTime("");
                    setSelectedWeekdays([]);
                  }}
                  className="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  type="button"
                  onClick={handleCreateBlockSet}
                  disabled={isPending || !newBlockSetName.trim()}
                  className="flex-1 rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
                >
                  {isPending ? "ìƒì„± ì¤‘..." : "ë¸”ë¡ ì„¸íŠ¸ ìƒì„±"}
                </button>
              </div>
            </div>
          )}

        {/* ë¸”ë¡ ì„¸íŠ¸ ìˆ˜ì • í¼ */}
        {blockSetMode === "edit" && editingBlockSetId && (
          <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
            {/* ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„ ìˆ˜ì • */}
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-900">
                ë¸”ë¡ ì„¸íŠ¸ ì´ë¦„
              </label>
              <div className="flex gap-2">
                <input
                  type="text"
                  className="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
                  value={editingBlockSetName}
                  onChange={(e) => setEditingBlockSetName(e.target.value)}
                />
                <button
                  type="button"
                  onClick={handleUpdateBlockSetName}
                  disabled={
                    isPending ||
                    !editingBlockSetName.trim() ||
                    editingBlockSetName ===
                      uniqueBlockSets?.find((s) => s.id === editingBlockSetId)?.name
                  }
                  className="rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
                >
                  {isPending ? "ì €ì¥ ì¤‘..." : "ì´ë¦„ ì €ì¥"}
                </button>
              </div>
            </div>

            {/* í˜„ì¬ ë¸”ë¡ ëª©ë¡ */}
            {(() => {
              const selectedSet = uniqueBlockSets?.find(
                (set) => set.id === editingBlockSetId
              );
              const blocks = selectedSet?.blocks ?? [];
              const dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];

              if (blocks.length === 0) {
                return (
                  <div className="rounded-xl border border-gray-200 bg-white p-6">
                    <p className="text-xs text-gray-600">
                      ì´ ë¸”ë¡ ì„¸íŠ¸ì—ëŠ” ë“±ë¡ëœ ì‹œê°„ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ
                      ì¶”ê°€í•´ì£¼ì„¸ìš”.
                    </p>
                  </div>
                );
              }

              // ìš”ì¼ë³„ë¡œ ê·¸ë£¹í™”
              const blocksByDay = blocks.reduce((acc, block) => {
                const day = block.day_of_week;
                if (!acc[day]) acc[day] = [];
                acc[day].push(block);
                return acc;
              }, {} as Record<number, typeof blocks>);

              return (
                <div className="flex flex-col gap-2 rounded-xl border border-gray-200 bg-white p-6">
                  <h3 className="text-sm font-semibold text-gray-900">
                    ë“±ë¡ëœ ì‹œê°„ ë¸”ë¡ ({blocks.length}ê°œ)
                  </h3>
                  <div className="space-y-2">
                    {Object.entries(blocksByDay).map(([day, dayBlocks]) => (
                      <div key={day} className="space-y-1">
                        {dayBlocks.map((block) => (
                          <div
                            key={block.id}
                            className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
                          >
                            <div className="flex-1">
                              <span className="text-xs font-medium text-gray-900">
                                {dayNames[Number(day)]}ìš”ì¼:
                              </span>{" "}
                              <span className="text-xs text-gray-600">
                                {block.start_time} ~ {block.end_time}
                              </span>
                            </div>
                            <button
                              type="button"
                              onClick={() => handleDeleteBlock(block.id)}
                              disabled={isPending}
                              className="text-xs text-red-600 hover:text-red-800 disabled:opacity-50"
                            >
                              ì‚­ì œ
                            </button>
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
              );
            })()}

            {/* ì‹œê°„ ë¸”ë¡ ì¶”ê°€ */}
            <div className="flex flex-col gap-3 rounded-xl border border-gray-200 bg-white p-6">
              <h3 className="text-sm font-semibold text-gray-900">
                ì‹œê°„ ë¸”ë¡ ì¶”ê°€
              </h3>
              {/* ... (ìš”ì¼ ì„ íƒ/ì‹œê°„ ì…ë ¥ UI ë™ì¼) */}
              <WeekdaySelector
                selectedWeekdays={selectedWeekdays}
                onToggle={toggleWeekday}
                onSelectAll={selectAllWeekdays}
                onSelectWeekdays={selectWeekdays}
                onSelectWeekends={selectWeekends}
              />

              <div className="grid grid-cols-2 gap-3">
                <div className="flex flex-col gap-1">
                  <label className="block text-xs font-medium text-gray-900">
                    ì‹œì‘ ì‹œê°„
                  </label>
                  <input
                    type="time"
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
                    value={blockStartTime}
                    onChange={(e) => setBlockStartTime(e.target.value)}
                  />
                </div>
                <div className="flex flex-col gap-1">
                  <label className="block text-xs font-medium text-gray-900">
                    ì¢…ë£Œ ì‹œê°„
                  </label>
                  <input
                    type="time"
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
                    value={blockEndTime}
                    onChange={(e) => setBlockEndTime(e.target.value)}
                  />
                </div>
              </div>

              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={() => {
                    setBlockSetMode("select");
                    setEditingBlockSetId(null);
                    setEditingBlockSetName("");
                    setAddedBlocks([]);
                    setBlockStartTime("");
                    setBlockEndTime("");
                    setSelectedWeekdays([]);
                  }}
                  className="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50"
                >
                  ì·¨ì†Œ(ëª©ë¡ìœ¼ë¡œ)
                </button>
                <button
                  type="button"
                  onClick={handleAddBlocksToSet}
                  disabled={
                    selectedWeekdays.length === 0 ||
                    !blockStartTime ||
                    !blockEndTime
                  }
                  className="flex-1 rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
                >
                  ë¸”ë¡ ì¶”ê°€
                </button>
              </div>
            </div>
          </div>
        )}
        </div>
      </CollapsibleSection>

      {/* ë¸”ë¡ ì„¸íŠ¸ ì„¤ëª… ë‹¤ì´ì–¼ë¡œê·¸ */}
      <Dialog
        open={showBlockSetDescDialog}
        onOpenChange={setShowBlockSetDescDialog}
      >
        <div className="space-y-4">
          <h3 className="text-lg font-semibold text-gray-900">
            ë¸”ë¡ ì„¸íŠ¸ë€?
          </h3>
          <p className="text-sm text-gray-600">
            ë¸”ë¡ ì„¸íŠ¸ëŠ” í•™ìŠµ ê°€ëŠ¥í•œ ì‹œê°„ëŒ€ë¥¼ ë¯¸ë¦¬ ì •ì˜í•´ë‘” í…œí”Œë¦¿ì…ë‹ˆë‹¤.
            <br />
            í•™ìƒì˜ ìƒí™œ íŒ¨í„´(í•™êµ ë“±êµ, í•™ì› ì‹œê°„ ë“±)ì„ ê³ ë ¤í•˜ì—¬ í•™ìŠµ ê°€ëŠ¥í•œ
            ì‹œê°„ì„ ì„¤ì •í•˜ë©´, í•´ë‹¹ ì‹œê°„ ë‚´ì—ì„œ ì½˜í…ì¸ ê°€ ìë™ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤.
          </p>
          <div className="flex flex-col gap-2 rounded-lg bg-gray-50 p-4">
            <h4 className="text-sm font-medium text-gray-900">
              ì‚¬ìš© ì˜ˆì‹œ
            </h4>
            <ul className="list-disc space-y-1 pl-4 text-xs text-gray-600">
              <li>
                <strong>í•™ê¸°ì¤‘ (í‰ì¼):</strong> ë°©ê³¼ í›„ 17:00 ~ 22:00
              </li>
              <li>
                <strong>í•™ê¸°ì¤‘ (ì£¼ë§):</strong> ì˜¤ì „ 10:00 ~ 22:00
              </li>
              <li>
                <strong>ë°©í•™ì¤‘:</strong> ì˜¤ì „ 09:00 ~ 22:00
              </li>
            </ul>
          </div>
        </div>
      </Dialog>
    </>
  );
}
</file>

<file path="new-group/_components/Step1BasicInfo/index.ts">
export { Step1BasicInfo } from "./Step1BasicInfo";
</file>

<file path="new-group/_components/Step1BasicInfo/PeriodSection.tsx">
import { CollapsibleSection } from "../_summary/CollapsibleSection";
import { WizardData } from "../PlanGroupWizard";
import { usePeriodCalculation } from "./hooks/usePeriodCalculation";
import { getTodayParts, formatDateString, addDaysToDate } from "@/lib/utils/date";
import { DateInput } from "../_shared/DateInput";
import { FieldErrors } from "../hooks/useWizardValidation";
import { FieldError } from "../_shared/FieldError";
import { cn } from "@/lib/cn";

type PeriodSectionProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  editable: boolean;
  isCampMode: boolean;
  isTemplateMode: boolean;
  periodCalculation: ReturnType<typeof usePeriodCalculation>;
  toggleFieldControl: (fieldName: string) => void;
  canStudentInputPeriod: boolean;
  isFieldLocked: (fieldName: string) => boolean;
  isDisabled: (condition?: boolean) => boolean;
  lockedFields: Record<string, boolean | undefined>;
  showError: (message: string) => void;
  canStudentInputAdditionalPeriodReallocation: boolean;
  fieldErrors?: FieldErrors;
};

export function PeriodSection({
  data,
  onUpdate,
  editable,
  isCampMode,
  isTemplateMode,
  periodCalculation,
  toggleFieldControl,
  canStudentInputPeriod,
  isFieldLocked,
  isDisabled,
  lockedFields,
  showError,
  canStudentInputAdditionalPeriodReallocation,
  fieldErrors,
}: PeriodSectionProps) {
  const {
    periodInputType,
    ddayState,
    weeksState,
    directState,
    setPeriodInputType,
    setDdayState,
    setWeeksState,
    setDirectState,
    calculatePeriodFromWeeks,
    calculatePeriodFromDday,
  } = periodCalculation;

  // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ë¡œì»¬ íƒ€ì„ì¡´ ê¸°ì¤€ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° (íƒ€ì„ì¡´ ë¬¸ì œ ë°©ì§€)
  const todayParts = getTodayParts();
  const today = formatDateString(
    todayParts.year,
    todayParts.month,
    todayParts.day
  );

  return (
    <CollapsibleSection
      title="í•™ìŠµ ê¸°ê°„ *"
      defaultOpen={true}
      studentInputAllowed={
        data.templateLockedFields?.step1?.allow_student_period === true
      }
      onStudentInputToggle={(enabled) =>
        toggleFieldControl("allow_student_period")
      }
      showStudentInputToggle={isTemplateMode}
    >
      <div className="space-y-6">
        {/* ê¸°ê°„ ì…ë ¥ ìœ í˜• ì„ íƒ */}
        <div
          className={`flex flex-wrap gap-2 ${
          isFieldLocked("period_start") ||
          isFieldLocked("period_end") ||
          (isCampMode && !canStudentInputPeriod)
            ? "opacity-60"
            : ""
        }`}
      >
        <button
          type="button"
          onClick={() => setPeriodInputType("dday")}
          disabled={isDisabled(
            isFieldLocked("period_start") ||
              isFieldLocked("period_end") ||
              (isCampMode && !canStudentInputPeriod)
          )}
          className={`rounded-lg border px-3 py-1.5 text-sm font-medium transition-colors ${
            periodInputType === "dday"
              ? "border-gray-900 bg-gray-900 text-white"
              : "border-gray-300 text-gray-800 hover:bg-gray-50"
          } ${
            isDisabled(
              isFieldLocked("period_start") ||
                isFieldLocked("period_end") ||
                (isCampMode && !canStudentInputPeriod)
            )
              ? "cursor-not-allowed opacity-60"
              : ""
          }`}
        >
          D-day
        </button>
        <button
          type="button"
          onClick={() => setPeriodInputType("weeks")}
          disabled={isDisabled(
            isFieldLocked("period_start") ||
              isFieldLocked("period_end") ||
              (isCampMode && !canStudentInputPeriod)
          )}
          className={`rounded-lg border px-3 py-1.5 text-sm font-medium transition-colors ${
            periodInputType === "weeks"
              ? "border-gray-900 bg-gray-900 text-white"
              : "border-gray-300 text-gray-800 hover:bg-gray-50"
          } ${
            isDisabled(
              isFieldLocked("period_start") ||
                isFieldLocked("period_end") ||
                (isCampMode && !canStudentInputPeriod)
            )
              ? "cursor-not-allowed opacity-60"
              : ""
          }`}
        >
          ì£¼ ë‹¨ìœ„
        </button>
        <button
          type="button"
          onClick={() => setPeriodInputType("direct")}
          disabled={isDisabled(
            isFieldLocked("period_start") ||
              isFieldLocked("period_end") ||
              (isCampMode && !canStudentInputPeriod)
          )}
          className={`rounded-lg border px-3 py-1.5 text-sm font-medium transition-colors ${
            periodInputType === "direct"
              ? "border-gray-900 bg-gray-900 text-white"
              : "border-gray-300 text-gray-800 hover:bg-gray-50"
          } ${
            isFieldLocked("period_start") ||
              isFieldLocked("period_end") ||
              (isCampMode && !canStudentInputPeriod)
              ? "cursor-not-allowed opacity-60"
              : ""
          }`}
        >
          ì§ì ‘ ì„ íƒ
        </button>
      </div>
      {(isFieldLocked("period_start") || isFieldLocked("period_end")) && (
        <p className="text-xs text-gray-600">
          í•™ìŠµ ê¸°ê°„ì€ í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        </p>
      )}
      {isCampMode && !canStudentInputPeriod && (
        <p className="text-xs text-gray-600">
          í•™ìŠµ ê¸°ê°„ì€ í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
      )}

      {/* D-day ì…ë ¥ */}
      {periodInputType === "dday" && (
        <div className="flex flex-col gap-2 rounded-xl border border-gray-200 bg-gray-50 p-6" data-field-id="period_start">
          <DateInput
            id="dday-date-input"
            label="ì‹œí—˜ì¼ ì…ë ¥"
            value={ddayState.date}
            onChange={(date) => {
              if (!editable) return;
              if (
                isFieldLocked("period_start") ||
                isFieldLocked("period_end") ||
                (isCampMode && !canStudentInputPeriod)
              )
                return;
              setDdayState({ date, calculated: !!date });
              if (date) {
                calculatePeriodFromDday(date);
              } else {
                onUpdate({
                  period_start: "",
                  period_end: "",
                  target_date: undefined,
                });
              }
            }}
            disabled={isDisabled(
              isFieldLocked("period_start") ||
              isFieldLocked("period_end") ||
              (isCampMode && !canStudentInputPeriod)
            )}
            min={today}
            error={fieldErrors?.get("period_start")}
            dataFieldId="period_start"
          />
          <FieldError error={fieldErrors?.get("period_start")} id="dday-date-input-error" />
          {ddayState.calculated && data.period_start && data.period_end && (
            <div className="flex flex-col gap-1 rounded-lg bg-white p-3">
              <div className="flex flex-col gap-1 text-sm text-gray-600">
                <div className="font-medium text-gray-800">í•™ìŠµ ê¸°ê°„</div>
                <div>
                  ì‹œì‘ì¼:{" "}
                  <span className="font-medium">{data.period_start}</span>
                </div>
                <div>
                  ì¢…ë£Œì¼:{" "}
                  <span className="font-medium">{data.period_end}</span>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* ì£¼ ë‹¨ìœ„ ì…ë ¥ */}
      {periodInputType === "weeks" && (
        <div className="flex flex-col gap-2 rounded-xl border border-gray-200 bg-gray-50 p-6" data-field-id="period_start">
          <DateInput
            id="weeks-start-date-input"
            label="ì‹œì‘ì¼ ì…ë ¥"
            value={weeksState.startDate}
            onChange={(startDate) => {
              if (!editable) return;
              if (
                isFieldLocked("period_start") ||
                isFieldLocked("period_end") ||
                (isCampMode && !canStudentInputPeriod)
              )
                return;
              setWeeksState({ ...weeksState, startDate });
              if (startDate) {
                calculatePeriodFromWeeks(weeksState.weeks, startDate);
              } else {
                onUpdate({ period_start: "", period_end: "" });
              }
            }}
            disabled={isDisabled(
              isFieldLocked("period_start") ||
              isFieldLocked("period_end") ||
              (isCampMode && !canStudentInputPeriod)
            )}
            min={today}
            error={fieldErrors?.get("period_start")}
            dataFieldId="period_start"
          />
          <FieldError error={fieldErrors?.get("period_start")} id="weeks-start-date-input-error" />

          {weeksState.startDate && (
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-900">
                í•™ìŠµ ì£¼ìˆ˜
              </label>
              <div className="flex items-center gap-3">
                <button
                  type="button"
                  onClick={() => {
                    if (!editable) return;
                    if (
                      isFieldLocked("period_start") ||
                      isFieldLocked("period_end") ||
                      (isCampMode && !canStudentInputPeriod)
                    )
                      return;
                    const newWeeks = Math.max(4, weeksState.weeks - 1);
                    setWeeksState({ ...weeksState, weeks: newWeeks });
                    calculatePeriodFromWeeks(newWeeks, weeksState.startDate);
                  }}
                  disabled={isDisabled(
                    weeksState.weeks <= 4 ||
                      isFieldLocked("period_start") ||
                      isFieldLocked("period_end") ||
                      (isCampMode && !canStudentInputPeriod)
                  )}
                  className="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-900 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  -
                </button>
                <div className="min-w-[80px] text-center font-medium text-gray-900">
                  {weeksState.weeks}ì£¼
                </div>
                <button
                  type="button"
                  onClick={() => {
                    if (!editable) return;
                    if (
                      isFieldLocked("period_start") ||
                      isFieldLocked("period_end") ||
                      (isCampMode && !canStudentInputPeriod)
                    )
                      return;
                    const newWeeks = weeksState.weeks + 1;
                    setWeeksState({ ...weeksState, weeks: newWeeks });
                    calculatePeriodFromWeeks(newWeeks, weeksState.startDate);
                  }}
                  disabled={isDisabled(
                    isFieldLocked("period_start") ||
                      isFieldLocked("period_end") ||
                      (isCampMode && !canStudentInputPeriod)
                  )}
                  className="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-900 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  +
                </button>
              </div>
              <p className="text-xs text-gray-600">
                ì¢…ë£Œì¼:{" "}
                <span className="font-medium">
                  {data.period_end || "ìë™ ê³„ì‚°ë¨"}
                </span>
              </p>
            </div>
          )}
        </div>
      )}

      {/* ì§ì ‘ ì…ë ¥ */}
      {periodInputType === "direct" && (
        <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
          <div className="grid grid-cols-2 gap-4">
            <div data-field-id="period_start">
              <DateInput
                id="direct-start-date-input"
                label="ì‹œì‘ì¼"
                value={directState.start}
                onChange={(start) => {
                  if (!editable) return;
                  if (
                    isFieldLocked("period_start") ||
                    (isCampMode && !canStudentInputPeriod)
                  )
                    return;
                  setDirectState({ ...directState, start });
                  onUpdate({ period_start: start });

                  // ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥´ë©´ ì´ˆê¸°í™”
                  if (directState.end && start > directState.end) {
                    setDirectState((prev) => ({ ...prev, end: "" }));
                    onUpdate({ period_end: "" });
                  }
                }}
                disabled={isDisabled(
                  isFieldLocked("period_start") ||
                    (isCampMode && !canStudentInputPeriod)
                )}
                min={today}
                error={fieldErrors?.get("period_start")}
                dataFieldId="period_start"
              />
              <FieldError error={fieldErrors?.get("period_start")} id="direct-start-date-input-error" />
            </div>
            <div data-field-id="period_end">
              <DateInput
                id="direct-end-date-input"
                label="ì¢…ë£Œì¼"
                value={directState.end}
                onChange={(end) => {
                  if (!editable) return;
                  if (
                    isFieldLocked("period_end") ||
                    (isCampMode && !canStudentInputPeriod)
                  )
                    return;
                  setDirectState({ ...directState, end });
                  onUpdate({ period_end: end });
                }}
                disabled={isDisabled(
                  !directState.start ||
                    isFieldLocked("period_end") ||
                    (isCampMode && !canStudentInputPeriod)
                )}
                min={directState.start || today}
                error={fieldErrors?.get("period_end")}
                dataFieldId="period_end"
              />
              <FieldError error={fieldErrors?.get("period_end")} id="direct-end-date-input-error" />
            </div>
          </div>
        </div>
      )}
      
      {/* ì¶”ê°€ ê¸°ê°„ í•™ìŠµ ë²”ìœ„ ì¬ë°°ì¹˜ (1730 Timetable) */}
      {data.scheduler_type === "1730_timetable" && (
        <div>
          <CollapsibleSection
            title="ì¶”ê°€ ê¸°ê°„ í•™ìŠµ ë²”ìœ„ ì¬ë°°ì¹˜ (ì„ íƒì‚¬í•­)"
            defaultOpen={!!data.additional_period_reallocation}
            studentInputAllowed={
              lockedFields.allow_student_additional_period_reallocation === true
            }
            onStudentInputToggle={(enabled) => {
              if (!data.additional_period_reallocation && enabled) {
                showError("ì¬ë°°ì¹˜ ì‚¬ìš©ì„ ë¨¼ì € ì²´í¬í•´ì£¼ì„¸ìš”.");
                return;
              }
              toggleFieldControl("allow_student_additional_period_reallocation");
            }}
            showStudentInputToggle={
              isTemplateMode && !!data.additional_period_reallocation
            }
            headerActions={
              <label
                className="flex items-center gap-2 text-xs text-gray-800"
                onClick={(e) => e.stopPropagation()}
              >
                <input
                  type="checkbox"
                  id="enable_additional_period"
                  checked={!!data.additional_period_reallocation}
                  onChange={(e) => {
                    if (
                      isCampMode &&
                      !canStudentInputAdditionalPeriodReallocation
                    )
                      return;
                    if (e.target.checked) {
                      if (!data.period_start || !data.period_end) {
                        showError("í•™ìŠµ ê¸°ê°„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        e.target.checked = false;
                        return;
                      }
                      if (!data.period_start || !data.period_end) {
                        showError(
                          "ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤. í•™ìŠµ ê¸°ê°„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”."
                        );
                        e.target.checked = false;
                        return;
                      }

                      const fourWeeksEndStr = addDaysToDate(
                        data.period_start,
                        28
                      );
                      const originalEndStr =
                        fourWeeksEndStr > data.period_end
                          ? data.period_end
                          : fourWeeksEndStr;

                      onUpdate({
                        additional_period_reallocation: {
                          period_start: "",
                          period_end: "",
                          type: "additional_review",
                          original_period_start: data.period_start,
                          original_period_end: originalEndStr,
                          review_of_review_factor: 0.25,
                        },
                      });
                    } else {
                      onUpdate({ additional_period_reallocation: undefined });
                    }
                  }}
                  disabled={
                    (isCampMode &&
                      !canStudentInputAdditionalPeriodReallocation) ||
                    !data.period_start ||
                    !data.period_end ||
                    isNaN(new Date(data.period_start).getTime()) ||
                    isNaN(new Date(data.period_end).getTime())
                  }
                  className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-60"
                />
                <span
                  className={
                    isCampMode && !canStudentInputAdditionalPeriodReallocation
                      ? "text-gray-900"
                      : ""
                  }
                >
                  ì¬ë°°ì¹˜ ì‚¬ìš©
                </span>
              </label>
            }
          >
            <div className="space-y-4">
              <p className="text-xs text-gray-600">
                ì¶”ê°€ ê¸°ê°„ì€ ë³µìŠµì¼ë¡œ ê³„ì‚°ë˜ë©°, í•™ìŠµ ê¸°ê°„ì— ë°°ì •ëœ ì½˜í…ì¸ 
                ë²”ìœ„ë¥¼ ì¶”ê°€ ê¸°ê°„ì— ë‹¤ì‹œ ë¶„í•  ë°°ì¹˜í•©ë‹ˆë‹¤.
                <br />
                í•™ìŠµ ê¸°ê°„ + ì¶”ê°€ ê¸°ê°„ì´ ì „ì²´ í•™ìŠµ ê¸°ê°„ì´ ë©ë‹ˆë‹¤.
              </p>

              {data.additional_period_reallocation && (
                <div className="flex flex-col gap-3 rounded-xl border border-gray-200 bg-white p-6">
                  <div className="grid grid-cols-2 gap-3">
                    <DateInput
                      id="additional-period-start-input"
                      label="ì¶”ê°€ ê¸°ê°„ ì‹œì‘ì¼"
                      labelClassName="text-xs"
                      value={data.additional_period_reallocation.period_start}
                      onChange={(newStartDate) => {
                        if (
                          isCampMode &&
                          !canStudentInputAdditionalPeriodReallocation
                        )
                          return;

                        const minDate = data.period_end
                          ? addDaysToDate(data.period_end, 1)
                          : null;

                        if (minDate && newStartDate < minDate) {
                          showError(
                            "ì¶”ê°€ ê¸°ê°„ ì‹œì‘ì¼ì€ í•™ìŠµ ê¸°ê°„ ì¢…ë£Œì¼ ë‹¤ìŒë‚ ë¶€í„° ê°€ëŠ¥í•©ë‹ˆë‹¤."
                          );
                          return;
                        }

                        let newEndDate =
                          data.additional_period_reallocation?.period_end || "";
                        if (newEndDate && newEndDate < newStartDate) {
                          newEndDate = addDaysToDate(newStartDate, 1);
                        }

                        onUpdate({
                          additional_period_reallocation: {
                            ...data.additional_period_reallocation!,
                            period_start: newStartDate,
                            period_end: newEndDate || addDaysToDate(newStartDate, 1),
                          },
                        });
                      }}
                      disabled={
                        isCampMode &&
                        !canStudentInputAdditionalPeriodReallocation
                      }
                      min={
                        data.period_end
                          ? addDaysToDate(data.period_end, 1)
                          : undefined
                      }
                    />
                    <DateInput
                      id="additional-period-end-input"
                      label="ì¶”ê°€ ê¸°ê°„ ì¢…ë£Œì¼"
                      labelClassName="text-xs"
                      value={data.additional_period_reallocation.period_end}
                      onChange={(newEndDate) => {
                        if (
                          isCampMode &&
                          !canStudentInputAdditionalPeriodReallocation
                        )
                          return;

                        const minDate = data.additional_period_reallocation
                          ?.period_start
                          ? addDaysToDate(
                              data.additional_period_reallocation!
                                .period_start,
                              1
                            )
                          : null;

                        if (minDate && newEndDate < minDate) {
                          showError(
                            "ì¶”ê°€ ê¸°ê°„ ì¢…ë£Œì¼ì€ ì¶”ê°€ ê¸°ê°„ ì‹œì‘ì¼ ë‹¤ìŒë‚ ë¶€í„° ê°€ëŠ¥í•©ë‹ˆë‹¤."
                          );
                          return;
                        }

                        onUpdate({
                          additional_period_reallocation: {
                            ...data.additional_period_reallocation!,
                            period_end: newEndDate,
                          },
                        });
                      }}
                      disabled={
                        isCampMode &&
                        !canStudentInputAdditionalPeriodReallocation
                      }
                      min={
                        data.additional_period_reallocation.period_start
                          ? addDaysToDate(
                              data.additional_period_reallocation
                                .period_start,
                              1
                            )
                          : undefined
                      }
                    />
                  </div>

                  <div className="flex flex-col gap-1 rounded-lg border border-blue-200 bg-blue-50 p-4">
                    <p className="text-xs text-blue-800">
                      <strong>ì¬ë°°ì¹˜ ë²”ìœ„:</strong>{" "}
                      {
                        data.additional_period_reallocation
                          .original_period_start
                      }{" "}
                      ~{" "}
                      {
                        data.additional_period_reallocation
                          .original_period_end
                      }
                    </p>
                    <p className="text-xs text-blue-800">
                      í•™ìŠµ ê¸°ê°„ì˜ ì½˜í…ì¸ ë¥¼ ì¶”ê°€ ê¸°ê°„ì— ì¬ë°°ì¹˜í•˜ì—¬ ë³µìŠµì„
                      ì§„í–‰í•©ë‹ˆë‹¤.
                    </p>
                    <p className="text-xs text-blue-800">
                      ë³µìŠµ ì†Œìš”ì‹œê°„ì€ ì›ë³¸ í•™ìŠµ ì†Œìš”ì‹œê°„ì˜ 25%ë¡œ ìë™
                      ê³„ì‚°ë©ë‹ˆë‹¤.
                    </p>
                  </div>
                </div>
              )}

              {isCampMode && !canStudentInputAdditionalPeriodReallocation && (
                <p className="text-xs text-gray-600">
                  ì¶”ê°€ ê¸°ê°„ í•™ìŠµ ë²”ìœ„ ì¬ë°°ì¹˜ëŠ” í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜
                  ì—†ìŠµë‹ˆë‹¤.
                </p>
              )}
            </div>
          </CollapsibleSection>
        </div>
      )}
      </div>
    </CollapsibleSection>
  );
}
</file>

<file path="new-group/_components/Step1BasicInfo/Step1BasicInfo.tsx">
import { useState } from "react";
import { WizardData } from "../PlanGroupWizard";
import { BlockSetSection } from "./BlockSetSection";
import { PeriodSection } from "./PeriodSection";
import { useBlockSetManagement } from "./hooks/useBlockSetManagement";
import { useToast } from "@/components/ui/ToastProvider";
import { Dialog } from "@/components/ui/Dialog";
import {
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";
import { BlockSetTimeline } from "../_shared/BlockSetTimeline";
import { CollapsibleSection } from "../_summary/CollapsibleSection";

import {
  formatDateFromDate,
  parseDateString as parseDateStringUtil,
  getTodayParts,
  formatDateString,
  addDaysToDate,
} from "@/lib/utils/date";
import { usePeriodCalculation } from "./hooks/usePeriodCalculation";
import { FieldErrors } from "../hooks/useWizardValidation";
import { FieldError } from "../_shared/FieldError";
import { getFieldErrorClasses } from "../_shared/fieldErrorUtils";
import { cn } from "@/lib/cn";
import { isFieldLocked, canStudentInput, toggleFieldControl as toggleFieldControlUtil, updateFieldLock } from "../utils/fieldLockUtils";
import type { TemplateLockedFields } from "../PlanGroupWizard";

type Step1BasicInfoProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  blockSets: Array<{
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  }>;
  onBlockSetCreated?: (blockSet: { id: string; name: string }) => void;
  onBlockSetsLoaded?: (
    blockSets: Array<{
      id: string;
      name: string;
      blocks?: Array<{
        id: string;
        day_of_week: number;
        start_time: string;
        end_time: string;
      }>;
    }>
  ) => void;
  editable?: boolean;
  campTemplateInfo?: {
    name: string;
    program_type: string;
  };
  isTemplateMode?: boolean;
  templateId?: string; // í…œí”Œë¦¿ ID (í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œ í•„ìš”)
  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ ê´€ë ¨
  isCampMode?: boolean; // í•™ìƒ ëª¨ë“œì—ì„œ ê³ ì • í•„ë“œ ìˆ˜ì • ë°©ì§€
  fieldErrors?: FieldErrors;
};



const planPurposes = [
  { value: "ë‚´ì‹ ëŒ€ë¹„", label: "ë‚´ì‹ ëŒ€ë¹„" },
  { value: "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)", label: "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)" },
] as const;

const schedulerTypes = [
  { value: "1730_timetable", label: "1730 Timetable" },
] as const;

export function Step1BasicInfo({
  data,
  onUpdate,
  blockSets,
  onBlockSetCreated,
  onBlockSetsLoaded,
  editable = true,
  campTemplateInfo,
  isTemplateMode = false,
  templateId,
  isCampMode = false,
  fieldErrors,
}: Step1BasicInfoProps) {
  const { showError } = useToast();

  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ í™•ì¸
  // templateLockedFieldsê°€ ì—†ê±°ë‚˜ step1ì´ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™” (ëª¨ë“  í•„ë“œ ì…ë ¥ ê°€ëŠ¥)
  const lockedFields = data.templateLockedFields?.step1 || {};

  // í•„ë“œê°€ ê³ ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©)
  const checkFieldLocked = (fieldName: string) => {
    return isFieldLocked(fieldName, lockedFields, isCampMode);
  };

  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•™ìƒ ì…ë ¥ í—ˆìš© í† ê¸€ (ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©)
  const toggleFieldControl = (fieldName: keyof NonNullable<TemplateLockedFields["step1"]>) => {
    if (!isTemplateMode) return;

    const currentLocked = data.templateLockedFields?.step1;
    const newLocked = toggleFieldControlUtil(fieldName, currentLocked);
    onUpdate(updateFieldLock(data, newLocked));
  };

  // ì²´í¬ë°•ìŠ¤ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜
  const renderStudentInputCheckbox = (fieldName: keyof typeof lockedFields) => {
    if (!isTemplateMode) return null;

    return (
      <label className="flex items-center gap-2 text-xs text-gray-800">
        <input
          type="checkbox"
          checked={lockedFields[fieldName] === true}
          onChange={() => toggleFieldControl(fieldName)}
          className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900"
        />
        <span>í•™ìƒ ì…ë ¥ í—ˆìš©</span>
      </label>
    );
  };

  // editable={false}ì¼ ë•Œ ëª¨ë“  í•„ë“œ ë¹„í™œì„±í™”
  const isDisabled = (additionalCondition: boolean = false) => {
    return !editable || additionalCondition;
  };

  // í•™ìƒ ëª¨ë“œì—ì„œ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©)
  const checkCanStudentInput = (fieldName: keyof NonNullable<TemplateLockedFields["step1"]>): boolean => {
    return canStudentInput(fieldName, lockedFields, editable, isCampMode);
  };

  // ê° í•„ë“œë³„ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€ (ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©)
  const canStudentInputName = checkCanStudentInput("allow_student_name");
  const canStudentInputPlanPurpose = checkCanStudentInput(
    "allow_student_plan_purpose"
  );
  const canStudentInputSchedulerType = checkCanStudentInput(
    "allow_student_scheduler_type"
  );
  const canStudentInputPeriod = checkCanStudentInput("allow_student_period");
  const canStudentInputBlockSetId = checkCanStudentInput(
    "allow_student_block_set_id"
  );
  const canStudentInputStudentLevel = checkCanStudentInput(
    "allow_student_student_level"
  );
  const canStudentInputSubjectAllocations = checkCanStudentInput(
    "allow_student_subject_allocations"
  );
  const canStudentInputStudyReviewCycle = checkCanStudentInput(
    "allow_student_study_review_cycle"
  );
  const canStudentInputAdditionalPeriodReallocation = checkCanStudentInput(
    "allow_student_additional_period_reallocation"
  );

  // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ë¡œì»¬ íƒ€ì„ì¡´ ê¸°ì¤€ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° (íƒ€ì„ì¡´ ë¬¸ì œ ë°©ì§€)
  const todayParts = getTodayParts();
  const today = formatDateString(
    todayParts.year,
    todayParts.month,
    todayParts.day
  );


  /* Period calculation hook */
  const periodCalculation = usePeriodCalculation({ data, onUpdate, editable });

  /* block set state removed as it is now in useBlockSetManagement hook */
  const blockSetManagement = useBlockSetManagement({
    data,
    onUpdate,
    blockSets,
    onBlockSetCreated,
    onBlockSetsLoaded,
    isTemplateMode,
    isCampMode,
    templateId,
  });

  const [show1730Desc, setShow1730Desc] = useState(false);

  // Restore show1730Desc since it wasn't moved to the hook?
  // Checking `useBlockSetManagement.ts`... it does not have show1730Desc.
  // I need to keep show1730Desc here or add it to hook.
  // It's related to scheduler type, not block sets. So I keep it here.

  // Oops, I deleted it in the previous step? No, I am replacing the block set state block.
  // I should check if I am deleting show1730Desc.
  // In previous view, lines 241-253 contained `show1730Desc`.
  // My hook does NOT contain `show1730Desc`.
  // So I must re-declare `show1730Desc` here.



  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-semibold text-gray-900">
          {isCampMode ? "ìº í”„ ê¸°ë³¸ ì •ë³´" : "í”Œëœ ê¸°ë³¸ ì •ë³´"}
        </h2>
        <p className="text-sm text-gray-600">
          {isCampMode
            ? "ìº í”„ì˜ ëª©ì ê³¼ ê¸°ê°„, ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•ì„ ì„¤ì •í•´ì£¼ì„¸ìš”."
            : "í”Œëœì˜ ëª©ì ê³¼ ê¸°ê°„, ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•ì„ ì„¤ì •í•´ì£¼ì„¸ìš”."}
        </p>
      </div>

      {/* í”Œëœ/ìº í”„ ì´ë¦„ (í•„ìˆ˜) */}
      <CollapsibleSection
        title={`${isCampMode ? "ìº í”„ ì´ë¦„" : "í”Œëœ ì´ë¦„"} *`}
        defaultOpen={true}
        studentInputAllowed={lockedFields.allow_student_name === true}
        onStudentInputToggle={(enabled) =>
          toggleFieldControl("allow_student_name")
        }
        showStudentInputToggle={isTemplateMode}
      >
        <div className="flex flex-col gap-1" data-field-id="plan_name">
          <label
            htmlFor="plan_name"
            className="block text-sm font-medium text-gray-800"
          >
            {isCampMode ? "ìº í”„ ì´ë¦„" : "í”Œëœ ì´ë¦„"}{" "}
            <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="plan_name"
            className={cn(
              "w-full rounded-lg border px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:outline-none",
              getFieldErrorClasses(
                "border-gray-300 focus:border-gray-900",
                !!fieldErrors?.get("plan_name")
              ),
              (!editable && !isCampMode) ||
                checkFieldLocked("name") ||
                (isCampMode && !canStudentInputName)
                ? "cursor-not-allowed bg-gray-100 opacity-60"
                : ""
            )}
            placeholder="ì˜ˆ: 1í•™ê¸° ì¤‘ê°„ê³ ì‚¬ ëŒ€ë¹„"
            value={data.name || ""}
            onChange={(e) => {
              if (!editable) return;
              onUpdate({ name: e.target.value });
            }}
            disabled={isDisabled(
              checkFieldLocked("name") ||
              (isCampMode && !canStudentInputName)
            )}
            required
            aria-invalid={!!fieldErrors?.get("plan_name")}
            aria-describedby={fieldErrors?.get("plan_name") ? "plan_name-error" : undefined}
          />
          <FieldError
            error={fieldErrors?.get("plan_name")}
            id="plan_name-error"
          />
          {checkFieldLocked("name") && (
            <p className="text-xs text-gray-600">
              ì´ í•„ë“œëŠ” í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            </p>
          )}
          {isCampMode && !canStudentInputName && (
            <p className="text-xs text-gray-600">
              ì´ í•„ë“œëŠ” í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
          )}
        </div>
      </CollapsibleSection>

      {/* í”Œëœ ëª©ì  */}
      <CollapsibleSection
        title="í”Œëœ ëª©ì  *"
        defaultOpen={true}
        studentInputAllowed={lockedFields.allow_student_plan_purpose === true}
        onStudentInputToggle={(enabled) =>
          toggleFieldControl("allow_student_plan_purpose")
        }
        showStudentInputToggle={isTemplateMode}
      >
        <div
          className={
            !editable || !canStudentInputPlanPurpose ? "opacity-60" : ""
          }
          data-field-id="plan_purpose"
        >
          <div className="grid gap-3 md:grid-cols-3">
            {planPurposes.map((purpose) => (
              <label
                key={purpose.value}
                className={cn(
                  "flex items-center justify-center gap-2 rounded-lg border px-4 py-3 text-sm font-medium transition-colors",
                  !editable || !canStudentInputPlanPurpose
                    ? "cursor-not-allowed bg-gray-100"
                    : "cursor-pointer hover:border-gray-300",
                  data.plan_purpose === purpose.value
                    ? "border-gray-900 bg-gray-900 text-white"
                    : "border-gray-200 bg-white text-gray-800",
                  !!fieldErrors?.get("plan_purpose") &&
                    data.plan_purpose !== purpose.value &&
                    "border-red-500"
                )}
              >
                <input
                  type="radio"
                  name="plan_purpose"
                  value={purpose.value}
                  checked={data.plan_purpose === purpose.value}
                  onChange={() => {
                    if (!editable) return;
                    onUpdate({ plan_purpose: purpose.value as any });
                  }}
                  disabled={isDisabled(
                    isCampMode && !canStudentInputPlanPurpose
                  )}
                  className="hidden"
                  aria-invalid={!!fieldErrors?.get("plan_purpose")}
                  aria-describedby={fieldErrors?.get("plan_purpose") ? "plan_purpose-error" : undefined}
                />
                {purpose.label}
              </label>
            ))}
          </div>
          <FieldError
            error={fieldErrors?.get("plan_purpose")}
            id="plan_purpose-error"
          />
          {isCampMode && !canStudentInputPlanPurpose && (
            <p className="text-xs text-gray-600">
              ì´ í•„ë“œëŠ” í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
          )}
        </div>
      </CollapsibleSection>

      {/* í•™ìŠµ ê¸°ê°„ (ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•ë³´ë‹¤ ë¨¼ì €) */}
      <PeriodSection
        data={data}
        onUpdate={onUpdate}
        editable={editable}
        isCampMode={isCampMode}
        isTemplateMode={isTemplateMode}
        periodCalculation={periodCalculation}
        toggleFieldControl={toggleFieldControl as (fieldName: string) => void}
        canStudentInputPeriod={canStudentInputPeriod}
        isFieldLocked={checkFieldLocked}
        isDisabled={isDisabled}
        lockedFields={lockedFields || {}}
        showError={showError}
        canStudentInputAdditionalPeriodReallocation={
          canStudentInputAdditionalPeriodReallocation
        }
        fieldErrors={fieldErrors}
      />




      {/* ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜• */}
      <CollapsibleSection
        title="ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜• *"
        defaultOpen={false}
        studentInputAllowed={lockedFields.allow_student_scheduler_type === true}
        onStudentInputToggle={(enabled) =>
          toggleFieldControl("allow_student_scheduler_type")
        }
        showStudentInputToggle={isTemplateMode}
      >
        {/* ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜• ì„ íƒ (í•œ ì¤„) */}
        <div
          className={cn(
            "flex gap-2",
            isCampMode && !canStudentInputSchedulerType ? "opacity-60" : ""
          )}
          data-field-id="scheduler_type"
        >
          {schedulerTypes.map((type) => (
            <label
              key={type.value}
              className={cn(
                "flex-1 rounded-lg border px-4 py-3 text-center text-sm font-medium transition-colors",
                isCampMode && !canStudentInputSchedulerType
                  ? "cursor-not-allowed bg-gray-100"
                  : "cursor-pointer hover:border-gray-300",
                data.scheduler_type === type.value
                  ? "border-gray-900 bg-gray-900 text-white"
                  : "border-gray-200 text-gray-900",
                !!fieldErrors?.get("scheduler_type") &&
                  data.scheduler_type !== type.value &&
                  "border-red-500"
              )}
            >
              <input
                type="radio"
                name="scheduler_type"
                value={type.value}
                checked={data.scheduler_type === type.value}
                onChange={() => {
                  if (!editable) return;
                  if (isCampMode && !canStudentInputSchedulerType) return;
                  onUpdate({
                    scheduler_type: type.value as any,
                    scheduler_options: undefined, // ìœ í˜• ë³€ê²½ ì‹œ ì˜µì…˜ ì´ˆê¸°í™”
                  });
                  // ìœ í˜• ë³€ê²½ ì‹œ ì„¤ëª…ë„ ì´ˆê¸°í™”
                  setShow1730Desc(false);
                }}
                disabled={isDisabled(isCampMode && !canStudentInputSchedulerType)}
                className="hidden"
                aria-invalid={!!fieldErrors?.get("scheduler_type")}
                aria-describedby={fieldErrors?.get("scheduler_type") ? "scheduler_type-error" : undefined}
              />
              {type.label}
            </label>
          ))}
        </div>
        <FieldError
          error={fieldErrors?.get("scheduler_type")}
          id="scheduler_type-error"
        />
        {isCampMode && !canStudentInputSchedulerType && (
          <p className="text-xs text-gray-600">
            ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•ì€ í…œí”Œë¦¿ì—ì„œ ê³ ì •ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </p>
        )}

        {data.scheduler_type === "1730_timetable" && (
          <div className="space-y-4">
            {/* ì„¤ëª… í† ê¸€ */}
            <div>
              <button
                type="button"
                onClick={() => {
                  if (!editable) return;
                  setShow1730Desc(!show1730Desc);
                }}
                className="flex w-full items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50"
              >
                <span>
                  1730 Timetable ë™ì‘ ë°©ì‹ {show1730Desc ? "ìˆ¨ê¸°ê¸°" : "ë³´ê¸°"}
                </span>
                <span className="text-gray-900">
                  {show1730Desc ? "â–²" : "â–¼"}
                </span>
              </button>

              {show1730Desc && (
                <div className="flex flex-col gap-3 rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm">
                  <h4 className="font-semibold text-blue-800">
                    1730 Timetable ë™ì‘ ë°©ì‹
                  </h4>
                  <ul className="flex flex-col gap-2 text-blue-800">
                    <li className="flex items-start gap-2">
                      <span>â€¢</span>
                      <span>
                        ì£¼ ë‹¨ìœ„ë¡œ í•™ìŠµê³¼ ë³µìŠµì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ”
                        ìŠ¤ì¼€ì¤„ëŸ¬ì…ë‹ˆë‹¤.
                      </span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span>â€¢</span>
                      <span>
                        ê¸°ë³¸ì ìœ¼ë¡œ <strong>6ì¼ í•™ìŠµ + 1ì¼ ë³µìŠµ</strong> íŒ¨í„´ìœ¼ë¡œ
                        êµ¬ì„±ë©ë‹ˆë‹¤.
                      </span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span>â€¢</span>
                      <span>
                        í•™ìŠµì¼ì—ëŠ” ìƒˆë¡œìš´ ì½˜í…ì¸ ë¥¼ ìˆœí™˜ ë°°ì •í•˜ì—¬ ë‹¤ì–‘í•œ ê³¼ëª©ì„
                        í•™ìŠµí•©ë‹ˆë‹¤.
                      </span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span>â€¢</span>
                      <span>
                        ë³µìŠµì¼ì—ëŠ” í•´ë‹¹ ì£¼ì— í•™ìŠµí•œ ë‚´ìš©ì„ ë³µìŠµí•˜ì—¬ í•™ìŠµ íš¨ê³¼ë¥¼
                        ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.
                      </span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span>â€¢</span>
                      <span>
                        í•™ìŠµì¼ê³¼ ë³µìŠµì¼ì˜ ë¹„ìœ¨ì„ ì¡°ì ˆí•˜ì—¬ ìì‹ ì—ê²Œ ë§ëŠ” í•™ìŠµ
                        íŒ¨í„´ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í•™ìŠµì¼ + ë³µìŠµì¼ = 7ì¼)
                      </span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span>â€¢</span>
                      <span>
                        ì •ê¸°ì ì¸ ë³µìŠµì„ í†µí•´ ì¥ê¸° ê¸°ì–µ ê°•í™”ì™€ í•™ìŠµ ë‚´ìš©ì˜ ì™„ì „í•œ
                        ì´í•´ë¥¼ ë„ëª¨í•©ë‹ˆë‹¤.
                      </span>
                    </li>
                  </ul>
                </div>
              )}
            </div>

            {/* ì˜µì…˜ */}
            <div className="flex flex-col gap-4 rounded-xl border border-gray-200 bg-gray-50 p-6">
              <div className="flex items-center justify-between">
                <h3 className="text-sm font-semibold text-gray-900">
                  1730 Timetable ì˜µì…˜
                </h3>
                {renderStudentInputCheckbox("allow_student_study_review_cycle")}
              </div>
              <div
                className={`flex flex-col gap-4 ${
                  isCampMode && !canStudentInputStudyReviewCycle
                    ? "opacity-60"
                    : ""
                }`}
              >
                <div className="flex flex-col gap-2">
                  <label className="block text-xs font-medium text-gray-900">
                    í•™ìŠµì¼ ìˆ˜
                  </label>
                  <div className="flex items-center gap-3">
                    <button
                      type="button"
                      onClick={() => {
                        if (!editable) return;
                        if (isCampMode && !canStudentInputStudyReviewCycle)
                          return;
                        const currentStudyDays =
                          data.scheduler_options?.study_days ??
                          data.study_review_cycle?.study_days ??
                          6;
                        const newStudyDays = Math.max(1, currentStudyDays - 1);
                        const newReviewDays = 7 - newStudyDays;
                        onUpdate({
                          scheduler_options: {
                            ...data.scheduler_options,
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                          study_review_cycle: {
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                        });
                      }}
                      disabled={isDisabled(
                        (data.scheduler_options?.study_days ??
                          data.study_review_cycle?.study_days ??
                          6) <= 1 ||
                        (isCampMode && !canStudentInputStudyReviewCycle)
                      )}
                      className="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-900 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      âˆ’
                    </button>
                    <div className="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-center text-sm font-semibold text-gray-800">
                      {data.scheduler_options?.study_days ??
                        data.study_review_cycle?.study_days ??
                        6}
                      ì¼
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        if (!editable) return;
                        if (isCampMode && !canStudentInputStudyReviewCycle)
                          return;
                        const currentStudyDays =
                          data.scheduler_options?.study_days ??
                          data.study_review_cycle?.study_days ??
                          6;
                        const newStudyDays = Math.min(6, currentStudyDays + 1);
                        const newReviewDays = 7 - newStudyDays;
                        onUpdate({
                          scheduler_options: {
                            ...data.scheduler_options,
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                          study_review_cycle: {
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                        });
                      }}
                      disabled={isDisabled(
                        (data.scheduler_options?.study_days ??
                          data.study_review_cycle?.study_days ??
                          6) >= 6 ||
                        (isCampMode && !canStudentInputStudyReviewCycle)
                      )}
                      className="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-900 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div className="flex flex-col gap-1">
                  <label className="block text-xs font-medium text-gray-900">
                    ë³µìŠµì¼ ìˆ˜
                  </label>
                  <div className="flex items-center gap-3">
                    <button
                      type="button"
                      onClick={() => {
                        if (!editable) return;
                        if (isCampMode && !canStudentInputStudyReviewCycle)
                          return;
                        const currentReviewDays =
                          data.scheduler_options?.review_days ??
                          data.study_review_cycle?.review_days ??
                          1;
                        const newReviewDays = Math.max(
                          1,
                          currentReviewDays - 1
                        );
                        const newStudyDays = 7 - newReviewDays;
                        onUpdate({
                          scheduler_options: {
                            ...data.scheduler_options,
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                          study_review_cycle: {
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                        });
                      }}
                      disabled={isDisabled(
                        (data.scheduler_options?.review_days ??
                          data.study_review_cycle?.review_days ??
                          1) <= 1 ||
                        (isCampMode && !canStudentInputStudyReviewCycle)
                      )}
                      className="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-900 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      âˆ’
                    </button>
                    <div className="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-center text-sm font-semibold text-gray-800">
                      {data.scheduler_options?.review_days ??
                        data.study_review_cycle?.review_days ??
                        1}
                      ì¼
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        if (!editable) return;
                        if (isCampMode && !canStudentInputStudyReviewCycle)
                          return;
                        const currentReviewDays =
                          data.scheduler_options?.review_days ??
                          data.study_review_cycle?.review_days ??
                          1;
                        const newReviewDays = Math.min(
                          6,
                          currentReviewDays + 1
                        );
                        const newStudyDays = 7 - newReviewDays;
                        onUpdate({
                          scheduler_options: {
                            ...data.scheduler_options,
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                          study_review_cycle: {
                            study_days: newStudyDays,
                            review_days: newReviewDays,
                          },
                        });
                      }}
                      disabled={isDisabled(
                        (data.scheduler_options?.review_days ??
                          data.study_review_cycle?.review_days ??
                          1) >= 6 ||
                        (isCampMode && !canStudentInputStudyReviewCycle)
                      )}
                      className="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-900 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      +
                    </button>
                  </div>
                  <p className="text-xs text-gray-600">
                    í•™ìŠµì¼ + ë³µìŠµì¼ = 7ì¼ë¡œ ê³ ì •ë©ë‹ˆë‹¤. ë³µìŠµì¼ì€ ìµœì†Œ 1ì¼ì´ì–´ì•¼
                    í•©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </CollapsibleSection>

      {/* ë¸”ë¡ ì„¸íŠ¸ ì„¹ì…˜ */}
      <BlockSetSection
        data={data}
        onUpdate={onUpdate}
        blockSets={blockSets}
        management={blockSetManagement}
        editable={editable}
        isCampMode={isCampMode}
        isTemplateMode={isTemplateMode}
        toggleFieldControl={toggleFieldControl as (fieldName: string) => void}
        canStudentInputBlockSetId={canStudentInputBlockSetId}
        lockedFields={lockedFields}
      />

    </div>
  );
}
</file>

<file path="new-group/_components/Step1BasicInfo/WeekdaySelector.tsx">
"use client";

type WeekdaySelectorProps = {
  selectedWeekdays: number[];
  onToggle: (day: number) => void;
  onSelectAll: () => void;
  onSelectWeekdays: () => void;
  onSelectWeekends: () => void;
  disabled?: boolean;
};

export function WeekdaySelector({
  selectedWeekdays,
  onToggle,
  onSelectAll,
  onSelectWeekdays,
  onSelectWeekends,
  disabled = false,
}: WeekdaySelectorProps) {
  const days = [
    { value: 0, label: "ì¼" },
    { value: 1, label: "ì›”" },
    { value: 2, label: "í™”" },
    { value: 3, label: "ìˆ˜" },
    { value: 4, label: "ëª©" },
    { value: 5, label: "ê¸ˆ" },
    { value: 6, label: "í† " },
  ];

  return (
    <div className="flex flex-col gap-2">
      <label className="block text-xs font-medium text-gray-900">
        ì¶”ê°€í•  ìš”ì¼ ì„ íƒ
      </label>
      <div className="flex flex-wrap gap-2">
        <button
          type="button"
          onClick={onSelectAll}
          disabled={disabled}
          className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-800 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-60"
        >
          ì „ì²´ ì„ íƒ
        </button>
        <button
          type="button"
          onClick={onSelectWeekdays}
          disabled={disabled}
          className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-800 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-60"
        >
          í‰ì¼
        </button>
        <button
          type="button"
          onClick={onSelectWeekends}
          disabled={disabled}
          className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-800 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-60"
        >
          ì£¼ë§
        </button>
      </div>
      <div className="flex flex-wrap gap-2">
        {days.map((day) => (
          <button
            key={day.value}
            type="button"
            onClick={() => onToggle(day.value)}
            disabled={disabled}
            className={`rounded-lg px-3 py-1.5 text-xs font-medium transition-colors disabled:cursor-not-allowed disabled:opacity-60 ${
              selectedWeekdays.includes(day.value)
                ? "bg-gray-900 text-white"
                : "bg-gray-100 text-gray-800 hover:bg-gray-200"
            }`}
          >
            {day.label}ìš”ì¼
          </button>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step3Contents/components/AddedContentList.tsx">
type AddedContentListProps = {
  contents: {
    books: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
    lectures: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
  };
  studentContents: Array<{
    content_id: string;
    content_type: "book" | "lecture";
    start_range: number;
    end_range: number;
    title?: string;
    subject_category?: string;
  }>;
  onRemove: (index: number) => void;
  editable: boolean;
};

export function AddedContentList({
  contents,
  studentContents,
  onRemove,
  editable,
}: AddedContentListProps) {
  const getContentTitle = (
    contentType: "book" | "lecture",
    contentId: string,
    savedTitle?: string
  ): string => {
    if (savedTitle) return savedTitle;

    if (contentType === "book") {
      const content = contents.books.find((c) => c.id === contentId);
      return content?.title || "ì•Œ ìˆ˜ ì—†ìŒ";
    } else {
      const content = contents.lectures.find((c) => c.id === contentId);
      return content?.title || "ì•Œ ìˆ˜ ì—†ìŒ";
    }
  };

  const getContentSubtitle = (
    contentType: "book" | "lecture",
    contentId: string,
    savedSubtitle?: string
  ): string | null => {
    if (savedSubtitle) return savedSubtitle;

    if (contentType === "book") {
      const content = contents.books.find((c) => c.id === contentId);
      return content?.subtitle || null;
    } else {
      const content = contents.lectures.find((c) => c.id === contentId);
      return content?.subtitle || null;
    }
  };

  if (studentContents.length === 0) {
    return (
      <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
        <p className="text-sm text-gray-600">ì¶”ê°€ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <p className="text-xs text-gray-600">
          ìœ„ í¼ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ê³  ë²”ìœ„ë¥¼ ì…ë ¥í•œ í›„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between text-sm font-medium text-gray-600">
        <span>ì¶”ê°€ëœ í•™ìƒ ì½˜í…ì¸  ({studentContents.length}ê°œ)</span>
      </div>
      {studentContents.map((content, index) => (
        <div
          key={index}
          className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3"
        >
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <div className="text-sm font-medium text-gray-900">
                {getContentTitle(
                  content.content_type,
                  content.content_id,
                  content.title
                )}
              </div>
              <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                í•™ìƒ ì½˜í…ì¸ 
              </span>
            </div>
            <div className="flex items-center gap-2 text-xs text-gray-600">
              <span>
                {content.content_type === "book" && "ğŸ“š ì±…"}
                {content.content_type === "lecture" && "ğŸ§ ê°•ì˜"}
              </span>
              {(() => {
                const contentType = content.content_type;
                const contentId = content.content_id;
                const foundContent =
                  contentType === "book"
                    ? contents.books.find((b) => b.id === contentId)
                    : contents.lectures.find((l) => l.id === contentId);
                return foundContent?.master_content_id ? (
                  <span className="inline-flex items-center gap-1 rounded-md bg-blue-50 px-2 py-0.5 text-xs font-medium text-blue-800">
                    ğŸ“¦ ë§ˆìŠ¤í„°ì—ì„œ ê°€ì ¸ì˜´
                  </span>
                ) : null;
              })()}
              {getContentSubtitle(
                content.content_type,
                content.content_id,
                content.subject_category
              ) && (
                <>
                  <span>Â·</span>
                  <span>
                    {getContentSubtitle(
                      content.content_type,
                      content.content_id,
                      content.subject_category
                    )}
                  </span>
                </>
              )}
              <span>Â·</span>
              <span>
                {content.start_range} ~ {content.end_range}
              </span>
            </div>
          </div>
          <button
            type="button"
            onClick={() => onRemove(index)}
            disabled={!editable}
            className={`text-sm ${
              !editable
                ? "cursor-not-allowed text-gray-600"
                : "text-red-600 hover:text-red-800"
            }`}
          >
            ì‚­ì œ
          </button>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="new-group/_components/Step3Contents/components/ContentItem.tsx">
import { ContentDetailData, ContentMetadata } from "../types";
import { ContentRangeSelector } from "./ContentRangeSelector";

type ContentItemProps = {
  item: {
    id: string;
    title: string;
    subtitle?: string | null;
    master_content_id?: string | null;
  };
  contentType: "book" | "lecture";
  isSelected: boolean;
  onToggle: () => void;
  metadata?: ContentMetadata;
  contentInfo?: ContentDetailData;
  isLoading?: boolean;
  range?: { start: string; end: string };
  startDetailId?: string;
  endDetailId?: string;
  onSetStartDetail: (id: string) => void;
  onSetEndDetail: (id: string) => void;
  onUpdateRange: (field: "start" | "end", value: string) => void;
  editable: boolean;
};

export function ContentItem({
  item,
  contentType,
  isSelected,
  onToggle,
  metadata,
  contentInfo,
  isLoading,
  range,
  startDetailId,
  endDetailId,
  onSetStartDetail,
  onSetEndDetail,
  onUpdateRange,
  editable,
}: ContentItemProps) {
  return (
    <label
      className={`flex cursor-pointer items-start gap-3 rounded-lg border p-3 transition-colors ${
        isSelected
          ? "border-gray-900 bg-gray-50"
          : "border-gray-200 hover:bg-gray-50"
      }`}
    >
      <input
        type="checkbox"
        checked={isSelected}
        onChange={onToggle}
        disabled={!editable}
        className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900 disabled:cursor-not-allowed disabled:opacity-50"
      />
      <div className="flex-1">
        <div className="flex items-start justify-between gap-2">
          <div className="flex flex-1 flex-col gap-1">
            <div className="text-sm font-medium text-gray-900">
              {item.title}
            </div>
            <div className="flex flex-wrap items-center gap-2 text-xs text-gray-600">
              <span
                className={`rounded px-1.5 py-0.5 ${
                  contentType === "book"
                    ? "bg-blue-100 text-blue-800"
                    : "bg-purple-100 text-purple-800"
                }`}
              >
                {contentType === "book" ? "ğŸ“š êµì¬" : "ğŸ§ ê°•ì˜"}
              </span>
              {item.master_content_id && (
                <span className="inline-flex items-center gap-1 rounded-md bg-blue-50 px-2 py-0.5 text-xs font-medium text-blue-800">
                  ğŸ“¦ ë§ˆìŠ¤í„°ì—ì„œ ê°€ì ¸ì˜´
                </span>
              )}
              {metadata?.subject && (
                <>
                  <span>Â·</span>
                  <span>{metadata.subject}</span>
                </>
              )}
              {metadata?.semester && (
                <>
                  <span>Â·</span>
                  <span>{metadata.semester}</span>
                </>
              )}
              {metadata?.revision && (
                <>
                  <span>Â·</span>
                  <span className="font-medium text-indigo-600">
                    {metadata.revision} ê°œì •íŒ
                  </span>
                </>
              )}
              {metadata?.difficulty_level && (
                <>
                  <span>Â·</span>
                  <span className="rounded bg-indigo-100 px-1.5 py-0.5 text-indigo-800 text-xs">
                    {metadata.difficulty_level}
                  </span>
                </>
              )}
              {metadata?.publisher && (
                <>
                  <span>Â·</span>
                  <span>{metadata.publisher}</span>
                </>
              )}
              {metadata?.platform && (
                <>
                  <span>Â·</span>
                  <span>{metadata.platform}</span>
                </>
              )}
            </div>
          </div>
        </div>

        {/* ì„ íƒëœ ê²½ìš° ìƒì„¸ ì •ë³´ í‘œì‹œ */}
        {isSelected && (
          <div className="flex flex-col gap-3">
            {isLoading ? (
              <div className="text-xs text-gray-600">
                ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </div>
            ) : contentInfo ? (
              <ContentRangeSelector
                contentId={item.id}
                contentType={contentType}
                contentInfo={contentInfo}
                range={range}
                startDetailId={startDetailId}
                endDetailId={endDetailId}
                onSetStartDetail={onSetStartDetail}
                onSetEndDetail={onSetEndDetail}
                onUpdateRange={onUpdateRange}
                editable={editable}
              />
            ) : null}
          </div>
        )}
      </div>
    </label>
  );
}
</file>

<file path="new-group/_components/Step3Contents/components/ContentList.tsx">
import Link from "next/link";
import { useRouter } from "next/navigation";
import { ContentDetailData, ContentMetadata } from "../types";
import { ContentItem } from "./ContentItem";

type Item = {
  id: string;
  title: string;
  subtitle?: string | null;
  master_content_id?: string | null;
};

type ContentListProps = {
  title: string;
  contentType: "book" | "lecture";
  items: Item[];
  emptyMessage: string;
  onSaveDraft?: () => Promise<void> | void;
  // State from hooks
  selectedContentIds: Set<string>;
  contentRanges: Map<string, { start: string; end: string }>;
  startDetailId: Map<string, string>;
  endDetailId: Map<string, string>;
  contentDetails: Map<string, ContentDetailData>;
  loadingDetails: Set<string>;
  contentMetadata: Map<string, ContentMetadata>;
  // Handlers
  onToggleSelection: (contentId: string, type: "book" | "lecture") => void;
  onSetStartDetail: (map: Map<string, string>) => void;
  onSetEndDetail: (map: Map<string, string>) => void;
  onUpdateRange: (contentId: string, field: "start" | "end", value: string) => void;
  editable: boolean;
};

export function ContentList({
  title,
  contentType,
  items,
  emptyMessage,
  onSaveDraft,
  selectedContentIds,
  contentRanges,
  startDetailId,
  endDetailId,
  contentDetails,
  loadingDetails,
  contentMetadata,
  onToggleSelection,
  onSetStartDetail,
  onSetEndDetail,
  onUpdateRange,
  editable,
}: ContentListProps) {
  const router = useRouter();

  const handleLinkClick = async (e: React.MouseEvent) => {
    if (onSaveDraft) {
      e.preventDefault();
      await onSaveDraft();
      router.push("/contents");
    }
  };

  return (
    <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
      <div className="flex flex-col gap-1">
        <h3 className="text-sm font-semibold text-gray-900">{title}</h3>
        <p className="text-xs text-gray-600">
          {contentType === "book" ? "í•™ìŠµ ì¤‘ì¸ êµì¬ë¥¼" : "í•™ìŠµ ì¤‘ì¸ ê°•ì˜ë¥¼"}{" "}
          ì¶”ê°€í•˜ê³  ì‹¶ë‹¤ë©´{" "}
          <Link
            href="/contents"
            className="font-medium text-indigo-600 hover:text-indigo-800 underline"
            onClick={handleLinkClick}
          >
            ì½˜í…ì¸  ë©”ë‰´
          </Link>
          ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
        </p>
      </div>

      {items.length === 0 ? (
        <div className="flex flex-col gap-2 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center">
          <p className="text-sm text-gray-600">{emptyMessage}</p>
          <p className="text-xs text-gray-600">
            {contentType === "book" ? "í•™ìŠµ ì¤‘ì¸ êµì¬ë¥¼" : "í•™ìŠµ ì¤‘ì¸ ê°•ì˜ë¥¼"}{" "}
            ì¶”ê°€í•˜ê³  ì‹¶ë‹¤ë©´{" "}
            <Link
              href="/contents"
              className="font-medium text-indigo-600 hover:text-indigo-800 underline"
              onClick={handleLinkClick}
            >
              ì½˜í…ì¸  ë©”ë‰´
            </Link>
            ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
          </p>
        </div>
      ) : (
        <div className="space-y-2">
          {items.map((item) => {
            const isSelected = selectedContentIds.has(item.id);
            const contentInfo = contentDetails.get(item.id);
            const range = contentRanges.get(item.id);
            const isLoading = loadingDetails.has(item.id);
            const selectedStartId = startDetailId.get(item.id);
            const selectedEndId = endDetailId.get(item.id);
            const metadata = contentMetadata.get(item.id);

            return (
              <ContentItem
                key={item.id}
                item={item}
                contentType={contentType}
                isSelected={isSelected}
                onToggle={() => onToggleSelection(item.id, contentType)}
                metadata={metadata}
                contentInfo={contentInfo}
                isLoading={isLoading}
                range={range}
                startDetailId={selectedStartId}
                endDetailId={selectedEndId}
                onSetStartDetail={(id) => {
                   const newMap = new Map(startDetailId);
                   newMap.set(item.id, id);
                   onSetStartDetail(newMap);
                }}
                onSetEndDetail={(id) => {
                   const newMap = new Map(endDetailId);
                   newMap.set(item.id, id);
                   onSetEndDetail(newMap);
                }}
                onUpdateRange={(field, value) => onUpdateRange(item.id, field, value)}
                editable={editable}
              />
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/Step3Contents/components/ContentRangeSelector.tsx">
import { BookDetail, ContentDetailData, LectureEpisode } from "../types";

type ContentRangeSelectorProps = {
  contentId: string;
  contentType: "book" | "lecture";
  contentInfo: ContentDetailData;
  range: { start: string; end: string } | undefined;
  startDetailId: string | undefined;
  endDetailId: string | undefined;
  onSetStartDetail: (id: string) => void;
  onSetEndDetail: (id: string) => void;
  onUpdateRange: (field: "start" | "end", value: string) => void;
  editable: boolean;
};

export function ContentRangeSelector({
  contentId,
  contentType,
  contentInfo,
  range,
  startDetailId,
  endDetailId,
  onSetStartDetail,
  onSetEndDetail,
  onUpdateRange,
  editable,
}: ContentRangeSelectorProps) {
  if (contentInfo.details.length === 0) {
    return (
      <div className="grid gap-2 md:grid-cols-2">
        <div className="flex flex-col gap-1">
          <label className="block text-xs font-medium text-gray-800">
            {contentType === "book" ? "ì‹œì‘ í˜ì´ì§€" : "ì‹œì‘ ê°•ì˜ ë²ˆí˜¸"}
          </label>
          <input
            type="number"
            className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
            placeholder={contentType === "book" ? "ì˜ˆ: 1" : "ì˜ˆ: 1"}
            min={0}
            value={range?.start || ""}
            onChange={(e) => onUpdateRange("start", e.target.value)}
            disabled={!editable}
          />
        </div>
        <div className="flex flex-col gap-1">
          <label className="block text-xs font-medium text-gray-800">
            {contentType === "book" ? "ì¢…ë£Œ í˜ì´ì§€" : "ì¢…ë£Œ ê°•ì˜ ë²ˆí˜¸"}
          </label>
          <input
            type="number"
            className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-gray-900 focus:outline-none"
            placeholder={contentType === "book" ? "ì˜ˆ: 150" : "ì˜ˆ: 20"}
            min={0}
            value={range?.end || ""}
            onChange={(e) => onUpdateRange("end", e.target.value)}
            disabled={!editable}
          />
        </div>
      </div>
    );
  }

  return (
    <>
      <div className="space-y-3">
        {/* ì‹œì‘ ë²”ìœ„ ì„ íƒ */}
        <div className="flex flex-col gap-2">
          <div className="text-xs font-medium text-gray-800">
            ì‹œì‘ ë²”ìœ„ ì„ íƒ
          </div>
          <div className="max-h-32 overflow-y-auto rounded-lg border border-gray-200 bg-white p-2">
            <div className="space-y-1">
              {contentType === "book"
                ? (contentInfo.details as BookDetail[]).map((detail) => {
                    const isSelected = startDetailId === detail.id;
                    return (
                      <label
                        key={detail.id}
                        className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                          isSelected
                            ? "border-blue-500 bg-blue-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name={`start-${contentId}`}
                          checked={isSelected}
                          onChange={() => onSetStartDetail(detail.id)}
                          disabled={!editable}
                          className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-50"
                        />
                        <div className="flex flex-1 items-center gap-1 text-xs">
                          <span className="font-medium">
                            í˜ì´ì§€ {detail.page_number}
                          </span>
                          {detail.major_unit && (
                            <span className="text-gray-600">
                              Â· {detail.major_unit}
                              {detail.minor_unit && ` - ${detail.minor_unit}`}
                            </span>
                          )}
                        </div>
                      </label>
                    );
                  })
                : (contentInfo.details as LectureEpisode[]).map((detail) => {
                    const isSelected = startDetailId === detail.id;
                    return (
                      <label
                        key={detail.id}
                        className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                          isSelected
                            ? "border-blue-500 bg-blue-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name={`start-${contentId}`}
                          checked={isSelected}
                          onChange={() => onSetStartDetail(detail.id)}
                          disabled={!editable}
                          className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-50"
                        />
                        <div className="flex flex-1 items-center gap-1 text-xs">
                          <span className="font-medium">
                            {detail.episode_number}ê°•
                          </span>
                          {detail.episode_title && (
                            <span className="text-gray-600">
                              Â· {detail.episode_title}
                            </span>
                          )}
                        </div>
                      </label>
                    );
                  })}
            </div>
          </div>
        </div>

        {/* ë ë²”ìœ„ ì„ íƒ */}
        <div className="flex flex-col gap-2">
          <div className="text-xs font-medium text-gray-800">
            ë ë²”ìœ„ ì„ íƒ
          </div>
          <div className="max-h-32 overflow-y-auto rounded-lg border border-gray-200 bg-white p-2">
            <div className="space-y-1">
              {contentType === "book"
                ? (contentInfo.details as BookDetail[]).map((detail) => {
                    const isSelected = endDetailId === detail.id;
                    return (
                      <label
                        key={detail.id}
                        className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                          isSelected
                            ? "border-green-500 bg-green-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name={`end-${contentId}`}
                          checked={isSelected}
                          onChange={() => onSetEndDetail(detail.id)}
                          disabled={!editable}
                          className="h-3 w-3 border-gray-300 text-green-600 focus:ring-green-500 disabled:cursor-not-allowed disabled:opacity-50"
                        />
                        <div className="flex flex-1 items-center gap-1 text-xs">
                          <span className="font-medium">
                            í˜ì´ì§€ {detail.page_number}
                          </span>
                          {detail.major_unit && (
                            <span className="text-gray-600">
                              Â· {detail.major_unit}
                              {detail.minor_unit && ` - ${detail.minor_unit}`}
                            </span>
                          )}
                        </div>
                      </label>
                    );
                  })
                : (contentInfo.details as LectureEpisode[]).map((detail) => {
                    const isSelected = endDetailId === detail.id;
                    return (
                      <label
                        key={detail.id}
                        className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                          isSelected
                            ? "border-green-500 bg-green-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name={`end-${contentId}`}
                          checked={isSelected}
                          onChange={() => onSetEndDetail(detail.id)}
                          disabled={!editable}
                          className="h-3 w-3 border-gray-300 text-green-600 focus:ring-green-500 disabled:cursor-not-allowed disabled:opacity-50"
                        />
                        <div className="flex flex-1 items-center gap-1 text-xs">
                          <span className="font-medium">
                            {detail.episode_number}ê°•
                          </span>
                          {detail.episode_title && (
                            <span className="text-gray-600">
                              Â· {detail.episode_title}
                            </span>
                          )}
                        </div>
                      </label>
                    );
                  })}
            </div>
          </div>
        </div>
      </div>

      {range && (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-2">
          <div className="text-xs font-medium text-gray-800">
            ì„ íƒëœ ë²”ìœ„: {range.start} ~ {range.end}{" "}
            {contentType === "book" ? "í˜ì´ì§€" : "ê°•"}
          </div>
          {(() => {
            if (contentType === "book") {
              const details = contentInfo.details as BookDetail[];
              const startPage = Number(range.start);
              const endPage = Number(range.end);
              const rangeDetails = details.filter(
                (d) => d.page_number >= startPage && d.page_number <= endPage
              );
              if (rangeDetails.length > 0) {
                return (
                  <div className="flex flex-col gap-1 text-xs text-gray-600">
                    <div className="font-medium">í¬í•¨ëœ ë‹¨ì›:</div>
                    <div className="flex flex-col gap-0.5">
                      {rangeDetails.map((d, idx) => (
                        <div key={idx}>
                          í˜ì´ì§€ {d.page_number}
                          {d.major_unit && (
                            <span className="text-gray-600">
                              {" "}
                              Â· {d.major_unit}
                              {d.minor_unit && ` - ${d.minor_unit}`}
                            </span>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                );
              }
            } else {
              // Lecture range details display (optional, based on original)
              const episodes = contentInfo.details as LectureEpisode[];
              const startNum = Number(range.start);
              const endNum = Number(range.end);
              const rangeEpisodes = episodes.filter(
                (e) =>
                  e.episode_number >= startNum && e.episode_number <= endNum
              );
               if (rangeEpisodes.length > 0) {
                return (
                  <div className="flex flex-col gap-1 text-xs text-gray-600">
                    <div className="font-medium">í¬í•¨ëœ ê°•ì˜:</div>
                    <div className="flex flex-col gap-0.5">
                      {rangeEpisodes.map((e, idx) => (
                        <div key={idx}>
                          {e.episode_number}ê°• 
                          {e.episode_title && (
                             <span className="text-gray-600"> Â· {e.episode_title}</span>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                );
              }
            }
            return null;
          })()}
        </div>
      )}
    </>
  );
}
</file>

<file path="new-group/_components/Step3Contents/components/SelectionProgress.tsx">
import { ProgressBar } from "@/components/atoms/ProgressBar";

type SelectionProgressProps = {
  totalCount: number;
  studentCount: number;
  recommendedCount: number;
  isCampMode: boolean;
  canAddMore: boolean;
  remainingSlots: number;
};

export function SelectionProgress({
  totalCount,
  studentCount,
  recommendedCount,
  isCampMode,
  canAddMore,
  remainingSlots,
}: SelectionProgressProps) {
  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <div className="flex flex-col gap-1">
          <h2 className="text-xl font-semibold text-gray-900">
            í•™ìŠµ ëŒ€ìƒ ì½˜í…ì¸ 
          </h2>
          <p className="text-sm text-gray-600">
            í”Œëœì— í¬í•¨í•  êµì¬ì™€ ê°•ì˜ë¥¼ ì„ íƒí•˜ê³  í•™ìŠµ ë²”ìœ„ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”. (ìµœëŒ€
            9ê°œ)
          </p>
        </div>
        <div className="text-right">
          <div className="text-2xl font-bold text-gray-900">
            {totalCount}/9
          </div>
          <div className="text-xs text-gray-600">
            í•™ìƒ {studentCount}ê°œ
            {!isCampMode &&
              recommendedCount > 0 &&
              ` / ì¶”ì²œ ${recommendedCount}ê°œ`}
          </div>
        </div>
      </div>
      {/* ì§„í–‰ ë°” */}
      <div>
        <ProgressBar
          value={(totalCount / 9) * 100}
          color="indigo"
          size="sm"
        />
      </div>
      {!canAddMore && !isCampMode && (
        <div className="rounded-lg border border-amber-200 bg-amber-50 p-3">
          <p className="text-sm text-amber-800">
            âš ï¸ ìµœëŒ€ 9ê°œì˜ ì½˜í…ì¸ ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì¶”ì²œ ì½˜í…ì¸ ëŠ” ë°›ì„ ìˆ˜
            ì—†ìŠµë‹ˆë‹¤.
          </p>
        </div>
      )}
      {!canAddMore && isCampMode && (
        <div className="rounded-lg border border-amber-200 bg-amber-50 p-3">
          <p className="text-sm text-amber-800">
            âš ï¸ ìµœëŒ€ 9ê°œì˜ ì½˜í…ì¸ ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.
          </p>
        </div>
      )}
      {canAddMore && totalCount > 0 && (
        <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
          <p className="text-sm text-blue-800">
            ğŸ’¡ {remainingSlots}ê°œì˜ ì½˜í…ì¸ ë¥¼ ë” ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.{" "}
            {!isCampMode &&
              studentCount < 9 &&
              "ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
            {isCampMode &&
              "ì œì¶œ í›„ ê´€ë¦¬ìê°€ ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª©ì„ ì„¤ì •í•˜ê³  í”Œëœì„ ìƒì„±í•©ë‹ˆë‹¤."}
          </p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/Step3Contents/hooks/useBatchContentDetails.ts">
import { useState, useEffect, useRef, useMemo } from "react";
import { BookDetail, LectureEpisode, ContentDetailData, ContentMetadata } from "../types";

type UseBatchContentDetailsProps = {
  selectedContentIds: Set<string>;
  contents: {
    books: Array<{ id: string }>;
    lectures: Array<{ id: string }>;
  };
};

export function useBatchContentDetails({
  selectedContentIds,
  contents,
}: UseBatchContentDetailsProps) {
  const [contentDetails, setContentDetails] = useState<Map<string, ContentDetailData>>(new Map());
  const [loadingDetails, setLoadingDetails] = useState<Set<string>>(new Set());
  const [contentMetadata, setContentMetadata] = useState<Map<string, ContentMetadata>>(new Map());

  // ì´ë¯¸ ì¡°íšŒí•œ ì½˜í…ì¸  ìƒì„¸ ì •ë³´ë¥¼ ìºì‹œë¡œ ê´€ë¦¬
  const cachedDetailsRef = useRef<Map<string, ContentDetailData>>(new Map());

  // ì½˜í…ì¸  íƒ€ì… í™•ì¸ ìµœì í™”: O(nÃ—m) â†’ O(n)ìœ¼ë¡œ ê°œì„ 
  const bookIdSet = useMemo(
    () => new Set(contents.books.map((b) => b.id)),
    [contents.books]
  );
  // lectureIdSet is not strictly needed if we assume everything not in bookIdSet is a lecture,
  // but good for safety.
  const lectureIdSet = useMemo(
    () => new Set(contents.lectures.map((l) => l.id)),
    [contents.lectures]
  );

  useEffect(() => {
    const fetchAllDetails = async () => {
      const newDetails = new Map<string, ContentDetailData>();

      // 1. ìºì‹œëœ ì½˜í…ì¸  ë¨¼ì € ì²˜ë¦¬
      const contentIdsToFetch: string[] = [];
      for (const contentId of selectedContentIds) {
        if (cachedDetailsRef.current.has(contentId)) {
          newDetails.set(contentId, cachedDetailsRef.current.get(contentId)!);
        } else {
          contentIdsToFetch.push(contentId);
        }
      }

      // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì—…ë°ì´íŠ¸
      if (newDetails.size > 0) {
        setContentDetails(new Map(newDetails));
      }

      // 2. ë‚˜ë¨¸ì§€ ì½˜í…ì¸ ë“¤ì„ ë°°ì¹˜ APIë¡œ ì¡°íšŒ
      if (contentIdsToFetch.length === 0) {
        return;
      }

      // ëª¨ë“  ì½˜í…ì¸ ë¥¼ ë¡œë”© ìƒíƒœë¡œ ì„¤ì •
      const initialLoadingSet = new Set(contentIdsToFetch);
      setLoadingDetails(new Set(initialLoadingSet));

      const performanceStart = performance.now();
      try {
        const typeCheckStart = performance.now();

        // ì½˜í…ì¸  íƒ€ì… ì •ë³´ ìˆ˜ì§‘
        const contentsToFetch = contentIdsToFetch.map((contentId) => {
          const isBook = bookIdSet.has(contentId);
          return {
            contentId,
            contentType: isBook ? ("book" as const) : ("lecture" as const),
          };
        });

        const typeCheckTime = performance.now() - typeCheckStart;
        const networkStart = performance.now();

        // ë°°ì¹˜ API í˜¸ì¶œ
        const response = await fetch("/api/student-content-details/batch", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            contents: contentsToFetch,
            includeMetadata: false,
          }),
        });

        const networkTime = performance.now() - networkStart;
        const parseStart = performance.now();

        if (response.ok) {
          const result = await response.json();
          const parseTime = performance.now() - parseStart;
          const processStart = performance.now();
          const batchData = result.data;

          // ë°°ì¹˜ ì‘ë‹µ ê²°ê³¼ ì²˜ë¦¬
          contentIdsToFetch.forEach((contentId) => {
            const contentType = contentsToFetch.find(
              (c) => c.contentId === contentId
            )?.contentType;
            const contentData = batchData[contentId];

            if (contentData) {
              const detailData: ContentDetailData =
                contentType === "book"
                  ? {
                      details: (contentData.details || []) as BookDetail[],
                      type: "book",
                    }
                  : {
                      details: (contentData.episodes || []) as LectureEpisode[],
                      type: "lecture",
                    };

              if (process.env.NODE_ENV === "development" && detailData.details.length === 0) {
                 console.debug("[useBatchContentDetails] ë°°ì¹˜ API ì‘ë‹µ: ìƒì„¸ì •ë³´ ì—†ìŒ", {
                   contentId, contentType
                 })
              }

              // ìºì‹œì— ì €ì¥
              cachedDetailsRef.current.set(contentId, detailData);
              newDetails.set(contentId, detailData);

              // ë©”íƒ€ë°ì´í„° ì €ì¥
              if (contentData.metadata) {
                setContentMetadata((prev) => {
                  const newMap = new Map(prev);
                  newMap.set(contentId, contentData.metadata);
                  return newMap;
                });
              }
            }
          });

          const processTime = performance.now() - processStart;
          const totalTime = performance.now() - performanceStart;

          if (process.env.NODE_ENV === "development") {
            console.log("[useBatchContentDetails] ë°°ì¹˜ API ì„±ëŠ¥:", {
                totalTime: `${totalTime.toFixed(2)}ms`,
                count: contentsToFetch.length
            });
          }
        } else {
            // Fallback to individual fetch if batch fails
            console.warn("[useBatchContentDetails] Batch API failed, falling back");
            
            const fetchPromises = contentIdsToFetch.map(async (contentId) => {
                const contentType = contentsToFetch.find((c) => c.contentId === contentId)?.contentType || "book";
                try {
                    const res = await fetch(`/api/student-content-details?contentType=${contentType}&contentId=${contentId}&includeMetadata=false`);
                    if (res.ok) {
                        const r = await res.json();
                        const d: ContentDetailData = contentType === "book" 
                            ? { details: r.details || [], type: "book" }
                            : { details: r.episodes || [], type: "lecture" };
                        
                        cachedDetailsRef.current.set(contentId, d);
                        if (r.metadata) {
                            setContentMetadata(prev => new Map(prev).set(contentId, r.metadata));
                        }
                        return { contentId, data: d };
                    }
                } catch (e) {
                    console.error(e);
                }
                return null;
            });

            const results = await Promise.all(fetchPromises);
            results.forEach(r => {
                if (r) newDetails.set(r.contentId, r.data);
            });
        }
      } catch (error) {
        console.error("[useBatchContentDetails] Error:", error);
      } finally {
        setLoadingDetails(new Set());
      }

      setContentDetails(new Map(newDetails));
    };

    if (selectedContentIds.size > 0) {
      fetchAllDetails();
    } else {
      setContentDetails(new Map());
    }
  }, [selectedContentIds, bookIdSet, lectureIdSet]);

  return { contentDetails, loadingDetails, contentMetadata };
}
</file>

<file path="new-group/_components/Step3Contents/hooks/useContentSelection.ts">
import { useState, useEffect } from "react";
import { WizardData } from "../../PlanGroupWizard";
import { ContentDetailData, BookDetail, LectureEpisode } from "../types";
import { fetchContentMetadataAction } from "@/app/(student)/actions/fetchContentMetadata";
import { getStudentContentMasterIdsAction } from "@/app/(student)/actions/getStudentContentMasterIds";
import {
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";

type UseContentSelectionProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  isCampMode: boolean;
  contents: {
    books: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
    lectures: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
  };
  contentDetails: Map<string, ContentDetailData>;
  // Lifted state
  selectedContentIds: Set<string>;
  setSelectedContentIds: (ids: Set<string>) => void;
};

export function useContentSelection({
  data,
  onUpdate,
  isCampMode,
  contents,
  contentDetails,
  selectedContentIds,
  setSelectedContentIds,
}: UseContentSelectionProps) {
  // removed internal selectedContentIds state
  const [contentRanges, setContentRanges] = useState<
    Map<string, { start: string; end: string }>
  >(new Map());
  const [startDetailId, setStartDetailId] = useState<Map<string, string>>(
    new Map()
  );
  const [endDetailId, setEndDetailId] = useState<Map<string, string>>(
    new Map()
  );

  // Sync ranges when details or selection change
  useEffect(() => {
    setContentRanges((prevRanges) => {
      const newRanges = new Map(prevRanges);

      for (const contentId of selectedContentIds) {
        const contentInfo = contentDetails.get(contentId);
        if (!contentInfo) continue;

        const startId = startDetailId.get(contentId);
        const endId = endDetailId.get(contentId);

        if (!startId || !endId) continue;

        if (contentInfo.type === "book") {
          const details = contentInfo.details as BookDetail[];
          const startDetail = details.find((d) => d.id === startId);
          const endDetail = details.find((d) => d.id === endId);

          if (startDetail && endDetail) {
            const startPage = startDetail.page_number;
            const endPage = endDetail.page_number;

            if (startPage > endPage) {
              newRanges.set(contentId, {
                start: String(endPage),
                end: String(startPage),
              });
            } else {
              newRanges.set(contentId, {
                start: String(startPage),
                end: String(endPage),
              });
            }
          }
        } else {
          const episodes = contentInfo.details as LectureEpisode[];
          const startEpisode = episodes.find((e) => e.id === startId);
          const endEpisode = episodes.find((e) => e.id === endId);

          if (startEpisode && endEpisode) {
            const startNum = startEpisode.episode_number;
            const endNum = endEpisode.episode_number;

            if (startNum > endNum) {
              newRanges.set(contentId, {
                start: String(endNum),
                end: String(startNum),
              });
            } else {
              newRanges.set(contentId, {
                start: String(startNum),
                end: String(endNum),
              });
            }
          }
        }
      }
      return newRanges;
    });
  }, [startDetailId, endDetailId, contentDetails, selectedContentIds]);

  const toggleContentSelection = (
    contentId: string,
    contentType: "book" | "lecture"
  ) => {
    const newSet = new Set(selectedContentIds);
    if (newSet.has(contentId)) {
      newSet.delete(contentId);
      // Cleanup
      const newStartIds = new Map(startDetailId);
      newStartIds.delete(contentId);
      setStartDetailId(newStartIds);
      const newEndIds = new Map(endDetailId);
      newEndIds.delete(contentId);
      setEndDetailId(newEndIds);
      const newRanges = new Map(contentRanges);
      newRanges.delete(contentId);
      setContentRanges(newRanges);
    } else {
      const totalContents = isCampMode
        ? data.student_contents.length
        : data.student_contents.length + data.recommended_contents.length;
      if (totalContents + newSet.size >= 9) {
        alert("í”Œëœ ëŒ€ìƒ ì½˜í…ì¸ ëŠ” ìµœëŒ€ 9ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }
      newSet.add(contentId);
    }
    setSelectedContentIds(newSet);
  };

  const updateContentRange = (
    contentId: string,
    field: "start" | "end",
    value: string
  ) => {
    const newRanges = new Map(contentRanges);
    const current = newRanges.get(contentId) || { start: "", end: "" };
    newRanges.set(contentId, { ...current, [field]: value });
    setContentRanges(newRanges);
  };

  const addSelectedContents = async () => {
    // 1. Get Master IDs
    const studentContentsForMasterId = data.student_contents.filter(
      (c) => c.content_type === "book" || c.content_type === "lecture"
    ) as Array<{ content_id: string; content_type: "book" | "lecture" }>;

    let studentMasterIds = new Set<string>();
    if (studentContentsForMasterId.length > 0) {
      try {
        const masterIdResult = await getStudentContentMasterIdsAction(
          studentContentsForMasterId
        );
        if (masterIdResult.success && masterIdResult.data) {
            masterIdResult.data.forEach((masterId) => {
                if (masterId) studentMasterIds.add(masterId);
            });
        }
      } catch (error) {
        console.warn("[useContentSelection] master_content_id fetch failed:", error);
      }
    }

    const contentsToAdd: Array<{
      content_type: "book" | "lecture";
      content_id: string;
      master_content_id?: string | null;
      start_range: number;
      end_range: number;
      start_detail_id?: string | null;
      end_detail_id?: string | null;
      title?: string;
      subject_category?: string;
    }> = [];

    for (const contentId of selectedContentIds) {
      const range = contentRanges.get(contentId);
      if (!range || !range.start || !range.end) {
        alert("ëª¨ë“  ì„ íƒëœ ì½˜í…ì¸ ì˜ í•™ìŠµ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const start = Number(range.start);
      const end = Number(range.end);
      if (isNaN(start) || isNaN(end) || start > end) {
        alert("ì˜¬ë°”ë¥¸ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì‹œì‘ â‰¤ ì¢…ë£Œ)");
        return;
      }

      const isBook = contents.books.some((b) => b.id === contentId);
      const contentType = isBook ? "book" : "lecture";
      const content = isBook
        ? contents.books.find((b) => b.id === contentId)
        : contents.lectures.find((l) => l.id === contentId);

      // Duplicate Check
      const isDuplicateByContentId = data.student_contents.some(
        (c) => c.content_type === contentType && c.content_id === contentId
      );
      const isDuplicateByMasterId =
        content?.master_content_id &&
        studentMasterIds.has(content.master_content_id);

      if (isDuplicateByContentId || isDuplicateByMasterId) continue;

      // Metadata fetch
      let subjectCategory: string | undefined = undefined;
      try {
        const result = await fetchContentMetadataAction(contentId, contentType);
        if (result.success && result.data) {
          subjectCategory = result.data.subject_category || undefined;
        }
      } catch (error) {
        console.error("[useContentSelection] Metadata fetch failed", error);
        subjectCategory = content?.subtitle || undefined;
      }

      contentsToAdd.push({
        content_type: contentType,
        content_id: contentId,
        start_range: start,
        end_range: end,
        start_detail_id: startDetailId.get(contentId) || null,
        end_detail_id: endDetailId.get(contentId) || null,
        title: content?.title,
        subject_category: subjectCategory,
        master_content_id: content?.master_content_id || null,
      });
    }

    if (contentsToAdd.length === 0) {
      alert("ì¶”ê°€í•  ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    const totalContents = isCampMode
      ? data.student_contents.length
      : data.student_contents.length + data.recommended_contents.length;
    
    if (totalContents + contentsToAdd.length > 9) {
      alert("í”Œëœ ëŒ€ìƒ ì½˜í…ì¸ ëŠ” ìµœëŒ€ 9ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }

    onUpdate({
      student_contents: [...data.student_contents, ...contentsToAdd],
    });

    // Reset
    setSelectedContentIds(new Set());
    setStartDetailId(new Map());
    setEndDetailId(new Map());
    setContentRanges(new Map());
  };

  const removeContent = (index: number) => {
    onUpdate({
      student_contents: data.student_contents.filter((_, i) => i !== index),
    });
  };

  return {
    contentRanges,
    startDetailId,
    endDetailId,
    toggleContentSelection,
    updateContentRange,
    setStartDetailId,
    setEndDetailId,
    addSelectedContents,
    removeContent,
  };
}
</file>

<file path="new-group/_components/Step3Contents/index.ts">
export * from "./Step3Contents";
</file>

<file path="new-group/_components/Step3Contents/Step3Contents.tsx">
"use client";

import { useState } from "react";
import { WizardData } from "../PlanGroupWizard";
import { useBatchContentDetails } from "./hooks/useBatchContentDetails";
import { useContentSelection } from "./hooks/useContentSelection";
import { ContentList } from "./components/ContentList";
import { SelectionProgress } from "./components/SelectionProgress";
import { AddedContentList } from "./components/AddedContentList";
import { getContentTitleFromMaster } from "./utils";

type Step3ContentsProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  contents: {
    books: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
    lectures: Array<{
      id: string;
      title: string;
      subtitle?: string | null;
      master_content_id?: string | null;
    }>;
    custom: Array<{ id: string; title: string; subtitle?: string | null }>;
  };
  onSaveDraft?: () => Promise<void> | void;
  isSavingDraft?: boolean;
  isCampMode?: boolean;
  editable?: boolean;
};

export function Step3Contents({
  data,
  onUpdate,
  contents,
  onSaveDraft,
  isSavingDraft = false,
  isCampMode = false,
  editable = true,
}: Step3ContentsProps) {
  const [selectedContentIds, setSelectedContentIds] = useState<Set<string>>(
    new Set()
  );

  const { contentDetails, loadingDetails, contentMetadata } =
    useBatchContentDetails({
      selectedContentIds,
      contents,
    });

  const {
    contentRanges,
    startDetailId,
    endDetailId,
    toggleContentSelection,
    updateContentRange,
    setStartDetailId,
    setEndDetailId,
    addSelectedContents,
    removeContent,
  } = useContentSelection({
    data,
    onUpdate,
    isCampMode,
    contents,
    contentDetails,
    selectedContentIds,
    setSelectedContentIds,
  });

  const studentCount = data.student_contents.length;
  const recommendedCount = data.recommended_contents.length;
  const totalCount =
    studentCount + (isCampMode ? 0 : recommendedCount) + selectedContentIds.size;
  // Note: SelectionProgress uses "totalCount" as the currently filled slots for the progress bar.
  // The logic in original was:
  // const totalContents = isCampMode ? data.student_contents.length : data.student_contents.length + data.recommended_contents.length;
  // And it checked against 9.
  // Here we want to show progress.
  
  const currentTotal = isCampMode 
    ? studentCount 
    : studentCount + recommendedCount;

  const canAddMore = totalCount < 9;
  const remainingSlots = 9 - totalCount;

  return (
    <div className="space-y-6">
      <SelectionProgress
        totalCount={totalCount}
        studentCount={studentCount}
        recommendedCount={recommendedCount}
        isCampMode={isCampMode}
        canAddMore={canAddMore}
        remainingSlots={remainingSlots}
      />

      {/* Books List */}
      <ContentList
        title="ğŸ“š ë“±ë¡ëœ êµì¬"
        contentType="book"
        items={contents.books}
        emptyMessage="ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤."
        onSaveDraft={onSaveDraft}
        selectedContentIds={selectedContentIds}
        contentRanges={contentRanges}
        startDetailId={startDetailId}
        endDetailId={endDetailId}
        contentDetails={contentDetails}
        loadingDetails={loadingDetails}
        contentMetadata={contentMetadata}
        onToggleSelection={toggleContentSelection}
        onSetStartDetail={setStartDetailId}
        onSetEndDetail={setEndDetailId}
        onUpdateRange={updateContentRange}
        editable={editable}
      />

      {/* Lectures List */}
      <ContentList
        title="ğŸ§ ë“±ë¡ëœ ê°•ì˜"
        contentType="lecture"
        items={contents.lectures}
        emptyMessage="ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤."
        onSaveDraft={onSaveDraft}
        selectedContentIds={selectedContentIds}
        contentRanges={contentRanges}
        startDetailId={startDetailId}
        endDetailId={endDetailId}
        contentDetails={contentDetails}
        loadingDetails={loadingDetails}
        contentMetadata={contentMetadata}
        onToggleSelection={toggleContentSelection}
        onSetStartDetail={setStartDetailId}
        onSetEndDetail={setEndDetailId}
        onUpdateRange={updateContentRange}
        editable={editable}
      />

      {/* Add Button Area */}
      {selectedContentIds.size > 0 && (
        <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-gray-600">
              ì„ íƒëœ ì½˜í…ì¸ : {selectedContentIds.size}ê°œ
            </span>
            {!canAddMore && !isCampMode && (
              <span className="text-xs font-medium text-amber-600">
                âš ï¸ ì¶”ì²œ ì½˜í…ì¸  ë¶ˆê°€
              </span>
            )}
          </div>
          <div className="flex flex-col gap-2">
            {Array.from(selectedContentIds).map((id) => {
              const range = contentRanges.get(id);
              const hasRange =
                range &&
                range.start &&
                range.end &&
                range.start.trim() !== "" &&
                range.end.trim() !== "";
              if (!hasRange) {
                const isBook = contents.books.some((b) => b.id === id);
                return (
                  <div
                    key={id}
                    className="rounded-lg border border-yellow-200 bg-yellow-50 p-2 text-xs text-yellow-800"
                  >
                  {isBook ? "ğŸ“š" : "ğŸ§"}{" "}
                  {getContentTitleFromMaster(contents, isBook ? "book" : "lecture", id)}: 
                  í•™ìŠµ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                </div>
              );
            }
            return null;
          })}
          <button
            type="button"
            onClick={addSelectedContents}
            disabled={
              !editable ||
              Array.from(selectedContentIds).some((id) => {
                const range = contentRanges.get(id);
                return (
                  !range ||
                  !range.start ||
                  !range.end ||
                  range.start.trim() === "" ||
                  range.end.trim() === ""
                );
              }) ||
              !canAddMore
            }
            className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
          >
            ì„ íƒí•œ ì½˜í…ì¸  ì¶”ê°€í•˜ê¸° ({totalCount}/9)
          </button>
        </div>
      </div>
      )}

      {/* Added Content List */}
      <AddedContentList
        contents={contents}
        studentContents={data.student_contents}
        onRemove={removeContent}
        editable={editable}
      />
    </div>
  );
}
</file>

<file path="new-group/_components/Step3Contents/types.ts">
export type ContentType = "book" | "lecture";

export type BookDetail = {
  id: string;
  page_number: number;
  major_unit: string | null;
  minor_unit: string | null;
};

export type LectureEpisode = {
  id: string;
  episode_number: number;
  episode_title: string | null;
};

export type ContentDetailData = { 
  details: BookDetail[] | LectureEpisode[]; 
  type: "book" | "lecture" 
};

export type ContentMetadata = {
  subject?: string | null;
  semester?: string | null;
  revision?: string | null;
  difficulty_level?: string | null;
  publisher?: string | null;
  platform?: string | null;
};
</file>

<file path="new-group/_components/Step3Contents/utils.ts">
export const getContentTitleFromMaster = (
  contents: {
    books: Array<{ id: string; title: string }>;
    lectures: Array<{ id: string; title: string }>;
  },
  contentType: "book" | "lecture",
  contentId: string
): string => {
  if (contentType === "book") {
    const content = contents.books.find((c) => c.id === contentId);
    return content?.title || "ì•Œ ìˆ˜ ì—†ìŒ";
  } else {
    const content = contents.lectures.find((c) => c.id === contentId);
    return content?.title || "ì•Œ ìˆ˜ ì—†ìŒ";
  }
};

export const getContentSubtitleFromMaster = (
  contents: {
    books: Array<{ id: string; subtitle?: string | null }>;
    lectures: Array<{ id: string; subtitle?: string | null }>;
  },
  contentType: "book" | "lecture",
  contentId: string
): string | null => {
  if (contentType === "book") {
    const content = contents.books.find((c) => c.id === contentId);
    return content?.subtitle || null;
  } else {
    const content = contents.lectures.find((c) => c.id === contentId);
    return content?.subtitle || null;
  }
};
</file>

<file path="new-group/_components/Step4RecommendedContents/components/AddedContentsList.tsx">
/**
 * AddedContentsList
 * ì¶”ê°€ëœ ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ (ë²”ìœ„ í¸ì§‘ í¬í•¨)
 */

"use client";

import { BookDetail, LectureEpisode, RecommendedContent } from "../types";
import { Pencil, Check, X, Trash2 } from "lucide-react";

type AddedContentsListProps = {
  contents: Array<{
    content_type: "book" | "lecture";
    content_id: string;
    start_range: number;
    end_range: number;
    title?: string;
    subject_category?: string;
  }>;
  allRecommendedContents: RecommendedContent[];
  editingRangeIndex: number | null;
  editingRange: { start: string; end: string } | null;
  contentDetails: Map<
    number,
    { details: (BookDetail | LectureEpisode)[]; type: "book" | "lecture" }
  >;
  startDetailId: Map<number, string>;
  endDetailId: Map<number, string>;
  contentTotals: Map<number, number>;
  loadingDetails: Set<number>;
  onStartEditing: (index: number) => void;
  onSaveRange: () => void;
  onCancelEditing: () => void;
  onRemove: (index: number) => void;
  onStartDetailChange: (index: number, detailId: string) => void;
  onEndDetailChange: (index: number, detailId: string) => void;
  onRangeChange?: (start: string, end: string) => void;
};

export default function AddedContentsList({
  contents,
  allRecommendedContents,
  editingRangeIndex,
  editingRange,
  contentDetails,
  startDetailId,
  endDetailId,
  contentTotals,
  loadingDetails,
  onStartEditing,
  onSaveRange,
  onCancelEditing,
  onRemove,
  onStartDetailChange,
  onEndDetailChange,
  onRangeChange,
}: AddedContentsListProps) {
  if (contents.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-col gap-2">
      <div className="flex items-center justify-between text-sm font-medium text-gray-800">
        <span>
          {allRecommendedContents.length > 0
            ? `ì¶”ê°€ëœ ì¶”ì²œ ì½˜í…ì¸  (${contents.length}ê°œ)`
            : `ë“±ë¡ëœ ì½˜í…ì¸  (${contents.length}ê°œ)`}
        </span>
      </div>
      {contents.map((content, index) => {
        // ì œëª© ë° ê³¼ëª© ì •ë³´ ì¡°íšŒ
        let title = content.title;
        let subjectCategory = content.subject_category;

        // allRecommendedContentsì—ì„œ ì¡°íšŒ
        const recommendedContent = allRecommendedContents.find(
          (c) => c.id === content.content_id
        );
        if (recommendedContent) {
          title = title || recommendedContent.title;
          subjectCategory =
            subjectCategory ||
            recommendedContent.subject_category ||
            undefined;
        }

        // ì—¬ì „íˆ ì—†ìœ¼ë©´ "ì•Œ ìˆ˜ ì—†ìŒ"
        if (!title) {
          title = "ì•Œ ìˆ˜ ì—†ìŒ";
        }

        const isEditing = editingRangeIndex === index;
        const contentInfo = contentDetails.get(index);
        const isLoading = loadingDetails.has(index);
        const selectedStartId = startDetailId.get(index);
        const selectedEndId = endDetailId.get(index);

        return (
          <div
            key={index}
            className="flex items-start justify-between rounded-lg border border-gray-200 bg-white px-4 py-3"
          >
            <div className="flex-1">
              <div className="flex items-start justify-between gap-2">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <div className="text-sm font-medium text-gray-900">
                      {title}
                    </div>
                    {allRecommendedContents.length > 0 && (
                      <span className="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
                        ì¶”ì²œ ì½˜í…ì¸ 
                      </span>
                    )}
                    {allRecommendedContents.length === 0 && (
                      <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                        í•™ìƒ ì½˜í…ì¸ 
                      </span>
                    )}
                  </div>
                  <div className="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                    {content.content_type === "book" && (
                      <span className="rounded bg-blue-100 px-1.5 py-0.5 text-blue-800">
                        ğŸ“š êµì¬
                      </span>
                    )}
                    {content.content_type === "lecture" && (
                      <span className="rounded bg-purple-100 px-1.5 py-0.5 text-purple-800">
                        ğŸ§ ê°•ì˜
                      </span>
                    )}
                    {recommendedContent?.subject && (
                      <>
                        <span>Â·</span>
                        <span>{recommendedContent.subject}</span>
                      </>
                    )}
                    {recommendedContent?.semester && (
                      <>
                        <span>Â·</span>
                        <span>{recommendedContent.semester}</span>
                      </>
                    )}
                    {recommendedContent?.revision && (
                      <>
                        <span>Â·</span>
                        <span className="font-medium text-indigo-600">
                          {recommendedContent.revision} ê°œì •íŒ
                        </span>
                      </>
                    )}
                    {recommendedContent?.difficulty_level && (
                      <>
                        <span>Â·</span>
                        <span className="rounded bg-indigo-100 px-1.5 py-0.5 text-indigo-800 text-xs">
                          {recommendedContent.difficulty_level}
                        </span>
                      </>
                    )}
                    {recommendedContent?.publisher && (
                      <>
                        <span>Â·</span>
                        <span>{recommendedContent.publisher}</span>
                      </>
                    )}
                    {recommendedContent?.platform && (
                      <>
                        <span>Â·</span>
                        <span>{recommendedContent.platform}</span>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* ë²”ìœ„ ì •ë³´ ë˜ëŠ” ë²”ìœ„ í¸ì§‘ UI */}
              <div className="flex items-center gap-2 text-xs text-gray-500">
                <span>Â·</span>
                {isEditing ? (
                  <div className="flex-1 space-y-3">
                    {/* ìƒì„¸ì •ë³´ê°€ ìˆëŠ” ê²½ìš° ì‹œì‘/ë ë²”ìœ„ ê°ê° ì„ íƒ */}
                    {isLoading ? (
                      <div className="text-xs text-gray-500">
                        ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                      </div>
                    ) : contentInfo && contentInfo.details.length > 0 ? (
                      <div className="space-y-3">
                        {/* ì‹œì‘ ë²”ìœ„ ì„ íƒ */}
                        <div className="flex flex-col gap-2">
                          <div className="text-xs font-medium text-gray-800">
                            ì‹œì‘ ë²”ìœ„ ì„ íƒ
                          </div>
                          <div className="max-h-32 overflow-y-auto rounded-lg border border-gray-200 bg-white p-2">
                            <div className="space-y-1">
                              {contentInfo.type === "book"
                                ? (contentInfo.details as BookDetail[]).map(
                                    (detail) => {
                                      const isSelected =
                                        selectedStartId === detail.id;
                                      return (
                                        <label
                                          key={detail.id}
                                          className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                            isSelected
                                              ? "border-blue-500 bg-blue-50"
                                              : "border-gray-200 hover:bg-gray-50"
                                          }`}
                                        >
                                          <input
                                            type="radio"
                                            name={`start-recommended-${index}`}
                                            checked={isSelected}
                                            onChange={() =>
                                              onStartDetailChange(index, detail.id)
                                            }
                                            className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500"
                                          />
                                          <div className="flex flex-1 items-center gap-2 text-xs">
                                            <span className="font-medium">
                                              í˜ì´ì§€ {detail.page_number}
                                            </span>
                                            {detail.major_unit && (
                                              <span className="text-gray-500">
                                                Â· {detail.major_unit}
                                                {detail.minor_unit &&
                                                  ` - ${detail.minor_unit}`}
                                              </span>
                                            )}
                                          </div>
                                        </label>
                                      );
                                    }
                                  )
                                : (
                                    contentInfo.details as LectureEpisode[]
                                  ).map((episode) => {
                                    const isSelected =
                                      selectedStartId === episode.id;
                                    return (
                                      <label
                                        key={episode.id}
                                        className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                          isSelected
                                            ? "border-blue-500 bg-blue-50"
                                            : "border-gray-200 hover:bg-gray-50"
                                        }`}
                                      >
                                        <input
                                          type="radio"
                                          name={`start-recommended-${index}`}
                                          checked={isSelected}
                                          onChange={() =>
                                            onStartDetailChange(index, episode.id)
                                          }
                                          className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        <div className="flex flex-1 items-center gap-2 text-xs">
                                          <span className="font-medium">
                                            {episode.episode_number}íšŒì°¨
                                          </span>
                                          {episode.episode_title && (
                                            <span className="text-gray-500">
                                              Â· {episode.episode_title}
                                            </span>
                                          )}
                                        </div>
                                      </label>
                                    );
                                  })}
                            </div>
                          </div>
                        </div>

                        {/* ë ë²”ìœ„ ì„ íƒ */}
                        <div className="flex flex-col gap-2">
                          <div className="text-xs font-medium text-gray-800">
                            ë ë²”ìœ„ ì„ íƒ
                          </div>
                          <div className="max-h-32 overflow-y-auto rounded-lg border border-gray-200 bg-white p-2">
                            <div className="space-y-1">
                              {contentInfo.type === "book"
                                ? (contentInfo.details as BookDetail[]).map(
                                    (detail) => {
                                      const isSelected =
                                        selectedEndId === detail.id;
                                      return (
                                        <label
                                          key={detail.id}
                                          className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                            isSelected
                                              ? "border-green-500 bg-green-50"
                                              : "border-gray-200 hover:bg-gray-50"
                                          }`}
                                        >
                                          <input
                                            type="radio"
                                            name={`end-recommended-${index}`}
                                            checked={isSelected}
                                            onChange={() =>
                                              onEndDetailChange(index, detail.id)
                                            }
                                            className="h-3 w-3 border-gray-300 text-green-600 focus:ring-green-500"
                                          />
                                          <div className="flex flex-1 items-center gap-2 text-xs">
                                            <span className="font-medium">
                                              í˜ì´ì§€ {detail.page_number}
                                            </span>
                                            {detail.major_unit && (
                                              <span className="text-gray-500">
                                                Â· {detail.major_unit}
                                                {detail.minor_unit &&
                                                  ` - ${detail.minor_unit}`}
                                              </span>
                                            )}
                                          </div>
                                        </label>
                                      );
                                    }
                                  )
                                : (
                                    contentInfo.details as LectureEpisode[]
                                  ).map((episode) => {
                                    const isSelected =
                                      selectedEndId === episode.id;
                                    return (
                                      <label
                                        key={episode.id}
                                        className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                          isSelected
                                            ? "border-green-500 bg-green-50"
                                            : "border-gray-200 hover:bg-gray-50"
                                        }`}
                                      >
                                        <input
                                          type="radio"
                                          name={`end-recommended-${index}`}
                                          checked={isSelected}
                                          onChange={() =>
                                            onEndDetailChange(index, episode.id)
                                          }
                                          className="h-3 w-3 border-gray-300 text-green-600 focus:ring-green-500"
                                        />
                                        <div className="flex flex-1 items-center gap-2 text-xs">
                                          <span className="font-medium">
                                            {episode.episode_number}íšŒì°¨
                                          </span>
                                          {episode.episode_title && (
                                            <span className="text-gray-500">
                                              Â· {episode.episode_title}
                                            </span>
                                          )}
                                        </div>
                                      </label>
                                    );
                                  })}
                            </div>
                          </div>
                        </div>

                        {/* ì„ íƒëœ ë²”ìœ„ í‘œì‹œ */}
                        {editingRange && (
                          <div className="rounded-lg border border-blue-200 bg-blue-50 p-2 text-xs text-blue-800">
                            <span className="font-medium">ì„ íƒëœ ë²”ìœ„:</span>{" "}
                            {content.content_type === "book"
                              ? `${editingRange.start}í˜ì´ì§€ ~ ${editingRange.end}í˜ì´ì§€`
                              : `${editingRange.start}íšŒì°¨ ~ ${editingRange.end}íšŒì°¨`}
                          </div>
                        )}

                        {/* ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ */}
                        <div className="flex gap-2">
                          <button
                            type="button"
                            onClick={onSaveRange}
                            className="flex items-center gap-1 rounded bg-blue-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-blue-700"
                          >
                            <Check className="h-3 w-3" />
                            ì €ì¥
                          </button>
                          <button
                            type="button"
                            onClick={onCancelEditing}
                            className="flex items-center gap-1 rounded bg-gray-200 px-3 py-1.5 text-xs font-medium text-gray-800 hover:bg-gray-300"
                          >
                            <X className="h-3 w-3" />
                            ì·¨ì†Œ
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {(() => {
                          // ìƒì„¸ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ë¡œê¹… (ì •ìƒ ì¼€ì´ìŠ¤)
                          const content = contents[editingRangeIndex!];
                          const originalContent = allRecommendedContents.find(
                            (c) => c.id === content.content_id
                          );
                          const total = contentTotals.get(editingRangeIndex!);
                          
                          if (process.env.NODE_ENV === "development") {
                            console.debug("[AddedContentsList] ìƒì„¸ì •ë³´ ì—†ìŒ (ì •ìƒ):", {
                              type: "NO_DETAILS",
                              contentType: content.content_type,
                              contentId: content.content_id,
                              title: originalContent?.title || "ì œëª© ì—†ìŒ",
                              editingRangeIndex,
                              total: total || "ì—†ìŒ",
                              reason: "í•´ë‹¹ ì½˜í…ì¸ ì— ëª©ì°¨/íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë²”ìœ„ë¥¼ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                            });
                          }
                          return null;
                        })()}
                        
                        {/* ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì •ë³´ í‘œì‹œ */}
                        {(() => {
                          const content = contents[editingRangeIndex!];
                          const total = contentTotals.get(editingRangeIndex!);
                          
                          if (total) {
                            return (
                              <div className="rounded-lg border border-blue-200 bg-blue-50 p-2 text-xs text-blue-800">
                                <span className="font-medium">
                                  {content.content_type === "book" ? "ì´ í˜ì´ì§€ìˆ˜" : "ì´ íšŒì°¨"}: {total}
                                  {content.content_type === "book" ? "í˜ì´ì§€" : "íšŒì°¨"}
                                </span>
                              </div>
                            );
                          }
                          return null;
                        })()}

                        {/* ë²”ìœ„ ì§ì ‘ ì…ë ¥ */}
                        <div className="flex flex-col gap-2">
                          <div className="flex flex-col gap-1">
                            <label className="text-xs font-medium text-gray-800">
                              ì‹œì‘ ë²”ìœ„
                            </label>
                            <input
                              type="number"
                              min="1"
                              max={contentTotals.get(editingRangeIndex!) || undefined}
                              value={editingRange?.start || "1"}
                              onChange={(e) => {
                                const newStart = e.target.value;
                                const currentEnd = editingRange?.end || "1";
                                if (onRangeChange) {
                                  onRangeChange(newStart, currentEnd);
                                }
                              }}
                              className="w-full rounded border border-gray-300 px-2 py-1.5 text-xs text-gray-900 placeholder:text-gray-600 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                              placeholder="1"
                            />
                          </div>
                          <div className="flex flex-col gap-1">
                            <label className="text-xs font-medium text-gray-800">
                              ë ë²”ìœ„
                            </label>
                            <input
                              type="number"
                              min="1"
                              max={contentTotals.get(editingRangeIndex!) || undefined}
                              value={editingRange?.end || "1"}
                              onChange={(e) => {
                                const newEnd = e.target.value;
                                const currentStart = editingRange?.start || "1";
                                if (onRangeChange) {
                                  onRangeChange(currentStart, newEnd);
                                }
                              }}
                              className="w-full rounded border border-gray-300 px-2 py-1.5 text-xs text-gray-900 placeholder:text-gray-600 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                              placeholder={contentTotals.get(editingRangeIndex!)?.toString() || "100"}
                            />
                          </div>
                          
                          {/* ì„ íƒëœ ë²”ìœ„ í‘œì‹œ */}
                          {editingRange && (
                            <div className="rounded-lg border border-blue-200 bg-blue-50 p-2 text-xs text-blue-800">
                              <span className="font-medium">ì„ íƒëœ ë²”ìœ„:</span>{" "}
                              {contents[editingRangeIndex!].content_type === "book"
                                ? `${editingRange.start}í˜ì´ì§€ ~ ${editingRange.end}í˜ì´ì§€`
                                : `${editingRange.start}íšŒì°¨ ~ ${editingRange.end}íšŒì°¨`}
                            </div>
                          )}

                          {/* ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ */}
                          <div className="flex gap-2">
                            <button
                              type="button"
                              onClick={onSaveRange}
                              className="flex items-center gap-1 rounded bg-blue-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-blue-700"
                            >
                              <Check className="h-3 w-3" />
                              ì €ì¥
                            </button>
                            <button
                              type="button"
                              onClick={onCancelEditing}
                              className="flex items-center gap-1 rounded bg-gray-200 px-3 py-1.5 text-xs font-medium text-gray-800 hover:bg-gray-300"
                            >
                              <X className="h-3 w-3" />
                              ì·¨ì†Œ
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <span>
                    {content.content_type === "book"
                      ? `${content.start_range}í˜ì´ì§€ ~ ${content.end_range}í˜ì´ì§€`
                      : `${content.start_range}íšŒì°¨ ~ ${content.end_range}íšŒì°¨`}
                  </span>
                )}
              </div>
            </div>

            {/* ì•¡ì…˜ ë²„íŠ¼ */}
            <div className="flex gap-2">
              {!isEditing && (
                <button
                  type="button"
                  onClick={() => onStartEditing(index)}
                  className="rounded p-1 text-gray-400 hover:bg-gray-100 hover:text-blue-600"
                  aria-label="ë²”ìœ„ ìˆ˜ì •"
                >
                  <Pencil className="h-4 w-4" />
                </button>
              )}
              <button
                type="button"
                onClick={() => {
                  if (confirm("ì´ ì½˜í…ì¸ ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    onRemove(index);
                  }
                }}
                className="rounded p-1 text-gray-400 hover:bg-gray-100 hover:text-red-600"
                aria-label="ì½˜í…ì¸  ì œê±°"
              >
                <Trash2 className="h-4 w-4" />
              </button>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/components/RecommendationRequestForm.tsx">
/**
 * RecommendationRequestForm
 * ì¶”ì²œ ìš”ì²­ í¼ ì»´í¬ë„ŒíŠ¸ - êµê³¼ ì„ íƒ ë° ê°œìˆ˜ ì„¤ì •
 */

"use client";

import { AVAILABLE_SUBJECTS } from "../constants";

type RecommendationRequestFormProps = {
  selectedSubjects: Set<string>;
  recommendationCounts: Map<string, number>;
  autoAssignContents: boolean;
  currentStudentContentsCount: number;
  currentRecommendedContentsCount: number;
  onSubjectToggle: (subject: string) => void;
  onCountChange: (subject: string, count: number) => void;
  onAutoAssignChange: (value: boolean) => void;
  onSubmit: () => Promise<void>;
  disabled?: boolean;
};

export default function RecommendationRequestForm({
  selectedSubjects,
  recommendationCounts,
  autoAssignContents,
  currentStudentContentsCount,
  currentRecommendedContentsCount,
  onSubjectToggle,
  onCountChange,
  onAutoAssignChange,
  onSubmit,
  disabled = false,
}: RecommendationRequestFormProps) {
  const totalCount = currentStudentContentsCount + currentRecommendedContentsCount;
  const maxAvailable = 9 - totalCount;

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex flex-col gap-3">
        <h3 className="text-sm font-semibold text-gray-900">
          ì¶”ì²œ ë°›ì„ êµê³¼ ì„ íƒ
        </h3>
        <p className="text-xs text-gray-500">
          ì¶”ì²œ ë°›ê³  ì‹¶ì€ êµê³¼ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì—¬ëŸ¬ êµê³¼ë¥¼ ë™ì‹œì— ì„ íƒí•  ìˆ˜
          ìˆìŠµë‹ˆë‹¤.
        </p>
        <div className="grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-5">
          {AVAILABLE_SUBJECTS.map((subject) => {
            const isSelected = selectedSubjects.has(subject);
            return (
              <button
                key={subject}
                type="button"
                onClick={() => onSubjectToggle(subject)}
                disabled={disabled}
                className={`rounded-lg border-2 px-4 py-2 text-sm font-medium transition-colors ${
                  isSelected
                    ? "border-indigo-600 bg-indigo-50 text-indigo-700"
                    : "border-gray-300 bg-white text-gray-800 hover:border-gray-400"
                } disabled:cursor-not-allowed disabled:opacity-50`}
              >
                {subject}
              </button>
            );
          })}
        </div>
      </div>

      {/* êµê³¼ë³„ ì¶”ì²œ ê°œìˆ˜ ì„¤ì • */}
      {selectedSubjects.size > 0 && (
        <div className="flex flex-col gap-3">
          <h3 className="text-sm font-semibold text-gray-900">
            êµê³¼ë³„ ì¶”ì²œ ê°œìˆ˜ ì„¤ì •
          </h3>
          <p className="text-xs text-gray-600">
            ê° êµê³¼ë³„ë¡œ ëª‡ ê°œì˜ ì½˜í…ì¸ ë¥¼ ì¶”ì²œ ë°›ì„ì§€ ì„¤ì •í•˜ì„¸ìš”.
          </p>
          <div className="flex flex-col gap-2">
            {Array.from(selectedSubjects).map((subject) => {
              const currentCount = recommendationCounts.get(subject) || 1;
              // ë‹¤ë¥¸ êµê³¼ì˜ ì´í•©
              const totalSelectedCount = Array.from(
                recommendationCounts.values()
              ).reduce((sum, count) => sum + count, 0);
              const remainingForOthers =
                maxAvailable - (totalSelectedCount - currentCount);
              const maxForThis = Math.max(1, remainingForOthers);

              return (
                <div
                  key={subject}
                  className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-3"
                >
                  <span className="text-sm font-medium text-gray-900">
                    {subject}
                  </span>
                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      onClick={() => {
                        if (currentCount > 1) {
                          onCountChange(subject, currentCount - 1);
                        }
                      }}
                      disabled={currentCount <= 1 || disabled}
                      className="flex h-8 w-8 items-center justify-center rounded border border-gray-300 bg-white text-gray-800 disabled:cursor-not-allowed disabled:opacity-50 hover:bg-gray-50"
                    >
                      -
                    </button>
                    <span className="w-8 text-center text-sm font-semibold text-gray-900">
                      {currentCount}
                    </span>
                    <button
                      type="button"
                      onClick={() => {
                        if (currentCount < maxForThis) {
                          onCountChange(subject, currentCount + 1);
                        }
                      }}
                      disabled={currentCount >= maxForThis || disabled}
                      className="flex h-8 w-8 items-center justify-center rounded border border-gray-300 bg-white text-gray-800 disabled:cursor-not-allowed disabled:opacity-50 hover:bg-gray-50"
                    >
                      +
                    </button>
                    <span className="text-xs text-gray-500">
                      (ìµœëŒ€ {maxForThis}ê°œ)
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
          <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
            <p className="text-xs text-blue-800">
              í˜„ì¬ í•™ìƒ ì½˜í…ì¸ : {currentStudentContentsCount}ê°œ, ì¶”ì²œ ì½˜í…ì¸ :{" "}
              {currentRecommendedContentsCount}ê°œ
              <br />
              ì¶”ê°€ ê°€ëŠ¥: {Math.max(0, maxAvailable)}ê°œ / ì „ì²´ ìµœëŒ€ 9ê°œ
            </p>
          </div>
        </div>
      )}

      {/* ì½˜í…ì¸  ìë™ ë°°ì • ì˜µì…˜ */}
      <div className="flex items-center gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
        <label className="flex items-center gap-2">
          <input
            type="checkbox"
            checked={autoAssignContents}
            onChange={(e) => {
              console.log("[RecommendationRequestForm] ìë™ ë°°ì • ì²´í¬ë°•ìŠ¤ ë³€ê²½:", e.target.checked);
              onAutoAssignChange(e.target.checked);
            }}
            disabled={disabled}
            className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-50"
          />
          <span className="text-sm font-medium text-gray-800">
            ì½˜í…ì¸  ìë™ ë°°ì •
          </span>
        </label>
        <p className="text-xs text-gray-500">
          ì„ íƒ ì‹œ ì¶”ì²œ ë°›ì€ ì½˜í…ì¸ ë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€ ì¶”ì²œ ì½˜í…ì¸ ë¡œ ì´ë™í•©ë‹ˆë‹¤.
        </p>
      </div>

      {/* ì¶”ì²œë°›ê¸° ë²„íŠ¼ */}
      <div className="flex justify-center">
        <button
          type="button"
          onClick={() => {
            console.log("[RecommendationRequestForm] ì¶”ì²œë°›ê¸° ë²„íŠ¼ í´ë¦­:", {
              selectedSubjects: Array.from(selectedSubjects),
              recommendationCounts: Object.fromEntries(recommendationCounts),
              autoAssignContents,
              disabled,
            });
            onSubmit();
          }}
          disabled={selectedSubjects.size === 0 || disabled}
          className="rounded-lg bg-indigo-600 px-6 py-3 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-400"
        >
          ì¶”ì²œë°›ê¸°
        </button>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/components/RecommendedContentCard.tsx">
/**
 * RecommendedContentCard
 * ì¶”ì²œ ì½˜í…ì¸  ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
 */

"use client";

import { RecommendedContent } from "../types";
import { formatNumber } from "@/lib/utils/formatNumber";

type RecommendedContentCardProps = {
  content: RecommendedContent;
  isSelected: boolean;
  onToggleSelection: (contentId: string) => void;
};

export default function RecommendedContentCard({
  content,
  isSelected,
  onToggleSelection,
}: RecommendedContentCardProps) {
  return (
    <label
      className={`flex cursor-pointer items-start gap-3 rounded-lg border p-3 transition-colors ${
        isSelected
          ? "border-gray-900 bg-gray-50"
          : "border-gray-200 hover:bg-gray-50"
      }`}
    >
      <input
        type="checkbox"
        checked={isSelected}
        onChange={() => onToggleSelection(content.id)}
        className="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900"
      />
      <div className="flex flex-1 flex-col gap-1">
        <div className="flex items-start justify-between gap-2">
          <div className="flex flex-1 flex-col gap-1">
            {/* ì œëª© */}
            <div className="text-sm font-medium text-gray-900">
              {content.title}
            </div>

            {/* ë©”íƒ€ ì •ë³´ */}
            <div className="flex flex-wrap items-center gap-2 text-xs text-gray-500">
              {/* ì½˜í…ì¸  íƒ€ì… */}
              {content.contentType === "book" && (
                <span className="rounded bg-blue-100 px-1.5 py-0.5 text-blue-800">
                  ğŸ“š êµì¬
                </span>
              )}
              {content.contentType === "lecture" && (
                <span className="rounded bg-purple-100 px-1.5 py-0.5 text-purple-800">
                  ğŸ§ ê°•ì˜
                </span>
              )}

              {/* ê³¼ëª© */}
              {content.subject && (
                <>
                  <span>Â·</span>
                  <span>{content.subject}</span>
                </>
              )}

              {/* í•™ê¸° */}
              {content.semester && (
                <>
                  <span>Â·</span>
                  <span>{content.semester}</span>
                </>
              )}

              {/* ê°œì •íŒ */}
              {content.revision && (
                <>
                  <span>Â·</span>
                  <span className="font-medium text-indigo-600">
                    {content.revision} ê°œì •íŒ
                  </span>
                </>
              )}

              {/* ë‚œì´ë„ */}
              {content.difficulty_level && (
                <>
                  <span>Â·</span>
                  <span className="rounded bg-indigo-100 px-1.5 py-0.5 text-indigo-800 text-xs">
                    {content.difficulty_level}
                  </span>
                </>
              )}

              {/* ì¶œíŒì‚¬ */}
              {content.publisher && (
                <>
                  <span>Â·</span>
                  <span>{content.publisher}</span>
                </>
              )}

              {/* í”Œë«í¼ */}
              {content.platform && (
                <>
                  <span>Â·</span>
                  <span>{content.platform}</span>
                </>
              )}
            </div>

            {/* ì¶”ì²œ ì´ìœ  */}
            <div className="text-xs text-gray-600">
              <span className="font-medium">ì¶”ì²œ ì´ìœ :</span> {content.reason}
            </div>

            {/* ì„±ì  ë°ì´í„° */}
            {content.scoreDetails && (
              <div className="flex flex-wrap gap-1 text-xs">
                {/* ë‚´ì‹  í‰ê·  */}
                {content.scoreDetails.schoolAverageGrade !== null &&
                  content.scoreDetails.schoolAverageGrade !== undefined && (
                    <span className="rounded bg-blue-100 px-1.5 py-0.5 text-blue-800">
                      ë‚´ì‹  í‰ê· {" "}
                      {formatNumber(content.scoreDetails.schoolAverageGrade)}
                      ë“±ê¸‰
                    </span>
                  )}

                {/* ëª¨ì˜ê³ ì‚¬ ë°±ë¶„ìœ„ */}
                {content.scoreDetails.mockPercentile !== null &&
                  content.scoreDetails.mockPercentile !== undefined && (
                    <span className="rounded bg-purple-100 px-1.5 py-0.5 text-purple-800">
                      ëª¨ì˜ê³ ì‚¬{" "}
                      {formatNumber(content.scoreDetails.mockPercentile)}%
                    </span>
                  )}

                {/* ìœ„í—˜ë„ */}
                {content.scoreDetails.riskScore !== undefined &&
                  content.scoreDetails.riskScore >= 50 && (
                    <span className="rounded bg-red-100 px-1.5 py-0.5 text-red-800">
                      ìœ„í—˜ë„ {formatNumber(content.scoreDetails.riskScore)}ì 
                    </span>
                  )}
              </div>
            )}
          </div>
        </div>
      </div>
    </label>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/components/RecommendedContentsList.tsx">
/**
 * RecommendedContentsList
 * ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ ë° ì¬ì¶”ì²œ ë²„íŠ¼ í¬í•¨
 */

"use client";

import { RecommendedContent } from "../types";
import RecommendedContentCard from "./RecommendedContentCard";
import { RefreshCw } from "lucide-react";

type RecommendedContentsListProps = {
  recommendedContents: RecommendedContent[];
  selectedContentIds: Set<string>;
  selectedSubjects: Set<string>;
  recommendationCounts: Map<string, number>;
  requiredSubjectCategories: string[];
  selectedSubjectCategories: Set<string>;
  missingRequiredSubjects: Array<{
    name: string;
    current: number;
    required: number;
  }>;
  studentCount: number;
  recommendedCount: number;
  loading: boolean;
  onToggleSelection: (contentId: string) => void;
  onRefresh: () => Promise<void>;
  onAddSelectedContents: () => Promise<void>;
};

export default function RecommendedContentsList({
  recommendedContents,
  selectedContentIds,
  selectedSubjects,
  recommendationCounts,
  requiredSubjectCategories,
  selectedSubjectCategories,
  missingRequiredSubjects,
  studentCount,
  recommendedCount,
  loading,
  onToggleSelection,
  onRefresh,
  onAddSelectedContents,
}: RecommendedContentsListProps) {
  const totalCount = studentCount + recommendedCount;

  // ê³¼ëª©ë³„ ê·¸ë£¹í™”
  const contentsBySubject = new Map<string, RecommendedContent[]>();
  recommendedContents.forEach((content) => {
    const subject = content.subject_category || "ê¸°íƒ€";
    if (!contentsBySubject.has(subject)) {
      contentsBySubject.set(subject, []);
    }
    contentsBySubject.get(subject)!.push(content);
  });

  // í•„ìˆ˜ ê³¼ëª© ìš°ì„  ì •ë ¬
  const sortedSubjects = Array.from(contentsBySubject.keys()).sort((a, b) => {
    const aIndex = requiredSubjectCategories.indexOf(a);
    const bIndex = requiredSubjectCategories.indexOf(b);
    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
    if (aIndex !== -1) return -1;
    if (bIndex !== -1) return 1;
    return a.localeCompare(b);
  });

  return (
    <div className="flex flex-col gap-4">
      {/* ì¬ì¶”ì²œ ë²„íŠ¼ */}
      <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex flex-col gap-1">
          <h3 className="text-sm font-semibold text-gray-900">
            ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡
          </h3>
          <p className="text-xs text-gray-500">
            ì¶”ì²œ ê²°ê³¼ê°€ ë§ˆìŒì— ë“¤ì§€ ì•Šìœ¼ë©´ ë‹¤ì‹œ ì¶”ì²œë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <button
          type="button"
          onClick={onRefresh}
          disabled={loading || selectedSubjects.size === 0}
          className="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <RefreshCw className="h-4 w-4" />
          ì¶”ì²œ ë‹¤ì‹œ ë°›ê¸°
        </button>
      </div>

      {/* ê³¼ëª©ë³„ ê·¸ë£¹í™”ëœ ì¶”ì²œ ëª©ë¡ */}
      <div className="flex flex-col gap-6">
        {sortedSubjects.map((subject) => {
          const contents = contentsBySubject.get(subject) || [];
          const isRequired = requiredSubjectCategories.includes(subject);
          const isSelected = selectedSubjectCategories.has(subject);

          return (
            <div
              key={subject}
              className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <h3 className="text-sm font-semibold text-gray-900">
                    {subject}
                  </h3>
                  {isRequired && (
                    <span className="rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800">
                      í•„ìˆ˜
                    </span>
                  )}
                  {isRequired && !isSelected && (
                    <span className="text-xs text-red-600">
                      (1ê°œ ì´ìƒ ì„ íƒ í•„ìš”)
                    </span>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-xs text-gray-500">
                    {contents.length}ê°œ ì¶”ì²œ
                  </span>
                  {contents.some(
                    (c) =>
                      c.scoreDetails?.riskScore &&
                      c.scoreDetails.riskScore >= 50
                  ) && (
                    <span className="rounded-full bg-orange-100 px-2 py-0.5 text-xs font-medium text-orange-800">
                      âš ï¸ ìœ„í—˜ë„ ë†’ìŒ
                    </span>
                  )}
                  {contents.some((c) =>
                    c.reason.includes("ì·¨ì•½ ê³¼ëª©")
                  ) && (
                    <span className="rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">
                      ì·¨ì•½ ê³¼ëª©
                    </span>
                  )}
                </div>
              </div>
              <div className="flex flex-col gap-2">
                {contents.map((content) => {
                  const isSelected = selectedContentIds.has(content.id);
                  return (
                    <RecommendedContentCard
                      key={content.id}
                      content={content}
                      isSelected={isSelected}
                      onToggleSelection={onToggleSelection}
                    />
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>

      {/* ì„ íƒ ìš”ì•½ ë° ì¶”ê°€ ë²„íŠ¼ */}
      <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between">
            <div className="text-sm font-medium text-gray-800">
              ì„ íƒëœ ì¶”ì²œ ì½˜í…ì¸ : {selectedContentIds.size}ê°œ
              {totalCount > 0 && (
                <span className="text-gray-500">
                  {" "}(ì „ì²´ {totalCount}ê°œ ì¤‘ í•™ìƒ {studentCount}ê°œ, ì¶”ì²œ{" "}
                  {recommendedCount}ê°œ)
                </span>
              )}
            </div>
            {missingRequiredSubjects.length > 0 && (
              <div className="text-xs font-medium text-red-600">
                í•„ìˆ˜ ê³¼ëª© ë¯¸ì¶©ì¡±:{" "}
                {missingRequiredSubjects
                  .map((m) => `${m.name} (${m.current}/${m.required})`)
                  .join(", ")}
              </div>
            )}
          </div>
          {selectedContentIds.size > 0 && (
            <div className="flex flex-col gap-1 rounded-lg border border-green-200 bg-green-50 p-2">
              <div className="text-xs text-green-800">
                <span className="font-medium">ì„ íƒëœ ì¶”ì²œ ì½˜í…ì¸ :</span>
                <div className="flex flex-col gap-1">
                  {Array.from(selectedContentIds).map((id) => {
                    const content = recommendedContents.find(
                      (c) => c.id === id
                    );
                    if (!content) return null;
                    return (
                      <div key={id} className="flex items-center gap-2">
                        <span className="text-green-700">
                          {content.contentType === "book" ? "ğŸ“š" : "ğŸ§"}{" "}
                          {content.title}
                        </span>
                        {content.difficulty_level && (
                          <span className="rounded bg-green-100 px-1.5 py-0.5 text-xs text-green-800">
                            {content.difficulty_level}
                          </span>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}
        </div>
        <button
          type="button"
          onClick={() => {
            console.log("[RecommendedContentsList] ì„ íƒí•œ ì½˜í…ì¸  ì¶”ê°€í•˜ê¸° ë²„íŠ¼ í´ë¦­:", {
              selectedContentIds: Array.from(selectedContentIds),
              selectedContentIdsSize: selectedContentIds.size,
              totalCount,
              missingRequiredSubjects,
              disabled:
                selectedContentIds.size === 0 ||
                missingRequiredSubjects.length > 0 ||
                totalCount + selectedContentIds.size > 9,
            });
            onAddSelectedContents();
          }}
          disabled={
            selectedContentIds.size === 0 ||
            missingRequiredSubjects.length > 0 ||
            totalCount + selectedContentIds.size > 9
          }
          className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
        >
          ì„ íƒí•œ ì½˜í…ì¸  ì¶”ê°€í•˜ê¸° ({totalCount + selectedContentIds.size}/9)
        </button>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/components/RequiredSubjectItem.tsx">
/**
 * RequiredSubjectItem
 * í•„ìˆ˜ êµê³¼ ê°œë³„ í•­ëª© ì»´í¬ë„ŒíŠ¸
 * ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ì§€ì • ì§€ì›
 */

"use client";

import { useState, useEffect } from "react";
import { X, ChevronDown, ChevronUp } from "lucide-react";
import type { SubjectGroup } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

type RequiredSubjectItemProps = {
  requirement: {
    subject_group_id: string;
    subject_category: string;
    min_count: number;
    subjects_by_curriculum?: Array<{
      curriculum_revision_id: string;
      subject_id?: string;
      subject_name?: string;
    }>;
  };
  index: number;
  availableSubjectGroups: SubjectGroup[];
  curriculumRevisions: CurriculumRevision[];
  onLoadSubjects: (
    subjectGroupId: string,
    curriculumRevisionId: string
  ) => Promise<Array<{ id: string; name: string }>>;
  onUpdate: (
    updated: Partial<{
      subject_group_id: string;
      subject_category: string;
      min_count: number;
      subjects_by_curriculum?: Array<{
        curriculum_revision_id: string;
        subject_id?: string;
        subject_name?: string;
      }>;
    }>
  ) => void;
  onRemove: () => void;
};

export default function RequiredSubjectItem({
  requirement,
  availableSubjectGroups,
  curriculumRevisions,
  onLoadSubjects,
  onUpdate,
  onRemove,
}: RequiredSubjectItemProps) {
  const [showCurriculumSubjects, setShowCurriculumSubjects] = useState(false);
  const [subjectsByCurriculum, setSubjectsByCurriculum] = useState<
    Map<string, Array<{ id: string; name: string }>>
  >(new Map());
  const [loadingSubjects, setLoadingSubjects] = useState<Set<string>>(
    new Set()
  );

  // êµê³¼ ê·¸ë£¹ ì´ë¦„ìœ¼ë¡œ ì¤‘ë³µ ì œê±°ëœ ëª©ë¡ ìƒì„±
  const uniqueSubjectGroups = availableSubjectGroups.reduce((acc, group) => {
    if (!acc.find((g) => g.name === group.name)) {
      acc.push(group);
    }
    return acc;
  }, [] as SubjectGroup[]);

  // êµê³¼ ë³€ê²½ ì‹œ subjects_by_curriculum ì´ˆê¸°í™”
  const handleSubjectGroupChange = (subjectGroupId: string) => {
    const selectedGroup = availableSubjectGroups.find(
      (g) => g.id === subjectGroupId
    );
    onUpdate({
      subject_group_id: subjectGroupId,
      subject_category: selectedGroup?.name || "",
      subjects_by_curriculum: [], // êµê³¼ ë³€ê²½ ì‹œ ì´ˆê¸°í™”
    });
    setSubjectsByCurriculum(new Map());
  };

  // ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ë¡œë“œ
  const handleLoadSubjects = async (
    subjectGroupId: string,
    curriculumRevisionId: string
  ) => {
    const key = `${subjectGroupId}-${curriculumRevisionId}`;
    if (subjectsByCurriculum.has(key)) {
      return;
    }

    setLoadingSubjects((prev) => new Set(prev).add(key));
    try {
      const subjects = await onLoadSubjects(
        subjectGroupId,
        curriculumRevisionId
      );
      setSubjectsByCurriculum((prev) => new Map(prev).set(key, subjects));
    } catch (error) {
      console.error("ì„¸ë¶€ ê³¼ëª© ì¡°íšŒ ì‹¤íŒ¨:", error);
    } finally {
      setLoadingSubjects((prev) => {
        const newSet = new Set(prev);
        newSet.delete(key);
        return newSet;
      });
    }
  };

  // ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ì—…ë°ì´íŠ¸
  const handleSubjectChange = (
    curriculumRevisionId: string,
    subjectId: string | undefined,
    subjectName: string | undefined
  ) => {
    const currentSubjects = requirement.subjects_by_curriculum || [];
    const existingIndex = currentSubjects.findIndex(
      (s) => s.curriculum_revision_id === curriculumRevisionId
    );

    let updatedSubjects: Array<{
      curriculum_revision_id: string;
      subject_id?: string;
      subject_name?: string;
    }>;

    if (subjectId && subjectName) {
      if (existingIndex >= 0) {
        // ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸
        updatedSubjects = [...currentSubjects];
        updatedSubjects[existingIndex] = {
          curriculum_revision_id: curriculumRevisionId,
          subject_id: subjectId,
          subject_name: subjectName,
        };
      } else {
        // ìƒˆ í•­ëª© ì¶”ê°€
        updatedSubjects = [
          ...currentSubjects,
          {
            curriculum_revision_id: curriculumRevisionId,
            subject_id: subjectId,
            subject_name: subjectName,
          },
        ];
      }
    } else {
      // ì„¸ë¶€ ê³¼ëª© ì œê±°
      if (existingIndex >= 0) {
        updatedSubjects = currentSubjects.filter(
          (s) => s.curriculum_revision_id !== curriculumRevisionId
        );
      } else {
        updatedSubjects = currentSubjects;
      }
    }

    onUpdate({
      subjects_by_curriculum: updatedSubjects,
    });
  };

  // í˜„ì¬ ì„ íƒëœ ì„¸ë¶€ ê³¼ëª© ê°€ì ¸ì˜¤ê¸°
  const getSelectedSubject = (curriculumRevisionId: string) => {
    return requirement.subjects_by_curriculum?.find(
      (s) => s.curriculum_revision_id === curriculumRevisionId
    );
  };

  return (
    <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
      <div className="flex items-start gap-3">
        {/* êµê³¼ ì„ íƒ */}
        <div className="flex flex-1 flex-col gap-1">
          <label className="text-xs font-medium text-gray-800">
            êµê³¼
          </label>
          <select
            value={requirement.subject_group_id}
            onChange={(e) => handleSubjectGroupChange(e.target.value)}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
          >
            <option value="">êµê³¼ ì„ íƒ</option>
            {uniqueSubjectGroups.map((group) => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
        </div>

        {/* ìµœì†Œ ê°œìˆ˜ */}
        <div className="flex w-24 flex-col gap-1">
          <label className="text-xs font-medium text-gray-800">
            ìµœì†Œ ê°œìˆ˜
          </label>
          <input
            type="number"
            min="1"
            max="9"
            value={requirement.min_count}
            onChange={(e) =>
              onUpdate({ min_count: parseInt(e.target.value) || 1 })
            }
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
          />
        </div>

        {/* ì‚­ì œ ë²„íŠ¼ */}
        <button
          type="button"
          onClick={onRemove}
          className="text-gray-600 hover:text-red-600 transition-colors"
          aria-label="í•„ìˆ˜ êµê³¼ ì‚­ì œ"
        >
          <X className="h-5 w-5" />
        </button>
      </div>

      {/* ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ì„ íƒ */}
      {requirement.subject_group_id && (
        <div className="flex flex-col gap-3">
          <button
            type="button"
            onClick={() => {
              setShowCurriculumSubjects(!showCurriculumSubjects);
              // ì²˜ìŒ ì—´ ë•Œ ëª¨ë“  ê°œì •êµìœ¡ê³¼ì •ì˜ ê³¼ëª© ë¡œë“œ
              if (!showCurriculumSubjects && requirement.subject_group_id) {
                curriculumRevisions.forEach((revision) => {
                  handleLoadSubjects(requirement.subject_group_id, revision.id);
                });
              }
            }}
            className="flex items-center gap-1 text-xs text-blue-800 hover:text-blue-800 transition-colors"
          >
            {showCurriculumSubjects ? (
              <>
                <ChevronUp className="h-3 w-3" />
                ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ìˆ¨ê¸°ê¸°
              </>
            ) : (
              <>
                <ChevronDown className="h-3 w-3" />
                ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ì§€ì • (ì„ íƒì‚¬í•­)
              </>
            )}
          </button>

          {showCurriculumSubjects && (
            <div className="flex flex-col gap-3">
              {curriculumRevisions.map((revision) => {
                const key = `${requirement.subject_group_id}-${revision.id}`;
                const subjects = subjectsByCurriculum.get(key) || [];
                const isLoading = loadingSubjects.has(key);
                const selectedSubject = getSelectedSubject(revision.id);

                return (
                  <div
                    key={revision.id}
                    className="flex flex-col gap-2 rounded border border-gray-200 bg-white p-3"
                  >
                    <label className="text-xs font-medium text-gray-800">
                      {revision.name}{" "}
                      {revision.year ? `(${revision.year})` : ""}
                    </label>
                    {isLoading ? (
                      <p className="text-xs text-gray-800">
                        ì„¸ë¶€ ê³¼ëª© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                      </p>
                    ) : subjects.length > 0 ? (
                      <select
                        value={selectedSubject?.subject_id || ""}
                        onChange={(e) => {
                          const selectedOption =
                            e.target.options[e.target.selectedIndex];
                          const subjectId = e.target.value || undefined;
                          const subjectName =
                            selectedOption.text !== "ì„¸ë¶€ ê³¼ëª© ì„ íƒ (ì „ì²´)"
                              ? selectedOption.text
                              : undefined;
                          handleSubjectChange(
                            revision.id,
                            subjectId,
                            subjectName
                          );
                        }}
                        className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
                      >
                        <option value="">ì„¸ë¶€ ê³¼ëª© ì„ íƒ (ì „ì²´)</option>
                        {subjects.map((subject) => (
                          <option key={subject.id} value={subject.id}>
                            {subject.name}
                          </option>
                        ))}
                      </select>
                    ) : (
                      <p className="text-xs text-gray-800">
                        ì„¸ë¶€ ê³¼ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                      </p>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/components/RequiredSubjectsSection.tsx">
/**
 * RequiredSubjectsSection
 * í•„ìˆ˜ êµê³¼ ì„¤ì • ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸
 */

"use client";

import { useState, useEffect, useMemo } from "react";
import { WizardData } from "../../PlanGroupWizard";
import RequiredSubjectItem from "./RequiredSubjectItem";
import { getCurriculumRevisionsAction, getSubjectGroupsAction } from "@/app/(student)/actions/contentMetadataActions";
import { getCurrentStudent } from "@/app/(student)/actions/studentActions";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import type { SubjectGroup } from "@/lib/data/subjects";

type RequiredSubjectsSectionProps = {
  data: WizardData;
  availableSubjectGroups: SubjectGroup[]; // subject_groups í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
  curriculumRevisions: CurriculumRevision[]; // ê°œì •êµìœ¡ê³¼ì • ëª©ë¡
  onUpdate: (updates: Partial<WizardData>) => void;
  onLoadSubjects: (subjectGroupId: string, curriculumRevisionId: string) => Promise<Array<{ id: string; name: string }>>;
  onAddRequiredSubject: () => void;
  onUpdateRequiredSubject: (
    index: number,
    updated: Partial<{
      subject_group_id: string;
      subject_category: string;
      min_count: number;
      subjects_by_curriculum?: Array<{
        curriculum_revision_id: string;
        subject_id?: string;
        subject_name?: string;
      }>;
    }>
  ) => void;
  onRemoveRequiredSubject: (index: number) => void;
  onConstraintHandlingChange: (handling: "strict" | "warning" | "auto_fix") => void;
  isTemplateMode?: boolean;
  isCampMode?: boolean;
  studentId?: string;
};

export default function RequiredSubjectsSection({
  data,
  availableSubjectGroups,
  curriculumRevisions,
  onLoadSubjects,
  onAddRequiredSubject,
  onUpdateRequiredSubject,
  onRemoveRequiredSubject,
  onConstraintHandlingChange,
  isTemplateMode = false,
  isCampMode = false,
  studentId,
}: RequiredSubjectsSectionProps) {
  const [studentCurriculumRevision, setStudentCurriculumRevision] = useState<string | null>(null);
  const [loadingStudentCurriculum, setLoadingStudentCurriculum] = useState(false);

  // í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì • í™•ì¸ (ìº í”„ ëª¨ë“œì¼ ë•Œë§Œ)
  useEffect(() => {
    if (isCampMode && studentId) {
      setLoadingStudentCurriculum(true);
      getCurrentStudent()
        .then((student) => {
          if (student?.curriculum_revision) {
            setStudentCurriculumRevision(student.curriculum_revision);
          }
        })
        .catch((error) => {
          console.error("í•™ìƒ ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ ì‹¤íŒ¨:", error);
        })
        .finally(() => {
          setLoadingStudentCurriculum(false);
        });
    }
  }, [isCampMode, studentId]);

  // í…œí”Œë¦¿ì˜ ê°œì •êµìœ¡ê³¼ì •ê³¼ í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì • ë¹„êµ
  const curriculumMismatch = useMemo(() => {
    if (!isCampMode || !studentCurriculumRevision) {
      return null;
    }

    // required_subjectsì—ì„œ ì‚¬ìš© ì¤‘ì¸ ê°œì •êµìœ¡ê³¼ì • í™•ì¸
    const usedCurriculumIds = new Set<string>();
    data.subject_constraints?.required_subjects?.forEach((req) => {
      req.subjects_by_curriculum?.forEach((subj) => {
        if (subj.curriculum_revision_id) {
          usedCurriculumIds.add(subj.curriculum_revision_id);
        }
      });
    });

    if (usedCurriculumIds.size === 0) {
      return null;
    }

    // í•™ìƒì˜ curriculum_revision í…ìŠ¤íŠ¸ì™€ ì‚¬ìš© ì¤‘ì¸ ê°œì •êµìœ¡ê³¼ì • ë¹„êµ
    const studentRevisionNormalized = studentCurriculumRevision.trim();
    const studentYear = studentRevisionNormalized.match(/\d{4}/)?.[0];

    // ì‚¬ìš© ì¤‘ì¸ ê°œì •êµìœ¡ê³¼ì • ì¤‘ í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì •ê³¼ ì¼ì¹˜í•˜ëŠ” ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸
    const hasMatchingCurriculum = Array.from(usedCurriculumIds).some((revisionId) => {
      const revision = curriculumRevisions.find((r) => r.id === revisionId);
      if (!revision) return false;

      const revisionYear = revision.year?.toString();
      if (revisionYear && studentYear) {
        return revisionYear === studentYear;
      }

      const revisionNameNormalized = revision.name.replace(/êµìœ¡ê³¼ì •/g, "").trim();
      return (
        revisionNameNormalized.includes(studentRevisionNormalized) ||
        studentRevisionNormalized.includes(revisionNameNormalized)
      );
    });

    return !hasMatchingCurriculum;
  }, [isCampMode, studentCurriculumRevision, curriculumRevisions, data.subject_constraints]);

  return (
    <div className="flex flex-col gap-4 rounded-lg border-2 border-blue-300 bg-blue-50 p-6 shadow-md">
      <div className="flex flex-col gap-2">
        <div className="flex items-center gap-2">
          <h2 className="text-lg font-semibold text-gray-900">
            í•„ìˆ˜ êµê³¼ ì„¤ì •
          </h2>
          <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
            í•„ìˆ˜
          </span>
        </div>
        <p className="text-sm text-gray-600">
          í”Œëœ ìƒì„± ì‹œ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” êµê³¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ì˜ˆ: êµ­ì–´, ìˆ˜í•™,
          ì˜ì–´)
        </p>
      </div>

      <div className="flex flex-col gap-4">
        {/* í•™ìƒ ê°œì •êµìœ¡ê³¼ì • ë¶ˆì¼ì¹˜ ê²½ê³  (ìº í”„ ëª¨ë“œì¼ ë•Œë§Œ) */}
        {isCampMode && curriculumMismatch && (
          <div className="flex flex-col gap-1 rounded-lg border-2 border-amber-300 bg-amber-50 p-4">
            <div className="flex items-start gap-2">
              <span className="text-amber-600">âš ï¸</span>
              <div className="flex flex-1 flex-col gap-1">
                <p className="text-sm font-medium text-amber-800">
                  ê°œì •êµìœ¡ê³¼ì • ë¶ˆì¼ì¹˜
                </p>
                <p className="text-xs text-amber-700">
                  í…œí”Œë¦¿ì— ì„¤ì •ëœ ê°œì •êµìœ¡ê³¼ì •ê³¼ í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì •ì´ ë‹¤ë¦…ë‹ˆë‹¤.{" "}
                  {studentCurriculumRevision && (
                    <>í•™ìƒ: {studentCurriculumRevision}</>
                  )}
                </p>
              </div>
            </div>
          </div>
        )}

        <p className="text-sm text-gray-600">
          í”Œëœ ìƒì„± ì‹œ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” êµê³¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ê°œì •êµìœ¡ê³¼ì •ë³„ë¡œ
          ì„¸ë¶€ ê³¼ëª©ì„ ì§€ì •í•˜ì—¬ ë” ì •í™•í•œ ì œì•½ ì¡°ê±´ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        {/* í•„ìˆ˜ êµê³¼ ëª©ë¡ */}
        {(data.subject_constraints?.required_subjects || []).length > 0 && (
          <div className="flex flex-col gap-3">
            {(data.subject_constraints?.required_subjects || []).map(
              (req, index) => (
                <RequiredSubjectItem
                  key={index}
                  requirement={req}
                  index={index}
                  availableSubjectGroups={availableSubjectGroups}
                  curriculumRevisions={curriculumRevisions}
                  onLoadSubjects={onLoadSubjects}
                  onUpdate={(updated) =>
                    onUpdateRequiredSubject(index, updated)
                  }
                  onRemove={() => onRemoveRequiredSubject(index)}
                />
              )
            )}
          </div>
        )}

        {/* êµê³¼ ì¶”ê°€ ë²„íŠ¼ */}
        <button
          type="button"
          onClick={onAddRequiredSubject}
          className="w-full rounded-lg border-2 border-dashed border-gray-300 p-3 text-sm text-gray-600 hover:border-gray-400 hover:text-gray-800 transition-colors"
        >
          + í•„ìˆ˜ êµê³¼ ì¶”ê°€
        </button>

        {/* ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ì‹ */}
        <div className="flex flex-col gap-1">
          <label className="text-sm font-medium text-gray-800">
            ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ì‹
          </label>
          <select
            value={data.subject_constraints?.constraint_handling || "warning"}
            onChange={(e) =>
              onConstraintHandlingChange(
                e.target.value as "strict" | "warning" | "auto_fix"
              )
            }
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
          >
            <option value="warning">
              ê²½ê³  (ê¶Œì¥) - ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì§„í–‰
            </option>
            <option value="strict">
              ì—„ê²© (í•„ìˆ˜) - ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ì§„í–‰ ë¶ˆê°€
            </option>
            <option value="auto_fix">
              ìë™ ë³´ì • - ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ë³´ì •
            </option>
          </select>
          <p className="text-xs text-gray-500">
            {data.subject_constraints?.constraint_handling === "warning" &&
              "ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ê²½ê³ ë¥¼ í‘œì‹œí•˜ì§€ë§Œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
            {data.subject_constraints?.constraint_handling === "strict" &&
              "ì¡°ê±´ì„ ë°˜ë“œì‹œ ì¶©ì¡±í•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
            {data.subject_constraints?.constraint_handling === "auto_fix" &&
              "ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ í•„ìš”í•œ ì½˜í…ì¸ ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤."}
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/hooks/useContentSelection.ts">
/**
 * useContentSelection Hook
 * ì½˜í…ì¸  ì„ íƒ ìƒíƒœ ê´€ë¦¬
 */

import { useState, useCallback } from "react";
import { WizardData } from "../../PlanGroupWizard";
import { RecommendedContent, UseContentSelectionReturn } from "../types";
import { MAX_CONTENTS, ERROR_MESSAGES, SUCCESS_MESSAGES } from "../constants";

type UseContentSelectionProps = {
  data: WizardData;
  recommendedContents: RecommendedContent[];
  allRecommendedContents: RecommendedContent[];
  onUpdate: (updates: Partial<WizardData>) => void;
};

export function useContentSelection({
  data,
  recommendedContents,
  allRecommendedContents,
  onUpdate,
}: UseContentSelectionProps): UseContentSelectionReturn {
  const [selectedContentIds, setSelectedContentIds] = useState<Set<string>>(
    new Set()
  );

  /**
   * ì½˜í…ì¸  ì„ íƒ í† ê¸€
   */
  const toggleContentSelection = useCallback((contentId: string) => {
    setSelectedContentIds((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(contentId)) {
        newSet.delete(contentId);
      } else {
        // ì¤‘ë³µ í™•ì¸
        const isDuplicate =
          data.student_contents.some((c) => c.content_id === contentId) ||
          data.recommended_contents.some((c) => c.content_id === contentId);
        
        if (isDuplicate) {
          alert(ERROR_MESSAGES.ALREADY_SELECTED);
          return prev;
        }
        newSet.add(contentId);
      }
      return newSet;
    });
  }, [data.student_contents, data.recommended_contents]);

  /**
   * ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ
   */
  const fetchContentTotal = useCallback(async (
    contentType: "book" | "lecture",
    contentId: string
  ): Promise<number | null> => {
    try {
      const response = await fetch(
        `/api/master-content-info?content_type=${contentType}&content_id=${contentId}`
      );
      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data) {
          if (contentType === "book") {
            return result.data.total_pages ?? null;
          } else {
            return result.data.total_episodes ?? null;
          }
        }
      }
      return null;
    } catch (error) {
      console.error("[useContentSelection] ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ ì‹¤íŒ¨:", {
        contentType,
        contentId,
        error,
      });
      return null;
    }
  }, []);

  /**
   * ì„ íƒëœ ì½˜í…ì¸  ì¶”ê°€
   */
  const addSelectedContents = useCallback(async () => {
    console.log("[useContentSelection] addSelectedContents í˜¸ì¶œ:", {
      selectedContentIds: Array.from(selectedContentIds),
      selectedContentIdsSize: selectedContentIds.size,
      currentStudentContents: data.student_contents.length,
      currentRecommendedContents: data.recommended_contents.length,
    });

    if (selectedContentIds.size === 0) {
      console.warn("[useContentSelection] ì„ íƒëœ ì½˜í…ì¸ ê°€ ì—†ìŒ");
      alert(ERROR_MESSAGES.NO_CONTENT_SELECTED);
      return;
    }

    // ìµœëŒ€ ê°œìˆ˜ í™•ì¸
    const currentTotal =
      data.student_contents.length + data.recommended_contents.length;
    const toAdd = selectedContentIds.size;

    console.log("[useContentSelection] ê°œìˆ˜ í™•ì¸:", {
      currentTotal,
      toAdd,
      max: MAX_CONTENTS,
      willExceed: currentTotal + toAdd > MAX_CONTENTS,
    });

    if (currentTotal + toAdd > MAX_CONTENTS) {
      console.warn("[useContentSelection] ìµœëŒ€ ê°œìˆ˜ ì´ˆê³¼");
      alert(ERROR_MESSAGES.EXCEED_MAX_CONTENTS(currentTotal, toAdd, MAX_CONTENTS));
      return;
    }

    // ì„ íƒëœ ì½˜í…ì¸  ì •ë³´ ìˆ˜ì§‘
    const contentsToAdd: Array<{
      content_type: "book" | "lecture";
      content_id: string;
      start_range: number;
      end_range: number;
      title?: string;
      subject_category?: string;
      master_content_id?: string;
      recommendation_reason?: string;
    }> = [];

    // ê° ì½˜í…ì¸ ì˜ ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ
    for (const contentId of selectedContentIds) {
      const content = recommendedContents.find((c) => c.id === contentId);
      if (content) {
        // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ
        const total = await fetchContentTotal(content.contentType, content.id);
        const endRange = total && total > 0 ? total : 100;

        contentsToAdd.push({
          content_type: content.contentType,
          content_id: content.id,
          start_range: 1,
          end_range: endRange,
          title: content.title,
          subject_category: content.subject_category || undefined,
          master_content_id: content.id,
          recommendation_reason: content.reason,
        });
      }
    }

    if (contentsToAdd.length > 0) {
      console.log("[useContentSelection] ì½˜í…ì¸  ì¶”ê°€:", {
        contentsToAdd: contentsToAdd.map((c) => ({
          content_id: c.content_id,
          content_type: c.content_type,
          title: c.title,
        })),
        currentRecommendedContents: data.recommended_contents.length,
        newRecommendedContents: data.recommended_contents.length + contentsToAdd.length,
      });

      onUpdate({
        recommended_contents: [
          ...data.recommended_contents,
          ...contentsToAdd,
        ],
      });

      console.log("[useContentSelection] onUpdate í˜¸ì¶œ ì™„ë£Œ");
      alert(SUCCESS_MESSAGES.CONTENTS_ADDED(contentsToAdd.length));
      setSelectedContentIds(new Set());
    } else {
      console.warn("[useContentSelection] ì¶”ê°€í•  ì½˜í…ì¸ ê°€ ì—†ìŒ");
    }
  }, [
    selectedContentIds,
    data.student_contents,
    data.recommended_contents,
    recommendedContents,
    onUpdate,
    fetchContentTotal,
  ]);

  /**
   * ì½˜í…ì¸  ì œê±° (ì¶”ì²œ ì½˜í…ì¸ ì™€ í•™ìƒ ì½˜í…ì¸  ëª¨ë‘ ì§€ì›)
   */
  const removeContent = useCallback(
    (index: number, type: "recommended" | "student" = "recommended") => {
      if (type === "recommended") {
        const newContents = [...data.recommended_contents];
        newContents.splice(index, 1);
        onUpdate({ recommended_contents: newContents });
      } else {
        const newContents = [...data.student_contents];
        newContents.splice(index, 1);
        onUpdate({ student_contents: newContents });
      }
    },
    [data.recommended_contents, data.student_contents, onUpdate]
  );

  return {
    selectedContentIds,
    toggleContentSelection,
    addSelectedContents,
    removeContent,
    setSelectedContentIds,
  };
}
</file>

<file path="new-group/_components/Step4RecommendedContents/hooks/useRangeEditor.ts">
/**
 * useRangeEditor Hook
 * ì½˜í…ì¸  ë²”ìœ„ í¸ì§‘ ìƒíƒœ ê´€ë¦¬
 */

import { useState, useRef, useEffect, useCallback } from "react";
import { WizardData } from "../../PlanGroupWizard";
import { BookDetail, LectureEpisode, UseRangeEditorReturn } from "../types";
import { toPlanGroupError, PlanGroupErrorCodes } from "@/lib/errors/planGroupErrors";

type ContentDetail =
  | { details: BookDetail[]; type: "book" }
  | { details: LectureEpisode[]; type: "lecture" };

type UseRangeEditorProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  studentId?: string; // ê´€ë¦¬ì ëª¨ë“œì—ì„œ í•„ìš”
};

export function useRangeEditor({
  data,
  onUpdate,
  studentId,
}: UseRangeEditorProps): UseRangeEditorReturn {
  const [editingRangeIndex, setEditingRangeIndex] = useState<number | null>(null);
  const [editingContentType, setEditingContentType] = useState<"recommended" | "student">("recommended");
  const [editingRange, setEditingRange] = useState<{
    start: string;
    end: string;
  } | null>(null);
  const [contentDetails, setContentDetails] = useState<Map<number, ContentDetail>>(
    new Map()
  );
  const [loadingDetails, setLoadingDetails] = useState<Set<number>>(new Set());
  const [startDetailId, setStartDetailId] = useState<Map<number, string>>(new Map());
  const [endDetailId, setEndDetailId] = useState<Map<number, string>>(new Map());
  const [contentTotals, setContentTotals] = useState<Map<number, number>>(new Map());
  
  const cachedDetailsRef = useRef<Map<string, ContentDetail>>(new Map());
  const cachedTotalsRef = useRef<Map<string, number>>(new Map());

  /**
   * ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ
   */
  const fetchContentTotal = useCallback(async (
    contentType: "book" | "lecture",
    contentId: string,
    studentId?: string,
    isStudentContent?: boolean
  ): Promise<number | null> => {
    // ìºì‹œ í™•ì¸ (í•™ìƒ ì½˜í…ì¸ ì˜ ê²½ìš° studentIdë¥¼ í¬í•¨í•œ í‚¤ ì‚¬ìš©)
    const cacheKey = isStudentContent && studentId 
      ? `${contentId}_${studentId}` 
      : contentId;
    
    if (cachedTotalsRef.current.has(cacheKey)) {
      return cachedTotalsRef.current.get(cacheKey) ?? null;
    }

    try {
      // í•™ìƒ ì½˜í…ì¸ ì˜ ê²½ìš° student-content-info API ì‚¬ìš©
      const apiEndpoint = isStudentContent && studentId
        ? `/api/student-content-info?content_type=${contentType}&content_id=${contentId}&student_id=${studentId}`
        : `/api/master-content-info?content_type=${contentType}&content_id=${contentId}`;
      
      const response = await fetch(apiEndpoint);
      if (response.ok) {
        const result = await response.json();
        if (result.success && result.data) {
          const total = contentType === "book" 
            ? result.data.total_pages 
            : result.data.total_episodes;
          
          if (total && total > 0) {
            cachedTotalsRef.current.set(cacheKey, total);
            return total;
          }
        }
      }
      return null;
    } catch (error) {
      console.error("[useRangeEditor] ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ ì‹¤íŒ¨:", {
        contentType,
        contentId,
        studentId,
        isStudentContent,
        error,
      });
      return null;
    }
  }, []);

  /**
   * ì½˜í…ì¸  ìƒì„¸ì •ë³´ ì¡°íšŒ (í¸ì§‘ ì‹œì‘ ì‹œ)
   */
  useEffect(() => {
    if (editingRangeIndex === null) {
      return;
    }

    const contents = editingContentType === "recommended" 
      ? data.recommended_contents 
      : data.student_contents;
    const content = contents[editingRangeIndex];
    if (!content) return;

    const fetchDetails = async () => {
      // ìºì‹œ í™•ì¸
      if (cachedDetailsRef.current.has(content.content_id)) {
        const cached = cachedDetailsRef.current.get(content.content_id)!;
        setContentDetails(new Map([[editingRangeIndex, cached]]));
        
        // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì •ë³´ë„ í™•ì¸
        const cachedTotal = cachedTotalsRef.current.get(content.content_id);
        if (cachedTotal) {
          setContentTotals(new Map([[editingRangeIndex, cachedTotal]]));
        }
        return;
      }

      setLoadingDetails(new Set([editingRangeIndex]));

      try {
        // ì½˜í…ì¸  íƒ€ì…ì— ë”°ë¼ ì˜¬ë°”ë¥¸ API ì—”ë“œí¬ì¸íŠ¸ ì„ íƒ
        const apiEndpoint = editingContentType === "recommended"
          ? `/api/master-content-details?contentType=${content.content_type}&contentId=${content.content_id}`
          : `/api/student-content-details?contentType=${content.content_type}&contentId=${content.content_id}${studentId ? `&student_id=${studentId}` : ""}`;

        // ìƒì„¸ì •ë³´ì™€ ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ë¥¼ ë™ì‹œì— ì¡°íšŒ
        const [detailsResponse, total] = await Promise.all([
          fetch(apiEndpoint),
          fetchContentTotal(content.content_type, content.content_id, studentId, editingContentType === "student"),
        ]);

        // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì •ë³´ ì €ì¥
        if (total) {
          setContentTotals(new Map([[editingRangeIndex, total]]));
        }

        if (detailsResponse.ok) {
          const result = await detailsResponse.json();
          const detailData: ContentDetail =
            content.content_type === "book"
              ? { details: result.details || [], type: "book" as const }
              : { details: result.episodes || [], type: "lecture" as const };

          // ìƒì„¸ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ë¡œê¹… (ê°œë°œ í™˜ê²½ì—ì„œë§Œ)
          if (detailData.details.length === 0) {
            if (process.env.NODE_ENV === "development") {
              console.debug("[useRangeEditor] ìƒì„¸ì •ë³´ ì—†ìŒ (ì •ìƒ):", {
                type: "NO_DETAILS",
                contentType: content.content_type,
                contentId: content.content_id,
                title: content.title,
                total: total || "ì—†ìŒ",
                reason: "í•´ë‹¹ ì½˜í…ì¸ ì— ëª©ì°¨/íšŒì°¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë²”ìœ„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
              });
            }

            // ìƒì„¸ì •ë³´ê°€ ì—†ì„ ë•Œ í˜„ì¬ ë²”ìœ„ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
            setEditingRange((prev) => {
              // ì´ë¯¸ í¸ì§‘ ì¤‘ì¸ ë²”ìœ„ê°€ ìˆìœ¼ë©´ ìœ ì§€
              if (prev) {
                return prev;
              }
              // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ê°€ ìˆìœ¼ë©´ ì „ì²´ ë²”ìœ„ë¡œ ì„¤ì •, ì—†ìœ¼ë©´ í˜„ì¬ ë²”ìœ„ ì‚¬ìš©
              if (total && total > 0) {
                return {
                  start: "1",
                  end: String(total),
                };
              } else {
                // í˜„ì¬ ë²”ìœ„ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
                return {
                  start: String(content.start_range || 1),
                  end: String(content.end_range || 100),
                };
              }
            });
          } else {
            console.log("[useRangeEditor] ìƒì„¸ì •ë³´ ì¡°íšŒ ì„±ê³µ:", {
              type: "SUCCESS",
              contentType: content.content_type,
              contentId: content.content_id,
              title: content.title,
              detailsCount: detailData.details.length,
            });

            // ìºì‹œ ì €ì¥
            cachedDetailsRef.current.set(content.content_id, detailData);
            setContentDetails(new Map([[editingRangeIndex, detailData]]));

            // í˜„ì¬ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” í•­ëª© ìë™ ì„ íƒ
            const currentRange = {
              start: content.start_range || 1,
              end: content.end_range || 1,
            };

            if (detailData.type === "book") {
              const details = detailData.details as BookDetail[];
              const startDetail = details.find(
                (d) => d.page_number === currentRange.start
              );
              const endDetail = details.find(
                (d) => d.page_number === currentRange.end
              );
              if (startDetail)
                setStartDetailId(new Map([[editingRangeIndex, startDetail.id]]));
              if (endDetail)
                setEndDetailId(new Map([[editingRangeIndex, endDetail.id]]));
            } else {
              const episodes = detailData.details as LectureEpisode[];
              const startEpisode = episodes.find(
                (e) => e.episode_number === currentRange.start
              );
              const endEpisode = episodes.find(
                (e) => e.episode_number === currentRange.end
              );
              if (startEpisode)
                setStartDetailId(new Map([[editingRangeIndex, startEpisode.id]]));
              if (endEpisode)
                setEndDetailId(new Map([[editingRangeIndex, endEpisode.id]]));
            }
          }

          // ìºì‹œ ì €ì¥ (ìƒì„¸ì •ë³´ê°€ ì—†ì–´ë„ ë¹ˆ ë°°ì—´ë¡œ ì €ì¥)
          cachedDetailsRef.current.set(content.content_id, detailData);
          setContentDetails(new Map([[editingRangeIndex, detailData]]));
        } else {
          // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì €ì¥í•˜ì—¬ ì§ì ‘ ì…ë ¥ UI í‘œì‹œ
          const emptyDetailData: ContentDetail =
            content.content_type === "book"
              ? { details: [], type: "book" as const }
              : { details: [], type: "lecture" as const };
          
          cachedDetailsRef.current.set(content.content_id, emptyDetailData);
          setContentDetails(new Map([[editingRangeIndex, emptyDetailData]]));
          
          // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ê°€ ìˆìœ¼ë©´ ë²”ìœ„ ìë™ ì„¤ì •
          if (total && total > 0) {
            setEditingRange({
              start: "1",
              end: String(total),
            });
          } else {
            // ì´ëŸ‰ë„ ì—†ìœ¼ë©´ í˜„ì¬ ë²”ìœ„ ìœ ì§€
            setEditingRange({
              start: String(content.start_range),
              end: String(content.end_range),
            });
          }
        }
      } catch (error) {
        const planGroupError = toPlanGroupError(
          error,
          PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED
        );
        console.error(
          "[useRangeEditor] ìƒì„¸ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (ì—ëŸ¬):",
          {
            type: "API_ERROR",
            error: planGroupError,
            contentType: content.content_type,
            contentId: content.content_id,
            title: content.title,
            reason: "API í˜¸ì¶œ ì‹¤íŒ¨ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬",
          }
        );
        
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì €ì¥í•˜ì—¬ ì§ì ‘ ì…ë ¥ UI í‘œì‹œ
        const emptyDetailData: ContentDetail =
          content.content_type === "book"
            ? { details: [], type: "book" as const }
            : { details: [], type: "lecture" as const };
        
        cachedDetailsRef.current.set(content.content_id, emptyDetailData);
        setContentDetails(new Map([[editingRangeIndex, emptyDetailData]]));
        
        // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ ì¡°íšŒ ì‹œë„
        try {
          const total = await fetchContentTotal(content.content_type, content.content_id, studentId, editingContentType === "student");
          if (total) {
            setContentTotals(new Map([[editingRangeIndex, total]]));
            setEditingRange({
              start: "1",
              end: String(total),
            });
          } else {
            // ì´ëŸ‰ë„ ì—†ìœ¼ë©´ í˜„ì¬ ë²”ìœ„ ìœ ì§€
            setEditingRange({
              start: String(content.start_range || 1),
              end: String(content.end_range || 100),
            });
          }
        } catch (totalError) {
          // ì´ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ í˜„ì¬ ë²”ìœ„ ìœ ì§€
          setEditingRange({
            start: String(content.start_range || 1),
            end: String(content.end_range || 100),
          });
        }
      } finally {
        setLoadingDetails((prev) => {
          const newSet = new Set(prev);
          newSet.delete(editingRangeIndex);
          return newSet;
        });
      }
    };

    fetchDetails();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [editingRangeIndex, fetchContentTotal]);

  /**
   * ì‹œì‘/ë ë²”ìœ„ ì„ íƒ ì‹œ ë²”ìœ„ ìë™ ê³„ì‚°
   */
  useEffect(() => {
    if (editingRangeIndex === null) return;

    const contents = editingContentType === "recommended" 
      ? data.recommended_contents 
      : data.student_contents;
    const content = contents[editingRangeIndex];
    if (!content) return;

    const contentInfo = contentDetails.get(editingRangeIndex);
    const startId = startDetailId.get(editingRangeIndex);
    const endId = endDetailId.get(editingRangeIndex);

    if (!contentInfo || !startId || !endId) return;

    let newStart: number | null = null;
    let newEnd: number | null = null;

    if (contentInfo.type === "book") {
      const details = contentInfo.details as BookDetail[];
      const startDetail = details.find((d) => d.id === startId);
      const endDetail = details.find((d) => d.id === endId);
      if (startDetail && endDetail) {
        newStart = startDetail.page_number;

        // ë ë²”ìœ„: ë í•­ëª©ì˜ ë‹¤ìŒ í•­ëª©ì˜ í˜ì´ì§€ - 1
        const endIndex = details.findIndex((d) => d.id === endId);
        if (endIndex !== -1 && endIndex < details.length - 1) {
          newEnd = details[endIndex + 1].page_number - 1;
        } else {
          // ë í•­ëª©ì´ ë§ˆì§€ë§‰ í•­ëª©ì´ë©´ ì´ í˜ì´ì§€ê¹Œì§€
          const totalPages = Math.max(
            content.end_range || 0,
            details.length > 0 ? details[details.length - 1].page_number : 0
          );
          newEnd = totalPages;
        }

        if (newStart > newEnd) [newStart, newEnd] = [newEnd, newStart];
      }
    } else {
      // ê°•ì˜ëŠ” ë í•­ëª©ì˜ íšŒì°¨ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      const episodes = contentInfo.details as LectureEpisode[];
      const startEpisode = episodes.find((e) => e.id === startId);
      const endEpisode = episodes.find((e) => e.id === endId);
      if (startEpisode && endEpisode) {
        newStart = startEpisode.episode_number;
        newEnd = endEpisode.episode_number;
        if (newStart > newEnd) [newStart, newEnd] = [newEnd, newStart];
      }
    }

    if (newStart !== null && newEnd !== null) {
      setEditingRange({
        start: String(newStart),
        end: String(newEnd),
      });
    }
  }, [
    startDetailId,
    endDetailId,
    contentDetails,
    editingRangeIndex,
    editingContentType,
    data.recommended_contents,
    data.student_contents,
    studentId,
  ]);

  /**
   * ë²”ìœ„ í¸ì§‘ ì‹œì‘
   */
  const startEditingRange = useCallback((index: number, type: "recommended" | "student" = "recommended") => {
    const contents = type === "recommended" 
      ? data.recommended_contents 
      : data.student_contents;
    const content = contents[index];
    if (!content) return;
    
    setEditingContentType(type);
    setEditingRangeIndex(index);
    setEditingRange({
      start: String(content.start_range || 1),
      end: String(content.end_range || 1),
    });
  }, [data.recommended_contents, data.student_contents]);

  /**
   * ë²”ìœ„ í¸ì§‘ ì·¨ì†Œ
   */
  const cancelEditingRange = useCallback(() => {
    setEditingRangeIndex(null);
    setEditingContentType("recommended");
    setEditingRange(null);
  }, []);

  /**
   * ë²”ìœ„ ì €ì¥
   */
  const saveEditingRange = useCallback(() => {
    if (editingRangeIndex === null || !editingRange) return;

    const startNum = Number(editingRange.start);
    const endNum = Number(editingRange.end);

    // ìœ íš¨ì„± ê²€ì‚¬
    if (isNaN(startNum) || isNaN(endNum) || startNum <= 0 || endNum <= 0) {
      alert("ìœ íš¨í•œ ìˆ«ì ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    if (startNum > endNum) {
      alert("ì‹œì‘ ë²”ìœ„ëŠ” ì¢…ë£Œ ë²”ìœ„ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì´ í˜ì´ì§€ìˆ˜/íšŒì°¨ í™•ì¸
    const contents = editingContentType === "recommended" 
      ? data.recommended_contents 
      : data.student_contents;
    const content = contents[editingRangeIndex];
    if (!content) return;
    
    const total = contentTotals.get(editingRangeIndex);
    if (total && (startNum > total || endNum > total)) {
      alert(
        `ë²”ìœ„ëŠ” ìµœëŒ€ ${total}${content.content_type === "book" ? "í˜ì´ì§€" : "íšŒì°¨"}ê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
      );
      return;
    }

    if (editingContentType === "recommended") {
      const newContents = [...data.recommended_contents];
      newContents[editingRangeIndex] = {
        ...newContents[editingRangeIndex],
        start_range: startNum,
        end_range: endNum,
      };
      onUpdate({ recommended_contents: newContents });
    } else {
      const newContents = [...data.student_contents];
      newContents[editingRangeIndex] = {
        ...newContents[editingRangeIndex],
        start_range: startNum,
        end_range: endNum,
      };
      onUpdate({ student_contents: newContents });
    }
    setEditingRangeIndex(null);
    setEditingContentType("recommended");
    setEditingRange(null);
  }, [editingRangeIndex, editingContentType, editingRange, data.recommended_contents, data.student_contents, contentTotals, onUpdate]);

  /**
   * ì‹œì‘ ë²”ìœ„ ì„¤ì •
   */
  const setStartRange = useCallback((index: number, detailId: string) => {
    const newMap = new Map(startDetailId);
    newMap.set(index, detailId);
    setStartDetailId(newMap);
  }, [startDetailId]);

  /**
   * ë ë²”ìœ„ ì„¤ì •
   */
  const setEndRange = useCallback((index: number, detailId: string) => {
    const newMap = new Map(endDetailId);
    newMap.set(index, detailId);
    setEndDetailId(newMap);
  }, [endDetailId]);

  return {
    editingRangeIndex,
    editingRange,
    contentDetails,
    loadingDetails,
    startDetailId,
    endDetailId,
    contentTotals,
    startEditingRange,
    cancelEditingRange,
    saveEditingRange,
    setStartRange,
    setEndRange,
    setEditingRange,
  };
}
</file>

<file path="new-group/_components/Step4RecommendedContents/hooks/useRecommendations.ts">
/**
 * useRecommendations Hook
 * ì¶”ì²œ ì½˜í…ì¸  ì¡°íšŒ ë° ê´€ë¦¬
 */

import { useState, useCallback, useRef, useEffect, useMemo } from "react";
import { WizardData } from "../../PlanGroupWizard";
import {
  PlanGroupError,
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";
import { RecommendedContent, UseRecommendationsReturn } from "../types";
import { ERROR_MESSAGES, SUCCESS_MESSAGES } from "../constants";

type UseRecommendationsProps = {
  data: WizardData;
  isEditMode: boolean;
  studentId?: string;
  onUpdate: (
    updates: Partial<WizardData> | ((prev: WizardData) => Partial<WizardData>)
  ) => void;
};

export function useRecommendations({
  data,
  isEditMode,
  studentId,
  onUpdate,
}: UseRecommendationsProps): UseRecommendationsReturn {
  const [recommendedContents, setRecommendedContents] = useState<
    RecommendedContent[]
  >([]);
  const [allRecommendedContents, setAllRecommendedContents] = useState<
    RecommendedContent[]
  >([]);
  const [loading, setLoading] = useState(!isEditMode);
  const [hasRequestedRecommendations, setHasRequestedRecommendations] =
    useState(!isEditMode);
  const [hasScoreData, setHasScoreData] = useState(false);
  
  // í¸ì§‘ ëª¨ë“œì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œ ì¶”ì²œ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ hasRequestedRecommendationsë¥¼ trueë¡œ ì„¤ì •
  // í•˜ì§€ë§Œ recommendedContentsëŠ” ë¹ˆ ë°°ì—´ë¡œ ìœ ì§€ (ì¶”ì²œ ëª©ë¡ì„ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•¨)
  const hasInitializedRef = useRef(false);
  
  useEffect(() => {
    if (isEditMode && !hasInitializedRef.current) {
      // í¸ì§‘ ëª¨ë“œì—ì„œ ì´ˆê¸° ë¡œë“œ ì‹œ ì¶”ì²œ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ì¶”ì²œì„ ë°›ì€ ê²ƒìœ¼ë¡œ ê°„ì£¼
      if (data.recommended_contents.length > 0) {
        setHasRequestedRecommendations(true);
        // ì¶”ì²œ ì½˜í…ì¸ ê°€ ìˆì§€ë§Œ recommendedContentsëŠ” ë¹ˆ ë°°ì—´ì´ë¯€ë¡œ
        // ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì¶”ì²œì„ ìš”ì²­í•˜ê±°ë‚˜ ì¶”ê°€ ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•¨
      }
      hasInitializedRef.current = true;
    }
  }, [isEditMode, data.recommended_contents.length]);

  // data.recommended_contentsê°€ ì—…ë°ì´íŠ¸ë˜ë©´ recommendedContentsì™€ allRecommendedContentsì—ì„œ ì œê±°
  // ì˜ì¡´ì„±ì„ content_id ë°°ì—´ë¡œ ë³€ê²½í•˜ì—¬ ì •í™•í•œ ë³€ê²½ ê°ì§€
  const recommendedContentIds = useMemo(
    () => data.recommended_contents.map((c) => c.content_id).sort().join(","),
    [data.recommended_contents]
  );

  useEffect(() => {
    if (data.recommended_contents.length > 0) {
      const addedContentIds = new Set(
        data.recommended_contents.map((c) => c.content_id)
      );
      
      console.log("[useRecommendations] useEffect: ì¶”ê°€ëœ ì½˜í…ì¸  ê°ì§€:", {
        addedContentIds: Array.from(addedContentIds),
        currentRecommendedContentsCount: data.recommended_contents.length,
      });
      
      // recommendedContentsì—ì„œ ì œê±°
      setRecommendedContents((prev) => {
        const filtered = prev.filter((c) => !addedContentIds.has(c.id));
        
        if (filtered.length !== prev.length) {
          console.log("[useRecommendations] useEffect: ì¶”ê°€ëœ ì½˜í…ì¸ ë¥¼ ì¶”ì²œ ëª©ë¡ì—ì„œ ì œê±°:", {
            before: prev.length,
            after: filtered.length,
            removed: prev.length - filtered.length,
            removedIds: prev
              .filter((c) => addedContentIds.has(c.id))
              .map((c) => ({ id: c.id, title: c.title })),
          });
        }
        
        return filtered;
      });
      
      // allRecommendedContentsì—ì„œë„ ì œê±°
      setAllRecommendedContents((prev) => {
        const filtered = prev.filter((c) => !addedContentIds.has(c.id));
        
        if (filtered.length !== prev.length) {
          console.log("[useRecommendations] useEffect: ì¶”ê°€ëœ ì½˜í…ì¸ ë¥¼ ì „ì²´ ì¶”ì²œ ëª©ë¡ì—ì„œ ì œê±°:", {
            before: prev.length,
            after: filtered.length,
            removed: prev.length - filtered.length,
            removedIds: prev
              .filter((c) => addedContentIds.has(c.id))
              .map((c) => ({ id: c.id, title: c.title })),
          });
        }
        
        return filtered;
      });
    } else {
      // recommended_contentsê°€ ë¹„ì–´ìˆìœ¼ë©´ í•„í„°ë§í•˜ì§€ ì•ŠìŒ (ì´ˆê¸° ìƒíƒœ)
      // í•˜ì§€ë§Œ ì´ë¯¸ ì¶”ê°€ëœ ì½˜í…ì¸ ëŠ” ì œê±°ëœ ìƒíƒœë¥¼ ìœ ì§€
    }
  }, [recommendedContentIds]);

  /**
   * í•™ìƒ ì½˜í…ì¸ ì˜ master_content_id ìˆ˜ì§‘
   */
  const collectStudentMasterIds = useCallback(async () => {
    const studentMasterIds = new Set<string>();
    
    // WizardDataì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
    data.student_contents.forEach((c) => {
      const masterContentId = (c as any).master_content_id;
      if (masterContentId) {
        studentMasterIds.add(masterContentId);
      }
    });

    // master_content_idê°€ ì—†ëŠ” ì½˜í…ì¸ ëŠ” DBì—ì„œ ì¡°íšŒ
    const studentContentsWithoutMasterId = data.student_contents.filter(
      (c) =>
        (c.content_type === "book" || c.content_type === "lecture") &&
        !(c as any).master_content_id
    ) as Array<{ content_id: string; content_type: "book" | "lecture" }>;

    if (studentContentsWithoutMasterId.length > 0) {
      try {
        const { getStudentContentMasterIdsAction } = await import(
          "@/app/(student)/actions/getStudentContentMasterIds"
        );
        // studentIdê°€ ìˆìœ¼ë©´ ì „ë‹¬ (í…œí”Œë¦¿ ëª¨ë“œì—ì„œëŠ” studentIdê°€ ì—†ì„ ìˆ˜ ìˆìŒ)
        const masterIdResult = await getStudentContentMasterIdsAction(
          studentContentsWithoutMasterId,
          studentId
        );
        if (masterIdResult.success && masterIdResult.data) {
          masterIdResult.data.forEach((masterId, contentId) => {
            if (masterId) {
              studentMasterIds.add(masterId);
            }
          });
        }
      } catch (error) {
        console.warn(
          "[useRecommendations] master_content_id ì¡°íšŒ ì‹¤íŒ¨:",
          error
        );
        // í…œí”Œë¦¿ ëª¨ë“œì—ì„œëŠ” studentIdê°€ ì—†ì–´ì„œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ë¥¼ ë¬´ì‹œ
      }
    }

    return studentMasterIds;
  }, [data.student_contents]);

  /**
   * ì¤‘ë³µ ì½˜í…ì¸  í•„í„°ë§
   */
  const filterDuplicateContents = useCallback(
    (recommendations: RecommendedContent[], studentMasterIds: Set<string>) => {
      const existingIds = new Set([
        ...data.student_contents.map((c) => c.content_id),
        ...data.recommended_contents.map((c) => c.content_id),
      ]);

      return recommendations.filter((r: RecommendedContent) => {
        // content_idë¡œ ì§ì ‘ ë¹„êµ
        if (existingIds.has(r.id)) {
          return false;
        }
        // master_content_idë¡œ ë¹„êµ
        if (studentMasterIds.has(r.id)) {
          return false;
        }
        // data.recommended_contentsì— ì´ë¯¸ ìˆëŠ” ì½˜í…ì¸  ì œì™¸
        if (data.recommended_contents.some((rc) => rc.content_id === r.id)) {
          return false;
        }
        return true;
      });
    },
    [data.student_contents, data.recommended_contents]
  );

  /**
   * ìë™ ë°°ì •: ì¶”ì²œ ë°›ì€ ì½˜í…ì¸ ë¥¼ ë°”ë¡œ ë“±ë¡
   * 
   * ì˜ë„:
   * - ì‚¬ìš©ìê°€ "ìë™ ë°°ì •" ì˜µì…˜ì„ ì²´í¬í–ˆì„ ë•Œ, ì¶”ì²œ ë°›ì€ ì½˜í…ì¸ ë¥¼ ìˆ˜ë™ ì„ íƒ ì—†ì´ ë°”ë¡œ ë“±ë¡
   * - ì´ëŠ” "ì¶”ì²œ ë°›ì€ ì½˜í…ì¸ ë¥¼ ë°”ë¡œ ë“±ë¡"í•˜ëŠ” ê²ƒì´ì§€, "ì¶”ê°€ë¡œ ë” ë°›ëŠ” ê²ƒ"ì´ ì•„ë‹˜
   * - ì œì¶œ ì‹œì ì— ì¶”ê°€ë¡œ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŒ (submitCampParticipationì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ)
   * 
   * ë™ì‘:
   * 1. ì¶”ì²œ ë°›ì€ ì½˜í…ì¸ ì˜ ìƒì„¸ ì •ë³´ ì¡°íšŒ (í˜ì´ì§€/íšŒì°¨ ë²”ìœ„)
   * 2. ì „ì²´ ë²”ìœ„ë¡œ ì„¤ì •í•˜ì—¬ recommended_contentsì— ì¶”ê°€
   * 3. is_auto_recommended: true, recommendation_source: "auto" í”Œë˜ê·¸ ì„¤ì •
   * 
   * ì°¸ê³ :
   * - Step 4ì˜ ì¶”ì²œ ê¸°ëŠ¥(/api/recommended-master-contents)ì€ ì •ìƒ ë™ì‘í•˜ë©°, ì´ í•¨ìˆ˜ì™€ëŠ” ë…ë¦½ì ì„
   * - ì œì¶œ ì‹œì ì˜ ìë™ ì¶”ì²œ ë¡œì§(campActions.ts)ê³¼ëŠ” ë³„ê°œë¡œ ë™ì‘í•¨
   */
  const autoAssignContents = useCallback(
    async (recommendations: RecommendedContent[]) => {
      const contentsToAutoAdd: Array<{
        content_type: "book" | "lecture";
        content_id: string;
        start_range: number;
        end_range: number;
        title?: string;
        subject_category?: string;
        is_auto_recommended?: boolean;
        recommendation_source?: "auto" | "admin" | "template" | null;
      }> = [];

      for (const r of recommendations) {
        try {
          let startRange = 1;
          let endRange = 100;

          // ìƒì„¸ ì •ë³´ ì¡°íšŒ
          let detailsResult: any = null;
          let hasDetails = false;
          
          const detailsResponse = await fetch(
            `/api/master-content-details?contentType=${r.contentType}&contentId=${r.id}`
          );

          if (detailsResponse.ok) {
            detailsResult = await detailsResponse.json();

            // API ì‘ë‹µ í˜•ì‹: { success: true, data: { details/episodes: [...] } }
            if (detailsResult.success && detailsResult.data) {
              if (r.contentType === "book") {
                const details = detailsResult.data.details || [];
                hasDetails = details.length > 0;
                if (hasDetails) {
                  startRange = details[0].page_number || 1;
                  endRange = details[details.length - 1].page_number || 100;
                }
              } else if (r.contentType === "lecture") {
                const episodes = detailsResult.data.episodes || [];
                hasDetails = episodes.length > 0;
                if (hasDetails) {
                  startRange = episodes[0].episode_number || 1;
                  endRange = episodes[episodes.length - 1].episode_number || 100;
                }
              }
            } else {
              // ë ˆê±°ì‹œ ì‘ë‹µ í˜•ì‹ ì§€ì› (í•˜ìœ„ í˜¸í™˜ì„±)
              if (r.contentType === "book") {
                const details = detailsResult.details || detailsResult.data?.details || [];
                hasDetails = details.length > 0;
                if (hasDetails) {
                  startRange = details[0].page_number || 1;
                  endRange = details[details.length - 1].page_number || 100;
                }
              } else if (r.contentType === "lecture") {
                const episodes = detailsResult.episodes || detailsResult.data?.episodes || [];
                hasDetails = episodes.length > 0;
                if (hasDetails) {
                  startRange = episodes[0].episode_number || 1;
                  endRange = episodes[episodes.length - 1].episode_number || 100;
                }
              }
            }
          }

          // ìƒì„¸ ì •ë³´ê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ê°’ì¼ ë•Œ ì´ëŸ‰ ì¡°íšŒ (ì „ì²´ ë²”ìœ„ ì„¤ì •)
          if (!hasDetails || (startRange === 1 && endRange === 100)) {
            try {
              const infoResponse = await fetch(
                `/api/master-content-info?content_type=${r.contentType}&content_id=${r.id}`
              );

              if (infoResponse.ok) {
                const infoResult = await infoResponse.json();
                if (infoResult.success && infoResult.data) {
                  if (r.contentType === "book" && infoResult.data.total_pages) {
                    endRange = infoResult.data.total_pages;
                    console.log(`[useRecommendations] ìë™ ë°°ì •: ${r.title} ì´ í˜ì´ì§€ìˆ˜ ${endRange}ë¡œ ì„¤ì •`);
                  } else if (r.contentType === "lecture" && infoResult.data.total_episodes) {
                    endRange = infoResult.data.total_episodes;
                    console.log(`[useRecommendations] ìë™ ë°°ì •: ${r.title} ì´ íšŒì°¨ ${endRange}ë¡œ ì„¤ì •`);
                  }
                }
              }
            } catch (infoError) {
              // ì´ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ê¸°ë³¸ê°’ 100 ì‚¬ìš©)
              if (process.env.NODE_ENV === "development") {
                console.debug(
                  `[useRecommendations] ì½˜í…ì¸  ${r.id} ì´ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨ (ê¸°ë³¸ê°’ ì‚¬ìš©):`,
                  infoError
                );
              }
            }
          }

          contentsToAutoAdd.push({
            content_type: r.contentType as "book" | "lecture",
            content_id: r.id,
            start_range: startRange,
            end_range: endRange,
            title: r.title,
            subject_category: r.subject_category || undefined,
            is_auto_recommended: true, // ìë™ ë°°ì • í”Œë˜ê·¸
            recommendation_source: "auto", // ìë™ ë°°ì • ì†ŒìŠ¤
          });
        } catch (error) {
          console.warn(
            `[useRecommendations] ì½˜í…ì¸  ${r.id} ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:`,
            error
          );
          // ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
          contentsToAutoAdd.push({
            content_type: r.contentType as "book" | "lecture",
            content_id: r.id,
            start_range: 1,
            end_range: 100,
            title: r.title,
            subject_category: r.subject_category || undefined,
            is_auto_recommended: true, // ìë™ ë°°ì • í”Œë˜ê·¸
            recommendation_source: "auto", // ìë™ ë°°ì • ì†ŒìŠ¤
          });
        }
      }

      // í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœì‹  ìƒíƒœ ë³´ì¥
      console.log("[useRecommendations] ìë™ ë°°ì • ì‹œì‘ - í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ í˜¸ì¶œ");
      
      try {
        onUpdate((prev) => {
          const currentTotal =
            prev.student_contents.length + prev.recommended_contents.length;
          const toAdd = contentsToAutoAdd.length;

          console.log("[useRecommendations] ìë™ ë°°ì • ì‹¤í–‰ (í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ ë‚´ë¶€):", {
            currentTotal,
            toAdd,
            currentRecommendedContents: prev.recommended_contents.length,
            currentStudentContents: prev.student_contents.length,
            contentsToAutoAdd: contentsToAutoAdd.map((c) => ({
              content_id: c.content_id,
              content_type: c.content_type,
              start_range: c.start_range,
              end_range: c.end_range,
              title: c.title,
            })),
          });

          if (currentTotal + toAdd > 9) {
            const maxToAdd = 9 - currentTotal;
            const trimmed = contentsToAutoAdd.slice(0, maxToAdd);

            if (trimmed.length > 0) {
              const newRecommendedContents = [
                ...prev.recommended_contents,
                ...trimmed,
              ];
              console.log("[useRecommendations] ìë™ ë°°ì • (ì œí•œ ì ìš©):", {
                trimmed: trimmed.length,
                excluded: toAdd - trimmed.length,
                newRecommendedContents: newRecommendedContents.length,
                currentRecommendedContents: prev.recommended_contents.length,
                newContents: newRecommendedContents.map((c) => ({
                  content_id: c.content_id,
                  title: c.title,
                  content_type: c.content_type,
                })),
              });

              // ë¹„ë™ê¸°ë¡œ ì•Œë¦¼ í‘œì‹œ (ìƒíƒœ ì—…ë°ì´íŠ¸ í›„)
              setTimeout(() => {
                alert(
                  SUCCESS_MESSAGES.RECOMMENDATIONS_ADDED(trimmed.length) +
                    ` (ìµœëŒ€ 9ê°œ ì œí•œìœ¼ë¡œ ${toAdd - trimmed.length}ê°œ ì œì™¸ë¨)`
                );
              }, 0);

              return {
                recommended_contents: newRecommendedContents,
              };
            } else {
              console.warn(
                "[useRecommendations] ìë™ ë°°ì • ì‹¤íŒ¨: ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ì½˜í…ì¸ ê°€ ì—†ìŒ (ìµœëŒ€ 9ê°œ ì œí•œ)"
              );
              setTimeout(() => {
                alert("ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ 9ê°œ ì œí•œ)");
              }, 0);
              return {};
            }
          } else {
            const newRecommendedContents = [
              ...prev.recommended_contents,
              ...contentsToAutoAdd,
            ];
            console.log("[useRecommendations] ìë™ ë°°ì • ì„±ê³µ:", {
              added: contentsToAutoAdd.length,
              currentRecommendedContents: prev.recommended_contents.length,
              newRecommendedContents: newRecommendedContents.length,
              contents: newRecommendedContents.map((c) => ({
                content_id: c.content_id,
                title: c.title,
                content_type: c.content_type,
                start_range: c.start_range,
                end_range: c.end_range,
              })),
            });

            // ë¹„ë™ê¸°ë¡œ ì•Œë¦¼ í‘œì‹œ (ìƒíƒœ ì—…ë°ì´íŠ¸ í›„)
            setTimeout(() => {
              alert(SUCCESS_MESSAGES.RECOMMENDATIONS_ADDED(contentsToAutoAdd.length));
            }, 0);

            return {
              recommended_contents: newRecommendedContents,
            };
          }
        });

        console.log("[useRecommendations] onUpdate í˜¸ì¶œ ì™„ë£Œ");
      } catch (error) {
        console.error("[useRecommendations] ìë™ ë°°ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ìë™ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    },
    [onUpdate]
  );

  /**
   * êµê³¼ë³„ ì¶”ì²œ ëª©ë¡ ì¡°íšŒ
   */
  const fetchRecommendationsWithSubjects = useCallback(
    async (
      subjects: string[],
      counts: Map<string, number>,
      autoAssign: boolean = false
    ) => {
      console.log("[useRecommendations] fetchRecommendationsWithSubjects í˜¸ì¶œ:", {
        subjects,
        counts: Object.fromEntries(counts),
        autoAssign,
        studentId,
      });

      // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ studentIdê°€ ì—†ìœ¼ë©´ ì¶”ì²œ ì½˜í…ì¸  ì¡°íšŒ ë¶ˆê°€
      if (!studentId) {
        console.warn("[useRecommendations] studentIdê°€ ì—†ì–´ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í…œí”Œë¦¿ ëª¨ë“œ)");
        alert("í…œí”Œë¦¿ ëª¨ë“œì—ì„œëŠ” ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        setLoading(false);
        return;
      }

      setLoading(true);
      try {
        // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° êµ¬ì„±
        const params = new URLSearchParams();
        subjects.forEach((subject) => {
          const count = counts.get(subject) || 1;
          params.append("subjects", subject);
          params.append(`count_${subject}`, String(count));
        });

        // studentIdëŠ” í•„ìˆ˜ (í…œí”Œë¦¿ ëª¨ë“œì—ì„œëŠ” ìœ„ì—ì„œ ì²´í¬)
        params.append("student_id", studentId);

        // API í˜¸ì¶œ
        console.log("[useRecommendations] API í˜¸ì¶œ ì‹œì‘:", {
          url: `/api/recommended-master-contents?${params.toString()}`,
          params: params.toString(),
        });

        const response = await fetch(
          `/api/recommended-master-contents?${params.toString()}`
        );

        console.log("[useRecommendations] API ì‘ë‹µ ë°›ìŒ:", {
          ok: response.ok,
          status: response.status,
          statusText: response.statusText,
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error("[useRecommendations] API ì‘ë‹µ ì‹¤íŒ¨:", {
            status: response.status,
            statusText: response.statusText,
            error: errorText,
          });
          alert(
            `ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${response.status} ${response.statusText})`
          );
          setLoading(false);
          return;
        }

        const result = await response.json();

        // API ì‘ë‹µ ì „ì²´ ë¡œê¹…
        console.log("[useRecommendations] API ì‘ë‹µ:", {
          success: result.success,
          hasData: !!result.data,
          hasRecommendations: !!result.data?.recommendations,
          recommendationsCount: result.data?.recommendations?.length || 0,
          rawResponse: result,
        });

        if (!result.success) {
          console.error("[useRecommendations] API ì—ëŸ¬:", result.error);
          alert(
            result.error?.message || "ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
          setLoading(false);
          return;
        }

        const rawRecommendations = result.data?.recommendations || [];
        
        console.log("[useRecommendations] ì¶”ì²œ ì½˜í…ì¸  ìˆ˜:", {
          count: rawRecommendations.length,
          autoAssign,
        });

        // ê° ì¶”ì²œ ì½˜í…ì¸ ì˜ contentType í•„ë“œ í™•ì¸
        console.log("[useRecommendations] ì¶”ì²œ ì½˜í…ì¸  ìƒì„¸ (ë³€í™˜ ì „):", {
          count: rawRecommendations.length,
          items: rawRecommendations.map((r: any) => ({
            id: r.id,
            title: r.title,
            contentType: r.contentType,
            content_type: r.content_type,
            hasContentType: !!r.contentType,
            hasContent_type: !!r.content_type,
            allKeys: Object.keys(r),
          })),
        });

        // API ì‘ë‹µì„ RecommendedContentë¡œ ë³€í™˜ (ì„œë²„ì—ì„œ contentType ë³´ì¥)
        const recommendations: RecommendedContent[] = rawRecommendations.map((r: any) => {
          // contentType ê²€ì¦ (ì„œë²„ì—ì„œ ë³´ì¥ë˜ì§€ë§Œ ë°©ì–´ ì½”ë“œ)
          if (!r.contentType) {
            console.error("[useRecommendations] contentTypeì´ ì—†ëŠ” ì¶”ì²œ ì½˜í…ì¸ :", {
              id: r.id,
              title: r.title,
              allKeys: Object.keys(r),
              rawData: r,
            });
            // ì„œë²„ì—ì„œ ë³´ì¥ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ì—ëŸ¬ ë¡œê¹…ë§Œ ìˆ˜í–‰
          }

          // íƒ€ì… ê²€ì¦
          if (r.contentType && r.contentType !== "book" && r.contentType !== "lecture") {
            console.error("[useRecommendations] ì˜ëª»ëœ contentType:", {
              id: r.id,
              title: r.title,
              contentType: r.contentType,
              rawData: r,
            });
          }

          return {
            id: r.id,
            contentType: (r.contentType || "book") as "book" | "lecture", // ì„œë²„ì—ì„œ ë³´ì¥ë˜ì§€ë§Œ fallback
            title: r.title,
            subject_category: r.subject_category,
            subject: r.subject,
            semester: r.semester,
            revision: r.revision,
            publisher: r.publisher,
            platform: r.platform,
            difficulty_level: r.difficulty_level,
            reason: r.reason,
            priority: r.priority,
            scoreDetails: r.scoreDetails,
          };
        });

        // ë³€í™˜ í›„ í™•ì¸
        console.log("[useRecommendations] ì¶”ì²œ ì½˜í…ì¸  ìƒì„¸ (ë³€í™˜ í›„):", {
          count: recommendations.length,
          items: recommendations.map((r) => ({
            id: r.id,
            title: r.title,
            contentType: r.contentType,
            hasContentType: !!r.contentType,
          })),
        });

        // ì¶”ì²œ ì½˜í…ì¸ ê°€ ì—†ëŠ” ê²½ìš°
        if (recommendations.length === 0) {
          console.warn("[useRecommendations] ì¶”ì²œ ì½˜í…ì¸ ê°€ ì—†ìŒ:", {
            autoAssign,
            subjects,
            counts: Object.fromEntries(counts),
          });
          alert(
            "ì¶”ì²œ ì½˜í…ì¸ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ë¥¸ êµê³¼ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê°œìˆ˜ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”."
          );
          setLoading(false);
          return;
        }

        // êµê³¼ë³„ ë¶„ë¥˜ ë° ë¶€ì¡±í•œ êµê³¼ í™•ì¸
        const recommendedBySubject = new Map<string, RecommendedContent[]>();
        recommendations.forEach((r: RecommendedContent) => {
          if (r.subject_category && subjects.includes(r.subject_category)) {
            if (!recommendedBySubject.has(r.subject_category)) {
              recommendedBySubject.set(r.subject_category, []);
            }
            recommendedBySubject.get(r.subject_category)!.push(r);
          }
        });

        const insufficientSubjects: string[] = [];
        subjects.forEach((subject) => {
          const requestedCount = counts.get(subject) || 1;
          const actualCount = recommendedBySubject.get(subject)?.length || 0;
          if (actualCount < requestedCount) {
            insufficientSubjects.push(
              `${subject} (ìš”ì²­: ${requestedCount}ê°œ, ì‹¤ì œ: ${actualCount}ê°œ)`
            );
          }
        });

        if (insufficientSubjects.length > 0) {
          const confirmMessage = `ë‹¤ìŒ êµê³¼ì˜ ì¶”ì²œ ì½˜í…ì¸ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤:\n${insufficientSubjects.join(
            "\n"
          )}\n\në¶€ì¡±í•œ êµê³¼ë¥¼ ì œì™¸í•˜ê³  ì¶”ì²œ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`;
          const shouldContinue = window.confirm(confirmMessage);
          if (!shouldContinue) {
            setLoading(false);
            return;
          }
        }

        // ì„±ì  ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        const hasDetailedReasons = recommendations.some(
          (r: RecommendedContent) =>
            r.reason?.includes("ë‚´ì‹ ") ||
            r.reason?.includes("ëª¨ì˜ê³ ì‚¬") ||
            r.reason?.includes("ìœ„í—˜ë„") ||
            r.scoreDetails
        );
        setHasScoreData(hasDetailedReasons);

        // master_content_id ìˆ˜ì§‘
        const studentMasterIds = await collectStudentMasterIds();

        // allRecommendedContents ì—…ë°ì´íŠ¸ (ë³‘í•©)
        const recommendationsMap = new Map<string, RecommendedContent>();
        recommendations.forEach((c: RecommendedContent) => {
          recommendationsMap.set(c.id, c);
        });

        setAllRecommendedContents((prev) => {
          const merged = new Map<string, RecommendedContent>();
          prev.forEach((c) => merged.set(c.id, c));
          recommendationsMap.forEach((c, id) => {
            merged.set(id, c);
          });
          return Array.from(merged.values());
        });

        // ì¤‘ë³µ ì œê±°
        const filteredRecommendations = filterDuplicateContents(
          recommendations,
          studentMasterIds
        );

        setHasRequestedRecommendations(true);

        // ìë™ ë°°ì • ì¡°ê±´ ëª…í™•í™”
        const shouldAutoAssign =
          autoAssign && filteredRecommendations.length > 0;

        console.log("[useRecommendations] ìë™ ë°°ì • ì¡°ê±´ í™•ì¸:", {
          autoAssign,
          filteredRecommendationsCount: filteredRecommendations.length,
          shouldAutoAssign,
        });

        if (shouldAutoAssign) {
          console.log("[useRecommendations] ìë™ ë°°ì • ì‹œì‘:", {
            recommendationsCount: filteredRecommendations.length,
            recommendations: filteredRecommendations.map((r) => ({
              id: r.id,
              title: r.title,
              contentType: r.contentType,
            })),
          });
          
          // ìë™ ë°°ì • ì‹¤í–‰
          await autoAssignContents(filteredRecommendations);
          
          // ìë™ ë°°ì •ëœ ì½˜í…ì¸  ID ìˆ˜ì§‘
          const autoAssignedIds = new Set(
            filteredRecommendations.map((r) => r.id)
          );
          
          // ìë™ ë°°ì • í›„ ì¶”ì²œ ëª©ë¡ì—ì„œ ì¦‰ì‹œ ì œê±°
          // useEffectê°€ data.recommended_contents ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ì œê±°í•˜ì§€ë§Œ,
          // ì¦‰ì‹œ ë°˜ì˜ì„ ìœ„í•´ ì—¬ê¸°ì„œë„ ì œê±°
          setRecommendedContents((prev) => {
            const filtered = prev.filter((r) => !autoAssignedIds.has(r.id));
            console.log("[useRecommendations] ìë™ ë°°ì • í›„ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ):", {
              before: prev.length,
              after: filtered.length,
              autoAssigned: autoAssignedIds.size,
              removedIds: prev
                .filter((r) => autoAssignedIds.has(r.id))
                .map((r) => ({ id: r.id, title: r.title })),
            });
            return filtered;
          });
          
          // allRecommendedContentsì—ì„œë„ ì œê±°
          setAllRecommendedContents((prev) => {
            const filtered = prev.filter((r) => !autoAssignedIds.has(r.id));
            if (filtered.length !== prev.length) {
              console.log("[useRecommendations] ìë™ ë°°ì • í›„ ì „ì²´ ëª©ë¡ ì—…ë°ì´íŠ¸:", {
                before: prev.length,
                after: filtered.length,
                removed: prev.length - filtered.length,
              });
            }
            return filtered;
          });
        } else {
          console.log("[useRecommendations] ìë™ ë°°ì • ìŠ¤í‚µ:", {
            autoAssign,
            filteredRecommendationsCount: filteredRecommendations.length,
            reason: !autoAssign
              ? "ìë™ ë°°ì • ì˜µì…˜ì´ ë¹„í™œì„±í™”ë¨"
              : "ì¶”ì²œ ì½˜í…ì¸ ê°€ ì—†ìŒ",
          });
          
          // ìë™ ë°°ì •í•˜ì§€ ì•Šìœ¼ë©´ ì¶”ì²œ ëª©ë¡ í‘œì‹œ
          setRecommendedContents(filteredRecommendations);
        }
      } catch (error) {
        const planGroupError = toPlanGroupError(
          error,
          PlanGroupErrorCodes.CONTENT_FETCH_FAILED
        );
        console.error(
          "[useRecommendations] ì¶”ì²œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:",
          planGroupError
        );
        alert("ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      } finally {
        setLoading(false);
      }
    },
    [
      data,
      studentId,
      collectStudentMasterIds,
      filterDuplicateContents,
      autoAssignContents,
    ]
  );

  /**
   * ê¸°ë³¸ ì¶”ì²œ ëª©ë¡ ì¡°íšŒ (í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œ)
   */
  const fetchRecommendations = useCallback(async () => {
    // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ studentIdê°€ ì—†ìœ¼ë©´ ì¶”ì²œ ì½˜í…ì¸  ì¡°íšŒ ë¶ˆê°€
    if (!studentId) {
      console.warn("[useRecommendations] studentIdê°€ ì—†ì–´ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í…œí”Œë¦¿ ëª¨ë“œ)");
      setLoading(false);
      setHasRequestedRecommendations(false);
      return;
    }

    setLoading(true);
    try {
      const params = new URLSearchParams();
      // studentIdëŠ” í•„ìˆ˜ (í…œí”Œë¦¿ ëª¨ë“œì—ì„œëŠ” ìœ„ì—ì„œ ì²´í¬)
      params.append("student_id", studentId);
      const url = `/api/recommended-master-contents?${params.toString()}`;
      
      const response = await fetch(url);
      
      if (!response.ok) {
        console.error("[useRecommendations] API ì‹¤íŒ¨");
        setLoading(false);
        return;
      }

      const result = await response.json();

      // API ì‘ë‹µ ì „ì²´ ë¡œê¹…
      console.log("[useRecommendations] API ì‘ë‹µ (fetchRecommendations):", {
        success: result.success,
        hasData: !!result.data,
        hasRecommendations: !!result.data?.recommendations,
        recommendationsCount: result.data?.recommendations?.length || 0,
        rawResponse: result,
      });

      const rawRecommendations = result.data?.recommendations || [];

      // ê° ì¶”ì²œ ì½˜í…ì¸ ì˜ contentType í•„ë“œ í™•ì¸
      console.log("[useRecommendations] ì¶”ì²œ ì½˜í…ì¸  ìƒì„¸ (fetchRecommendations, ë³€í™˜ ì „):", {
        count: rawRecommendations.length,
        items: rawRecommendations.map((r: any) => ({
          id: r.id,
          title: r.title,
          contentType: r.contentType,
          content_type: r.content_type,
          hasContentType: !!r.contentType,
          hasContent_type: !!r.content_type,
          allKeys: Object.keys(r),
        })),
      });

      // API ì‘ë‹µì„ RecommendedContentë¡œ ë³€í™˜ (ì„œë²„ì—ì„œ contentType ë³´ì¥)
      const recommendations: RecommendedContent[] = rawRecommendations.map((r: any) => {
        // contentType ê²€ì¦ (ì„œë²„ì—ì„œ ë³´ì¥ë˜ì§€ë§Œ ë°©ì–´ ì½”ë“œ)
        if (!r.contentType) {
          console.error("[useRecommendations] contentTypeì´ ì—†ëŠ” ì¶”ì²œ ì½˜í…ì¸  (fetchRecommendations):", {
            id: r.id,
            title: r.title,
            allKeys: Object.keys(r),
            rawData: r,
          });
          // ì„œë²„ì—ì„œ ë³´ì¥ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ì—ëŸ¬ ë¡œê¹…ë§Œ ìˆ˜í–‰
        }

        // íƒ€ì… ê²€ì¦
        if (r.contentType && r.contentType !== "book" && r.contentType !== "lecture") {
          console.error("[useRecommendations] ì˜ëª»ëœ contentType (fetchRecommendations):", {
            id: r.id,
            title: r.title,
            contentType: r.contentType,
            rawData: r,
          });
        }

        return {
          id: r.id,
          contentType: (r.contentType || "book") as "book" | "lecture", // ì„œë²„ì—ì„œ ë³´ì¥ë˜ì§€ë§Œ fallback
          title: r.title,
          subject_category: r.subject_category,
          subject: r.subject,
          semester: r.semester,
          revision: r.revision,
          publisher: r.publisher,
          platform: r.platform,
          difficulty_level: r.difficulty_level,
          reason: r.reason,
          priority: r.priority,
          scoreDetails: r.scoreDetails,
        };
      });

      // ë³€í™˜ í›„ í™•ì¸
      console.log("[useRecommendations] ì¶”ì²œ ì½˜í…ì¸  ìƒì„¸ (fetchRecommendations, ë³€í™˜ í›„):", {
        count: recommendations.length,
        items: recommendations.map((r) => ({
          id: r.id,
          title: r.title,
          contentType: r.contentType,
          hasContentType: !!r.contentType,
        })),
      });

      // ì„±ì  ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      const hasDetailedReasons = recommendations.some(
        (r: RecommendedContent) =>
          r.reason?.includes("ë‚´ì‹ ") ||
          r.reason?.includes("ëª¨ì˜ê³ ì‚¬") ||
          r.reason?.includes("ìœ„í—˜ë„") ||
          r.scoreDetails
      );
      setHasScoreData(hasDetailedReasons);

      // master_content_id ìˆ˜ì§‘
      const studentMasterIds = await collectStudentMasterIds();

      // allRecommendedContents ì—…ë°ì´íŠ¸
      setAllRecommendedContents(recommendations);

      // ì¤‘ë³µ ì œê±°
      const filteredRecommendations = filterDuplicateContents(
        recommendations,
        studentMasterIds
      );

      setRecommendedContents(filteredRecommendations);
      setHasRequestedRecommendations(true);
    } catch (error) {
      const planGroupError = toPlanGroupError(
        error,
        PlanGroupErrorCodes.CONTENT_FETCH_FAILED
      );
      console.error("[useRecommendations] ì¶”ì²œ ì¡°íšŒ ì‹¤íŒ¨:", planGroupError);
    } finally {
      setLoading(false);
    }
  }, [studentId, collectStudentMasterIds, filterDuplicateContents]);

  return {
    recommendedContents,
    allRecommendedContents,
    loading,
    hasRequestedRecommendations,
    hasScoreData,
    fetchRecommendations,
    fetchRecommendationsWithSubjects,
    setRecommendedContents,
    setAllRecommendedContents,
  };
}
</file>

<file path="new-group/_components/Step4RecommendedContents/hooks/useRequiredSubjects.ts">
/**
 * useRequiredSubjects Hook
 * í•„ìˆ˜ êµê³¼ ê²€ì¦ ë¡œì§
 */

import { useMemo } from "react";
import { WizardData } from "../../PlanGroupWizard";
import { RecommendedContent } from "../types";

type UseRequiredSubjectsProps = {
  data: WizardData;
  allRecommendedContents: RecommendedContent[];
  selectedContentIds: Set<string>;
  recommendedContents: RecommendedContent[];
};

type RequiredSubject = {
  subject_category: string;
  subject?: string;
  min_count: number;
};

type MissingRequiredSubject = {
  name: string;
  current: number;
  required: number;
};

type ProgressRequiredSubject = {
  subject: string;
  selected: boolean;
};

export type UseRequiredSubjectsReturn = {
  requiredSubjects: RequiredSubject[];
  requiredSubjectCategories: string[];
  missingRequiredSubjects: MissingRequiredSubject[];
  progressRequiredSubjects: ProgressRequiredSubject[];
  selectedSubjectCategories: Set<string>;
  contentCountBySubject: Map<string, number>;
};

export function useRequiredSubjects({
  data,
  allRecommendedContents,
  selectedContentIds,
  recommendedContents,
}: UseRequiredSubjectsProps): UseRequiredSubjectsReturn {
  return useMemo(() => {
    // 1. ì„ íƒëœ êµê³¼ ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘
    const selectedSubjectCategories = new Set<string>();

    // 1-1. ì´ë¯¸ ì¶”ê°€ëœ í•™ìƒ ì½˜í…ì¸ ì˜ subject_category
    data.student_contents.forEach((sc) => {
      if (sc.subject_category) {
        selectedSubjectCategories.add(sc.subject_category);
      }
    });

    // 1-2. í˜„ì¬ ì„ íƒ ì¤‘ì¸ ì¶”ì²œ ì½˜í…ì¸ 
    Array.from(selectedContentIds).forEach((id) => {
      const content = recommendedContents.find((c) => c.id === id);
      if (content?.subject_category) {
        selectedSubjectCategories.add(content.subject_category);
      }
    });

    // 1-3. ì´ë¯¸ ì¶”ê°€ëœ ì¶”ì²œ ì½˜í…ì¸ 
    data.recommended_contents.forEach((rc) => {
      const subjectCategory =
        rc.subject_category ||
        allRecommendedContents.find((c) => c.id === rc.content_id)
          ?.subject_category;
      if (subjectCategory) {
        selectedSubjectCategories.add(subjectCategory);
      }
    });

    // 2. í•„ìˆ˜ ê³¼ëª© ì„¤ì • (í…œí”Œë¦¿ ì„¤ì •ì— ë”°ë¼ ë™ì  ì²˜ë¦¬)
    const requiredSubjects: RequiredSubject[] =
      data.subject_constraints?.enable_required_subjects_validation &&
      data.subject_constraints?.required_subjects &&
      data.subject_constraints.required_subjects.length > 0
        ? data.subject_constraints.required_subjects
        : [];

    const requiredSubjectCategories = requiredSubjects.map(
      (req) => req.subject_category
    );

    // 3. ì„ íƒëœ ì½˜í…ì¸ ë¥¼ êµê³¼/ê³¼ëª©ë³„ë¡œ ì¹´ìš´íŠ¸
    const contentCountBySubject = new Map<string, number>();

    // 3-1. í•™ìƒ ì½˜í…ì¸  ì¹´ìš´íŠ¸
    data.student_contents.forEach((sc) => {
      if (sc.subject_category) {
        const key = sc.subject ? `${sc.subject_category}:${sc.subject}` : sc.subject_category;
        contentCountBySubject.set(key, (contentCountBySubject.get(key) || 0) + 1);
      }
    });

    // 3-2. ì¶”ì²œ ì½˜í…ì¸  ì¹´ìš´íŠ¸
    data.recommended_contents.forEach((rc) => {
      const subjectCategory =
        rc.subject_category ||
        allRecommendedContents.find((c) => c.id === rc.content_id)
          ?.subject_category;
      if (subjectCategory) {
        const key = rc.subject ? `${subjectCategory}:${rc.subject}` : subjectCategory;
        contentCountBySubject.set(key, (contentCountBySubject.get(key) || 0) + 1);
      }
    });

    // 3-3. í˜„ì¬ ì„ íƒ ì¤‘ì¸ ì¶”ì²œ ì½˜í…ì¸  ì¹´ìš´íŠ¸
    Array.from(selectedContentIds).forEach((id) => {
      const content = recommendedContents.find((c) => c.id === id);
      if (content?.subject_category) {
        const key = content.subject_category;
        contentCountBySubject.set(key, (contentCountBySubject.get(key) || 0) + 1);
      }
    });

    // 4. í•„ìˆ˜ ê³¼ëª© ê²€ì¦
    const missingRequiredSubjects: MissingRequiredSubject[] = [];

    requiredSubjects.forEach((req) => {
      let count = 0;

      if (req.subject) {
        // ì„¸ë¶€ ê³¼ëª©ì´ ì§€ì •ëœ ê²½ìš°
        const exactKey = `${req.subject_category}:${req.subject}`;
        count = contentCountBySubject.get(exactKey) || 0;
      } else {
        // êµê³¼ë§Œ ì§€ì •ëœ ê²½ìš°: í•´ë‹¹ êµê³¼ì˜ ëª¨ë“  ì½˜í…ì¸  ì¹´ìš´íŠ¸
        contentCountBySubject.forEach((cnt, key) => {
          if (
            key.startsWith(req.subject_category + ":") ||
            key === req.subject_category
          ) {
            count += cnt;
          }
        });
      }

      if (count < req.min_count) {
        const displayName = req.subject
          ? `${req.subject_category} - ${req.subject}`
          : req.subject_category;
        missingRequiredSubjects.push({
          name: displayName,
          current: count,
          required: req.min_count,
        });
      }
    });

    // 5. ProgressIndicatorìš© í•„ìˆ˜ê³¼ëª© ì •ë³´ ìƒì„±
    const progressRequiredSubjects: ProgressRequiredSubject[] = requiredSubjects.map((req) => {
      let count = 0;

      if (req.subject) {
        const exactKey = `${req.subject_category}:${req.subject}`;
        count = contentCountBySubject.get(exactKey) || 0;
      } else {
        contentCountBySubject.forEach((cnt, key) => {
          if (
            key.startsWith(req.subject_category + ":") ||
            key === req.subject_category
          ) {
            count += cnt;
          }
        });
      }

      const displayName = req.subject
        ? `${req.subject_category} - ${req.subject}`
        : req.subject_category;

      return {
        subject: displayName,
        selected: count >= req.min_count,
      };
    });

    return {
      requiredSubjects,
      requiredSubjectCategories,
      missingRequiredSubjects,
      progressRequiredSubjects,
      selectedSubjectCategories,
      contentCountBySubject,
    };
  }, [
    data.student_contents,
    data.recommended_contents,
    data.subject_constraints,
    allRecommendedContents,
    selectedContentIds,
    recommendedContents,
  ]);
}
</file>

<file path="new-group/_components/Step4RecommendedContents/constants.ts">
/**
 * Step4RecommendedContents ìƒìˆ˜ ì •ì˜
 */

// ì‚¬ìš© ê°€ëŠ¥í•œ êµê³¼ ëª©ë¡
export const AVAILABLE_SUBJECTS = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ê³¼í•™", "ì‚¬íšŒ"] as const;

// ìµœëŒ€ ì½˜í…ì¸  ê°œìˆ˜
export const MAX_CONTENTS = 9;

// ìµœì†Œ ì¶”ì²œ ê°œìˆ˜
export const MIN_RECOMMENDATION_COUNT = 1;

// ìµœëŒ€ ì¶”ì²œ ê°œìˆ˜ (êµê³¼ë‹¹)
export const MAX_RECOMMENDATION_COUNT_PER_SUBJECT = 5;

// í•„ìˆ˜ êµê³¼ (ê¸°ë³¸ê°’)
export const DEFAULT_REQUIRED_SUBJECTS = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´"] as const;

// ì—ëŸ¬ ë©”ì‹œì§€
export const ERROR_MESSAGES = {
  NO_SUBJECTS_SELECTED: "ìµœì†Œ 1ê°œ ì´ìƒì˜ êµê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",
  NO_COUNT_SET: "ìµœì†Œ 1ê°œ ì´ìƒì˜ ì½˜í…ì¸ ë¥¼ ì¶”ì²œ ë°›ìœ¼ë ¤ë©´ ê°œìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.",
  EXCEED_MAX_CONTENTS: (current: number, requested: number, max: number) =>
    `ì¶”ì²œ ë°›ì„ ìˆ˜ ìˆëŠ” ìµœëŒ€ ê°œìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${current}ê°œ, ìš”ì²­: ${requested}ê°œ, ìµœëŒ€: ${max}ê°œ)`,
  ALREADY_SELECTED: "ì´ë¯¸ ì„ íƒëœ ì½˜í…ì¸ ì…ë‹ˆë‹¤.",
  DUPLICATE_CONTENT: "ì´ë¯¸ ì¶”ê°€ëœ ì½˜í…ì¸ ì…ë‹ˆë‹¤.",
  NO_CONTENT_SELECTED: "ì„ íƒëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.",
  RANGE_NOT_SET: "ì‹œì‘ê³¼ ì¢…ë£Œ ë²”ìœ„ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.",
  REQUIRED_SUBJECTS_NOT_MET: "í•„ìˆ˜ êµê³¼ê°€ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",
} as const;

// ì„±ê³µ ë©”ì‹œì§€
export const SUCCESS_MESSAGES = {
  RECOMMENDATIONS_ADDED: (count: number) => `ì¶”ì²œ ì½˜í…ì¸  ${count}ê°œê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`,
  CONTENTS_ADDED: (count: number) => `${count}ê°œì˜ ì½˜í…ì¸ ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`,
  REFRESH_COMPLETED: "ìƒˆë¡œìš´ ì¶”ì²œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.",
  RANGE_SAVED: "ë²”ìœ„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.",
} as const;

// í™•ì¸ ë©”ì‹œì§€
export const CONFIRM_MESSAGES = {
  REFRESH_RECOMMENDATIONS: "ìƒˆë¡œìš´ ì¶”ì²œì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ì¶”ì²œ ëª©ë¡ì— ìƒˆ ì¶”ì²œì´ ì¶”ê°€ë©ë‹ˆë‹¤.",
  CLOSE_WITH_CHANGES: "ë³€ê²½ ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?",
  REMOVE_CONTENT: "ì´ ì½˜í…ì¸ ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
} as const;
</file>

<file path="new-group/_components/Step4RecommendedContents/Step4RecommendedContentsRefactored.tsx">
/**
 * Step4RecommendedContents (Refactored)
 * ì„œë¹„ìŠ¤ ì¶”ì²œ ì½˜í…ì¸  ì„ íƒ ë‹¨ê³„ - ë¦¬íŒ©í† ë§ ë²„ì „
 */

"use client";

import { useState, useCallback, useEffect } from "react";
import { WizardData } from "../PlanGroupWizard";
import { ContentSelectionProgress } from "../_shared/ContentSelectionProgress";
import { fetchDetailSubjects } from "@/app/(student)/actions/fetchDetailSubjects";
import { getSubjectGroupsAction, getCurriculumRevisionsAction, getSubjectsByGroupAction } from "@/app/(student)/actions/contentMetadataActions";
import type { SubjectGroup } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

// Hooks
import { useRecommendations } from "./hooks/useRecommendations";
import { useContentSelection } from "./hooks/useContentSelection";
import { useRangeEditor } from "./hooks/useRangeEditor";
import { useRequiredSubjects } from "./hooks/useRequiredSubjects";

// Components
import RecommendationRequestForm from "./components/RecommendationRequestForm";
import RecommendedContentsList from "./components/RecommendedContentsList";
import AddedContentsList from "./components/AddedContentsList";
import RequiredSubjectsSection from "./components/RequiredSubjectsSection";

// Types & Constants
import { Step4RecommendedContentsProps } from "./types";
import { ERROR_MESSAGES, CONFIRM_MESSAGES } from "./constants";

export default function Step4RecommendedContents({
  data,
  onUpdate,
  isEditMode = false,
  isCampMode = false,
  studentId,
}: Step4RecommendedContentsProps) {
  // ============================================================================
  // ì¶”ì²œ ì½˜í…ì¸  ê´€ë¦¬
  // ============================================================================
  const {
    recommendedContents,
    allRecommendedContents,
    loading,
    hasRequestedRecommendations,
    hasScoreData,
    fetchRecommendations,
    fetchRecommendationsWithSubjects,
    setRecommendedContents,
    setAllRecommendedContents,
  } = useRecommendations({
    isEditMode,
    studentId,
    data,
    onUpdate,
  });

  // ============================================================================
  // ì½˜í…ì¸  ì„ íƒ ê´€ë¦¬
  // ============================================================================
  const {
    selectedContentIds,
    toggleContentSelection,
    addSelectedContents,
    removeContent,
    setSelectedContentIds,
  } = useContentSelection({
    data,
    recommendedContents,
    allRecommendedContents,
    onUpdate,
  });

  // ============================================================================
  // ë²”ìœ„ í¸ì§‘ ê´€ë¦¬
  // ============================================================================
  const {
    editingRangeIndex,
    editingRange,
    contentDetails,
    loadingDetails,
    contentTotals,
    startDetailId,
    endDetailId,
    startEditingRange,
    cancelEditingRange,
    saveEditingRange,
    setStartRange,
    setEndRange,
    setEditingRange,
  } = useRangeEditor({
    data,
    onUpdate,
  });

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ ê²€ì¦
  // ============================================================================
  const {
    requiredSubjects,
    requiredSubjectCategories,
    missingRequiredSubjects,
    progressRequiredSubjects,
    selectedSubjectCategories,
    contentCountBySubject,
  } = useRequiredSubjects({
    data,
    allRecommendedContents,
    selectedContentIds,
    recommendedContents,
  });

  // ============================================================================
  // ì¶”ì²œ ìš”ì²­ ìƒíƒœ (êµê³¼ ì„ íƒ, ê°œìˆ˜)
  // ============================================================================
  const [selectedSubjects, setSelectedSubjects] = useState<Set<string>>(
    new Set()
  );
  const [recommendationCounts, setRecommendationCounts] = useState<
    Map<string, number>
  >(new Map());
  const [autoAssignContents, setAutoAssignContents] = useState(false);

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ ì„¤ì • ê´€ë¦¬
  // ============================================================================
  const [availableSubjectGroups, setAvailableSubjectGroups] = useState<SubjectGroup[]>([]);
  const [curriculumRevisions, setCurriculumRevisions] = useState<CurriculumRevision[]>([]);
  const [loadingSubjectGroups, setLoadingSubjectGroups] = useState(false);
  const [loadingCurriculumRevisions, setLoadingCurriculumRevisions] = useState(false);

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ ë°ì´í„° ë¡œë“œ
  // ============================================================================
  useEffect(() => {
    const loadSubjectGroups = async () => {
      setLoadingSubjectGroups(true);
      try {
        const groups = await getSubjectGroupsAction();
        setAvailableSubjectGroups(groups);
      } catch (error) {
        console.error("êµê³¼ ê·¸ë£¹ ì¡°íšŒ ì‹¤íŒ¨:", error);
      } finally {
        setLoadingSubjectGroups(false);
      }
    };

    const loadCurriculumRevisions = async () => {
      setLoadingCurriculumRevisions(true);
      try {
        const revisions = await getCurriculumRevisionsAction();
        setCurriculumRevisions(revisions);
      } catch (error) {
        console.error("ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ ì‹¤íŒ¨:", error);
      } finally {
        setLoadingCurriculumRevisions(false);
      }
    };

    loadSubjectGroups();
    loadCurriculumRevisions();
  }, []);

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ í•¸ë“¤ëŸ¬
  // ============================================================================
  const handleLoadSubjects = useCallback(
    async (subjectGroupId: string, curriculumRevisionId: string): Promise<Array<{ id: string; name: string }>> => {
      try {
        const subjects = await getSubjectsByGroupAction(subjectGroupId);
        return subjects.map((subject) => ({
          id: subject.id,
          name: subject.name,
        }));
      } catch (error) {
        console.error("ê³¼ëª© ì¡°íšŒ ì‹¤íŒ¨:", error);
        return [];
      }
    },
    []
  );

  const handleAddRequiredSubject = useCallback(() => {
    const currentConstraints = data.subject_constraints || {
      enable_required_subjects_validation: true,
      required_subjects: [],
      constraint_handling: "warning",
    };

    onUpdate({
      subject_constraints: {
        ...currentConstraints,
        required_subjects: [
          ...(currentConstraints.required_subjects || []),
          { subject_group_id: "", subject_category: "", min_count: 1 },
        ],
      },
    });
  }, [data.subject_constraints, onUpdate]);

  const handleRequiredSubjectUpdate = useCallback(
    (
      index: number,
      updated: Partial<{
        subject_category: string;
        subject?: string;
        min_count: number;
      }>
    ) => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      const newRequirements = [...currentConstraints.required_subjects!];
      newRequirements[index] = { ...newRequirements[index], ...updated };

      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          required_subjects: newRequirements,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  const handleRequiredSubjectRemove = useCallback(
    (index: number) => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      const newRequirements = currentConstraints.required_subjects!.filter(
        (_, i) => i !== index
      );

      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          required_subjects: newRequirements,
          enable_required_subjects_validation: newRequirements.length > 0,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  const handleConstraintHandlingChange = useCallback(
    (handling: "strict" | "warning" | "auto_fix") => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          constraint_handling: handling,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  // ============================================================================
  // ì¶”ì²œ ìš”ì²­ í•¸ë“¤ëŸ¬
  // ============================================================================
  const handleSubjectToggle = useCallback((subject: string) => {
    setSelectedSubjects((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(subject)) {
        newSet.delete(subject);
      } else {
        newSet.add(subject);
      }
      return newSet;
    });

    // êµê³¼ê°€ ì„ íƒë˜ë©´ ê¸°ë³¸ ê°œìˆ˜ 1ë¡œ ì„¤ì •
    setRecommendationCounts((prev) => {
      const newMap = new Map(prev);
      if (!prev.has(subject)) {
        newMap.set(subject, 1);
      }
      return newMap;
    });
  }, []);

  const handleCountChange = useCallback((subject: string, count: number) => {
    setRecommendationCounts((prev) => {
      const newMap = new Map(prev);
      newMap.set(subject, count);
      return newMap;
    });
  }, []);

  const handleSubmitRecommendation = useCallback(async () => {
    // ìµœì†Œ ì œì•½ ê²€ì¦
    if (selectedSubjects.size === 0) {
      alert(ERROR_MESSAGES.NO_SUBJECTS_SELECTED);
      return;
    }

    const totalRequested = Array.from(recommendationCounts.values()).reduce(
      (sum, count) => sum + count,
      0
    );
    const currentTotal =
      data.student_contents.length + data.recommended_contents.length;

    if (totalRequested === 0) {
      alert(ERROR_MESSAGES.NO_COUNT_SET);
      return;
    }

    if (currentTotal + totalRequested > 9) {
      alert(
        ERROR_MESSAGES.EXCEED_MAX_CONTENTS(currentTotal, totalRequested, 9)
      );
      return;
    }

    // êµê³¼ë³„ ì¶”ì²œ ê°œìˆ˜ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì¶”ì²œ ìš”ì²­
    await fetchRecommendationsWithSubjects(
      Array.from(selectedSubjects),
      recommendationCounts,
      autoAssignContents
    );
  }, [
    selectedSubjects,
    recommendationCounts,
    data.student_contents,
    data.recommended_contents,
    autoAssignContents,
    fetchRecommendationsWithSubjects,
  ]);

  const handleRefreshRecommendations = useCallback(async () => {
    if (!confirm(CONFIRM_MESSAGES.REFRESH_RECOMMENDATIONS)) {
      return;
    }

    // êµê³¼ ì„ íƒ ì—¬ë¶€ í™•ì¸
    if (selectedSubjects.size === 0) {
      alert("ì¶”ì²œë°›ì„ êµê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    // ì¬ì¶”ì²œ ìš”ì²­
    await fetchRecommendationsWithSubjects(
      Array.from(selectedSubjects),
      recommendationCounts,
      false // ì¬ì¶”ì²œì€ ìë™ ë°°ì •í•˜ì§€ ì•ŠìŒ
    );

    alert("ìƒˆë¡œìš´ ì¶”ì²œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }, [
    selectedSubjects,
    recommendationCounts,
    fetchRecommendationsWithSubjects,
  ]);

  // ============================================================================
  // ê³„ì‚°ëœ ê°’ë“¤
  // ============================================================================
  const studentCount = data.student_contents.length;
  const recommendedCount = data.recommended_contents.length;
  const totalCount = studentCount + recommendedCount;
  const canAddMore = totalCount < 9;

  // ============================================================================
  // Render
  // ============================================================================
  return (
    <div className="space-y-6">
      {/* í•„ìˆ˜ êµê³¼ ì„¤ì • ì„¹ì…˜ */}
      <RequiredSubjectsSection
        data={data}
        availableSubjectGroups={availableSubjectGroups}
        curriculumRevisions={curriculumRevisions}
        onUpdate={onUpdate}
        onLoadSubjects={handleLoadSubjects}
        onAddRequiredSubject={handleAddRequiredSubject}
        onUpdateRequiredSubject={handleRequiredSubjectUpdate}
        onRemoveRequiredSubject={handleRequiredSubjectRemove}
        onConstraintHandlingChange={handleConstraintHandlingChange}
        isTemplateMode={false}
        isCampMode={isCampMode}
        studentId={studentId}
      />

      <div className="flex flex-col gap-6">
        <div className="flex flex-col gap-2">
          <h2 className="text-xl font-semibold text-gray-900">
            ì„œë¹„ìŠ¤ ì¶”ì²œ ì½˜í…ì¸ 
          </h2>
          <p className="text-sm text-gray-500">
            ì„±ì  ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œëœ êµì¬ì™€ ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ìµœëŒ€ 9ê°œ,
            êµ­ì–´/ìˆ˜í•™/ì˜ì–´ ê° 1ê°œ ì´ìƒ í•„ìˆ˜)
          </p>
        </div>

        {/* ì½˜í…ì¸  ì„ íƒ ì§„í–‰ë¥  */}
        <div>
          <ContentSelectionProgress
            current={totalCount}
            max={9}
            requiredSubjects={progressRequiredSubjects}
            showWarning={missingRequiredSubjects.length > 0}
            warningMessage={
              missingRequiredSubjects.length > 0
                ? `ë‹¤ìŒ í•„ìˆ˜ ê³¼ëª©ì˜ ìµœì†Œ ê°œìˆ˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${missingRequiredSubjects
                    .map(
                      (m) =>
                        `${m.name} (í˜„ì¬ ${m.current}ê°œ / í•„ìš” ${m.required}ê°œ)`
                    )
                    .join(", ")}`
                : undefined
            }
          />
        </div>

        {/* ì´ë¯¸ ì¶”ê°€ëœ ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ */}
        <AddedContentsList
          contents={data.recommended_contents}
          allRecommendedContents={allRecommendedContents}
          editingRangeIndex={editingRangeIndex}
          editingRange={editingRange}
          contentDetails={contentDetails}
          contentTotals={contentTotals}
          onRangeChange={(start, end) => {
            setEditingRange({ start, end });
          }}
          startDetailId={startDetailId}
          endDetailId={endDetailId}
          loadingDetails={loadingDetails}
          onStartEditing={startEditingRange}
          onSaveRange={saveEditingRange}
          onCancelEditing={cancelEditingRange}
          onRemove={removeContent}
          onStartDetailChange={setStartRange}
          onEndDetailChange={setEndRange}
        />

        {/* ì¶”ì²œ ìš”ì²­ í¼ (ì¶”ì²œì„ ë°›ê¸° ì „ ë˜ëŠ” ì¶”ê°€ ì¶”ì²œì„ ë°›ì„ ë•Œ) */}
        {!hasRequestedRecommendations && (
          <RecommendationRequestForm
            selectedSubjects={selectedSubjects}
            recommendationCounts={recommendationCounts}
            autoAssignContents={autoAssignContents}
            currentStudentContentsCount={studentCount}
            currentRecommendedContentsCount={recommendedCount}
            onSubjectToggle={handleSubjectToggle}
            onCountChange={handleCountChange}
            onAutoAssignChange={setAutoAssignContents}
            onSubmit={handleSubmitRecommendation}
            disabled={loading}
          />
        )}

        {/* ë¡œë”© ìƒíƒœ */}
        {loading && (
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
            <p className="text-sm text-gray-500">ì¶”ì²œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        )}

        {/* ì¶”ì²œ ê²°ê³¼ê°€ ì—†ì„ ë•Œ */}
        {hasRequestedRecommendations &&
          !loading &&
          recommendedContents.length === 0 && (
            <div className="rounded-lg border border-amber-200 bg-amber-50 p-8 text-center">
              <p className="text-sm font-medium text-amber-800">
                ì¶”ì²œí•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.
              </p>
              <p className="text-xs text-amber-600">
                ì„±ì  ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì‹œë©´ ë§ì¶¤í˜• ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          )}

        {/* ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ */}
        {hasRequestedRecommendations &&
          !loading &&
          recommendedContents.length > 0 && (
            <RecommendedContentsList
              recommendedContents={recommendedContents}
              selectedContentIds={selectedContentIds}
              selectedSubjects={selectedSubjects}
              recommendationCounts={recommendationCounts}
              requiredSubjectCategories={requiredSubjectCategories}
              selectedSubjectCategories={selectedSubjectCategories}
              missingRequiredSubjects={missingRequiredSubjects}
              studentCount={studentCount}
              recommendedCount={recommendedCount}
              loading={loading}
              onToggleSelection={toggleContentSelection}
              onRefresh={handleRefreshRecommendations}
              onAddSelectedContents={addSelectedContents}
            />
          )}
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents/types.ts">
/**
 * Step4RecommendedContents íƒ€ì… ì •ì˜
 */

import { WizardData } from "../PlanGroupWizard";

// ============================================================================
// ì½˜í…ì¸  ê´€ë ¨ íƒ€ì…
// ============================================================================

export type BookDetail = {
  id: string;
  page_number: number;
  major_unit: string | null;
  minor_unit: string | null;
};

export type LectureEpisode = {
  id: string;
  episode_number: number;
  episode_title: string | null;
};

export type ContentDetail = BookDetail | LectureEpisode;

export type RecommendedContent = {
  id: string;
  contentType: "book" | "lecture";
  title: string;
  subject_category: string | null;
  subject: string | null;
  semester: string | null;
  revision: string | null;
  publisher?: string | null;
  platform?: string | null;
  difficulty_level: string | null;
  reason: string;
  priority: number;
  scoreDetails?: {
    schoolGrade?: number | null;
    schoolAverageGrade?: number | null;
    mockPercentile?: number | null;
    mockGrade?: number | null;
    riskScore?: number;
  };
};

// ============================================================================
// Props íƒ€ì…
// ============================================================================

export type Step4RecommendedContentsProps = {
  data: WizardData;
  onUpdate: (
    updates: Partial<WizardData> | ((prev: WizardData) => Partial<WizardData>)
  ) => void;
  isEditMode?: boolean;
  isCampMode?: boolean;
  studentId?: string; // ê´€ë¦¬ì ëª¨ë“œì—ì„œ ë‹¤ë¥¸ í•™ìƒì˜ ì¶”ì²œ ì½˜í…ì¸  ì¡°íšŒ ì‹œ ì‚¬ìš©
  isAdminContinueMode?: boolean; // ê´€ë¦¬ì ë‚¨ì€ ë‹¨ê³„ ì§„í–‰ ëª¨ë“œ
};

// ============================================================================
// Hook ë°˜í™˜ íƒ€ì…
// ============================================================================

export type UseRecommendationsReturn = {
  recommendedContents: RecommendedContent[];
  allRecommendedContents: RecommendedContent[];
  loading: boolean;
  hasRequestedRecommendations: boolean;
  hasScoreData: boolean;
  fetchRecommendations: () => Promise<void>;
  fetchRecommendationsWithSubjects: (
    subjects: string[],
    counts: Map<string, number>,
    autoAssign: boolean
  ) => Promise<void>;
  setRecommendedContents: React.Dispatch<React.SetStateAction<RecommendedContent[]>>;
  setAllRecommendedContents: React.Dispatch<React.SetStateAction<RecommendedContent[]>>;
};

export type UseContentSelectionReturn = {
  selectedContentIds: Set<string>;
  toggleContentSelection: (contentId: string) => void;
  addSelectedContents: () => Promise<void>;
  removeContent: (index: number, type?: "recommended" | "student") => void;
  setSelectedContentIds: React.Dispatch<React.SetStateAction<Set<string>>>;
};

export type UseRangeEditorReturn = {
  editingRangeIndex: number | null;
  editingRange: { start: string; end: string } | null;
  contentDetails: Map<
    number,
    { details: (BookDetail | LectureEpisode)[]; type: "book" | "lecture" }
  >;
  startDetailId: Map<number, string>;
  endDetailId: Map<number, string>;
  contentTotals: Map<number, number>;
  loadingDetails: Set<number>;
  startEditingRange: (index: number, type?: "recommended" | "student") => void;
  saveEditingRange: () => void;
  cancelEditingRange: () => void;
  setStartRange: (index: number, detailId: string) => void;
  setEndRange: (index: number, detailId: string) => void;
  setEditingRange: React.Dispatch<React.SetStateAction<{ start: string; end: string } | null>>;
};

export type UseRequiredSubjectsReturn = {
  requiredSubjects: Array<{
    subject_category: string;
    subject?: string;
    min_count: number;
  }>;
  requiredSubjectCategories: string[];
  missingRequiredSubjects: Array<{
    name: string;
    current: number;
    required: number;
  }>;
  progressRequiredSubjects: Array<{
    subject: string;
    selected: boolean;
  }>;
  selectedSubjectCategories: Set<string>;
  contentCountBySubject: Map<string, number>;
};

// ============================================================================
// Component Props íƒ€ì…
// ============================================================================

export type RequiredSubjectsSectionProps = {
  data: WizardData;
  availableSubjects: string[];
  detailSubjects: Map<string, string[]>;
  loadingDetailSubjects: Set<string>;
  onUpdate: (updates: Partial<WizardData>) => void;
  onLoadDetailSubjects: (category: string, curriculumRevisionId?: string) => void;
  onAddRequiredSubject: () => void;
  onUpdateRequiredSubject: (
    index: number,
    updated: Partial<{
      subject_category: string;
      subject?: string;
      min_count: number;
    }>
  ) => void;
  onRemoveRequiredSubject: (index: number) => void;
  onConstraintHandlingChange?: (handling: "strict" | "warning" | "auto_fix") => void;
  isTemplateMode?: boolean;
  isCampMode?: boolean;
  studentId?: string;
};

export type RecommendationRequestFormProps = {
  selectedSubjects: Set<string>;
  recommendationCounts: Map<string, number>;
  autoAssignContents: boolean;
  availableSubjects: string[];
  data: WizardData;
  onSubjectToggle: (subject: string) => void;
  onCountChange: (subject: string, count: number) => void;
  onAutoAssignChange: (value: boolean) => void;
  onSubmit: (
    subjects: string[],
    counts: Map<string, number>,
    autoAssign: boolean
  ) => Promise<void>;
};

export type RecommendedContentsListProps = {
  recommendedContents: RecommendedContent[];
  allRecommendedContents: RecommendedContent[];
  selectedContentIds: Set<string>;
  requiredSubjects: Array<{
    subject_category: string;
    subject?: string;
    min_count: number;
  }>;
  data: WizardData;
  selectedSubjects: Set<string>;
  recommendationCounts: Map<string, number>;
  loading: boolean;
  onToggleSelection: (contentId: string) => void;
  onRefresh: (
    subjects: string[],
    counts: Map<string, number>,
    autoAssign: boolean
  ) => Promise<void>;
};

export type AddedContentsListProps = {
  contents: Array<{
    content_type: "book" | "lecture";
    content_id: string;
    start_range: number;
    end_range: number;
    start_detail_id?: string | null;
    end_detail_id?: string | null;
  }>;
  allRecommendedContents: RecommendedContent[];
  editingRangeIndex: number | null;
  contentDetails: Map<
    number,
    { details: ContentDetail[]; type: "book" | "lecture" }
  >;
  startDetailId: Map<number, string>;
  endDetailId: Map<number, string>;
  loadingDetails: Set<number>;
  onStartEditing: (index: number) => void;
  onSaveRange: (index: number) => void;
  onCancelEditing: () => void;
  onRemove: (index: number) => void;
  onStartDetailChange: (index: number, detailId: string) => void;
  onEndDetailChange: (index: number, detailId: string) => void;
};

// ============================================================================
// ë‚´ë¶€ íƒ€ì…
// ============================================================================

export type RequiredSubject = {
  subject_category: string;
  subject?: string;
  min_count: number;
};

export type ContentWithMetadata = {
  content_id: string;
  content_type: "book" | "lecture";
  title?: string;
  subject_category?: string | null;
  master_content_id?: string | null;
};
</file>

<file path="new-group/_components/Step6FinalReview/hooks/useContentDetails.ts">
import { useState, useEffect, useRef } from "react";
import {
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";
import { WizardData } from "../../PlanGroupWizard";
import { BookDetail, LectureEpisode } from "../types";

type UseContentDetailsProps = {
  editingRangeIndex: { type: "student" | "recommended"; index: number } | null;
  data: WizardData;
  isCampMode?: boolean;
  studentId?: string;
};

export function useContentDetails({
  editingRangeIndex,
  data,
  isCampMode = false,
  studentId,
}: UseContentDetailsProps) {
  const [contentDetails, setContentDetails] = useState<
    Map<
      string,
      { details: BookDetail[] | LectureEpisode[]; type: "book" | "lecture" }
    >
  >(new Map());
  const [startDetailId, setStartDetailId] = useState<Map<string, string>>(
    new Map()
  );
  const [endDetailId, setEndDetailId] = useState<Map<string, string>>(
    new Map()
  );
  const [loadingDetails, setLoadingDetails] = useState<Set<string>>(new Set());
  const cachedDetailsRef = useRef<
    Map<
      string,
      { details: BookDetail[] | LectureEpisode[]; type: "book" | "lecture" }
    >
  >(new Map());

  useEffect(() => {
    if (!editingRangeIndex) {
      return;
    }

    const fetchDetails = async () => {
      const content =
        editingRangeIndex.type === "student"
          ? data.student_contents[editingRangeIndex.index]
          : data.recommended_contents[editingRangeIndex.index];

      if (!content) return;

      const contentKey = `${editingRangeIndex.type}-${editingRangeIndex.index}`;

      // ì´ë¯¸ ì¡°íšŒí•œ ê²½ìš° ìºì‹œì—ì„œ ê°€ì ¸ì˜¤ê¸°
      if (cachedDetailsRef.current.has(content.content_id)) {
        const cached = cachedDetailsRef.current.get(content.content_id)!;
        setContentDetails(new Map([[contentKey, cached]]));
        return;
      }

      setLoadingDetails(new Set([contentKey]));

      try {
        // ìº í”„ ëª¨ë“œì—ì„œ ê´€ë¦¬ìì˜ ê²½ìš° student_idë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
        const studentIdParam =
          isCampMode && studentId ? `&student_id=${studentId}` : "";
        const apiPath =
          editingRangeIndex.type === "student"
            ? `/api/student-content-details?contentType=${content.content_type}&contentId=${content.content_id}${studentIdParam}`
            : `/api/master-content-details?contentType=${content.content_type}&contentId=${content.content_id}`;

        const response = await fetch(apiPath);
        if (response.ok) {
          const result = await response.json();
          const detailData =
            content.content_type === "book"
              ? { details: result.details || [], type: "book" as const }
              : { details: result.episodes || [], type: "lecture" as const };

          // ìºì‹œì— ì €ì¥
          cachedDetailsRef.current.set(content.content_id, detailData);
          setContentDetails(new Map([[contentKey, detailData]]));

          // ì €ì¥ëœ ìƒì„¸ ì •ë³´ IDê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ í˜„ì¬ ë²”ìœ„ë¡œ ì°¾ê¸°
          const savedStartDetailId = content.start_detail_id;
          const savedEndDetailId = content.end_detail_id;

          if (savedStartDetailId || savedEndDetailId) {
            // ì €ì¥ëœ detail_idë¡œ ì§ì ‘ ì„ íƒ
            if (savedStartDetailId) {
              setStartDetailId((prev) => {
                const newMap = new Map(prev);
                newMap.set(contentKey, savedStartDetailId);
                return newMap;
              });
            }
            if (savedEndDetailId) {
              setEndDetailId((prev) => {
                const newMap = new Map(prev);
                newMap.set(contentKey, savedEndDetailId);
                return newMap;
              });
            }
          } else {
            // ì €ì¥ëœ detail_idê°€ ì—†ìœ¼ë©´ í˜„ì¬ ë²”ìœ„ë¡œ ì°¾ê¸° (í•˜ìœ„ í˜¸í™˜ì„±)
            const currentRange = {
              start: content.start_range,
              end: content.end_range,
            };

            if (detailData.type === "book") {
              const details = detailData.details as BookDetail[];
              const startDetail = details.find(
                (d) => d.page_number === currentRange.start
              );
              const endDetail = details.find(
                (d) => d.page_number === currentRange.end
              );
              if (startDetail) {
                setStartDetailId((prev) => {
                  const newMap = new Map(prev);
                  newMap.set(contentKey, startDetail.id);
                  return newMap;
                });
              }
              if (endDetail) {
                setEndDetailId((prev) => {
                  const newMap = new Map(prev);
                  newMap.set(contentKey, endDetail.id);
                  return newMap;
                });
              }
            } else {
              const episodes = detailData.details as LectureEpisode[];
              const startEpisode = episodes.find(
                (e) => e.episode_number === currentRange.start
              );
              const endEpisode = episodes.find(
                (e) => e.episode_number === currentRange.end
              );
              if (startEpisode) {
                setStartDetailId((prev) => {
                  const newMap = new Map(prev);
                  newMap.set(contentKey, startEpisode.id);
                  return newMap;
                });
              }
              if (endEpisode) {
                setEndDetailId((prev) => {
                  const newMap = new Map(prev);
                  newMap.set(contentKey, endEpisode.id);
                  return newMap;
                });
              }
            }
          }
        }
      } catch (error) {
        const planGroupError = toPlanGroupError(
          error,
          PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED
        );
        console.error("[useContentDetails] ìƒì„¸ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", planGroupError);
      } finally {
        setLoadingDetails((prev) => {
          const newSet = new Set(prev);
          newSet.delete(contentKey);
          return newSet;
        });
      }
    };

    fetchDetails();
  }, [editingRangeIndex, data.student_contents, data.recommended_contents, isCampMode, studentId]);

  return {
    contentDetails,
    startDetailId,
    endDetailId,
    loadingDetails,
    setStartDetailId,
    setEndDetailId,
  };
}
</file>

<file path="new-group/_components/Step6FinalReview/hooks/useContentInfos.ts">
import { useState, useEffect, useMemo } from "react";
import {
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";
import { fetchContentMetadataAction } from "@/app/(student)/actions/fetchContentMetadata";
import { WizardData } from "../../PlanGroupWizard";
import { ContentInfo } from "../types";
import { createBatchRequest, getContentType } from "@/lib/utils/contentDetailsUtils";

type ContentMetadata = {
  title?: string;
  subject?: string | null;
  subject_category?: string | null;
  semester?: string | null;
  revision?: string | null;
  difficulty_level?: string | null;
  publisher?: string | null;
  platform?: string | null;
};

type UseContentInfosProps = {
  data: WizardData;
  contents?: {
    books: Array<{ id: string; title: string; subtitle?: string | null }>;
    lectures: Array<{ id: string; title: string; subtitle?: string | null }>;
    custom: Array<{ id: string; title: string; subtitle?: string | null }>;
  };
  isCampMode?: boolean;
  studentId?: string;
};

export function useContentInfos({
  data,
  contents,
  isCampMode = false,
  studentId,
}: UseContentInfosProps) {
  const [contentInfos, setContentInfos] = useState<ContentInfo[]>([]);
  const [loading, setLoading] = useState(true);

  // bookIdSet ìƒì„± (ì½˜í…ì¸  íƒ€ì… í™•ì¸ìš©)
  const bookIdSet = useMemo(() => {
    const set = new Set<string>();
    data.student_contents.forEach((c) => {
      if (c.content_type === "book") {
        set.add(c.content_id);
      }
    });
    data.recommended_contents.forEach((c) => {
      if (c.content_type === "book") {
        set.add(c.content_id);
      }
    });
    return set;
  }, [data.student_contents, data.recommended_contents]);

  useEffect(() => {
    const fetchContentInfos = async () => {
      setLoading(true);
      const infos: ContentInfo[] = [];

      // í•™ìƒ ì½˜í…ì¸  ë°°ì¹˜ ì¡°íšŒ
      if (data.student_contents.length > 0) {
        // ë°°ì¹˜ APIë¡œ ë©”íƒ€ë°ì´í„° ì¡°íšŒ
        const batchRequest = createBatchRequest(
          data.student_contents.map((c) => ({ content_id: c.content_id })),
          bookIdSet,
          true // ë©”íƒ€ë°ì´í„° í¬í•¨
        );

        const requestBody: typeof batchRequest & { student_id?: string } = {
          ...batchRequest,
        };
        if (isCampMode && studentId) {
          requestBody.student_id = studentId;
        }

        let batchMetadataMap = new Map<string, ContentMetadata>();

        try {
          const batchResponse = await fetch("/api/student-content-details/batch", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (batchResponse.ok) {
            const batchResult = await batchResponse.json();
            const batchData = batchResult.data;

            // ë°°ì¹˜ ì‘ë‹µì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
            data.student_contents.forEach((content) => {
              const contentData = batchData[content.content_id];
              if (contentData?.metadata) {
                batchMetadataMap.set(content.content_id, contentData.metadata);
              }
            });
          }
        } catch (error) {
          console.error("[useContentInfos] ë°°ì¹˜ API í˜¸ì¶œ ì‹¤íŒ¨:", error);
        }

        // ê° í•™ìƒ ì½˜í…ì¸  ì²˜ë¦¬
        const studentPromises = data.student_contents.map(async (content) => {
          let title = content.title;
          let subjectCategory = content.subject_category;
          let metadata: ContentMetadata | null = batchMetadataMap.get(content.content_id) || null;

          // ì €ì¥ëœ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì„œë²„ ì•¡ì…˜ìœ¼ë¡œ ì¡°íšŒ
          if (!title || !subjectCategory) {
            try {
              const result = await fetchContentMetadataAction(
                content.content_id,
                content.content_type
              );
              if (result.success && result.data) {
                title = title || result.data.title || "ì•Œ ìˆ˜ ì—†ìŒ";
                subjectCategory = subjectCategory || result.data.subject_category;
                metadata = metadata || result.data;
              }
            } catch (error) {
              const planGroupError = toPlanGroupError(
                error,
                PlanGroupErrorCodes.CONTENT_FETCH_FAILED
              );
              console.error(
                "[useContentInfos] í•™ìƒ ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:",
                planGroupError
              );
            }
          }

          // ì—¬ì „íˆ ì—†ìœ¼ë©´ contentsì—ì„œ ì°¾ê¸°
          if (!title && contents) {
            if (content.content_type === "book") {
              const book = contents.books.find(
                (b) => b.id === content.content_id
              );
              title = book?.title || "ì•Œ ìˆ˜ ì—†ìŒ";
              subjectCategory = subjectCategory || book?.subtitle || undefined;
            } else if (content.content_type === "lecture") {
              const lecture = contents.lectures.find(
                (l) => l.id === content.content_id
              );
              title = lecture?.title || "ì•Œ ìˆ˜ ì—†ìŒ";
              subjectCategory = subjectCategory || lecture?.subtitle || undefined;
            }
          }

          return {
            content_type: content.content_type,
            content_id: content.content_id,
            title: title || "ì•Œ ìˆ˜ ì—†ìŒ",
            subject_category: subjectCategory,
            start_range: content.start_range,
            end_range: content.end_range,
            isRecommended: false,
            subject: metadata?.subject || null,
            semester: metadata?.semester || null,
            revision: metadata?.revision || null,
            difficulty_level: metadata?.difficulty_level || null,
            publisher: metadata?.publisher || null,
            platform: metadata?.platform || null,
          };
        });

        const studentResults = await Promise.all(studentPromises);
        infos.push(...studentResults);
      }

      // ì¶”ì²œ ì½˜í…ì¸  ë³‘ë ¬ ì¡°íšŒ
      if (data.recommended_contents.length > 0) {
        const recommendedPromises = data.recommended_contents.map(
          async (content) => {
            let title = content.title;
            let subjectCategory = content.subject_category;

            // ì €ì¥ëœ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì„œë²„ ì•¡ì…˜ìœ¼ë¡œ ì¡°íšŒ (ë§ˆìŠ¤í„° ì½˜í…ì¸ )
            let metadata: ContentMetadata | null = null;
            if (!title || !subjectCategory) {
              try {
                const result = await fetchContentMetadataAction(
                  content.content_id,
                  content.content_type
                );
                if (result.success && result.data) {
                  title = title || result.data.title || "ì•Œ ìˆ˜ ì—†ìŒ";
                  subjectCategory = subjectCategory || result.data.subject_category;
                  metadata = result.data;
                }
              } catch (error) {
                const planGroupError = toPlanGroupError(
                  error,
                  PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED
                );
                console.error(
                  "[useContentInfos] ë§ˆìŠ¤í„° ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:",
                  planGroupError
                );
              }
            }

            // ë©”íƒ€ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒì„¸ ì •ë³´ APIì—ì„œ ì¡°íšŒ
            if (!metadata) {
              try {
                const response = await fetch(
                  `/api/master-content-details?contentType=${content.content_type}&contentId=${content.content_id}&includeMetadata=true`
                );
                if (response.ok) {
                  const result = await response.json();
                  metadata = result.metadata;
                }
              } catch (error) {
                const planGroupError = toPlanGroupError(
                  error,
                  PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED
                );
                console.error(
                  "[useContentInfos] ë§ˆìŠ¤í„° ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:",
                  planGroupError
                );
              }
            }

            return {
              content_type: content.content_type,
              content_id: content.content_id,
              title: title || "ì•Œ ìˆ˜ ì—†ìŒ",
              subject_category: subjectCategory,
              start_range: content.start_range,
              end_range: content.end_range,
              isRecommended: true,
              // ìë™ ì¶”ì²œ ì •ë³´ (contentì— í¬í•¨ëœ ê²½ìš°)
              is_auto_recommended: content.is_auto_recommended ?? false,
              recommendation_source: content.recommendation_source ?? null,
              recommendation_reason: content.recommendation_reason ?? null,
              recommendation_metadata: content.recommendation_metadata ?? null,
              subject: metadata?.subject || null,
              semester: metadata?.semester || null,
              revision: metadata?.revision || null,
              difficulty_level: metadata?.difficulty_level || null,
              publisher: metadata?.publisher || null,
              platform: metadata?.platform || null,
            };
          }
        );

        const recommendedResults = await Promise.all(recommendedPromises);
        infos.push(...recommendedResults);
      }

      setContentInfos(infos);
      setLoading(false);
    };

    fetchContentInfos();
  }, [data.student_contents, data.recommended_contents, contents, isCampMode, studentId, bookIdSet]);

  return { contentInfos, loading };
}
</file>

<file path="new-group/_components/Step6FinalReview/hooks/useContentTotals.ts">
import { useState, useEffect, useMemo } from "react";
import {
  toPlanGroupError,
  PlanGroupErrorCodes,
} from "@/lib/errors/planGroupErrors";
import { WizardData } from "../../PlanGroupWizard";
import { ContentInfo } from "../types";
import { createBatchRequest, getContentType } from "@/lib/utils/contentDetailsUtils";

type UseContentTotalsProps = {
  data: WizardData;
  contentInfos: ContentInfo[];
  isCampMode?: boolean;
  studentId?: string;
};

export function useContentTotals({
  data,
  contentInfos,
  isCampMode = false,
  studentId,
}: UseContentTotalsProps) {
  const [contentTotals, setContentTotals] = useState<Map<string, number>>(
    new Map()
  );
  const [loadingContentTotals, setLoadingContentTotals] = useState(false);

  // contentKey ë§¤í•‘ ìƒì„± (ë©”ëª¨ì´ì œì´ì…˜)
  const contentKeyMap = useMemo(() => {
    const map = new Map<string, string>();
    data.student_contents.forEach((c, idx) => {
      map.set(c.content_id, `student-${idx}`);
    });
    data.recommended_contents.forEach((c, idx) => {
      map.set(c.content_id, `recommended-${idx}`);
    });
    return map;
  }, [data.student_contents, data.recommended_contents]);

  // bookIdSet ìƒì„± (ì½˜í…ì¸  íƒ€ì… í™•ì¸ìš©)
  const bookIdSet = useMemo(() => {
    const set = new Set<string>();
    data.student_contents.forEach((c) => {
      if (c.content_type === "book") {
        set.add(c.content_id);
      }
    });
    data.recommended_contents.forEach((c) => {
      if (c.content_type === "book") {
        set.add(c.content_id);
      }
    });
    return set;
  }, [data.student_contents, data.recommended_contents]);

  useEffect(() => {
    const fetchContentTotals = async () => {
      setLoadingContentTotals(true);
      const newTotals = new Map<string, number>();

      // ì´ë¯¸ ì¡°íšŒí•œ ì½˜í…ì¸ ëŠ” ì œì™¸
      const contentInfosToFetch = contentInfos.filter((info) => {
        const contentKey = contentKeyMap.get(info.content_id);
        return contentKey && !contentTotals.has(contentKey);
      });

      if (contentInfosToFetch.length === 0) {
        setLoadingContentTotals(false);
        return;
      }

      // í•™ìƒ ì½˜í…ì¸ ì™€ ì¶”ì²œ ì½˜í…ì¸  ë¶„ë¦¬
      const studentContents = contentInfosToFetch.filter(
        (info) => !info.isRecommended
      );
      const recommendedContents = contentInfosToFetch.filter(
        (info) => info.isRecommended
      );

      try {
        // í•™ìƒ ì½˜í…ì¸ ëŠ” ë°°ì¹˜ APIë¡œ ì¡°íšŒ
        if (studentContents.length > 0) {
          const batchRequest = createBatchRequest(
            studentContents.map((info) => ({ content_id: info.content_id })),
            bookIdSet,
            false // ë©”íƒ€ë°ì´í„° ë¶ˆí•„ìš”
          );

          const requestBody: typeof batchRequest & { student_id?: string } = {
            ...batchRequest,
          };
          if (isCampMode && studentId) {
            requestBody.student_id = studentId;
          }

          const batchResponse = await fetch("/api/student-content-details/batch", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (batchResponse.ok) {
            const batchResult = await batchResponse.json();
            const batchData = batchResult.data;

            studentContents.forEach((contentInfo) => {
              const contentKey = contentKeyMap.get(contentInfo.content_id);
              if (!contentKey) return;

              const contentData = batchData[contentInfo.content_id];
              if (contentData) {
                const total =
                  contentInfo.content_type === "book"
                    ? contentData.total_pages
                    : contentData.total_episodes;

                // ì´ëŸ‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìƒì„¸ ì •ë³´ì—ì„œ ìµœëŒ€ê°’ ì¶”ì •
                if (!total) {
                  if (contentInfo.content_type === "book" && contentData.details) {
                    const details = contentData.details || [];
                    if (details.length > 0) {
                      const maxPage = Math.max(
                        ...details.map((d: { page_number?: number }) => d.page_number || 0)
                      );
                      if (maxPage > 0) {
                        newTotals.set(contentKey, maxPage);
                      }
                    }
                  } else if (contentInfo.content_type === "lecture" && contentData.episodes) {
                    const episodes = contentData.episodes || [];
                    if (episodes.length > 0) {
                      const maxEpisode = Math.max(
                        ...episodes.map((e: { episode_number?: number }) => e.episode_number || 0)
                      );
                      if (maxEpisode > 0) {
                        newTotals.set(contentKey, maxEpisode);
                      }
                    }
                  }
                } else if (total > 0) {
                  newTotals.set(contentKey, total);
                }
              }
            });
          }
        }

        // ì¶”ì²œ ì½˜í…ì¸ ëŠ” ë³‘ë ¬ë¡œ ê°œë³„ API í˜¸ì¶œ (ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” ë°°ì¹˜ API ì—†ìŒ)
        if (recommendedContents.length > 0) {
          const recommendedPromises = recommendedContents.map(
            async (contentInfo) => {
              const contentKey = contentKeyMap.get(contentInfo.content_id);
              if (!contentKey) return null;

              try {
                const apiPath = `/api/master-content-info?content_type=${contentInfo.content_type}&content_id=${contentInfo.content_id}`;
                const response = await fetch(apiPath);
                if (response.ok) {
                  const info = await response.json();
                  const total =
                    contentInfo.content_type === "book"
                      ? info.total_pages
                      : info.total_episodes;

                  // ì´ëŸ‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìƒì„¸ ì •ë³´ì—ì„œ ìµœëŒ€ê°’ ì¶”ì •
                  if (!total) {
                    const detailsApiPath = `/api/master-content-details?contentType=${contentInfo.content_type}&contentId=${contentInfo.content_id}`;
                    try {
                      const detailsResponse = await fetch(detailsApiPath);
                      if (detailsResponse.ok) {
                        const detailsResult = await detailsResponse.json();
                        if (contentInfo.content_type === "book") {
                          const details = detailsResult.details || [];
                          if (details.length > 0) {
                            const maxPage = Math.max(
                              ...details.map((d: { page_number?: number }) => d.page_number || 0)
                            );
                            if (maxPage > 0) {
                              return { contentKey, total: maxPage };
                            }
                          }
                        } else {
                          const episodes = detailsResult.episodes || [];
                          if (episodes.length > 0) {
                            const maxEpisode = Math.max(
                              ...episodes.map((e: { episode_number?: number }) => e.episode_number || 0)
                            );
                            if (maxEpisode > 0) {
                              return { contentKey, total: maxEpisode };
                            }
                          }
                        }
                      }
                    } catch (detailsError) {
                      const planGroupError = toPlanGroupError(
                        detailsError,
                        PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED,
                        { contentId: contentInfo.content_id }
                      );
                      console.error(
                        `[useContentTotals] ì¶”ì²œ ì½˜í…ì¸  ${contentInfo.content_id} ìƒì„¸ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (ì´ëŸ‰ ì¶”ì •ìš©):`,
                        planGroupError
                      );
                    }
                  } else if (total > 0) {
                    return { contentKey, total };
                  }
                }
              } catch (error) {
                const planGroupError = toPlanGroupError(
                  error,
                  PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED,
                  { contentId: contentInfo.content_id }
                );
                console.error(
                  `[useContentTotals] ì¶”ì²œ ì½˜í…ì¸  ${contentInfo.content_id} ì´ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:`,
                  planGroupError
                );
              }
              return null;
            }
          );

          const recommendedResults = await Promise.all(recommendedPromises);
          recommendedResults.forEach((result) => {
            if (result) {
              newTotals.set(result.contentKey, result.total);
            }
          });
        }
      } catch (error) {
        const planGroupError = toPlanGroupError(
          error,
          PlanGroupErrorCodes.CONTENT_METADATA_FETCH_FAILED
        );
        console.error("[useContentTotals] ì´ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:", planGroupError);
      }

      if (newTotals.size > 0) {
        setContentTotals((prev) => new Map([...prev, ...newTotals]));
      }
      setLoadingContentTotals(false);
    };

    if (contentInfos.length > 0) {
      fetchContentTotals();
    }
  }, [
    contentInfos,
    contentKeyMap,
    bookIdSet,
    contentTotals,
    isCampMode,
    studentId,
  ]);

  return { contentTotals, loadingContentTotals };
}
</file>

<file path="new-group/_components/Step6FinalReview/hooks/useInitialRanges.ts">
import { useState, useEffect } from "react";
import { WizardData } from "../../PlanGroupWizard";
import { ContentInfo } from "../types";

type UseInitialRangesProps = {
  contentInfos: ContentInfo[];
  data: WizardData;
};

export function useInitialRanges({ contentInfos, data }: UseInitialRangesProps) {
  const [initialRanges, setInitialRanges] = useState<
    Map<string, { start: number; end: number }>
  >(new Map());

  // ì´ˆê¸° ë²”ìœ„ ì €ì¥ (ë³€ê²½ ì—¬ë¶€ í™•ì¸ìš©)
  useEffect(() => {
    if (contentInfos.length === 0) return;

    // contentKey ë§¤í•‘ ìƒì„± (ìµœì í™”)
    const contentKeyMap = new Map<string, string>();
    const contentMap = new Map<
      string,
      | (typeof data.student_contents)[0]
      | (typeof data.recommended_contents)[0]
    >();

    data.student_contents.forEach((c, idx) => {
      const key = `student-${idx}`;
      contentKeyMap.set(c.content_id, key);
      contentMap.set(key, c);
    });
    data.recommended_contents.forEach((c, idx) => {
      const key = `recommended-${idx}`;
      contentKeyMap.set(c.content_id, key);
      contentMap.set(key, c);
    });

    setInitialRanges((prev) => {
      // ì´ë¯¸ ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ìœ ì§€
      if (prev.size > 0 && prev.size === contentInfos.length) return prev;

      const newMap = new Map(prev);
      contentInfos.forEach((info) => {
        const contentKey = contentKeyMap.get(info.content_id);
        if (!contentKey) return;
        if (newMap.has(contentKey)) return;

        const content = contentMap.get(contentKey);
        if (content) {
          newMap.set(contentKey, {
            start: content.start_range,
            end: content.end_range,
          });
        }
      });
      return newMap;
    });
  }, [contentInfos, data.student_contents, data.recommended_contents]);

  return initialRanges;
}
</file>

<file path="new-group/_components/Step6FinalReview/hooks/useRecommendedRanges.ts">
import { useState, useEffect, useCallback } from "react";
import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";
import { WizardData } from "../../PlanGroupWizard";
import { ContentInfo } from "../types";

type UseRecommendedRangesProps = {
  data: WizardData;
  contentInfos: ContentInfo[];
  contentTotals: Map<string, number>;
};

export function useRecommendedRanges({
  data,
  contentInfos,
  contentTotals,
}: UseRecommendedRangesProps) {
  const [recommendedRanges, setRecommendedRanges] = useState<
    Map<string, { start: number; end: number; reason: string }>
  >(new Map());
  const [rangeUnavailableReasons, setRangeUnavailableReasons] = useState<
    Map<string, string>
  >(new Map());

  // ì¶”ì²œ ë²”ìœ„ê°€ ì—†ëŠ” ì´ìœ ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
  const getUnavailableReason = useCallback(
    (
      contentKey: string,
      hasScheduleSummary: boolean,
      scheduleSummary: typeof data.schedule_summary,
      totalAmount: number | undefined
    ): string | null => {
      if (!hasScheduleSummary || !scheduleSummary) {
        return "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ";
      }

      const { total_study_days, total_study_hours } = scheduleSummary;
      if (total_study_days === 0 || total_study_hours === 0) {
        return "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ";
      }

      if (totalAmount === undefined) {
        return "ì´ëŸ‰ ì •ë³´ ì—†ìŒ";
      }

      if (totalAmount <= 0) {
        return "ì´ëŸ‰ ì •ë³´ ì˜¤ë¥˜";
      }

      return null;
    },
    []
  );

  useEffect(() => {
    const calculateRecommendedRanges = () => {
      if (!data.schedule_summary || contentInfos.length === 0) {
        setRecommendedRanges(new Map());
        setRangeUnavailableReasons(new Map());
        return;
      }

      const { total_study_days, total_study_hours } = data.schedule_summary;
      if (total_study_days === 0 || total_study_hours === 0) {
        // ëª¨ë“  ì½˜í…ì¸ ì— ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ í‘œì‹œ
        const reasons = new Map<string, string>();
        // contentKey ë§¤í•‘ ìƒì„± (ìµœì í™”)
        const contentKeyMap = new Map<string, string>();
        data.student_contents.forEach((c, idx) => {
          contentKeyMap.set(c.content_id, `student-${idx}`);
        });
        data.recommended_contents.forEach((c, idx) => {
          contentKeyMap.set(c.content_id, `recommended-${idx}`);
        });

        contentInfos.forEach((contentInfo) => {
          const contentKey = contentKeyMap.get(contentInfo.content_id);
          if (contentKey) {
            reasons.set(contentKey, "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ");
          }
        });
        setRecommendedRanges(new Map());
        setRangeUnavailableReasons(reasons);
        return;
      }

      // ì „ì²´ ì½˜í…ì¸  ê°œìˆ˜
      const totalContents = contentInfos.length;

      // ì¼ì¼ í‰ê·  í•™ìŠµ ì‹œê°„ ê³„ì‚°
      const avgDailyHours = total_study_hours / total_study_days;

      // ê° ì½˜í…ì¸ ì— í• ë‹¹í•  ì¼ì¼ í•™ìŠµëŸ‰ ê³„ì‚°
      // ì˜ˆ: 9ê°œ ì½˜í…ì¸ , í•˜ë£¨ 3ì‹œê°„ â†’ ê° ì½˜í…ì¸ ë‹¹ ì•½ 20ë¶„
      const hoursPerContentPerDay = avgDailyHours / totalContents;

      const newRanges = new Map<
        string,
        { start: number; end: number; reason: string }
      >();
      const newReasons = new Map<string, string>();

      // contentKey ë§¤í•‘ì„ ë¯¸ë¦¬ ìƒì„± (findIndex ë°˜ë³µ í˜¸ì¶œ ìµœì í™”)
      const contentKeyMap = new Map<string, string>();
      data.student_contents.forEach((c, idx) => {
        contentKeyMap.set(c.content_id, `student-${idx}`);
      });
      data.recommended_contents.forEach((c, idx) => {
        contentKeyMap.set(c.content_id, `recommended-${idx}`);
      });

      // ê° ì½˜í…ì¸ ë³„ ì¶”ì²œ ë²”ìœ„ ê³„ì‚°
      for (const contentInfo of contentInfos) {
        const contentKey = contentKeyMap.get(contentInfo.content_id);
        if (!contentKey) continue;

        const totalAmount = contentTotals.get(contentKey);
        const unavailableReason = getUnavailableReason(
          contentKey,
          true,
          data.schedule_summary,
          totalAmount
        );

        if (unavailableReason) {
          newReasons.set(contentKey, unavailableReason);
          continue;
        }

        if (!totalAmount || totalAmount <= 0) {
          newReasons.set(contentKey, "ì´ëŸ‰ ì •ë³´ ì˜¤ë¥˜");
          continue;
        }

        if (contentInfo.content_type === "book") {
          // êµì¬: ì¼ì¼ í•™ìŠµëŸ‰ì„ í˜ì´ì§€ë¡œ í™˜ì‚°
          const pagesPerHour = defaultRangeRecommendationConfig.pagesPerHour;
          const dailyPages = Math.round(hoursPerContentPerDay * pagesPerHour);
          const recommendedEnd = Math.min(
            dailyPages * total_study_days,
            totalAmount
          );

          newRanges.set(contentKey, {
            start: 1,
            end: recommendedEnd,
            reason: `${totalContents}ê°œ ì½˜í…ì¸  ë¶„ë°°, ì¼ì¼ ${dailyPages}í˜ì´ì§€ Ã— ${total_study_days}ì¼`,
          });
        } else {
          // ê°•ì˜: ì¼ì¼ í•™ìŠµëŸ‰ì„ íšŒì°¨ë¡œ í™˜ì‚°
          const episodesPerHour = defaultRangeRecommendationConfig.episodesPerHour;
          const dailyEpisodes = Math.round(
            hoursPerContentPerDay * episodesPerHour
          );
          const recommendedEnd = Math.min(
            dailyEpisodes * total_study_days,
            totalAmount
          );

          newRanges.set(contentKey, {
            start: 1,
            end: recommendedEnd,
            reason: `${totalContents}ê°œ ì½˜í…ì¸  ë¶„ë°°, ì¼ì¼ ${dailyEpisodes}íšŒì°¨ Ã— ${total_study_days}ì¼`,
          });
        }
      }

      setRecommendedRanges(newRanges);
      setRangeUnavailableReasons(newReasons);
    };

    calculateRecommendedRanges();
  }, [
    data.schedule_summary,
    contentInfos,
    contentTotals,
    data.student_contents,
    data.recommended_contents,
    getUnavailableReason,
  ]);

  return { recommendedRanges, rangeUnavailableReasons };
}
</file>

<file path="new-group/_components/Step6FinalReview/ComparisonTable.tsx">
import { WizardData } from "../PlanGroupWizard";
import { ContentInfo } from "./types";

type ComparisonTableProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  contentInfos: ContentInfo[];
  recommendedRanges: Map<
    string,
    { start: number; end: number; reason: string }
  >;
};

export function ComparisonTable({
  data,
  onUpdate,
  contentInfos,
  recommendedRanges,
}: ComparisonTableProps) {
  if (recommendedRanges.size === 0) return null;

  return (
    <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
      <div className="flex items-center justify-between">
        <h3 className="text-sm font-semibold text-gray-900">í•™ìŠµ ë²”ìœ„ ë¹„êµ</h3>
        <div className="flex gap-2">
          <button
            type="button"
            onClick={() => {
              // ê³¼ëª©ë³„ ì ìš©ì„ ìœ„í•œ ê³¼ëª© ëª©ë¡ ì¶”ì¶œ
              const subjects = Array.from(
                new Set(
                  contentInfos
                    .map((c) => c.subject_category)
                    .filter((s): s is string => !!s)
                )
              );
              if (subjects.length === 0) {
                alert("ê³¼ëª©ë³„ ì ìš©í•  ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
              }
              const selectedSubject = prompt(
                `ì ìš©í•  ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”:\n${subjects
                  .map((s, i) => `${i + 1}. ${s}`)
                  .join("\n")}\n\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`
              );
              if (!selectedSubject) return;
              const subjectIndex = parseInt(selectedSubject) - 1;
              if (
                isNaN(subjectIndex) ||
                subjectIndex < 0 ||
                subjectIndex >= subjects.length
              ) {
                alert("ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
              }
              const targetSubject = subjects[subjectIndex];

              // í•´ë‹¹ ê³¼ëª©ì˜ ì½˜í…ì¸ ë§Œ ì¶”ì²œ ë²”ìœ„ ì ìš©
              const updatedStudent = [...data.student_contents];
              const updatedRecommended = [...data.recommended_contents];

              // contentKey ë§¤í•‘ ìƒì„± (ìµœì í™”)
              const contentKeyMap = new Map<
                string,
                { type: "student" | "recommended"; index: number }
              >();
              data.student_contents.forEach((c, idx) => {
                contentKeyMap.set(c.content_id, {
                  type: "student",
                  index: idx,
                });
              });
              data.recommended_contents.forEach((c, idx) => {
                contentKeyMap.set(c.content_id, {
                  type: "recommended",
                  index: idx,
                });
              });

              contentInfos.forEach((info) => {
                if (info.subject_category !== targetSubject) return;

                const mapping = contentKeyMap.get(info.content_id);
                if (!mapping) return;

                const contentKey = `${mapping.type}-${mapping.index}`;
                const recommended = recommendedRanges.get(contentKey);
                if (!recommended) return;

                if (mapping.type === "recommended") {
                  updatedRecommended[mapping.index] = {
                    ...updatedRecommended[mapping.index],
                    start_range: recommended.start,
                    end_range: recommended.end,
                  };
                } else {
                  updatedStudent[mapping.index] = {
                    ...updatedStudent[mapping.index],
                    start_range: recommended.start,
                    end_range: recommended.end,
                  };
                }
              });

              onUpdate({
                student_contents: updatedStudent,
                recommended_contents: updatedRecommended,
              });
            }}
            className="rounded bg-green-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-green-700"
          >
            ê³¼ëª©ë³„ ì ìš©
          </button>
          <button
            type="button"
            onClick={() => {
              // ì „ì²´ ì¶”ì²œ ë²”ìœ„ ì¼ê´„ ì ìš©
              const updatedStudent = [...data.student_contents];
              const updatedRecommended = [...data.recommended_contents];

              // contentKey ë§¤í•‘ ìƒì„± (ìµœì í™”)
              const contentKeyMap = new Map<
                string,
                { type: "student" | "recommended"; index: number }
              >();
              data.student_contents.forEach((c, idx) => {
                contentKeyMap.set(c.content_id, {
                  type: "student",
                  index: idx,
                });
              });
              data.recommended_contents.forEach((c, idx) => {
                contentKeyMap.set(c.content_id, {
                  type: "recommended",
                  index: idx,
                });
              });

              contentInfos.forEach((info) => {
                const mapping = contentKeyMap.get(info.content_id);
                if (!mapping) return;

                const contentKey = `${mapping.type}-${mapping.index}`;
                const recommended = recommendedRanges.get(contentKey);
                if (!recommended) return;

                if (mapping.type === "recommended") {
                  updatedRecommended[mapping.index] = {
                    ...updatedRecommended[mapping.index],
                    start_range: recommended.start,
                    end_range: recommended.end,
                  };
                } else {
                  updatedStudent[mapping.index] = {
                    ...updatedStudent[mapping.index],
                    start_range: recommended.start,
                    end_range: recommended.end,
                  };
                }
              });

              onUpdate({
                student_contents: updatedStudent,
                recommended_contents: updatedRecommended,
              });
            }}
            className="rounded bg-blue-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-blue-700"
          >
            ì „ì²´ ì ìš©
          </button>
        </div>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-xs">
          <thead>
            <tr className="border-b border-gray-200">
              <th className="px-3 py-2 text-left font-medium text-gray-800">
                ì½˜í…ì¸ 
              </th>
              <th className="px-3 py-2 text-center font-medium text-gray-800">
                í•™ìƒ ì§€ì •
              </th>
              <th className="px-3 py-2 text-center font-medium text-gray-800">
                ì¶”ì²œ ë²”ìœ„
              </th>
              <th className="px-3 py-2 text-center font-medium text-gray-800">
                ì°¨ì´
              </th>
              <th className="px-3 py-2 text-center font-medium text-gray-800">
                ì ìš©
              </th>
            </tr>
          </thead>
          <tbody>
            {(() => {
              // contentKeyì™€ content ë§¤í•‘ì„ ë¯¸ë¦¬ ìƒì„± (ìµœì í™”)
              const contentKeyMap = new Map<string, string>();
              const contentMap = new Map<
                string,
                | (typeof data.student_contents)[0]
                | (typeof data.recommended_contents)[0]
              >();

              data.student_contents.forEach((c, idx) => {
                const key = `student-${idx}`;
                const mapKey = `${c.content_id}:student`;
                contentKeyMap.set(mapKey, key);
                contentMap.set(key, c);
              });

              data.recommended_contents.forEach((c, idx) => {
                const key = `recommended-${idx}`;
                const mapKey = `${c.content_id}:recommended`;
                contentKeyMap.set(mapKey, key);
                contentMap.set(key, c);
              });

              return contentInfos.map((info, idx) => {
                const mapKey = `${info.content_id}:${
                  info.isRecommended ? "recommended" : "student"
                }`;
                const contentKey = contentKeyMap.get(mapKey);
                if (!contentKey) return null;

                const content = contentMap.get(contentKey);
                if (!content) return null;

                const recommended = recommendedRanges.get(contentKey);
                const studentRange = content.end_range - content.start_range + 1;
                const recommendedRange = recommended
                  ? recommended.end - recommended.start + 1
                  : null;
                const difference =
                  recommendedRange !== null
                    ? studentRange - recommendedRange
                    : null;
                const isOver = difference !== null && difference > 0;
                const isUnder = difference !== null && difference < 0;

                const uniqueKey = `${contentKey}-${idx}`;

                return (
                  <tr key={uniqueKey} className="border-b border-gray-100">
                    <td className="px-3 py-2">
                      <div className="flex items-center gap-2">
                        <div className="flex flex-col gap-1">
                          <div className="flex items-center gap-2">
                            <div className="font-medium text-gray-900">
                              {info.title}
                            </div>
                            {info.isRecommended ? (
                              <>
                                {info.is_auto_recommended ? (
                                  <span
                                    className="rounded-full bg-purple-100 px-1.5 py-0.5 text-xs font-medium text-purple-800"
                                    title={
                                      info.recommendation_reason ||
                                      "ìë™ ì¶”ì²œëœ ì½˜í…ì¸ "
                                    }
                                  >
                                    ğŸ¤– ìë™ ì¶”ì²œ
                                  </span>
                                ) : (
                                  <span className="rounded-full bg-green-100 px-1.5 py-0.5 text-xs font-medium text-green-800">
                                    ì¶”ì²œ ì½˜í…ì¸ 
                                  </span>
                                )}
                              </>
                            ) : (
                              <span className="rounded-full bg-blue-100 px-1.5 py-0.5 text-xs font-medium text-blue-800">
                                í•™ìƒ ì½˜í…ì¸ 
                              </span>
                            )}
                          </div>
                          {info.is_auto_recommended &&
                            info.recommendation_reason && (
                              <div className="text-xs text-purple-600">
                                ğŸ’¡ {info.recommendation_reason}
                              </div>
                            )}
                          <div className="flex flex-wrap items-center gap-2 text-xs text-gray-600">
                            {info.content_type === "book" && (
                              <span className="rounded bg-blue-100 px-1.5 py-0.5 text-blue-800">
                                ğŸ“š êµì¬
                              </span>
                            )}
                            {info.content_type === "lecture" && (
                              <span className="rounded bg-purple-100 px-1.5 py-0.5 text-purple-800">
                                ğŸ§ ê°•ì˜
                              </span>
                            )}
                            {info.subject && (
                              <>
                                <span>Â·</span>
                                <span>{info.subject}</span>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td className="px-3 py-2 text-center text-gray-900">
                      <div>{studentRange}</div>
                      <div className="text-[10px] text-gray-500">
                        ({content.start_range} ~ {content.end_range})
                      </div>
                    </td>
                    <td className="px-3 py-2 text-center text-gray-900">
                      {recommended ? (
                        <>
                          <div>{recommendedRange}</div>
                          <div className="text-[10px] text-gray-500">
                            ({recommended.start} ~ {recommended.end})
                          </div>
                        </>
                      ) : (
                        <span className="text-gray-400">-</span>
                      )}
                    </td>
                    <td className="px-3 py-2 text-center">
                      {difference !== null && difference !== 0 ? (
                        <span
                          className={
                            isOver
                              ? "text-red-600"
                              : isUnder
                              ? "text-green-600"
                              : "text-gray-600"
                          }
                        >
                          {difference > 0 ? "+" : ""}
                          {difference}
                        </span>
                      ) : (
                        <span className="text-gray-400">-</span>
                      )}
                    </td>
                    <td className="px-3 py-2 text-center">
                      {recommended ? (
                        <button
                          type="button"
                          onClick={() => {
                            // ê°œë³„ ì ìš©
                            if (info.isRecommended) {
                              const updated = [...data.recommended_contents];
                              const idx = data.recommended_contents.findIndex(
                                (c) => c.content_id === info.content_id
                              );
                              if (idx !== -1) {
                                updated[idx] = {
                                  ...updated[idx],
                                  start_range: recommended.start,
                                  end_range: recommended.end,
                                };
                                onUpdate({ recommended_contents: updated });
                              }
                            } else {
                              const updated = [...data.student_contents];
                              const idx = data.student_contents.findIndex(
                                (c) => c.content_id === info.content_id
                              );
                              if (idx !== -1) {
                                updated[idx] = {
                                  ...updated[idx],
                                  start_range: recommended.start,
                                  end_range: recommended.end,
                                };
                                onUpdate({ student_contents: updated });
                              }
                            }
                          }}
                          className="rounded bg-blue-600 px-2 py-1 text-xs font-medium text-white hover:bg-blue-700"
                        >
                          ì ìš©
                        </button>
                      ) : (
                        <span className="text-xs text-gray-600">-</span>
                      )}
                    </td>
                  </tr>
                );
              });
            })()}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step6FinalReview/ContentAllocationUI.tsx">
import { WizardData } from "../PlanGroupWizard";
import { ContentInfo } from "./types";
import { getEffectiveAllocation } from "@/lib/utils/subjectAllocation";

type ContentAllocationUIProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  contentInfos: ContentInfo[];
};

export function ContentAllocationUI({
  data,
  onUpdate,
  contentInfos,
}: ContentAllocationUIProps) {
  // êµê³¼ë³„ë¡œ ì½˜í…ì¸  ê·¸ë£¹í™”
  const contentsBySubject = new Map<string, typeof contentInfos>();
  contentInfos.forEach((content) => {
    if (content.subject_category) {
      if (!contentsBySubject.has(content.subject_category)) {
        contentsBySubject.set(content.subject_category, []);
      }
      contentsBySubject.get(content.subject_category)!.push(content);
    }
  });

  const subjects = Array.from(contentsBySubject.keys()).sort();

  if (subjects.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">ì½˜í…ì¸ ì˜ ê³¼ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  const handleContentAllocationChange = (
    content: { content_type: string; content_id: string },
    allocation: {
      subject_type: "strategy" | "weakness";
      weekly_days?: number;
    }
  ) => {
    const currentAllocations = data.content_allocations || [];
    const updatedAllocations = currentAllocations.filter(
      (a) =>
        !(
          a.content_type === content.content_type &&
          a.content_id === content.content_id
        )
    );
    updatedAllocations.push({
      content_type: content.content_type as "book" | "lecture",
      content_id: content.content_id,
      subject_type: allocation.subject_type,
      weekly_days: allocation.weekly_days,
    });
    onUpdate({ content_allocations: updatedAllocations });
  };

  // í´ë°± ë©”ì»¤ë‹ˆì¦˜: ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì‚¬ìš©
  const getEffectiveAllocationForContent = (content: (typeof contentInfos)[0]) => {
    return getEffectiveAllocation(
      {
        content_type: content.content_type,
        content_id: content.content_id,
        subject_category: content.subject_category || undefined,
        subject: null,
        subject_id: undefined,
      },
      data.content_allocations?.map((a) => ({
        content_type: a.content_type as "book" | "lecture" | "custom",
        content_id: a.content_id,
        subject_type: a.subject_type,
        weekly_days: a.weekly_days,
      })),
      data.subject_allocations?.map((a) => ({
        subject_id: a.subject_id,
        subject_name: a.subject_name,
        subject_type: a.subject_type,
        weekly_days: a.weekly_days,
      })),
      false // UIì—ì„œëŠ” ë¡œê¹… ë¹„í™œì„±í™”
    );
  };

  return (
    <div className="flex flex-col gap-6">
      {subjects.map((subject) => {
        const contents = contentsBySubject.get(subject) || [];

        return (
          <div
            key={subject}
            className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4"
          >
            <h3 className="text-sm font-semibold text-gray-900">
              {subject}
            </h3>
            <div className="flex flex-col gap-3">
              {contents.map((content) => {
                const effectiveAlloc = getEffectiveAllocationForContent(content);
                const subjectType = effectiveAlloc.subject_type;
                const weeklyDays = effectiveAlloc.weekly_days || 3;
                const source = effectiveAlloc.source;

                return (
                  <div
                    key={`${content.content_type}-${content.content_id}`}
                    className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex flex-col gap-1 flex-1">
                        <div className="text-sm font-medium text-gray-900">
                          {content.content_type === "book" ? "ğŸ“š" : "ğŸ§"}{" "}
                          {content.title}
                        </div>
                        {source !== "content" && (
                          <div className="text-xs text-gray-600">
                            {source === "subject" && "êµê³¼ë³„ ì„¤ì • ì ìš© ì¤‘"}
                            {source === "default" && "ê¸°ë³¸ê°’ (ì·¨ì•½ê³¼ëª©)"}
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="flex flex-col gap-2">
                      <div className="flex gap-2">
                        <label className="flex flex-1 cursor-pointer items-center gap-2 rounded border p-2 text-xs transition-colors hover:bg-gray-100">
                          <input
                            type="radio"
                            name={`content_type_${content.content_type}_${content.content_id}`}
                            value="weakness"
                            checked={subjectType === "weakness"}
                            onChange={() => {
                              handleContentAllocationChange(content, {
                                subject_type: "weakness",
                              });
                            }}
                            className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <span className="text-gray-900">ì·¨ì•½ê³¼ëª©</span>
                        </label>
                        <label className="flex flex-1 cursor-pointer items-center gap-2 rounded border p-2 text-xs transition-colors hover:bg-gray-100">
                          <input
                            type="radio"
                            name={`content_type_${content.content_type}_${content.content_id}`}
                            value="strategy"
                            checked={subjectType === "strategy"}
                            onChange={() => {
                              handleContentAllocationChange(content, {
                                subject_type: "strategy",
                                weekly_days: 3,
                              });
                            }}
                            className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <span className="text-gray-900">ì „ëµê³¼ëª©</span>
                        </label>
                      </div>

                      {subjectType === "strategy" && (
                        <div>
                          <select
                            className="w-full rounded border border-gray-300 px-2 py-1 text-xs focus:border-gray-900 focus:outline-none"
                            value={weeklyDays}
                            onChange={(e) => {
                              handleContentAllocationChange(content, {
                                subject_type: "strategy",
                                weekly_days: Number(e.target.value),
                              });
                            }}
                          >
                            <option value="2">ì£¼ 2ì¼</option>
                            <option value="3">ì£¼ 3ì¼</option>
                            <option value="4">ì£¼ 4ì¼</option>
                          </select>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      })}

      {/* ì„¤ì • ìš”ì•½ */}
      <div className="flex flex-col gap-2 rounded-lg border border-blue-200 bg-blue-50 p-3">
        <h4 className="text-xs font-semibold text-blue-800">ì„¤ì • ìš”ì•½</h4>
        <div className="flex flex-col gap-1 text-xs text-blue-800">
          <p>â€¢ ì½˜í…ì¸ ë³„ ì„¤ì •: {(data.content_allocations || []).length}ê°œ</p>
          <p>
            â€¢ êµê³¼ë³„ ì„¤ì • (í´ë°±): {(data.subject_allocations || []).length}ê°œ
          </p>
          <p className="text-blue-800">
            ì½˜í…ì¸ ë³„ ì„¤ì •ì´ ìš°ì„  ì ìš©ë˜ë©°, ì„¤ì •ë˜ì§€ ì•Šì€ ì½˜í…ì¸ ëŠ” êµê³¼ë³„ ì„¤ì •ì„
            ë”°ë¦…ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step6FinalReview/ContentList.tsx">
import { WizardData } from "../PlanGroupWizard";
import { ContentInfo, BookDetail, LectureEpisode } from "./types";

type ContentListProps = {
  type: "student" | "recommended";
  contents: WizardData["student_contents"] | WizardData["recommended_contents"];
  contentInfos: ContentInfo[];
  recommendedRanges: Map<
    string,
    { start: number; end: number; reason: string }
  >;
  rangeUnavailableReasons: Map<string, string>;
  editingRangeIndex: { type: "student" | "recommended"; index: number } | null;
  editingRange: { start: string; end: string } | null;
  contentDetails: Map<
    string,
    { details: BookDetail[] | LectureEpisode[]; type: "book" | "lecture" }
  >;
  loadingDetails: Set<string>;
  startDetailId: Map<string, string>;
  endDetailId: Map<string, string>;
  onUpdateContents: (
    newContents:
      | WizardData["student_contents"]
      | WizardData["recommended_contents"]
  ) => void;
  // editing callbacks
  setEditingRangeIndex: (
    value: { type: "student" | "recommended"; index: number } | null
  ) => void;
  setEditingRange: (value: { start: string; end: string } | null) => void;
  setStartRange: (detailId: string) => void;
  setEndRange: (detailId: string) => void;
};

export function ContentList({
  type,
  contents,
  contentInfos,
  recommendedRanges,
  rangeUnavailableReasons,
  editingRangeIndex,
  editingRange,
  contentDetails,
  loadingDetails,
  startDetailId,
  endDetailId,
  onUpdateContents,
  setEditingRangeIndex,
  setEditingRange,
  setStartRange,
  setEndRange,
}: ContentListProps) {
  if (contents.length === 0) return null;

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <h3 className="text-lg font-semibold text-gray-900">
          {type === "student" ? "ì¶”ê°€í•œ í•™ìƒ ì½˜í…ì¸ " : "ì¶”ì²œ ì½˜í…ì¸ "}
        </h3>
        <span
          className={`rounded-full px-3 py-1 text-sm font-medium ${
            type === "student"
              ? "bg-blue-100 text-blue-800"
              : "bg-green-100 text-green-800"
          }`}
        >
          {contents.length}ê°œ
        </span>
      </div>
      <div className="space-y-2">
        {contents.map((content, index) => {
          const info = contentInfos.find(
            (c) =>
              c.content_id === content.content_id &&
              c.isRecommended === (type === "recommended")
          );
          if (!info) return null;

          const isEditing =
            editingRangeIndex?.type === type &&
            editingRangeIndex.index === index;
          const contentKey = `${type}-${index}`;

          return (
            <div
              key={index}
              className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3"
            >
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <div className="text-sm font-medium text-gray-900">
                    {info.title}
                  </div>
                  <span
                    className={`rounded-full px-2 py-0.5 text-xs font-medium ${
                      type === "student"
                        ? "bg-blue-100 text-blue-800"
                        : "bg-green-100 text-green-800"
                    }`}
                  >
                    {type === "student" ? "í•™ìƒ ì½˜í…ì¸ " : "ì¶”ì²œ ì½˜í…ì¸ "}
                  </span>
                </div>
                <div className="flex flex-wrap items-center gap-2 text-xs text-gray-600">
                  {content.content_type === "book" && (
                    <span className="rounded bg-blue-100 px-1.5 py-0.5 text-blue-800">
                      ğŸ“š êµì¬
                    </span>
                  )}
                  {content.content_type === "lecture" && (
                    <span className="rounded bg-purple-100 px-1.5 py-0.5 text-purple-800">
                      ğŸ§ ê°•ì˜
                    </span>
                  )}
                  {info.subject && (
                    <>
                      <span>Â·</span>
                      <span>{info.subject}</span>
                    </>
                  )}
                  {info.semester && (
                    <>
                      <span>Â·</span>
                      <span>{info.semester}</span>
                    </>
                  )}
                  {info.revision && (
                    <>
                      <span>Â·</span>
                      <span className="font-medium text-indigo-600">
                        {info.revision} ê°œì •íŒ
                      </span>
                    </>
                  )}
                  {info.difficulty_level && (
                    <>
                      <span>Â·</span>
                      <span className="rounded bg-indigo-100 px-1.5 py-0.5 text-indigo-800 text-xs">
                        {info.difficulty_level}
                      </span>
                    </>
                  )}
                  <span>Â·</span>
                  {isEditing ? (
                    (() => {
                      const contentInfo = contentDetails.get(contentKey);
                      const isLoading = loadingDetails.has(contentKey);
                      const selectedStartId = startDetailId.get(contentKey);
                      const selectedEndId = endDetailId.get(contentKey);
                      const recommendedRange =
                        recommendedRanges.get(contentKey);

                      return (
                        <div className="flex flex-col gap-3">
                          {recommendedRange && (
                            <div className="rounded-lg border border-blue-200 bg-blue-50 p-2">
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <div className="text-xs font-medium text-blue-800">
                                    ğŸ’¡ ì¶”ì²œ ë²”ìœ„: {recommendedRange.start} ~{" "}
                                    {recommendedRange.end}
                                    {content.content_type === "book"
                                      ? " í˜ì´ì§€"
                                      : " íšŒì°¨"}
                                  </div>
                                  <div className="text-xs text-blue-800">
                                    {recommendedRange.reason}
                                  </div>
                                </div>
                                <button
                                  type="button"
                                  onClick={() => {
                                    setEditingRange({
                                      start: String(recommendedRange.start),
                                      end: String(recommendedRange.end),
                                    });
                                  }}
                                  className="rounded bg-blue-600 px-2 py-1 text-xs font-medium text-white hover:bg-blue-700"
                                >
                                  ì ìš©
                                </button>
                              </div>
                            </div>
                          )}

                          {isLoading ? (
                            <div className="text-xs text-gray-600">
                              ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </div>
                          ) : contentInfo && contentInfo.details.length > 0 ? (
                            <div className="space-y-3">
                              {/* ì‹œì‘ ë²”ìœ„ ì„ íƒ */}
                              <div className="flex flex-col gap-2">
                                <div className="text-xs font-medium text-gray-600">
                                  ì‹œì‘ ë²”ìœ„ ì„ íƒ
                                </div>
                                <div className="max-h-32 overflow-y-auto rounded-lg border border-gray-200 bg-white p-2">
                                  <div className="flex flex-col gap-1">
                                    {contentInfo.type === "book"
                                      ? (
                                          contentInfo.details as BookDetail[]
                                        ).map((detail) => {
                                          const isSelected =
                                            selectedStartId === detail.id;
                                          return (
                                            <label
                                              key={detail.id}
                                              className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                                isSelected
                                                  ? "border-blue-500 bg-blue-50"
                                                  : "border-gray-200 hover:bg-gray-50"
                                              }`}
                                            >
                                              <input
                                                type="radio"
                                                name={`start-${type}-${index}`}
                                                checked={isSelected}
                                                onChange={() =>
                                                  setStartRange(detail.id)
                                                }
                                                className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500"
                                              />
                                              <div className="flex flex-1 items-center gap-2 text-xs">
                                                <span className="font-medium">
                                                  í˜ì´ì§€ {detail.page_number}
                                                </span>
                                                {detail.major_unit && (
                                                  <span className="text-gray-600">
                                                    Â· {detail.major_unit}
                                                    {detail.minor_unit &&
                                                      ` - ${detail.minor_unit}`}
                                                  </span>
                                                )}
                                              </div>
                                            </label>
                                          );
                                        })
                                      : (
                                          contentInfo.details as LectureEpisode[]
                                        ).map((episode) => {
                                          const isSelected =
                                            selectedStartId === episode.id;
                                          return (
                                            <label
                                              key={episode.id}
                                              className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                                isSelected
                                                  ? "border-blue-500 bg-blue-50"
                                                  : "border-gray-200 hover:bg-gray-50"
                                              }`}
                                            >
                                              <input
                                                type="radio"
                                                name={`start-${type}-${index}`}
                                                checked={isSelected}
                                                onChange={() =>
                                                  setStartRange(episode.id)
                                                }
                                                className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500"
                                              />
                                              <div className="flex flex-1 items-center gap-2 text-xs">
                                                <span className="font-medium">
                                                  {episode.episode_number}íšŒì°¨
                                                </span>
                                                {episode.episode_title && (
                                                  <span className="text-gray-600">
                                                    Â· {episode.episode_title}
                                                  </span>
                                                )}
                                              </div>
                                            </label>
                                          );
                                        })}
                                  </div>
                                </div>
                              </div>
                              {/* ë ë²”ìœ„ ì„ íƒ */}
                              <div className="flex flex-col gap-2">
                                <div className="text-xs font-medium text-gray-600">
                                  ë ë²”ìœ„ ì„ íƒ
                                </div>
                                <div className="max-h-32 overflow-y-auto rounded-lg border border-gray-200 bg-white p-2">
                                  <div className="flex flex-col gap-1">
                                    {contentInfo.type === "book"
                                      ? (
                                          contentInfo.details as BookDetail[]
                                        ).map((detail) => {
                                          const isSelected =
                                            selectedEndId === detail.id;
                                          return (
                                            <label
                                              key={detail.id}
                                              className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                                isSelected
                                                  ? "border-green-500 bg-green-50"
                                                  : "border-gray-200 hover:bg-gray-50"
                                              }`}
                                            >
                                              <input
                                                type="radio"
                                                name={`end-${type}-${index}`}
                                                checked={isSelected}
                                                onChange={() =>
                                                  setEndRange(detail.id)
                                                }
                                                className="h-3 w-3 border-gray-300 text-green-600 focus:ring-green-500"
                                              />
                                              <div className="flex flex-1 items-center gap-2 text-xs">
                                                <span className="font-medium">
                                                  í˜ì´ì§€ {detail.page_number}
                                                </span>
                                                {detail.major_unit && (
                                                  <span className="text-gray-600">
                                                    Â· {detail.major_unit}
                                                    {detail.minor_unit &&
                                                      ` - ${detail.minor_unit}`}
                                                  </span>
                                                )}
                                              </div>
                                            </label>
                                          );
                                        })
                                      : (
                                          contentInfo.details as LectureEpisode[]
                                        ).map((episode) => {
                                          const isSelected =
                                            selectedEndId === episode.id;
                                          return (
                                            <label
                                              key={episode.id}
                                              className={`flex cursor-pointer items-center gap-2 rounded border p-1.5 transition-colors ${
                                                isSelected
                                                  ? "border-green-500 bg-green-50"
                                                  : "border-gray-200 hover:bg-gray-50"
                                              }`}
                                            >
                                              <input
                                                type="radio"
                                                name={`end-${type}-${index}`}
                                                checked={isSelected}
                                                onChange={() =>
                                                  setEndRange(episode.id)
                                                }
                                                className="h-3 w-3 border-gray-300 text-green-600 focus:ring-green-500"
                                              />
                                              <div className="flex flex-1 items-center gap-2 text-xs">
                                                <span className="font-medium">
                                                  {episode.episode_number}íšŒì°¨
                                                </span>
                                                {episode.episode_title && (
                                                  <span className="text-gray-600">
                                                    Â· {episode.episode_title}
                                                  </span>
                                                )}
                                              </div>
                                            </label>
                                          );
                                        })}
                                  </div>
                                </div>
                              </div>
                              {/* ì„ íƒëœ ë²”ìœ„ ë° í¬í•¨ëœ ìƒì„¸ì •ë³´ í‘œì‹œ */}
                              {editingRange && (
                                <div className="rounded-lg border border-gray-200 bg-gray-50 p-2">
                                  <div className="text-xs font-medium text-gray-600">
                                    ì„ íƒëœ ë²”ìœ„: {editingRange.start} ~{" "}
                                    {editingRange.end}
                                    {content.content_type === "book"
                                      ? " í˜ì´ì§€"
                                      : " íšŒì°¨"}
                                  </div>
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                min={1}
                                value={
                                  editingRange?.start || content.start_range
                                }
                                onChange={(e) =>
                                  setEditingRange({
                                    start: e.target.value,
                                    end:
                                      editingRange?.end ||
                                      String(content.end_range),
                                  })
                                }
                                className="w-20 rounded border border-gray-300 px-2 py-1 text-xs focus:border-gray-900 focus:outline-none"
                                placeholder="ì‹œì‘"
                              />
                              <span>~</span>
                              <input
                                type="number"
                                min={1}
                                value={editingRange?.end || content.end_range}
                                onChange={(e) =>
                                  setEditingRange({
                                    start:
                                      editingRange?.start ||
                                      String(content.start_range),
                                    end: e.target.value,
                                  })
                                }
                                className="w-20 rounded border border-gray-300 px-2 py-1 text-xs focus:border-gray-900 focus:outline-none"
                                placeholder="ì¢…ë£Œ"
                              />
                            </div>
                          )}
                          <div className="flex items-center gap-2">
                            <button
                              type="button"
                              onClick={() => {
                                if (editingRange) {
                                  const start = Number(editingRange.start);
                                  const end = Number(editingRange.end);
                                  if (
                                    !isNaN(start) &&
                                    !isNaN(end) &&
                                    start <= end &&
                                    start > 0
                                  ) {
                                    // ê¸°ì¡´ contents ë°°ì—´ì„ ë³µì‚¬
                                    const updated = [...contents];
                                    const startDetailIdValue =
                                      startDetailId.get(contentKey) || null;
                                    const endDetailIdValue =
                                      endDetailId.get(contentKey) || null;
                                    
                                    // any íƒ€ì…ìœ¼ë¡œ ìºìŠ¤íŒ…í•˜ì—¬ ì—…ë°ì´íŠ¸ (WizardData íƒ€ì… í˜¸í™˜ì„±)
                                    // ì‹¤ì œë¡œëŠ” student_contentsì™€ recommended_contents íƒ€ì…ì´ ê±°ì˜ ë™ì¼í•¨
                                    updated[index] = {
                                      ...content,
                                      start_range: start,
                                      end_range: end,
                                      start_detail_id: startDetailIdValue,
                                      end_detail_id: endDetailIdValue,
                                    } as any;

                                    onUpdateContents(updated);
                                    setEditingRangeIndex(null);
                                    setEditingRange(null);
                                    // ìƒì„¸ì •ë³´ ì„ íƒ ì´ˆê¸°í™”ëŠ” ìƒìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ editingRangeIndex ë³€ê²½ ê°ì§€ë¡œ ì²˜ë¦¬ë˜ê±°ë‚˜ ì—¬ê¸°ì„œ ì§ì ‘ ì²˜ë¦¬?
                                    // ìƒìœ„ ì»´í¬ë„ŒíŠ¸ì˜ useContentDetailsê°€ editingRangeIndexì— ì˜ì¡´í•˜ë¯€ë¡œ nullë¡œ ì„¤ì •í•˜ë©´ resetë¨ (hook ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì•„ë‹˜, hook ë‚´ë¶€ stateëŠ” ë³„ë„)
                                    // ìƒìœ„ì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë§ì§€ë§Œ ì—¬ê¸°ì„œ hookì˜ set í•¨ìˆ˜ë¥¼ í˜¸ì¶œí–ˆìœ¼ë¯€ë¡œ, 
                                    // hookì„ ì‚¬ìš©í•˜ëŠ” ìª½ì—ì„œ editingRangeIndexê°€ nullì´ ë˜ë©´ stateë¥¼ ì •ë¦¬í•˜ëŠ” ë¡œì§ì´ ìˆìœ¼ë©´ ì¢‹ìŒ.
                                    // í˜„ì¬ useContentDetailsëŠ” editingRangeIndexê°€ ìˆìœ¼ë©´ fetchí•˜ì§€ë§Œ ì—†ìœ¼ë©´?
                                    // ì—¬ê¸°ì„œëŠ” ê·¸ëƒ¥ ë‹«ê¸°.
                                  } else {
                                    alert(
                                      "ì˜¬ë°”ë¥¸ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì‹œì‘ â‰¤ ì¢…ë£Œ, ì–‘ìˆ˜)"
                                    );
                                  }
                                }
                              }}
                              className="rounded bg-blue-600 px-2 py-1 text-xs font-medium text-white hover:bg-blue-700"
                            >
                              ì €ì¥
                            </button>
                            <button
                              type="button"
                              onClick={() => {
                                setEditingRangeIndex(null);
                                setEditingRange(null);
                              }}
                              className="rounded bg-gray-300 px-2 py-1 text-xs font-medium text-gray-600 hover:bg-gray-400"
                            >
                              ì·¨ì†Œ
                            </button>
                          </div>
                        </div>
                      );
                    })()
                  ) : (
                    <span className="font-medium">
                      {content.start_range} ~ {content.end_range}
                      {content.content_type === "book" ? " í˜ì´ì§€" : " íšŒì°¨"}
                    </span>
                  )}
                </div>
              </div>
              {!isEditing &&
                (() => {
                  const recommendedRange = recommendedRanges.get(contentKey);
                  const unavailableReason =
                    rangeUnavailableReasons.get(contentKey);
                  const range = content.end_range - content.start_range + 1;
                  const recRange = recommendedRange
                    ? recommendedRange.end - recommendedRange.start + 1
                    : null;
                  const difference =
                    recRange !== null ? range - recRange : null;

                  return (
                    <div className="flex flex-col items-end gap-2">
                       {recommendedRange ? (
                        <div className="rounded-lg border border-blue-200 bg-blue-50 px-2 py-1 text-xs">
                          <div className="font-medium text-blue-800">
                            ğŸ’¡ ì¶”ì²œ: {recommendedRange.start} ~{" "}
                            {recommendedRange.end}
                            {content.content_type === "book"
                              ? " í˜ì´ì§€"
                              : " íšŒì°¨"}
                          </div>
                          {difference !== null && difference !== 0 && (
                            <div
                              className={`text-xs ${
                                difference > 0
                                  ? "text-red-600"
                                  : "text-green-600"
                              }`}
                            >
                              {difference > 0 ? "+" : ""}
                              {difference}{" "}
                              {content.content_type === "book"
                                ? "í˜ì´ì§€"
                                : "íšŒì°¨"}{" "}
                              ì°¨ì´
                            </div>
                          )}
                        </div>
                      ) : unavailableReason ? (
                        <div className="flex flex-col gap-0.5 rounded-lg border border-gray-200 bg-gray-50 px-2 py-1 text-xs">
                          <div className="text-gray-600">ì¶”ì²œ ë²”ìœ„ ì—†ìŒ</div>
                          <div className="text-gray-600">
                            ({unavailableReason})
                          </div>
                        </div>
                      ) : null}
                      <div className="flex items-center gap-2">
                        <button
                          type="button"
                          onClick={() => {
                            setEditingRangeIndex({
                              type,
                              index,
                            });
                            setEditingRange({
                              start: String(content.start_range),
                              end: String(content.end_range),
                            });
                          }}
                          className="text-sm text-blue-600 hover:text-blue-800"
                        >
                          ë²”ìœ„ ìˆ˜ì •
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            const updated = contents.filter(
                              (_, i) => i !== index
                            );
                            onUpdateContents(updated);
                          }}
                          className="text-sm text-red-600 hover:text-red-800"
                        >
                          ì‚­ì œ
                        </button>
                      </div>
                    </div>
                  );
                })()}
            </div>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step6FinalReview/index.ts">
export * from "./Step6FinalReview";
export * from "./types";
export { Step6FinalReview as default } from "./Step6FinalReview";
</file>

<file path="new-group/_components/Step6FinalReview/Step6FinalReview.tsx">
import { useState, useMemo } from "react";
import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";
import { WizardData } from "../PlanGroupWizard";
import {
  Step6FinalReviewProps,
  ContentInfo,
  BookDetail,
  LectureEpisode,
} from "./types";
import { useContentInfos } from "./hooks/useContentInfos";
import { useContentTotals } from "./hooks/useContentTotals";
import { useRecommendedRanges } from "./hooks/useRecommendedRanges";
import { useContentDetails } from "./hooks/useContentDetails";
import { useInitialRanges } from "./hooks/useInitialRanges";
import { SubjectAllocationUI } from "./SubjectAllocationUI";
import { ContentAllocationUI } from "./ContentAllocationUI";
import { ContentList } from "./ContentList";
import { ComparisonTable } from "./ComparisonTable";

export function Step6FinalReview({
  data,
  onUpdate,
  contents,
  isCampMode = false,
  studentId,
}: Step6FinalReviewProps) {
  // Hooks
  const { contentInfos, loading } = useContentInfos({
    data,
    contents,
    isCampMode,
    studentId,
  });

  const { contentTotals, loadingContentTotals } = useContentTotals({
    data,
    contentInfos,
    isCampMode,
    studentId,
  });

  const { recommendedRanges, rangeUnavailableReasons } = useRecommendedRanges({
    data,
    contentInfos,
    contentTotals,
  });

  const initialRanges = useInitialRanges({ contentInfos, data });

  // Range Editing State
  const [editingRangeIndex, setEditingRangeIndex] = useState<{
    type: "student" | "recommended";
    index: number;
  } | null>(null);
  const [editingRange, setEditingRange] = useState<{
    start: string;
    end: string;
  } | null>(null);

  const {
    contentDetails,
    startDetailId,
    endDetailId,
    loadingDetails,
    setStartDetailId,
    setEndDetailId,
  } = useContentDetails({ editingRangeIndex, data, isCampMode, studentId });

  // Helper functions for range editing
  const setStartRange = (detailId: string) => {
    if (!editingRangeIndex) return;
    const contentKey = `${editingRangeIndex.type}-${editingRangeIndex.index}`;
    setStartDetailId((prev) => {
      const newMap = new Map(prev);
      newMap.set(contentKey, detailId);
      return newMap;
    });
  };

  const setEndRange = (detailId: string) => {
    if (!editingRangeIndex) return;
    const contentKey = `${editingRangeIndex.type}-${editingRangeIndex.index}`;
    setEndDetailId((prev) => {
      const newMap = new Map(prev);
      newMap.set(contentKey, detailId);
      return newMap;
    });
  };

  // ê³¼ëª©ë³„ ì •ë ¬ ë° í•„ìˆ˜ ê³¼ëª© ì²˜ë¦¬
  const contentsBySubject = new Map<string, ContentInfo[]>();
  contentInfos.forEach((content) => {
    const subject = content.subject_category || "ê¸°íƒ€";
    if (!contentsBySubject.has(subject)) {
      contentsBySubject.set(subject, []);
    }
    contentsBySubject.get(subject)!.push(content);
  });

  const requiredSubjects = useMemo(() => {
    if (!isCampMode) return [];
    return (
      data.subject_constraints?.required_subjects?.map(
        (req) => req.subject_category
      ) || []
    );
  }, [isCampMode, data.subject_constraints]);

  const sortedSubjects = useMemo(() => {
    return Array.from(contentsBySubject.keys()).sort((a, b) => {
      if (isCampMode && requiredSubjects.length > 0) {
        const aIndex = requiredSubjects.indexOf(a);
        const bIndex = requiredSubjects.indexOf(b);
        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
        if (aIndex !== -1) return -1;
        if (bIndex !== -1) return 1;
      }
      return a.localeCompare(b);
    });
  }, [contentsBySubject, isCampMode, requiredSubjects]);

  const studentCount = data.student_contents.length;
  const recommendedCount = data.recommended_contents.length;
  const totalCount = studentCount + recommendedCount;

  const selectedSubjectCategories = new Set(
    contentInfos.map((c) => c.subject_category).filter((s): s is string => !!s)
  );

  // í•™ìŠµëŸ‰ ìš”ì•½ ìƒíƒœ ê³„ì‚°
  const scheduleSummaryState = useMemo(() => {
    if (!data.schedule_summary) return null;

    const isCalculatingRecommendations =
      contentInfos.length > 0 &&
      recommendedRanges.size === 0 &&
      rangeUnavailableReasons.size === 0;
    const isLoading = loadingContentTotals || isCalculatingRecommendations;

    if (isLoading) {
      return {
        type: "loading" as const,
        loadingContentTotals,
      };
    }

    if (recommendedRanges.size === 0 && rangeUnavailableReasons.size > 0) {
      return { type: "unavailable" as const };
    }

    if (recommendedRanges.size === 0) {
      return { type: "empty" as const };
    }

    return { type: "ready" as const };
  }, [
    data.schedule_summary,
    contentInfos.length,
    recommendedRanges.size,
    rangeUnavailableReasons.size,
    loadingContentTotals,
  ]);

  // í•™ìŠµëŸ‰ ìš”ì•½ ë°ì´í„° ê³„ì‚°
  const learningVolumeSummary = useMemo(() => {
    if (!scheduleSummaryState || scheduleSummaryState.type !== "ready") {
      return null;
    }

    let initialTotalPages = 0;
    let initialTotalEpisodes = 0;
    let currentTotalPages = 0;
    let currentTotalEpisodes = 0;
    let recommendedTotalPages = 0;
    let recommendedTotalEpisodes = 0;

    const contentKeyMap = new Map<string, string>();
    const contentMap = new Map<
      string,
      | (typeof data.student_contents)[0]
      | (typeof data.recommended_contents)[0]
    >();

    data.student_contents.forEach((c, idx) => {
      const key = `student-${idx}`;
      contentKeyMap.set(c.content_id, key);
      contentMap.set(key, c);
    });

    data.recommended_contents.forEach((c, idx) => {
      const key = `recommended-${idx}`;
      contentKeyMap.set(c.content_id, key);
      contentMap.set(key, c);
    });

    contentInfos.forEach((info) => {
      const contentKey = contentKeyMap.get(info.content_id);
      if (!contentKey) return;

      const content = contentMap.get(contentKey);
      if (!content) return;

      const initial = initialRanges.get(contentKey);
      const recommended = recommendedRanges.get(contentKey);

      const range = content.end_range - content.start_range + 1;
      const initialRange = initial ? initial.end - initial.start + 1 : range;
      const recommendedRange = recommended
        ? recommended.end - recommended.start + 1
        : 0;

      if (info.content_type === "book") {
        initialTotalPages += initialRange;
        currentTotalPages += range;
        recommendedTotalPages += recommendedRange;
      } else {
        initialTotalEpisodes += initialRange;
        currentTotalEpisodes += range;
        recommendedTotalEpisodes += recommendedRange;
      }
    });

    const { total_study_days, total_study_hours } = data.schedule_summary || {
      total_study_days: 0,
      total_study_hours: 0,
    };
    const avgDailyHours =
      total_study_days > 0 ? total_study_hours / total_study_days : 0;

    const pagesPerHour = defaultRangeRecommendationConfig.pagesPerHour;
    const episodesPerHour = defaultRangeRecommendationConfig.episodesPerHour;
    const totalDailyPages = Math.round(avgDailyHours * pagesPerHour);
    const totalDailyEpisodes = Math.round(avgDailyHours * episodesPerHour);

    let currentEstimatedDays = 0;
    if (currentTotalPages > 0 && totalDailyPages > 0) {
      currentEstimatedDays = Math.ceil(currentTotalPages / totalDailyPages);
    }
    if (currentTotalEpisodes > 0 && totalDailyEpisodes > 0) {
      const episodeDays = Math.ceil(
        currentTotalEpisodes / totalDailyEpisodes
      );
      currentEstimatedDays = Math.max(currentEstimatedDays, episodeDays);
    }

    let recommendedEstimatedDays = 0;
    if (recommendedTotalPages > 0 && totalDailyPages > 0) {
      recommendedEstimatedDays = Math.ceil(
        recommendedTotalPages / totalDailyPages
      );
    }
    if (recommendedTotalEpisodes > 0 && totalDailyEpisodes > 0) {
      const episodeDays = Math.ceil(
        recommendedTotalEpisodes / totalDailyEpisodes
      );
      recommendedEstimatedDays = Math.max(
        recommendedEstimatedDays,
        episodeDays
      );
    }

    const hasChanged =
      initialTotalPages !== currentTotalPages ||
      initialTotalEpisodes !== currentTotalEpisodes;
    const hasDifference =
      currentTotalPages !== recommendedTotalPages ||
      currentTotalEpisodes !== recommendedTotalEpisodes;

    return {
      initialTotalPages,
      initialTotalEpisodes,
      currentTotalPages,
      currentTotalEpisodes,
      recommendedTotalPages,
      recommendedTotalEpisodes,
      currentEstimatedDays,
      recommendedEstimatedDays,
      hasChanged,
      hasDifference,
    };
  }, [
    scheduleSummaryState,
    contentInfos,
    data.student_contents,
    data.recommended_contents,
    data.schedule_summary,
    initialRanges,
    recommendedRanges,
  ]);

  if (loading) {
    return (
      <div className="flex flex-col gap-6">
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
          <p className="text-sm text-gray-600">ì½˜í…ì¸  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-semibold text-gray-900">
          ìµœì¢… í™•ì¸ ë° ì¡°ì •
        </h2>
        <p className="text-sm text-gray-600">
          ì„ íƒí•œ ì½˜í…ì¸ ì™€ í•™ìŠµ ë²”ìœ„ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ì¡°ì •í•´ì£¼ì„¸ìš”.
        </p>
      </div>

      {/* ìš”ì•½ ì •ë³´ */}
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-4">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-gray-800">ì „ì²´ ì½˜í…ì¸ </div>
              <div className="text-2xl font-bold text-gray-900">
                {totalCount}ê°œ
              </div>
            </div>
          </div>
          <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-blue-800">í•™ìƒ ì½˜í…ì¸ </div>
              <div className="text-2xl font-bold text-blue-800">
                {studentCount}ê°œ
              </div>
            </div>
          </div>
          <div className="rounded-lg border border-green-200 bg-green-50 p-4">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-green-700">
                ì¶”ì²œ ì½˜í…ì¸ 
              </div>
              <div className="text-2xl font-bold text-green-900">
                {recommendedCount}ê°œ
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* í•™ìŠµëŸ‰ ë¹„êµ ìš”ì•½ */}
      {scheduleSummaryState && scheduleSummaryState.type === "loading" && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-semibold text-gray-900">
              ğŸ“Š ì „ì²´ í•™ìŠµëŸ‰ ë¹„êµ
            </h3>
            <div className="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
              <div className="flex flex-col items-center justify-center gap-3">
                <div className="h-6 w-6 animate-spin rounded-full border-2 border-gray-300 border-t-indigo-600"></div>
                <div className="flex flex-col gap-1">
                  <p className="text-sm font-medium text-gray-800">
                    {scheduleSummaryState.loadingContentTotals
                      ? "ì½˜í…ì¸  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."
                      : "ì¶”ì²œ ë²”ìœ„ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘..."}
                  </p>
                  <p className="text-xs text-gray-600">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {scheduleSummaryState &&
        scheduleSummaryState.type === "ready" &&
        learningVolumeSummary && (
          <div className="rounded-lg border border-gray-200 bg-white p-4">
            <div className="flex flex-col gap-3">
              <h3 className="text-sm font-semibold text-gray-900">
                ğŸ“Š ì „ì²´ í•™ìŠµëŸ‰ ë¹„êµ
              </h3>
              <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
                {/* í˜„ì¬ ë²”ìœ„ */}
                <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
                  <div className="flex flex-col gap-1">
                    <div className="text-xs font-medium text-blue-800">
                      í˜„ì¬ ì§€ì • ë²”ìœ„
                    </div>
                    <div className="text-lg font-bold text-blue-800">
                      {learningVolumeSummary.currentTotalPages > 0 && (
                        <span className="block">
                          ğŸ“„ {learningVolumeSummary.currentTotalPages}í˜ì´ì§€
                        </span>
                      )}
                      {learningVolumeSummary.currentTotalEpisodes > 0 && (
                        <span className="block">
                          ğŸ“º {learningVolumeSummary.currentTotalEpisodes}íšŒì°¨
                        </span>
                      )}
                      {learningVolumeSummary.currentTotalPages === 0 &&
                        learningVolumeSummary.currentTotalEpisodes === 0 && (
                          <span className="text-sm text-gray-600">ì—†ìŒ</span>
                        )}
                    </div>
                    <div className="text-xs text-blue-600">
                      ì˜ˆìƒ ì†Œìš”: ì•½ {learningVolumeSummary.currentEstimatedDays}ì¼
                    </div>
                  </div>
                </div>
              </div>

              {/* ì¶”ì²œ ë²”ìœ„ */}
              <div className="rounded-lg border border-green-200 bg-green-50 p-3">
                <div className="flex flex-col gap-1">
                  <div className="text-xs font-medium text-green-700">
                    ì¶”ì²œ ë²”ìœ„
                  </div>
                  <div className="text-lg font-bold text-green-900">
                    {learningVolumeSummary.recommendedTotalPages > 0 && (
                      <span className="block">
                        ğŸ“„ {learningVolumeSummary.recommendedTotalPages}í˜ì´ì§€
                      </span>
                    )}
                    {learningVolumeSummary.recommendedTotalEpisodes > 0 && (
                      <span className="block">
                        ğŸ“º {learningVolumeSummary.recommendedTotalEpisodes}íšŒì°¨
                      </span>
                    )}
                    {learningVolumeSummary.recommendedTotalPages === 0 &&
                      learningVolumeSummary.recommendedTotalEpisodes === 0 && (
                        <span className="text-sm text-gray-600">ì—†ìŒ</span>
                      )}
                  </div>
                  <div className="text-xs text-green-600">
                    ì˜ˆìƒ ì†Œìš”: ì•½ {learningVolumeSummary.recommendedEstimatedDays}
                    ì¼ (ìŠ¤ì¼€ì¤„ì— ë§ì¶¤)
                  </div>
                </div>
              </div>

              {/* ì°¨ì´ */}
              <div className="rounded-lg border border-amber-200 bg-amber-50 p-3">
                <div className="flex flex-col gap-1">
                  <div className="text-xs font-medium text-amber-700">ì°¨ì´</div>
                  <div className="text-lg font-bold text-amber-900">
                    {learningVolumeSummary.hasDifference ? (
                      <>
                        {learningVolumeSummary.currentTotalPages -
                          learningVolumeSummary.recommendedTotalPages !==
                          0 && (
                          <span className="block">
                            ğŸ“„{" "}
                            {learningVolumeSummary.currentTotalPages -
                              learningVolumeSummary.recommendedTotalPages >
                            0
                              ? "+"
                              : ""}
                            {learningVolumeSummary.currentTotalPages -
                              learningVolumeSummary.recommendedTotalPages}
                            í˜ì´ì§€
                          </span>
                        )}
                        {learningVolumeSummary.currentTotalEpisodes -
                          learningVolumeSummary.recommendedTotalEpisodes !==
                          0 && (
                          <span className="block">
                            ğŸ“º{" "}
                            {learningVolumeSummary.currentTotalEpisodes -
                              learningVolumeSummary.recommendedTotalEpisodes >
                            0
                              ? "+"
                              : ""}
                            {learningVolumeSummary.currentTotalEpisodes -
                              learningVolumeSummary.recommendedTotalEpisodes}
                            íšŒì°¨
                          </span>
                        )}
                      </>
                    ) : (
                      <span className="text-sm text-green-600">ì¼ì¹˜</span>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

      {/* í•™ìŠµ ë²”ìœ„ ë¹„êµ í…Œì´ë¸” */}
      <ComparisonTable
        data={data}
        onUpdate={onUpdate}
        contentInfos={contentInfos}
        recommendedRanges={recommendedRanges}
      />

      {/* ê³¼ëª©ë³„ ê·¸ë£¹í™”ëœ í•™ìŠµ ë²”ìœ„ ìš”ì•½ */}
      {sortedSubjects.length > 0 && (
        <div className="flex flex-col gap-4">
          <h3 className="text-lg font-semibold text-gray-900">
            ê³¼ëª©ë³„ í•™ìŠµ ë²”ìœ„
          </h3>
          <div className="flex flex-col gap-3">
            {sortedSubjects.map((subject) => {
              const contents = contentsBySubject.get(subject) || [];
              const isRequired = requiredSubjects.includes(subject);
              const hasRequired = selectedSubjectCategories.has(subject);

              return (
                <div
                  key={subject}
                  className="rounded-lg border border-gray-200 bg-white p-4"
                >
                  <div className="flex flex-col gap-3">
                    <div className="flex items-center gap-2">
                      <h4 className="text-sm font-semibold text-gray-900">
                        {subject}
                      </h4>
                      {isRequired && (
                        <span className="rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800">
                          í•„ìˆ˜
                        </span>
                      )}
                      {isRequired && !hasRequired && (
                        <span className="text-xs text-red-600">(ë¯¸ì„ íƒ)</span>
                      )}
                      <span className="ml-auto text-xs text-gray-600">
                        {contents.length}ê°œ
                      </span>
                    </div>
                    <div className="flex flex-col gap-2">
                      {contents.map((content, idx) => (
                        <div
                          key={idx}
                          className="flex items-center justify-between rounded-lg border border-gray-100 bg-gray-50 px-3 py-2"
                        >
                          <div className="flex-1">
                            <div className="flex flex-col gap-1">
                              <div className="text-xs font-medium text-gray-900">
                                {content.title}
                              </div>
                              <div className="flex items-center gap-1 text-xs text-gray-600">
                                {content.content_type === "book" && "ğŸ“š"}
                                {content.content_type === "lecture" && "ğŸ§"}
                                <span>
                                  {content.start_range} ~ {content.end_range}
                                  {content.content_type === "book"
                                    ? " í˜ì´ì§€"
                                    : " íšŒì°¨"}
                                </span>
                              </div>
                            </div>
                          </div>
                          {content.isRecommended && (
                            <span className="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">
                              ì¶”ì²œ
                            </span>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* ì½˜í…ì¸ ê°€ ì—†ëŠ” ê²½ìš° */}
      {totalCount === 0 && (
        <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
          <p className="text-sm text-gray-600">ì„ íƒëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          <p className="text-xs text-gray-600">
            ì´ì „ ë‹¨ê³„ì—ì„œ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
          </p>
        </div>
      )}

      {/* í•™ìƒ ì½˜í…ì¸  ë¦¬ìŠ¤íŠ¸ */}
      <ContentList
        type="student"
        contents={data.student_contents}
        contentInfos={contentInfos}
        recommendedRanges={recommendedRanges}
        rangeUnavailableReasons={rangeUnavailableReasons}
        editingRangeIndex={editingRangeIndex}
        editingRange={editingRange}
        contentDetails={contentDetails}
        loadingDetails={loadingDetails}
        startDetailId={startDetailId}
        endDetailId={endDetailId}
        onUpdateContents={(newContents) => onUpdate({ student_contents: newContents })}
        setEditingRangeIndex={setEditingRangeIndex}
        setEditingRange={setEditingRange}
        setStartRange={setStartRange}
        setEndRange={setEndRange}
      />

       {/* ì¶”ì²œ ì½˜í…ì¸  ë¦¬ìŠ¤íŠ¸ */}
       <ContentList
        type="recommended"
        contents={data.recommended_contents}
        contentInfos={contentInfos}
        recommendedRanges={recommendedRanges}
        rangeUnavailableReasons={rangeUnavailableReasons}
        editingRangeIndex={editingRangeIndex}
        editingRange={editingRange}
        contentDetails={contentDetails}
        loadingDetails={loadingDetails}
        startDetailId={startDetailId}
        endDetailId={endDetailId}
        onUpdateContents={(newContents) => onUpdate({ recommended_contents: newContents })}
        setEditingRangeIndex={setEditingRangeIndex}
        setEditingRange={setEditingRange}
        setStartRange={setStartRange}
        setEndRange={setEndRange}
      />

      {/* ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì •ë³´ */}
      {data.scheduler_type === "1730_timetable" &&
        (data.student_contents.length > 0 ||
          data.recommended_contents.length > 0) && (
          <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold text-gray-900">
                ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì •ë³´
              </h2>

              <div className="inline-flex rounded-lg border border-gray-300 p-1">
                <button
                  type="button"
                  onClick={() => onUpdate({ allocation_mode: "subject" })}
                  className={`rounded-md px-3 py-1.5 text-sm font-medium transition-colors ${
                    (data.allocation_mode || "subject") === "subject"
                      ? "bg-gray-900 text-white"
                      : "text-gray-600 hover:text-gray-900"
                  }`}
                >
                  êµê³¼ë³„ ì„¤ì •
                </button>
                <button
                  type="button"
                  onClick={() => onUpdate({ allocation_mode: "content" })}
                  className={`rounded-md px-3 py-1.5 text-sm font-medium transition-colors ${
                    data.allocation_mode === "content"
                      ? "bg-gray-900 text-white"
                      : "text-gray-600 hover:text-gray-900"
                  }`}
                >
                  ì½˜í…ì¸ ë³„ ì„¤ì •
                </button>
              </div>
            </div>

            <p className="text-sm text-gray-600">
              {(data.allocation_mode || "subject") === "subject"
                ? "êµê³¼ ë‹¨ìœ„ë¡œ ì „ëµ/ì·¨ì•½ê³¼ëª©ì„ ì„¤ì •í•©ë‹ˆë‹¤. ê°™ì€ êµê³¼ì˜ ëª¨ë“  ì½˜í…ì¸ ì— ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤."
                : "ê°œë³„ ì½˜í…ì¸ ë§ˆë‹¤ ì „ëµ/ì·¨ì•½ê³¼ëª©ì„ ì„¤ì •í•©ë‹ˆë‹¤. ë” ì„¸ë°€í•œ ì¡°ì ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."}
            </p>

            {(data.allocation_mode || "subject") === "subject" && (
              <SubjectAllocationUI
                data={data}
                onUpdate={onUpdate}
                contentInfos={contentInfos}
              />
            )}

            {data.allocation_mode === "content" && (
              <ContentAllocationUI
                data={data}
                onUpdate={onUpdate}
                contentInfos={contentInfos}
              />
            )}
          </div>
        )}
    </div>
  );
}
</file>

<file path="new-group/_components/Step6FinalReview/SubjectAllocationUI.tsx">
import { WizardData } from "../PlanGroupWizard";
import { ContentInfo } from "./types";

type SubjectAllocationUIProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  contentInfos: ContentInfo[];
};

export function SubjectAllocationUI({
  data,
  onUpdate,
  contentInfos,
}: SubjectAllocationUIProps) {
  // ê³¼ëª© ì¶”ì¶œ
  const allSubjects = new Set<string>();
  contentInfos.forEach((content) => {
    if (content.subject_category) {
      allSubjects.add(content.subject_category);
    }
  });
  const subjects = Array.from(allSubjects).sort();

  if (subjects.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">ì½˜í…ì¸ ì˜ ê³¼ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  const handleSubjectAllocationChange = (
    subject: string,
    allocation: {
      subject_id: string;
      subject_name: string;
      subject_type: "strategy" | "weakness";
      weekly_days?: number;
    }
  ) => {
    const currentAllocations = data.subject_allocations || [];
    const updatedAllocations = currentAllocations.filter(
      (a) => a.subject_name !== subject
    );
    updatedAllocations.push(allocation);
    onUpdate({ subject_allocations: updatedAllocations });
  };

  return (
    <div className="space-y-4">
      {subjects.map((subject) => {
        const existingAllocation = (data.subject_allocations || []).find(
          (a) => a.subject_name === subject
        );
        const subjectType = existingAllocation?.subject_type || "weakness";
        const weeklyDays = existingAllocation?.weekly_days || 3;

        const subjectContentCount = contentInfos.filter(
          (c) => c.subject_category === subject
        ).length;

        return (
          <div
            key={subject}
            className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4"
          >
            <div className="flex items-center justify-between">
              <h3 className="text-sm font-semibold text-gray-900">{subject}</h3>
              <span className="text-xs text-gray-600">
                {subjectContentCount}ê°œ ì½˜í…ì¸ 
              </span>
            </div>

            <div className="flex flex-col gap-3">
              <div className="flex flex-col gap-2">
                <label className="block text-xs font-medium text-gray-600">
                  ê³¼ëª© ìœ í˜•
                </label>
                <div className="flex gap-3">
                  <label className="flex flex-1 cursor-pointer items-center gap-2 rounded-lg border p-3 transition-colors hover:bg-gray-100">
                    <input
                      type="radio"
                      name={`subject_type_${subject}`}
                      value="weakness"
                      checked={subjectType === "weakness"}
                      onChange={() => {
                        handleSubjectAllocationChange(subject, {
                          subject_id: subject
                            .toLowerCase()
                            .replace(/\s+/g, "_"),
                          subject_name: subject,
                          subject_type: "weakness",
                        });
                      }}
                      className="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <div className="flex-1">
                      <div className="text-sm font-medium text-gray-900">
                        ì·¨ì•½ê³¼ëª©
                      </div>
                      <div className="text-xs text-gray-600">
                        ì „ì²´ í•™ìŠµì¼ì— í”Œëœ ë°°ì •
                      </div>
                    </div>
                  </label>
                  <label className="flex flex-1 cursor-pointer items-center gap-2 rounded-lg border p-3 transition-colors hover:bg-gray-100">
                    <input
                      type="radio"
                      name={`subject_type_${subject}`}
                      value="strategy"
                      checked={subjectType === "strategy"}
                      onChange={() => {
                        handleSubjectAllocationChange(subject, {
                          subject_id: subject
                            .toLowerCase()
                            .replace(/\s+/g, "_"),
                          subject_name: subject,
                          subject_type: "strategy",
                          weekly_days: 3,
                        });
                      }}
                      className="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <div className="flex-1">
                      <div className="text-sm font-medium text-gray-900">
                        ì „ëµê³¼ëª©
                      </div>
                      <div className="text-xs text-gray-600">
                        ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜ì— ë”°ë¼ ë°°ì •
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              {subjectType === "strategy" && (
                <div className="flex flex-col gap-2">
                  <label className="block text-xs font-medium text-gray-600">
                    ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜
                  </label>
                  <select
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
                    value={weeklyDays}
                    onChange={(e) => {
                      handleSubjectAllocationChange(subject, {
                        subject_id: subject.toLowerCase().replace(/\s+/g, "_"),
                        subject_name: subject,
                        subject_type: "strategy",
                        weekly_days: Number(e.target.value),
                      });
                    }}
                  >
                    <option value="2">ì£¼ 2ì¼</option>
                    <option value="3">ì£¼ 3ì¼</option>
                    <option value="4">ì£¼ 4ì¼</option>
                  </select>
                  <p className="text-xs text-gray-600">
                    ì„ íƒí•œ ì£¼ë‹¹ ì¼ìˆ˜ì— ë”°ë¼ í•™ìŠµì¼ì— ê· ë“±í•˜ê²Œ ë°°ì •ë©ë‹ˆë‹¤.
                  </p>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="new-group/_components/Step6FinalReview/types.ts">
import { WizardData } from "../PlanGroupWizard";

export type Step6FinalReviewProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  contents?: {
    books: Array<{ id: string; title: string; subtitle?: string | null }>;
    lectures: Array<{ id: string; title: string; subtitle?: string | null }>;
    custom: Array<{ id: string; title: string; subtitle?: string | null }>;
  };
  isCampMode?: boolean;
  studentId?: string; // ìº í”„ ëª¨ë“œì—ì„œ ê´€ë¦¬ìê°€ ì‚¬ìš©í•˜ëŠ” í•™ìƒ ID
};

export type ContentInfo = {
  content_type: "book" | "lecture";
  content_id: string;
  title: string;
  subject_category?: string | null;
  start_range: number;
  end_range: number;
  isRecommended: boolean;
  // ìë™ ì¶”ì²œ ê´€ë ¨ í•„ë“œ
  is_auto_recommended?: boolean;
  recommendation_source?: "auto" | "admin" | "template" | null;
  recommendation_reason?: string | null;
  recommendation_metadata?: {
    scoreDetails?: {
      schoolGrade?: number | null;
      schoolAverageGrade?: number | null;
      mockPercentile?: number | null;
      mockGrade?: number | null;
      riskScore?: number;
    };
    priority?: number;
  } | null;
  subject?: string | null;
  semester?: string | null;
  revision?: string | null;
  difficulty_level?: string | null;
  publisher?: string | null;
  platform?: string | null;
};

export type BookDetail = {
  id: string;
  page_number: number;
  major_unit: string | null;
  minor_unit: string | null;
};

export type LectureEpisode = {
  id: string;
  episode_number: number;
  episode_title: string | null;
};
</file>

<file path="new-group/_components/Step7ScheduleResult/MeasureRow.tsx">
import { memo, useRef, useEffect } from "react";

// Row Size Measurer
export function MeasureRow({
  index,
  setSize,
  children,
  expandedKey
}: {
  index: number;
  setSize: (index: number, size: number) => void;
  children: React.ReactNode;
  expandedKey?: string;
}) {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (ref.current) {
      setSize(index, ref.current.getBoundingClientRect().height);
    }
  }, [setSize, index, expandedKey, children]);

  return <div ref={ref}>{children}</div>;
}
</file>

<file path="new-group/_components/Step7ScheduleResult/PlanTable.tsx">
import { memo } from "react";
import type { Plan } from "./scheduleTypes";
import type { ContentData } from "../utils/scheduleTransform";
import { timeToMinutes } from "./scheduleUtils";

// í”Œëœ í‘œ ì»´í¬ë„ŒíŠ¸
export const PlanTable = memo(
  function PlanTable({
    plans,
    contents,
    dayType,
    sequenceMap,
  }: {
    plans: Array<{
      plan: Plan;
      start: string;
      end: string;
      isPartial?: boolean;
      isContinued?: boolean;
      originalEstimatedTime?: number;
    }>;
    contents: Map<string, ContentData>;
    dayType: string;
    sequenceMap: Map<string, number>;
  }) {
    const formatTime = (minutes: number): string => {
      if (minutes === 0) return "0ë¶„";
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      if (hours > 0 && mins > 0) {
        return `${hours}ì‹œê°„ ${mins}ë¶„`;
      } else if (hours > 0) {
        return `${hours}ì‹œê°„`;
      } else {
        return `${mins}ë¶„`;
      }
    };

    const formatLearningAmount = (plan: Plan): string => {
      if (
        plan.planned_start_page_or_time === null ||
        plan.planned_end_page_or_time === null
      ) {
        return "-";
      }

      if (plan.content_type === "book") {
        return `${plan.planned_start_page_or_time}-${plan.planned_end_page_or_time}p`;
      } else if (plan.content_type === "lecture") {
        return `${plan.planned_start_page_or_time}ê°•`;
      }

      return `${plan.planned_start_page_or_time}-${plan.planned_end_page_or_time}`;
    };

    return (
      <table className="w-full text-xs border-collapse border border-blue-200">
        <thead className="bg-blue-100">
          <tr>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              ì‹œê°„
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              êµê³¼
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              ê³¼ëª©
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              ìœ í˜•
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              ì´ë¦„
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              í•™ìŠµë‚´ì—­
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              íšŒì°¨
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              í•™ìŠµ ë¶„ëŸ‰
            </th>
            <th className="px-3 py-2 text-left border border-blue-200 font-semibold text-blue-800">
              ì†Œìš”ì‹œê°„
            </th>
          </tr>
        </thead>
        <tbody>
          {plans.map((planTime, planIdx) => {
            const content = contents.get(planTime.plan.content_id);
            const duration =
              timeToMinutes(planTime.end) - timeToMinutes(planTime.start);
            const isReviewDay = dayType === "ë³µìŠµì¼";
            const showOriginalTime =
              isReviewDay &&
              planTime.originalEstimatedTime &&
              planTime.originalEstimatedTime > duration;
            const sequence = planTime.plan.sequence || 1;

            return (
              <tr
                key={`${planTime.plan.id}-${planIdx}`}
                className={`hover:bg-blue-50 ${
                  planTime.isContinued ? "bg-blue-100" : ""
                }`}
              >
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  <div className="flex items-center gap-1">
                    {planTime.isContinued && (
                      <span className="text-blue-800 font-semibold text-[10px]">
                        [ì´ì–´ì„œ]
                      </span>
                    )}
                    <span className="font-medium">
                      {planTime.start} ~ {planTime.end}
                    </span>
                    <span className="text-blue-800">
                      ({formatTime(duration)})
                    </span>
                    {planTime.isPartial && (
                      <span className="text-blue-800 text-[10px]">(ì¼ë¶€)</span>
                    )}
                    {showOriginalTime && (
                      <span className="text-orange-600 font-semibold text-[10px]">
                        [ì˜ˆìƒ: {formatTime(planTime.originalEstimatedTime!)}]
                      </span>
                    )}
                  </div>
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  {content?.subject_category || "-"}
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  {content?.subject || "-"}
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  {planTime.plan.content_type === "book" ? "êµì¬" : "ê°•ì˜"}
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  <div
                    className="max-w-[200px] truncate"
                    title={content?.title || ""}
                  >
                    {content?.title || "-"}
                  </div>
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  <div
                    className="max-w-[200px] truncate"
                    title={planTime.plan.chapter || ""}
                  >
                    {planTime.plan.chapter || "-"}
                  </div>
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800 text-center">
                  {sequence}
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  {formatLearningAmount(planTime.plan)}
                </td>
                <td className="px-3 py-2 border border-blue-200 text-blue-800">
                  <div className="flex flex-col gap-0.5">
                    <span>{formatTime(duration)}</span>
                    {showOriginalTime && (
                      <div className="text-orange-600 text-[10px]">
                        (ì˜ˆìƒ: {formatTime(planTime.originalEstimatedTime!)})
                      </div>
                    )}
                  </div>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    );
  },
  (prevProps, nextProps) => {
    // plans ë°°ì—´ì˜ ê¸¸ì´ì™€ ì£¼ìš” ì†ì„±ë§Œ ë¹„êµ
    return (
      prevProps.plans.length === nextProps.plans.length &&
      prevProps.dayType === nextProps.dayType &&
      prevProps.sequenceMap.size === nextProps.sequenceMap.size
    );
  }
);
</file>

<file path="new-group/_components/Step7ScheduleResult/ScheduleItem.tsx">
import { memo } from "react";
import {
  ChevronDown,
  ChevronUp,
  Clock,
  Calendar,
  XCircle,
} from "lucide-react";
import type { DailySchedule, Plan } from "./scheduleTypes";
import type { ContentData, BlockData } from "../utils/scheduleTransform";
import { formatNumber } from "@/lib/utils/formatNumber";
import { TimelineBar } from "./TimelineBar";
import { TimeSlotsWithPlans } from "./TimeSlotsWithPlans";
import { dayTypeLabels, dayTypeColors } from "./scheduleUtils";

export const ScheduleItem = memo(
  function ScheduleItem({
    schedule,
    datePlans,
    contents,
    blocks,
    sequenceMap,
    isExpanded,
    onToggle,
  }: {
    schedule: DailySchedule;
    datePlans: Plan[];
    contents: Map<string, ContentData>;
    blocks: BlockData[];
    sequenceMap: Map<string, number>;
    isExpanded: boolean;
    onToggle: () => void;
  }) {
    const formatDate = (dateStr: string): string => {
      const date = new Date(dateStr);
      const weekdays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      const weekday = weekdays[date.getDay()];
      return `${dateStr} (${weekday})`;
    };

    const hasDetails =
      schedule.academy_schedules && schedule.academy_schedules.length > 0;
    const hasExclusion =
      schedule.exclusion !== null && schedule.exclusion !== undefined;
    const hasTimeSlots = schedule.time_slots && schedule.time_slots.length > 0;

    return (
      <div className="border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
        <div
          className={`w-full px-4 py-3 ${
            hasDetails || hasExclusion || hasTimeSlots ? "cursor-pointer" : ""
          }`}
          onClick={() => {
            if (hasDetails || hasExclusion || hasTimeSlots) {
              onToggle();
            }
          }}
        >
          <div className="flex items-start justify-between gap-4">
            <div className="flex-1 min-w-0 pr-2">
              <div className="flex flex-col gap-2">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium text-gray-900">
                    {formatDate(schedule.date)}
                  </span>
                  <span
                    className={`rounded-full border px-2 py-0.5 text-xs font-medium ${
                      dayTypeColors[schedule.day_type] || dayTypeColors["í•™ìŠµì¼"]
                    }`}
                  >
                    {dayTypeLabels[schedule.day_type] || schedule.day_type}
                  </span>
                </div>
                {/* ì‹œê°„ ìŠ¬ë¡¯ì—ì„œ ê° íƒ€ì…ë³„ ì‹œê°„ ê³„ì‚° (ì‹œê°„ ë‹¨ìœ„) */}
                {(() => {
                const calculateTimeFromSlots = (
                  type: "í•™ìŠµì‹œê°„" | "ììœ¨í•™ìŠµ" | "ì´ë™ì‹œê°„" | "í•™ì›ì¼ì •"
                ): number => {
                  if (!schedule.time_slots) return 0;
                  const minutes = schedule.time_slots
                    .filter((slot) => slot.type === type)
                    .reduce((sum, slot) => {
                      const [startHour, startMin] = slot.start
                        .split(":")
                        .map(Number);
                      const [endHour, endMin] = slot.end.split(":").map(Number);
                      const startMinutes = startHour * 60 + startMin;
                      const endMinutes = endHour * 60 + endMin;
                      return sum + (endMinutes - startMinutes);
                    }, 0);
                  return minutes / 60;
                };

                // ì§€ì •íœ´ì¼ì¸ ê²½ìš° study_hoursê°€ ììœ¨í•™ìŠµ ì‹œê°„ì´ë¯€ë¡œ ë³„ë„ ê³„ì‚° ë¶ˆí•„ìš”
                const isDesignatedHoliday = schedule.day_type === "ì§€ì •íœ´ì¼";

                // ìˆœìˆ˜ í•™ìŠµ ì‹œê°„: time_slotsì—ì„œ "í•™ìŠµì‹œê°„" íƒ€ì…ë§Œ ê³„ì‚°
                const studyHours = calculateTimeFromSlots("í•™ìŠµì‹œê°„");
                const selfStudyHours = isDesignatedHoliday
                  ? schedule.study_hours
                  : calculateTimeFromSlots("ììœ¨í•™ìŠµ");
                const travelHours = calculateTimeFromSlots("ì´ë™ì‹œê°„");
                const academyHours = calculateTimeFromSlots("í•™ì›ì¼ì •");

                return (
                  <div className="flex flex-col gap-1 text-xs text-gray-600">
                    {isDesignatedHoliday ? (
                      // ì§€ì •íœ´ì¼ì¸ ê²½ìš° ììœ¨í•™ìŠµ ì‹œê°„ë§Œ í‘œê¸°
                      <div className="flex items-center gap-4">
                        <span className="font-medium">
                          ììœ¨ í•™ìŠµ ì‹œê°„: {formatNumber(selfStudyHours)}ì‹œê°„
                        </span>
                      </div>
                    ) : (
                      // ì¼ë°˜ í•™ìŠµì¼/ë³µìŠµì¼ì¸ ê²½ìš° í•™ìŠµ ì‹œê°„ê³¼ ììœ¨í•™ìŠµ ì‹œê°„ ë³„ë„ í‘œê¸°
                      <>
                        <div className="flex items-center gap-4">
                          <span className="font-medium">
                            í•™ìŠµ ì‹œê°„: {formatNumber(studyHours)}ì‹œê°„
                          </span>
                          {selfStudyHours > 0 && (
                            <span>
                              ììœ¨ í•™ìŠµ ì‹œê°„: {formatNumber(selfStudyHours)}ì‹œê°„
                            </span>
                          )}
                          {datePlans.length > 0 && (
                            <span>í”Œëœ: {datePlans.length}ê°œ</span>
                          )}
                        </div>
                        {(travelHours > 0 || academyHours > 0) && (
                          <div className="flex items-center gap-4">
                            {travelHours > 0 && (
                              <span>
                                ì´ë™ì‹œê°„: {formatNumber(travelHours)}ì‹œê°„
                              </span>
                            )}
                            {academyHours > 0 && (
                              <span>
                                í•™ì› ì‹œê°„: {formatNumber(academyHours)}ì‹œê°„
                              </span>
                            )}
                          </div>
                        )}
                      </>
                    )}

                    {/* íƒ€ì„ë¼ì¸ ë°” ê·¸ë˜í”„ */}
                    {schedule.time_slots && schedule.time_slots.length > 0 && (
                      <TimelineBar
                        timeSlots={schedule.time_slots}
                        totalHours={
                          studyHours +
                          selfStudyHours +
                          travelHours +
                          academyHours
                        }
                      />
                    )}
                  </div>
                );
              })()}
              {schedule.note && (
                <div className="text-xs text-gray-600">
                  {schedule.note}
                </div>
              )}
              </div>
            </div>
            {(hasDetails || hasExclusion || hasTimeSlots) && (
              <div className="flex-shrink-0 relative z-10">
                {isExpanded ? (
                  <ChevronUp className="h-5 w-5 text-gray-600" />
                ) : (
                  <ChevronDown className="h-5 w-5 text-gray-600" />
                )}
              </div>
            )}
          </div>
        </div>

        {/* í™•ì¥ëœ ìƒì„¸ ì •ë³´ */}
        {isExpanded && (hasDetails || hasExclusion || hasTimeSlots) && (
          <div className="border-t border-gray-100 bg-gray-50 px-4 py-3">
            <div className="flex flex-col gap-4">
              {/* ì‹œê°„ íƒ€ì„ë¼ì¸ */}
              {hasTimeSlots && schedule.time_slots && (
                <div className="flex flex-col gap-2">
                  <div className="flex items-center gap-2">
                    <Clock className="h-4 w-4 text-gray-600" />
                    <div className="text-xs font-medium text-gray-600">
                      ì‹œê°„ êµ¬ì„±
                    </div>
                  </div>
                  <div className="pl-6 flex flex-col gap-1.5">
                    <TimeSlotsWithPlans
                      timeSlots={schedule.time_slots}
                      date={schedule.date}
                      datePlans={datePlans}
                      contents={contents}
                      blocks={blocks}
                      dayType={schedule.day_type}
                      totalStudyHours={schedule.study_hours}
                      sequenceMap={sequenceMap}
                    />
                  </div>
                </div>
              )}

              {/* ì œì™¸ì¼ ì •ë³´ */}
              {hasExclusion && schedule.exclusion && (
                <div className="flex items-start gap-2">
                  <XCircle className="h-4 w-4 flex-shrink-0 text-gray-600 self-start" />
                  <div className="flex-1">
                    <div className="flex flex-col gap-1">
                      <div className="text-xs font-medium text-gray-600">
                        {schedule.exclusion.exclusion_type === "íœ´ê°€"
                          ? "íœ´ê°€"
                          : schedule.exclusion.exclusion_type === "ê°œì¸ì‚¬ì •"
                          ? "ê°œì¸ì‚¬ì •"
                          : schedule.exclusion.exclusion_type === "íœ´ì¼ì§€ì •"
                          ? "ì§€ì •íœ´ì¼"
                          : "ì œì™¸ì¼"}
                      </div>
                      {schedule.exclusion.reason && (
                        <div className="text-xs text-gray-600">
                          {schedule.exclusion.reason}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* í•™ì›ì¼ì • ì •ë³´ */}
              {hasDetails && schedule.academy_schedules && (
                <div className="flex flex-col gap-2">
                  <div className="flex items-center gap-2">
                    <Calendar className="h-4 w-4 text-gray-600" />
                    <div className="text-xs font-medium text-gray-600">
                      í•™ì›ì¼ì • ({schedule.academy_schedules.length}ê°œ)
                    </div>
                  </div>
                  <div className="pl-6 flex flex-col gap-1.5">
                    {schedule.academy_schedules.map((academy, idx) => (
                      <div
                        key={idx}
                        className="rounded border border-gray-200 bg-white px-2 py-1.5 text-xs"
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-1 font-medium text-gray-900">
                            <span>{academy.academy_name || "í•™ì›"}</span>
                            {academy.subject && (
                              <span className="text-gray-600">
                                ({academy.subject})
                              </span>
                            )}
                          </div>
                          <div className="text-gray-600">
                            {academy.start_time} ~ {academy.end_time}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    );
  },
  (prevProps, nextProps) => {
    // ì»¤ìŠ¤í…€ ë¹„êµ í•¨ìˆ˜ë¡œ ë¶ˆí•„ìš”í•œ ì¬ë Œë”ë§ ë°©ì§€
    return (
      prevProps.schedule.date === nextProps.schedule.date &&
      prevProps.isExpanded === nextProps.isExpanded &&
      prevProps.datePlans.length === nextProps.datePlans.length &&
      prevProps.sequenceMap.size === nextProps.sequenceMap.size &&
      prevProps.schedule.day_type === nextProps.schedule.day_type &&
      prevProps.schedule.study_hours === nextProps.schedule.study_hours
    );
  }
);
</file>

<file path="new-group/_components/Step7ScheduleResult/ScheduleListByWeek.tsx">
import { useRef, useState, useCallback, useMemo, useEffect } from "react";
import { VariableSizeList as List } from "react-window";
import type { DailySchedule, Plan } from "./scheduleTypes";
import type { ContentData, BlockData } from "../utils/scheduleTransform";
import { MeasureRow } from "./MeasureRow";
import { WeekSection } from "./WeekSection";

// ì£¼ì°¨ë³„ ê·¸ë£¹í™” ì»´í¬ë„ŒíŠ¸
export function ScheduleListByWeek({
  height,
  width,
  schedules,
  plansByDate,
  contents,
  blocks,
  sequenceMap,
  expandedDates,
  onToggleDate,
}: {
  height: number;
  width: number;
  schedules: DailySchedule[];
  plansByDate: Map<string, Plan[]>;
  contents: Map<string, ContentData>;
  blocks: BlockData[];
  sequenceMap: Map<string, number>;
  expandedDates: Map<string, boolean>;
  onToggleDate: (date: string) => void;
}) {
  // ì£¼ì°¨ë³„ë¡œ ê·¸ë£¹í™”
  const schedulesByWeek = useMemo(() => {
    const map = new Map<number | undefined, DailySchedule[]>();
    for (const schedule of schedules) {
      const weekNum = schedule.week_number;
      if (!map.has(weekNum)) {
        map.set(weekNum, []);
      }
      map.get(weekNum)!.push(schedule);
    }
    return map;
  }, [schedules]);

  // ì£¼ì°¨ ë²ˆí˜¸ë¡œ ì •ë ¬ (undefinedëŠ” ë§ˆì§€ë§‰)
  const sortedWeeks = useMemo(() => {
    return Array.from(schedulesByWeek.entries()).sort((a, b) => {
      if (a[0] === undefined) return 1;
      if (b[0] === undefined) return -1;
      return a[0] - b[0];
    });
  }, [schedulesByWeek]);

  const listRef = useRef<List>(null);
  const sizeMap = useRef<Map<number, number>>(new Map());
  // WeekSection ìì²´ì˜ expand ìƒíƒœë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ Map
  const [expandedWeeks, setExpandedWeeks] = useState<Map<string, boolean>>(
    new Map()
  );

  const toggleWeek = useCallback((weekKey: string) => {
    setExpandedWeeks((prev) => {
      const next = new Map(prev);
      next.set(weekKey, !next.get(weekKey));
      return next;
    });
  }, []);

  const setSize = useCallback((index: number, size: number) => {
    if (sizeMap.current.get(index) !== size) {
      sizeMap.current.set(index, size);
      listRef.current?.resetAfterIndex(index);
    }
  }, []);

  const getSize = useCallback((index: number) => {
    return sizeMap.current.get(index) || 120; // Default week height
  }, []);

  // í™•ì¥ ìƒíƒœ ë³€ê²½ ì‹œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  
  // (í•˜ìœ„ ë‚ ì§œê°€ í† ê¸€ë˜ì–´ë„ ë†’ì´ê°€ ë³€í•˜ë¯€ë¡œ expandedDates ì˜ì¡´ì„± í•„ìš”)
  useEffect(() => {
      if (listRef.current) {
        listRef.current.resetAfterIndex(0);
      }
  }, [expandedWeeks, expandedDates]);

  return (
    <List
      ref={listRef}
      height={height}
      width={width}
      itemCount={sortedWeeks.length}
      itemSize={getSize}
    >
      {({ index, style }: { index: number; style: React.CSSProperties }) => {
        const [weekNum, weekSchedules] = sortedWeeks[index];
        const weekKey = weekNum !== undefined ? String(weekNum) : "undefined";
        
        return (
          <div style={style}>
            <MeasureRow
              index={index}
              setSize={setSize}
              expandedKey={`${expandedWeeks.get(weekKey)}-${weekSchedules.map(d => expandedDates.get(d.date)).join(',')}`}
            >
              <WeekSection
                weekNum={weekNum}
                schedules={weekSchedules}
                plansByDate={plansByDate}
                contents={contents}
                blocks={blocks}
                sequenceMap={sequenceMap}
                expandedDates={expandedDates}
                onToggleDate={onToggleDate}
                isExpanded={expandedWeeks.get(weekKey) ?? false}
                onToggleWeek={() => toggleWeek(weekKey)}
              />
            </MeasureRow>
          </div>
        );
      }}
    </List>
  );
}
</file>

<file path="new-group/_components/Step7ScheduleResult/ScheduleTableView.tsx">
import {
  useState,
  useMemo,
  useCallback,
  useDeferredValue,
  useEffect,
  useRef,
} from "react";
import { VariableSizeList as List } from "react-window";
import AutoSizer from "react-virtualized-auto-sizer";
import type { BlockData, ContentData } from "../utils/scheduleTransform";
import type { DailySchedule, Plan } from "./scheduleTypes";
import { MeasureRow } from "./MeasureRow";
import { ScheduleItem } from "./ScheduleItem";
import { ScheduleListByWeek } from "./ScheduleListByWeek";

type ScheduleTableViewProps = {
  dailySchedule: DailySchedule[];
  plans: Plan[];
  contents: Map<string, ContentData>;
  blocks: BlockData[];
};

export function ScheduleTableView({
  dailySchedule,
  plans,
  contents,
  blocks,
}: ScheduleTableViewProps) {
  // useDeferredValueë¡œ í° ë°ì´í„°ì…‹ ì§€ì—° ì²˜ë¦¬
  const deferredDailySchedule = useDeferredValue(dailySchedule);
  const deferredPlans = useDeferredValue(plans);

  // ì£¼ì°¨ë³„ ê·¸ë£¹í™”ê°€ ê°€ëŠ¥í•œì§€ í™•ì¸
  const hasWeekNumbers = dailySchedule.some((s) => s.week_number !== undefined);

  // sequenceMap ì œê±° (ì„œë²„ ë°ì´í„° ì‚¬ìš©)
  const sequenceMap = useMemo(() => new Map<string, number>(), []);

  // ë‚ ì§œë³„ë¡œ í”Œëœ ê·¸ë£¹í™”
  const plansByDate = useMemo(() => {
    const map = new Map<string, Plan[]>();
    if (deferredPlans && Array.isArray(deferredPlans)) {
      deferredPlans.forEach((plan) => {
        if (!map.has(plan.plan_date)) {
          map.set(plan.plan_date, []);
        }
        map.get(plan.plan_date)!.push(plan);
      });
    }
    return map;
  }, [deferredPlans]);

  // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬ëœ ìŠ¤ì¼€ì¤„ (ì£¼ì°¨ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°)
  const sortedSchedules = useMemo(() => {
    if (hasWeekNumbers) return [];
    return [...(deferredDailySchedule || [])].sort(
      (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()
    );
  }, [deferredDailySchedule, hasWeekNumbers]);

  const [expandedDates, setExpandedDates] = useState<Map<string, boolean>>(
    new Map()
  );

  const toggleDate = useCallback((date: string) => {
    setExpandedDates((prev) => {
      const next = new Map(prev);
      next.set(date, !next.get(date));
      return next;
    });
  }, []);

  const listRef = useRef<List>(null);
  const sizeMap = useRef<Map<number, number>>(new Map());

  const setSize = useCallback((index: number, size: number) => {
    if (sizeMap.current.get(index) !== size) {
      sizeMap.current.set(index, size);
      listRef.current?.resetAfterIndex(index);
    }
  }, []);

  const getSize = useCallback((index: number) => {
    return sizeMap.current.get(index) || 80; // Default height
  }, []);

  // í™•ì¥ ìƒíƒœ ë³€ê²½ ì‹œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
  useEffect(() => {
    if (listRef.current) {
      listRef.current.resetAfterIndex(0);
    }
  }, [expandedDates]);

  if (!dailySchedule || dailySchedule.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
        <p className="text-sm text-gray-600">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  return (
    <div className="w-full h-[800px] rounded-lg border border-gray-200 bg-white flex flex-col">
      <div className="border-b border-gray-200 bg-gray-50 px-4 py-3 shrink-0">
        <h3 className="text-sm font-semibold text-gray-900">
          ì¼ë³„ ìŠ¤ì¼€ì¤„ ({dailySchedule.length}ì¼)
        </h3>
      </div>
      <div className="flex-1 min-h-0">
        <AutoSizer>
          {({ height, width }) =>
            hasWeekNumbers ? (
              <ScheduleListByWeek
                height={height}
                width={width}
                schedules={deferredDailySchedule}
                plansByDate={plansByDate}
                contents={contents}
                blocks={blocks}
                sequenceMap={sequenceMap}
                expandedDates={expandedDates}
                onToggleDate={toggleDate}
              />
            ) : (
              <List
                ref={listRef}
                height={height}
                width={width}
                itemCount={sortedSchedules.length}
                itemSize={getSize}
              >
                {({
                  index,
                  style,
                }: {
                  index: number;
                  style: React.CSSProperties;
                }) => {
                  const schedule = sortedSchedules[index];
                  const datePlans = plansByDate.get(schedule.date) || [];
                  return (
                    <div style={style}>
                      <MeasureRow
                        index={index}
                        setSize={setSize}
                        // Force re-measure when expanded changes
                        expandedKey={`${expandedDates.get(schedule.date)}`}
                      >
                        <ScheduleItem
                          schedule={schedule}
                          datePlans={datePlans}
                          contents={contents}
                          blocks={blocks}
                          sequenceMap={sequenceMap}
                          isExpanded={expandedDates.get(schedule.date) ?? false}
                          onToggle={() => toggleDate(schedule.date)}
                        />
                      </MeasureRow>
                    </div>
                  );
                }}
              </List>
            )
          }
        </AutoSizer>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step7ScheduleResult/scheduleTypes.ts">
import type { ContentData } from "../utils/scheduleTransform";

export type DailySchedule = {
  date: string;
  day_type: string;
  study_hours: number;
  week_number?: number; // ì£¼ì°¨ ë²ˆí˜¸ (ì„ íƒì )
  time_slots?: Array<{
    type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
    start: string;
    end: string;
    label?: string;
  }>;
  exclusion?: {
    exclusion_type: string;
    reason?: string;
  } | null;
  academy_schedules?: Array<{
    academy_name?: string;
    subject?: string;
    start_time: string;
    end_time: string;
  }>;
  note?: string; // ì¼ì • ë©”ëª¨
};

export type Plan = {
  id: string;
  plan_date: string;
  block_index: number | null;
  content_type: string;
  content_id: string;
  chapter: string | null;
  planned_start_page_or_time: number | null;
  planned_end_page_or_time: number | null;
  completed_amount: number | null;
  plan_number: number | null;
  sequence: number | null;
};
</file>

<file path="new-group/_components/Step7ScheduleResult/scheduleUtils.ts">
import type { BlockData, ContentData } from "../utils/scheduleTransform";
import type { Plan } from "./scheduleTypes";
import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";

export const dayTypeLabels: Record<string, string> = {
  í•™ìŠµì¼: "í•™ìŠµì¼",
  ë³µìŠµì¼: "ë³µìŠµì¼",
  ì§€ì •íœ´ì¼: "ì§€ì •íœ´ì¼",
  íœ´ê°€: "íœ´ê°€",
  ê°œì¸ì¼ì •: "ê°œì¸ì¼ì •",
};

export const dayTypeColors: Record<string, string> = {
  í•™ìŠµì¼: "bg-blue-100 text-blue-800 border-blue-200",
  ë³µìŠµì¼: "bg-green-100 text-green-800 border-green-200",
  ì§€ì •íœ´ì¼: "bg-yellow-100 text-yellow-800 border-yellow-200",
  íœ´ê°€: "bg-gray-100 text-gray-800 border-gray-200",
  ê°œì¸ì¼ì •: "bg-purple-100 text-purple-800 border-purple-200",
};

export function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

export function minutesToTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}

export function getPlanStartTime(
  plan: Plan,
  date: string,
  blocks: BlockData[]
): string | null {
  if (plan.block_index !== null && plan.block_index !== undefined) {
    const planDate = new Date(date + "T00:00:00");
    const dayOfWeek = planDate.getDay();

    // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¸”ë¡ ì°¾ê¸°
    let block = blocks.find(
      (b) => b.day_of_week === dayOfWeek && b.block_index === plan.block_index
    );

    // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¸”ë¡ì´ ì—†ìœ¼ë©´ ê°™ì€ ìš”ì¼ì˜ ë¸”ë¡ ì¤‘ì—ì„œ ì°¾ê¸°
    if (!block) {
      const dayBlocks = blocks.filter((b) => b.day_of_week === dayOfWeek);
      if (dayBlocks.length > 0) {
        const sortedBlocks = [...dayBlocks].sort(
          (a, b) => a.block_index - b.block_index
        );
        // block_indexê°€ ë²”ìœ„ ë‚´ì— ìˆìœ¼ë©´ í•´ë‹¹ ë¸”ë¡ ì‚¬ìš©
        if (plan.block_index > 0 && plan.block_index <= sortedBlocks.length) {
          block = sortedBlocks[plan.block_index - 1];
        } else if (sortedBlocks.length > 0) {
          // ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ì²« ë²ˆì§¸ ë¸”ë¡ ì‚¬ìš©
          block = sortedBlocks[0];
        }
      }
    }

    if (block) {
      return block.start_time;
    }
  }

  return null;
}

export function calculateEstimatedTime(
  plan: Plan,
  contents: Map<string, ContentData>,
  dayType?: string
): number {
  const content = contents.get(plan.content_id);

  if (
    plan.planned_start_page_or_time === null ||
    plan.planned_end_page_or_time === null
  ) {
    const baseTime = 60; // ê¸°ë³¸ê°’ 1ì‹œê°„
    // ë³µìŠµì¼ì´ë©´ ì†Œìš”ì‹œê°„ ë‹¨ì¶• (í•™ìŠµì¼ ëŒ€ë¹„ 50%ë¡œ ë‹¨ì¶•)
    return dayType === "ë³µìŠµì¼" ? Math.round(baseTime * 0.5) : baseTime;
  }

  const amount =
    plan.planned_end_page_or_time - plan.planned_start_page_or_time;
  if (amount <= 0) {
    const baseTime = 60;
    return dayType === "ë³µìŠµì¼" ? Math.round(baseTime * 0.5) : baseTime;
  }

  let baseTime = 0;

  if (plan.content_type === "book") {
    // ì±…: ì„¤ì • ê¸°ë°˜ ì‹œê°„ ê³„ì‚°
    const pagesPerHour = defaultRangeRecommendationConfig.pagesPerHour;
    const minutesPerPage = 60 / pagesPerHour;
    baseTime = Math.round(amount * minutesPerPage);
  } else if (plan.content_type === "lecture") {
    // ê°•ì˜: duration ì •ë³´ ì‚¬ìš©
    if (content?.duration && content.duration > 0) {
      // ì´ durationì„ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” episodeë³„ durationì´ í•„ìš”í•  ìˆ˜ ìˆìŒ)
      // ê°•ì˜ì˜ ê²½ìš° planned_start_page_or_timeê³¼ planned_end_page_or_timeì´ íšŒì°¨ë¥¼ ë‚˜íƒ€ëƒ„
      // ì˜ˆ: 1ê°•, 2ê°• -> durationì„ íšŒì°¨ ìˆ˜ë¡œ ë‚˜ëˆ ì„œ ê³„ì‚°
      const episodeCount = amount; // íšŒì°¨ ìˆ˜
      const totalDuration = content.duration;
      // íšŒì°¨ë‹¹ í‰ê·  ì‹œê°„ ê³„ì‚° (ë” ì •í™•í•œ ê³„ì‚°ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ)
      baseTime = Math.round(totalDuration / Math.max(episodeCount, 1));
    } else {
      baseTime = 60; // ê¸°ë³¸ê°’
    }
  } else {
    baseTime = 60; // ê¸°ë³¸ê°’
  }

  // ë³µìŠµì¼ì´ë©´ ì†Œìš”ì‹œê°„ ë‹¨ì¶• (í•™ìŠµì¼ ëŒ€ë¹„ 50%ë¡œ ë‹¨ì¶•)
  if (dayType === "ë³µìŠµì¼") {
    return Math.round(baseTime * 0.5);
  }

  return baseTime;
}
</file>

<file path="new-group/_components/Step7ScheduleResult/TimelineBar.tsx">
"use client";

type TimeSlot = {
  type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
  start: string;
  end: string;
  label?: string;
};

type TimelineBarProps = {
  timeSlots: TimeSlot[];
  totalHours: number;
};

// ì‹œê°„ ë¬¸ìì—´(HH:mm)ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

// ê° íƒ€ì…ë³„ ìƒ‰ìƒ ë§¤í•‘
const slotColors: Record<TimeSlot["type"], string> = {
  í•™ìŠµì‹œê°„: "bg-blue-500",
  ì ì‹¬ì‹œê°„: "bg-orange-400",
  í•™ì›ì¼ì •: "bg-purple-500",
  ì´ë™ì‹œê°„: "bg-gray-400",
  ììœ¨í•™ìŠµ: "bg-green-500",
};

// ê° íƒ€ì…ë³„ ë¼ë²¨
const slotLabels: Record<TimeSlot["type"], string> = {
  í•™ìŠµì‹œê°„: "í•™ìŠµ",
  ì ì‹¬ì‹œê°„: "ì ì‹¬",
  í•™ì›ì¼ì •: "í•™ì›",
  ì´ë™ì‹œê°„: "ì´ë™",
  ììœ¨í•™ìŠµ: "ììœ¨",
};

export function TimelineBar({ timeSlots, totalHours }: TimelineBarProps) {
  if (!timeSlots || timeSlots.length === 0) {
    return null;
  }

  // ê° ìŠ¬ë¡¯ì˜ ì‹œê°„(ë¶„)ê³¼ ë¹„ìœ¨ ê³„ì‚°
  const slotData = timeSlots.map((slot) => {
    const startMinutes = timeToMinutes(slot.start);
    const endMinutes = timeToMinutes(slot.end);
    const durationMinutes = endMinutes - startMinutes;
    const durationHours = durationMinutes / 60;

    return {
      type: slot.type,
      durationMinutes,
      durationHours,
      label: slot.label,
      start: slot.start,
      end: slot.end,
    };
  });

  // ì „ì²´ ì‹œê°„(ë¶„)
  const totalMinutes = slotData.reduce((sum, slot) => sum + slot.durationMinutes, 0);

  // ë¹„ìœ¨ ê³„ì‚° ë° ìµœì†Œ ë„ˆë¹„ ì ìš© í›„ ì¬ì •ê·œí™”
  const minWidthPercentage = 3; // ìµœì†Œ 3%
  const rawPercentages = slotData.map((slot) => ({
    ...slot,
    rawPercentage: (slot.durationMinutes / totalMinutes) * 100,
  }));

  // ìµœì†Œ ë„ˆë¹„ ì ìš©
  const adjustedPercentages = rawPercentages.map((item) => ({
    ...item,
    adjustedPercentage: Math.max(item.rawPercentage, minWidthPercentage),
  }));

  // ì´í•© ê³„ì‚°
  const totalAdjusted = adjustedPercentages.reduce(
    (sum, item) => sum + item.adjustedPercentage,
    0
  );

  // 100%ë¡œ ì¬ì •ê·œí™” (ë¹ˆ ê³µê°„ ì œê±°)
  const normalizedPercentages = adjustedPercentages.map((item) => ({
    ...item,
    finalPercentage: (item.adjustedPercentage / totalAdjusted) * 100,
  }));

  // grid-template-columns ë¬¸ìì—´ ìƒì„± (fr ë‹¨ìœ„ ì‚¬ìš©)
  const gridTemplateColumns = normalizedPercentages
    .map((item) => `${item.finalPercentage}fr`)
    .join(" ");

  // aria-labelìš© ì„¤ëª… ìƒì„±
  const ariaLabel = slotData
    .map((slot) => `${slotLabels[slot.type]} ${slot.durationHours.toFixed(1)}ì‹œê°„`)
    .join(", ");

  return (
    <div className="flex flex-col gap-1.5 w-full" aria-label={`ì¼ì • êµ¬ì„±: ${ariaLabel}`}>
      <div 
        className="grid h-6 md:h-8 w-full overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm"
        style={{ gridTemplateColumns }}
      >
        {normalizedPercentages.map((item, index) => {
          // 30ë¶„ ë¯¸ë§Œì€ ë¼ë²¨ ìƒëµ
          const showLabel = item.durationMinutes >= 30;
          
          // ì‹œê°„ ë¼ë²¨ í¬ë§· (1ì‹œê°„ ë¯¸ë§Œì€ ë¶„ìœ¼ë¡œ, ì´ìƒì€ ì‹œê°„ìœ¼ë¡œ)
          const timeLabel = item.durationHours >= 1
            ? `${item.durationHours.toFixed(1)}h`
            : `${item.durationMinutes}m`;

          return (
            <div
              key={`${item.type}-${index}`}
              className={`flex items-center justify-center ${slotColors[item.type]} text-white transition-all`}
              title={`${slotLabels[item.type]}: ${item.durationHours.toFixed(1)}ì‹œê°„ (${item.start} - ${item.end})`}
            >
              {showLabel && (
                <span className="text-[10px] md:text-xs font-semibold truncate px-1">
                  {timeLabel}
                </span>
              )}
            </div>
          );
        })}
      </div>
      
      {/* ë²”ë¡€ (íƒ€ì…ë³„ ìƒ‰ìƒ ì•ˆë‚´) - í† ê¸€ ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì œê±°í•˜ê±°ë‚˜ ìµœì†Œí™” */}
      {slotData.length > 0 && (
        <div className="flex flex-wrap gap-2 text-[10px] text-gray-600 max-w-full">
          {Array.from(new Set(slotData.map(s => s.type))).map((type) => (
            <div key={type} className="flex items-center gap-1 flex-shrink-0">
              <div className={`w-2 h-2 rounded-sm ${slotColors[type]}`} />
              <span className="whitespace-nowrap">{slotLabels[type]}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/Step7ScheduleResult/TimeSlotsWithPlans.tsx">
import { memo, useMemo } from "react";
import type { BlockData, ContentData } from "../utils/scheduleTransform";
import type { Plan } from "./scheduleTypes";
import {
  timeToMinutes,
  minutesToTime,
  getPlanStartTime,
  calculateEstimatedTime,
} from "./scheduleUtils";
import { PlanTable } from "./PlanTable";

// ëª¨ë“  ì‹œê°„ ìŠ¬ë¡¯ê³¼ í”Œëœì„ í•¨ê»˜ ì²˜ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
export const TimeSlotsWithPlans = memo(
  function TimeSlotsWithPlans({
    timeSlots,
    date,
    datePlans,
    contents,
    blocks,
    dayType,
    totalStudyHours,
    sequenceMap,
  }: {
    timeSlots: Array<{
      type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
      start: string;
      end: string;
      label?: string;
    }>;
    date: string;
    datePlans: Plan[];
    contents: Map<string, ContentData>;
    blocks: BlockData[];
    dayType: string;
    totalStudyHours: number;
    sequenceMap: Map<string, number>;
  }) {
    // í•™ìŠµì‹œê°„ê³¼ ììœ¨í•™ìŠµ ë¸”ë¡ í•„í„°ë§ (ë©”ëª¨ì´ì œì´ì…˜)
    const studyTimeSlots = useMemo(
      () =>
        timeSlots.filter(
          (slot) => slot.type === "í•™ìŠµì‹œê°„" || slot.type === "ììœ¨í•™ìŠµ"
        ),
      [timeSlots]
    );

    // ì´ë™ì‹œê°„ê³¼ í•™ì›ì¼ì • ìŠ¬ë¡¯ í•„í„°ë§ (ë©”ëª¨ì´ì œì´ì…˜)
    const travelAndAcademySlots = useMemo(
      () =>
        timeSlots.filter(
          (slot) => slot.type === "ì´ë™ì‹œê°„" || slot.type === "í•™ì›ì¼ì •"
        ),
      [timeSlots]
    );

    // í”Œëœ ì •ë³´ ì¤€ë¹„ (ë©”ëª¨ì´ì œì´ì…˜)
    const plansWithInfo = useMemo(() => {
      const plans = datePlans.map((plan) => {
        const startTime = getPlanStartTime(plan, date, blocks);
        const estimatedTime = calculateEstimatedTime(plan, contents, dayType);
        return {
          plan,
          originalStartTime: startTime ? timeToMinutes(startTime) : null,
          originalEstimatedTime: estimatedTime, // ì›ë˜ ì˜ˆìƒ ì†Œìš”ì‹œê°„ ì €ì¥
          estimatedTime, // ë°°ì¹˜ì— ì‚¬ìš©í•  ì‹œê°„
          remainingTime: estimatedTime, // ë‚¨ì€ ì‹œê°„ ì¶”ì 
          blockIndex: plan.block_index,
        };
      });

      // ë³µìŠµì¼ì´ê³  ì˜ˆìƒ ì†Œìš”ì‹œê°„ì´ ì´ í•™ìŠµì‹œê°„ë³´ë‹¤ í° ê²½ìš° í‰ê·  ì‹œê°„ìœ¼ë¡œ ì¡°ì •
      const isReviewDay = dayType === "ë³µìŠµì¼";
      const totalEstimatedTime = plans.reduce(
        (sum, p) => sum + p.originalEstimatedTime,
        0
      );
      const totalStudyMinutes = totalStudyHours * 60;

      if (
        isReviewDay &&
        totalEstimatedTime > totalStudyMinutes &&
        datePlans.length > 0
      ) {
        // í‰ê·  ì‹œê°„ ê³„ì‚°
        const averageTime = Math.floor(totalStudyMinutes / datePlans.length);
        plans.forEach((p) => {
          p.estimatedTime = averageTime;
          p.remainingTime = averageTime;
          // originalEstimatedTimeì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ê°•ì¡° í‘œì‹œìš©)
        });
      }

      return plans;
    }, [datePlans, date, blocks, contents, dayType, totalStudyHours]);

    // í”Œëœì„ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬ (ë©”ëª¨ì´ì œì´ì…˜)
    const sortedPlans = useMemo(() => {
      return [...plansWithInfo].sort((a, b) => {
        if (a.originalStartTime !== null && b.originalStartTime !== null) {
          return a.originalStartTime - b.originalStartTime;
        }
        if (a.originalStartTime !== null) return -1;
        if (b.originalStartTime !== null) return 1;
        return (a.blockIndex || 0) - (b.blockIndex || 0);
      });
    }, [plansWithInfo]);

    // ê° í•™ìŠµì‹œê°„ ë¸”ë¡ì— í”Œëœ ë°°ì¹˜ (ë©”ëª¨ì´ì œì´ì…˜)
    const slotPlansMap = useMemo(() => {
      const map = new Map<
        number,
        Array<{
          plan: Plan;
          start: string;
          end: string;
          isPartial: boolean;
          isContinued: boolean; // ì´ì „ ë¸”ë¡ì—ì„œ ì´ì–´ì§€ëŠ”ì§€
          originalEstimatedTime: number; // ì›ë˜ ì˜ˆìƒ ì†Œìš”ì‹œê°„
        }>
      >();

      // ê° ìŠ¬ë¡¯ì— í”Œëœ ë°°ì¹˜ (ê°™ì€ ë‚  ëª¨ë“  í”Œëœ ìš°ì„  ë°°ì¹˜)
      // plansWithInfoë¥¼ ë³µì‚¬í•˜ì—¬ remainingTimeì„ ì¶”ì 
      const plansWithRemainingTime = sortedPlans.map((p) => ({
        ...p,
        remainingTime: p.estimatedTime,
      }));

      studyTimeSlots.forEach((slot, slotIdx) => {
        const slotStart = timeToMinutes(slot.start);
        const slotEnd = timeToMinutes(slot.end);
        const plansInSlot: Array<{
          plan: Plan;
          start: string;
          end: string;
          isPartial: boolean;
          isContinued: boolean;
          originalEstimatedTime: number;
        }> = [];

        // ì‹œì‘ ì‹œê°„ì´ ìˆëŠ” í”Œëœë“¤ ë°°ì¹˜
        for (const planInfo of plansWithRemainingTime) {
          if (planInfo.remainingTime <= 0) continue;

          if (planInfo.originalStartTime !== null) {
            const planStart = planInfo.originalStartTime;
            const planEnd = planStart + planInfo.originalEstimatedTime; // ì›ë˜ ì˜ˆìƒ ì‹œê°„ ì‚¬ìš©

            // í”Œëœì´ ì´ ìŠ¬ë¡¯ê³¼ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
            if (planStart < slotEnd && planEnd > slotStart) {
              const slotAvailableStart = Math.max(planStart, slotStart);
              const slotAvailableEnd = Math.min(
                planStart + planInfo.remainingTime,
                slotEnd
              );

              if (slotAvailableStart < slotAvailableEnd) {
                const timeUsed = slotAvailableEnd - slotAvailableStart;
                const wasPartial =
                  planInfo.remainingTime < planInfo.originalEstimatedTime;

                plansInSlot.push({
                  plan: planInfo.plan,
                  start: minutesToTime(slotAvailableStart),
                  end: minutesToTime(slotAvailableEnd),
                  isPartial: planInfo.remainingTime > timeUsed,
                  isContinued: wasPartial, // ì´ì „ ë¸”ë¡ì—ì„œ ì´ì–´ì§€ëŠ”ì§€
                  originalEstimatedTime: planInfo.originalEstimatedTime,
                });
                planInfo.remainingTime -= timeUsed;
              }
            }
          }
        }

        // ì‹œì‘ ì‹œê°„ì´ ì—†ëŠ” í”Œëœë“¤ ë°°ì¹˜ (ê°™ì€ ë‚  ëª¨ë“  í”Œëœ ìš°ì„  ë°°ì¹˜)
        let currentTime = slotStart;
        for (const planInfo of plansWithRemainingTime) {
          if (planInfo.remainingTime <= 0) continue;
          if (planInfo.originalStartTime !== null) continue; // ì´ë¯¸ ë°°ì¹˜ëœ í”Œëœì€ ìŠ¤í‚µ

          const timeToUse = Math.min(
            planInfo.remainingTime,
            slotEnd - currentTime
          );
          if (timeToUse > 0) {
            const wasPartial =
              planInfo.remainingTime < planInfo.originalEstimatedTime;
            const willBePartial = planInfo.remainingTime > timeToUse;

            plansInSlot.push({
              plan: planInfo.plan,
              start: minutesToTime(currentTime),
              end: minutesToTime(currentTime + timeToUse),
              isPartial: willBePartial,
              isContinued: wasPartial, // ì´ì „ ë¸”ë¡ì—ì„œ ì´ì–´ì§€ëŠ”ì§€
              originalEstimatedTime: planInfo.originalEstimatedTime,
            });
            planInfo.remainingTime -= timeToUse;
            currentTime += timeToUse;

            if (currentTime >= slotEnd) break;
          }
        }

        // ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
        plansInSlot.sort(
          (a, b) => timeToMinutes(a.start) - timeToMinutes(b.start)
        );

        if (plansInSlot.length > 0) {
          map.set(slotIdx, plansInSlot);
        }
      });

      return map;
    }, [studyTimeSlots, sortedPlans]);

    // ê° í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì—ì„œ ë‚¨ì€ ì‹œê°„ ì˜ì—­ ê³„ì‚° (ë©”ëª¨ì´ì œì´ì…˜)
    const remainingTimeSlotsMap = useMemo(() => {
      const map = new Map<
        number,
        Array<{
          start: string;
          end: string;
          type: "í•™ìŠµì‹œê°„" | "ììœ¨í•™ìŠµ";
        }>
      >();

      studyTimeSlots.forEach((slot, slotIdx) => {
        const slotStart = timeToMinutes(slot.start);
        const slotEnd = timeToMinutes(slot.end);
        const plansInSlot = slotPlansMap.get(slotIdx) || [];

        // í”Œëœì´ ë°°ì¹˜ëœ ì‹œê°„ êµ¬ê°„ë“¤
        const usedRanges: Array<{ start: number; end: number }> = [];
        plansInSlot.forEach((plan) => {
          usedRanges.push({
            start: timeToMinutes(plan.start),
            end: timeToMinutes(plan.end),
          });
        });

        // ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
        usedRanges.sort((a, b) => a.start - b.start);

        // ë‚¨ì€ ì‹œê°„ êµ¬ê°„ ê³„ì‚°
        const remainingRanges: Array<{ start: string; end: string }> = [];
        let currentTime = slotStart;

        usedRanges.forEach((range) => {
          if (currentTime < range.start) {
            // í”Œëœ ë°°ì¹˜ ì „ ë‚¨ì€ ì‹œê°„
            remainingRanges.push({
              start: minutesToTime(currentTime),
              end: minutesToTime(range.start),
            });
          }
          currentTime = Math.max(currentTime, range.end);
        });

        // ë§ˆì§€ë§‰ í”Œëœ ì´í›„ ë‚¨ì€ ì‹œê°„
        if (currentTime < slotEnd) {
          remainingRanges.push({
            start: minutesToTime(currentTime),
            end: minutesToTime(slotEnd),
          });
        }

        if (remainingRanges.length > 0) {
          map.set(
            slotIdx,
            remainingRanges.map((range) => ({
              ...range,
              type: slot.type as "í•™ìŠµì‹œê°„" | "ììœ¨í•™ìŠµ",
            }))
          );
        }
      });

      return map;
    }, [studyTimeSlots, slotPlansMap]);

    // ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ì— ì»¤ìŠ¤í…€ í”Œëœ ë°°ì¹˜ (ë©”ëª¨ì´ì œì´ì…˜)
    const travelAndAcademyPlansMap = useMemo(() => {
      const map = new Map<
        number,
        Array<{
          plan: Plan;
          start: string;
          end: string;
          isPartial: boolean;
          isContinued: boolean;
          originalEstimatedTime: number;
        }>
      >();

      // ì»¤ìŠ¤í…€ í”Œëœë§Œ ë³„ë„ë¡œ ì²˜ë¦¬ (ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ì— ë°°ì¹˜)
      const customPlansWithInfo = plansWithInfo.filter(
        (p) => p.plan.content_type === "custom"
      );

      travelAndAcademySlots.forEach((slot, slotIdx) => {
        const slotStart = timeToMinutes(slot.start);
        const slotEnd = timeToMinutes(slot.end);
        const plansInSlot: Array<{
          plan: Plan;
          start: string;
          end: string;
          isPartial: boolean;
          isContinued: boolean;
          originalEstimatedTime: number;
        }> = [];

        // ì»¤ìŠ¤í…€ í”Œëœ ì¤‘ì—ì„œ ì´ ìŠ¬ë¡¯ê³¼ ì‹œê°„ì´ ì¼ì¹˜í•˜ëŠ” í”Œëœ ì°¾ê¸°
        for (const planInfo of customPlansWithInfo) {
          // ì‹œì‘ ì‹œê°„ì´ ìˆëŠ” ê²½ìš°: ìŠ¬ë¡¯ê³¼ ì‹œê°„ì´ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
          if (planInfo.originalStartTime !== null) {
            const planStart = planInfo.originalStartTime;
            const planEnd = planStart + planInfo.originalEstimatedTime;

            // í”Œëœì´ ì´ ìŠ¬ë¡¯ê³¼ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
            if (planStart < slotEnd && planEnd > slotStart) {
              const slotAvailableStart = Math.max(planStart, slotStart);
              const slotAvailableEnd = Math.min(planEnd, slotEnd);

              if (slotAvailableStart < slotAvailableEnd) {
                plansInSlot.push({
                  plan: planInfo.plan,
                  start: minutesToTime(slotAvailableStart),
                  end: minutesToTime(slotAvailableEnd),
                  isPartial: false,
                  isContinued: false,
                  originalEstimatedTime: planInfo.originalEstimatedTime,
                });
              }
            }
          } else {
            // ì‹œì‘ ì‹œê°„ì´ ì—†ëŠ” ê²½ìš°: ìŠ¬ë¡¯ ì‹œê°„ì— ë§ì¶° ë°°ì¹˜
            // (ì´ë™ì‹œê°„/í•™ì›ì¼ì •ì€ ì¼ë°˜ì ìœ¼ë¡œ ì‹œê°„ì´ ê³ ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ)
            const timeToUse = Math.min(
              planInfo.estimatedTime,
              slotEnd - slotStart
            );
            if (timeToUse > 0) {
              plansInSlot.push({
                plan: planInfo.plan,
                start: slot.start,
                end: minutesToTime(slotStart + timeToUse),
                isPartial: planInfo.estimatedTime > timeToUse,
                isContinued: false,
                originalEstimatedTime: planInfo.originalEstimatedTime,
              });
            }
          }
        }

        if (plansInSlot.length > 0) {
          map.set(slotIdx, plansInSlot);
        }
      });

      return map;
    }, [travelAndAcademySlots, plansWithInfo]);

    // ëª¨ë“  ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ì—ì„œ ë°°ì¹˜ëœ í”Œëœ ID ìˆ˜ì§‘
    const placedPlanIds = new Set<string>();
    travelAndAcademyPlansMap.forEach((plans) => {
      plans.forEach((p) => {
        placedPlanIds.add(p.plan.id);
      });
    });

    // í•™ìŠµì‹œê°„ ë° ììœ¨í•™ìŠµ ë¸”ë¡ ì¸ë±ìŠ¤ ë§¤í•‘ (ë©”ëª¨ì´ì œì´ì…˜)
    const studySlotIndexMap = useMemo(() => {
      const map = new Map<number, number>();
      let studySlotIdx = 0;
      timeSlots.forEach((slot, idx) => {
        if (slot.type === "í•™ìŠµì‹œê°„" || slot.type === "ììœ¨í•™ìŠµ") {
          map.set(idx, studySlotIdx);
          studySlotIdx++;
        }
      });
      return map;
    }, [timeSlots]);

    // ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ ì¸ë±ìŠ¤ ë§¤í•‘ (ë©”ëª¨ì´ì œì´ì…˜)
    const travelAndAcademySlotIndexMap = useMemo(() => {
      const map = new Map<number, number>();
      let travelAndAcademySlotIdx = 0;
      timeSlots.forEach((slot, idx) => {
        if (slot.type === "ì´ë™ì‹œê°„" || slot.type === "í•™ì›ì¼ì •") {
          map.set(idx, travelAndAcademySlotIdx);
          travelAndAcademySlotIdx++;
        }
      });
      return map;
    }, [timeSlots]);

    return (
      <>
        {timeSlots.map((slot, idx) => {
          const getSlotColor = () => {
            switch (slot.type) {
              case "í•™ìŠµì‹œê°„":
                return "bg-blue-50 border-blue-200 text-blue-800";
              case "ì ì‹¬ì‹œê°„":
                return "bg-orange-50 border-orange-200 text-orange-800";
              case "í•™ì›ì¼ì •":
                return "bg-purple-50 border-purple-200 text-purple-800";
              case "ì´ë™ì‹œê°„":
                return "bg-gray-50 border-gray-200 text-gray-800";
              case "ììœ¨í•™ìŠµ":
                return "bg-green-50 border-green-200 text-green-800";
              default:
                return "bg-gray-50 border-gray-200 text-gray-800";
            }
          };

          // í•™ìŠµì‹œê°„ ë¸”ë¡ì¸ ê²½ìš° í•´ë‹¹ ì¸ë±ìŠ¤ë¡œ í”Œëœ ì°¾ê¸°
          const studySlotIdx = studySlotIndexMap.get(idx);
          const plansInStudySlot =
            slot.type === "í•™ìŠµì‹œê°„" && studySlotIdx !== undefined
              ? slotPlansMap.get(studySlotIdx) || []
              : [];

          // ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ì¸ ê²½ìš° ì»¤ìŠ¤í…€ í”Œëœ ì°¾ê¸°
          const travelAndAcademySlotIdx = travelAndAcademySlotIndexMap.get(idx);
          const plansInTravelAndAcademySlot =
            (slot.type === "ì´ë™ì‹œê°„" || slot.type === "í•™ì›ì¼ì •") &&
            travelAndAcademySlotIdx !== undefined
              ? travelAndAcademyPlansMap.get(travelAndAcademySlotIdx) || []
              : [];

          // í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì—ëŠ” ì»¤ìŠ¤í…€ì´ ì•„ë‹Œ í”Œëœë§Œ í‘œì‹œ
          // const nonCustomPlans = datePlans.filter(
          //   (p) => p.content_type !== "custom"
          // );
          // ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ì—ëŠ” ì»¤ìŠ¤í…€ í”Œëœë§Œ í‘œì‹œ
          const customPlans = datePlans.filter(
            (p) => p.content_type === "custom"
          );
          // ë°°ì¹˜ë˜ì§€ ì•Šì€ ì»¤ìŠ¤í…€ í”Œëœë§Œ í•„í„°ë§
          const unplacedCustomPlans = customPlans.filter(
            (p) => !placedPlanIds.has(p.id)
          );

          return (
            <div key={idx} className="flex flex-col gap-1.5">
              <div
                className={`rounded border px-3 py-2 text-xs ${getSlotColor()}`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="font-semibold">{idx + 1}.</span>
                    <span className="font-medium">
                      {slot.label || slot.type}
                    </span>
                  </div>
                  <span className="text-gray-600">
                    {slot.start} ~ {slot.end}
                  </span>
                </div>
              </div>
              {/* í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ */}
              {(slot.type === "í•™ìŠµì‹œê°„" || slot.type === "ììœ¨í•™ìŠµ") && (
                <>
                  {plansInStudySlot.length > 0 && (
                    <div className="pl-4 overflow-x-auto">
                      <PlanTable
                        plans={plansInStudySlot}
                        contents={contents}
                        dayType={dayType}
                        sequenceMap={sequenceMap}
                      />
                    </div>
                  )}
                  {/* ë‚¨ì€ í•™ìŠµ ì‹œê°„ ì˜ì—­ í‘œì‹œ (í”Œëœì´ ì¼ë¶€ë§Œ ë°°ì¹˜ëœ ê²½ìš°ë§Œ) */}
                  {(() => {
                    // í”Œëœì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë‚¨ì€ ì‹œê°„ ì˜ì—­ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ë°©ì§€)
                    if (plansInStudySlot.length === 0) {
                      return null;
                    }

                    const studySlotIdx = studySlotIndexMap.get(idx);
                    const remainingRanges =
                      studySlotIdx !== undefined
                        ? remainingTimeSlotsMap.get(studySlotIdx) || []
                        : [];

                    // í”Œëœì´ ì¼ë¶€ë§Œ ë°°ì¹˜ë˜ì–´ ë‚¨ì€ ì˜ì—­ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
                    return remainingRanges.length > 0 ? (
                      <div className="pl-4 flex flex-col gap-1.5">
                        {remainingRanges.map((range, rangeIdx) => (
                          <div
                            key={rangeIdx}
                            className={`rounded border px-3 py-2 text-xs ${
                              range.type === "í•™ìŠµì‹œê°„"
                                ? "border-blue-200 bg-blue-50"
                                : "border-green-200 bg-green-50"
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <span
                                className={`font-medium ${
                                  range.type === "í•™ìŠµì‹œê°„"
                                    ? "text-blue-800"
                                    : "text-green-800"
                                }`}
                              >
                                {range.type === "í•™ìŠµì‹œê°„"
                                  ? "í•™ìŠµ ì‹œê°„"
                                  : "ììœ¨ í•™ìŠµ ì‹œê°„"}
                              </span>
                              <span
                                className={`${
                                  range.type === "í•™ìŠµì‹œê°„"
                                    ? "text-blue-800"
                                    : "text-green-600"
                                }`}
                              >
                                {range.start} ~ {range.end}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : null;
                  })()}
                </>
              )}
              {/* ì´ë™ì‹œê°„/í•™ì›ì¼ì • ìŠ¬ë¡¯ */}
              {(slot.type === "ì´ë™ì‹œê°„" || slot.type === "í•™ì›ì¼ì •") && (
                <>
                  {plansInTravelAndAcademySlot.length > 0 ? (
                    <div className="pl-4 overflow-x-auto">
                      <PlanTable
                        plans={plansInTravelAndAcademySlot}
                        contents={contents}
                        dayType={dayType}
                        sequenceMap={sequenceMap}
                      />
                    </div>
                  ) : unplacedCustomPlans.length > 0 ? (
                    <div className="pl-4 text-xs text-gray-600 italic">
                      (ì»¤ìŠ¤í…€ í”Œëœ {unplacedCustomPlans.length}ê°œ - ì‹œê°„ ì •ë³´
                      ì—†ìŒ)
                    </div>
                  ) : null}
                </>
              )}
            </div>
          );
        })}
      </>
    );
  },
  (prevProps, nextProps) => {
    // timeSlots, datePlans, dayTypeì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
    return (
      prevProps.date === nextProps.date &&
      prevProps.dayType === nextProps.dayType &&
      prevProps.totalStudyHours === nextProps.totalStudyHours &&
      prevProps.timeSlots.length === nextProps.timeSlots.length &&
      prevProps.datePlans.length === nextProps.datePlans.length &&
      prevProps.sequenceMap.size === nextProps.sequenceMap.size
    );
  }
);
</file>

<file path="new-group/_components/Step7ScheduleResult/WeekSection.tsx">
import {
  ChevronDown,
  ChevronUp,
} from "lucide-react";
import type { DailySchedule, Plan } from "./scheduleTypes";
import type { ContentData, BlockData } from "../utils/scheduleTransform";
import { formatNumber } from "@/lib/utils/formatNumber";
import { ScheduleItem } from "./ScheduleItem";

// ì£¼ì°¨ ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸
export function WeekSection({
  weekNum,
  schedules,
  plansByDate,
  contents,
  blocks,
  sequenceMap,
  expandedDates,
  onToggleDate,
  isExpanded,
  onToggleWeek,
}: {
  weekNum: number | undefined;
  schedules: DailySchedule[];
  plansByDate: Map<string, Plan[]>;
  contents: Map<string, ContentData>;
  blocks: BlockData[];
  sequenceMap: Map<string, number>;
  expandedDates: Map<string, boolean>;
  onToggleDate: (date: string) => void;
  isExpanded: boolean;
  onToggleWeek: () => void;
}) {
  if (weekNum === undefined) {
    // ì£¼ì°¨ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° (ì˜ˆì™¸ ìƒí™© ë³´ì •)
    return (
      <div>
        {schedules.map((schedule) => {
          const datePlans = plansByDate.get(schedule.date) || [];
          return (
            <ScheduleItem
              key={schedule.date}
              schedule={schedule}
              datePlans={datePlans}
              contents={contents}
              blocks={blocks}
              sequenceMap={sequenceMap}
              isExpanded={expandedDates.get(schedule.date) ?? false}
              onToggle={() => onToggleDate(schedule.date)}
            />
          );
        })}
      </div>
    );
  }

  const weekStart = schedules[0]?.date;
  const weekEnd = schedules[schedules.length - 1]?.date;
  const weekStartDate = weekStart ? new Date(weekStart) : null;
  const weekEndDate = weekEnd ? new Date(weekEnd) : null;

  const formatDateRange = () => {
    if (!weekStartDate || !weekEndDate) return "";
    return `${weekStart} ~ ${weekEnd}`;
  };

  const weekStudyDays = schedules.filter((s) => s.day_type === "í•™ìŠµì¼").length;
  const weekReviewDays = schedules.filter(
    (s) => s.day_type === "ë³µìŠµì¼"
  ).length;
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const weekExclusionDays = schedules.filter(
    (s) =>
      s.day_type === "íœ´ê°€" ||
      s.day_type === "ê°œì¸ì¼ì •" ||
      s.day_type === "ì§€ì •íœ´ì¼"
  ).length;

  // ì£¼ì°¨ë³„ ìˆœìˆ˜ í•™ìŠµ ì‹œê°„ ê³„ì‚° (time_slotsì—ì„œ "í•™ìŠµì‹œê°„" íƒ€ì…ë§Œ)
  const weekTotalHours = schedules.reduce((sum, s) => {
    // ì§€ì •íœ´ì¼ì€ í•™ìŠµ ì‹œê°„ì´ ì—†ìœ¼ë¯€ë¡œ ì œì™¸
    if (s.day_type === "ì§€ì •íœ´ì¼") return sum;
    if (!s.time_slots) return sum;
    const studyMinutes = s.time_slots
      .filter((slot) => slot.type === "í•™ìŠµì‹œê°„")
      .reduce((slotSum, slot) => {
        const [startHour, startMin] = slot.start.split(":").map(Number);
        const [endHour, endMin] = slot.end.split(":").map(Number);
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;
        return slotSum + (endMinutes - startMinutes);
      }, 0);
    return sum + studyMinutes / 60;
  }, 0);

  // ì£¼ì°¨ë³„ ììœ¨í•™ìŠµ ì‹œê°„ ê³„ì‚°
  // ì§€ì •íœ´ì¼ì˜ ê²½ìš° study_hoursê°€ ì´ë¯¸ ììœ¨í•™ìŠµ ì‹œê°„ì„ í¬í•¨í•˜ë¯€ë¡œ ì¤‘ë³µ ê³„ì‚° ë°©ì§€
  const weekSelfStudyHours = schedules.reduce((sum, s) => {
    // ì§€ì •íœ´ì¼ì¸ ê²½ìš° study_hoursê°€ ììœ¨í•™ìŠµ ì‹œê°„ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    if (s.day_type === "ì§€ì •íœ´ì¼") {
      return sum + s.study_hours;
    }
    // ì¼ë°˜ í•™ìŠµì¼/ë³µìŠµì¼ì˜ ê²½ìš° time_slotsì—ì„œ ììœ¨í•™ìŠµ ì‹œê°„ ê³„ì‚°
    if (!s.time_slots) return sum;
    const selfStudyMinutes = s.time_slots
      .filter((slot) => slot.type === "ììœ¨í•™ìŠµ")
      .reduce((slotSum, slot) => {
        const [startHour, startMin] = slot.start.split(":").map(Number);
        const [endHour, endMin] = slot.end.split(":").map(Number);
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;
        return slotSum + (endMinutes - startMinutes);
      }, 0);
    return sum + selfStudyMinutes / 60;
  }, 0);

  // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
  const sortedSchedules = [...schedules].sort(
    (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()
  );

  return (
    <div className="border-b border-gray-200 last:border-b-0">
      <button
        onClick={onToggleWeek}
        className="w-full bg-gray-50 px-4 py-3 text-left hover:bg-gray-100"
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            {isExpanded ? (
              <ChevronUp className="h-5 w-5 text-gray-600" />
            ) : (
              <ChevronDown className="h-5 w-5 text-gray-600" />
            )}
            <div className="flex flex-col gap-1">
              <div className="text-sm font-semibold text-gray-900">
                {weekNum}ì£¼ì°¨ {formatDateRange()}
              </div>
              <div className="flex flex-col gap-1">
                <div className="flex items-center gap-3 text-xs text-gray-600">
                  <span>
                    í•™ìŠµì¼ {weekStudyDays}ì¼
                    {weekReviewDays > 0 && <> + ë³µìŠµì¼ {weekReviewDays}ì¼</>}
                  </span>
                  <span>í•™ìŠµì‹œê°„ {formatNumber(weekTotalHours)}ì‹œê°„</span>
                  {weekSelfStudyHours > 0 && (
                    <span>
                      ììœ¨í•™ìŠµì‹œê°„ {formatNumber(weekSelfStudyHours)}ì‹œê°„
                    </span>
                  )}
                  <span>
                    ì´ì‹œê°„ {formatNumber(weekTotalHours + weekSelfStudyHours)}
                    ì‹œê°„
                  </span>
                </div>
                {weekStudyDays + weekReviewDays > 0 && (
                  <div className="text-xs text-gray-600">
                    í‰ê· :{" "}
                    {formatNumber(
                      (weekTotalHours + weekSelfStudyHours) /
                        (weekStudyDays + weekReviewDays)
                    )}
                    ì‹œê°„/ì¼ ({formatNumber(weekTotalHours + weekSelfStudyHours)}
                    ì‹œê°„ Ã· {weekStudyDays + weekReviewDays}ì¼)
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </button>
      {isExpanded && (
        <div>
          {sortedSchedules.map((schedule) => {
            const datePlans = plansByDate.get(schedule.date) || [];
            return (
              <ScheduleItem
                key={schedule.date}
                schedule={schedule}
                datePlans={datePlans}
                contents={contents}
                blocks={blocks}
                sequenceMap={sequenceMap}
                isExpanded={expandedDates.get(schedule.date) ?? false}
                onToggle={() => onToggleDate(schedule.date)}
              />
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/utils/fieldLockUtils.ts">
/**
 * í•„ë“œ ì ê¸ˆ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 * 
 * í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•„ë“œ ì ê¸ˆ/í•´ì œ ë¡œì§ì„ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.
 */

import type { TemplateLockedFields } from "../PlanGroupWizard";
import type { WizardData } from "../PlanGroupWizard";

/**
 * í•„ë“œëª…ê³¼ allow_student_* í•„ë“œëª… ë§¤í•‘
 */
const FIELD_NAME_MAP: Record<string, string> = {
  name: "allow_student_name",
  plan_purpose: "allow_student_plan_purpose",
  scheduler_type: "allow_student_scheduler_type",
  period_start: "allow_student_period",
  period_end: "allow_student_period",
  block_set_id: "allow_student_block_set_id",
  student_level: "allow_student_student_level",
  subject_allocations: "allow_student_subject_allocations",
  study_review_cycle: "allow_student_study_review_cycle",
  additional_period_reallocation: "allow_student_additional_period_reallocation",
};

/**
 * í•„ë“œê°€ ê³ ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
 * 
 * @param fieldName í•„ë“œëª… (ì˜ˆ: "name", "plan_purpose")
 * @param lockedFields í…œí”Œë¦¿ ê³ ì • í•„ë“œ ê°ì²´
 * @param isCampMode ìº í”„ ëª¨ë“œ ì—¬ë¶€ (í•™ìƒ ëª¨ë“œì—ì„œë§Œ ì²´í¬)
 * @returns í•„ë“œê°€ ê³ ì •ë˜ì–´ ìˆìœ¼ë©´ true
 */
export function isFieldLocked(
  fieldName: string,
  lockedFields: TemplateLockedFields["step1"] | undefined,
  isCampMode: boolean
): boolean {
  // í…œí”Œë¦¿ í¸ì§‘ ëª¨ë“œì—ì„œëŠ” í•­ìƒ í¸ì§‘ ê°€ëŠ¥
  if (!isCampMode) return false;

  const allowFieldName = FIELD_NAME_MAP[fieldName];
  if (!allowFieldName || !lockedFields) return false;

  const fieldValue = lockedFields[allowFieldName as keyof typeof lockedFields];
  // ëª…ì‹œì ìœ¼ë¡œ falseì¸ ê²½ìš°ë§Œ ê³ ì •
  return fieldValue === false;
}

/**
 * í•™ìƒì´ í•„ë“œì— ì…ë ¥í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
 * 
 * @param fieldName í•„ë“œëª… (allow_student_* í˜•ì‹)
 * @param lockedFields í…œí”Œë¦¿ ê³ ì • í•„ë“œ ê°ì²´
 * @param editable í¸ì§‘ ê°€ëŠ¥ ì—¬ë¶€
 * @param isCampMode ìº í”„ ëª¨ë“œ ì—¬ë¶€
 * @returns ì…ë ¥ ê°€ëŠ¥í•˜ë©´ true
 */
export function canStudentInput(
  fieldName: keyof NonNullable<TemplateLockedFields["step1"]>,
  lockedFields: TemplateLockedFields["step1"] | undefined,
  editable: boolean,
  isCampMode: boolean
): boolean {
  // editable={false}ì¼ ë•ŒëŠ” ëª¨ë“  í•„ë“œ ì…ë ¥ ë¶ˆê°€
  if (!editable) return false;
  
  // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” í•­ìƒ í—ˆìš©
  if (!isCampMode) return true;

  // templateLockedFieldsê°€ ì—†ìœ¼ë©´ ëª¨ë“  í•„ë“œ ì…ë ¥ ê°€ëŠ¥ (ê¸°ë³¸ê°’)
  if (!lockedFields) return true;

  const fieldValue = lockedFields[fieldName];
  // undefined ë˜ëŠ” trueì´ë©´ ì…ë ¥ ê°€ëŠ¥, falseì´ë©´ ì…ë ¥ ë¶ˆê°€
  return fieldValue !== false;
}

/**
 * í•„ë“œ ì œì–´ í† ê¸€ (í…œí”Œë¦¿ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©)
 * 
 * @param fieldName í•„ë“œëª… (allow_student_* í˜•ì‹)
 * @param currentLocked í˜„ì¬ ê³ ì • í•„ë“œ ê°ì²´
 * @returns ìƒˆë¡œìš´ ê³ ì • í•„ë“œ ê°ì²´
 */
export function toggleFieldControl(
  fieldName: keyof NonNullable<TemplateLockedFields["step1"]>,
  currentLocked: TemplateLockedFields["step1"] | undefined
): TemplateLockedFields["step1"] {
  const locked = currentLocked || {};
  const currentValue = locked[fieldName];
  // í˜„ì¬ ê°’ì´ undefinedì´ë©´ trueë¡œ, trueì´ë©´ falseë¡œ, falseì´ë©´ trueë¡œ í† ê¸€
  const newValue = currentValue === true ? false : true;

  return {
    ...locked,
    [fieldName]: newValue,
  };
}

/**
 * í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•™ìƒ ì…ë ¥ í—ˆìš© ì—¬ë¶€ í™•ì¸
 * 
 * @param fieldName í•„ë“œëª… (allow_student_* í˜•ì‹)
 * @param lockedFields í…œí”Œë¦¿ ê³ ì • í•„ë“œ ê°ì²´
 * @returns í•™ìƒ ì…ë ¥ í—ˆìš© ì—¬ë¶€
 */
export function isStudentInputAllowed(
  fieldName: keyof NonNullable<TemplateLockedFields["step1"]>,
  lockedFields: TemplateLockedFields["step1"] | undefined
): boolean {
  if (!lockedFields) return false;
  const fieldValue = lockedFields[fieldName];
  return fieldValue === true;
}

/**
 * í•„ë“œ ì ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
 * 
 * @param wizardData í˜„ì¬ ìœ„ì €ë“œ ë°ì´í„°
 * @param step1LockedFields Step1ì˜ ìƒˆë¡œìš´ ê³ ì • í•„ë“œ ê°ì²´
 * @returns ì—…ë°ì´íŠ¸ëœ ìœ„ì €ë“œ ë°ì´í„°
 */
export function updateFieldLock(
  wizardData: WizardData,
  step1LockedFields: TemplateLockedFields["step1"]
): Partial<WizardData> {
  return {
    templateLockedFields: {
      ...wizardData.templateLockedFields,
      step1: step1LockedFields,
    },
  };
}

/**
 * ëª¨ë“  í•„ë“œì˜ í•™ìƒ ì…ë ¥ í—ˆìš© ì—¬ë¶€ë¥¼ í•œ ë²ˆì— í™•ì¸
 * 
 * @param lockedFields í…œí”Œë¦¿ ê³ ì • í•„ë“œ ê°ì²´
 * @param editable í¸ì§‘ ê°€ëŠ¥ ì—¬ë¶€
 * @param isCampMode ìº í”„ ëª¨ë“œ ì—¬ë¶€
 * @returns í•„ë“œë³„ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€ ë§µ
 */
export function getAllFieldInputPermissions(
  lockedFields: TemplateLockedFields["step1"] | undefined,
  editable: boolean,
  isCampMode: boolean
): Record<string, boolean> {
  const permissions: Record<string, boolean> = {};
  
  const fieldNames: Array<keyof NonNullable<TemplateLockedFields["step1"]>> = [
    "allow_student_name",
    "allow_student_plan_purpose",
    "allow_student_scheduler_type",
    "allow_student_period",
    "allow_student_block_set_id",
    "allow_student_student_level",
    "allow_student_subject_allocations",
    "allow_student_study_review_cycle",
    "allow_student_additional_period_reallocation",
  ];

  for (const fieldName of fieldNames) {
    permissions[fieldName] = canStudentInput(fieldName, lockedFields, editable, isCampMode);
  }

  return permissions;
}
</file>

<file path="new-group/_components/utils/modeUtils.ts">
/**
 * ìœ„ì €ë“œ ëª¨ë“œ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 * 
 * ìœ„ì €ë“œì˜ ë‹¤ì–‘í•œ ëª¨ë“œ(isCampMode, isTemplateMode, isAdminMode, isAdminContinueMode)ë¥¼
 * í†µí•© ê´€ë¦¬í•˜ê³  ì²´í¬í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.
 */

/**
 * ìœ„ì €ë“œ ëª¨ë“œ íƒ€ì… ì •ì˜
 */
export type WizardMode = {
  isCampMode: boolean;
  isTemplateMode: boolean;
  isAdminMode: boolean;
  isAdminContinueMode: boolean;
  isEditMode?: boolean;
};

/**
 * ìœ„ì €ë“œ ëª¨ë“œ props íƒ€ì…
 */
export type WizardModeProps = {
  isCampMode?: boolean;
  isTemplateMode?: boolean;
  isAdminMode?: boolean;
  isAdminContinueMode?: boolean;
  isEditMode?: boolean;
};

/**
 * ëª¨ë“œ propsë¥¼ WizardMode ê°ì²´ë¡œ ë³€í™˜
 */
export function createWizardMode(props: WizardModeProps): WizardMode {
  return {
    isCampMode: props.isCampMode ?? false,
    isTemplateMode: props.isTemplateMode ?? false,
    isAdminMode: props.isAdminMode ?? false,
    isAdminContinueMode: props.isAdminContinueMode ?? false,
    isEditMode: props.isEditMode ?? false,
  };
}

/**
 * ê´€ë¦¬ì ëª¨ë“œì¸ì§€ í™•ì¸
 */
export function isAdminMode(mode: WizardMode): boolean {
  return mode.isAdminMode || mode.isAdminContinueMode;
}

/**
 * í•™ìƒ ëª¨ë“œì¸ì§€ í™•ì¸ (ì¼ë°˜ ëª¨ë“œ)
 */
export function isStudentMode(mode: WizardMode): boolean {
  return !mode.isCampMode && !mode.isTemplateMode && !isAdminMode(mode);
}

/**
 * í¸ì§‘ ê°€ëŠ¥í•œì§€ í™•ì¸
 * 
 * @param mode ìœ„ì €ë“œ ëª¨ë“œ
 * @param additionalCondition ì¶”ê°€ ì¡°ê±´ (ì˜ˆ: í•„ë“œ ì ê¸ˆ ì—¬ë¶€)
 */
export function isEditable(mode: WizardMode, additionalCondition: boolean = false): boolean {
  // ê´€ë¦¬ì continue ëª¨ë“œì—ì„œëŠ” íŠ¹ì • ë‹¨ê³„ë§Œ í¸ì§‘ ê°€ëŠ¥
  if (mode.isAdminContinueMode) {
    return !additionalCondition;
  }
  return !additionalCondition;
}

/**
 * í…œí”Œë¦¿ ëª¨ë“œì—ì„œ íŠ¹ì • ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ëŠ”ì§€ í™•ì¸
 */
export function shouldSkipStep(step: number, mode: WizardMode): boolean {
  if (mode.isTemplateMode) {
    // í…œí”Œë¦¿ ëª¨ë“œëŠ” Step 5, 6, 7ì„ ê±´ë„ˆëœ€
    return step === 5 || step === 6 || step === 7;
  }
  return false;
}

/**
 * ë§ˆì§€ë§‰ ë‹¨ê³„ì¸ì§€ í™•ì¸
 */
export function isLastStep(currentStep: number, mode: WizardMode): boolean {
  if (mode.isTemplateMode) {
    return currentStep === 4; // í…œí”Œë¦¿ ëª¨ë“œëŠ” Step 4ê°€ ë§ˆì§€ë§‰
  }
  if (mode.isCampMode && !mode.isAdminContinueMode) {
    return currentStep === 4; // ìº í”„ ëª¨ë“œ (í•™ìƒ)ëŠ” Step 4ê°€ ë§ˆì§€ë§‰
  }
  return currentStep === 7; // ì¼ë°˜ ëª¨ë“œì™€ ìº í”„ ëª¨ë“œ (ê´€ë¦¬ì)ëŠ” Step 7ì´ ë§ˆì§€ë§‰
}

/**
 * Step 4ì—ì„œ ì œì¶œí•´ì•¼ í•˜ëŠ”ì§€ í™•ì¸
 */
export function shouldSubmitAtStep4(mode: WizardMode): boolean {
  // í…œí”Œë¦¿ ëª¨ë“œë‚˜ ìº í”„ ëª¨ë“œ(í•™ìƒ)ì—ì„œ Step 4ì—ì„œ ì œì¶œ
  return (mode.isTemplateMode || (mode.isCampMode && !mode.isAdminContinueMode));
}

/**
 * Step 5, 6ì—ì„œ í”Œëœ ìƒì„± ì—†ì´ ì €ì¥ë§Œ í•˜ëŠ”ì§€ í™•ì¸
 */
export function shouldSaveOnlyWithoutPlanGeneration(mode: WizardMode): boolean {
  return mode.isAdminContinueMode;
}

/**
 * ìº í”„ ëª¨ë“œì—ì„œ ì½˜í…ì¸  ê²€ì¦ì„ ê±´ë„ˆë›°ëŠ”ì§€ í™•ì¸
 */
export function shouldSkipContentValidation(mode: WizardMode, currentStep: number): boolean {
  return mode.isCampMode && currentStep === 4 && !mode.isAdminContinueMode;
}

/**
 * ë’¤ë¡œê°€ê¸° ê°€ëŠ¥í•œì§€ í™•ì¸
 */
export function canGoBack(currentStep: number, mode: WizardMode): boolean {
  if (currentStep === 1) return false;
  
  // ê´€ë¦¬ì continue ëª¨ë“œëŠ” Step 4ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ Step 4 ì´ìƒì—ì„œë§Œ ë’¤ë¡œê°€ê¸° ê°€ëŠ¥
  if (mode.isAdminContinueMode) {
    return currentStep > 4;
  }
  
  return true;
}

/**
 * íŠ¹ì • ë‹¨ê³„ë¡œ ì´ë™ ê°€ëŠ¥í•œì§€ í™•ì¸
 */
export function canNavigateToStep(targetStep: number, mode: WizardMode): boolean {
  // ê´€ë¦¬ì continue ëª¨ë“œëŠ” Step 4ë¶€í„° ì‹œì‘
  if (mode.isAdminContinueMode && targetStep < 4) {
    return false;
  }
  
  // í…œí”Œë¦¿ ëª¨ë“œëŠ” Step 1-4ë§Œ ê°€ëŠ¥
  if (mode.isTemplateMode && targetStep > 4) {
    return false;
  }
  
  return true;
}
</file>

<file path="new-group/_components/utils/scheduleTransform.ts">
/**
 * í”Œëœ ë°ì´í„°ë¥¼ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ê¸°ì¤€ í‘œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹°
 */

import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";

export type ScheduleTableRow = {
  id: string;
  weekAndDay: string; // "1ì£¼ì°¨-1ì¼"
  date: string; // YYYY-MM-DD
  time: string; // HH:MM
  subjectCategory: string; // êµê³¼
  subject: string; // ê³¼ëª©
  contentType: string; // "ê°•ì˜" | "êµì¬"
  contentName: string; // êµì¬/ê°•ì˜ ì´ë¦„
  learningContent: string; // í•™ìŠµë‚´ì—­ (ë‹¨ì›ëª… ë“±)
  sequence: number; // íšŒì°¨
  estimatedTime: number; // ì˜ˆìƒ ì†Œìš”ì‹œê°„ (ë¶„)
  learningAmount: string; // í•™ìŠµ ë¶„ëŸ‰ (ì˜ˆ: "10-14p" ë˜ëŠ” "12ê°•")
  completed: boolean; // ì™„ë£Œ ì—¬ë¶€
  completionRate: number; // ì™„ë£Œìœ¨ (0-100)
  planId: string; // ì›ë³¸ í”Œëœ ID
  dayType: "í•™ìŠµì¼" | "ë³µìŠµì¼" | null; // í•™ìŠµì¼/ë³µìŠµì¼ êµ¬ë¶„
  block_index: number | null; // ë¸”ë¡ ì¸ë±ìŠ¤
  timeSlots?: Array<{
    type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
    start: string;
    end: string;
    label?: string;
  }>; // Step 2.5ì˜ ì‹œê°„ êµ¬ì„± íƒ€ì„ë¼ì¸
};

export type PlanData = {
  id: string;
  plan_date: string;
  block_index: number | null;
  content_type: string;
  content_id: string;
  chapter: string | null;
  planned_start_page_or_time: number | null;
  planned_end_page_or_time: number | null;
  completed_amount: number | null;
  plan_number: number | null;
  sequence: number | null;
};

export type ContentData = {
  id: string;
  title: string;
  subject?: string | null;
  subject_category?: string | null;
  total_pages?: number | null; // ì±…ì˜ ê²½ìš°
  duration?: number | null; // ê°•ì˜ì˜ ê²½ìš°
  total_page_or_time?: number | null; // ì»¤ìŠ¤í…€ì˜ ê²½ìš°
};

export type BlockData = {
  id: string;
  day_of_week: number;
  start_time: string;
  end_time: string;
  block_index: number;
};

/**
 * ì£¼ì°¨ ê³„ì‚° (ì‹œì‘ì¼ ê¸°ì¤€, ì‹œì‘ì¼ë¶€í„° 1ì¼ì°¨)
 */
function calculateWeekNumber(
  planDate: string,
  periodStart: string
): { week: number; day: number } {
  const start = new Date(periodStart);
  const current = new Date(planDate);
  
  // ì‹œì‘ì¼ê³¼ í˜„ì¬ì¼ì„ ë‚ ì§œë§Œ ë¹„êµ (ì‹œê°„ ì œê±°)
  start.setHours(0, 0, 0, 0);
  current.setHours(0, 0, 0, 0);
  
  // ì‹œì‘ì¼ë¶€í„° ê²½ê³¼ ì¼ìˆ˜ ê³„ì‚°
  const diffTime = current.getTime() - start.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  // ì£¼ì°¨ ê³„ì‚° (1ì£¼ì°¨ë¶€í„° ì‹œì‘, 7ì¼ ë‹¨ìœ„)
  const week = Math.floor(diffDays / 7) + 1;
  
  // ì¼ì°¨ ê³„ì‚° (í•´ë‹¹ ì£¼ì˜ ëª‡ ë²ˆì§¸ ë‚ ì¸ì§€, ì‹œì‘ì¼=1ì¼ì°¨)
  // ì˜ˆ: ì‹œì‘ì¼ì´ ìˆ˜ìš”ì¼ì´ë©´ ìˆ˜ìš”ì¼=1ì¼ì°¨, ëª©ìš”ì¼=2ì¼ì°¨, ...
  const day = (diffDays % 7) + 1;
  
  return { week, day };
}

/**
 * íšŒì°¨ ê³„ì‚° (ê°™ì€ ì½˜í…ì¸ ì˜ ë‚ ì§œ ìˆœì„œëŒ€ë¡œ ì¹´ìš´íŠ¸, plan_numberë¥¼ ê³ ë ¤)
 * ê°™ì€ plan_numberë¥¼ ê°€ì§„ í”Œëœë“¤ì€ ê°™ì€ íšŒì°¨ë¥¼ ê°€ì§
 */
function calculateSequence(
  plans: PlanData[],
  currentIndex: number,
  contentId: string,
  planNumber: number | null = null
): number {
  const currentPlan = plans[currentIndex];
  const pn = planNumber !== null ? planNumber : currentPlan?.plan_number ?? null;
  
  // ê°™ì€ content_idë¥¼ ê°€ì§„ í”Œëœë“¤ ì¤‘ì—ì„œ
  // plan_numberê°€ nullì´ ì•„ë‹Œ ê²½ìš°, ê°™ì€ plan_numberë¥¼ ê°€ì§„ ì²« ë²ˆì§¸ í”Œëœì˜ íšŒì°¨ë¥¼ ì‚¬ìš©
  if (pn !== null) {
    const firstPlanWithSameNumber = plans.findIndex(
      (p, idx) => 
        p.content_id === contentId && 
        p.plan_number === pn &&
        idx < currentIndex
    );
    
    if (firstPlanWithSameNumber >= 0) {
      // ê°™ì€ plan_numberë¥¼ ê°€ì§„ ì²« ë²ˆì§¸ í”Œëœì˜ íšŒì°¨ ê³„ì‚° (ì¬ê·€ í˜¸ì¶œ)
      return calculateSequence(plans, firstPlanWithSameNumber, contentId, null);
    }
  }
  
  // plan_numberê°€ nullì´ê±°ë‚˜ ê°™ì€ plan_numberë¥¼ ê°€ì§„ ì²« ë²ˆì§¸ í”Œëœì¸ ê²½ìš°
  // ë‚ ì§œ ìˆœì„œëŒ€ë¡œ ì¹´ìš´íŠ¸
  let sequence = 1;
  const seenPlanNumbers = new Set<number | null>();
  
  for (let i = 0; i < currentIndex; i++) {
    if (plans[i].content_id === contentId) {
      const pn = plans[i].plan_number;
      
      // plan_numberê°€ nullì´ë©´ ê°œë³„ ì¹´ìš´íŠ¸
      if (pn === null) {
        sequence++;
      } else {
        // plan_numberê°€ ìˆìœ¼ë©´ ê°™ì€ ë²ˆí˜¸ë¥¼ ê°€ì§„ ê·¸ë£¹ì€ í•œ ë²ˆë§Œ ì¹´ìš´íŠ¸
        if (!seenPlanNumbers.has(pn)) {
          seenPlanNumbers.add(pn);
          sequence++;
        }
      }
    }
  }
  
  return sequence;
}

/**
 * ì‹œê°„ ë¸”ë¡ì—ì„œ ì‹œê°„ ë¬¸ìì—´ ì¶”ì¶œ
 * block_indexê°€ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš° ê°€ì¥ ê°€ê¹Œìš´ ë¸”ë¡ ì°¾ê¸°
 */
function getTimeFromBlock(
  planDate: string,
  blockIndex: number | null,
  blocks: BlockData[]
): string {
  if (blockIndex === null) return "";
  
  const planDateObj = new Date(planDate);
  const dayOfWeek = planDateObj.getDay();
  
  // ë¨¼ì € ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¸”ë¡ ì°¾ê¸°
  let block = blocks.find(
    (b) => b.day_of_week === dayOfWeek && b.block_index === blockIndex
  );
  
  // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¸”ë¡ì´ ì—†ìœ¼ë©´ ê°™ì€ ìš”ì¼ì˜ ë¸”ë¡ ì¤‘ì—ì„œ ì°¾ê¸°
  if (!block) {
    const dayBlocks = blocks.filter((b) => b.day_of_week === dayOfWeek);
    if (dayBlocks.length > 0) {
      // block_indexë¡œ ì •ë ¬
      const sortedBlocks = [...dayBlocks].sort((a, b) => a.block_index - b.block_index);
      // blockIndexê°€ ë²”ìœ„ ë‚´ì— ìˆìœ¼ë©´ í•´ë‹¹ ë¸”ë¡ ì‚¬ìš©, ì•„ë‹ˆë©´ ì²« ë²ˆì§¸ ë˜ëŠ” ë§ˆì§€ë§‰ ë¸”ë¡ ì‚¬ìš©
      if (blockIndex > 0 && blockIndex <= sortedBlocks.length) {
        block = sortedBlocks[blockIndex - 1];
      } else if (sortedBlocks.length > 0) {
        // ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê°€ì¥ ê°€ê¹Œìš´ ë¸”ë¡ ì‚¬ìš©
        block = sortedBlocks[Math.min(blockIndex - 1, sortedBlocks.length - 1)] || sortedBlocks[0];
      }
    }
  }
  
  if (!block) return "";
  
  return `${block.start_time} ~ ${block.end_time}`; // HH:MM ~ HH:MM í˜•ì‹
}

/**
 * ì˜ˆìƒ ì†Œìš”ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
 * ì½˜í…ì¸  íƒ€ì…ê³¼ í•™ìŠµ ë¶„ëŸ‰ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
 * ë³µìŠµì¼ì¼ ê²½ìš° ì†Œìš”ì‹œê°„ ë‹¨ì¶• ì ìš© (í•™ìŠµì¼ ëŒ€ë¹„ 50%ë¡œ ë‹¨ì¶•)
 */
function calculateEstimatedTime(
  contentType: string,
  startPageOrTime: number | null,
  endPageOrTime: number | null,
  content: ContentData | undefined,
  planDate: string,
  blockIndex: number | null,
  blocks: BlockData[],
  dayType: "í•™ìŠµì¼" | "ë³µìŠµì¼" | null
): number {
  // í•™ìŠµ ë¶„ëŸ‰ì´ ì—†ìœ¼ë©´ ë¸”ë¡ ì‹œê°„ ë°˜í™˜
  if (startPageOrTime === null || endPageOrTime === null) {
    const blockTime = getBlockDuration(planDate, blockIndex, blocks);
    // ë³µìŠµì¼ì´ë©´ ì‹œê°„ ë‹¨ì¶•
    return dayType === "ë³µìŠµì¼" ? Math.round(blockTime * 0.5) : blockTime;
  }

  const amount = endPageOrTime - startPageOrTime;
  if (amount <= 0) {
    const blockTime = getBlockDuration(planDate, blockIndex, blocks);
    return dayType === "ë³µìŠµì¼" ? Math.round(blockTime * 0.5) : blockTime;
  }

  let baseTime = 0;

  // ì½˜í…ì¸  íƒ€ì…ë³„ ì†Œìš”ì‹œê°„ ê³„ì‚°
  if (contentType === "book") {
    // ì±…: ì„¤ì • ê¸°ë°˜ ì‹œê°„ ê³„ì‚°
    const pagesPerHour = defaultRangeRecommendationConfig.pagesPerHour;
    const minutesPerPage = 60 / pagesPerHour;
    baseTime = Math.round(amount * minutesPerPage);
  } else if (contentType === "lecture") {
    // ê°•ì˜: duration ì •ë³´ ì‚¬ìš©
    if (content?.duration && content.duration > 0) {
      // ì´ durationì„ total_episodesë¡œ ë‚˜ëˆ ì„œ íšŒì°¨ë‹¹ ì‹œê°„ ê³„ì‚°
      // ë‹¨, ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ durationì„ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” episodeë³„ durationì´ í•„ìš”í•  ìˆ˜ ìˆìŒ)
      // í˜„ì¬ëŠ” í”Œëœì˜ íšŒì°¨ ë²”ìœ„ë¥¼ ê³ ë ¤í•˜ì—¬ ê³„ì‚°
      // ì˜ˆ: ì´ 100ë¶„ ê°•ì˜, 10íšŒì°¨ë©´ íšŒì°¨ë‹¹ 10ë¶„
      // í•˜ì§€ë§Œ ì •í™•í•œ ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” episodeë³„ durationì´ í•„ìš”
      // ì¼ë‹¨ì€ ë¸”ë¡ ì‹œê°„ ë°˜í™˜ (ì¶”í›„ ê°œì„  í•„ìš”)
      baseTime = getBlockDuration(planDate, blockIndex, blocks);
    } else {
      // duration ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¸”ë¡ ì‹œê°„ ë°˜í™˜
      baseTime = getBlockDuration(planDate, blockIndex, blocks);
    }
  } else if (contentType === "custom") {
    // ì»¤ìŠ¤í…€: total_page_or_timeì´ ì‹œê°„ ë‹¨ìœ„ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    // í•˜ì§€ë§Œ planned_start_page_or_timeê³¼ planned_end_page_or_timeì˜ ì°¨ì´ê°€ ì‹œê°„ì¸ì§€ í˜ì´ì§€ì¸ì§€ ë¶ˆëª…í™•
    // ì¼ë‹¨ì€ ë¸”ë¡ ì‹œê°„ ë°˜í™˜ (ì¶”í›„ ê°œì„  í•„ìš”)
    baseTime = getBlockDuration(planDate, blockIndex, blocks);
  } else {
    // ê¸°ë³¸ê°’: ë¸”ë¡ ì‹œê°„
    baseTime = getBlockDuration(planDate, blockIndex, blocks);
  }

  // ë³µìŠµì¼ì´ë©´ ì†Œìš”ì‹œê°„ ë‹¨ì¶• (í•™ìŠµì¼ ëŒ€ë¹„ 50%ë¡œ ë‹¨ì¶•)
  if (dayType === "ë³µìŠµì¼") {
    return Math.round(baseTime * 0.5);
  }

  return baseTime;
}

/**
 * ë¸”ë¡ ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
 */
function getBlockDuration(
  planDate: string,
  blockIndex: number | null,
  blocks: BlockData[]
): number {
  if (blockIndex === null) return 0;
  
  const planDateObj = new Date(planDate);
  const dayOfWeek = planDateObj.getDay();
  
  const block = blocks.find(
    (b) => b.day_of_week === dayOfWeek && b.block_index === blockIndex
  );
  
  if (!block) return 0;
  
  const [startHour, startMin] = block.start_time.split(":").map(Number);
  const [endHour, endMin] = block.end_time.split(":").map(Number);
  
  const startMinutes = startHour * 60 + startMin;
  const endMinutes = endHour * 60 + endMin;
  
  return endMinutes - startMinutes;
}

/**
 * í•™ìŠµ ë¶„ëŸ‰ í¬ë§·íŒ…
 */
function formatLearningAmount(
  contentType: string,
  start: number | null,
  end: number | null
): string {
  if (start === null || end === null) return "";
  
  if (contentType === "book") {
    return `${start}-${end}p`;
  } else if (contentType === "lecture") {
    return `${start}ê°•`;
  }
  
  return `${start}-${end}`;
}

/**
 * í•™ìŠµì¼/ë³µìŠµì¼ ê³„ì‚° (1730 Timetable ìŠ¤ì¼€ì¤„ëŸ¬ìš©)
 * schedulerOptionsê°€ nullì´ì–´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ê³„ì‚°
 */
function calculateDayType(
  date: string,
  periodStart: string,
  periodEnd: string,
  schedulerType: string | null,
  schedulerOptions: { study_days?: number; review_days?: number } | null | undefined
): "í•™ìŠµì¼" | "ë³µìŠµì¼" | null {
  // 1730 Timetableì´ ì•„ë‹ˆë©´ null ë°˜í™˜
  if (schedulerType !== "1730_timetable") {
    return null;
  }

  // schedulerOptionsê°€ nullì´ê±°ë‚˜ undefinedì—¬ë„ ê¸°ë³¸ê°’ ì‚¬ìš©
  const studyDays = schedulerOptions?.study_days ?? 6;
  const reviewDays = schedulerOptions?.review_days ?? 1;
  const weekSize = studyDays + reviewDays;

  if (weekSize <= 0) {
    return null;
  }

  const start = new Date(periodStart);
  const current = new Date(date);
  
  start.setHours(0, 0, 0, 0);
  current.setHours(0, 0, 0, 0);
  
  // ì‹œì‘ì¼ë¶€í„° ê²½ê³¼ ì¼ìˆ˜ ê³„ì‚°
  const diffTime = current.getTime() - start.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return null;
  }

  // ì£¼ì°¨ ë‚´ì—ì„œì˜ ìœ„ì¹˜ ê³„ì‚°
  const positionInWeek = diffDays % weekSize;
  
  // í•™ìŠµì¼ ë²”ìœ„ ë‚´ì´ë©´ í•™ìŠµì¼, ì•„ë‹ˆë©´ ë³µìŠµì¼
  if (positionInWeek < studyDays) {
    return "í•™ìŠµì¼";
  } else {
    return "ë³µìŠµì¼";
  }
}

/**
 * í”Œëœ ë°ì´í„°ë¥¼ í‘œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 */
export function transformPlansToScheduleTable(
  plans: PlanData[],
  contents: Map<string, ContentData>,
  blocks: BlockData[],
  periodStart: string,
  periodEnd?: string | null,
  schedulerType?: string | null,
  schedulerOptions?: { study_days?: number; review_days?: number } | null,
  dateTimeSlots?: Record<string, Array<{
    type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
    start: string;
    end: string;
    label?: string;
  }>>
): ScheduleTableRow[] {
  // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬
  const sortedPlans = [...plans].sort((a, b) => {
    if (a.plan_date !== b.plan_date) {
      return a.plan_date.localeCompare(b.plan_date);
    }
    return (a.block_index || 0) - (b.block_index || 0);
  });

  // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ê°™ì€ ë‚ ì§œì˜ ì²« ë²ˆì§¸ í”Œëœì—ë§Œ timeSlots í• ë‹¹
  const plansByDate = new Map<string, PlanData[]>();
  sortedPlans.forEach((plan) => {
    if (!plansByDate.has(plan.plan_date)) {
      plansByDate.set(plan.plan_date, []);
    }
    plansByDate.get(plan.plan_date)!.push(plan);
  });

  return sortedPlans.map((plan, index) => {
    const content = contents.get(plan.content_id);
    const { week, day } = calculateWeekNumber(plan.plan_date, periodStart);
    // ì €ì¥ëœ sequenceê°€ ìˆìœ¼ë©´ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ê³„ì‚°
    const sequence = plan.sequence !== null && plan.sequence !== undefined
      ? plan.sequence
      : calculateSequence(sortedPlans, index, plan.content_id, plan.plan_number);
    
    // dayTypeì„ ë¨¼ì € ê³„ì‚° (estimatedTime ê³„ì‚°ì— í•„ìš”)
    const dayType = calculateDayType(
      plan.plan_date,
      periodStart,
      periodEnd || "",
      schedulerType || null,
      schedulerOptions || null
    );
    
    const time = getTimeFromBlock(plan.plan_date, plan.block_index, blocks);
    const estimatedTime = calculateEstimatedTime(
      plan.content_type,
      plan.planned_start_page_or_time,
      plan.planned_end_page_or_time,
      content,
      plan.plan_date,
      plan.block_index,
      blocks,
      dayType
    );
    const learningAmount = formatLearningAmount(
      plan.content_type,
      plan.planned_start_page_or_time,
      plan.planned_end_page_or_time
    );

    // ì™„ë£Œìœ¨ ê³„ì‚°
    const totalAmount =
      plan.planned_end_page_or_time && plan.planned_start_page_or_time
        ? plan.planned_end_page_or_time - plan.planned_start_page_or_time
        : 0;
    const completedAmount = plan.completed_amount || 0;
    const completionRate =
      totalAmount > 0 ? Math.round((completedAmount / totalAmount) * 100) : 0;

    // ê°™ì€ ë‚ ì§œì˜ ì²« ë²ˆì§¸ í”Œëœì—ë§Œ timeSlots í• ë‹¹
    const datePlans = plansByDate.get(plan.plan_date) || [];
    const isFirstPlanOfDate = datePlans[0]?.id === plan.id;
    const timeSlots = isFirstPlanOfDate ? dateTimeSlots?.[plan.plan_date] : undefined;

    return {
      id: plan.id,
      weekAndDay: `${week}ì£¼ì°¨-${day}ì¼`,
      date: plan.plan_date,
      time,
      subjectCategory: content?.subject_category || "",
      subject: content?.subject || "",
      contentType: plan.content_type === "book" ? "êµì¬" : "ê°•ì˜",
      contentName: content?.title || "",
      learningContent: plan.chapter || "",
      sequence,
      estimatedTime,
      learningAmount,
      completed: completionRate >= 100,
      completionRate,
      planId: plan.id,
      dayType,
      block_index: plan.block_index,
      timeSlots,
    };
  });
}
</file>

<file path="new-group/_components/utils/validationUtils.ts">
/**
 * ê²€ì¦ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 * 
 * ìœ„ì €ë“œ ë°ì´í„° ê²€ì¦ ë¡œì§ì„ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.
 */

import { PlanValidator } from "@/lib/validation/planValidator";
import type { WizardData } from "../PlanGroupWizard";
import { canStudentInput as checkStudentInputAllowed } from "./fieldLockUtils";

/**
 * ê¸°ê°„ ê²€ì¦ ê²°ê³¼ íƒ€ì…
 */
export type PeriodValidationResult = {
  isValid: boolean;
  error?: string;
};

/**
 * ê¸°ê°„ ê²€ì¦ (ê³µí†µ í•¨ìˆ˜)
 * 
 * @param wizardData ìœ„ì €ë“œ ë°ì´í„°
 * @param isCampMode ìº í”„ ëª¨ë“œ ì—¬ë¶€
 * @returns ê²€ì¦ ê²°ê³¼
 */
export function validatePeriod(
  wizardData: WizardData,
  isCampMode: boolean
): PeriodValidationResult {
  // ìº í”„ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ê²€ì¦
  if (isCampMode) {
    return { isValid: true };
  }

  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•™ìƒ ì…ë ¥ í—ˆìš©ì´ ì•„ë‹ ë•Œë§Œ í•„ìˆ˜
  const lockedFields = wizardData.templateLockedFields?.step1;
  const canInputPeriod = checkStudentInputAllowed(
    "allow_student_period",
    lockedFields,
    true, // editableì€ ì—¬ê¸°ì„œëŠ” ì²´í¬í•˜ì§€ ì•ŠìŒ
    false // isCampModeëŠ” ì´ë¯¸ ì²´í¬í–ˆìœ¼ë¯€ë¡œ false
  );

  if (!canInputPeriod) {
    if (!wizardData.period_start || !wizardData.period_end) {
      return {
        isValid: false,
        error: "ê¸°ê°„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. Step 1ì—ì„œ í•™ìŠµ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
      };
    }

    // PlanValidatorë¥¼ ì‚¬ìš©í•œ ì¶”ê°€ ê²€ì¦
    const periodValidation = PlanValidator.validatePeriod(
      wizardData.period_start,
      wizardData.period_end
    );

    if (periodValidation.errors.length > 0) {
      return {
        isValid: false,
        error: periodValidation.errors[0], // ì²« ë²ˆì§¸ ì—ëŸ¬ë§Œ ë°˜í™˜
      };
    }
  }

  return { isValid: true };
}

/**
 * í•„ìˆ˜ í•„ë“œ ê²€ì¦
 * 
 * @param wizardData ìœ„ì €ë“œ ë°ì´í„°
 * @param isTemplateMode í…œí”Œë¦¿ ëª¨ë“œ ì—¬ë¶€
 * @returns ê²€ì¦ ê²°ê³¼
 */
export type RequiredFieldsValidationResult = {
  isValid: boolean;
  errors: string[];
  fieldErrors: Map<string, string>;
};

export function validateRequiredFields(
  wizardData: WizardData,
  isTemplateMode: boolean
): RequiredFieldsValidationResult {
  const errors: string[] = [];
  const fieldErrors = new Map<string, string>();

  // í…œí”Œë¦¿ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì´ë¦„ ê²€ì¦
  if (!isTemplateMode) {
    if (!wizardData.name || wizardData.name.trim() === "") {
      const errorMsg = "í”Œëœ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      errors.push(errorMsg);
      fieldErrors.set("plan_name", errorMsg);
    }
  }

  // í”Œëœ ëª©ì  ê²€ì¦
  const lockedFields = wizardData.templateLockedFields?.step1;
  const canInputPlanPurpose = checkStudentInputAllowed(
    "allow_student_plan_purpose",
    lockedFields,
    true,
    false
  );

  if (!canInputPlanPurpose) {
    if (!wizardData.plan_purpose) {
      const errorMsg = "í”Œëœ ëª©ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
      errors.push(errorMsg);
      fieldErrors.set("plan_purpose", errorMsg);
    }
  }

  // ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜• ê²€ì¦
  const canInputSchedulerType = checkStudentInputAllowed(
    "allow_student_scheduler_type",
    lockedFields,
    true,
    false
  );

  if (!canInputSchedulerType) {
    if (!wizardData.scheduler_type) {
      const errorMsg = "ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
      errors.push(errorMsg);
      fieldErrors.set("scheduler_type", errorMsg);
    }
  }

  return {
    isValid: errors.length === 0,
    errors,
    fieldErrors,
  };
}

/**
 * ì½˜í…ì¸  ê²€ì¦
 * 
 * @param wizardData ìœ„ì €ë“œ ë°ì´í„°
 * @param isTemplateMode í…œí”Œë¦¿ ëª¨ë“œ ì—¬ë¶€
 * @returns ê²€ì¦ ê²°ê³¼
 */
export type ContentValidationResult = {
  isValid: boolean;
  error?: string;
  fieldError?: string;
};

export function validateContents(
  wizardData: WizardData,
  isTemplateMode: boolean
): ContentValidationResult {
  // í…œí”Œë¦¿ ëª¨ë“œì—ì„œëŠ” ì½˜í…ì¸  ì„ íƒ ê²€ì¦ ê±´ë„ˆë›°ê¸°
  if (isTemplateMode) {
    return { isValid: true };
  }

  const totalContents =
    wizardData.student_contents.length +
    (wizardData.recommended_contents?.length || 0);

  if (totalContents === 0) {
    return {
      isValid: false,
      error: "ìµœì†Œ 1ê°œ ì´ìƒì˜ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",
      fieldError: "content_selection",
    };
  }

  return { isValid: true };
}

/**
 * í†µí•© ê²€ì¦ í•¨ìˆ˜
 * 
 * @param wizardData ìœ„ì €ë“œ ë°ì´í„°
 * @param step ê²€ì¦í•  ë‹¨ê³„
 * @param isTemplateMode í…œí”Œë¦¿ ëª¨ë“œ ì—¬ë¶€
 * @param isCampMode ìº í”„ ëª¨ë“œ ì—¬ë¶€
 * @returns ê²€ì¦ ê²°ê³¼
 */
export type StepValidationResult = {
  isValid: boolean;
  errors: string[];
  warnings: string[];
  fieldErrors: Map<string, string>;
};

export function validateStep(
  wizardData: WizardData,
  step: number,
  isTemplateMode: boolean,
  isCampMode: boolean
): StepValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];
  const fieldErrors = new Map<string, string>();

  if (step === 1) {
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const requiredFieldsResult = validateRequiredFields(wizardData, isTemplateMode);
    errors.push(...requiredFieldsResult.errors);
    requiredFieldsResult.fieldErrors.forEach((value, key) => {
      fieldErrors.set(key, value);
    });

    // ê¸°ê°„ ê²€ì¦
    const periodResult = validatePeriod(wizardData, isCampMode);
    if (!periodResult.isValid && periodResult.error) {
      errors.push(periodResult.error);
      fieldErrors.set("period_start", periodResult.error);
    }

    // PlanValidatorì˜ ê¸°ê°„ ê²€ì¦ì—ì„œ ê²½ê³ ë„ ê°€ì ¸ì˜¤ê¸°
    if (wizardData.period_start && wizardData.period_end) {
      const periodValidation = PlanValidator.validatePeriod(
        wizardData.period_start,
        wizardData.period_end
      );
      warnings.push(...periodValidation.warnings);
    }
  }

  if (step === 4) {
    // ì½˜í…ì¸  ê²€ì¦
    const contentResult = validateContents(wizardData, isTemplateMode);
    if (!contentResult.isValid) {
      if (contentResult.error) {
        errors.push(contentResult.error);
      }
      if (contentResult.fieldError) {
        fieldErrors.set(contentResult.fieldError, contentResult.error || "");
      }
    }
  }

  return {
    isValid: errors.length === 0,
    errors,
    warnings,
    fieldErrors,
  };
}
</file>

<file path="new-group/_components/ContentMasterSearch.tsx">
"use client";

import { useState, useTransition, useEffect } from "react";
import { searchContentMastersAction, copyMasterToStudentContentAction } from "@/app/(student)/actions/contentMasterActions";
import { ContentMaster } from "@/lib/types/plan";
import { Dialog, DialogContent } from "@/components/ui/Dialog";

type ContentMasterSearchProps = {
  contentType: "book" | "lecture";
  onContentAdded: (contentId: string, contentType: "book" | "lecture") => void;
  onClose: () => void;
  studentId?: string; // ê´€ë¦¬ì ëª¨ë“œì—ì„œ ì‚¬ìš© ì‹œ
};

export function ContentMasterSearch({
  contentType,
  onContentAdded,
  onClose,
  studentId,
}: ContentMasterSearchProps) {
  const [searchQuery, setSearchQuery] = useState("");
  const [curriculumRevisionId, setCurriculumRevisionId] = useState("");
  const [subjectGroupId, setSubjectGroupId] = useState("");
  const [subjectId, setSubjectId] = useState("");
  const [publisherId, setPublisherId] = useState("");
  const [platformId, setPlatformId] = useState("");
  const [difficulty, setDifficulty] = useState("");
  const [sort, setSort] = useState("updated_at_desc");
  const [results, setResults] = useState<ContentMaster[]>([]);
  const [isSearching, startSearch] = useTransition();
  const [copyingId, setCopyingId] = useState<string | null>(null);
  const [curriculumRevisions, setCurriculumRevisions] = useState<Array<{ id: string; name: string }>>([]);
  const [subjectGroups, setSubjectGroups] = useState<Array<{ id: string; name: string }>>([]);
  // êµê³¼ë³„ ê³¼ëª©ì„ Mapìœ¼ë¡œ ê´€ë¦¬ (êµê³¼ ID â†’ ê³¼ëª© ëª©ë¡)
  const [subjectsMap, setSubjectsMap] = useState<Map<string, Array<{ id: string; name: string }>>>(new Map());
  const [publishers, setPublishers] = useState<Array<{ id: string; name: string }>>([]);
  const [platforms, setPlatforms] = useState<Array<{ id: string; name: string }>>([]);
  const [difficulties, setDifficulties] = useState<string[]>([]);
  const [loadingGroups, setLoadingGroups] = useState(false);
  const [loadingSubjects, setLoadingSubjects] = useState(false);

  // í˜„ì¬ ì„ íƒëœ êµê³¼ì˜ ê³¼ëª© ëª©ë¡
  const currentSubjects = subjectGroupId 
    ? subjectsMap.get(subjectGroupId) || []
    : [];

  // ê°œì •êµìœ¡ê³¼ì •, ì¶œíŒì‚¬, í”Œë«í¼, ë‚œì´ë„ ëª©ë¡ ë¡œë“œ
  useEffect(() => {
    Promise.all([
      fetch("/api/curriculum-revisions").then((res) => res.json()),
      contentType === "book" 
        ? fetch("/api/publishers").then((res) => res.json())
        : Promise.resolve({ success: true, data: [] }),
      contentType === "lecture"
        ? fetch("/api/platforms").then((res) => res.json())
        : Promise.resolve({ success: true, data: [] }),
      contentType === "book"
        ? fetch("/api/master-books/difficulties").then((res) => res.json()).catch(() => ({ success: true, data: [] }))
        : fetch("/api/master-lectures/difficulties").then((res) => res.json()).catch(() => ({ success: true, data: [] })),
    ])
      .then(([revisionsRes, publishersRes, platformsRes, difficultiesRes]) => {
        if (revisionsRes.success) {
          setCurriculumRevisions(revisionsRes.data || []);
        }
        if (publishersRes.success) {
          setPublishers(publishersRes.data || []);
        }
        if (platformsRes.success) {
          setPlatforms(platformsRes.data || []);
        }
        if (difficultiesRes.success) {
          setDifficulties(difficultiesRes.data || []);
        }
      })
      .catch((err) => {
        console.error("í•„í„° ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:", err);
      });
  }, [contentType]);

  // ê°œì •êµìœ¡ê³¼ì • ë³€ê²½ ì‹œ êµê³¼ì™€ ê³¼ëª© ëª©ë¡ ë³‘ë ¬ ë¡œë“œ
  useEffect(() => {
    if (curriculumRevisionId) {
      loadHierarchyData(curriculumRevisionId);
    } else {
      setSubjectGroups([]);
      setSubjectsMap(new Map());
      setSubjectGroupId("");
      setSubjectId("");
    }
  }, [curriculumRevisionId]);

  // ê³„ì¸µ êµ¬ì¡° ë°ì´í„° ë¡œë“œ (ë³‘ë ¬ ì²˜ë¦¬)
  const loadHierarchyData = async (curriculumRevisionId: string) => {
    setLoadingGroups(true);
    setLoadingSubjects(true);

    try {
      // êµê³¼ì™€ ê³¼ëª©ì„ í•¨ê»˜ ì¡°íšŒ (ë³‘ë ¬ ì²˜ë¦¬)
      const response = await fetch(
        `/api/subject-groups?curriculum_revision_id=${curriculumRevisionId}&include_subjects=true`
      );
      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
      }

      const groupsWithSubjects = result.data || [];
      const groups: Array<{ id: string; name: string }> = groupsWithSubjects.map(
        (group: { id: string; name: string; subjects?: Array<{ id: string; name: string }> }) => ({
          id: group.id,
          name: group.name,
        })
      );

      // êµê³¼ë³„ ê³¼ëª©ì„ Mapìœ¼ë¡œ ë³€í™˜
      const newSubjectsMap = new Map<string, Array<{ id: string; name: string }>>();
      groupsWithSubjects.forEach((group: { id: string; name: string; subjects?: Array<{ id: string; name: string }> }) => {
        if (group.subjects && group.subjects.length > 0) {
          newSubjectsMap.set(group.id, group.subjects);
        }
      });

      setSubjectGroups(groups);
      setSubjectsMap(newSubjectsMap);
      setSubjectGroupId("");
      setSubjectId("");
      setLoadingGroups(false);
      setLoadingSubjects(false);
    } catch (err) {
      console.error("ê³„ì¸µ êµ¬ì¡° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      setLoadingGroups(false);
      setLoadingSubjects(false);
      setSubjectGroups([]);
      setSubjectsMap(new Map());
    }
  };

  const handleSearch = () => {
    if (!searchQuery.trim() && !curriculumRevisionId && !subjectGroupId && !subjectId && !publisherId && !platformId && !difficulty) {
      return;
    }

    startSearch(async () => {
      try {
        const result = await searchContentMastersAction({
          content_type: contentType,
          curriculum_revision_id: curriculumRevisionId || undefined,
          subject_group_id: subjectGroupId || undefined,
          subject_id: subjectId || undefined,
          publisher_id: contentType === "book" ? (publisherId || undefined) : undefined,
          platform_id: contentType === "lecture" ? (platformId || undefined) : undefined,
          search: searchQuery.trim() || undefined,
          difficulty: difficulty || undefined,
          sort: sort || undefined,
          limit: 20,
        });
        setResults(result.data);
      } catch (error) {
        alert(
          error instanceof Error
            ? error.message
            : "ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  const handleCopy = async (masterId: string) => {
    setCopyingId(masterId);
    try {
      const result = await copyMasterToStudentContentAction(masterId, studentId);
      const contentId = result.bookId || result.lectureId;
      if (contentId) {
        onContentAdded(contentId, contentType);
        onClose();
      }
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "ì½˜í…ì¸  ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      );
    } finally {
      setCopyingId(null);
    }
  };

  return (
    <Dialog
      open={true}
      onOpenChange={onClose}
      title={contentType === "book" ? "ğŸ“š êµì¬ ê²€ìƒ‰" : "ğŸ§ ê°•ì˜ ê²€ìƒ‰"}
      maxWidth="2xl"
    >
      <DialogContent>
        {/* ê²€ìƒ‰ í¼ */}
        <div className="flex flex-col gap-4">
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-gray-800">
              ì œëª© ê²€ìƒ‰
            </label>
            <input
              type="text"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
              placeholder="êµì¬/ê°•ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter") {
                  handleSearch();
                }
              }}
            />
          </div>
          <div className="flex flex-col gap-3">
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-800">
                ê°œì •êµìœ¡ê³¼ì •
              </label>
              <select
                value={curriculumRevisionId}
                onChange={(e) => {
                  setCurriculumRevisionId(e.target.value);
                  setSubjectGroupId("");
                  setSubjectId("");
                }}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
              >
                <option value="">ì „ì²´</option>
                {curriculumRevisions.map((rev) => (
                  <option key={rev.id} value={rev.id}>
                    {rev.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-800">
                êµê³¼
              </label>
              <select
                value={subjectGroupId}
                onChange={(e) => {
                  setSubjectGroupId(e.target.value);
                  setSubjectId("");
                }}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                disabled={!curriculumRevisionId || loadingGroups}
              >
                <option value="">ì „ì²´</option>
                {loadingGroups ? (
                  <option value="">ë¡œë”© ì¤‘...</option>
                ) : (
                  subjectGroups.map((group) => (
                    <option key={group.id} value={group.id}>
                      {group.name}
                    </option>
                  ))
                )}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-800">
                ê³¼ëª©
              </label>
              <select
                value={subjectId}
                onChange={(e) => setSubjectId(e.target.value)}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                disabled={!subjectGroupId || loadingSubjects}
              >
                <option value="">ì „ì²´</option>
                {loadingSubjects ? (
                  <option value="">ë¡œë”© ì¤‘...</option>
                ) : (
                  currentSubjects.map((subject) => (
                    <option key={subject.id} value={subject.id}>
                      {subject.name}
                    </option>
                  ))
                )}
              </select>
            </div>
            {/* ì¶œíŒì‚¬ (êµì¬ìš©) */}
            {contentType === "book" && publishers.length > 0 && (
              <div className="flex flex-col gap-1">
                <label className="text-sm font-medium text-gray-800">
                  ì¶œíŒì‚¬
                </label>
                <select
                  value={publisherId}
                  onChange={(e) => setPublisherId(e.target.value)}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
                >
                  <option value="">ì „ì²´</option>
                  {publishers.map((publisher) => (
                    <option key={publisher.id} value={publisher.id}>
                      {publisher.name}
                    </option>
                  ))}
                </select>
              </div>
            )}
            {/* í”Œë«í¼ (ê°•ì˜ìš©) */}
            {contentType === "lecture" && platforms.length > 0 && (
              <div className="flex flex-col gap-1">
                <label className="text-sm font-medium text-gray-800">
                  í”Œë«í¼
                </label>
                <select
                  value={platformId}
                  onChange={(e) => setPlatformId(e.target.value)}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
                >
                  <option value="">ì „ì²´</option>
                  {platforms.map((platform) => (
                    <option key={platform.id} value={platform.id}>
                      {platform.name}
                    </option>
                  ))}
                </select>
              </div>
            )}
            {/* ë‚œì´ë„ */}
            {difficulties.length > 0 && (
              <div className="flex flex-col gap-1">
                <label className="text-sm font-medium text-gray-800">
                  ë‚œì´ë„
                </label>
                <select
                  value={difficulty}
                  onChange={(e) => setDifficulty(e.target.value)}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
                >
                  <option value="">ì „ì²´</option>
                  {difficulties.map((diff) => (
                    <option key={diff} value={diff}>
                      {diff}
                    </option>
                  ))}
                </select>
              </div>
            )}
            {/* ì •ë ¬ */}
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-800">
                ì •ë ¬
              </label>
              <select
                value={sort}
                onChange={(e) => setSort(e.target.value)}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
              >
                <option value="updated_at_desc">ìµœì‹ ìˆœ</option>
                <option value="created_at_desc">ìµœì‹ ìˆœ</option>
                <option value="created_at_asc">ì˜¤ë˜ëœìˆœ</option>
                <option value="title_asc">ì œëª© ê°€ë‚˜ë‹¤ìˆœ</option>
                <option value="title_desc">ì œëª© ì—­ìˆœ</option>
                <option value="difficulty_level_asc">ë‚œì´ë„ ë‚®ì€ìˆœ</option>
                <option value="difficulty_level_desc">ë‚œì´ë„ ë†’ì€ìˆœ</option>
              </select>
            </div>
          </div>
          <button
            type="button"
            onClick={handleSearch}
            disabled={isSearching}
            className="w-full rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
          >
            {isSearching ? "ê²€ìƒ‰ ì¤‘..." : "ê²€ìƒ‰"}
          </button>
        </div>

          {/* ê²€ìƒ‰ ê²°ê³¼ */}
          {results.length > 0 && (
            <div className="max-h-96 space-y-2 overflow-y-auto">
              {results.map((master) => (
                <div
                  key={master.id}
                  className="flex items-start justify-between gap-4 rounded-lg border border-gray-200 bg-gray-50 p-4"
                >
                  <div className="flex-1">
                    <h4 className="font-semibold text-gray-900">{master.title}</h4>
                    <div className="flex flex-wrap gap-2 text-xs text-gray-600">
                      {master.publisher_or_academy && (
                        <span>{master.publisher_or_academy}</span>
                      )}
                      {master.subject && <span>Â· {master.subject}</span>}
                      {master.revision && <span>Â· {master.revision}</span>}
                      {master.total_pages && (
                        <span>Â· {master.total_pages}í˜ì´ì§€</span>
                      )}
                      {master.total_episodes && (
                        <span>Â· {master.total_episodes}íšŒì°¨</span>
                      )}
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => handleCopy(master.id)}
                    disabled={copyingId === master.id}
                    className="rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
                  >
                    {copyingId === master.id ? "ë³µì‚¬ ì¤‘..." : "ê°€ì ¸ì˜¤ê¸°"}
                  </button>
                </div>
              ))}
            </div>
          )}

          {results.length === 0 && !isSearching && searchQuery && (
            <div className="py-8 text-center text-sm text-gray-500">
              ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          )}
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="new-group/_components/PlanGroupActivationDialog.tsx">
"use client";

import { useTransition } from "react";
import { useRouter } from "next/navigation";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { updatePlanGroupStatus, checkPlansExistAction } from "@/app/(student)/actions/planGroupActions";
import { useToast } from "@/components/ui/ToastProvider";

type PlanGroupActivationDialogProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  groupId: string;
  activeGroupNames: string[];
};

export function PlanGroupActivationDialog({
  open,
  onOpenChange,
  groupId,
  activeGroupNames,
}: PlanGroupActivationDialogProps) {
  const router = useRouter();
  const toast = useToast();
  const [isPending, startTransition] = useTransition();

  const handleActivate = () => {
    startTransition(async () => {
      try {
        // í”Œëœì´ ì‹¤ì œë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        const checkResult = await checkPlansExistAction(groupId);
        if (!checkResult.hasPlans) {
          toast.showError("í”Œëœì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”Œëœì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.");
          return;
        }

        // í™œì„±í™” ì‹œ ë‹¤ë¥¸ í™œì„± í”Œëœ ê·¸ë£¹ë“¤ì´ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë¨
        await updatePlanGroupStatus(groupId, "active");
        toast.showSuccess(
          activeGroupNames.length > 0
            ? `í”Œëœ ê·¸ë£¹ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ${activeGroupNames.length}ê°œì˜ ë‹¤ë¥¸ í”Œëœ ê·¸ë£¹ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`
            : "í”Œëœ ê·¸ë£¹ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
        );
        onOpenChange(false);
        router.refresh();
        // í™œì„±í™” í›„ í”Œëœ ê·¸ë£¹ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        router.push(`/plan/group/${groupId}`, { scroll: true });
      } catch (error) {
        toast.showError(
          error instanceof Error
            ? error.message
            : "í”Œëœ ê·¸ë£¹ í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  const handleCancel = () => {
    // ì·¨ì†Œ ì‹œ saved ìƒíƒœë¡œ ì €ì¥
    startTransition(async () => {
      try {
        await updatePlanGroupStatus(groupId, "saved");
        toast.showSuccess("í”Œëœ ê·¸ë£¹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        onOpenChange(false);
        router.refresh();
        // ì €ì¥ í›„ í”Œëœ ê·¸ë£¹ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        router.push(`/plan/group/${groupId}`, { scroll: true });
      } catch (error) {
        toast.showError(
          error instanceof Error
            ? error.message
            : "í”Œëœ ê·¸ë£¹ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        );
      }
    });
  };

  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title="í”Œëœ ê·¸ë£¹ í™œì„±í™”"
      description="ì´ í”Œëœ ê·¸ë£¹ì„ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
    >
      <DialogContent>
        <div className="flex flex-col gap-4">
          {activeGroupNames.length > 0 && (
            <div className="flex flex-col gap-3 rounded-lg border border-yellow-200 bg-yellow-50 p-4">
              <p className="text-sm font-medium text-yellow-800">
                í˜„ì¬ í™œì„±í™”ëœ í”Œëœ ê·¸ë£¹ì´ ìˆìŠµë‹ˆë‹¤.
              </p>
              <p className="text-sm text-yellow-700">
                ì´ í”Œëœ ê·¸ë£¹ì„ í™œì„±í™”í•˜ë©´ ë‹¤ìŒ í”Œëœ ê·¸ë£¹ì´ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤:
              </p>
              <ul className="flex flex-col gap-1 pl-4 list-disc">
                {activeGroupNames.map((name, index) => (
                  <li key={index} className="text-sm text-yellow-700">
                    {name || "í”Œëœ ê·¸ë£¹"}
                  </li>
                ))}
              </ul>
            </div>
          )}

          <p className="text-sm text-gray-600">
            í•œ ë²ˆì— í•˜ë‚˜ì˜ í”Œëœ ê·¸ë£¹ë§Œ í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
          </p>
        </div>
      </DialogContent>
      <DialogFooter>
        <button
          type="button"
          onClick={handleCancel}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isPending ? "ì €ì¥ ì¤‘..." : "ì·¨ì†Œ (ì €ì¥)"}
        </button>
        <button
          type="button"
          onClick={handleActivate}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg border border-green-300 bg-green-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-green-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isPending ? "í™œì„±í™” ì¤‘..." : "í™œì„±í™”"}
        </button>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="new-group/_components/PlanGroupWizard.tsx">
"use client";

import { useState, useTransition, useMemo, useCallback, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { getActivePlanGroups } from "@/app/(student)/actions/planGroupActions";
import { PlanGroupActivationDialog } from "./PlanGroupActivationDialog";
import { useToast } from "@/components/ui/ToastProvider";
import { scrollToTop, scrollToField } from "@/lib/utils/scroll";
import { getFirstErrorFieldId } from "./hooks/useWizardValidation";
import {
  createPlanGroupAction,
  savePlanGroupDraftAction,
  updatePlanGroupDraftAction,
  updatePlanGroupAction,
  generatePlansFromGroupAction,
  updatePlanGroupStatus,
  checkPlansExistAction,
} from "@/app/(student)/actions/planGroupActions";
import { updateCampTemplateAction } from "@/app/(admin)/actions/campTemplateActions";
import { PlanGroupCreationData } from "@/lib/types/plan";
import { WizardValidator } from "@/lib/validation/wizardValidator";
import { PlanValidator } from "@/lib/validation/planValidator";
import { validateDataConsistency } from "@/lib/utils/planGroupDataSync";
import { useWizardValidation } from "./hooks/useWizardValidation";
import { usePlanSubmission } from "./hooks/usePlanSubmission";
import { PlanGroupError, toPlanGroupError, isRecoverableError, PlanGroupErrorCodes } from "@/lib/errors/planGroupErrors";
import type { SchedulerOptions } from "@/lib/types/plan";
import { createWizardMode, isLastStep as checkIsLastStep, shouldSubmitAtStep4, shouldSaveOnlyWithoutPlanGeneration, canGoBack } from "./utils/modeUtils";
import { Step1BasicInfo } from "./Step1BasicInfo";
import { Step2TimeSettings } from "./Step2TimeSettings";
import { Step3SchedulePreview } from "./Step3SchedulePreview";
import { Step3ContentSelection } from "./Step3ContentSelection";
import { Step6FinalReview } from "./Step6FinalReview";
import { Step6Simplified } from "./Step6Simplified";
import { Step7ScheduleResult } from "./Step7ScheduleResult";

export type WizardStep = 1 | 2 | 3 | 4 | 5 | 6 | 7;

/**
 * í…œí”Œë¦¿ ê³ ì • í•„ë“œ íƒ€ì…
 */
export type TemplateLockedFields = {
  step1?: {
    allow_student_name?: boolean;
    allow_student_plan_purpose?: boolean;
    allow_student_scheduler_type?: boolean;
    allow_student_period?: boolean;
    allow_student_block_set_id?: boolean;
    allow_student_student_level?: boolean;
    allow_student_subject_allocations?: boolean;
    allow_student_study_review_cycle?: boolean;
    allow_student_additional_period_reallocation?: boolean;
  };
  // í–¥í›„ í™•ì¥ ê°€ëŠ¥
  step2?: Record<string, boolean>;
  step3?: Record<string, boolean>;
  step4?: Record<string, boolean>;
  step5?: Record<string, boolean>;
  step6?: Record<string, boolean>;
};

export type WizardData = {
  // Step 1
  name: string;
  plan_purpose: "ë‚´ì‹ ëŒ€ë¹„" | "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)" | "";
  scheduler_type: "1730_timetable" | "";
  scheduler_options?: {
    study_days?: number;
    review_days?: number;
  };
  period_start: string;
  period_end: string;
  target_date?: string;
  block_set_id: string;
  // Step 2
  exclusions: Array<{
    exclusion_date: string;
    exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
    reason?: string;
    source?: "template" | "student" | "time_management"; // ì¶œì²˜ êµ¬ë¶„
    is_locked?: boolean; // í…œí”Œë¦¿ì—ì„œ ê³ ì •ëœ ì œì™¸ì¼
  }>;
  academy_schedules: Array<{
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string;
    subject?: string;
    travel_time?: number; // ì´ë™ì‹œê°„ (ë¶„ ë‹¨ìœ„, ê¸°ë³¸ê°’: 60ë¶„)
    source?: "template" | "student" | "time_management"; // ì¶œì²˜ êµ¬ë¶„
    is_locked?: boolean; // í…œí”Œë¦¿ì—ì„œ ê³ ì •ëœ í•™ì› ì¼ì •
  }>;
  // Step 2 - ì‹œê°„ ì„¤ì •
  time_settings?: {
    lunch_time?: {
      start: string; // "12:00"
      end: string; // "13:00"
    };
    // 1730 Timetable ì „ìš© ì„¤ì •
    camp_study_hours?: {
      start: string; // "10:00"
      end: string; // "19:00"
    };
    camp_self_study_hours?: {
      start: string; // "19:00"
      end: string; // "22:00"
    };
    designated_holiday_hours?: {
      start: string; // "13:00"
      end: string; // "19:00"
    };
    // ììœ¨í•™ìŠµì‹œê°„ ì‚¬ìš© ê°€ëŠ¥ (í•™ìƒ/ë“±ë¡ ì‹œê°„ë¸”ë¡ê³¼ ì¡°ìœ¨)
    use_self_study_with_blocks?: boolean;
    // ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì • í† ê¸€
    enable_self_study_for_holidays?: boolean; // ì§€ì •íœ´ì¼ ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì •
    enable_self_study_for_study_days?: boolean; // í•™ìŠµì¼/ë³µìŠµì¼ ììœ¨í•™ìŠµ ì‹œê°„ ë°°ì •
  };
  // Step 3 - í•™ìƒ ì½˜í…ì¸ 
  student_contents: Array<{
    content_type: "book" | "lecture";
    content_id: string;
    start_range: number;
    end_range: number;
    start_detail_id?: string | null; // ì‹œì‘ ë²”ìœ„ ìƒì„¸ ì •ë³´ ID (book_details.id ë˜ëŠ” lecture_episodes.id)
    end_detail_id?: string | null; // ì¢…ë£Œ ë²”ìœ„ ìƒì„¸ ì •ë³´ ID (book_details.id ë˜ëŠ” lecture_episodes.id)
    title?: string; // ì¶”ê°€: ì œëª© ì €ì¥
    subject_category?: string; // ì¶”ê°€: ê³¼ëª© ì¹´í…Œê³ ë¦¬ ì €ì¥ (í•„ìˆ˜ ê³¼ëª© ê²€ì¦ìš©)
    subject?: string; // ì¶”ê°€: ì„¸ë¶€ ê³¼ëª© ì €ì¥ (ê²€ì¦ìš©)
    master_content_id?: string | null; // ì¶”ê°€: ë§ˆìŠ¤í„° ì½˜í…ì¸  ID (ì¤‘ë³µ ë°©ì§€ìš©)
  }>;
  // Step 4 - ì¶”ì²œ ì½˜í…ì¸ 
  recommended_contents: Array<{
    content_type: "book" | "lecture";
    content_id: string;
    start_range: number;
    end_range: number;
    start_detail_id?: string | null; // ì‹œì‘ ë²”ìœ„ ìƒì„¸ ì •ë³´ ID (book_details.id ë˜ëŠ” lecture_episodes.id)
    end_detail_id?: string | null; // ì¢…ë£Œ ë²”ìœ„ ìƒì„¸ ì •ë³´ ID (book_details.id ë˜ëŠ” lecture_episodes.id)
    title?: string; // ì¶”ê°€: ì œëª© ì €ì¥
    subject_category?: string; // ì¶”ê°€: ê³¼ëª© ì¹´í…Œê³ ë¦¬ ì €ì¥ (í•„ìˆ˜ ê³¼ëª© ê²€ì¦ìš©)
    subject?: string; // ì¶”ê°€: ì„¸ë¶€ ê³¼ëª© ì €ì¥ (ê²€ì¦ìš©)
    is_auto_recommended?: boolean; // ìë™ ë°°ì • í”Œë˜ê·¸
    recommendation_source?: "auto" | "admin" | "template" | null; // ìë™ ë°°ì • ì†ŒìŠ¤
    recommendation_reason?: string | null; // ì¶”ì²œ ì‚¬ìœ 
    recommendation_metadata?: Record<string, unknown> | null; // ì¶”ì²œ ë©”íƒ€ë°ì´í„°
  }>;
  // Step 2.5 - ìŠ¤ì¼€ì¤„ ìš”ì•½ ì •ë³´ (Step 3ì—ì„œ í•™ìŠµ ë²”ìœ„ ì¶”ì²œì— ì‚¬ìš©)
  schedule_summary?: {
    total_days: number;
    total_study_days: number;
    total_review_days: number;
    total_study_hours: number;
    total_study_hours_í•™ìŠµì¼: number;
    total_study_hours_ë³µìŠµì¼: number;
    total_self_study_hours: number;
  };
  // Step 2.5 - ì¼ë³„ ìŠ¤ì¼€ì¤„ ì •ë³´ (plan_groups.daily_scheduleì— ì €ì¥)
  daily_schedule?: Array<{
    date: string;
    day_type: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •";
    study_hours: number;
    available_time_ranges: Array<{ start: string; end: string }>;
    note: string;
    academy_schedules?: Array<{
      day_of_week: number;
      start_time: string;
      end_time: string;
      academy_name?: string;
      subject?: string;
      travel_time?: number;
    }>;
    exclusion?: {
      exclusion_date: string;
      exclusion_type: string;
      reason?: string;
    } | null;
    week_number?: number;
    time_slots?: Array<{
      type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
      start: string;
      end: string;
      label?: string;
    }>;
  }>;
  // 1730 Timetable ì¶”ê°€ í•„ë“œ
  study_review_cycle?: {
    study_days: number; // ê¸°ë³¸ê°’: 6
    review_days: number; // ê¸°ë³¸ê°’: 1
  };
  // í•™ìƒ ìˆ˜ì¤€ ì •ë³´ (í•„ìˆ˜)
  student_level?: "high" | "medium" | "low";
  // ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì •ë³´ (í•„ìˆ˜)
  subject_allocations?: Array<{
    subject_id: string;
    subject_name: string;
    subject_type: "strategy" | "weakness";
    weekly_days?: number; // ì „ëµê³¼ëª©ì¸ ê²½ìš°: 2, 3, 4
  }>;
  subject_constraints?: {
    enable_required_subjects_validation?: boolean; // í•„ìˆ˜ ê³¼ëª© ê²€ì¦ ì‚¬ìš© ì—¬ë¶€ (í…œí”Œë¦¿ ëª¨ë“œì—ì„œ ì„¤ì •)
    required_subjects?: Array<{
      subject_group_id: string; // subject_groups í…Œì´ë¸” ID
      subject_category: string; // í‘œì‹œìš© ì´ë¦„ (subject_groups.name)
      min_count: number; // ìµœì†Œ ê°œìˆ˜
      // ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© (ì„ íƒì‚¬í•­)
      subjects_by_curriculum?: Array<{
        curriculum_revision_id: string;
        subject_id?: string; // subjects í…Œì´ë¸” ID
        subject_name?: string; // í‘œì‹œìš© (subjects.name)
      }>;
    }>; // í•„ìˆ˜ êµê³¼/ê³¼ëª© ëª©ë¡ (ìœ„ê³„ êµ¬ì¡° + ê°œìˆ˜)
    excluded_subjects?: string[];
    constraint_handling: "strict" | "warning" | "auto_fix";
  };
  additional_period_reallocation?: {
    period_start: string;
    period_end: string;
    type: "additional_review";
    original_period_start: string;
    original_period_end: string;
    subjects?: string[];
    review_of_review_factor?: number; // ê¸°ë³¸ê°’: 0.25
  };
  non_study_time_blocks?: Array<{
    type: "ì•„ì¹¨ì‹ì‚¬" | "ì €ë…ì‹ì‚¬" | "ìˆ˜ë©´" | "ê¸°íƒ€"; // "ì ì‹¬ì‹ì‚¬" ì œê±°
    start_time: string; // HH:mm
    end_time: string; // HH:mm
    day_of_week?: number[]; // 0-6, ì—†ìœ¼ë©´ ë§¤ì¼
    description?: string;
  }>;
  // í…œí”Œë¦¿ ê³ ì • í•„ë“œ (í…œí”Œë¦¿ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©)
  templateLockedFields?: TemplateLockedFields;
  // ìº í”„ ê´€ë ¨ í•„ë“œ (Step 7ì—ì„œ ì‚¬ìš©)
  plan_type?: "individual" | "integrated" | "camp";
  camp_template_id?: string | null;
  camp_invitation_id?: string | null;
  // Step 4 - í•„ìˆ˜ êµê³¼ ì„¤ì • UI í‘œì‹œ ì—¬ë¶€
  show_required_subjects_ui?: boolean;
  // Step 6 - ì½˜í…ì¸ ë³„ ì „ëµ/ì·¨ì•½ ì„¤ì • (ìš°ì„ ìˆœìœ„)
  content_allocations?: Array<{
    content_type: "book" | "lecture";
    content_id: string;
    subject_type: "strategy" | "weakness";
    weekly_days?: number; // ì „ëµê³¼ëª©ì¸ ê²½ìš°ë§Œ
  }>;
  // Step 6 - ì „ëµ/ì·¨ì•½ ì„¤ì • ëª¨ë“œ ("subject" | "content")
  allocation_mode?: "subject" | "content";
};

type ExtendedInitialData = Partial<WizardData> & {
  groupId?: string;
  templateId?: string;
  templateProgramType?: string;
  templateStatus?: string;
  _startStep?: number;
  _validationErrors?: string[];
  student_id?: string;
  contents?: WizardData["student_contents"]; // ê¸°ì¡´ êµ¬ì¡° í˜¸í™˜ì„±
};

type PlanGroupWizardProps = {
  initialBlockSets?: Array<{ id: string; name: string }>;
  initialContents?: {
    books: Array<{ id: string; title: string; subtitle?: string | null; master_content_id?: string | null }>;
    lectures: Array<{ id: string; title: string; subtitle?: string | null; master_content_id?: string | null }>;
    custom: Array<{ id: string; title: string; subtitle?: string | null }>;
  };
  initialData?: ExtendedInitialData;
  isEditMode?: boolean;
  isCampMode?: boolean;
  campInvitationId?: string;
  isTemplateMode?: boolean; // í…œí”Œë¦¿ ìƒì„± ëª¨ë“œ (ê´€ë¦¬ììš©)
  isAdminMode?: boolean; // ê´€ë¦¬ì ëª¨ë“œ (ê´€ë¦¬ììš©)
  isAdminContinueMode?: boolean; // ê´€ë¦¬ì ë‚¨ì€ ë‹¨ê³„ ì§„í–‰ ëª¨ë“œ (1~4ë‹¨ê³„ ì½ê¸° ì „ìš©, 5~7ë‹¨ê³„ë§Œ í¸ì§‘)
  onTemplateSave?: (wizardData: WizardData) => Promise<void>; // í…œí”Œë¦¿ ì €ì¥ ì½œë°±
  onSaveRequest?: (saveFn: () => Promise<void>) => void; // ì €ì¥ í•¨ìˆ˜ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œ
};


// Stepë³„ ê°€ì¤‘ì¹˜ (ì§„í–‰ë¥  ê³„ì‚°ìš©)
const stepWeights: Record<WizardStep, number> = {
  1: 16.67,  // ê¸°ë³¸ ì •ë³´ (1/6)
  2: 16.67,  // ë¸”ë¡ ë° ì œì™¸ì¼ (2/6)
  3: 16.67,  // ìŠ¤ì¼€ì¤„ í™•ì¸ (3/6)
  4: 16.67,  // ì½˜í…ì¸  ì„ íƒ (4/6)
  5: 16.67,  // ì¶”ì²œ ì½˜í…ì¸  (5/6)
  6: 16.65,  // ìµœì¢… í™•ì¸ (6/6)
  7: 0,      // ìŠ¤ì¼€ì¤„ ê²°ê³¼ (ì™„ë£Œ í›„)
};

/**
 * ì§„í–‰ë¥  ê³„ì‚° í•¨ìˆ˜
 */
function calculateProgress(currentStep: WizardStep, wizardData: WizardData, isTemplateMode: boolean = false): number {
  let progress = 0;

  // ì™„ë£Œëœ Stepë“¤ì˜ ê°€ì¤‘ì¹˜ í•©ì‚°
  for (let step = 1; step < currentStep; step++) {
    // í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œ Step 5, 6, 7 ì œì™¸ (1, 2, 3, 4ë§Œ)
    if (isTemplateMode && (step === 5 || step === 6 || step === 7)) {
      continue;
    }
    progress += stepWeights[step as WizardStep];
  }

  // í˜„ì¬ Stepì˜ ë¶€ë¶„ ì™„ë£Œë„ ê³„ì‚°
  // í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œ Step 5, 6, 7ì€ ê°€ì¤‘ì¹˜ 0ìœ¼ë¡œ ì²˜ë¦¬
  const currentStepWeight = (isTemplateMode && (currentStep === 5 || currentStep === 6 || currentStep === 7)) ? 0 : stepWeights[currentStep];
  let currentStepProgress = 0;

  switch (currentStep) {
    case 1:
      // ê¸°ë³¸ ì •ë³´: name, plan_purpose, scheduler_type, period, block_set_id
      let step1Count = 0;
      let step1Total = 5;
      if (wizardData.name && wizardData.name.trim() !== "") step1Count++;
      // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í•™ìƒ ì…ë ¥ í—ˆìš©ì´ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ plan_purposeëŠ” ì„ íƒì‚¬í•­
      const isPlanPurposeOptional = isTemplateMode && wizardData.templateLockedFields?.step1?.allow_student_plan_purpose === true;
      if (isPlanPurposeOptional) {
        step1Total = 4; // plan_purpose ì œì™¸
      } else {
        if (wizardData.plan_purpose) step1Count++;
      }
      if (wizardData.scheduler_type) step1Count++;
      if (wizardData.period_start && wizardData.period_end) step1Count++;
      if (wizardData.block_set_id) step1Count++;
      currentStepProgress = (step1Count / step1Total) * currentStepWeight;
      break;
    case 2:
      // ë¸”ë¡ ë° ì œì™¸ì¼: í•­ìƒ ì™„ë£Œë¡œ ê°„ì£¼ (ì„ íƒì‚¬í•­)
      currentStepProgress = currentStepWeight;
      break;
    case 3:
      // ìŠ¤ì¼€ì¤„ í™•ì¸: í•­ìƒ ì™„ë£Œë¡œ ê°„ì£¼ (í™•ì¸ë§Œ í•˜ëŠ” ë‹¨ê³„)
      currentStepProgress = currentStepWeight;
      break;
    case 4:
      // ì½˜í…ì¸  ì„ íƒ: student_contents ë˜ëŠ” recommended_contentsê°€ ìˆìœ¼ë©´ ì™„ë£Œ
      const hasAnyContent = wizardData.student_contents.length > 0 || wizardData.recommended_contents.length > 0;
      currentStepProgress = hasAnyContent ? currentStepWeight : 0;
      break;
    case 5:
      // ì¶”ì²œ ì½˜í…ì¸ : í•­ìƒ ì™„ë£Œ (ì„ íƒì‚¬í•­)
      currentStepProgress = currentStepWeight;
      break;
    case 6:
      // ìµœì¢… í™•ì¸: í•­ìƒ ì™„ë£Œ
      currentStepProgress = currentStepWeight;
      break;
    case 7:
      // ìŠ¤ì¼€ì¤„ ê²°ê³¼: í•­ìƒ ì™„ë£Œ
      currentStepProgress = currentStepWeight;
      break;
  }

  progress += currentStepProgress;

  return Math.min(progress, 100);
}

/**
 * ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì½ì€ plan_purposeë¥¼ UI í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 * ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±: "ìˆ˜ëŠ¥" ë˜ëŠ” "ëª¨ì˜ê³ ì‚¬"ëŠ” "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)"ìœ¼ë¡œ ë³€í™˜
 * ìƒˆ ë°ì´í„°: "ë‚´ì‹ ëŒ€ë¹„", "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)"ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
 */
function denormalizePlanPurpose(purpose: string | null | undefined): "" | "ë‚´ì‹ ëŒ€ë¹„" | "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)" {
  if (!purpose) return "";
  // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±: "ìˆ˜ëŠ¥" ë˜ëŠ” "ëª¨ì˜ê³ ì‚¬"ëŠ” "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)"ìœ¼ë¡œ ë³€í™˜
  if (purpose === "ìˆ˜ëŠ¥" || purpose === "ëª¨ì˜ê³ ì‚¬") return "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)";
  // ìƒˆ ë°ì´í„°: "ë‚´ì‹ ëŒ€ë¹„", "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)"ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  if (purpose === "ë‚´ì‹ ëŒ€ë¹„" || purpose === "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)") return purpose as "ë‚´ì‹ ëŒ€ë¹„" | "ëª¨ì˜ê³ ì‚¬(ìˆ˜ëŠ¥)";
  return "";
}

export function PlanGroupWizard({
  initialBlockSets = [],
  initialContents = { books: [], lectures: [], custom: [] },
  initialData,
  isEditMode = false,
  isCampMode = false,
  campInvitationId,
  isTemplateMode = false,
  isAdminMode = false,
  isAdminContinueMode = false,
  onTemplateSave,
  onSaveRequest,
}: PlanGroupWizardProps) {
  const router = useRouter();
  const toast = useToast();
  
  // ëª¨ë“œ í†µí•© ê´€ë¦¬
  const mode = useMemo(() => createWizardMode({
    isCampMode,
    isTemplateMode,
    isAdminMode,
    isAdminContinueMode,
    isEditMode,
  }), [isCampMode, isTemplateMode, isAdminMode, isAdminContinueMode, isEditMode]);
  
  // _startStepì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‹¨ê³„ë¡œ ì´ˆê¸°í™” (ê´€ë¦¬ì ë‚¨ì€ ë‹¨ê³„ ì§„í–‰ ëª¨ë“œ)
  const initialStep = initialData?._startStep 
    ? (initialData._startStep as WizardStep)
    : 1;

  const initialContentsState = useMemo(() => {
    if (initialData?.student_contents || initialData?.recommended_contents) {
      return {
        student_contents: initialData.student_contents || [],
        recommended_contents: initialData.recommended_contents || [],
      };
    }
    // ê¸°ì¡´ êµ¬ì¡°: contentsê°€ ìˆìœ¼ë©´ ëª¨ë‘ student_contentsë¡œ ì²˜ë¦¬
    if (initialData?.contents) {
      return {
        student_contents: initialData.contents,
        recommended_contents: [],
      };
    }
    return {
      student_contents: [],
      recommended_contents: [],
    };
  }, [initialData]);

  const [currentStep, setCurrentStep] = useState<WizardStep>(initialStep);
  const [blockSets, setBlockSets] = useState(initialBlockSets);
  
  // WizardData ì´ˆê¸°ê°’ ì„¤ì •
  const [wizardData, setWizardData] = useState<WizardData>(() => ({
    name: initialData?.name || "",
    // plan_purpose ì •ê·œí™” ì²˜ë¦¬
    plan_purpose: denormalizePlanPurpose(initialData?.plan_purpose),
    scheduler_type: (initialData?.scheduler_type as "1730_timetable" | "") || "1730_timetable",
    period_start: initialData?.period_start || "",
    period_end: initialData?.period_end || "",
    target_date: initialData?.target_date || undefined,
    block_set_id: initialData?.block_set_id || "",
    // scheduler_options ì´ˆê¸°í™”
    scheduler_options: {
      ...(initialData?.scheduler_options || {}),
      study_days:
        (initialData?.scheduler_options as SchedulerOptions | undefined)?.study_days ||
        initialData?.study_review_cycle?.study_days ||
        6,
      review_days:
        (initialData?.scheduler_options as SchedulerOptions | undefined)?.review_days ||
        initialData?.study_review_cycle?.review_days ||
        1,
      student_level:
        initialData?.student_level ||
        (initialData?.scheduler_options as SchedulerOptions | undefined)?.student_level,
    },
    exclusions:
      initialData?.exclusions?.map((e) => ({
        exclusion_date: e.exclusion_date,
        exclusion_type: e.exclusion_type,
        reason: e.reason,
        source: e.source,
        is_locked: e.is_locked,
      })) || [],
    academy_schedules:
      initialData?.academy_schedules?.map((s) => ({
        day_of_week: s.day_of_week,
        start_time: s.start_time,
        end_time: s.end_time,
        academy_name: s.academy_name,
        subject: s.subject,
        travel_time: s.travel_time,
        source: s.source,
        is_locked: s.is_locked,
      })) || [],
    time_settings: initialData?.time_settings,
    student_contents: initialContentsState.student_contents,
    recommended_contents: initialContentsState.recommended_contents,
    // 1730 Timetable ì¶”ê°€ í•„ë“œ
    study_review_cycle: initialData?.study_review_cycle || {
      study_days: (initialData?.scheduler_options as SchedulerOptions | undefined)?.study_days || 6,
      review_days: (initialData?.scheduler_options as SchedulerOptions | undefined)?.review_days || 1,
    },
    student_level:
      initialData?.student_level ||
      (initialData?.scheduler_options as SchedulerOptions | undefined)?.student_level,
    subject_allocations:
      initialData?.subject_allocations ||
      (initialData?.scheduler_options as SchedulerOptions | undefined)?.subject_allocations,
    content_allocations: (initialData?.scheduler_options as SchedulerOptions | undefined)
      ?.content_allocations,
    subject_constraints: initialData?.subject_constraints,
    additional_period_reallocation:
      initialData?.additional_period_reallocation,
    non_study_time_blocks: initialData?.non_study_time_blocks,
    // ì¼ë³„ ìŠ¤ì¼€ì¤„ ì •ë³´
    daily_schedule: initialData?.daily_schedule,
    // ìº í”„ ì •ë³´ (ì´ˆê¸° ë°ì´í„°ì—ì„œ)
    plan_type: initialData?.plan_type,
    camp_template_id: initialData?.camp_template_id,
    camp_invitation_id: initialData?.camp_invitation_id,
    templateLockedFields: initialData?.templateLockedFields || (isTemplateMode ? {
      step1: {
        allow_student_name: false,
        allow_student_plan_purpose: false,
        allow_student_scheduler_type: false,
        allow_student_period: false,
        allow_student_block_set_id: false,
        allow_student_student_level: false,
        allow_student_subject_allocations: false,
        allow_student_study_review_cycle: false,
        allow_student_additional_period_reallocation: false,
      },
      step2: {
        allow_student_exclusions: false,
        allow_student_academy_schedules: false,
        allow_student_time_settings: false,
        allow_student_non_study_time_blocks: false,
      },
    } : undefined),
  }));

  // State for Draft and Template
  const [draftGroupId, setDraftGroupId] = useState<string | null>(
    initialData?.groupId || null
  );
  const templateId = initialData?.templateId;
  const templateProgramType = initialData?.templateProgramType || "ê¸°íƒ€";
  const templateStatus = initialData?.templateStatus || "draft";

  // ë””ë²„ê¹…: templateId í™•ì¸
  // if (isTemplateMode && !templateId && process.env.NODE_ENV === "development") { ... }

  // Validation Hook
  const {
    validationErrors,
    validationWarnings,
    fieldErrors,
    setValidationErrors,
    setValidationWarnings,
    validateStep,
    clearValidationState
  } = useWizardValidation({
    wizardData,
    isTemplateMode
  });

  // Submission Hook
  const { isSubmitting, executeSave, handleSubmit } = usePlanSubmission({
      wizardData,
      draftGroupId,
      setDraftGroupId,
      currentStep,
      setCurrentStep,
      setValidationErrors,
      isCampMode,
      campInvitationId,
      initialData,
      isAdminContinueMode,
      isAdminMode: isAdminMode || false,
      onSaveRequest,
  });

  // Alias for backward compatibility / readability
  const handleSaveDraft = executeSave;
  
  // ì´ˆê¸° ê²€ì¦ ì—ëŸ¬ ì²˜ë¦¬ (usePlanSubmission/validation ì´ˆê¸°í™”ì™€ ì¶©ëŒ ë°©ì§€ ìœ„í•´ hook ì´í›„ì— ì²˜ë¦¬í•˜ê±°ë‚˜ hook ë‚´ë¶€ë¡œ ì´ë™ ê¶Œì¥ë˜ì§€ë§Œ, ìš°ì„  ì—¬ê¸°ì„œ ìƒíƒœ ë™ê¸°í™”)
  useEffect(() => {
     if (initialData?._validationErrors) {
         setValidationErrors(initialData._validationErrors);
     }
  }, [initialData, setValidationErrors]);
  
  // Removed isPending/startTransition as usePlanSubmission handles loading state
  // const [isPending, startTransition] = useTransition();
  // const isSubmittingRef = useRef(false); 

  const [activationDialogOpen, setActivationDialogOpen] = useState(false);
  const [activeGroupNames, setActiveGroupNames] = useState<string[]>([]);

  // block_set_id ë³€ê²½ ì¶”ì  (ìë™ ì €ì¥ ë°©ì§€ìš©)
  const prevBlockSetIdRef = useRef<string | undefined>(wizardData.block_set_id);
  const isBlockSetIdOnlyChangeRef = useRef(false);

  // ë‹¨ê³„ ë³€ê²½ ì‹œ ìŠ¤í¬ë¡¤ì„ ìƒë‹¨ìœ¼ë¡œ ì´ë™
  useEffect(() => {
    scrollToTop();
  }, [currentStep]);

  // block_set_id ë³€ê²½ ê°ì§€ (ìë™ ì €ì¥ ë°©ì§€ë¥¼ ìœ„í•œ ì¶”ì )
  useEffect(() => {
    const currentBlockSetId = wizardData.block_set_id;
    const prevBlockSetId = prevBlockSetIdRef.current;

    if (prevBlockSetId !== currentBlockSetId) {
      // block_set_idê°€ ë³€ê²½ë˜ì—ˆìŒì„ í‘œì‹œ
      isBlockSetIdOnlyChangeRef.current = true;
      prevBlockSetIdRef.current = currentBlockSetId;

      // ë‹¤ìŒ ë Œë”ë§ ì‚¬ì´í´ì—ì„œ í”Œë˜ê·¸ ë¦¬ì…‹ (ë‹¤ë¥¸ í•„ë“œ ë³€ê²½ê³¼ êµ¬ë¶„)
      setTimeout(() => {
        isBlockSetIdOnlyChangeRef.current = false;
      }, 0);
    }
  }, [wizardData.block_set_id]);

  const updateWizardData = useCallback((
    updates: Partial<WizardData> | ((prev: WizardData) => Partial<WizardData>)
  ) => {
    if (typeof updates === "function") {
      setWizardData((prev) => {
        const partialUpdates = updates(prev);
        return { ...prev, ...partialUpdates };
      });
    } else {
      setWizardData((prev) => ({ ...prev, ...updates }));
    }
    setValidationErrors([]);
    setValidationWarnings([]);
  }, [setValidationErrors, setValidationWarnings]);

  // validateStep Logic replaced by useWizardValidation hook

  // ì²« ë²ˆì§¸ ì˜¤ë¥˜ í•„ë“œë¡œ ìŠ¤í¬ë¡¤ ì´ë™ í•¨ìˆ˜
  const scrollToFirstError = useCallback(() => {
    if (fieldErrors.size === 0) return;

    // í™”ë©´ ìˆœì„œì— ë”°ë¼ ì²« ë²ˆì§¸ ì˜¤ë¥˜ í•„ë“œ ì°¾ê¸°
    const firstFieldId = getFirstErrorFieldId(fieldErrors, currentStep);
    if (!firstFieldId) return;

    // DOM ì—…ë°ì´íŠ¸ í›„ ìŠ¤í¬ë¡¤ ì‹¤í–‰
    // requestAnimationFrameì„ ë‘ ë²ˆ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì € ë Œë”ë§ ì™„ë£Œ ë³´ì¥
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        scrollToField(firstFieldId);
      });
    });
  }, [fieldErrors, currentStep]);

  // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ref
  const shouldScrollToErrorRef = useRef(false);

  // fieldErrorsê°€ ë³€ê²½ë˜ê³  ìŠ¤í¬ë¡¤ í”Œë˜ê·¸ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ìŠ¤í¬ë¡¤ ì‹¤í–‰
  useEffect(() => {
    if (shouldScrollToErrorRef.current && fieldErrors.size > 0) {
      shouldScrollToErrorRef.current = false;
      scrollToFirstError();
    }
  }, [fieldErrors, scrollToFirstError]);

  const handleNext = useCallback(() => {
    // Step 3 (ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°)ì—ì„œëŠ” ê²€ì¦ ë¡œì§ ê±´ë„ˆë›°ê¸°
    if (currentStep !== 3) {
      if (!validateStep(currentStep)) {
        // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¡¤ í”Œë˜ê·¸ ì„¤ì •
        // useEffectì—ì„œ fieldErrors ë³€ê²½ ê°ì§€ í›„ ìŠ¤í¬ë¡¤ ì‹¤í–‰
        shouldScrollToErrorRef.current = true;
        return;
      }
    }

    // isAdminContinueModeì¼ ë•Œ Step 3ì—ì„œ Step 4ë¡œ ì´ë™ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€
    if (mode.isAdminContinueMode && currentStep === 3) {
      setCurrentStep(4);
      return;
    }

    // í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œ Step 4ì—ì„œ í…œí”Œë¦¿ ì €ì¥
    if (shouldSubmitAtStep4(mode) && currentStep === 4) {
      handleSubmit();
      return;
    }

    // Step 5 (í•™ìŠµë²”ìœ„ ì ê²€)ì—ì„œ ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì‹œ
    if (currentStep === 5) {
      // ì¼ë°˜ ëª¨ë“œ: ë°ì´í„°ë§Œ ì €ì¥ í›„ Step 6ìœ¼ë¡œ ì´ë™ (í”Œëœ ìƒì„±ì€ Step 6 â†’ Step 7 ì „í™˜ ì‹œ)
      // ìº í”„ ëª¨ë“œ: ë°ì´í„°ë§Œ ì €ì¥ í›„ Step 6ìœ¼ë¡œ ì´ë™ (í”Œëœ ìƒì„±ì€ Step 7ì—ì„œ)
      handleSubmit(shouldSaveOnlyWithoutPlanGeneration(mode) ? false : false);
      return;
    }

    // Step 6 (ìµœì¢… í™•ì¸)ì—ì„œ ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì‹œ
    if (currentStep === 6) {
      // ê´€ë¦¬ì continue ëª¨ë“œ: ë°ì´í„°ë§Œ ì €ì¥ í›„ Step 7ë¡œ ì´ë™
      // ì¼ë°˜ ëª¨ë“œ: í”Œëœ ìƒì„± í›„ Step 7ë¡œ ì´ë™
      handleSubmit(shouldSaveOnlyWithoutPlanGeneration(mode) ? false : true);
      return;
    }

    if (currentStep < 5) {
      if (currentStep === 4) {
        // í…œí”Œë¦¿ ëª¨ë“œë‚˜ ìº í”„ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ Step 4ì—ì„œ ë°ì´í„°ë§Œ ì €ì¥í•˜ê³  Step 5ë¡œ ì´ë™
        // í…œí”Œë¦¿ ëª¨ë“œë‚˜ ìº í”„ ëª¨ë“œì¼ ë•ŒëŠ” ìœ„ì—ì„œ ì´ë¯¸ handleSubmit()ì´ í˜¸ì¶œë¨
        if (!shouldSubmitAtStep4(mode)) {
          // Step 4ì—ì„œëŠ” ë°ì´í„°ë§Œ ì €ì¥í•˜ê³  Step 5ë¡œ ì´ë™ (í”Œëœ ìƒì„±ì€ Step 5ì—ì„œ)
          // handleSubmit ë‚´ë¶€ì—ì„œ setCurrentStep(5)ë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í˜¸ì¶œë§Œ í•¨
          handleSubmit(false); // í”Œëœ ìƒì„±í•˜ì§€ ì•ŠìŒ
          return; // handleSubmit ë‚´ë¶€ì—ì„œ ë‹¨ê³„ ì´ë™ ì²˜ë¦¬
        }
      } else {
        setCurrentStep((prev) => (prev + 1) as WizardStep);
      }
    }
  }, [currentStep, validateStep, mode, handleSubmit]);

  const handleBack = useCallback(() => {
    if (canGoBack(currentStep, mode)) {
      setCurrentStep((prev) => (prev - 1) as WizardStep);
    }
  }, [currentStep, mode]);

  // Step 7 ì™„ë£Œ í•¸ë“¤ëŸ¬
  const handleStep7Complete = useCallback(async () => {
    if (!draftGroupId) return;

    // ê´€ë¦¬ì continue ëª¨ë“œì—ì„œëŠ” í”Œëœ ìƒì„± ë° í˜ì´ì§€ ì´ë™ ì²˜ë¦¬
    if (isAdminContinueMode) {
      try {
        const { continueCampStepsForAdmin } = await import("@/app/(admin)/actions/campTemplateActions");
        
        // Step 7ì—ì„œ í”Œëœ ìƒì„± ë° ì €ì¥
        const result = await continueCampStepsForAdmin(
          draftGroupId || (initialData?.groupId as string),
          wizardData,
          currentStep
        );

        if (result.success) {
          toast.showSuccess("í”Œëœì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ì°¸ì—¬ì ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
          const templateId = initialData?.templateId;
          if (templateId) {
            window.location.href = `/admin/camp-templates/${templateId}/participants`;
          } else {
            window.location.href = `/admin/camp-templates`;
          }
        } else {
          const errorMessage = result.error || "í”Œëœ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          setValidationErrors([errorMessage]);
          toast.showError(errorMessage);
        }
      } catch (error) {
        console.error("[PlanGroupWizard] ê´€ë¦¬ì ìº í”„ í”Œëœ ìƒì„± ì‹¤íŒ¨:", error);
        const errorMessage = error instanceof Error ? error.message : "í”Œëœ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        setValidationErrors([errorMessage]);
        toast.showError(errorMessage);
      }
      return;
    }

    // ì¼ë°˜ ëª¨ë“œ(í•™ìƒ ëª¨ë“œ)ì—ì„œëŠ” í”Œëœì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ë§Œ ìˆ˜í–‰
    // í”Œëœ ìƒì„±ì€ Step 7 ì§„ì… ì‹œ ìë™ìœ¼ë¡œ ì™„ë£Œë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í™•ì¸ë§Œ
    try {
      const checkResult = await checkPlansExistAction(draftGroupId);
      if (!checkResult.hasPlans) {
        // í”Œëœì´ ì—†ìœ¼ë©´ ê²½ê³ ë§Œ í‘œì‹œ (Step 7ì—ì„œ ì´ë¯¸ ìƒì„±ë˜ì–´ì•¼ í•¨)
        alert("í”Œëœì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”Œëœ ì¬ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        return;
      }
    } catch (error) {
      // í”Œëœ í™•ì¸ ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ê³„ì† ì§„í–‰
      console.warn("[PlanGroupWizard] í”Œëœ í™•ì¸ ì‹¤íŒ¨:", error);
    }

    // ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ í™œì„±í™” ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œë¥¼ ìœ„í•´ ë‹¤ë¥¸ í™œì„± í”Œëœ ê·¸ë£¹ í™•ì¸
    // (ìë™ í™œì„±í™”ëŠ” í•˜ì§€ ì•ŠìŒ - ì‚¬ìš©ìê°€ ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ í™œì„±í™”)
    try {
      const activeGroups = await getActivePlanGroups(draftGroupId);
      if (activeGroups.length > 0) {
        // ë‹¤ë¥¸ í™œì„± í”Œëœ ê·¸ë£¹ì´ ìˆìœ¼ë©´ ì´ë¦„ ì €ì¥ (ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ)
        setActiveGroupNames(activeGroups.map(g => g.name || "í”Œëœ ê·¸ë£¹"));
      }
      // ë‹¤ë¥¸ í™œì„± í”Œëœ ê·¸ë£¹ì´ ì—†ì–´ë„ ìë™ í™œì„±í™”í•˜ì§€ ì•ŠìŒ
      // ì‚¬ìš©ìê°€ ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ í™œì„±í™”ë¨
    } catch (error) {
      // í™œì„± ê·¸ë£¹ í™•ì¸ ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ (í•„ìˆ˜ê°€ ì•„ë‹ˆë¯€ë¡œ)
      const planGroupError = toPlanGroupError(
        error,
        PlanGroupErrorCodes.UNKNOWN_ERROR
      );
      console.warn("[PlanGroupWizard] í”Œëœ ê·¸ë£¹ í™œì„± ê·¸ë£¹ í™•ì¸ ì‹¤íŒ¨:", planGroupError);
    }

    // ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ í™œì„±í™” ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
    // ë‹¤ë¥¸ í™œì„± í”Œëœ ê·¸ë£¹ì´ ìˆìœ¼ë©´ í™œì„±í™” ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
    if (activeGroupNames.length > 0) {
      setActivationDialogOpen(true);
    } else {
      // ë‹¤ë¥¸ í™œì„± í”Œëœ ê·¸ë£¹ì´ ì—†ìœ¼ë©´ í™œì„±í™” í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
      try {
        // saved ìƒíƒœë¡œ ë¨¼ì € ë³€ê²½ ì‹œë„ (ì´ë¯¸ saved ìƒíƒœë©´ ì—ëŸ¬ ì—†ì´ ì„±ê³µ)
        try {
          await updatePlanGroupStatus(draftGroupId, "saved");
        } catch (savedError) {
          // saved ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ì´ë¯¸ saved ìƒíƒœì¼ ìˆ˜ ìˆìŒ)
          console.warn("í”Œëœ ê·¸ë£¹ saved ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ (ë¬´ì‹œ):", savedError);
        }
        // saved ìƒíƒœì—ì„œ activeë¡œ ì „ì´
        await updatePlanGroupStatus(draftGroupId, "active");
        router.refresh(); // ìºì‹œ ê°±ì‹ 
        router.push(`/plan/group/${draftGroupId}`, { scroll: true });
      } catch (statusError) {
        // í™œì„±í™” ì‹¤íŒ¨ ì‹œì—ë„ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ê²½ê³ ë§Œ)
        console.warn("í”Œëœ ê·¸ë£¹ í™œì„±í™” ì‹¤íŒ¨:", statusError);
        router.refresh(); // ìºì‹œ ê°±ì‹ 
        router.push(`/plan/group/${draftGroupId}`, { scroll: true });
      }
    }
  }, [draftGroupId, isAdminContinueMode, wizardData, currentStep, initialData, toast, setValidationErrors, router]);

  // ì§„í–‰ë¥  ê³„ì‚°
  const progress = useMemo(() => calculateProgress(currentStep, wizardData, isTemplateMode), [currentStep, wizardData, isTemplateMode]);

  // ë§ˆì§€ë§‰ ë‹¨ê³„ íŒë‹¨ (ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©)
  const isLastStep = useMemo(() => {
    return checkIsLastStep(currentStep, mode);
  }, [currentStep, mode]);

  // handleSaveDraftë¥¼ refë¡œ ì €ì¥í•˜ì—¬ ìµœì‹  í•¨ìˆ˜ë¥¼ ì°¸ì¡°
  const handleSaveDraftRef = useRef(handleSaveDraft);
  useEffect(() => {
    handleSaveDraftRef.current = handleSaveDraft;
  }, [handleSaveDraft]);

  // ì €ì¥ í•¨ìˆ˜ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œ (í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œë§Œ)
  useEffect(() => {
    if (isTemplateMode && onSaveRequest) {
      onSaveRequest(() => handleSaveDraftRef.current(false));
    }
  }, [isTemplateMode, onSaveRequest]);

  return (
    <div className="mx-auto w-full max-w-4xl">
      {/* ìƒë‹¨ ì•¡ì…˜ ë°” - í…œí”Œë¦¿ ëª¨ë“œì¼ ë•ŒëŠ” ìˆ¨ê¹€ (CampTemplateEditFormì—ì„œ ì²˜ë¦¬) */}
      {!isTemplateMode && (
        <div className="mb-6 flex items-center justify-between rounded-xl border border-gray-200 bg-white px-4 py-3 shadow-sm">
          <div className="flex items-center gap-2">
            {/* ìº í”„ ëª¨ë“œì¼ ë•ŒëŠ” ë²„íŠ¼ ìˆ¨ê¹€ (ìƒìœ„ í˜ì´ì§€ì˜ 'ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°' ë²„íŠ¼ ì‚¬ìš©) */}
            {!mode.isCampMode && (
              <Link
                href={
                  isEditMode
                    ? `/plan/group/${draftGroupId}`
                    : "/plan"
                }
                className="inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-800 transition hover:bg-gray-100"
              >
                <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
                {isEditMode
                  ? "ìƒì„¸ ë³´ê¸°"
                  : "í”Œëœ ëª©ë¡"}
              </Link>
            )}
          </div>
          <div className="flex items-center gap-4">
            <button
              type="button"
              onClick={() => {
                if (confirm("ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì§€ ì•Šê³  ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                  // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” ìº í”„ í…œí”Œë¦¿ ì°¸ì—¬ì ëª©ë¡ìœ¼ë¡œ ì´ë™
                  if (mode.isAdminMode || mode.isAdminContinueMode) {
                    const templateId = initialData?.templateId;
                    if (templateId) {
                      router.push(`/admin/camp-templates/${templateId}/participants`, { scroll: true });
                      return;
                    }
                  }
                  // ì¼ë°˜ ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
                  router.push(isEditMode && draftGroupId ? `/plan/group/${draftGroupId}` : "/plan", { scroll: true });
                }
              }}
              disabled={isSubmitting}
              className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
            >
              ì·¨ì†Œ
            </button>
            <button
              type="button"
              onClick={() => handleSaveDraft(false)}
              disabled={
                isSubmitting || 
                !wizardData.name || 
                (!mode.isCampMode && (!wizardData.period_start || !wizardData.period_end))
              }
              className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
            >
              {isSubmitting ? "ì €ì¥ ì¤‘..." : "ì €ì¥"}
            </button>
          </div>
        </div>
      )}


      {/* ê²½ê³  ë©”ì‹œì§€ */}
      {validationWarnings.length > 0 && (
        <div className="mb-6 rounded-xl bg-yellow-50 p-4">
          <div className="flex flex-col gap-2">
            <h3 className="text-sm font-semibold text-yellow-800">ê²½ê³ </h3>
            <ul className="list-disc space-y-1 pl-5 text-sm text-yellow-700">
              {validationWarnings.map((warning, index) => (
                <li key={index}>{warning}</li>
              ))}
            </ul>
          </div>
        </div>
      )}

      {/* ë‹¨ê³„ë³„ í¼ */}
      <div className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        {currentStep === 1 && (
          <Step1BasicInfo
            data={wizardData}
            onUpdate={updateWizardData}
            blockSets={blockSets}
            onBlockSetsLoaded={(latestBlockSets: any) => {
              setBlockSets(latestBlockSets);
            }}
            isTemplateMode={isTemplateMode}
            editable={!isAdminContinueMode}
            campTemplateInfo={
              isCampMode
                ? {
                    name: wizardData.name || "",
                    program_type: "ìº í”„",
                  }
                : undefined
            }
            fieldErrors={fieldErrors}
          />
        )}
        {currentStep === 2 && (
          <Step2TimeSettings
            data={wizardData}
            onUpdate={updateWizardData}
            periodStart={wizardData.period_start}
            periodEnd={wizardData.period_end}
            groupId={draftGroupId || undefined}
            onNavigateToStep={(step) => setCurrentStep(step as WizardStep)}
            campMode={isCampMode}
            isTemplateMode={isTemplateMode}
            templateExclusions={isCampMode ? wizardData.exclusions : undefined}
            editable={!isAdminContinueMode}
            studentId={initialData?.student_id}
            isAdminMode={isAdminMode}
            isAdminContinueMode={isAdminContinueMode}
          />
        )}
        {currentStep === 3 && (
          <Step3SchedulePreview
            data={wizardData}
            onUpdate={updateWizardData}
            blockSets={blockSets}
            isTemplateMode={isTemplateMode}
            campMode={isCampMode}
            campTemplateId={isCampMode ? initialData?.templateId : undefined}
            onNavigateToStep={(step) => setCurrentStep(step as WizardStep)}
          />
        )}
        {currentStep === 4 && (
          <Step3ContentSelection
            data={wizardData}
            onUpdate={(updates: any) => {
              // custom íƒ€ì… í•„í„°ë§
              const filteredUpdates: Partial<WizardData> = { ...updates };
              if (updates.student_contents) {
                filteredUpdates.student_contents = updates.student_contents.filter(
                  (c: any) => c.content_type === "book" || c.content_type === "lecture"
                ) as WizardData["student_contents"];
              }
              if (updates.recommended_contents) {
                filteredUpdates.recommended_contents = updates.recommended_contents.filter(
                  (c: any) => c.content_type === "book" || c.content_type === "lecture"
                ) as WizardData["recommended_contents"];
              }
              updateWizardData(filteredUpdates);
            }}
            contents={initialContents}
            isCampMode={isCampMode}
            isTemplateMode={isTemplateMode}
            isEditMode={isEditMode}
            studentId={initialData?.student_id}
            editable={isEditMode || isAdminContinueMode || !isCampMode}
            isAdminContinueMode={isAdminContinueMode}
            fieldErrors={fieldErrors}
          />
        )}
        {/* Step 5: í•™ìŠµë²”ìœ„ ì ê²€ (í•™ìŠµ ë¶„ëŸ‰ ì„¤ì •) */}
        {currentStep === 5 && !isTemplateMode && (
          <Step6FinalReview
            data={wizardData}
            onUpdate={updateWizardData}
            contents={initialContents}
            isCampMode={isCampMode}
            studentId={initialData?.student_id}
          />
        )}
        {/* Step 6: ìµœì¢… í™•ì¸ */}
        {currentStep === 6 && !isTemplateMode && (
          <Step6Simplified
            data={wizardData}
            onEditStep={(step) => setCurrentStep(step)}
            isCampMode={isCampMode}
            isAdminContinueMode={isAdminContinueMode}
            onUpdate={isAdminContinueMode ? updateWizardData : undefined}
            contents={isAdminContinueMode ? initialContents : undefined}
            studentId={initialData?.student_id}
          />
        )}
        {currentStep === 7 && draftGroupId && !isTemplateMode && (
          <Step7ScheduleResult
            groupId={draftGroupId}
            isAdminContinueMode={isAdminContinueMode}
            onComplete={handleStep7Complete}
          />
        )}
      </div>

      {/* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */}
      <div className="mt-6 flex justify-between">
        <div className="flex gap-2">
          <button
            type="button"
            onClick={handleBack}
            disabled={currentStep === 1 || isSubmitting}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 px-5 py-2.5 text-sm font-semibold text-gray-800 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          >
            ì´ì „
          </button>
        </div>
        {currentStep === 7 && draftGroupId && !isTemplateMode ? (
          <button
            type="button"
            onClick={handleStep7Complete}
            disabled={isSubmitting}
            className="inline-flex items-center justify-center rounded-lg bg-gray-900 px-5 py-2.5 text-sm font-semibold text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
          >
            ì™„ë£Œ
          </button>
        ) : (
          <button
            type="button"
            onClick={handleNext}
            disabled={isSubmitting}
            className="inline-flex items-center justify-center rounded-lg bg-gray-900 px-5 py-2.5 text-sm font-semibold text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
          >
            {isSubmitting
              ? "ì €ì¥ ì¤‘..."
              : isLastStep
              ? "ì™„ë£Œ"
              : "ë‹¤ìŒ"}
          </button>
        )}
      </div>

      {/* í”Œëœ ê·¸ë£¹ í™œì„±í™” ë‹¤ì´ì–¼ë¡œê·¸ */}
      {draftGroupId && (
        <PlanGroupActivationDialog
          open={activationDialogOpen}
          onOpenChange={setActivationDialogOpen}
          groupId={draftGroupId}
          activeGroupNames={activeGroupNames}
        />
      )}
    </div>
  );
}
</file>

<file path="new-group/_components/Step2TimeSettings.tsx">
"use client";

import React from "react";
import { WizardData } from "./PlanGroupWizard";
import { TimeSettingsPanel } from "./_panels/TimeSettingsPanel";

type Step2TimeSettingsProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  periodStart: string;
  periodEnd: string;
  groupId?: string;
  onNavigateToStep?: (step: number) => void;
  campMode?: boolean;
  isTemplateMode?: boolean;
  templateExclusions?: Array<{
    exclusion_date: string;
    exclusion_type: "íœ´ê°€" | "ê°œì¸ì‚¬ì •" | "íœ´ì¼ì§€ì •" | "ê¸°íƒ€";
    reason?: string;
  }>;
  editable?: boolean;
  studentId?: string;
  isAdminMode?: boolean;
  isAdminContinueMode?: boolean;
};

/**
 * Step 2: ë¸”ë¡ ë° ì œì™¸ì¼ ì„¤ì •
 * 
 * ì‹œê°„ ì„¤ì • ì „ìš© ë‹¨ê³„ (ë¯¸ë¦¬ë³´ê¸°ëŠ” Step 3ìœ¼ë¡œ ë¶„ë¦¬)
 */
export function Step2TimeSettings({
  data,
  onUpdate,
  periodStart,
  periodEnd,
  groupId,
  onNavigateToStep,
  campMode = false,
  isTemplateMode = false,
  templateExclusions,
  editable = true,
  studentId,
  isAdminMode = false,
  isAdminContinueMode = false,
}: Step2TimeSettingsProps) {
  return (
    <div className="flex flex-col gap-6">
      {/* ì„¤ì • íŒ¨ë„ */}
      <TimeSettingsPanel
        data={data}
        onUpdate={onUpdate}
        periodStart={periodStart}
        periodEnd={periodEnd}
        groupId={groupId}
        onNavigateToStep={onNavigateToStep}
        campMode={campMode}
        isTemplateMode={isTemplateMode}
        templateExclusions={templateExclusions}
        editable={editable}
        studentId={studentId}
        isAdminMode={isAdminMode}
        isAdminContinueMode={isAdminContinueMode}
      />
    </div>
  );
}
</file>

<file path="new-group/_components/Step3ContentSelection.tsx">
"use client";

import React, { useState, useEffect, useMemo, useCallback } from "react";
import {
  Step3ContentSelectionProps,
  RecommendationSettings,
  RecommendedContent,
} from "@/lib/types/content-selection";
import {
  StudentContentsPanel,
  RecommendedContentsPanel,
  MasterContentsPanel,
  ContentSelectionProgress,
  UnifiedContentsView,
} from "./_shared";
import { BookOpen, Sparkles, Package } from "lucide-react";
import { cn } from "@/lib/cn";
import { getRecommendedMasterContentsAction } from "@/app/(student)/actions/getRecommendedMasterContents";
import { fetchDetailSubjects } from "@/app/(student)/actions/fetchDetailSubjects";
import {
  getCurriculumRevisionsAction,
  getSubjectGroupsAction,
  getSubjectsByGroupAction,
} from "@/app/(student)/actions/contentMetadataActions";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import type { SubjectGroup } from "@/lib/data/subjects";
import RequiredSubjectItem from "./Step4RecommendedContents/components/RequiredSubjectItem";
import { FieldErrors } from "./hooks/useWizardValidation";
import { FieldError } from "./_shared/FieldError";
import { createWizardMode, isStudentMode } from "./utils/modeUtils";

/**
 * Step3ContentSelection - ì½˜í…ì¸  ì„ íƒ í†µí•© ì»´í¬ë„ŒíŠ¸
 *
 * Phase 3.5ì—ì„œ êµ¬í˜„
 * ê¸°ì¡´ Step3Contents + Step4RecommendedContentsë¥¼ í†µí•©
 * íƒ­ UIë¡œ í•™ìƒ ì½˜í…ì¸ ì™€ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ í•œ í™”ë©´ì—ì„œ ê´€ë¦¬
 */
export function Step3ContentSelection({
  data,
  onUpdate,
  contents,
  isEditMode = false,
  isCampMode = false,
  isTemplateMode = false,
  studentId,
  editable = true,
  isAdminContinueMode = false,
  fieldErrors,
}: Step3ContentSelectionProps & { 
  isTemplateMode?: boolean; 
  isAdminContinueMode?: boolean;
  fieldErrors?: FieldErrors;
}) {
  // ëª¨ë“œ í†µí•© ê´€ë¦¬
  const mode = useMemo(() => createWizardMode({
    isCampMode,
    isTemplateMode,
    isAdminMode: false,
    isAdminContinueMode,
    isEditMode,
  }), [isCampMode, isTemplateMode, isAdminContinueMode, isEditMode]);

  // íƒ­ ìƒíƒœ
  const [activeTab, setActiveTab] = useState<
    "student" | "recommended" | "master"
  >("student");

  // ì¶”ì²œ ì½˜í…ì¸  ìƒíƒœ
  const [recommendedContents, setRecommendedContents] = useState<
    RecommendedContent[]
  >([]);
  const [allRecommendedContents, setAllRecommendedContents] = useState<
    RecommendedContent[]
  >([]);
  const [selectedRecommendedIds, setSelectedRecommendedIds] = useState<
    Set<string>
  >(new Set());
  const [recommendationLoading, setRecommendationLoading] = useState(false);
  const [hasRequestedRecommendations, setHasRequestedRecommendations] =
    useState(false); // í•­ìƒ falseë¡œ ì´ˆê¸°í™” (ì¼ë°˜ ëª¨ë“œì—ì„œë„ ì¶”ì²œ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥)
  const [hasScoreData, setHasScoreData] = useState(false);

  // ì¶”ì²œ ì„¤ì •
  const [recommendationSettings, setRecommendationSettings] =
    useState<RecommendationSettings>({
      selectedSubjects: new Set(),
      recommendationCounts: new Map(),
      autoAssignContents: false,
    });

  // í•„ìˆ˜ êµê³¼ ì„¤ì • ê´€ë ¨ ìƒíƒœ
  const [availableSubjectGroups, setAvailableSubjectGroups] = useState<
    SubjectGroup[]
  >([]);
  const [curriculumRevisions, setCurriculumRevisions] = useState<
    CurriculumRevision[]
  >([]);
  const [loadingSubjectGroups, setLoadingSubjectGroups] = useState(false);
  const [loadingRevisions, setLoadingRevisions] = useState(false);

  // êµê³¼ ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ
  useEffect(() => {
    if (mode.isTemplateMode) {
      setLoadingSubjectGroups(true);
      getSubjectGroupsAction()
        .then((groups) => {
          setAvailableSubjectGroups(groups || []);
        })
        .catch((error) => {
          console.error("êµê³¼ ê·¸ë£¹ ì¡°íšŒ ì‹¤íŒ¨:", error);
        })
        .finally(() => {
          setLoadingSubjectGroups(false);
        });
    }
  }, [isTemplateMode]);

  // ê°œì •êµìœ¡ê³¼ì • ëª©ë¡ ì¡°íšŒ (í…œí”Œë¦¿ ëª¨ë“œì¼ ë•Œë§Œ)
  useEffect(() => {
    if (mode.isTemplateMode) {
      setLoadingRevisions(true);
      getCurriculumRevisionsAction()
        .then((revisions) => {
          setCurriculumRevisions(revisions || []);
        })
        .catch((error) => {
          console.error("ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ ì‹¤íŒ¨:", error);
        })
        .finally(() => {
          setLoadingRevisions(false);
        });
    }
  }, [isTemplateMode]);

  // ìµœëŒ€ ì½˜í…ì¸  ê°œìˆ˜
  const maxContents = 9;
  const currentTotal =
    data.student_contents.length + data.recommended_contents.length;

  // í•„ìˆ˜ ê³¼ëª© ì²´í¬ (ìº í”„ ëª¨ë“œì—ì„œë§Œ)
  const requiredSubjects = useMemo(() => {
    // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” í•„ìˆ˜ ê³¼ëª© ê²€ì¦ ì‚¬ìš© ì•ˆ í•¨
    if (!isCampMode) {
      return [];
    }

    // í•„ìˆ˜ êµê³¼ ì„¤ì •ì—ì„œ ì§€ì •í•œ ê³¼ëª© ê°€ì ¸ì˜¤ê¸°
    const requiredSubjectCategories =
      data.subject_constraints?.required_subjects
        ?.map((req) => req.subject_category)
        .filter(Boolean) || [];

    // í•„ìˆ˜ êµê³¼ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
    if (requiredSubjectCategories.length === 0) {
      return [];
    }

    const allContents = [
      ...data.student_contents,
      ...data.recommended_contents,
    ];
    const subjectSet = new Set(
      allContents.map((c) => c.subject_category).filter((s): s is string => !!s)
    );

    // í•„ìˆ˜ êµê³¼ ì„¤ì •ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ìƒì„±
    return requiredSubjectCategories.map((category) => ({
      subject: category,
      selected: subjectSet.has(category),
    }));
  }, [
    data.student_contents,
    data.recommended_contents,
    data.subject_constraints?.required_subjects,
    mode.isCampMode,
  ]);

  // í•„ìˆ˜ ê³¼ëª© ëª¨ë‘ ì„ íƒ ì—¬ë¶€ (ìº í”„ ëª¨ë“œì—ì„œë§Œ)
  const allRequiredSelected = useMemo(() => {
    if (!mode.isCampMode) return true; // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” í•­ìƒ true
    return requiredSubjects.every((s) => s.selected);
  }, [requiredSubjects, mode.isCampMode]);

  // ê²½ê³  ë©”ì‹œì§€
  const warningMessage = useMemo(() => {
    if (currentTotal === 0) {
      return "ìµœì†Œ 1ê°œ ì´ìƒì˜ ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
    }
    // ìº í”„ ëª¨ë“œì—ì„œë§Œ í•„ìˆ˜ ê³¼ëª© ê²€ì¦
    if (mode.isCampMode && !allRequiredSelected && currentTotal >= maxContents) {
      const missing = requiredSubjects
        .filter((s) => !s.selected)
        .map((s) => s.subject);
      return `í•„ìˆ˜ ê³¼ëª© (${missing.join(", ")})ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`;
    }
    return undefined;
  }, [
    currentTotal,
    allRequiredSelected,
    requiredSubjects,
    isCampMode,
    maxContents,
  ]);

  // í•™ìƒ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
  const handleStudentContentsUpdate = useCallback(
    (contents: typeof data.student_contents) => {
      onUpdate({ student_contents: contents });
    },
    [onUpdate]
  );

  // ì¶”ì²œ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
  const handleRecommendedContentsUpdate = useCallback(
    (contents: typeof data.recommended_contents) => {
      onUpdate({ recommended_contents: contents });

      // ì„ íƒëœ ID ì—…ë°ì´íŠ¸
      setSelectedRecommendedIds(new Set(contents.map((c) => c.content_id)));
    },
    [onUpdate]
  );

  // ì¶”ì²œ ë°›ê¸° ìš”ì²­
  const handleRequestRecommendations = useCallback(async () => {
    console.log("[Step3ContentSelection] ì¶”ì²œ ë°›ê¸° ìš”ì²­ ì‹œì‘:", {
      recommendationSettings: {
        selectedSubjects: Array.from(recommendationSettings.selectedSubjects),
        recommendationCounts: Object.fromEntries(
          recommendationSettings.recommendationCounts
        ),
        autoAssignContents: recommendationSettings.autoAssignContents,
      },
      studentId,
    });

    setRecommendationLoading(true);

    try {
      // ê³¼ëª©ê³¼ ê°œìˆ˜ ë°°ì—´ë¡œ ë³€í™˜
      const subjects = Array.from(recommendationSettings.selectedSubjects);
      // Record<string, number> í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const counts: Record<string, number> = {};
      subjects.forEach((subject) => {
        counts[subject] = recommendationSettings.recommendationCounts.get(subject) || 1;
      });

      // API í˜¸ì¶œ
      const result = await getRecommendedMasterContentsAction(
        studentId,
        subjects,
        counts
      );

      if (!result.success || !result.data) {
        alert("ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const rawRecommendations = result.data.recommendations || [];

      // API ì‘ë‹µì„ RecommendedContentë¡œ ë³€í™˜ (contentType ë³´ì¥)
      const recommendations: RecommendedContent[] = rawRecommendations.map(
        (r: any) => {
          // contentType ê²°ì •: camelCase ìš°ì„ , ì—†ìœ¼ë©´ snake_case, ì—†ìœ¼ë©´ ì¶”ì •
          let contentType = r.contentType || r.content_type;

          if (!contentType) {
            // publisherê°€ ìˆìœ¼ë©´ book, platformì´ ìˆìœ¼ë©´ lectureë¡œ ì¶”ì •
            if (r.publisher) {
              contentType = "book";
            } else if (r.platform) {
              contentType = "lecture";
            } else {
              // ê¸°ë³¸ê°’: book
              contentType = "book";
            }

            console.warn(
              "[Step3ContentSelection] contentTypeì´ ì—†ì–´ ì¶”ì •ê°’ ì‚¬ìš©:",
              {
                id: r.id,
                title: r.title,
                estimatedContentType: contentType,
                publisher: r.publisher,
                platform: r.platform,
                allKeys: Object.keys(r),
              }
            );
          }

          // íƒ€ì… ê²€ì¦
          if (contentType !== "book" && contentType !== "lecture") {
            console.error("[Step3ContentSelection] ì˜ëª»ëœ contentType:", {
              id: r.id,
              title: r.title,
              contentType,
              rawData: r,
            });
            // ì˜ëª»ëœ íƒ€ì…ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³€ê²½
            contentType = "book";
          }

          return {
            id: r.id,
            contentType: contentType as "book" | "lecture",
            title: r.title,
            subject_category: r.subject_category,
            subject: r.subject,
            semester: r.semester,
            revision: r.revision,
            publisher: r.publisher,
            platform: r.platform,
            difficulty_level: r.difficulty_level,
            reason: r.reason || "",
            priority: r.priority || 0,
            scoreDetails: r.scoreDetails,
          };
        }
      );

      // ì„±ì  ë°ì´í„° ìœ ë¬´ í™•ì¸
      const hasDetailedReasons = recommendations.some(
        (r: RecommendedContent) =>
          r.reason?.includes("ë‚´ì‹ ") ||
          r.reason?.includes("ëª¨ì˜ê³ ì‚¬") ||
          r.reason?.includes("ìœ„í—˜ë„") ||
          r.scoreDetails
      );
      setHasScoreData(hasDetailedReasons);

      // ì¤‘ë³µ ì œê±°
      const existingIds = new Set([
        ...data.student_contents.map((c) => c.content_id),
        ...data.recommended_contents.map((c) => c.content_id),
      ]);

      // í•™ìƒ ì½˜í…ì¸ ì˜ master_content_id ìˆ˜ì§‘
      const studentMasterIds = new Set<string>();
      data.student_contents.forEach((c) => {
        const masterContentId = (c as any).master_content_id;
        if (masterContentId) {
          studentMasterIds.add(masterContentId);
        }
      });

      // ì¶”ì²œ ì½˜í…ì¸  ë§¤í•‘
      const recommendationsMap = new Map<string, RecommendedContent>();
      recommendations.forEach((c: RecommendedContent) => {
        recommendationsMap.set(c.id, c);
      });

      // ì „ì²´ ëª©ë¡ ì—…ë°ì´íŠ¸
      setAllRecommendedContents((prev) => {
        const merged = new Map<string, RecommendedContent>();
        prev.forEach((c) => merged.set(c.id, c));
        recommendationsMap.forEach((c, id) => {
          merged.set(id, c);
        });
        return Array.from(merged.values());
      });

      // í•„í„°ë§
      const filteredRecommendations = recommendations.filter((r: any) => {
        // content_idë¡œ ì§ì ‘ ë¹„êµ
        if (existingIds.has(r.id)) {
          return false;
        }
        // master_content_idë¡œ ë¹„êµ
        if (studentMasterIds.has(r.id)) {
          return false;
        }
        return true;
      });

      setRecommendedContents(filteredRecommendations);
      setHasRequestedRecommendations(true);

      // ìë™ ë°°ì •
      console.log("[Step3ContentSelection] ìë™ ë°°ì • ì²´í¬:", {
        autoAssign: recommendationSettings.autoAssignContents,
        filteredRecommendationsCount: filteredRecommendations.length,
        willAutoAssign:
          recommendationSettings.autoAssignContents &&
          filteredRecommendations.length > 0,
      });

      // ìë™ ë°°ì • ì¡°ê±´ ëª…í™•í™”
      const shouldAutoAssign =
        recommendationSettings.autoAssignContents &&
        filteredRecommendations.length > 0;

      console.log("[Step3ContentSelection] ìë™ ë°°ì • ì¡°ê±´ í™•ì¸:", {
        autoAssignContents: recommendationSettings.autoAssignContents,
        filteredRecommendationsCount: filteredRecommendations.length,
        shouldAutoAssign,
      });

      if (shouldAutoAssign) {
        console.log("[Step3ContentSelection] ìë™ ë°°ì • ì‹œì‘:", {
          recommendationsCount: filteredRecommendations.length,
          recommendations: filteredRecommendations.map((r) => ({
            id: r.id,
            title: r.title,
            contentType: r.contentType,
          })),
        });

        // ìë™ ë°°ì • ë¡œì§ êµ¬í˜„
        const contentsToAutoAdd: Array<{
          content_type: "book" | "lecture";
          content_id: string;
          start_range: number;
          end_range: number;
          title?: string;
          subject_category?: string;
          is_auto_recommended?: boolean;
        }> = [];

        for (const r of filteredRecommendations) {
          try {
            let startRange = 1;
            let endRange = 100;

            // ìƒì„¸ ì •ë³´ ì¡°íšŒ
            let detailsResult: any = null;
            let hasDetails = false;

            const detailsResponse = await fetch(
              `/api/master-content-details?contentType=${r.contentType}&contentId=${r.id}`
            );

            if (detailsResponse.ok) {
              detailsResult = await detailsResponse.json();

              if (detailsResult.success && detailsResult.data) {
                if (r.contentType === "book") {
                  const details = detailsResult.data.details || [];
                  hasDetails = details.length > 0;
                  if (hasDetails) {
                    startRange = details[0].page_number || 1;
                    endRange = details[details.length - 1].page_number || 100;
                  }
                } else if (r.contentType === "lecture") {
                  const episodes = detailsResult.data.episodes || [];
                  hasDetails = episodes.length > 0;
                  if (hasDetails) {
                    startRange = episodes[0].episode_number || 1;
                    endRange =
                      episodes[episodes.length - 1].episode_number || 100;
                  }
                }
              }
            }

            // ìƒì„¸ ì •ë³´ê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ê°’ì¼ ë•Œ ì´ëŸ‰ ì¡°íšŒ
            if (!hasDetails || (startRange === 1 && endRange === 100)) {
              try {
                const infoResponse = await fetch(
                  `/api/master-content-info?content_type=${r.contentType}&content_id=${r.id}`
                );

                if (infoResponse.ok) {
                  const infoResult = await infoResponse.json();
                  if (infoResult.success && infoResult.data) {
                    if (
                      r.contentType === "book" &&
                      infoResult.data.total_pages
                    ) {
                      endRange = infoResult.data.total_pages;
                    } else if (
                      r.contentType === "lecture" &&
                      infoResult.data.total_episodes
                    ) {
                      endRange = infoResult.data.total_episodes;
                    }
                  }
                }
              } catch (infoError) {
                // ì´ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ê¸°ë³¸ê°’ 100 ì‚¬ìš©)
              }
            }

            contentsToAutoAdd.push({
              content_type: r.contentType,
              content_id: r.id,
              start_range: startRange,
              end_range: endRange,
              title: r.title,
              subject_category: r.subject_category || undefined,
              is_auto_recommended: true, // ìë™ ë°°ì • í”Œë˜ê·¸
            });
          } catch (error) {
            console.warn(
              `[Step3ContentSelection] ì½˜í…ì¸  ${r.id} ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:`,
              error
            );
            // ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
            contentsToAutoAdd.push({
              content_type: r.contentType,
              content_id: r.id,
              start_range: 1,
              end_range: 100,
              title: r.title,
              subject_category: r.subject_category || undefined,
              is_auto_recommended: true, // ìë™ ë°°ì • í”Œë˜ê·¸
            });
          }
        }

        // í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœì‹  ìƒíƒœ ë³´ì¥
        console.log(
          "[Step3ContentSelection] ìë™ ë°°ì • ì‹¤í–‰ - í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ í˜¸ì¶œ:",
          {
            contentsToAutoAdd: contentsToAutoAdd.map((c) => ({
              content_id: c.content_id,
              content_type: c.content_type,
              start_range: c.start_range,
              end_range: c.end_range,
              title: c.title,
            })),
          }
        );

        try {
          const currentTotal =
            data.student_contents.length + data.recommended_contents.length;
          const toAdd = contentsToAutoAdd.length;

          console.log(
            "[Step3ContentSelection] ìë™ ë°°ì • ì‹¤í–‰:",
            {
              currentTotal,
              toAdd,
              currentRecommendedContents: data.recommended_contents.length,
              currentStudentContents: data.student_contents.length,
            }
          );

          if (currentTotal + toAdd > 9) {
            const maxToAdd = 9 - currentTotal;
            const trimmed = contentsToAutoAdd.slice(0, maxToAdd);

            if (trimmed.length > 0) {
              const newRecommendedContents = [
                ...data.recommended_contents,
                ...trimmed,
              ];
              console.log("[Step3ContentSelection] ìë™ ë°°ì • (ì œí•œ ì ìš©):", {
                trimmed: trimmed.length,
                excluded: toAdd - trimmed.length,
              });
              setTimeout(() => {
                alert(
                  `ì¶”ì²œ ì½˜í…ì¸  ${
                    trimmed.length
                  }ê°œê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 9ê°œ ì œí•œìœ¼ë¡œ ${
                    toAdd - trimmed.length
                  }ê°œ ì œì™¸ë¨)`
                );
              }, 0);
              onUpdate({
                recommended_contents: newRecommendedContents,
              });
            } else {
              setTimeout(() => {
                alert("ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ 9ê°œ ì œí•œ)");
              }, 0);
            }
          } else {
            const newRecommendedContents = [
              ...data.recommended_contents,
              ...contentsToAutoAdd,
            ];
            console.log("[Step3ContentSelection] ìë™ ë°°ì • ì„±ê³µ:", {
              added: contentsToAutoAdd.length,
              newRecommendedContents: newRecommendedContents.length,
            });
            setTimeout(() => {
              alert(
                `ì¶”ì²œ ì½˜í…ì¸  ${contentsToAutoAdd.length}ê°œê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`
              );
            }, 0);
            onUpdate({
              recommended_contents: newRecommendedContents,
            });
          }

          console.log("[Step3ContentSelection] onUpdate í˜¸ì¶œ ì™„ë£Œ");

          // ìë™ ë°°ì •ëœ ì½˜í…ì¸ ë¥¼ ì¶”ì²œ ëª©ë¡ì—ì„œ ì œê±°
          const autoAssignedIds = new Set(
            filteredRecommendations.map((r) => r.id)
          );
          setRecommendedContents((prev) => {
            const filtered = prev.filter((r) => !autoAssignedIds.has(r.id));
            console.log("[Step3ContentSelection] ìë™ ë°°ì • í›„ ëª©ë¡ ì—…ë°ì´íŠ¸:", {
              before: prev.length,
              after: filtered.length,
              autoAssigned: autoAssignedIds.size,
            });
            return filtered;
          });
        } catch (error) {
          console.error(
            "[Step3ContentSelection] ìë™ ë°°ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",
            error
          );
          alert("ìë™ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      } else {
        console.log("[Step3ContentSelection] ìë™ ë°°ì • ìŠ¤í‚µ:", {
          autoAssign: recommendationSettings.autoAssignContents,
          filteredRecommendationsCount: filteredRecommendations.length,
          reason: !recommendationSettings.autoAssignContents
            ? "ìë™ ë°°ì • ì˜µì…˜ì´ ë¹„í™œì„±í™”ë¨"
            : "ì¶”ì²œ ì½˜í…ì¸ ê°€ ì—†ìŒ",
        });
      }

      // ì¶”ì²œ íƒ­ìœ¼ë¡œ ì „í™˜
      setActiveTab("recommended");
    } catch (error) {
      console.error("[Step3ContentSelection] ì¶”ì²œ ë°›ê¸° ì‹¤íŒ¨:", error);
      alert("ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setRecommendationLoading(false);
    }
  }, [
    recommendationSettings,
    studentId,
    data.student_contents,
    data.recommended_contents,
  ]);

  // í•„ìˆ˜ êµê³¼ ì„¤ì • í•¸ë“¤ëŸ¬
  // ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ë¶ˆëŸ¬ì˜¤ê¸°
  const handleLoadSubjects = useCallback(
    async (
      subjectGroupId: string,
      curriculumRevisionId: string
    ): Promise<Array<{ id: string; name: string }>> => {
      try {
        // í•´ë‹¹ ê°œì •êµìœ¡ê³¼ì •ì˜ êµê³¼ ê·¸ë£¹ ì°¾ê¸°
        const selectedGroup = availableSubjectGroups.find(
          (g) => g.id === subjectGroupId
        );
        if (!selectedGroup) {
          return [];
        }

        // ê°™ì€ ì´ë¦„ì˜ êµê³¼ ê·¸ë£¹ ì¤‘ í•´ë‹¹ ê°œì •êµìœ¡ê³¼ì •ì˜ ê²ƒ ì°¾ê¸°
        const curriculumGroup = availableSubjectGroups.find(
          (g) =>
            g.name === selectedGroup.name &&
            g.curriculum_revision_id === curriculumRevisionId
        );

        if (!curriculumGroup) {
          return [];
        }

        // í•´ë‹¹ êµê³¼ ê·¸ë£¹ì˜ ê³¼ëª© ì¡°íšŒ
        const subjects = await getSubjectsByGroupAction(curriculumGroup.id);
        return subjects.map((s) => ({ id: s.id, name: s.name }));
      } catch (error) {
        console.error("ì„¸ë¶€ ê³¼ëª© ì¡°íšŒ ì‹¤íŒ¨:", error);
        return [];
      }
    },
    [availableSubjectGroups]
  );

  // í•„ìˆ˜ êµê³¼ ì¶”ê°€
  const handleAddRequiredSubject = useCallback(() => {
    if (!editable) return;
    const currentConstraints = data.subject_constraints || {
      enable_required_subjects_validation: true,
      required_subjects: [],
      excluded_subjects: [],
      constraint_handling: "warning",
    };

    const newRequirement = {
      subject_group_id: "",
      subject_category: "",
      min_count: 1,
    };

    onUpdate({
      subject_constraints: {
        ...currentConstraints,
        enable_required_subjects_validation: true,
        required_subjects: [
          ...(currentConstraints.required_subjects || []),
          newRequirement,
        ],
      },
    });
  }, [data.subject_constraints, onUpdate]);

  // í•„ìˆ˜ êµê³¼ ì—…ë°ì´íŠ¸
  const handleRequiredSubjectUpdate = useCallback(
    (
      index: number,
      updated: Partial<{
        subject_group_id: string;
        subject_category: string;
        min_count: number;
        subjects_by_curriculum?: Array<{
          curriculum_revision_id: string;
          subject_id?: string;
          subject_name?: string;
        }>;
      }>
    ) => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      const newRequirements = [...currentConstraints.required_subjects!];
      newRequirements[index] = { ...newRequirements[index], ...updated };

      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          required_subjects: newRequirements,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  // í•„ìˆ˜ êµê³¼ ì‚­ì œ
  const handleRequiredSubjectRemove = useCallback(
    (index: number) => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      const newRequirements = currentConstraints.required_subjects!.filter(
        (_, i) => i !== index
      );

      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          required_subjects: newRequirements,
          enable_required_subjects_validation: newRequirements.length > 0,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  // ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ì‹ ë³€ê²½
  const handleConstraintHandlingChange = useCallback(
    (handling: "strict" | "warning" | "auto_fix") => {
      if (!editable) return;
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          constraint_handling: handling,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  // í¸ì§‘ ëª¨ë“œì—ì„œ ê¸°ì¡´ ì¶”ì²œ ì½˜í…ì¸  ì •ë³´ ë¡œë“œ
  useEffect(() => {
    if (isEditMode && data.recommended_contents.length > 0) {
      // í¸ì§‘ ëª¨ë“œì—ì„œ ê¸°ì¡´ ì¶”ì²œ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ allRecommendedContentsì— ì¶”ê°€
      // ì‹¤ì œ ì¶”ì²œ ì½˜í…ì¸  ì •ë³´ëŠ” ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ ì¡°íšŒ
      const existingIds = new Set(
        data.recommended_contents.map((c) => c.content_id)
      );
      setSelectedRecommendedIds(existingIds);
    }
  }, [isEditMode, data.recommended_contents]);

  return (
    <div className="flex flex-col gap-6" data-field-id="content_selection">
      {/* í•„ìˆ˜ êµê³¼ ì„¤ì • ì„¹ì…˜ - í…œí”Œë¦¿ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ */}
      {mode.isTemplateMode && (
        <div className="flex flex-col gap-4 rounded-xl border-2 border-blue-300 bg-blue-50 p-6 shadow-md">
          <div className="flex flex-col gap-2">
            <div className="flex items-center gap-2">
              <h2 className="text-lg font-semibold text-gray-900">
                í•„ìˆ˜ êµê³¼ ì„¤ì •
              </h2>
              <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                í•„ìˆ˜
              </span>
            </div>
            <p className="text-sm text-gray-600">
              í”Œëœ ìƒì„± ì‹œ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” êµê³¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ì˜ˆ: êµ­ì–´,
              ìˆ˜í•™, ì˜ì–´)
            </p>
          </div>

          <div className="flex flex-col gap-4">
            <p className="text-sm text-gray-600">
              í”Œëœ ìƒì„± ì‹œ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” êµê³¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
              ê°œì •êµìœ¡ê³¼ì •ë³„ë¡œ ì„¸ë¶€ ê³¼ëª©ì„ ì§€ì •í•˜ì—¬ ë” ì •í™•í•œ ì œì•½ ì¡°ê±´ì„ ì„¤ì •í• 
              ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>

            {/* í•„ìˆ˜ êµê³¼ ëª©ë¡ */}
            {(data.subject_constraints?.required_subjects || []).length > 0 && (
              <div className="flex flex-col gap-3">
                {(data.subject_constraints?.required_subjects || []).map(
                  (req, index) => (
                    <RequiredSubjectItem
                      key={index}
                      requirement={req}
                      index={index}
                      availableSubjectGroups={availableSubjectGroups}
                      curriculumRevisions={curriculumRevisions}
                      onLoadSubjects={handleLoadSubjects}
                      onUpdate={(updated) =>
                        handleRequiredSubjectUpdate(index, updated)
                      }
                      onRemove={() => handleRequiredSubjectRemove(index)}
                    />
                  )
                )}
              </div>
            )}

            {/* êµê³¼ ì¶”ê°€ ë²„íŠ¼ */}
            <button
              type="button"
              onClick={handleAddRequiredSubject}
              disabled={!editable}
              className={`w-full rounded-lg border-2 border-dashed p-3 text-sm transition-colors ${
                !editable
                  ? "cursor-not-allowed border-gray-200 bg-gray-50 text-gray-400"
                  : "border-gray-300 text-gray-600 hover:border-gray-400 hover:text-gray-600"
              }`}
            >
              + í•„ìˆ˜ êµê³¼ ì¶”ê°€
            </button>

            {/* ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ì‹ */}
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-600">
                ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ì‹
              </label>
              <select
                value={
                  data.subject_constraints?.constraint_handling || "warning"
                }
                onChange={(e) =>
                  handleConstraintHandlingChange(
                    e.target.value as "strict" | "warning" | "auto_fix"
                  )
                }
                disabled={!editable}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
              >
                <option value="warning">
                  ê²½ê³  (ê¶Œì¥) - ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì§„í–‰
                </option>
                <option value="strict">
                  ì—„ê²© (í•„ìˆ˜) - ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ì§„í–‰ ë¶ˆê°€
                </option>
                <option value="auto_fix">
                  ìë™ ë³´ì • - ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ë³´ì •
                </option>
              </select>
              <p className="text-xs text-gray-600">
                {data.subject_constraints?.constraint_handling === "warning" &&
                  "ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ê²½ê³ ë¥¼ í‘œì‹œí•˜ì§€ë§Œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
                {data.subject_constraints?.constraint_handling === "strict" &&
                  "ì¡°ê±´ì„ ë°˜ë“œì‹œ ì¶©ì¡±í•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
                {data.subject_constraints?.constraint_handling === "auto_fix" &&
                  "ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ í•„ìš”í•œ ì½˜í…ì¸ ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤."}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* ì§„í–‰ë¥  í‘œì‹œ */}
      <ContentSelectionProgress
        current={currentTotal}
        max={maxContents}
        requiredSubjects={requiredSubjects}
        showWarning={!!warningMessage}
        warningMessage={warningMessage}
      />

      {/* íƒ­ UI - ì½ê¸° ì „ìš© ëª¨ë“œì—ì„œëŠ” ìˆ¨ê¹€ */}
      {editable && (
        <div className="flex gap-2 border-b border-gray-200">
          <button
            type="button"
            onClick={() => {
              if (!editable) return;
              setActiveTab("student");
            }}
            disabled={!editable}
            className={cn(
              "flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors",
              activeTab === "student"
                ? "border-blue-600 text-blue-800"
                : "border-transparent text-gray-600 hover:text-gray-900",
              !editable && "cursor-not-allowed opacity-60"
            )}
          >
            <BookOpen className="h-4 w-4" />
            <span>í•™ìƒ ì½˜í…ì¸ </span>
            <span
              className={cn(
                "rounded-full px-2 py-0.5 text-xs",
                activeTab === "student"
                  ? "bg-blue-100 text-blue-800"
                  : "bg-gray-100 text-gray-600"
              )}
            >
              {data.student_contents.length}
            </span>
          </button>

          <button
            type="button"
            onClick={() => {
              if (!editable) return;
              setActiveTab("recommended");
            }}
            disabled={!editable}
            className={cn(
              "flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors",
              activeTab === "recommended"
                ? "border-blue-600 text-blue-800"
                : "border-transparent text-gray-600 hover:text-gray-900",
              !editable && "cursor-not-allowed opacity-60"
            )}
          >
            <Sparkles className="h-4 w-4" />
            <span>ì¶”ì²œ ì½˜í…ì¸ </span>
            <span
              className={cn(
                "rounded-full px-2 py-0.5 text-xs",
                activeTab === "recommended"
                  ? "bg-blue-100 text-blue-800"
                  : "bg-gray-100 text-gray-600"
              )}
            >
              {data.recommended_contents.length}
            </span>
          </button>

          <button
            type="button"
            onClick={() => {
              if (!editable) return;
              setActiveTab("master");
            }}
            disabled={!editable}
            className={cn(
              "flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors",
              activeTab === "master"
                ? "border-blue-600 text-blue-800"
                : "border-transparent text-gray-600 hover:text-gray-900",
              !editable && "cursor-not-allowed opacity-60"
            )}
          >
            <Package className="h-4 w-4" />
            <span>ë§ˆìŠ¤í„° ì½˜í…ì¸ </span>
          </button>
        </div>
      )}

      {/* ì˜¤ë¥˜ ë©”ì‹œì§€ */}
      {fieldErrors?.get("content_selection") && (
        <div className="rounded-lg border border-red-300 bg-red-50 p-3">
          <FieldError
            error={fieldErrors.get("content_selection")}
            id="content_selection-error"
          />
        </div>
      )}

      {/* íƒ­ ë‚´ìš© ë˜ëŠ” í†µí•© ë·° */}
      <div>
        {editable ? (
          // í¸ì§‘ ëª¨ë“œ: íƒ­ë³„ í‘œì‹œ
          activeTab === "student" ? (
            <StudentContentsPanel
              contents={contents}
              selectedContents={data.student_contents}
              maxContents={maxContents}
              currentTotal={currentTotal}
              onUpdate={handleStudentContentsUpdate}
              editable={editable}
              isCampMode={isCampMode}
            />
          ) : activeTab === "recommended" ? (
            <RecommendedContentsPanel
              recommendedContents={recommendedContents}
              allRecommendedContents={allRecommendedContents}
              selectedContents={data.recommended_contents}
              selectedRecommendedIds={selectedRecommendedIds}
              maxContents={maxContents}
              currentTotal={currentTotal}
              settings={recommendationSettings}
              onSettingsChange={setRecommendationSettings}
              onUpdate={handleRecommendedContentsUpdate}
              onRequestRecommendations={handleRequestRecommendations}
              isEditMode={isEditMode}
              isCampMode={isCampMode}
              loading={recommendationLoading}
              hasRequestedRecommendations={hasRequestedRecommendations}
              hasScoreData={hasScoreData}
              studentId={studentId}
              isAdminContinueMode={isAdminContinueMode}
              editable={editable}
            />
          ) : (
            <MasterContentsPanel
              selectedContents={data.student_contents}
              maxContents={maxContents}
              currentTotal={currentTotal}
              onUpdate={handleStudentContentsUpdate}
              editable={editable}
              isCampMode={isCampMode}
            />
          )
        ) : (
          // ì½ê¸° ì „ìš© ëª¨ë“œ: í†µí•© ë·°
          <UnifiedContentsView
            studentContents={data.student_contents}
            recommendedContents={data.recommended_contents}
            contents={contents}
            allRecommendedContents={allRecommendedContents}
            isCampMode={isCampMode}
          />
        )}
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step3SchedulePreview.tsx">
"use client";

import React from "react";
import { WizardData } from "./PlanGroupWizard";
import { SchedulePreviewPanel } from "./_panels/SchedulePreviewPanel";
import { ArrowLeft } from "lucide-react";

type Step3SchedulePreviewProps = {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  blockSets?: Array<{
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  }>;
  isTemplateMode?: boolean;
  campMode?: boolean;
  campTemplateId?: string;
  onNavigateToStep?: (step: number) => void;
};

/**
 * Step 3: ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°
 *
 * ì„¤ì •ëœ ë¸”ë¡ê³¼ ì œì™¸ì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ì„ ë¯¸ë¦¬ë³´ê¸°
 * - ì¼ê°„/ì£¼ê°„/ì›”ê°„ ë·° ì „í™˜
 * - í¸ì§‘ ë²„íŠ¼ìœ¼ë¡œ Step 2ë¡œ ì´ë™
 */
export function Step3SchedulePreview({
  data,
  onUpdate,
  blockSets,
  isTemplateMode = false,
  campMode = false,
  campTemplateId,
  onNavigateToStep,
}: Step3SchedulePreviewProps) {
  return (
    <div className="flex flex-col gap-6">
      {/* í—¤ë” */}
      <div className="flex items-center justify-between">
        <div className="flex flex-col gap-2">
          <h2 className="text-2xl font-bold text-gray-900">ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°</h2>
          <p className="text-gray-600">
            ì„¤ì •ëœ ë¸”ë¡ê³¼ ì œì™¸ì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ìŠ¤ì¼€ì¤„ì„ í™•ì¸í•˜ì„¸ìš”.
          </p>
        </div>
        {onNavigateToStep && (
          <button
            type="button"
            onClick={() => onNavigateToStep(2)}
            className="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            <ArrowLeft className="h-4 w-4" />
            ì„¤ì • ìˆ˜ì •
          </button>
        )}
      </div>

      {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
      <div className="rounded-xl border border-blue-200 bg-blue-50 p-4">
        <p className="text-sm text-blue-800">
          <strong>ì•ˆë‚´:</strong> ì´ ë‹¨ê³„ì—ì„œëŠ” ìŠ¤ì¼€ì¤„ì´ ì–´ë–»ê²Œ ë°°ì •ë˜ëŠ”ì§€ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜
          ìˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ ë³€ê²½í•˜ë ¤ë©´ "ì„¤ì • ìˆ˜ì •" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
        </p>
      </div>

      {/* ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ */}
      <div className="w-full">
        <SchedulePreviewPanel
          data={data}
          onUpdate={onUpdate}
          blockSets={blockSets}
          isTemplateMode={isTemplateMode}
          isCampMode={campMode}
          campTemplateId={campTemplateId}
        />
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step4RecommendedContents.tsx">
/**
 * Step4RecommendedContents (Refactored)
 * ì„œë¹„ìŠ¤ ì¶”ì²œ ì½˜í…ì¸  ì„ íƒ ë‹¨ê³„ - ë¦¬íŒ©í† ë§ ë²„ì „
 */

"use client";

import { useState, useCallback, useEffect } from "react";
import { WizardData } from "./PlanGroupWizard";
import { ContentSelectionProgress } from "./_shared/ContentSelectionProgress";
import { fetchDetailSubjects } from "@/app/(student)/actions/fetchDetailSubjects";
import {
  getCurriculumRevisionsAction,
  getSubjectGroupsAction,
  getSubjectsByGroupAction,
} from "@/app/(student)/actions/contentMetadataActions";
import type { SubjectGroup } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

// Hooks
import { useRecommendations } from "./Step4RecommendedContents/hooks/useRecommendations";
import { useContentSelection } from "./Step4RecommendedContents/hooks/useContentSelection";
import { useRangeEditor } from "./Step4RecommendedContents/hooks/useRangeEditor";
import { useRequiredSubjects } from "./Step4RecommendedContents/hooks/useRequiredSubjects";

// Components
import RecommendationRequestForm from "./Step4RecommendedContents/components/RecommendationRequestForm";
import RecommendedContentsList from "./Step4RecommendedContents/components/RecommendedContentsList";
import AddedContentsList from "./Step4RecommendedContents/components/AddedContentsList";
import RequiredSubjectsSection from "./Step4RecommendedContents/components/RequiredSubjectsSection";

// Types & Constants
import { Step4RecommendedContentsProps } from "./Step4RecommendedContents/types";
import {
  AVAILABLE_SUBJECTS,
  ERROR_MESSAGES,
  CONFIRM_MESSAGES,
} from "./Step4RecommendedContents/constants";

export default function Step4RecommendedContents({
  data,
  onUpdate,
  isEditMode = false,
  isCampMode = false,
  studentId,
  isAdminContinueMode = false,
}: Step4RecommendedContentsProps) {
  // ============================================================================
  // ì¶”ì²œ ì½˜í…ì¸  ê´€ë¦¬
  // ============================================================================
  const {
    recommendedContents,
    allRecommendedContents,
    loading,
    hasRequestedRecommendations,
    hasScoreData,
    fetchRecommendations,
    fetchRecommendationsWithSubjects,
    setRecommendedContents,
    setAllRecommendedContents,
  } = useRecommendations({
    isEditMode,
    studentId,
    data,
    onUpdate,
  });

  // ============================================================================
  // ì½˜í…ì¸  ì„ íƒ ê´€ë¦¬
  // ============================================================================
  const {
    selectedContentIds,
    toggleContentSelection,
    addSelectedContents,
    removeContent,
    setSelectedContentIds,
  } = useContentSelection({
    data,
    recommendedContents,
    allRecommendedContents,
    onUpdate,
  });

  // ============================================================================
  // ë²”ìœ„ í¸ì§‘ ê´€ë¦¬
  // ============================================================================
  const {
    editingRangeIndex,
    editingRange,
    contentDetails,
    loadingDetails,
    startDetailId,
    endDetailId,
    contentTotals,
    startEditingRange,
    cancelEditingRange,
    saveEditingRange,
    setStartRange,
    setEndRange,
    setEditingRange,
  } = useRangeEditor({
    data,
    onUpdate,
    studentId,
  });

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ ê²€ì¦
  // ============================================================================
  const {
    requiredSubjects,
    requiredSubjectCategories,
    missingRequiredSubjects,
    progressRequiredSubjects,
    selectedSubjectCategories,
    contentCountBySubject,
  } = useRequiredSubjects({
    data,
    allRecommendedContents,
    selectedContentIds,
    recommendedContents,
  });

  // ============================================================================
  // ì¶”ì²œ ìš”ì²­ ìƒíƒœ (êµê³¼ ì„ íƒ, ê°œìˆ˜)
  // ============================================================================
  const [selectedSubjects, setSelectedSubjects] = useState<Set<string>>(
    new Set()
  );
  const [recommendationCounts, setRecommendationCounts] = useState<
    Map<string, number>
  >(new Map());
  const [autoAssignContents, setAutoAssignContents] = useState(false);

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ ì„¤ì • ê´€ë¦¬
  // ============================================================================
  const [availableSubjectGroups, setAvailableSubjectGroups] = useState<
    SubjectGroup[]
  >([]);
  const [curriculumRevisions, setCurriculumRevisions] = useState<
    CurriculumRevision[]
  >([]);
  const [loadingSubjectGroups, setLoadingSubjectGroups] = useState(false);
  const [loadingRevisions, setLoadingRevisions] = useState(false);

  // êµê³¼ ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ
  useEffect(() => {
    setLoadingSubjectGroups(true);
    getSubjectGroupsAction()
      .then((groups) => {
        setAvailableSubjectGroups(groups || []);
      })
      .catch((error) => {
        console.error("êµê³¼ ê·¸ë£¹ ì¡°íšŒ ì‹¤íŒ¨:", error);
      })
      .finally(() => {
        setLoadingSubjectGroups(false);
      });
  }, []);

  // ê°œì •êµìœ¡ê³¼ì • ëª©ë¡ ì¡°íšŒ
  useEffect(() => {
    setLoadingRevisions(true);
    getCurriculumRevisionsAction()
      .then((revisions) => {
        setCurriculumRevisions(revisions || []);
      })
      .catch((error) => {
        console.error("ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ ì‹¤íŒ¨:", error);
      })
      .finally(() => {
        setLoadingRevisions(false);
      });
  }, []);

  // ============================================================================
  // í•„ìˆ˜ êµê³¼ í•¸ë“¤ëŸ¬
  // ============================================================================
  const handleLoadSubjects = useCallback(
    async (
      subjectGroupId: string,
      curriculumRevisionId: string
    ): Promise<Array<{ id: string; name: string }>> => {
      try {
        // í•´ë‹¹ ê°œì •êµìœ¡ê³¼ì •ì˜ êµê³¼ ê·¸ë£¹ ì°¾ê¸°
        const selectedGroup = availableSubjectGroups.find(
          (g) => g.id === subjectGroupId
        );
        if (!selectedGroup) {
          return [];
        }

        // ê°™ì€ ì´ë¦„ì˜ êµê³¼ ê·¸ë£¹ ì¤‘ í•´ë‹¹ ê°œì •êµìœ¡ê³¼ì •ì˜ ê²ƒ ì°¾ê¸°
        const curriculumGroup = availableSubjectGroups.find(
          (g) =>
            g.name === selectedGroup.name &&
            g.curriculum_revision_id === curriculumRevisionId
        );

        if (!curriculumGroup) {
          return [];
        }

        // í•´ë‹¹ êµê³¼ ê·¸ë£¹ì˜ ê³¼ëª© ì¡°íšŒ
        const subjects = await getSubjectsByGroupAction(curriculumGroup.id);
        return subjects.map((s) => ({ id: s.id, name: s.name }));
      } catch (error) {
        console.error("ì„¸ë¶€ ê³¼ëª© ì¡°íšŒ ì‹¤íŒ¨:", error);
        return [];
      }
    },
    [availableSubjectGroups]
  );

  const handleAddRequiredSubject = useCallback(() => {
    const currentConstraints = data.subject_constraints || {
      enable_required_subjects_validation: true,
      required_subjects: [],
      constraint_handling: "warning",
    };

    onUpdate({
      subject_constraints: {
        ...currentConstraints,
        required_subjects: [
          ...(currentConstraints.required_subjects || []),
          { subject_group_id: "", subject_category: "", min_count: 1 },
        ],
      },
    });
  }, [data.subject_constraints, onUpdate]);

  const handleRequiredSubjectUpdate = useCallback(
    (
      index: number,
      updated: Partial<{
        subject_group_id: string;
        subject_category: string;
        min_count: number;
        subjects_by_curriculum?: Array<{
          curriculum_revision_id: string;
          subject_id?: string;
          subject_name?: string;
        }>;
      }>
    ) => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      const newRequirements = [...currentConstraints.required_subjects!];
      newRequirements[index] = { ...newRequirements[index], ...updated };

      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          required_subjects: newRequirements,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  const handleRequiredSubjectRemove = useCallback(
    (index: number) => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      const newRequirements = currentConstraints.required_subjects!.filter(
        (_: any, i: number) => i !== index
      );

      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          required_subjects: newRequirements,
          enable_required_subjects_validation: newRequirements.length > 0,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  const handleConstraintHandlingChange = useCallback(
    (handling: "strict" | "warning" | "auto_fix") => {
      if (!data.subject_constraints) return;

      const currentConstraints = data.subject_constraints;
      onUpdate({
        subject_constraints: {
          ...currentConstraints,
          constraint_handling: handling,
        },
      });
    },
    [data.subject_constraints, onUpdate]
  );

  // ============================================================================
  // ì¶”ì²œ ìš”ì²­ í•¸ë“¤ëŸ¬
  // ============================================================================
  const handleSubjectToggle = useCallback((subject: string) => {
    setSelectedSubjects((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(subject)) {
        newSet.delete(subject);
      } else {
        newSet.add(subject);
      }
      return newSet;
    });

    // êµê³¼ê°€ ì„ íƒë˜ë©´ ê¸°ë³¸ ê°œìˆ˜ 1ë¡œ ì„¤ì •
    setRecommendationCounts((prev) => {
      const newMap = new Map(prev);
      if (!prev.has(subject)) {
        newMap.set(subject, 1);
      }
      return newMap;
    });
  }, []);

  const handleCountChange = useCallback((subject: string, count: number) => {
    setRecommendationCounts((prev) => {
      const newMap = new Map(prev);
      newMap.set(subject, count);
      return newMap;
    });
  }, []);

  const handleSubmitRecommendation = useCallback(async () => {
    console.log("[Step4RecommendedContents] ì¶”ì²œ ìš”ì²­ ì‹œì‘:", {
      selectedSubjects: Array.from(selectedSubjects),
      recommendationCounts: Object.fromEntries(recommendationCounts),
      autoAssignContents,
    });

    // ìµœì†Œ ì œì•½ ê²€ì¦
    if (selectedSubjects.size === 0) {
      alert(ERROR_MESSAGES.NO_SUBJECTS_SELECTED);
      return;
    }

    const totalRequested = Array.from(recommendationCounts.values()).reduce(
      (sum, count) => sum + count,
      0
    );
    const currentTotal =
      data.student_contents.length + data.recommended_contents.length;

    if (totalRequested === 0) {
      alert(ERROR_MESSAGES.NO_COUNT_SET);
      return;
    }

    if (currentTotal + totalRequested > 9) {
      alert(
        ERROR_MESSAGES.EXCEED_MAX_CONTENTS(currentTotal, totalRequested, 9)
      );
      return;
    }

    console.log(
      "[Step4RecommendedContents] fetchRecommendationsWithSubjects í˜¸ì¶œ:",
      {
        subjects: Array.from(selectedSubjects),
        counts: Object.fromEntries(recommendationCounts),
        autoAssign: autoAssignContents,
      }
    );

    // êµê³¼ë³„ ì¶”ì²œ ê°œìˆ˜ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì¶”ì²œ ìš”ì²­
    await fetchRecommendationsWithSubjects(
      Array.from(selectedSubjects),
      recommendationCounts,
      autoAssignContents
    );
  }, [
    selectedSubjects,
    recommendationCounts,
    data.student_contents,
    data.recommended_contents,
    autoAssignContents,
    fetchRecommendationsWithSubjects,
  ]);

  const handleRefreshRecommendations = useCallback(async () => {
    if (!confirm(CONFIRM_MESSAGES.REFRESH_RECOMMENDATIONS)) {
      return;
    }

    // êµê³¼ ì„ íƒ ì—¬ë¶€ í™•ì¸
    if (selectedSubjects.size === 0) {
      alert("ì¶”ì²œë°›ì„ êµê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    // ì¬ì¶”ì²œ ìš”ì²­
    await fetchRecommendationsWithSubjects(
      Array.from(selectedSubjects),
      recommendationCounts,
      false // ì¬ì¶”ì²œì€ ìë™ ë°°ì •í•˜ì§€ ì•ŠìŒ
    );

    alert("ìƒˆë¡œìš´ ì¶”ì²œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }, [
    selectedSubjects,
    recommendationCounts,
    fetchRecommendationsWithSubjects,
  ]);

  // ============================================================================
  // ê³„ì‚°ëœ ê°’ë“¤
  // ============================================================================
  const studentCount = data.student_contents.length;
  const recommendedCount = data.recommended_contents.length;
  const totalCount = studentCount + recommendedCount;
  const canAddMore = totalCount < 9;

  // ì¶”ì²œ ìš”ì²­ í¼ í‘œì‹œ ì¡°ê±´: ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” í•­ìƒ í‘œì‹œ, ê·¸ ì™¸ì—ëŠ” ì¶”ì²œì„ ë°›ê¸° ì „ì´ê±°ë‚˜, ì¶”ì²œì„ ë°›ì•˜ì§€ë§Œ ëª©ë¡ì´ ë¹„ì–´ìˆì„ ë•Œ
  const shouldShowRecommendationForm =
    isAdminContinueMode || // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” í•­ìƒ í‘œì‹œ
    !hasRequestedRecommendations ||
    (hasRequestedRecommendations &&
      recommendedContents.length === 0 &&
      !loading);

  // ë””ë²„ê¹…: ì¶”ì²œ ìš”ì²­ í¼ í‘œì‹œ ì¡°ê±´ í™•ì¸
  console.log("[Step4RecommendedContents] ì¶”ì²œ ìš”ì²­ í¼ í‘œì‹œ ì¡°ê±´:", {
    hasRequestedRecommendations,
    recommendedContentsLength: recommendedContents.length,
    loading,
    shouldShowRecommendationForm,
    autoAssignContents,
  });

  // ============================================================================
  // Render
  // ============================================================================
  return (
    <div className="space-y-6">
      {/* í•„ìˆ˜ êµê³¼ ì„¤ì • ì„¹ì…˜ - ìº í”„ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
      {!isCampMode && (
        <RequiredSubjectsSection
          data={data}
          availableSubjectGroups={availableSubjectGroups}
          curriculumRevisions={curriculumRevisions}
          onLoadSubjects={handleLoadSubjects}
          onUpdate={onUpdate}
          onAddRequiredSubject={handleAddRequiredSubject}
          onUpdateRequiredSubject={handleRequiredSubjectUpdate}
          onRemoveRequiredSubject={handleRequiredSubjectRemove}
          onConstraintHandlingChange={handleConstraintHandlingChange}
          isTemplateMode={false}
          isCampMode={isCampMode}
          studentId={studentId}
        />
      )}

      <div className="flex flex-col gap-6">
        {/* í•™ìƒ ì½˜í…ì¸  ì„¹ì…˜ (ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) */}
        {isCampMode && data.student_contents && data.student_contents.length > 0 && (
          <div className="flex flex-col gap-4">
            <div className="flex flex-col gap-2">
              <h2 className="text-xl font-semibold text-gray-900">
                í•™ìƒì´ ë“±ë¡í•œ ì½˜í…ì¸ 
              </h2>
              <p className="text-sm text-gray-500">
                í•™ìƒì´ ë“±ë¡í•œ ì½˜í…ì¸ ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
              </p>
            </div>
            <AddedContentsList
              contents={data.student_contents}
              allRecommendedContents={[]} // í•™ìƒ ì½˜í…ì¸ ëŠ” ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ì´ ì—†ìŒ
              editingRangeIndex={editingRangeIndex}
              editingRange={editingRange}
              contentDetails={contentDetails}
              startDetailId={startDetailId}
              endDetailId={endDetailId}
              contentTotals={contentTotals}
              loadingDetails={loadingDetails}
              onStartEditing={(index) => startEditingRange(index, "student")}
              onSaveRange={saveEditingRange}
              onCancelEditing={cancelEditingRange}
              onRemove={(index) => removeContent(index, "student")}
              onStartDetailChange={setStartRange}
              onEndDetailChange={setEndRange}
              onRangeChange={(start, end) => setEditingRange({ start, end })}
            />
          </div>
        )}

        <div className="flex flex-col gap-2">
          <h2 className="text-xl font-semibold text-gray-900">
            ì„œë¹„ìŠ¤ ì¶”ì²œ ì½˜í…ì¸ 
          </h2>
          <p className="text-sm text-gray-500">
            ì„±ì  ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œëœ êµì¬ì™€ ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ìµœëŒ€ 9ê°œ,
            êµ­ì–´/ìˆ˜í•™/ì˜ì–´ ê° 1ê°œ ì´ìƒ í•„ìˆ˜)
          </p>
        </div>

        {/* ì½˜í…ì¸  ì„ íƒ ì§„í–‰ë¥  */}
        <ContentSelectionProgress
          current={totalCount}
          max={9}
          requiredSubjects={progressRequiredSubjects}
          showWarning={missingRequiredSubjects.length > 0}
          warningMessage={
            missingRequiredSubjects.length > 0
              ? `ë‹¤ìŒ í•„ìˆ˜ ê³¼ëª©ì˜ ìµœì†Œ ê°œìˆ˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${missingRequiredSubjects
                  .map(
                    (m: any) =>
                      `${m.name} (í˜„ì¬ ${m.current}ê°œ / í•„ìš” ${m.required}ê°œ)`
                  )
                  .join(", ")}`
              : undefined
          }
        />

        {/* ì´ë¯¸ ì¶”ê°€ëœ ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ */}
        <AddedContentsList
          contents={data.recommended_contents}
          allRecommendedContents={allRecommendedContents}
          editingRangeIndex={editingRangeIndex}
          editingRange={editingRange}
          contentDetails={contentDetails}
          startDetailId={startDetailId}
          endDetailId={endDetailId}
          contentTotals={contentTotals}
          loadingDetails={loadingDetails}
          onStartEditing={(index) => startEditingRange(index, "recommended")}
          onSaveRange={saveEditingRange}
          onCancelEditing={cancelEditingRange}
          onRemove={(index) => removeContent(index, "recommended")}
          onStartDetailChange={setStartRange}
          onEndDetailChange={setEndRange}
          onRangeChange={(start, end) => setEditingRange({ start, end })}
        />

        {/* ì¶”ì²œ ìš”ì²­ í¼ (ì¶”ì²œì„ ë°›ê¸° ì „ ë˜ëŠ” ì¶”ê°€ ì¶”ì²œì„ ë°›ì„ ë•Œ) */}
        {/* í¸ì§‘ ëª¨ë“œì—ì„œ ì €ì¥ í›„ ë‹¤ì‹œ ë¡œë“œí•  ë•Œ recommendedContentsê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¶”ì²œ ìš”ì²­ í¼ì„ ë‹¤ì‹œ í‘œì‹œ */}
        {shouldShowRecommendationForm && (
          <RecommendationRequestForm
            selectedSubjects={selectedSubjects}
            recommendationCounts={recommendationCounts}
            autoAssignContents={autoAssignContents}
            currentStudentContentsCount={studentCount}
            currentRecommendedContentsCount={recommendedCount}
            onSubjectToggle={handleSubjectToggle}
            onCountChange={handleCountChange}
            onAutoAssignChange={setAutoAssignContents}
            onSubmit={handleSubmitRecommendation}
            disabled={loading}
          />
        )}

        {/* ë¡œë”© ìƒíƒœ */}
        {loading && (
          <div className="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
            <p className="text-sm text-gray-500">ì¶”ì²œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        )}

        {/* ì¶”ì²œ ê²°ê³¼ê°€ ì—†ì„ ë•Œ (ì¶”ì²œ ìš”ì²­ í¼ì´ í‘œì‹œë˜ì§€ ì•Šì„ ë•Œë§Œ) */}
        {hasRequestedRecommendations &&
          !loading &&
          recommendedContents.length === 0 &&
          !shouldShowRecommendationForm && (
            <div className="flex flex-col gap-2 rounded-lg border border-amber-200 bg-amber-50 p-8 text-center">
              <p className="text-sm font-medium text-amber-800">
                ì¶”ì²œí•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.
              </p>
              <p className="text-xs text-amber-600">
                ì„±ì  ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì‹œë©´ ë§ì¶¤í˜• ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          )}

        {/* ì¶”ì²œ ì½˜í…ì¸  ëª©ë¡ */}
        {hasRequestedRecommendations &&
          !loading &&
          recommendedContents.length > 0 && (
            <RecommendedContentsList
              recommendedContents={recommendedContents}
              selectedContentIds={selectedContentIds}
              selectedSubjects={selectedSubjects}
              recommendationCounts={recommendationCounts}
              requiredSubjectCategories={requiredSubjectCategories}
              selectedSubjectCategories={selectedSubjectCategories}
              missingRequiredSubjects={missingRequiredSubjects}
              studentCount={studentCount}
              recommendedCount={recommendedCount}
              loading={loading}
              onToggleSelection={toggleContentSelection}
              onRefresh={handleRefreshRecommendations}
              onAddSelectedContents={addSelectedContents}
            />
          )}
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step6Simplified.tsx">
"use client";

import React, { useState, useEffect, useMemo, useRef } from "react";
import { WizardData } from "./PlanGroupWizard";
import {
  CollapsibleSection,
  BasicInfoSummary,
  TimeSettingsSummary,
  ContentsSummary,
  LearningVolumeSummary,
  SubjectAllocationSummary,
} from "./_summary";
import { getEffectiveAllocation } from "@/lib/utils/subjectAllocation";

/**
 * Step6Simplified - ìµœì¢… í™•ì¸ (ê°„ì†Œí™”)
 *
 * Phase 4.4ì—ì„œ êµ¬í˜„
 *
 * ê¸°ì¡´ Step6FinalReview (2,625 ë¼ì¸)ë¥¼ ê°„ì†Œí™”
 * - ì ‘ê¸°/í¼ì¹˜ê¸° UI
 * - ì½ê¸° ì „ìš© ì¤‘ì‹¬
 * - ìš”ì•½ ì •ë³´ë§Œ í‘œì‹œ
 * - ìˆ˜ì •ì€ ë‹¨ê³„ ì´ë™
 */

export type Step6SimplifiedProps = {
  data: WizardData;
  onEditStep: (step: 1 | 2 | 4) => void;
  isCampMode?: boolean;
  isAdminContinueMode?: boolean;
  onUpdate?: (updates: Partial<WizardData>) => void;
  contents?: {
    books: Array<{ id: string; title: string; subtitle?: string | null; master_content_id?: string | null }>;
    lectures: Array<{ id: string; title: string; subtitle?: string | null; master_content_id?: string | null }>;
    custom: Array<{ id: string; title: string; subtitle?: string | null }>;
  };
  studentId?: string;
  editable?: boolean;
  isTemplateMode?: boolean;
};

// SubjectAllocationEditor ì»´í¬ë„ŒíŠ¸ (ê´€ë¦¬ì ëª¨ë“œìš©)
// êµê³¼ë³„ë¡œ ê·¸ë£¹í™”í•˜ë˜, ê° ì½˜í…ì¸ ë§ˆë‹¤ ê°œë³„ì ìœ¼ë¡œ ì „ëµ/ì·¨ì•½ ì„¤ì • ê°€ëŠ¥
function SubjectAllocationEditor({
  data,
  onUpdate,
  contents,
  editable = true,
}: {
  data: WizardData;
  onUpdate: (updates: Partial<WizardData>) => void;
  contents: {
    books: Array<{ id: string; title: string; subtitle?: string | null; master_content_id?: string | null }>;
    lectures: Array<{ id: string; title: string; subtitle?: string | null; master_content_id?: string | null }>;
    custom: Array<{ id: string; title: string; subtitle?: string | null }>;
  };
  editable?: boolean;
}) {
  // contentInfos ìƒì„± (data.student_contentsì™€ data.recommended_contentsì—ì„œ)
  const contentInfos = useMemo(() => {
    const infos: Array<{
      content_type: "book" | "lecture";
      content_id: string;
      title: string;
      subject_category: string | null;
      isRecommended: boolean;
    }> = [];

    // í•™ìƒ ì½˜í…ì¸ 
    data.student_contents.forEach((content) => {
      infos.push({
        content_type: content.content_type as "book" | "lecture",
        content_id: content.content_id,
        title: content.title || "ì•Œ ìˆ˜ ì—†ìŒ",
        subject_category: content.subject_category || null,
        isRecommended: false,
      });
    });

    // ì¶”ì²œ ì½˜í…ì¸ 
    data.recommended_contents.forEach((content) => {
      infos.push({
        content_type: content.content_type as "book" | "lecture",
        content_id: content.content_id,
        title: content.title || "ì•Œ ìˆ˜ ì—†ìŒ",
        subject_category: content.subject_category || null,
        isRecommended: true,
      });
    });

    return infos;
  }, [data.student_contents, data.recommended_contents]);

  // êµê³¼ë³„ë¡œ ì½˜í…ì¸  ê·¸ë£¹í™”
  const contentsBySubject = useMemo(() => {
    const map = new Map<string, typeof contentInfos>();
    contentInfos.forEach((content) => {
      if (content.subject_category) {
        if (!map.has(content.subject_category)) {
          map.set(content.subject_category, []);
        }
        map.get(content.subject_category)!.push(content);
      }
    });
    return map;
  }, [contentInfos]);

  const subjects = Array.from(contentsBySubject.keys()).sort();

  // ì´ˆê¸°í™” ì—¬ë¶€ ì¶”ì ì„ ìœ„í•œ ref
  const hasInitialized = useRef(false);

  // ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ë³¸ê°’ ìë™ ì €ì¥
  useEffect(() => {
    // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆê±°ë‚˜ ì½˜í…ì¸ ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    if (hasInitialized.current || contentInfos.length === 0) {
      return;
    }

    // ì´ˆê¸°í™” ì¡°ê±´ í™•ì¸: content_allocationsì™€ subject_allocationsê°€ ëª¨ë‘ ë¹„ì–´ìˆëŠ” ê²½ìš°
    const hasContentAllocations = (data.content_allocations || []).length > 0;
    const hasSubjectAllocations = (data.subject_allocations || []).length > 0;
    
    if (!hasContentAllocations && !hasSubjectAllocations) {
      // ëª¨ë“  ì½˜í…ì¸ ì— ëŒ€í•´ ê¸°ë³¸ê°’(ì·¨ì•½ê³¼ëª©)ì„ content_allocationsì— ìë™ìœ¼ë¡œ ì¶”ê°€
      const defaultContentAllocations = contentInfos.map((content) => ({
        content_type: content.content_type as "book" | "lecture",
        content_id: content.content_id,
        subject_type: "weakness" as const,
        weekly_days: undefined,
      }));
      
      onUpdate({ content_allocations: defaultContentAllocations });
      hasInitialized.current = true;
    } else {
      // ì´ë¯¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™” ì™„ë£Œë¡œ í‘œì‹œ
      hasInitialized.current = true;
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [contentInfos, data.content_allocations, data.subject_allocations]);

  if (subjects.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">ì½˜í…ì¸ ì˜ ê³¼ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  // ì½˜í…ì¸ ë³„ ì„¤ì • ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleContentAllocationChange = (
    content: { content_type: string; content_id: string },
    allocation: {
      subject_type: "strategy" | "weakness";
      weekly_days?: number;
    }
  ) => {
    if (!editable) return;
    const currentAllocations = data.content_allocations || [];
    const updatedAllocations = currentAllocations.filter(
      (a) =>
        !(
          a.content_type === content.content_type &&
          a.content_id === content.content_id
        )
    );
    updatedAllocations.push({
      content_type: content.content_type as "book" | "lecture",
      content_id: content.content_id,
      subject_type: allocation.subject_type,
      weekly_days: allocation.weekly_days,
    });
    onUpdate({ content_allocations: updatedAllocations });
  };

  // êµê³¼ë³„ ì„¤ì • ëª¨ë“œ íŒë‹¨: subject_allocationsì— ìˆìœ¼ë©´ êµê³¼ ë‹¨ìœ„, content_allocationsì— í•´ë‹¹ êµê³¼ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ì½˜í…ì¸ ë³„, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ êµê³¼ ë‹¨ìœ„
  const getSubjectAllocationMode = (subject: string): "subject" | "content" => {
    // subject_allocationsì— í•´ë‹¹ êµê³¼ê°€ ìˆìœ¼ë©´ êµê³¼ ë‹¨ìœ„ ì„¤ì • ëª¨ë“œ
    const hasSubjectAllocation = (data.subject_allocations || []).some(
      (a) => a.subject_name === subject
    );
    if (hasSubjectAllocation) {
      return "subject";
    }

    // content_allocationsì— í•´ë‹¹ êµê³¼ì˜ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ì½˜í…ì¸ ë³„ ì„¤ì • ëª¨ë“œ
    const subjectContents = contentsBySubject.get(subject) || [];
    const hasContentAllocation = subjectContents.some((content) =>
      (data.content_allocations || []).some(
        (a) =>
          a.content_type === content.content_type &&
          a.content_id === content.content_id
      )
    );
    if (hasContentAllocation) {
      return "content";
    }

    // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’: êµê³¼ ë‹¨ìœ„ ì„¤ì • ëª¨ë“œ
    return "subject";
  };

  // êµê³¼ ë‹¨ìœ„ ì„¤ì • ë³€ê²½ í•¸ë“¤ëŸ¬
  const handleSubjectAllocationChange = (
    subject: string,
    allocation: {
      subject_id: string;
      subject_name: string;
      subject_type: "strategy" | "weakness";
      weekly_days?: number;
    }
  ) => {
    if (!editable) return;
    const currentAllocations = data.subject_allocations || [];
    const updatedAllocations = currentAllocations.filter(
      (a) => a.subject_name !== subject
    );
    updatedAllocations.push(allocation);
    
    // í•´ë‹¹ êµê³¼ì˜ content_allocationsì—ì„œ ì œê±°
    const subjectContents = contentsBySubject.get(subject) || [];
    const updatedContentAllocations = (data.content_allocations || []).filter(
      (a) =>
        !subjectContents.some(
          (c) =>
            c.content_type === a.content_type && c.content_id === a.content_id
        )
    );

    onUpdate({
      subject_allocations: updatedAllocations,
      content_allocations: updatedContentAllocations,
    });
  };

  // ì„¤ì • ëª¨ë“œ ì „í™˜ í•¸ë“¤ëŸ¬
  const handleModeChange = (subject: string, mode: "subject" | "content") => {
    if (!editable) return;
    
    if (mode === "subject") {
      // êµê³¼ ë‹¨ìœ„ ì„¤ì • ëª¨ë“œë¡œ ì „í™˜
      // ê¸°ë³¸ê°’ìœ¼ë¡œ ì·¨ì•½ê³¼ëª© ì„¤ì •
      const currentAllocations = data.subject_allocations || [];
      const updatedAllocations = currentAllocations.filter(
        (a) => a.subject_name !== subject
      );
      updatedAllocations.push({
        subject_id: subject.toLowerCase().replace(/\s+/g, "_"),
        subject_name: subject,
        subject_type: "weakness",
      });

      // í•´ë‹¹ êµê³¼ì˜ content_allocationsì—ì„œ ì œê±°
      const subjectContents = contentsBySubject.get(subject) || [];
      const updatedContentAllocations = (data.content_allocations || []).filter(
        (a) =>
          !subjectContents.some(
            (c) =>
              c.content_type === a.content_type &&
              c.content_id === a.content_id
          )
      );

      onUpdate({
        subject_allocations: updatedAllocations,
        content_allocations: updatedContentAllocations,
      });
    } else {
      // ì½˜í…ì¸ ë³„ ì„¤ì • ëª¨ë“œë¡œ ì „í™˜
      // subject_allocationsì—ì„œ í•´ë‹¹ êµê³¼ ì œê±°
      const updatedAllocations = (data.subject_allocations || []).filter(
        (a) => a.subject_name !== subject
      );
      
      // ê¸°ì¡´ êµê³¼ ë‹¨ìœ„ ì„¤ì • ê°’ ê°€ì ¸ì˜¤ê¸°
      const existingSubjectAllocation = (data.subject_allocations || []).find(
        (a) => a.subject_name === subject
      );
      
      // í•´ë‹¹ êµê³¼ì˜ ì½˜í…ì¸  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      const subjectContents = contentsBySubject.get(subject) || [];
      
      // ê¸°ì¡´ content_allocations ê°€ì ¸ì˜¤ê¸°
      const currentContentAllocations = data.content_allocations || [];
      
      // í•´ë‹¹ êµê³¼ì˜ ê¸°ì¡´ content_allocations ì œê±° (ì¤‘ë³µ ë°©ì§€)
      const filteredContentAllocations = currentContentAllocations.filter(
        (a) =>
          !subjectContents.some(
            (c) =>
              c.content_type === a.content_type &&
              c.content_id === a.content_id
          )
      );
      
      // ê¸°ì¡´ êµê³¼ ë‹¨ìœ„ ì„¤ì • ê°’ì´ ìˆìœ¼ë©´ ê° ì½˜í…ì¸ ì— ë³µì‚¬
      // ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(ì·¨ì•½ê³¼ëª©)ìœ¼ë¡œ ê° ì½˜í…ì¸ ì— ì„¤ì •
      const allocationToApply = existingSubjectAllocation || {
        subject_type: "weakness" as const,
        weekly_days: undefined,
      };
      
      subjectContents.forEach((content) => {
        // ì´ë¯¸ content_allocationsì— ìˆëŠ”ì§€ í™•ì¸
        const existingContentAlloc = currentContentAllocations.find(
          (a) =>
            a.content_type === content.content_type &&
            a.content_id === content.content_id
        );
        
        // ì—†ìœ¼ë©´ ê¸°ì¡´ êµê³¼ ë‹¨ìœ„ ì„¤ì • ê°’(ë˜ëŠ” ê¸°ë³¸ê°’)ìœ¼ë¡œ ì¶”ê°€
        if (!existingContentAlloc) {
          filteredContentAllocations.push({
            content_type: content.content_type as "book" | "lecture",
            content_id: content.content_id,
            subject_type: allocationToApply.subject_type,
            weekly_days: allocationToApply.weekly_days,
          });
        }
      });
      
      onUpdate({
        subject_allocations: updatedAllocations,
        content_allocations: filteredContentAllocations,
      });
    }
  };

  // í´ë°± ë©”ì»¤ë‹ˆì¦˜: ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì‚¬ìš©
  const getEffectiveAllocationForContent = (content: (typeof contentInfos)[0]) => {
    return getEffectiveAllocation(
      {
        content_type: content.content_type,
        content_id: content.content_id,
        subject_category: content.subject_category || undefined,
        subject: null,
        subject_id: undefined,
      },
      data.content_allocations?.map((a) => ({
        content_type: a.content_type as "book" | "lecture" | "custom",
        content_id: a.content_id,
        subject_type: a.subject_type,
        weekly_days: a.weekly_days,
      })),
      data.subject_allocations?.map((a) => ({
        subject_id: a.subject_id,
        subject_name: a.subject_name,
        subject_type: a.subject_type,
        weekly_days: a.weekly_days,
      })),
      false // UIì—ì„œëŠ” ë¡œê¹… ë¹„í™œì„±í™”
    );
  };

  return (
    <div className="flex flex-col gap-6">
      {subjects.map((subject) => {
        const contents = contentsBySubject.get(subject) || [];
        const allocationMode = getSubjectAllocationMode(subject);
        const isSubjectMode = allocationMode === "subject";
        
        // êµê³¼ ë‹¨ìœ„ ì„¤ì • ì •ë³´
        const subjectAllocation = (data.subject_allocations || []).find(
          (a) => a.subject_name === subject
        );
        const subjectType = subjectAllocation?.subject_type || "weakness";
        const subjectWeeklyDays = subjectAllocation?.weekly_days || 3;

        return (
          <div
            key={subject}
            className="rounded-xl border border-gray-200 bg-white p-6"
          >
            <div className="flex flex-col gap-4">
              {/* êµê³¼ í—¤ë” */}
              <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <h3 className="text-sm font-semibold text-gray-900">{subject}</h3>
                <span className="text-xs text-gray-600">
                  {contents.length}ê°œ ì½˜í…ì¸ 
                </span>
              </div>
              
              {/* ì„¤ì • ëª¨ë“œ í† ê¸€ */}
              <div className="inline-flex rounded-lg border border-gray-300 p-1">
                <button
                  type="button"
                  onClick={() => handleModeChange(subject, "subject")}
                  disabled={!editable}
                  className={`rounded-md px-3 py-1.5 text-xs font-medium transition-colors disabled:cursor-not-allowed disabled:opacity-60 ${
                    isSubjectMode
                      ? "bg-gray-900 text-white"
                      : "text-gray-600 hover:bg-gray-100"
                  }`}
                >
                  êµê³¼ ë‹¨ìœ„ ì„¤ì •
                </button>
                <button
                  type="button"
                  onClick={() => handleModeChange(subject, "content")}
                  disabled={!editable}
                  className={`rounded-md px-3 py-1.5 text-xs font-medium transition-colors disabled:cursor-not-allowed disabled:opacity-60 ${
                    !isSubjectMode
                      ? "bg-gray-900 text-white"
                      : "text-gray-600 hover:bg-gray-100"
                  }`}
                >
                  ì½˜í…ì¸ ë³„ ì„¤ì •
                </button>
              </div>
            </div>

            {/* êµê³¼ ë‹¨ìœ„ ì„¤ì • UI */}
            {isSubjectMode && (
              <div className="rounded-lg border border-gray-200 bg-gray-50 p-3">
                <div className="flex flex-col gap-3">
                  <div className="flex flex-col gap-2">
                    <label className="block text-xs font-medium text-gray-600">
                      ê³¼ëª© ìœ í˜•
                    </label>
                  <div className="flex gap-3">
                    <label className="flex flex-1 cursor-pointer items-center gap-2 rounded-lg border p-3 transition-colors hover:bg-gray-100">
                      <input
                        type="radio"
                        name={`subject_type_${subject}`}
                        value="weakness"
                        checked={subjectType === "weakness"}
                        onChange={() => {
                          handleSubjectAllocationChange(subject, {
                            subject_id: subject
                              .toLowerCase()
                              .replace(/\s+/g, "_"),
                            subject_name: subject,
                            subject_type: "weakness",
                          });
                        }}
                        disabled={!editable}
                        className="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-60"
                      />
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-900">
                          ì·¨ì•½ê³¼ëª©
                        </div>
                        <div className="text-xs text-gray-600">
                          ì „ì²´ í•™ìŠµì¼ì— í”Œëœ ë°°ì •
                        </div>
                      </div>
                    </label>
                    <label className="flex flex-1 cursor-pointer items-center gap-2 rounded-lg border p-3 transition-colors hover:bg-gray-100">
                      <input
                        type="radio"
                        name={`subject_type_${subject}`}
                        value="strategy"
                        checked={subjectType === "strategy"}
                        onChange={() => {
                          handleSubjectAllocationChange(subject, {
                            subject_id: subject
                              .toLowerCase()
                              .replace(/\s+/g, "_"),
                            subject_name: subject,
                            subject_type: "strategy",
                            weekly_days: 3,
                          });
                        }}
                        disabled={!editable}
                        className="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-60"
                      />
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-900">
                          ì „ëµê³¼ëª©
                        </div>
                        <div className="text-xs text-gray-600">
                          ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜ì— ë”°ë¼ ë°°ì •
                        </div>
                      </div>
                    </label>
                  </div>
                </div>

                {subjectType === "strategy" && (
                  <div className="flex flex-col gap-2">
                    <label className="block text-xs font-medium text-gray-600">
                      ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜
                    </label>
                    <select
                      className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                      value={subjectWeeklyDays}
                      onChange={(e) => {
                        handleSubjectAllocationChange(subject, {
                          subject_id: subject.toLowerCase().replace(/\s+/g, "_"),
                          subject_name: subject,
                          subject_type: "strategy",
                          weekly_days: Number(e.target.value),
                        });
                      }}
                      disabled={!editable}
                    >
                      <option value="2">ì£¼ 2ì¼</option>
                      <option value="3">ì£¼ 3ì¼</option>
                      <option value="4">ì£¼ 4ì¼</option>
                    </select>
                    <p className="text-xs text-gray-600">
                      ì„ íƒí•œ ì£¼ë‹¹ ì¼ìˆ˜ì— ë”°ë¼ í•™ìŠµì¼ì— ê· ë“±í•˜ê²Œ ë°°ì •ë©ë‹ˆë‹¤.
                    </p>
                  </div>
                )}
                </div>
              </div>
            )}

            {/* ì½˜í…ì¸  ëª©ë¡ */}
            <div className="flex flex-col gap-3">
              {contents.map((content) => {
                const effectiveAlloc = getEffectiveAllocationForContent(content);
                const contentSubjectType = effectiveAlloc.subject_type;
                const contentWeeklyDays = effectiveAlloc.weekly_days || 3;
                const source = effectiveAlloc.source;
                const isContentDisabled = isSubjectMode && !editable;

                return (
                  <div
                    key={`${content.content_type}-${content.content_id}`}
                    className={`rounded-lg border border-gray-200 p-3 ${
                      isSubjectMode ? "bg-gray-50 opacity-75" : "bg-gray-50"
                    }`}
                  >
                    <div className="flex flex-col gap-2">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex flex-col gap-1">
                            <div className="text-sm font-medium text-gray-900">
                              {content.content_type === "book" ? "ğŸ“š" : "ğŸ§"}{" "}
                              {content.title}
                            </div>
                            {isSubjectMode && (
                              <div className="text-xs text-gray-600">
                                êµê³¼ ë‹¨ìœ„ ì„¤ì • ì ìš© ì¤‘
                              </div>
                            )}
                            {!isSubjectMode && source !== "content" && (
                              <div className="text-xs text-gray-600">
                                {source === "subject" && "êµê³¼ë³„ ì„¤ì • ì ìš© ì¤‘"}
                                {source === "default" && "ê¸°ë³¸ê°’ (ì·¨ì•½ê³¼ëª©)"}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>

                      {/* ì½˜í…ì¸ ë³„ ì„¤ì • UI (êµê³¼ ë‹¨ìœ„ ëª¨ë“œì¼ ë•ŒëŠ” ë¹„í™œì„±í™”) */}
                      {!isSubjectMode && (
                        <div className="flex flex-col gap-2">
                        <div className="flex gap-2">
                          <label className="flex flex-1 cursor-pointer items-center gap-2 rounded border p-2 text-xs transition-colors hover:bg-gray-100">
                            <input
                              type="radio"
                              name={`content_type_${content.content_type}_${content.content_id}`}
                              value="weakness"
                              checked={contentSubjectType === "weakness"}
                              onChange={() => {
                                handleContentAllocationChange(content, {
                                  subject_type: "weakness",
                                });
                              }}
                              disabled={!editable || isContentDisabled}
                              className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-60"
                            />
                            <span className="text-gray-900">ì·¨ì•½ê³¼ëª©</span>
                          </label>
                          <label className="flex flex-1 cursor-pointer items-center gap-2 rounded border p-2 text-xs transition-colors hover:bg-gray-100">
                            <input
                              type="radio"
                              name={`content_type_${content.content_type}_${content.content_id}`}
                              value="strategy"
                              checked={contentSubjectType === "strategy"}
                              onChange={() => {
                                handleContentAllocationChange(content, {
                                  subject_type: "strategy",
                                  weekly_days: 3,
                                });
                              }}
                              disabled={!editable || isContentDisabled}
                              className="h-3 w-3 border-gray-300 text-blue-600 focus:ring-blue-500 disabled:cursor-not-allowed disabled:opacity-60"
                            />
                            <span className="text-gray-900">ì „ëµê³¼ëª©</span>
                          </label>
                        </div>

                        {contentSubjectType === "strategy" && (
                          <div>
                            <select
                              className="w-full rounded border border-gray-300 px-2 py-1 text-xs focus:border-gray-900 focus:outline-none disabled:cursor-not-allowed disabled:bg-gray-100 disabled:opacity-60"
                              value={contentWeeklyDays}
                              onChange={(e) => {
                                handleContentAllocationChange(content, {
                                  subject_type: "strategy",
                                  weekly_days: Number(e.target.value),
                                });
                              }}
                              disabled={!editable || isContentDisabled}
                            >
                              <option value="2">ì£¼ 2ì¼</option>
                              <option value="3">ì£¼ 3ì¼</option>
                              <option value="4">ì£¼ 4ì¼</option>
                            </select>
                          </div>
                        )}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
            </div>
          </div>
        );
      })}

      {/* ì„¤ì • ìš”ì•½ */}
      <div className="rounded-lg border border-blue-200 bg-blue-50 p-3">
        <div className="flex flex-col gap-2">
          <h4 className="text-xs font-semibold text-blue-800">ì„¤ì • ìš”ì•½</h4>
          <div className="flex flex-col gap-1 text-xs text-blue-800">
          <p>â€¢ ì½˜í…ì¸ ë³„ ì„¤ì •: {(data.content_allocations || []).length}ê°œ</p>
          <p>
            â€¢ êµê³¼ë³„ ì„¤ì • (í´ë°±): {(data.subject_allocations || []).length}ê°œ
          </p>
          <p className="text-blue-800">
            ì½˜í…ì¸ ë³„ ì„¤ì •ì´ ìš°ì„  ì ìš©ë˜ë©°, ì„¤ì •ë˜ì§€ ì•Šì€ ì½˜í…ì¸ ëŠ” êµê³¼ë³„ ì„¤ì •ì„
            ë”°ë¦…ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>
    </div>
  );
}

export function Step6Simplified({
  data,
  onEditStep,
  isCampMode = false,
  isAdminContinueMode = false,
  onUpdate,
  contents,
  studentId,
  editable = true,
  isTemplateMode = false,
}: Step6SimplifiedProps) {
  return (
    <div className="flex flex-col gap-6">
      {/* í—¤ë” */}
      <div className="flex flex-col gap-1">
        <h2 className="text-xl font-semibold text-gray-900">ìµœì¢… í™•ì¸</h2>
        <p className="text-sm text-gray-600">
          í”Œëœì„ ìƒì„±í•˜ê¸° ì „ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”. ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ í•´ë‹¹
          ë‹¨ê³„ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      </div>

      {/* ì„¹ì…˜ë“¤ */}
      <div className="flex flex-col gap-4">
        {/* 1. ê¸°ë³¸ ì •ë³´ */}
        <CollapsibleSection
          title="ê¸°ë³¸ ì •ë³´"
          defaultOpen={false}
          onEdit={() => onEditStep(1)}
          editLabel="Step 1ë¡œ ëŒì•„ê°€ê¸°"
        >
          <BasicInfoSummary data={data} />
        </CollapsibleSection>

        {/* 2. ì‹œê°„ ì„¤ì • */}
        <CollapsibleSection
          title="ì‹œê°„ ì„¤ì •"
          defaultOpen={false}
          onEdit={() => onEditStep(2)}
          editLabel="Step 2ë¡œ ëŒì•„ê°€ê¸°"
        >
          <TimeSettingsSummary data={data} />
        </CollapsibleSection>

        {/* 3. ì½˜í…ì¸  ì„ íƒ (ê¸°ë³¸ í¼ì¹¨) */}
        <CollapsibleSection
          title="ì½˜í…ì¸  ì„ íƒ"
          defaultOpen={true}
          onEdit={() => onEditStep(4)}
          editLabel="Step 4ë¡œ ëŒì•„ê°€ê¸°"
        >
          <ContentsSummary data={data} isCampMode={isCampMode} />
        </CollapsibleSection>

        {/* 4. í•™ìŠµëŸ‰ ë¹„êµ */}
        <CollapsibleSection title="í•™ìŠµëŸ‰ ë¹„êµ" defaultOpen={false}>
          <LearningVolumeSummary data={data} />
        </CollapsibleSection>

        {/* 5. ì „ëµ/ì·¨ì•½ ê³¼ëª© */}
        {/* ê´€ë¦¬ì ëª¨ë“œì—ì„œëŠ” í•­ìƒ í‘œì‹œ, ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” 1730_timetableì´ê³  subject_allocationsê°€ ìˆì„ ë•Œ í‘œì‹œ */}
        {(isAdminContinueMode ||
          (data.scheduler_type === "1730_timetable" &&
            data.subject_allocations &&
            data.subject_allocations.length > 0)) && (
            <CollapsibleSection title="ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª©" defaultOpen={false}>
            {isAdminContinueMode && onUpdate && contents ? (
              <SubjectAllocationEditor
                data={data}
                onUpdate={onUpdate}
                contents={contents}
                editable={editable}
              />
            ) : (
              <SubjectAllocationSummary data={data} />
            )}
            </CollapsibleSection>
          )}
      </div>

      {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
      <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
        <div className="flex items-start gap-3">
          <div className="flex-shrink-0">
            <svg
              className="h-5 w-5 text-blue-800"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <div className="flex-1">
            <div className="flex flex-col gap-2">
              <h4 className="text-sm font-semibold text-blue-800">
                í”Œëœ ìƒì„± ì „ í™•ì¸ì‚¬í•­
              </h4>
              <ul className="flex flex-col gap-1 text-sm text-blue-800">
              <li>â€¢ ëª¨ë“  ì •ë³´ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”</li>
              <li>
                â€¢ ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ ê° ì„¹ì…˜ì˜ &quot;ëŒì•„ê°€ê¸°&quot; ë²„íŠ¼ì„
                í´ë¦­í•˜ì„¸ìš”
              </li>
              <li>â€¢ í”Œëœ ìƒì„± í›„ì—ë„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="new-group/_components/Step7ScheduleResult.tsx">
"use client";

import { useEffect, useRef } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { 
  getScheduleResultDataAction,
  generatePlansFromGroupAction,
  checkPlansExistAction,
} from "@/app/(student)/actions/planGroupActions";
import { ScheduleTableView } from "./Step7ScheduleResult/ScheduleTableView";
import type {
  ContentData,
  BlockData,
} from "./utils/scheduleTransform";

type Step7ScheduleResultProps = {
  groupId: string;
  onComplete: () => void;
  isAdminContinueMode?: boolean;
};

export function Step7ScheduleResult({
  groupId,
  onComplete,
  isAdminContinueMode = false,
}: Step7ScheduleResultProps) {
  const queryClient = useQueryClient();
  const hasAutoGeneratedRef = useRef(false); // ìë™ ìƒì„± ì¤‘ë³µ ë°©ì§€

  // í”Œëœ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  const { data: plansCheck, isLoading: isCheckingPlans } = useQuery({
    queryKey: ["plansExist", groupId],
    queryFn: () => checkPlansExistAction(groupId),
    staleTime: 1000 * 60, // 1ë¶„ê°„ ìºì‹œ ìœ ì§€
  });

  // í”Œëœ ìƒì„± ë®¤í…Œì´ì…˜
  const generatePlansMutation = useMutation({
    mutationFn: () => generatePlansFromGroupAction(groupId),
    onSuccess: async () => {
      // í”Œëœ ìƒì„± í›„ ê´€ë ¨ ì¿¼ë¦¬ ìºì‹œ ë¬´íš¨í™” ë° ì¬ì¡°íšŒ
      await queryClient.invalidateQueries({ queryKey: ["plansExist", groupId] });
      await queryClient.invalidateQueries({ queryKey: ["planSchedule", groupId] });
      // plansCheckë¥¼ ì¦‰ì‹œ ì¬ì¡°íšŒí•˜ì—¬ hasPlans ìƒíƒœ ì—…ë°ì´íŠ¸
      await queryClient.refetchQueries({ queryKey: ["plansExist", groupId] });
    },
  });

  // Step 7 ì§„ì… ì‹œ í”Œëœì´ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ì¼ë°˜ ëª¨ë“œë§Œ)
  useEffect(() => {
    // ê´€ë¦¬ì continue ëª¨ë“œëŠ” ì™„ë£Œ ë²„íŠ¼ì—ì„œ continueCampStepsForAdmin í˜¸ì¶œí•˜ë¯€ë¡œ ìë™ ìƒì„± ìŠ¤í‚µ
    if (isAdminContinueMode) {
      return;
    }

    // ì¼ë°˜ ëª¨ë“œë§Œ ìë™ ìƒì„±
    // í”Œëœ í™•ì¸ì´ ì™„ë£Œë˜ê³ , í”Œëœì´ ì—†ê³ , ì•„ì§ ìë™ ìƒì„±í•˜ì§€ ì•Šì•˜ê³ , ìƒì„± ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
    if (
      !isCheckingPlans &&
      plansCheck &&
      !plansCheck.hasPlans &&
      !hasAutoGeneratedRef.current &&
      !generatePlansMutation.isPending &&
      !generatePlansMutation.isSuccess
    ) {
      console.log("[Step7ScheduleResult] í”Œëœì´ ì—†ì–´ ìë™ ìƒì„± ì‹œì‘:", groupId);
      hasAutoGeneratedRef.current = true;
      generatePlansMutation.mutate();
    }
  }, [
    isCheckingPlans,
    plansCheck,
    groupId,
    isAdminContinueMode,
    generatePlansMutation.isPending,
    generatePlansMutation.isSuccess,
  ]);

  // í”Œëœ ì¬ìƒì„± í•¸ë“¤ëŸ¬
  const handleRegenerate = () => {
    if (
      !confirm(
        "í”Œëœì„ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ í”Œëœì´ ì‚­ì œë˜ê³  ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤."
      )
    ) {
      return;
    }

    generatePlansMutation.mutate();
  };

  // ìŠ¤ì¼€ì¤„ ê²°ê³¼ ë°ì´í„° ì¡°íšŒ (ê¸°ì¡´ PlanScheduleViewì™€ ë™ì¼í•œ queryKey ì‚¬ìš©)
  const {
    data,
    isLoading,
    error,
  } = useQuery({
    queryKey: ["planSchedule", groupId],
    queryFn: async () => {
      const result = await getScheduleResultDataAction(groupId);

      if (result.plans.length === 0) {
        throw new Error("ìƒì„±ëœ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.");
      }

      // contents ë°°ì—´ì„ Mapìœ¼ë¡œ ë³€í™˜
      const contentsMap = new Map(
        result.contents.map((c) => [c.id, c])
      );

      return {
        dailySchedule: result.dailySchedule || [],
        plans: result.plans || [],
        contents: contentsMap,
        blocks: result.blocks || [],
      };
    },
    enabled: Boolean(plansCheck?.hasPlans || generatePlansMutation.isSuccess),
    staleTime: 1000 * 60 * 5, // 5ë¶„ê°„ ìºì‹œ ìœ ì§€
    gcTime: 1000 * 60 * 10, // 10ë¶„ê°„ ë©”ëª¨ë¦¬ ìœ ì§€
    refetchOnWindowFocus: false,
    refetchOnMount: false,
    refetchOnReconnect: false,
  });

  const isGenerating = generatePlansMutation.isPending;
  const isLoadingData = isLoading || isCheckingPlans;
  const hasError = error || generatePlansMutation.error;

  if (isLoadingData || isGenerating) {
    return (
      <div className="flex flex-col gap-6">
        <div className="flex flex-col gap-1">
          <h2 className="text-xl font-semibold text-gray-900">ìŠ¤ì¼€ì¤„ ê²°ê³¼</h2>
          <p className="text-sm text-gray-500">
            {isGenerating ? "í”Œëœì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤..." : "ìƒì„±ëœ í•™ìŠµ í”Œëœì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
          </p>
        </div>
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-gray-50 p-8 text-center">
          <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-gray-900"></div>
          <p className="text-sm text-gray-500">
            {isGenerating ? "í”Œëœ ìƒì„± ì¤‘..." : "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."}
          </p>
        </div>
      </div>
    );
  }

  if (hasError) {
    const errorMessage = 
      generatePlansMutation.error instanceof Error 
        ? `í”Œëœ ìƒì„± ì‹¤íŒ¨: ${generatePlansMutation.error.message}`
        : error instanceof Error 
        ? error.message
        : "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

    return (
      <div className="flex flex-col gap-6">
        <div className="flex flex-col gap-1">
          <h2 className="text-xl font-semibold text-gray-900">ìŠ¤ì¼€ì¤„ ê²°ê³¼</h2>
          <p className="text-sm text-gray-500">
            ìƒì„±ëœ í•™ìŠµ í”Œëœì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <div className="flex flex-col gap-2 rounded-lg border border-red-200 bg-red-50 p-4">
          <h3 className="text-sm font-semibold text-red-800">ì˜¤ë¥˜</h3>
          <p className="text-sm text-red-700">{errorMessage}</p>
        </div>
      </div>
    );
  }

  // í”Œëœì´ ì—†ì„ ë•Œ ì—ëŸ¬ í‘œì‹œ (ìë™ ìƒì„± ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í•œ ê²½ìš°)
  // ìë™ ìƒì„±ì´ ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì„±ê³µí•œ ê²½ìš°ëŠ” ë¡œë”© í™”ë©´ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì—ëŸ¬ë§Œ í‘œì‹œ
  if (
    !data &&
    !isLoadingData &&
    !isGenerating &&
    plansCheck &&
    !plansCheck.hasPlans &&
    (generatePlansMutation.isError || hasAutoGeneratedRef.current)
  ) {
    return (
      <div className="flex flex-col gap-6">
        <div className="flex flex-col gap-1">
          <h2 className="text-xl font-semibold text-gray-900">ìŠ¤ì¼€ì¤„ ê²°ê³¼</h2>
          <p className="text-sm text-gray-500">
            ìƒì„±ëœ í•™ìŠµ í”Œëœì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <div className="flex flex-col gap-3 rounded-lg border border-red-200 bg-red-50 p-4">
          <h3 className="text-sm font-semibold text-red-800">ì˜¤ë¥˜</h3>
          <p className="text-sm text-red-700">
            í”Œëœ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í”Œëœ ì¬ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
          </p>
          <button
            type="button"
            onClick={handleRegenerate}
            disabled={generatePlansMutation.isPending}
            className="inline-flex items-center justify-center rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 disabled:cursor-not-allowed disabled:bg-red-400"
          >
            {generatePlansMutation.isPending ? "ì¬ìƒì„± ì¤‘..." : "í”Œëœ ì¬ìƒì„±"}
          </button>
        </div>
      </div>
    );
  }

  // í”Œëœì´ ìˆì„ ë•Œ ìŠ¤ì¼€ì¤„ ê²°ê³¼ í‘œì‹œ
  if (!data) {
    return null;
  }

  const { dailySchedule, plans, contents, blocks } = data;

  return (
    <div className="flex flex-col gap-6">
      <div className="flex items-center justify-between">
        <div className="flex flex-col gap-1">
          <h2 className="text-xl font-semibold text-gray-900">ìŠ¤ì¼€ì¤„ ê²°ê³¼</h2>
          <p className="text-sm text-gray-500">
            ìƒì„±ëœ í•™ìŠµ í”Œëœì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ {plans.length}ê°œì˜ í”Œëœì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          </p>
        </div>
        <button
          type="button"
          onClick={handleRegenerate}
          disabled={generatePlansMutation.isPending}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
        >
          {generatePlansMutation.isPending ? "ì¬ìƒì„± ì¤‘..." : "í”Œëœ ì¬ìƒì„±"}
        </button>
      </div>

      <ScheduleTableView
        dailySchedule={dailySchedule}
        plans={plans}
        contents={contents}
        blocks={blocks}
      />
    </div>
  );
}
</file>

<file path="new-group/page.tsx">
import Link from "next/link";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import { PlanGroupWizard } from "./_components/PlanGroupWizard";
import { getPlanGroupWithDetails } from "@/lib/data/planGroups";
import { getCurrentUser } from "@/lib/auth/getCurrentUser";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { fetchAllStudentContents } from "@/lib/data/planContents";
import { ScrollToTop } from "@/components/ScrollToTop";
import { getContainerClass } from "@/lib/constants/layout";
import { inlineButtonBase } from "@/lib/utils/darkMode";

type PageProps = {
  searchParams: Promise<Record<string, string | undefined>>;
};

export default async function NewPlanGroupPage({ searchParams }: PageProps) {
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  const params = await searchParams;
  const draftId = params.draft;

  // Draft ë¶ˆëŸ¬ì˜¤ê¸°
  let initialData: any = undefined;
  if (draftId) {
    try {
      const currentUser = await getCurrentUser();
      const tenantContext = await getTenantContext();
      const { group, contents, exclusions, academySchedules } =
        await getPlanGroupWithDetails(
          draftId,
          currentUser?.userId || user.id,
          tenantContext?.tenantId
        );

      if (group && group.status === "draft") {
        // ë°ì´í„° ë³€í™˜ í•¨ìˆ˜ ì‚¬ìš©
        const { transformPlanGroupToWizardData } = await import("@/lib/utils/planGroupTransform");
        initialData = await transformPlanGroupToWizardData(
          group,
          contents,
          exclusions,
          academySchedules,
          user.id
        );
      }
    } catch (error) {
      console.error("[plan/new-group] Draft ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", error);
      // ì—ëŸ¬ ë°œìƒ ì‹œ ì´ˆê¸° ë°ì´í„° ì—†ì´ ì§„í–‰
    }
  }

  // ë¸”ë¡ ì„¸íŠ¸ ëª©ë¡ ì¡°íšŒ (ì‹œê°„ ë¸”ë¡ ì •ë³´ í¬í•¨)
  const { fetchBlockSetsWithBlocks } = await import("@/lib/data/blockSets");
  const blockSets = await fetchBlockSetsWithBlocks(user.id);

  // ì½˜í…ì¸  ëª©ë¡ ì¡°íšŒ (í†µí•© í•¨ìˆ˜ ì‚¬ìš©)
  const { books, lectures, custom } = await fetchAllStudentContents(user.id);

  return (
    <>
      <ScrollToTop />
      <section className={getContainerClass("LIST", "lg")}>
        <div className="flex flex-col gap-8">
        <div className="flex items-start justify-between gap-4">
          <div className="flex flex-col gap-2 flex-1">
            <p className="text-sm font-medium text-gray-500">í•™ìŠµ í”Œëœ</p>
            <h1 className="text-3xl font-semibold text-gray-900">
              ìƒˆ í•™ìŠµ í”Œëœ ê·¸ë£¹ ë§Œë“¤ê¸°
            </h1>
            <p className="text-sm text-gray-500">
              ëª©ì ê³¼ ê¸°ê°„ì„ ì„¤ì •í•˜ê³ , í•™ìŠµ ëŒ€ìƒ ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ì—¬ ë§ì¶¤í˜• í•™ìŠµ ê³„íšì„ ìƒì„±í•˜ì„¸ìš”.
            </p>
          </div>
          <Link
            href="/plan"
            className={inlineButtonBase("px-4 py-2 text-sm font-semibold")}
          >
            ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </Link>
        </div>

      <PlanGroupWizard
        initialBlockSets={blockSets || []}
        initialContents={{
          books,
          lectures,
          custom,
        }}
        initialData={initialData}
      />
      </div>
    </section>
    </>
  );
}
</file>

<file path="page.tsx">
import { Suspense } from "react";
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { PlanGroupList } from "./_components/PlanGroupList";
import { PlanGroupStatsCard } from "./_components/PlanGroupStatsCard";
import { FilterBar } from "./_components/FilterBar";
import { RescheduleRecommendations } from "./_components/RescheduleRecommendations";
import { getPlanGroupsWithStats, PlanGroupFilters } from "@/lib/data/planGroups";
import { ScrollToTop } from "@/components/ScrollToTop";
import { PageHeader } from "@/components/layout/PageHeader";
import PageContainer from "@/components/layout/PageContainer";
import { EmptyState } from "@/components/molecules/EmptyState";
import { SuspenseFallback } from "@/components/ui/LoadingSkeleton";
import { getContainerClass } from "@/lib/constants/layout";

type PlanPageProps = {
  searchParams: Promise<Record<string, string | undefined>>;
};

export default async function PlanListPage({ searchParams }: PlanPageProps) {
  const params = await searchParams;
  const createdCount = params?.created;
  const planPurpose = params?.planPurpose;
  const sortOrder = params?.sortOrder || "desc"; // ê¸°ë³¸ê°’: ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)

  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  // í”Œëœ ê·¸ë£¹ í•„í„° êµ¬ì„±
  const planGroupFilters: PlanGroupFilters = {
    studentId: user.id,
    includeDeleted: false,
  };

  if (planPurpose) {
    planGroupFilters.planPurpose = planPurpose;
  }

  // í†µí•© í•¨ìˆ˜ ì‚¬ìš© (í†µê³„ í¬í•¨)
  const planGroupsWithStats = await getPlanGroupsWithStats(planGroupFilters);

  // ìº í”„ ëª¨ë“œ í”Œëœ ì œì™¸ (ìº í”„ ê´€ë ¨ í”Œëœì€ /camp ê²½ë¡œì—ì„œë§Œ í™•ì¸)
  const nonCampPlanGroups = planGroupsWithStats.filter(
    (group) => 
      group.plan_type !== "camp" && 
      !group.camp_template_id && 
      !group.camp_invitation_id
  );

  // ìƒì„±ì¼ ê¸°ì¤€ ì •ë ¬
  const sortedPlanGroups = [...nonCampPlanGroups].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
    return sortOrder === "asc" ? dateA - dateB : dateB - dateA;
  });

  // PlanGroupListì— ì „ë‹¬í•  í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const planGroups = sortedPlanGroups;
  
  const planCounts = new Map<string, number>();
  const planProgressData = new Map<string, { completedCount: number; totalCount: number }>();

  // í•„í„°ë§ëœ í”Œëœ ê·¸ë£¹ë§Œ í†µê³„ì— í¬í•¨
  nonCampPlanGroups.forEach((group) => {
    planCounts.set(group.id, group.planCount);
    planProgressData.set(group.id, {
      completedCount: group.completedCount,
      totalCount: group.totalCount,
    });
  });

  // í†µê³„ ê³„ì‚°
  const stats = {
    total: planGroups.length,
    active: planGroups.filter((g) => g.status === "active").length,
    paused: planGroups.filter((g) => g.status === "paused" || g.status === "cancelled").length,
    completed: planGroups.filter((g) => g.status === "completed").length,
  };

  return (
    <>
      <ScrollToTop />
      <section className={getContainerClass("CAMP_PLAN", "md")}>
        <div className="flex flex-col gap-6">
        <PageHeader
          title="í•™ìƒë³„ í”Œëœ ëª©ë¡"
          description="ê¸°ê°„ë³„ë¡œ ìƒì„±ëœ í•™ìŠµ ê³„íšì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”."
          action={
            <Link
              href="/plan/new-group"
              className="inline-flex items-center justify-center gap-2 rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2"
              aria-label="ìƒˆ í”Œëœ ê·¸ë£¹ ìƒì„±"
            >
              + í”Œëœ ìƒì„±
            </Link>
          }
        />

        {createdCount && (
          <div className="rounded-lg border border-green-200 bg-green-50 p-4 text-sm text-green-700">
            {createdCount}ê°œì˜ í•™ìŠµ í”Œëœì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
          </div>
        )}

        {/* í•„í„° ë°” */}
        {planGroups.length > 0 && (
          <Suspense fallback={<SuspenseFallback />}>
            <FilterBar
              currentPlanPurpose={planPurpose}
              currentSortOrder={sortOrder}
            />
          </Suspense>
        )}

        {/* ì¬ì¡°ì • ì¶”ì²œ - í”Œëœ ê·¸ë£¹ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ */}
        {planGroups.length > 0 && (
          <RescheduleRecommendations 
            key={planGroups.length} 
            studentId={user.id} 
          />
        )}

        {/* í†µê³„ ì¹´ë“œ */}
        {planGroups.length > 0 && (
          <PlanGroupStatsCard
            totalGroups={stats.total}
            activeCount={stats.active}
            pausedCount={stats.paused}
            completedCount={stats.completed}
          />
        )}

        {/* í”Œëœ ëª©ë¡ ì„¹ì…˜ */}
        <div className="flex flex-col gap-4">
          {planGroups.length > 0 ? (
            <PlanGroupList 
              key={planGroups.length}
              groups={planGroups} 
              planCounts={planCounts}
              planProgressData={planProgressData}
            />
          ) : (
            <EmptyState
              icon="ğŸ“‹"
              title="ë“±ë¡ëœ í”Œëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤"
              description="ìƒˆë¡œìš´ í”Œëœ ê·¸ë£¹ì„ ë§Œë“¤ì–´ ê¸°ê°„ë³„ í•™ìŠµ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”."
              actionLabel="í”Œëœ ê·¸ë£¹ ìƒì„±í•˜ê¸°"
              actionHref="/plan/new-group"
            />
          )}
        </div>
      </div>
    </section>
    </>
  );
}
</file>

<file path="page.tsx">
import { Suspense } from "react";
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { PlanGroupList } from "./_components/PlanGroupList";
import { PlanGroupStatsCard } from "./_components/PlanGroupStatsCard";
import { FilterBar } from "./_components/FilterBar";
import { RescheduleRecommendations } from "./_components/RescheduleRecommendations";
import { getPlanGroupsWithStats, PlanGroupFilters } from "@/lib/data/planGroups";
import { ScrollToTop } from "@/components/ScrollToTop";
import { PageHeader } from "@/components/layout/PageHeader";
import PageContainer from "@/components/layout/PageContainer";
import { EmptyState } from "@/components/molecules/EmptyState";
import { SuspenseFallback } from "@/components/ui/LoadingSkeleton";
import { getContainerClass } from "@/lib/constants/layout";

type PlanPageProps = {
  searchParams: Promise<Record<string, string | undefined>>;
};

export default async function PlanListPage({ searchParams }: PlanPageProps) {
  const params = await searchParams;
  const createdCount = params?.created;
  const planPurpose = params?.planPurpose;
  const sortOrder = params?.sortOrder || "desc"; // ê¸°ë³¸ê°’: ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)

  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  // í”Œëœ ê·¸ë£¹ í•„í„° êµ¬ì„±
  const planGroupFilters: PlanGroupFilters = {
    studentId: user.id,
    includeDeleted: false,
  };

  if (planPurpose) {
    planGroupFilters.planPurpose = planPurpose;
  }

  // í†µí•© í•¨ìˆ˜ ì‚¬ìš© (í†µê³„ í¬í•¨)
  const planGroupsWithStats = await getPlanGroupsWithStats(planGroupFilters);

  // ìº í”„ ëª¨ë“œ í”Œëœ ì œì™¸ (ìº í”„ ê´€ë ¨ í”Œëœì€ /camp ê²½ë¡œì—ì„œë§Œ í™•ì¸)
  const nonCampPlanGroups = planGroupsWithStats.filter(
    (group) => 
      group.plan_type !== "camp" && 
      !group.camp_template_id && 
      !group.camp_invitation_id
  );

  // ìƒì„±ì¼ ê¸°ì¤€ ì •ë ¬
  const sortedPlanGroups = [...nonCampPlanGroups].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
    return sortOrder === "asc" ? dateA - dateB : dateB - dateA;
  });

  // PlanGroupListì— ì „ë‹¬í•  í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const planGroups = sortedPlanGroups;
  
  const planCounts = new Map<string, number>();
  const planProgressData = new Map<string, { completedCount: number; totalCount: number }>();

  // í•„í„°ë§ëœ í”Œëœ ê·¸ë£¹ë§Œ í†µê³„ì— í¬í•¨
  nonCampPlanGroups.forEach((group) => {
    planCounts.set(group.id, group.planCount);
    planProgressData.set(group.id, {
      completedCount: group.completedCount,
      totalCount: group.totalCount,
    });
  });

  // í†µê³„ ê³„ì‚°
  const stats = {
    total: planGroups.length,
    active: planGroups.filter((g) => g.status === "active").length,
    paused: planGroups.filter((g) => g.status === "paused" || g.status === "cancelled").length,
    completed: planGroups.filter((g) => g.status === "completed").length,
  };

  return (
    <>
      <ScrollToTop />
      <section className={getContainerClass("CAMP_PLAN", "md")}>
        <div className="flex flex-col gap-6">
        <PageHeader
          title="í•™ìƒë³„ í”Œëœ ëª©ë¡"
          description="ê¸°ê°„ë³„ë¡œ ìƒì„±ëœ í•™ìŠµ ê³„íšì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”."
          action={
            <Link
              href="/plan/new-group"
              className="inline-flex items-center justify-center gap-2 rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2"
              aria-label="ìƒˆ í”Œëœ ê·¸ë£¹ ìƒì„±"
            >
              + í”Œëœ ìƒì„±
            </Link>
          }
        />

        {createdCount && (
          <div className="rounded-lg border border-green-200 bg-green-50 p-4 text-sm text-green-700">
            {createdCount}ê°œì˜ í•™ìŠµ í”Œëœì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
          </div>
        )}

        {/* í•„í„° ë°” */}
        {planGroups.length > 0 && (
          <Suspense fallback={<SuspenseFallback />}>
            <FilterBar
              currentPlanPurpose={planPurpose}
              currentSortOrder={sortOrder}
            />
          </Suspense>
        )}

        {/* ì¬ì¡°ì • ì¶”ì²œ - í”Œëœ ê·¸ë£¹ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ */}
        {planGroups.length > 0 && (
          <RescheduleRecommendations 
            key={planGroups.length} 
            studentId={user.id} 
          />
        )}

        {/* í†µê³„ ì¹´ë“œ */}
        {planGroups.length > 0 && (
          <PlanGroupStatsCard
            totalGroups={stats.total}
            activeCount={stats.active}
            pausedCount={stats.paused}
            completedCount={stats.completed}
          />
        )}

        {/* í”Œëœ ëª©ë¡ ì„¹ì…˜ */}
        <div className="flex flex-col gap-4">
          {planGroups.length > 0 ? (
            <PlanGroupList 
              key={planGroups.length}
              groups={planGroups} 
              planCounts={planCounts}
              planProgressData={planProgressData}
            />
          ) : (
            <EmptyState
              icon="ğŸ“‹"
              title="ë“±ë¡ëœ í”Œëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤"
              description="ìƒˆë¡œìš´ í”Œëœ ê·¸ë£¹ì„ ë§Œë“¤ì–´ ê¸°ê°„ë³„ í•™ìŠµ ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”."
              actionLabel="í”Œëœ ê·¸ë£¹ ìƒì„±í•˜ê¸°"
              actionHref="/plan/new-group"
            />
          )}
        </div>
      </div>
    </section>
    </>
  );
}
</file>

<file path="_components/BaseScoreCard.tsx">
"use client";

import { memo, useState, ReactNode } from "react";
import { Edit2, Trash2 } from "lucide-react";
import { Dialog } from "@/components/ui/Dialog";
import { cn } from "@/lib/cn";

type BaseScoreCardProps<T extends { id: string; grade_score?: number | null }> = {
  score: T;
  subjectGroupName?: string;
  subjectName?: string;
  subjectTypeName?: string;
  gradeBadge: ReactNode; // ë“±ê¸‰ ë°°ì§€
  periodBadge: ReactNode; // ê¸°ê°„/ì‹œí—˜ ì •ë³´ ë°°ì§€
  scoreFields: ReactNode; // ì„±ì  ì •ë³´ í•„ë“œë“¤
  detailDialogContent: ReactNode; // ìƒì„¸ ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ìš©
  onEdit: (score: T) => void;
  onDelete: (scoreId: string) => void;
};

function BaseScoreCardComponent<T extends { id: string; grade_score?: number | null }>({
  score,
  subjectGroupName,
  subjectName,
  subjectTypeName,
  gradeBadge,
  periodBadge,
  scoreFields,
  detailDialogContent,
  onEdit,
  onDelete,
}: BaseScoreCardProps<T>) {
  const [isHovered, setIsHovered] = useState(false);
  const [isDetailOpen, setIsDetailOpen] = useState(false);

  return (
    <>
      <div
        className={cn(
          "group relative rounded-xl border bg-white shadow-sm transition-all duration-200 select-none cursor-pointer",
          "hover:shadow-md hover:border-indigo-200",
          isHovered && "shadow-md border-indigo-200"
        )}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        onClick={(e) => {
          // ì•¡ì…˜ ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ì—´ì§€ ì•ŠìŒ
          if ((e.target as HTMLElement).closest('[data-action-container]')) {
            return;
          }
          setIsDetailOpen(true);
        }}
      >
        <div className="flex flex-col gap-5 p-5 md:p-6">
          {/* í—¤ë”: ê³¼ëª©ëª… ë° ë“±ê¸‰ */}
          <div className="flex items-start justify-between gap-4">
            <div className="flex flex-col gap-2 flex-1 min-w-0">
              <div className="flex items-center gap-2">
                <h3 className="text-lg font-bold text-gray-900 truncate">
                  {subjectName || "-"}
                </h3>
                {gradeBadge}
              </div>
              <div className="flex flex-wrap items-center gap-1.5">
                {subjectGroupName && (
                  <span className="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-700 ring-1 ring-inset ring-gray-200">
                    {subjectGroupName}
                  </span>
                )}
                {subjectTypeName && (
                  <span className="inline-flex items-center rounded-md bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700 ring-1 ring-inset ring-indigo-200">
                    {subjectTypeName}
                  </span>
                )}
                {periodBadge}
              </div>
            </div>
          </div>

          {/* ì„±ì  ì •ë³´ ê·¸ë¦¬ë“œ */}
          <div className="grid grid-cols-2 gap-3 border-t border-gray-100 pt-4">
            {scoreFields}
          </div>

          {/* ìš°ìƒë‹¨ ì•¡ì…˜ ë²„íŠ¼ (í˜¸ë²„ ì‹œ í‘œì‹œ) */}
          {isHovered && (
            <div
              data-action-container
              className="absolute top-3 right-3 flex gap-1.5 z-10"
            >
              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onEdit(score);
                }}
                className="rounded-lg bg-white p-2 text-gray-600 shadow-md ring-1 ring-gray-200 transition-all hover:bg-indigo-50 hover:text-indigo-600 hover:ring-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                aria-label="ìˆ˜ì •"
                title="ìˆ˜ì •"
              >
                <Edit2 className="h-4 w-4" />
              </button>
              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  onDelete(score.id);
                }}
                className="rounded-lg bg-white p-2 text-gray-600 shadow-md ring-1 ring-gray-200 transition-all hover:bg-red-50 hover:text-red-600 hover:ring-red-300 focus:outline-none focus:ring-2 focus:ring-red-500"
                aria-label="ì‚­ì œ"
                title="ì‚­ì œ"
              >
                <Trash2 className="h-4 w-4" />
              </button>
            </div>
          )}
        </div>
      </div>

      {/* ìƒì„¸ë³´ê¸° ë‹¤ì´ì–¼ë¡œê·¸ */}
      <Dialog
        open={isDetailOpen}
        onOpenChange={setIsDetailOpen}
        title="ì„±ì  ìƒì„¸ ì •ë³´"
        maxWidth="lg"
      >
        <div className="flex flex-col gap-6">
          {detailDialogContent}
          
          {/* ì•¡ì…˜ ë²„íŠ¼ */}
          <div className="flex justify-end gap-3 border-t border-gray-200 pt-4">
            <button
              onClick={() => setIsDetailOpen(false)}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              ë‹«ê¸°
            </button>
            <button
              onClick={() => {
                setIsDetailOpen(false);
                onEdit(score);
              }}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
            >
              ìˆ˜ì •
            </button>
          </div>
        </div>
      </Dialog>
    </>
  );
}

export const BaseScoreCard = memo(BaseScoreCardComponent) as typeof BaseScoreCardComponent;
</file>

<file path="_components/DeleteScoreButton.tsx">
"use client";

import { useTransition, useState } from "react";
import { useRouter } from "next/navigation";
import { deleteStudentScore } from "@/app/actions/scores";

type DeleteScoreButtonProps = {
  id: string;
};

export function DeleteScoreButton({ id }: DeleteScoreButtonProps) {
  const [isPending, startTransition] = useTransition();
  const [showConfirm, setShowConfirm] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  const handleDelete = async () => {
    setError(null);
    startTransition(async () => {
      try {
        await deleteStudentScore(id);
        router.refresh();
      } catch (err) {
        setError(err instanceof Error ? err.message : "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      } finally {
        setShowConfirm(false);
      }
    });
  };

  return (
    <>
      <button
        onClick={() => setShowConfirm(true)}
        disabled={isPending}
        className="inline-flex items-center justify-center rounded-lg border border-red-300 bg-white px-3 py-1.5 text-xs font-semibold text-red-700 transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"
      >
        ì‚­ì œ
      </button>

      {showConfirm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className="flex flex-col gap-6 rounded-lg bg-white p-6 shadow-xl">
            <div className="flex flex-col gap-2">
              <h3 className="text-lg font-semibold text-gray-900">ì„±ì  ì‚­ì œ í™•ì¸</h3>
              <p className="text-sm text-gray-600">
                ì •ë§ë¡œ ì´ ì„±ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </p>
            </div>
            {error && (
              <p className="rounded-md bg-red-50 p-3 text-sm text-red-600">
                {error}
              </p>
            )}
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setShowConfirm(false)}
                disabled={isPending}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleDelete}
                disabled={isPending}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
              >
                {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
</file>

<file path="_components/EmptyScoresState.tsx">
"use client";

import { FileText, Plus } from "lucide-react";
import { Card } from "@/components/molecules/Card";

type EmptyScoresStateProps = {
  onAddClick?: () => void;
  message?: string;
  actionLabel?: string;
};

export function EmptyScoresState({
  onAddClick,
  message = "ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.",
  actionLabel = "ì„±ì  ì¶”ê°€í•˜ê¸°",
}: EmptyScoresStateProps) {
  return (
    <Card className="flex flex-col items-center justify-center gap-4 p-12 text-center">
      <div className="rounded-full bg-gray-100 p-4">
        <FileText className="h-8 w-8 text-gray-400" />
      </div>
      <div className="flex flex-col gap-2">
        <h3 className="text-lg font-semibold text-gray-900">{message}</h3>
        <p className="text-sm text-gray-500">
          ì„±ì ì„ ì¶”ê°€í•˜ì—¬ í•™ìŠµ ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•˜ì„¸ìš”.
        </p>
      </div>
      {onAddClick && (
        <button
          onClick={onAddClick}
          className="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-6 py-3 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          <Plus className="h-4 w-4" />
          {actionLabel}
        </button>
      )}
    </Card>
  );
}
</file>

<file path="_components/GradeTabs.tsx">
"use client";

import { usePathname, useRouter } from "next/navigation";
import { useCallback, useRef, useEffect } from "react";

const grades = [
  { value: "1", label: "1í•™ë…„" },
  { value: "2", label: "2í•™ë…„" },
  { value: "3", label: "3í•™ë…„" },
];

type GradeTabsProps = {
  basePath: string; // ì˜ˆ: "/scores/school" ë˜ëŠ” "/scores/mock"
  currentGrade: string;
  additionalParams?: string[]; // ì˜ˆ: ["1", "êµ­ì–´"] (semester, subject-group ë“±)
};

export function GradeTabs({
  basePath,
  currentGrade,
  additionalParams = [],
}: GradeTabsProps) {
  const pathname = usePathname();
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const buildHref = (grade: string) => {
    const encodedParams = additionalParams.map((p) => encodeURIComponent(p)).join("/");
    return `${basePath}/${grade}${additionalParams.length > 0 ? `/${encodedParams}` : ""}`;
  };

  const handleTabClick = useCallback((grade: string) => {
    // ì´ë¯¸ í™œì„±í™”ëœ íƒ­ì´ë©´ ë¬´ì‹œ
    if (grade === currentGrade) return;

    // ì´ì „ timeout ì·¨ì†Œ
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    // 150ms debounce (ì—°ì† í´ë¦­ ë°©ì§€)
    timeoutRef.current = setTimeout(() => {
      router.push(buildHref(grade));
    }, 150);
  }, [basePath, currentGrade, additionalParams, router]);

  // cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ timeout ì •ë¦¬
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="flex gap-2 border-b border-gray-200">
      {grades.map((grade) => {
        const active = currentGrade === grade.value;
        return (
          <button
            key={grade.value}
            onClick={() => handleTabClick(grade.value)}
            className={`px-4 py-2 text-sm font-medium transition ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {grade.label}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="_components/MockExamTypeTabs.tsx">
"use client";

import { usePathname, useRouter } from "next/navigation";
import { useCallback, useRef, useEffect } from "react";

const examTypes = [
  { value: "í‰ê°€ì›", label: "í‰ê°€ì›" },
  { value: "êµìœ¡ì²­", label: "êµìœ¡ì²­" },
  { value: "ì‚¬ì„¤", label: "ì‚¬ì„¤" },
];

type MockExamTypeTabsProps = {
  basePath: string; // ì˜ˆ: "/scores/mock/1/3"
  currentExamType: string;
};

export function MockExamTypeTabs({
  basePath,
  currentExamType,
}: MockExamTypeTabsProps) {
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const buildHref = (examType: string) => {
    return `${basePath}/${encodeURIComponent(examType)}`;
  };

  const handleTabClick = useCallback((examType: string) => {
    const decodedCurrent = decodeURIComponent(currentExamType);
    // ì´ë¯¸ í™œì„±í™”ëœ íƒ­ì´ë©´ ë¬´ì‹œ
    if (examType === decodedCurrent) return;

    // ì´ì „ timeout ì·¨ì†Œ
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    // 150ms debounce (ì—°ì† í´ë¦­ ë°©ì§€)
    timeoutRef.current = setTimeout(() => {
      router.push(buildHref(examType));
    }, 150);
  }, [basePath, currentExamType, router]);

  // cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ timeout ì •ë¦¬
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="flex gap-2 border-b border-gray-200">
      {examTypes.map((examType) => {
        const active = decodeURIComponent(currentExamType) === examType.value;
        return (
          <button
            key={examType.value}
            onClick={() => handleTabClick(examType.value)}
            className={`px-4 py-2 text-sm font-medium transition ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {examType.label}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="_components/MockMonthTabs.tsx">
"use client";

import { usePathname, useRouter } from "next/navigation";
import { useCallback, useRef, useEffect } from "react";

const months = [
  { value: "3", label: "3ì›”" },
  { value: "4", label: "4ì›”" },
  { value: "5", label: "5ì›”" },
  { value: "6", label: "6ì›”" },
  { value: "7", label: "7ì›”" },
  { value: "8", label: "8ì›”" },
  { value: "9", label: "9ì›”" },
  { value: "10", label: "10ì›”" },
  { value: "11", label: "11ì›”" },
];

type MockMonthTabsProps = {
  basePath: string; // ì˜ˆ: "/scores/mock/1"
  currentMonth: string;
  additionalParams?: string[]; // ì¶”ê°€ íŒŒë¼ë¯¸í„° (ì˜ˆ: exam-type)
};

export function MockMonthTabs({ 
  basePath, 
  currentMonth,
  additionalParams = [],
}: MockMonthTabsProps) {
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const buildHref = (month: string) => {
    const params = additionalParams.length > 0 
      ? `/${additionalParams.map(p => encodeURIComponent(p)).join("/")}` 
      : "";
    return `${basePath}/${month}${params}`;
  };

  const handleTabClick = useCallback((month: string) => {
    // ì´ë¯¸ í™œì„±í™”ëœ íƒ­ì´ë©´ ë¬´ì‹œ
    if (month === currentMonth) return;

    // ì´ì „ timeout ì·¨ì†Œ
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    // 150ms debounce (ì—°ì† í´ë¦­ ë°©ì§€)
    timeoutRef.current = setTimeout(() => {
      router.push(buildHref(month));
    }, 150);
  }, [basePath, currentMonth, additionalParams, router]);

  // cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ timeout ì •ë¦¬
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="flex gap-2 border-b border-gray-200 overflow-x-auto">
      {months.map((month) => {
        const active = currentMonth === month.value;
        return (
          <button
            key={month.value}
            onClick={() => handleTabClick(month.value)}
            className={`whitespace-nowrap px-4 py-2 text-sm font-medium transition ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {month.label}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="_components/MockScoreListTable.tsx">
"use client";

import Link from "next/link";
import { useState, useMemo, memo } from "react";
import { getGradeColor } from "@/lib/constants/colors";
import { Card } from "@/components/molecules/Card";
import { Badge } from "@/components/atoms";
import { inlineButtonBase, tableRowBase, divideDefault, textSecondary, textPrimary } from "@/lib/utils/darkMode";

type MockScoreRow = {
  id: string;
  grade: number;
  subject_group: string;
  exam_type: string;
  subject_name: string | null;
  raw_score: number | null;
  percentile: number | null;
  grade_score: number | null;
  exam_round: string | null;
  created_at: string | null;
};

type MockScoreListTableProps = {
  scores: MockScoreRow[];
  grade: string;
  subjectGroup: string;
  examType: string;
  DeleteButton: React.ComponentType<{ id: string }>;
};

type SortField = "grade" | "exam_round" | "grade_score" | "raw_score" | "percentile";
type SortOrder = "asc" | "desc";

function MockScoreListTableComponent({
  scores,
  grade,
  subjectGroup,
  examType,
  DeleteButton,
}: MockScoreListTableProps) {
  const [sortField, setSortField] = useState<SortField>("grade");
  const [sortOrder, setSortOrder] = useState<SortOrder>("asc");
  const [filterRound, setFilterRound] = useState<string>("all");

  // í•„í„°ë§ ë° ì •ë ¬
  const filteredAndSortedScores = useMemo(() => {
    let filtered = [...scores];

    // íšŒì°¨ í•„í„°ë§
    if (filterRound !== "all") {
      filtered = filtered.filter((score) => score.exam_round === filterRound);
    }

    // ì •ë ¬
    filtered.sort((a, b) => {
      let aValue: number | string | null = null;
      let bValue: number | string | null = null;

      switch (sortField) {
        case "grade":
          aValue = a.grade ?? 0;
          bValue = b.grade ?? 0;
          break;
        case "exam_round":
          aValue = a.exam_round ?? "";
          bValue = b.exam_round ?? "";
          break;
        case "grade_score":
          aValue = a.grade_score ?? 999;
          bValue = b.grade_score ?? 999;
          break;
        case "raw_score":
          aValue = a.raw_score ?? 0;
          bValue = b.raw_score ?? 0;
          break;
        case "percentile":
          aValue = a.percentile ?? 0;
          bValue = b.percentile ?? 0;
          break;
      }

      if (aValue < bValue) return sortOrder === "asc" ? -1 : 1;
      if (aValue > bValue) return sortOrder === "asc" ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [scores, sortField, sortOrder, filterRound]);

  // ê³ ìœ í•œ íšŒì°¨ ëª©ë¡
  const examRounds = useMemo(() => {
    const rounds = new Set<string>();
    scores.forEach((score) => {
      if (score.exam_round) rounds.add(score.exam_round);
    });
    return Array.from(rounds).sort();
  }, [scores]);

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortOrder("desc");
    }
  };

  const SortIcon = ({ field }: { field: SortField }) => {
    if (sortField !== field) {
      return <span className="text-gray-400">â†•</span>;
    }
    return sortOrder === "asc" ? <span>â†‘</span> : <span>â†“</span>;
  };

  return (
    <div className="flex flex-col gap-4">
      {/* í•„í„° ë° ì •ë ¬ ì»¨íŠ¸ë¡¤ */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div className="flex flex-wrap items-center gap-2">
          <label className="text-sm font-medium text-gray-700">íšŒì°¨:</label>
          <select
            value={filterRound}
            onChange={(e) => setFilterRound(e.target.value)}
            className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="all">ì „ì²´</option>
            {examRounds.map((round) => (
              <option key={round} value={round}>
                {round}
              </option>
            ))}
          </select>
        </div>
        <div className="flex items-center gap-2 text-sm text-gray-600">
          <span>ì •ë ¬:</span>
          <button
            onClick={() => handleSort("grade")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "grade" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            í•™ë…„ <SortIcon field="grade" />
          </button>
          <button
            onClick={() => handleSort("exam_round")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "exam_round" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            íšŒì°¨ <SortIcon field="exam_round" />
          </button>
          <button
            onClick={() => handleSort("grade_score")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "grade_score" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            ë“±ê¸‰ <SortIcon field="grade_score" />
          </button>
          <button
            onClick={() => handleSort("percentile")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "percentile" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            ë°±ë¶„ìœ„ <SortIcon field="percentile" />
          </button>
        </div>
      </div>

      {/* ë°ìŠ¤í¬í†± í…Œì´ë¸” ë·° */}
      <Card className="hidden md:block">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                  ì„¸ë¶€ ê³¼ëª©ëª…
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                  íšŒì°¨
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                  <button
                    onClick={() => handleSort("raw_score")}
                    className="flex items-center gap-1 hover:text-gray-900"
                  >
                    ì›ì ìˆ˜ <SortIcon field="raw_score" />
                  </button>
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                  <button
                    onClick={() => handleSort("percentile")}
                    className="flex items-center gap-1 hover:text-gray-900"
                  >
                    ë°±ë¶„ìœ„ <SortIcon field="percentile" />
                  </button>
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                  <button
                    onClick={() => handleSort("grade_score")}
                    className="flex items-center gap-1 hover:text-gray-900"
                  >
                    ë“±ê¸‰ <SortIcon field="grade_score" />
                  </button>
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                  ì‘ì—…
                </th>
              </tr>
            </thead>
            <tbody className={divideDefault}>
              {filteredAndSortedScores.map((score) => {
                const gradeColor = getGradeColor(score.grade_score);
                return (
                  <tr key={score.id} className={tableRowBase}>
                    <td className={`px-4 py-3 text-sm ${textSecondary}`}>
                      {score.subject_name || "-"}
                    </td>
                    <td className={`px-4 py-3 text-sm ${textSecondary}`}>
                      {score.exam_round || "-"}
                    </td>
                    <td className={`px-4 py-3 text-sm ${textPrimary}`}>
                      {score.raw_score !== null ? score.raw_score : "-"}
                    </td>
                    <td className={`px-4 py-3 text-sm ${textPrimary}`}>
                      {score.percentile !== null ? `${score.percentile}%` : "-"}
                    </td>
                    <td className="px-4 py-3 text-sm">
                      {score.grade_score !== null ? (
                        <Badge
                          className={gradeColor.badge}
                          size="xs"
                        >
                          {score.grade_score}ë“±ê¸‰
                        </Badge>
                      ) : (
                        <span className="text-gray-400 dark:text-gray-500">-</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-sm">
                      <div className="flex items-center gap-2">
                        <Link
                          href={`/scores/mock/${grade}/${encodeURIComponent(subjectGroup)}/${encodeURIComponent(examType)}/${score.id}/edit`}
                          className={inlineButtonBase("px-3 py-1.5 text-xs font-semibold")}
                        >
                          ìˆ˜ì •
                        </Link>
                        <DeleteButton id={score.id} />
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </Card>

      {/* ëª¨ë°”ì¼ ì¹´ë“œ ë·° */}
      <div className="flex flex-col gap-3 md:hidden">
        {filteredAndSortedScores.map((score) => {
          const gradeColor = getGradeColor(score.grade_score);
          return (
            <Card key={score.id} hover>
              <div className="flex flex-col gap-3">
                <div className="flex items-start justify-between">
                  <div className="flex flex-col gap-1">
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-semibold text-gray-900">
                        {score.subject_name || "-"}
                      </span>
                      {score.exam_round && (
                        <span className="rounded-full bg-indigo-100 px-2 py-0.5 text-xs text-indigo-700">
                          {score.exam_round}
                        </span>
                      )}
                    </div>
                  </div>
                  {score.grade_score !== null && (
                    <Badge
                      className={gradeColor.badge}
                      size="sm"
                    >
                      {score.grade_score}ë“±ê¸‰
                    </Badge>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-3 border-t border-gray-100 pt-3">
                  <div>
                    <p className="text-xs text-gray-500">ì›ì ìˆ˜</p>
                    <p className="text-sm font-medium text-gray-900">
                      {score.raw_score !== null ? score.raw_score : "-"}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-500">ë°±ë¶„ìœ„</p>
                    <p className="text-sm font-medium text-indigo-600">
                      {score.percentile !== null ? `${score.percentile}%` : "-"}
                    </p>
                  </div>
                </div>

                <div className="flex gap-2 border-t border-gray-100 pt-3">
                  <Link
                    href={`/scores/mock/${grade}/${encodeURIComponent(subjectGroup)}/${encodeURIComponent(examType)}/${score.id}/edit`}
                    className="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-center text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
                  >
                    ìˆ˜ì •
                  </Link>
                  <div className="flex-1">
                    <DeleteButton id={score.id} />
                  </div>
                </div>
              </div>
            </Card>
          );
        })}
      </div>

      {filteredAndSortedScores.length === 0 && (
        <Card>
          <div className="p-8 text-center">
            <p className="text-sm text-gray-500">
              {filterRound !== "all"
                ? "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤."
                : "ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤."}
            </p>
          </div>
        </Card>
      )}
    </div>
  );
}

export const MockScoreListTable = memo(MockScoreListTableComponent, (prevProps, nextProps) => {
  // scores ë°°ì—´ì˜ ê¸¸ì´ì™€ ì£¼ìš” ì†ì„± ë¹„êµ
  if (prevProps.scores.length !== nextProps.scores.length) {
    return false;
  }
  
  // scores ë°°ì—´ì˜ ê° í•­ëª© ë¹„êµ (idì™€ ì£¼ìš” ì†ì„±ë§Œ)
  for (let i = 0; i < prevProps.scores.length; i++) {
    const prev = prevProps.scores[i];
    const next = nextProps.scores[i];
    if (
      prev.id !== next.id ||
      prev.grade !== next.grade ||
      prev.raw_score !== next.raw_score ||
      prev.grade_score !== next.grade_score ||
      prev.percentile !== next.percentile
    ) {
      return false;
    }
  }
  
  return (
    prevProps.grade === nextProps.grade &&
    prevProps.subjectGroup === nextProps.subjectGroup &&
    prevProps.examType === nextProps.examType &&
    prevProps.DeleteButton === nextProps.DeleteButton
  );
});
</file>

<file path="_components/ScoreCard.tsx">
"use client";

import { memo } from "react";
import { SchoolScore } from "@/lib/data/studentScores";
import { getGradeColor } from "@/lib/constants/colors";
import { BaseScoreCard } from "./BaseScoreCard";
import { cn } from "@/lib/cn";
import { textMuted, textPrimary, borderDefault } from "@/lib/utils/darkMode";

type ScoreCardProps = {
  score: SchoolScore;
  subjectGroupName?: string;
  subjectName?: string;
  subjectTypeName?: string;
  onEdit: (score: SchoolScore) => void;
  onDelete: (scoreId: string) => void;
};

function ScoreCardComponent({
  score,
  subjectGroupName,
  subjectName,
  subjectTypeName,
  onEdit,
  onDelete,
}: ScoreCardProps) {
  const gradeColor = getGradeColor(score.grade_score);

  // ë“±ê¸‰ ë°°ì§€
  const gradeBadge =
    score.grade_score !== null ? (
      <div
        className={cn(
          "flex h-7 w-7 items-center justify-center rounded-full text-sm font-bold shrink-0 shadow-sm",
          gradeColor.badge
        )}
      >
        {score.grade_score}
      </div>
    ) : null;

  // ê¸°ê°„ ë°°ì§€
  const periodBadge = (
    <span className="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-900/30 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-300 ring-1 ring-inset ring-blue-200 dark:ring-blue-800">
      {score.grade}í•™ë…„ {score.semester}í•™ê¸°
    </span>
  );

  // ì„±ì  ì •ë³´ í•„ë“œ
  const scoreFields = (
    <>
      <div className="flex flex-col gap-1">
        <span className={`text-xs font-medium ${textMuted}`}>ì›ì ìˆ˜</span>
        <span className={`text-base font-semibold ${textPrimary}`}>
          {score.raw_score != null ? score.raw_score.toLocaleString() : "-"}
        </span>
      </div>
      <div className="flex flex-col gap-1">
        <span className={`text-xs font-medium ${textMuted}`}>í•™ì ìˆ˜</span>
        <span className={`text-base font-semibold ${textPrimary}`}>
          {score.credit_hours !== null ? score.credit_hours : "-"}
        </span>
      </div>
      {score.subject_average !== null && (
        <div className="flex flex-col gap-1">
          <span className={`text-xs font-medium ${textMuted}`}>ê³¼ëª©í‰ê· </span>
          <span className={`text-base font-semibold ${textPrimary}`}>
            {score.subject_average}
          </span>
        </div>
      )}
      {score.class_rank !== null && (
        <div className="flex flex-col gap-1">
          <span className={`text-xs font-medium ${textMuted}`}>ë°˜ ì„ì°¨</span>
          <span className={`text-base font-semibold ${textPrimary}`}>
            {score.class_rank}ë“±
          </span>
        </div>
      )}
    </>
  );

  // ìƒì„¸ ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ìš©
  const detailDialogContent = (
    <>
      {/* ê¸°ë³¸ ì •ë³´ */}
      <div className="grid gap-4 sm:grid-cols-2">
        <div className="flex flex-col gap-1">
          <span className={`text-xs ${textMuted}`}>ê³¼ëª©ëª…</span>
          <p className={`text-sm font-medium ${textPrimary}`}>
            {subjectName || score.subject_name || "-"}
          </p>
        </div>
        <div className="flex flex-col gap-1">
          <span className={`text-xs ${textMuted}`}>êµê³¼</span>
          <p className={`text-sm font-medium ${textPrimary}`}>
            {subjectGroupName || score.subject_group || "-"}
          </p>
        </div>
        <div className="flex flex-col gap-1">
          <span className={`text-xs ${textMuted}`}>ê³¼ëª© ìœ í˜•</span>
          <p className={`text-sm font-medium ${textPrimary}`}>
            {subjectTypeName || score.subject_type || "-"}
          </p>
        </div>
        <div className="flex flex-col gap-1">
          <span className={`text-xs ${textMuted}`}>í•™ë…„/í•™ê¸°</span>
          <p className={`text-sm font-medium ${textPrimary}`}>
            {score.grade}í•™ë…„ {score.semester}í•™ê¸°
          </p>
        </div>
      </div>

      {/* ì„±ì  ì •ë³´ */}
      <div className={cn("flex flex-col gap-4 border-t pt-4", borderDefault)}>
        <h3 className={`text-sm font-semibold ${textPrimary}`}>ì„±ì  ì •ë³´</h3>
        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div className="flex flex-col gap-1">
            <span className={`text-xs ${textMuted}`}>ë“±ê¸‰</span>
            <div className="flex items-center gap-2">
              {score.grade_score !== null && (
                <div
                  className={cn(
                    "flex h-8 w-8 items-center justify-center rounded-full text-sm font-bold",
                    gradeColor.badge
                  )}
                >
                  {score.grade_score}
                </div>
              )}
              {score.grade_score === null && (
                <span className={`text-sm font-medium ${textPrimary}`}>-</span>
              )}
            </div>
          </div>
          <div className="flex flex-col gap-1">
            <span className={`text-xs ${textMuted}`}>ì›ì ìˆ˜</span>
            <p className={`text-sm font-medium ${textPrimary}`}>
              {score.raw_score != null ? score.raw_score : "-"}
            </p>
          </div>
          <div className="flex flex-col gap-1">
            <span className={`text-xs ${textMuted}`}>í•™ì ìˆ˜</span>
            <p className={`text-sm font-medium ${textPrimary}`}>
              {score.credit_hours !== null ? score.credit_hours : "-"}
            </p>
          </div>
          {score.subject_average !== null && (
            <div className="flex flex-col gap-1">
              <span className={`text-xs ${textMuted}`}>ê³¼ëª©í‰ê· </span>
              <p className={`text-sm font-medium ${textPrimary}`}>
                {score.subject_average}
              </p>
            </div>
          )}
          {score.standard_deviation !== null && (
            <div className="flex flex-col gap-1">
              <span className={`text-xs ${textMuted}`}>í‘œì¤€í¸ì°¨</span>
              <p className={`text-sm font-medium ${textPrimary}`}>
                {score.standard_deviation}
              </p>
            </div>
          )}
          {score.total_students !== null && (
            <div className="flex flex-col gap-1">
              <span className={`text-xs ${textMuted}`}>ìˆ˜ê°•ììˆ˜</span>
              <p className={`text-sm font-medium ${textPrimary}`}>
                {score.total_students}ëª…
              </p>
            </div>
          )}
          {score.rank_grade !== null && (
            <div className="flex flex-col gap-1">
              <span className={`text-xs ${textMuted}`}>ì„ì°¨ë“±ê¸‰</span>
              <p className={`text-sm font-medium ${textPrimary}`}>
                {score.rank_grade}ë“±ê¸‰
              </p>
            </div>
          )}
          {score.class_rank !== null && (
            <div className="flex flex-col gap-1">
              <span className={`text-xs ${textMuted}`}>ë°˜ ì„ì°¨</span>
              <p className={`text-sm font-medium ${textPrimary}`}>
                {score.class_rank}ë“±
              </p>
            </div>
          )}
        </div>
      </div>
    </>
  );

  return (
    <BaseScoreCard
      score={score}
      subjectGroupName={subjectGroupName}
      subjectName={subjectName || score.subject_name || undefined}
      subjectTypeName={subjectTypeName}
      gradeBadge={gradeBadge}
      periodBadge={periodBadge}
      scoreFields={scoreFields}
      detailDialogContent={detailDialogContent}
      onEdit={onEdit}
      onDelete={onDelete}
    />
  );
}

export const ScoreCard = memo(ScoreCardComponent);
</file>

<file path="_components/ScoreCardGrid.tsx">
"use client";

import { useMemo, useState, memo } from "react";
import { SchoolScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { ScoreCard } from "./ScoreCard";
import { EmptyState } from "@/components/molecules/EmptyState";
import { Plus, Filter, ArrowUpDown, FileText } from "lucide-react";
import { cn } from "@/lib/cn";
import { VirtualizedList } from "@/lib/components/VirtualizedList";

type ScoreCardGridProps = {
  initialGrade?: number;
  initialSemester?: number;
  scores: SchoolScore[];
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
  onAddClick?: () => void;
  onEdit: (score: SchoolScore) => void;
  onDelete: (scoreId: string) => void;
};

type SortField = "grade" | "semester" | "grade_score" | "raw_score" | "subject_name";
type SortOrder = "asc" | "desc";

function ScoreCardGridComponent({
  initialGrade,
  initialSemester,
  scores,
  subjectGroups,
  subjectTypes,
  onAddClick,
  onEdit,
  onDelete,
}: ScoreCardGridProps) {
  const [sortField, setSortField] = useState<SortField>("grade");
  const [sortOrder, setSortOrder] = useState<SortOrder>("asc");
  const [filterGrade, setFilterGrade] = useState<string>(initialGrade?.toString() || "all");
  const [filterSemester, setFilterSemester] = useState<string>(initialSemester?.toString() || "all");
  const [filterSubjectGroup, setFilterSubjectGroup] = useState<string>("all");
  const [filterSubject, setFilterSubject] = useState<string>("all");
  const [filterSubjectType, setFilterSubjectType] = useState<string>("all");
  const [showFilters, setShowFilters] = useState(false);

  // ì„±ì  ë°ì´í„°ì— ê³¼ëª© ì •ë³´ ë§¤í•‘
  const scoresWithInfo = useMemo(() => {
    return scores.map((score) => {
      const group = score.subject_group_id
        ? subjectGroups.find((g) => g.id === score.subject_group_id)
        : subjectGroups.find((g) => g.name === score.subject_group);
      const subject = score.subject_id
        ? group?.subjects.find((s) => s.id === score.subject_id)
        : group?.subjects.find((s) => s.name === score.subject_name);
      const subjectType = score.subject_type_id
        ? subjectTypes.find((st) => st.id === score.subject_type_id)
        : score.subject_type
          ? subjectTypes.find((st) => st.name === score.subject_type)
          : null;

      return {
        score,
        subjectGroupName: group?.name || score.subject_group || "",
        subjectName: subject?.name || score.subject_name || "",
        subjectTypeName: subjectType?.name || score.subject_type || "",
      };
    });
  }, [scores, subjectGroups, subjectTypes]);

  // í•„í„°ë§ ë° ì •ë ¬
  const filteredAndSortedScores = useMemo(() => {
    let filtered = [...scoresWithInfo];

    // í•™ë…„ í•„í„°ë§
    if (filterGrade !== "all") {
      filtered = filtered.filter(
        (item) => item.score.grade === parseInt(filterGrade)
      );
    }

    // í•™ê¸° í•„í„°ë§
    if (filterSemester !== "all") {
      filtered = filtered.filter(
        (item) => item.score.semester === parseInt(filterSemester)
      );
    }

    // êµê³¼ í•„í„°ë§
    if (filterSubjectGroup !== "all") {
      filtered = filtered.filter(
        (item) => item.subjectGroupName === filterSubjectGroup
      );
    }

    // ê³¼ëª© í•„í„°ë§
    if (filterSubject !== "all") {
      filtered = filtered.filter(
        (item) => item.subjectName === filterSubject
      );
    }

    // ê³¼ëª© ìœ í˜• í•„í„°ë§
    if (filterSubjectType !== "all") {
      filtered = filtered.filter((item) => item.subjectTypeName === filterSubjectType);
    }

    // ì •ë ¬
    filtered.sort((a, b) => {
      let aValue: number | string | null = null;
      let bValue: number | string | null = null;

      switch (sortField) {
        case "grade":
          aValue = a.score.grade ?? 0;
          bValue = b.score.grade ?? 0;
          break;
        case "semester":
          aValue = a.score.semester ?? 0;
          bValue = b.score.semester ?? 0;
          break;
        case "grade_score":
          aValue = a.score.grade_score ?? 999;
          bValue = b.score.grade_score ?? 999;
          break;
        case "raw_score":
          aValue = a.score.raw_score ?? 0;
          bValue = b.score.raw_score ?? 0;
          break;
        case "subject_name":
          aValue = a.subjectName;
          bValue = b.subjectName;
          break;
      }

      if (aValue < bValue) return sortOrder === "asc" ? -1 : 1;
      if (aValue > bValue) return sortOrder === "asc" ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [scoresWithInfo, sortField, sortOrder, filterGrade, filterSemester, filterSubjectGroup, filterSubject, filterSubjectType]);

  // ê³ ìœ í•œ êµê³¼ ë° ê³¼ëª© ìœ í˜• ëª©ë¡
  const availableSubjectGroups = useMemo(() => {
    const groups = new Set<string>();
    scoresWithInfo.forEach((item) => {
      if (item.subjectGroupName) groups.add(item.subjectGroupName);
    });
    return Array.from(groups).sort();
  }, [scoresWithInfo]);

  const availableSubjectTypes = useMemo(() => {
    const types = new Set<string>();
    scoresWithInfo.forEach((item) => {
      if (item.subjectTypeName) types.add(item.subjectTypeName);
    });
    return Array.from(types).sort();
  }, [scoresWithInfo]);

  const availableSubjects = useMemo(() => {
    const subjects = new Set<string>();
    scoresWithInfo.forEach((item) => {
      if (item.subjectName) subjects.add(item.subjectName);
    });
    return Array.from(subjects).sort();
  }, [scoresWithInfo]);

  const availableGrades = useMemo(() => {
    const grades = new Set<number>();
    scoresWithInfo.forEach((item) => {
      if (item.score.grade) grades.add(item.score.grade);
    });
    return Array.from(grades).sort();
  }, [scoresWithInfo]);

  const availableSemesters = useMemo(() => {
    const semesters = new Set<number>();
    scoresWithInfo.forEach((item) => {
      if (item.score.semester) semesters.add(item.score.semester);
    });
    return Array.from(semesters).sort();
  }, [scoresWithInfo]);

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortOrder("desc");
    }
  };

  if (scores.length === 0) {
    return (
      <EmptyState
        icon={<FileText className="h-8 w-8 text-gray-400" />}
        title="ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤."
        description="ì„±ì ì„ ì¶”ê°€í•˜ì—¬ í•™ìŠµ ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•˜ì„¸ìš”."
        actionLabel="ì„±ì  ì¶”ê°€í•˜ê¸°"
        onAction={onAddClick}
      />
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {/* í•„í„° ë° ì •ë ¬ ë°” */}
      <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className={cn(
                "inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition",
                showFilters
                  ? "border-indigo-500 bg-indigo-50 text-indigo-700"
                  : "border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
              )}
            >
              <Filter className="h-4 w-4" />
              í•„í„°
            </button>
            {onAddClick && (
              <button
                onClick={onAddClick}
                className="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                <Plus className="h-4 w-4" />
                ì„±ì  ì¶”ê°€
              </button>
            )}
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">
              ì´ {filteredAndSortedScores.length}ê°œ
            </span>
          </div>
        </div>

        {/* í•„í„° íŒ¨ë„ */}
        {showFilters && (
          <div className="grid gap-4 border-t border-gray-200 pt-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5">
            {/* í•™ë…„ í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                í•™ë…„
              </label>
              <select
                value={filterGrade}
                onChange={(e) => setFilterGrade(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableGrades.map((grade) => (
                  <option key={grade} value={grade.toString()}>
                    {grade}í•™ë…„
                  </option>
                ))}
              </select>
            </div>

            {/* í•™ê¸° í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                í•™ê¸°
              </label>
              <select
                value={filterSemester}
                onChange={(e) => setFilterSemester(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSemesters.map((semester) => (
                  <option key={semester} value={semester.toString()}>
                    {semester}í•™ê¸°
                  </option>
                ))}
              </select>
            </div>

            {/* êµê³¼ í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                êµê³¼
              </label>
              <select
                value={filterSubjectGroup}
                onChange={(e) => {
                  setFilterSubjectGroup(e.target.value);
                  setFilterSubject("all"); // êµê³¼ ë³€ê²½ ì‹œ ê³¼ëª© í•„í„° ì´ˆê¸°í™”
                }}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSubjectGroups.map((group) => (
                  <option key={group} value={group}>
                    {group}
                  </option>
                ))}
              </select>
            </div>

            {/* ê³¼ëª© í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ê³¼ëª©
              </label>
              <select
                value={filterSubject}
                onChange={(e) => setFilterSubject(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSubjects.map((subject) => (
                  <option key={subject} value={subject}>
                    {subject}
                  </option>
                ))}
              </select>
            </div>

            {/* ê³¼ëª© ìœ í˜• í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ê³¼ëª© ìœ í˜•
              </label>
              <select
                value={filterSubjectType}
                onChange={(e) => setFilterSubjectType(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSubjectTypes.map((type) => (
                  <option key={type} value={type}>
                    {type}
                  </option>
                ))}
              </select>
            </div>

            {/* ì •ë ¬ ìˆœì„œ */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ì •ë ¬ ìˆœì„œ
              </label>
              <button
                onClick={() => setSortOrder(sortOrder === "asc" ? "desc" : "asc")}
                className="flex w-full items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm transition hover:bg-gray-50"
              >
                <ArrowUpDown className="h-4 w-4" />
                {sortOrder === "asc" ? "ì˜¤ë¦„ì°¨ìˆœ" : "ë‚´ë¦¼ì°¨ìˆœ"}
              </button>
            </div>
          </div>
        )}
      </div>

      {/* í•„í„° ì ìš© ì¤‘ì¼ ë•Œ ê²°ê³¼ê°€ ì—†ì„ ê²½ìš° */}
      {(filterGrade !== "all" || filterSemester !== "all" || filterSubjectGroup !== "all" || filterSubject !== "all" || filterSubjectType !== "all") &&
        filteredAndSortedScores.length === 0 && (
          <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-8 text-center">
            <p className="text-sm text-gray-500">
              ì„ íƒí•œ í•„í„° ì¡°ê±´ì— ë§ëŠ” ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <button
              onClick={() => {
                setFilterGrade("all");
                setFilterSemester("all");
                setFilterSubjectGroup("all");
                setFilterSubject("all");
                setFilterSubjectType("all");
              }}
              className="text-sm font-medium text-indigo-600 hover:text-indigo-700"
            >
              í•„í„° ì´ˆê¸°í™”
            </button>
          </div>
        )}

      {/* ì¹´ë“œ ê·¸ë¦¬ë“œ - 20ê°œ ì´ìƒì¼ ë•Œ ê°€ìƒí™” ì ìš© */}
      {filteredAndSortedScores.length > 0 && (
        filteredAndSortedScores.length > 20 ? (
          <VirtualizedList
            items={filteredAndSortedScores}
            itemHeight={180} // ScoreCardì˜ ì˜ˆìƒ ë†’ì´
            containerHeight={600} // ì»¨í…Œì´ë„ˆ ë†’ì´
            renderItem={(item, index) => (
              <div className="p-2">
                <ScoreCard
                  key={item.score.id}
                  score={item.score}
                  subjectGroupName={item.subjectGroupName}
                  subjectName={item.subjectName}
                  subjectTypeName={item.subjectTypeName}
                  onEdit={onEdit}
                  onDelete={onDelete}
                />
              </div>
            )}
            className="rounded-xl border border-gray-200 bg-white p-4"
            overscan={3}
          />
        ) : (
          <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
            {filteredAndSortedScores.map((item) => (
              <ScoreCard
                key={item.score.id}
                score={item.score}
                subjectGroupName={item.subjectGroupName}
                subjectName={item.subjectName}
                subjectTypeName={item.subjectTypeName}
                onEdit={onEdit}
                onDelete={onDelete}
              />
            ))}
          </div>
        )
      )}
    </div>
  );
}

export const ScoreCardGrid = memo(ScoreCardGridComponent, (prevProps, nextProps) => {
  // scores ë°°ì—´ì˜ ê¸¸ì´ì™€ ì£¼ìš” ì†ì„± ë¹„êµ
  if (prevProps.scores.length !== nextProps.scores.length) {
    return false;
  }
  
  // scores ë°°ì—´ì˜ ê° í•­ëª© ë¹„êµ (idì™€ ì£¼ìš” ì†ì„±ë§Œ)
  for (let i = 0; i < prevProps.scores.length; i++) {
    const prev = prevProps.scores[i];
    const next = nextProps.scores[i];
    if (
      prev.id !== next.id ||
      prev.grade !== next.grade ||
      prev.semester !== next.semester ||
      prev.raw_score !== next.raw_score ||
      prev.grade_score !== next.grade_score
    ) {
      return false;
    }
  }
  
  return (
    prevProps.initialGrade === nextProps.initialGrade &&
    prevProps.initialSemester === nextProps.initialSemester &&
    prevProps.subjectGroups.length === nextProps.subjectGroups.length &&
    prevProps.subjectTypes.length === nextProps.subjectTypes.length
  );
});
</file>

<file path="_components/ScoreFilterBar.tsx">
"use client";

import Link from "next/link";

type ScoreFilterBarProps = {
  courseFilter?: string;
  semesterFilter?: string;
  searchQuery?: string;
  courseList: string[];
  semesterList: string[];
};

export function ScoreFilterBar({
  courseFilter,
  semesterFilter,
  searchQuery,
  courseList,
  semesterList,
}: ScoreFilterBarProps) {
  return (
    <form action="/scores" method="get" className="flex flex-wrap items-end gap-4">
      <div className="flex min-w-[200px] flex-1 flex-col gap-2">
        <label className="block text-sm font-medium text-gray-700">
          êµê³¼ í•„í„°
        </label>
        <select
          name="course"
          defaultValue={courseFilter ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
          onChange={(e) => {
            const form = e.currentTarget.form;
            if (form) {
              const semesterSelect = form.querySelector(
                'select[name="semester"]'
              ) as HTMLSelectElement;
              const searchInput = form.querySelector(
                'input[name="search"]'
              ) as HTMLInputElement;
              if (semesterSelect) {
                const hiddenSemester = document.createElement("input");
                hiddenSemester.type = "hidden";
                hiddenSemester.name = "semester";
                hiddenSemester.value = semesterSelect.value || "";
                form.appendChild(hiddenSemester);
              }
              if (searchInput) {
                const hiddenSearch = document.createElement("input");
                hiddenSearch.type = "hidden";
                hiddenSearch.name = "search";
                hiddenSearch.value = searchInput.value || "";
                form.appendChild(hiddenSearch);
              }
              form.submit();
            }
          }}
        >
          <option value="">ì „ì²´</option>
          {courseList.map((course) => (
            <option key={course} value={course}>
              {course}
            </option>
          ))}
        </select>
      </div>

      <div className="flex min-w-[200px] flex-1 flex-col gap-2">
        <label className="block text-sm font-medium text-gray-700">
          í•™ê¸° í•„í„°
        </label>
        <select
          name="semester"
          defaultValue={semesterFilter ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
          onChange={(e) => {
            const form = e.currentTarget.form;
            if (form) {
              const courseSelect = form.querySelector(
                'select[name="course"]'
              ) as HTMLSelectElement;
              const searchInput = form.querySelector(
                'input[name="search"]'
              ) as HTMLInputElement;
              if (courseSelect) {
                const hiddenCourse = document.createElement("input");
                hiddenCourse.type = "hidden";
                hiddenCourse.name = "course";
                hiddenCourse.value = courseSelect.value || "";
                form.appendChild(hiddenCourse);
              }
              if (searchInput) {
                const hiddenSearch = document.createElement("input");
                hiddenSearch.type = "hidden";
                hiddenSearch.name = "search";
                hiddenSearch.value = searchInput.value || "";
                form.appendChild(hiddenSearch);
              }
              form.submit();
            }
          }}
        >
          <option value="">ì „ì²´</option>
          {semesterList.map((semester) => (
            <option key={semester} value={semester}>
              {semester}
            </option>
          ))}
        </select>
      </div>

      <div className="flex min-w-[200px] flex-1 flex-col gap-2">
        <label className="block text-sm font-medium text-gray-700">
          ê²€ìƒ‰ (ê³¼ëª©ëª…)
        </label>
        <input
          type="text"
          name="search"
          defaultValue={searchQuery ?? ""}
          placeholder="ê³¼ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰"
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
          onKeyDown={(e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              const form = e.currentTarget.form;
              if (form) {
                const courseSelect = form.querySelector(
                  'select[name="course"]'
                ) as HTMLSelectElement;
                const semesterSelect = form.querySelector(
                  'select[name="semester"]'
                ) as HTMLSelectElement;
                if (courseSelect) {
                  const hiddenCourse = document.createElement("input");
                  hiddenCourse.type = "hidden";
                  hiddenCourse.name = "course";
                  hiddenCourse.value = courseSelect.value || "";
                  form.appendChild(hiddenCourse);
                }
                if (semesterSelect) {
                  const hiddenSemester = document.createElement("input");
                  hiddenSemester.type = "hidden";
                  hiddenSemester.name = "semester";
                  hiddenSemester.value = semesterSelect.value || "";
                  form.appendChild(hiddenSemester);
                }
                form.submit();
              }
            }
          }}
        />
      </div>

      {(courseFilter || semesterFilter || searchQuery) && (
        <Link
          href="/scores"
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          í•„í„° ì´ˆê¸°í™”
        </Link>
      )}
    </form>
  );
}
</file>

<file path="_components/ScoreForm.tsx">
"use client";

import { useActionState } from "react";
import { useFormStatus } from "react-dom";

type FormState = {
  error?: string;
  success?: boolean;
};

type ScoreFormProps = {
  action: (formData: FormData) => Promise<void>;
  initialData?: {
    subject_type: string;
    semester: string;
    course: string;
    course_detail: string;
    raw_score: string;
    grade: string;
    score_type_detail: string;
    test_date: string;
  };
};

function SubmitButton() {
  const { pending } = useFormStatus();

  return (
    <button
      type="submit"
      disabled={pending}
      className="w-full rounded-lg bg-indigo-600 px-4 py-3 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {pending ? "ì €ì¥ ì¤‘..." : "ì €ì¥í•˜ê¸°"}
    </button>
  );
}

export function ScoreForm({ action, initialData }: ScoreFormProps) {
  const [state, formAction] = useActionState<FormState, FormData>(
    async (prevState: FormState, formData: FormData) => {
      try {
        await action(formData);
        return { success: true };
      } catch (error) {
        return {
          error: error instanceof Error ? error.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
        };
      }
    },
    {}
  );

  return (
    <form action={formAction} className="flex flex-col gap-6">
      {/* ê³¼ëª© ìœ í˜• */}
      <div className="flex flex-col gap-2">
        <label
          htmlFor="subject_type"
          className="block text-sm font-medium text-gray-700"
        >
          ê³¼ëª© ìœ í˜• <span className="text-red-500">*</span>
        </label>
        <select
          id="subject_type"
          name="subject_type"
          required
          defaultValue={initialData?.subject_type ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        >
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì¼ë°˜ì„ íƒ">ì¼ë°˜ì„ íƒ</option>
          <option value="ì§„ë¡œì„ íƒ">ì§„ë¡œì„ íƒ</option>
          <option value="ê³µí†µê³¼ëª©">ê³µí†µê³¼ëª©</option>
        </select>
      </div>

      {/* í•™ê¸° */}
      <div className="flex flex-col gap-1">
        <label
          htmlFor="semester"
          className="block text-sm font-medium text-gray-700"
        >
          í•™ê¸° <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="semester"
          name="semester"
          required
          placeholder="ì˜ˆ: 1-1, 1-2, 2-1, 2-2"
          defaultValue={initialData?.semester ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        />
        <p className="text-xs text-gray-500">
          í˜•ì‹: í•™ë…„-í•™ê¸° (ì˜ˆ: 1-1, 2-2)
        </p>
      </div>

      {/* êµê³¼ */}
      <div className="flex flex-col gap-2">
        <label
          htmlFor="course"
          className="block text-sm font-medium text-gray-700"
        >
          êµê³¼ <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="course"
          name="course"
          required
          placeholder="ì˜ˆ: êµ­ì–´, ìˆ˜í•™, ì˜ì–´"
          defaultValue={initialData?.course ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        />
      </div>

      {/* ì„¸ë¶€ ê³¼ëª©ëª… */}
      <div className="flex flex-col gap-2">
        <label
          htmlFor="course_detail"
          className="block text-sm font-medium text-gray-700"
        >
          ì„¸ë¶€ ê³¼ëª©ëª… <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="course_detail"
          name="course_detail"
          required
          placeholder="ì˜ˆ: ë¬¸í•™, ë¯¸ì ë¶„, ì˜ì–´ë…í•´"
          defaultValue={initialData?.course_detail ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        />
      </div>

      {/* ì›ì ìˆ˜ */}
      <div className="flex flex-col gap-2">
        <label
          htmlFor="raw_score"
          className="block text-sm font-medium text-gray-700"
        >
          ì›ì ìˆ˜ <span className="text-red-500">*</span>
        </label>
        <input
          type="number"
          id="raw_score"
          name="raw_score"
          required
          min="0"
          step="0.1"
          placeholder="ì˜ˆ: 95.5"
          defaultValue={initialData?.raw_score ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        />
      </div>

      {/* ë“±ê¸‰ */}
      <div className="flex flex-col gap-1">
        <label
          htmlFor="grade"
          className="block text-sm font-medium text-gray-700"
        >
          ë“±ê¸‰ <span className="text-red-500">*</span>
        </label>
        <input
          type="number"
          id="grade"
          name="grade"
          required
          min="1"
          max="9"
          placeholder="1~9"
          defaultValue={initialData?.grade ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        />
        <p className="text-xs text-gray-500">1ë“±ê¸‰ì´ ê°€ì¥ ë†’ê³ , 9ë“±ê¸‰ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.</p>
      </div>

      {/* í‰ê°€ ìœ í˜• */}
      <div className="flex flex-col gap-2">
        <label
          htmlFor="score_type_detail"
          className="block text-sm font-medium text-gray-700"
        >
          í‰ê°€ ìœ í˜• <span className="text-red-500">*</span>
        </label>
        <select
          id="score_type_detail"
          name="score_type_detail"
          required
          defaultValue={initialData?.score_type_detail ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        >
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ë‚´ì‹ ">ë‚´ì‹ </option>
          <option value="í‰ê°€ì›">í‰ê°€ì›</option>
          <option value="êµìœ¡ì²­">êµìœ¡ì²­</option>
          <option value="ì‚¬ì„¤">ì‚¬ì„¤</option>
        </select>
      </div>

      {/* ì‹œí—˜ì¼ */}
      <div className="flex flex-col gap-2">
        <label
          htmlFor="test_date"
          className="block text-sm font-medium text-gray-700"
        >
          ì‹œí—˜ì¼ <span className="text-red-500">*</span>
        </label>
        <input
          type="date"
          id="test_date"
          name="test_date"
          required
          defaultValue={initialData?.test_date ?? ""}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-600 focus:outline-none focus:ring-1 focus:ring-indigo-600"
        />
      </div>

      {state.error && (
        <div className="rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700">
          {state.error}
        </div>
      )}

      {state.success && (
        <div className="rounded-lg border border-green-200 bg-green-50 p-3 text-sm text-green-700">
          ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>
      )}

      <SubmitButton />
    </form>
  );
}
</file>

<file path="_components/ScoreFormModal.tsx">
"use client";

import { useTransition, useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";
import { SchoolScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { addSchoolScore, updateSchoolScoreAction } from "@/app/(student)/actions/scoreActions";
import { useToast } from "@/components/ui/ToastProvider";

type ScoreFormModalProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  initialGrade?: number;
  initialSemester?: number;
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
  editingScore?: SchoolScore | null;
  onSuccess?: () => void;
};

type FormErrors = {
  grade?: string;
  semester?: string;
  subject_type_id?: string;
  subject_id?: string;
  credit_hours?: string;
  raw_score?: string;
  subject_average?: string;
  standard_deviation?: string;
  grade_score?: string;
  total_students?: string;
  rank_grade?: string;
  class_rank?: string;
};

export function ScoreFormModal({
  open,
  onOpenChange,
  initialGrade,
  initialSemester,
  subjectGroups,
  subjectTypes,
  editingScore,
  onSuccess,
}: ScoreFormModalProps) {
  const router = useRouter();
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  const [errors, setErrors] = useState<FormErrors>({});
  const [touched, setTouched] = useState<Record<string, boolean>>({});

  // í¼ ìƒíƒœ
  const [formData, setFormData] = useState({
    grade: initialGrade?.toString() || "",
    semester: initialSemester?.toString() || "",
    subject_type_id: "",
    subject_group_id: "",
    subject_id: "",
    credit_hours: "",
    raw_score: "",
    subject_average: "",
    standard_deviation: "",
    grade_score: "",
    total_students: "",
    rank_grade: "",
    class_rank: "",
  });

  // í¸ì§‘ ëª¨ë“œì¼ ë•Œ ì´ˆê¸°ê°’ ì„¤ì •
  useEffect(() => {
    if (editingScore && open) {
      setFormData({
        grade: editingScore.grade?.toString() || initialGrade?.toString() || "",
        semester: editingScore.semester?.toString() || initialSemester?.toString() || "",
        subject_type_id: editingScore.subject_type_id || "",
        subject_group_id: editingScore.subject_group_id || "",
        subject_id: editingScore.subject_id || "",
        credit_hours: editingScore.credit_hours?.toString() || "",
        raw_score: editingScore.raw_score?.toString() || "",
        subject_average: editingScore.subject_average?.toString() || "",
        standard_deviation: editingScore.standard_deviation?.toString() || "",
        grade_score: editingScore.grade_score?.toString() || "",
        total_students: editingScore.total_students?.toString() || "",
        rank_grade: editingScore.rank_grade?.toString() || "",
        class_rank: editingScore.class_rank?.toString() || "",
      });
    } else if (!editingScore && open) {
      // ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš° ì´ˆê¸°í™”
      setFormData({
        grade: initialGrade?.toString() || "",
        semester: initialSemester?.toString() || "",
        subject_type_id: "",
        subject_group_id: "",
        subject_id: "",
        credit_hours: "",
        raw_score: "",
        subject_average: "",
        standard_deviation: "",
        grade_score: "",
        total_students: "",
        rank_grade: "",
        class_rank: "",
      });
    }
    // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì—ëŸ¬ ìƒíƒœ ì´ˆê¸°í™”
    if (!open) {
      setError(null);
      setErrors({});
      setTouched({});
    }
  }, [editingScore, open, initialGrade, initialSemester]);

  const validateField = (name: string, value: string | number | null): string | undefined => {
    switch (name) {
      case "grade":
        if (!value || value === "") {
          return "í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        const gradeNum = Number(value);
        if (isNaN(gradeNum) || gradeNum < 1 || gradeNum > 3) {
          return "í•™ë…„ì€ 1~3 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "semester":
        if (!value || value === "") {
          return "í•™ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        const semesterNum = Number(value);
        if (isNaN(semesterNum) || semesterNum < 1 || semesterNum > 2) {
          return "í•™ê¸°ëŠ” 1~2 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "subject_type_id":
        if (!value || value === "") {
          return "ê³¼ëª© ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        break;
      case "subject_id":
        if (!value || value === "") {
          return "ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        break;
      case "credit_hours":
        if (!value || value === "") {
          return "í•™ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const creditNum = Number(value);
        if (isNaN(creditNum) || creditNum <= 0) {
          return "í•™ì ìˆ˜ëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "raw_score":
        if (!value || value === "") {
          return "ì›ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const rawNum = Number(value);
        if (isNaN(rawNum) || rawNum < 0) {
          return "ì›ì ìˆ˜ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "grade_score":
        if (!value || value === "") {
          return "ì„±ì·¨ë„ ë“±ê¸‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const gradeScoreNum = Number(value);
        if (isNaN(gradeScoreNum) || gradeScoreNum < 1 || gradeScoreNum > 9) {
          return "ë“±ê¸‰ì€ 1~9 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
    }
    return undefined;
  };

  const handleBlur = (e: React.FocusEvent<HTMLInputElement | HTMLSelectElement> | React.FocusEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setTouched((prev) => ({ ...prev, [name]: true }));
    const error = validateField(name, value);
    setErrors((prev) => ({ ...prev, [name]: error }));
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));

    // êµê³¼ ì„ íƒ ì‹œ ê³¼ëª© ì´ˆê¸°í™” ë° ì²« ë²ˆì§¸ ê³¼ëª© ìë™ ì„ íƒ
    if (name === "subject_group_id") {
      const group = subjectGroups.find((g) => g.id === value);
      const firstSubject = group?.subjects[0];
      setFormData((prev) => ({
        ...prev,
        subject_group_id: value,
        subject_id: firstSubject?.id || "",
        subject_type_id: firstSubject?.subject_type_id || prev.subject_type_id,
      }));
    }

    // ê³¼ëª© ì„ íƒ ì‹œ ê³¼ëª©êµ¬ë¶„ ìë™ ì„¤ì •
    if (name === "subject_id") {
      const group = subjectGroups.find((g) => g.subjects.some((s) => s.id === value));
      const subject = group?.subjects.find((s) => s.id === value);
      setFormData((prev) => ({
        ...prev,
        subject_id: value,
        subject_type_id: subject?.subject_type_id || prev.subject_type_id,
      }));
    }

    if (touched[name]) {
      const error = validateField(name, value);
      setErrors((prev) => ({ ...prev, [name]: error }));
    }
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError(null);
    setErrors({});

    const formErrors: FormErrors = {};

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const requiredFields = [
      "grade",
      "semester",
      "subject_type_id",
      "subject_group_id",
      "subject_id",
      "credit_hours",
      "raw_score",
      "grade_score",
    ];
    requiredFields.forEach((field) => {
      const value = formData[field as keyof typeof formData];
      const error = validateField(field, value);
      if (error) {
        formErrors[field as keyof FormErrors] = error;
        setTouched((prev) => ({ ...prev, [field]: true }));
      }
    });

    if (Object.keys(formErrors).length > 0) {
      setErrors(formErrors);
      return;
    }

    startTransition(async () => {
      try {
        const group = subjectGroups.find((g) => g.id === formData.subject_group_id);
        const subject = group?.subjects.find((s) => s.id === formData.subject_id);
        const subjectType = subjectTypes.find((st) => st.id === formData.subject_type_id);

        if (!group || !subject) {
          throw new Error("êµê³¼ ë˜ëŠ” ê³¼ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const submitFormData = new FormData();
        submitFormData.append("grade", formData.grade);
        submitFormData.append("semester", formData.semester);
        submitFormData.append("subject_group_id", group.id);
        submitFormData.append("subject_id", subject.id);
        if (formData.subject_type_id) {
          submitFormData.append("subject_type_id", formData.subject_type_id);
        }
        // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ í…ìŠ¤íŠ¸ í•„ë“œë„ í•¨ê»˜ ì „ë‹¬
        submitFormData.append("subject_group", group.name);
        if (subjectType) submitFormData.append("subject_type", subjectType.name);
        submitFormData.append("subject_name", subject.name);
        submitFormData.append("credit_hours", formData.credit_hours);
        submitFormData.append("raw_score", formData.raw_score);
        if (formData.subject_average)
          submitFormData.append("subject_average", formData.subject_average);
        if (formData.standard_deviation)
          submitFormData.append("standard_deviation", formData.standard_deviation);
        submitFormData.append("grade_score", formData.grade_score);
        if (formData.total_students)
          submitFormData.append("total_students", formData.total_students);
        if (formData.rank_grade) submitFormData.append("rank_grade", formData.rank_grade);
        if (formData.class_rank)         submitFormData.append("class_rank", formData.class_rank);
        // ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ë•ŒëŠ” redirect ë°©ì§€
        submitFormData.append("skipRedirect", "true");

        if (editingScore) {
          await updateSchoolScoreAction(editingScore.id, submitFormData);
          showSuccess("ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          await addSchoolScore(submitFormData);
          showSuccess("ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        onOpenChange(false);
        router.refresh();
        onSuccess?.();
      } catch (err) {
        const errorMessage = err instanceof Error ? err.message : "ì„±ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        setError(errorMessage);
        showError(errorMessage);
      }
    });
  };

  const getSubjectsByGroupId = (groupId: string): Subject[] => {
    if (!groupId) return [];
    const group = subjectGroups.find((g) => g.id === groupId);
    return group?.subjects || [];
  };

  const formatDate = (dateString: string | null | undefined) => {
    if (!dateString) return "";
    try {
      return new Date(dateString).toISOString().split("T")[0];
    } catch {
      return "";
    }
  };

  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title={editingScore ? "ì„±ì  ìˆ˜ì •" : "ì„±ì  ì¶”ê°€"}
      description={`ë‚´ì‹  ì„±ì ì„ ${editingScore ? "ìˆ˜ì •" : "ì¶”ê°€"}í•©ë‹ˆë‹¤.`}
      maxWidth="2xl"
    >
      <form onSubmit={handleSubmit} className="flex flex-col gap-6">
        {error && (
          <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {error}
          </div>
        )}

        <div className="grid gap-6 sm:grid-cols-2">
          {/* í•™ë…„ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="grade"
              className="block text-sm font-medium text-gray-700"
            >
              í•™ë…„ <span className="text-red-500">*</span>
            </label>
            <select
              id="grade"
              name="grade"
              value={formData.grade}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.grade
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="1">1í•™ë…„</option>
              <option value="2">2í•™ë…„</option>
              <option value="3">3í•™ë…„</option>
            </select>
            {errors.grade && touched.grade && (
              <p className="text-xs text-red-600">{errors.grade}</p>
            )}
          </div>

          {/* í•™ê¸° */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="semester"
              className="block text-sm font-medium text-gray-700"
            >
              í•™ê¸° <span className="text-red-500">*</span>
            </label>
            <select
              id="semester"
              name="semester"
              value={formData.semester}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.semester
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="1">1í•™ê¸°</option>
              <option value="2">2í•™ê¸°</option>
            </select>
            {errors.semester && touched.semester && (
              <p className="text-xs text-red-600">{errors.semester}</p>
            )}
          </div>

          {/* êµê³¼ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_group_id"
              className="block text-sm font-medium text-gray-700"
            >
              êµê³¼ <span className="text-red-500">*</span>
            </label>
            <select
              id="subject_group_id"
              name="subject_group_id"
              value={formData.subject_group_id}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.subject_id && !formData.subject_group_id
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {subjectGroups.map((group) => (
                <option key={group.id} value={group.id}>
                  {group.name}
                </option>
              ))}
            </select>
          </div>

          {/* ê³¼ëª© */}
          <div className="flex flex-col gap-2">
            <label htmlFor="subject_id" className="block text-sm font-medium text-gray-700">
              ê³¼ëª© <span className="text-red-500">*</span>
            </label>
            <select
              id="subject_id"
              name="subject_id"
              value={formData.subject_id}
              onBlur={handleBlur}
              onChange={handleChange}
              disabled={!formData.subject_group_id}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                errors.subject_id
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {getSubjectsByGroupId(formData.subject_group_id).map((subject) => (
                <option key={subject.id} value={subject.id}>
                  {subject.name}
                </option>
              ))}
            </select>
            {errors.subject_id && touched.subject_id && (
              <p className="text-xs text-red-600">{errors.subject_id}</p>
            )}
          </div>

          {/* ê³¼ëª© ìœ í˜• */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_type_id"
              className="block text-sm font-medium text-gray-700"
            >
              ê³¼ëª© ìœ í˜• <span className="text-red-500">*</span>
            </label>
            <select
              id="subject_type_id"
              name="subject_type_id"
              value={formData.subject_type_id}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.subject_type_id
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {subjectTypes.map((subjectType) => (
                <option key={subjectType.id} value={subjectType.id}>
                  {subjectType.name}
                </option>
              ))}
            </select>
            {errors.subject_type_id && touched.subject_type_id && (
              <p className="text-xs text-red-600">{errors.subject_type_id}</p>
            )}
          </div>

          {/* í•™ì ìˆ˜ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="credit_hours" className="block text-sm font-medium text-gray-700">
              í•™ì ìˆ˜ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="credit_hours"
              name="credit_hours"
              step="0.5"
              min="0.5"
              value={formData.credit_hours}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 4"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.credit_hours
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.credit_hours && touched.credit_hours && (
              <p className="text-xs text-red-600">{errors.credit_hours}</p>
            )}
          </div>

          {/* ì›ì ìˆ˜ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="raw_score" className="block text-sm font-medium text-gray-700">
              ì›ì ìˆ˜ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="raw_score"
              name="raw_score"
              step="0.1"
              min="0"
              value={formData.raw_score}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 85.5"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.raw_score
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.raw_score && touched.raw_score && (
              <p className="text-xs text-red-600">{errors.raw_score}</p>
            )}
          </div>

          {/* ì„±ì·¨ë„ ë“±ê¸‰ */}
          <div className="flex flex-col gap-1">
            <label htmlFor="grade_score" className="block text-sm font-medium text-gray-700">
              ì„±ì·¨ë„ ë“±ê¸‰ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="grade_score"
              name="grade_score"
              min="1"
              max="9"
              value={formData.grade_score}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="1~9"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.grade_score
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.grade_score && touched.grade_score && (
              <p className="text-xs text-red-600">{errors.grade_score}</p>
            )}
            <p className="text-xs text-gray-500">1ë“±ê¸‰ì´ ê°€ì¥ ë†’ê³ , 9ë“±ê¸‰ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.</p>
          </div>

          {/* ê³¼ëª©í‰ê·  */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_average"
              className="block text-sm font-medium text-gray-700"
            >
              ê³¼ëª©í‰ê· 
            </label>
            <input
              type="number"
              id="subject_average"
              name="subject_average"
              step="0.1"
              value={formData.subject_average}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 78.5"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          {/* í‘œì¤€í¸ì°¨ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="standard_deviation"
              className="block text-sm font-medium text-gray-700"
            >
              í‘œì¤€í¸ì°¨
            </label>
            <input
              type="number"
              id="standard_deviation"
              name="standard_deviation"
              step="0.1"
              min="0"
              value={formData.standard_deviation}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 12.5"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          {/* ìˆ˜ê°•ììˆ˜ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="total_students"
              className="block text-sm font-medium text-gray-700"
            >
              ìˆ˜ê°•ììˆ˜
            </label>
            <input
              type="number"
              id="total_students"
              name="total_students"
              min="1"
              value={formData.total_students}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 120"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          {/* ì„ì°¨ë“±ê¸‰ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="rank_grade" className="block text-sm font-medium text-gray-700">
              ì„ì°¨ë“±ê¸‰
            </label>
            <input
              type="number"
              id="rank_grade"
              name="rank_grade"
              min="1"
              max="9"
              value={formData.rank_grade}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="1~9"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          {/* ë°˜ ì„ì°¨ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="class_rank" className="block text-sm font-medium text-gray-700">
              ë°˜ ì„ì°¨
            </label>
            <input
              type="number"
              id="class_rank"
              name="class_rank"
              min="1"
              value={formData.class_rank}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 5"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

        </div>

        <DialogFooter>
          <button
            type="button"
            onClick={() => onOpenChange(false)}
            disabled={isPending}
            className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            ì·¨ì†Œ
          </button>
          <button
            type="submit"
            disabled={isPending}
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isPending ? (editingScore ? "ìˆ˜ì • ì¤‘..." : "ë“±ë¡ ì¤‘...") : editingScore ? "ìˆ˜ì •í•˜ê¸°" : "ë“±ë¡í•˜ê¸°"}
          </button>
        </DialogFooter>
      </form>
    </Dialog>
  );
}
</file>

<file path="_components/ScoreListTable.tsx">
"use client";

import Link from "next/link";
import { useState, useMemo, memo } from "react";
import { getGradeColor } from "@/lib/constants/colors";
import { Card } from "@/components/molecules/Card";
import { Badge } from "@/components/atoms";
import { inlineButtonBase, tableRowBase, divideDefault, textSecondary, textPrimary } from "@/lib/utils/darkMode";

type SchoolScoreRow = {
  id: string;
  grade: number;
  semester: number;
  subject_group: string;
  subject_type: string | null;
  subject_name: string | null;
  raw_score: number | null;
  grade_score: number | null;
  class_rank: number | null;
  created_at: string | null;
};

type ScoreListTableProps = {
  scores: SchoolScoreRow[];
  grade: string;
  semester: string;
  subjectGroup: string;
  type: "school";
  DeleteButton: React.ComponentType<{ id: string }>;
};

type SortField = "grade" | "semester" | "grade_score" | "raw_score" | "class_rank";
type SortOrder = "asc" | "desc";

function ScoreListTableComponent({
  scores,
  grade,
  semester,
  subjectGroup,
  type,
  DeleteButton,
}: ScoreListTableProps) {
  const [sortField, setSortField] = useState<SortField>("grade");
  const [sortOrder, setSortOrder] = useState<SortOrder>("asc");
  const [filterSubjectType, setFilterSubjectType] = useState<string>("all");

  // í•„í„°ë§ ë° ì •ë ¬
  const filteredAndSortedScores = useMemo(() => {
    let filtered = [...scores];

    // ê³¼ëª© ìœ í˜• í•„í„°ë§
    if (filterSubjectType !== "all") {
      filtered = filtered.filter(
        (score) => score.subject_type === filterSubjectType
      );
    }

    // ì •ë ¬
    filtered.sort((a, b) => {
      let aValue: number | string | null = null;
      let bValue: number | string | null = null;

      switch (sortField) {
        case "grade":
          aValue = a.grade ?? 0;
          bValue = b.grade ?? 0;
          break;
        case "semester":
          aValue = a.semester ?? 0;
          bValue = b.semester ?? 0;
          break;
        case "grade_score":
          aValue = a.grade_score ?? 999;
          bValue = b.grade_score ?? 999;
          break;
        case "raw_score":
          aValue = a.raw_score ?? 0;
          bValue = b.raw_score ?? 0;
          break;
        case "class_rank":
          aValue = a.class_rank ?? 999;
          bValue = b.class_rank ?? 999;
          break;
      }

      if (aValue < bValue) return sortOrder === "asc" ? -1 : 1;
      if (aValue > bValue) return sortOrder === "asc" ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [scores, sortField, sortOrder, filterSubjectType]);

  // ê³ ìœ í•œ ê³¼ëª© ìœ í˜• ëª©ë¡
  const subjectTypes = useMemo(() => {
    const types = new Set<string>();
    scores.forEach((score) => {
      if (score.subject_type) types.add(score.subject_type);
    });
    return Array.from(types).sort();
  }, [scores]);

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortOrder("desc");
    }
  };

  const SortIcon = ({ field }: { field: SortField }) => {
    if (sortField !== field) {
      return <span className="text-gray-400">â†•</span>;
    }
    return sortOrder === "asc" ? <span>â†‘</span> : <span>â†“</span>;
  };

  return (
    <div className="flex flex-col gap-4">
      {/* í•„í„° ë° ì •ë ¬ ì»¨íŠ¸ë¡¤ */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div className="flex flex-wrap items-center gap-2">
          <label className="text-sm font-medium text-gray-700">ê³¼ëª© ìœ í˜•:</label>
          <select
            value={filterSubjectType}
            onChange={(e) => setFilterSubjectType(e.target.value)}
            className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="all">ì „ì²´</option>
            {subjectTypes.map((type) => (
              <option key={type} value={type}>
                {type}
              </option>
            ))}
          </select>
        </div>
        <div className="flex items-center gap-2 text-sm text-gray-600">
          <span>ì •ë ¬:</span>
          <button
            onClick={() => handleSort("grade")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "grade" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            í•™ë…„ <SortIcon field="grade" />
          </button>
          <button
            onClick={() => handleSort("semester")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "semester" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            í•™ê¸° <SortIcon field="semester" />
          </button>
          <button
            onClick={() => handleSort("grade_score")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "grade_score" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            ë“±ê¸‰ <SortIcon field="grade_score" />
          </button>
          <button
            onClick={() => handleSort("raw_score")}
            className={`rounded px-2 py-1 text-xs transition hover:bg-gray-100 ${
              sortField === "raw_score" ? "bg-gray-100 font-medium" : ""
            }`}
          >
            ì›ì ìˆ˜ <SortIcon field="raw_score" />
          </button>
        </div>
      </div>

      {/* ë°ìŠ¤í¬í†± í…Œì´ë¸” ë·° */}
      <Card className="hidden md:block">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">
                  ê³¼ëª© ìœ í˜•
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">
                  ì„¸ë¶€ ê³¼ëª©ëª…
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">
                  <button
                    onClick={() => handleSort("raw_score")}
                    className="flex items-center gap-1 hover:text-gray-900 dark:hover:text-gray-100"
                  >
                    ì›ì ìˆ˜ <SortIcon field="raw_score" />
                  </button>
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">
                  <button
                    onClick={() => handleSort("grade_score")}
                    className="flex items-center gap-1 hover:text-gray-900 dark:hover:text-gray-100"
                  >
                    ë“±ê¸‰ <SortIcon field="grade_score" />
                  </button>
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">
                  <button
                    onClick={() => handleSort("class_rank")}
                    className="flex items-center gap-1 hover:text-gray-900 dark:hover:text-gray-100"
                  >
                    ë°˜ ì„ì°¨ <SortIcon field="class_rank" />
                  </button>
                </th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">
                  ì‘ì—…
                </th>
              </tr>
            </thead>
            <tbody className={divideDefault}>
              {filteredAndSortedScores.map((score) => {
                const gradeColor = getGradeColor(score.grade_score);
                return (
                  <tr key={score.id} className={tableRowBase}>
                    <td className={`px-4 py-3 text-sm ${textSecondary}`}>
                      {score.subject_type || "-"}
                    </td>
                    <td className={`px-4 py-3 text-sm ${textSecondary}`}>
                      {score.subject_name || "-"}
                    </td>
                    <td className={`px-4 py-3 text-sm ${textPrimary}`}>
                      {score.raw_score !== null ? score.raw_score : "-"}
                    </td>
                    <td className="px-4 py-3 text-sm">
                      {score.grade_score !== null ? (
                        <Badge
                          className={gradeColor.badge}
                          size="xs"
                        >
                          {score.grade_score}ë“±ê¸‰
                        </Badge>
                      ) : (
                        <span className="text-gray-400 dark:text-gray-500">-</span>
                      )}
                    </td>
                    <td className={`px-4 py-3 text-sm ${textSecondary}`}>
                      {score.class_rank !== null ? `${score.class_rank}ë“±` : "-"}
                    </td>
                    <td className="px-4 py-3 text-sm">
                      <div className="flex items-center gap-2">
                        <Link
                          href={`/scores/school/${grade}/${semester}/${encodeURIComponent(subjectGroup)}/${score.id}/edit`}
                          className={inlineButtonBase("px-3 py-1.5 text-xs font-semibold")}
                        >
                          ìˆ˜ì •
                        </Link>
                        <DeleteButton id={score.id} />
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </Card>

      {/* ëª¨ë°”ì¼ ì¹´ë“œ ë·° */}
      <div className="flex flex-col gap-3 md:hidden">
        {filteredAndSortedScores.map((score) => {
          const gradeColor = getGradeColor(score.grade_score);
          return (
            <Card key={score.id} hover>
              <div className="flex flex-col gap-3">
                <div className="flex items-start justify-between">
                  <div className="flex flex-col gap-1">
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-semibold text-gray-900">
                        {score.subject_name || "-"}
                      </span>
                      {score.subject_type && (
                        <span className="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">
                          {score.subject_type}
                        </span>
                      )}
                    </div>
                  </div>
                  {score.grade_score !== null && (
                    <Badge
                      className={gradeColor.badge}
                      size="sm"
                    >
                      {score.grade_score}ë“±ê¸‰
                    </Badge>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-3 border-t border-gray-100 pt-3">
                  <div>
                    <p className="text-xs text-gray-500">ì›ì ìˆ˜</p>
                    <p className="text-sm font-medium text-gray-900">
                      {score.raw_score !== null ? score.raw_score : "-"}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-500">ë°˜ ì„ì°¨</p>
                    <p className="text-sm font-medium text-gray-900">
                      {score.class_rank !== null ? `${score.class_rank}ë“±` : "-"}
                    </p>
                  </div>
                </div>

                <div className="flex gap-2 border-t border-gray-100 pt-3">
                  <Link
                    href={`/scores/school/${grade}/${semester}/${encodeURIComponent(subjectGroup)}/${score.id}/edit`}
                    className="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-center text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
                  >
                    ìˆ˜ì •
                  </Link>
                  <div className="flex-1">
                    <DeleteButton id={score.id} />
                  </div>
                </div>
              </div>
            </Card>
          );
        })}
      </div>

      {filteredAndSortedScores.length === 0 && (
        <Card>
          <div className="p-8 text-center">
            <p className="text-sm text-gray-500">
              {filterSubjectType !== "all"
                ? "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤."
                : "ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤."}
            </p>
          </div>
        </Card>
      )}
    </div>
  );
}

export const ScoreListTable = memo(ScoreListTableComponent, (prevProps, nextProps) => {
  // scores ë°°ì—´ì˜ ê¸¸ì´ì™€ ì£¼ìš” ì†ì„± ë¹„êµ
  if (prevProps.scores.length !== nextProps.scores.length) {
    return false;
  }
  
  // scores ë°°ì—´ì˜ ê° í•­ëª© ë¹„êµ (idì™€ ì£¼ìš” ì†ì„±ë§Œ)
  for (let i = 0; i < prevProps.scores.length; i++) {
    const prev = prevProps.scores[i];
    const next = nextProps.scores[i];
    if (
      prev.id !== next.id ||
      prev.grade !== next.grade ||
      prev.semester !== next.semester ||
      prev.raw_score !== next.raw_score ||
      prev.grade_score !== next.grade_score
    ) {
      return false;
    }
  }
  
  return (
    prevProps.grade === nextProps.grade &&
    prevProps.semester === nextProps.semester &&
    prevProps.subjectGroup === nextProps.subjectGroup &&
    prevProps.type === nextProps.type &&
    prevProps.DeleteButton === nextProps.DeleteButton
  );
});
</file>

<file path="_components/ScoreTypeTabs.tsx">
"use client";

import { usePathname, useRouter } from "next/navigation";
import { useCallback, useRef, useEffect, type KeyboardEvent } from "react";

const scoreTypes = [
  { value: "dashboard", label: "ëŒ€ì‹œë³´ë“œ", href: "/scores/dashboard/unified" },
  { value: "school", label: "ë‚´ì‹ ", href: "/scores/school/1/1" },
  { value: "mock", label: "ëª¨ì˜ê³ ì‚¬", href: "/scores/mock/1/3/" + encodeURIComponent("í‰ê°€ì›") },
];

export function ScoreTypeTabs() {
  const pathname = usePathname();
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const isActive = (href: string) => {
    return pathname.startsWith(href.split("/").slice(0, 3).join("/"));
  };

  const handleTabClick = useCallback((href: string) => {
    // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì´ë©´ ë¬´ì‹œ
    if (isActive(href)) return;

    // ì´ì „ timeout ì·¨ì†Œ
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    // 150ms debounce (ì—°ì† í´ë¦­ ë°©ì§€)
    timeoutRef.current = setTimeout(() => {
      router.push(href);
    }, 150);
  }, [pathname, router]);

  // cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ timeout ì •ë¦¬
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  const handleKeyDown = (e: KeyboardEvent<HTMLButtonElement>, index: number) => {
    if (e.key === "ArrowLeft") {
      e.preventDefault();
      const prevIndex = index > 0 ? index - 1 : scoreTypes.length - 1;
      handleTabClick(scoreTypes[prevIndex].href);
      (e.currentTarget.parentElement?.children[prevIndex] as HTMLElement)?.focus();
    } else if (e.key === "ArrowRight") {
      e.preventDefault();
      const nextIndex = index < scoreTypes.length - 1 ? index + 1 : 0;
      handleTabClick(scoreTypes[nextIndex].href);
      (e.currentTarget.parentElement?.children[nextIndex] as HTMLElement)?.focus();
    } else if (e.key === "Home") {
      e.preventDefault();
      handleTabClick(scoreTypes[0].href);
      (e.currentTarget.parentElement?.children[0] as HTMLElement)?.focus();
    } else if (e.key === "End") {
      e.preventDefault();
      const lastIndex = scoreTypes.length - 1;
      handleTabClick(scoreTypes[lastIndex].href);
      (e.currentTarget.parentElement?.children[lastIndex] as HTMLElement)?.focus();
    }
  };

  return (
    <div className="flex gap-2 border-b border-gray-200" role="tablist" aria-label="ì„±ì  íƒ€ì… ì„ íƒ">
      {scoreTypes.map((type, index) => {
        const active = isActive(type.href);
        return (
          <button
            key={type.value}
            onClick={() => handleTabClick(type.href)}
            onKeyDown={(e) => handleKeyDown(e, index)}
            role="tab"
            aria-selected={active}
            aria-controls={`tabpanel-${type.value}`}
            tabIndex={active ? 0 : -1}
            className={`px-4 py-2 text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2 ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {type.label}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="_components/SemesterTabs.tsx">
"use client";

import { usePathname, useRouter } from "next/navigation";
import { useCallback, useRef, useEffect } from "react";

const semesters = [
  { value: "1", label: "1í•™ê¸°" },
  { value: "2", label: "2í•™ê¸°" },
];

type SemesterTabsProps = {
  basePath: string; // ì˜ˆ: "/scores/school/1"
  currentSemester: string;
  subjectGroup?: string; // ì„ íƒì  (êµ¬ë²„ì „ í˜¸í™˜ì„±)
};

export function SemesterTabs({
  basePath,
  currentSemester,
  subjectGroup,
}: SemesterTabsProps) {
  const pathname = usePathname();
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const buildHref = (semester: string) => {
    if (subjectGroup) {
      // êµ¬ë²„ì „ ê²½ë¡œ ì§€ì›
      return `${basePath}/${semester}/${encodeURIComponent(subjectGroup)}`;
    }
    // ì‹ ë²„ì „ ê²½ë¡œ
    return `${basePath}/${semester}`;
  };

  const handleTabClick = useCallback((semester: string) => {
    // ì´ë¯¸ í™œì„±í™”ëœ íƒ­ì´ë©´ ë¬´ì‹œ
    if (semester === currentSemester) return;

    // ì´ì „ timeout ì·¨ì†Œ
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    // 150ms debounce (ì—°ì† í´ë¦­ ë°©ì§€)
    timeoutRef.current = setTimeout(() => {
      router.push(buildHref(semester));
    }, 150);
  }, [basePath, currentSemester, subjectGroup, router]);

  // cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ timeout ì •ë¦¬
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="flex gap-2 border-b border-gray-200">
      {semesters.map((semester) => {
        const active = currentSemester === semester.value;
        return (
          <button
            key={semester.value}
            onClick={() => handleTabClick(semester.value)}
            className={`px-4 py-2 text-sm font-medium transition ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {semester.label}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="_components/SubjectGroupTabs.tsx">
"use client";

import { usePathname, useRouter } from "next/navigation";

const schoolSubjects = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ì‚¬íšŒ", "ê³¼í•™"];
const mockSubjects = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "íƒêµ¬"];

type SubjectGroupTabsProps = {
  type: "school" | "mock";
  basePath: string; // ì˜ˆ: "/scores/school/1/1" ë˜ëŠ” "/scores/mock/1"
  currentSubject: string;
  additionalParams?: string[]; // ëª¨ì˜ê³ ì‚¬ìš©: ["í‰ê°€ì›"]
};

export function SubjectGroupTabs({
  type,
  basePath,
  currentSubject,
  additionalParams = [],
}: SubjectGroupTabsProps) {
  const router = useRouter();
  const subjects = type === "school" ? schoolSubjects : mockSubjects;

  const buildHref = (subject: string) => {
    const encodedSubject = encodeURIComponent(subject);
    const encodedParams = additionalParams.map((p) => encodeURIComponent(p)).join("/");
    return `${basePath}/${encodedSubject}${additionalParams.length > 0 ? `/${encodedParams}` : ""}`;
  };

  return (
    <div className="flex gap-2 border-b border-gray-200">
      {subjects.map((subject) => {
        const active = decodeURIComponent(currentSubject) === subject;
        return (
          <button
            key={subject}
            onClick={() => router.push(buildHref(subject))}
            className={`px-4 py-2 text-sm font-medium transition ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {subject}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="[id]/edit/page.tsx">
import { redirect, notFound } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { updateStudentScore } from "@/app/actions/scores";
import { ScoreForm } from "../../_components/ScoreForm";
import { getContainerClass } from "@/lib/constants/layout";

type ScoreRow = {
  id: string;
  subject_type: string | null;
  semester: string | null;
  course: string | null;
  course_detail: string | null;
  raw_score: number | null;
  grade: number | null;
  score_type_detail: string | null;
  test_date: string | null;
};

type EditScorePageProps = {
  params: Promise<{ id: string }>;
};

export default async function EditScorePage({ params }: EditScorePageProps) {
  const { id } = await params;
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // ì„±ì  ì¡°íšŒ
  const selectScore = () =>
    supabase
      .from("student_scores")
      .select(
        "id,subject_type,semester,course,course_detail,raw_score,grade,score_type_detail,test_date"
      )
      .eq("id", id);

  let { data: score, error } = await selectScore().eq("student_id", user.id).single();

  if (error && error.code === "42703") {
    ({ data: score, error } = await selectScore().single());
  }

  if (error || !score) {
    notFound();
  }

  const scoreData = score as ScoreRow;

  return (
    <section className={getContainerClass("FORM", "lg")}>
      <div className="flex flex-col gap-2">
        <h1 className="text-3xl font-semibold text-gray-900">ì„±ì  ìˆ˜ì •</h1>
        <p className="text-sm text-gray-500">
          ì„±ì  ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.
        </p>
      </div>

      <div className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <ScoreForm
          action={(formData: FormData) => updateStudentScore(id, formData)}
          initialData={{
            subject_type: scoreData.subject_type ?? "",
            semester: scoreData.semester ?? "",
            course: scoreData.course ?? "",
            course_detail: scoreData.course_detail ?? "",
            raw_score: scoreData.raw_score?.toString() ?? "",
            grade: scoreData.grade?.toString() ?? "",
            score_type_detail: scoreData.score_type_detail ?? "",
            test_date: scoreData.test_date
              ? new Date(scoreData.test_date).toISOString().split("T")[0]
              : "",
          }}
        />
      </div>
    </section>
  );
}
</file>

<file path="analysis/_components/AnalysisLayout.tsx">
"use client";

import { useState } from "react";
import InternalDetailAnalysis from "./InternalDetailAnalysis";
import MockDetailAnalysis from "./MockDetailAnalysis";

type AnalysisLayoutProps = {
  studentId: string;
  tenantId: string;
  internalScores: any[];
  mockScores: any[];
};

type AnalysisType = "internal" | "mock";

export default function AnalysisLayout({
  studentId,
  tenantId,
  internalScores,
  mockScores,
}: AnalysisLayoutProps) {
  const [analysisType, setAnalysisType] = useState<AnalysisType>("internal");

  return (
    <div className="flex flex-col gap-6">
      {/* ë¶„ì„ ìœ í˜• ì„ íƒ íƒ­ */}
      <div className="flex gap-2 border-b border-gray-200">
        <button
          onClick={() => setAnalysisType("internal")}
          className={`px-4 py-3 text-sm font-medium transition-colors ${
            analysisType === "internal"
              ? "border-b-2 border-indigo-600 text-indigo-600"
              : "text-gray-600 hover:text-gray-900"
          }`}
        >
          ë‚´ì‹  ë¶„ì„
        </button>
        <button
          onClick={() => setAnalysisType("mock")}
          className={`px-4 py-3 text-sm font-medium transition-colors ${
            analysisType === "mock"
              ? "border-b-2 border-indigo-600 text-indigo-600"
              : "text-gray-600 hover:text-gray-900"
          }`}
        >
          ëª¨ì˜ê³ ì‚¬ ë¶„ì„
        </button>
      </div>

      {/* ë¶„ì„ ì½˜í…ì¸  */}
      {analysisType === "internal" ? (
        <InternalDetailAnalysis
          studentId={studentId}
          tenantId={tenantId}
          scores={internalScores}
        />
      ) : (
        <MockDetailAnalysis
          studentId={studentId}
          tenantId={tenantId}
          scores={mockScores}
        />
      )}
    </div>
  );
}
</file>

<file path="analysis/_components/InternalDetailAnalysis.tsx">
"use client";

import { useMemo } from "react";
import { calculateGPATrend, calculateSubjectRanking, analyzeWeakPoints } from "@/lib/analysis/scoreAnalyzer";
import InternalGPAChart from "./InternalGPAChart";
import InternalSubjectTable from "./InternalSubjectTable";

type InternalDetailAnalysisProps = {
  studentId: string;
  tenantId: string;
  scores: any[];
};

export default function InternalDetailAnalysis({
  studentId,
  tenantId,
  scores,
}: InternalDetailAnalysisProps) {
  // GPA ì¶”ì´ ê³„ì‚°
  const gpaTrend = useMemo(() => calculateGPATrend(scores), [scores]);

  // ê³¼ëª©ë³„ ìˆœìœ„ ê³„ì‚°
  const subjectRanking = useMemo(() => {
    const scoresWithNames = scores.map((s) => ({
      ...s,
      subject_name: s.subjects?.name || "ì•Œ ìˆ˜ ì—†ìŒ",
      subject_group_name: s.subject_groups?.name || "ê¸°íƒ€",
    }));
    return calculateSubjectRanking(scoresWithNames);
  }, [scores]);

  // ì·¨ì•½ ê³¼ëª© ë¶„ì„
  const weakSubjects = useMemo(() => {
    const scoresWithNames = scores.map((s) => ({
      ...s,
      subject_name: s.subjects?.name || "ì•Œ ìˆ˜ ì—†ìŒ",
      subject_group_name: s.subject_groups?.name || "ê¸°íƒ€",
    }));
    return analyzeWeakPoints(scoresWithNames);
  }, [scores]);

  if (scores.length === 0) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-12">
        <div className="flex flex-col gap-2 text-center">
          <p className="text-gray-600">ë‚´ì‹  ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          <p className="text-sm text-gray-500">
            ì„±ì  ì…ë ¥ í˜ì´ì§€ì—ì„œ ì„±ì ì„ ì…ë ¥í•˜ì„¸ìš”.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      {/* GPA ì¶”ì´ ì°¨íŠ¸ */}
      <div className="flex flex-col gap-4 bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <h2 className="text-lg font-semibold text-gray-900">
          GPA ì¶”ì´
        </h2>
        <InternalGPAChart data={gpaTrend} />
      </div>

      {/* ê³¼ëª©ë³„ ì„±ì  í…Œì´ë¸” */}
      <div className="flex flex-col gap-4 bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <h2 className="text-lg font-semibold text-gray-900">
          ê³¼ëª©ë³„ ì„±ì  ìƒì„¸
        </h2>
        <InternalSubjectTable scores={scores} ranking={subjectRanking} />
      </div>

      {/* ì·¨ì•½ ê³¼ëª© ë¶„ì„ */}
      {weakSubjects.length > 0 && (
        <div className="flex flex-col gap-4 bg-white rounded-lg border border-gray-200 p-4 md:p-6">
          <h2 className="text-lg font-semibold text-gray-900">
            ì·¨ì•½ ê³¼ëª© ë¶„ì„ (5ë“±ê¸‰ ì´í•˜)
          </h2>
          <div className="flex flex-col gap-3">
            {weakSubjects.map((subject) => (
              <div
                key={subject.subject_id}
                className="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200"
              >
                <div className="flex flex-col gap-1">
                  <p className="text-sm font-medium text-gray-900">
                    {subject.subject_name}
                  </p>
                  <p className="text-xs text-gray-600">
                    {subject.subject_group_name}
                  </p>
                </div>
                <div className="flex flex-col items-end gap-1">
                  <p className="text-sm font-semibold text-red-700">
                    í‰ê·  {subject.average_grade.toFixed(1)}ë“±ê¸‰
                  </p>
                  {subject.recent_grade && (
                    <p className="text-xs text-gray-600">
                      ìµœê·¼ {subject.recent_grade}ë“±ê¸‰
                    </p>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ì„±ì  ìš”ì•½ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="flex flex-col gap-1 bg-white rounded-lg border border-gray-200 p-4">
          <p className="text-sm text-gray-600">ì „ì²´ ê³¼ëª© ìˆ˜</p>
          <p className="text-2xl font-bold text-gray-900">
            {subjectRanking.length}
          </p>
        </div>
        <div className="flex flex-col gap-1 bg-white rounded-lg border border-gray-200 p-4">
          <p className="text-sm text-gray-600">í‰ê·  GPA</p>
          <p className="text-2xl font-bold text-gray-900">
            {gpaTrend.length > 0
              ? (
                  gpaTrend.reduce((sum, t) => sum + t.gpa, 0) / gpaTrend.length
                ).toFixed(2)
              : "N/A"}
          </p>
        </div>
        <div className="flex flex-col gap-1 bg-white rounded-lg border border-gray-200 p-4">
          <p className="text-sm text-gray-600">ì·¨ì•½ ê³¼ëª© ìˆ˜</p>
          <p className="text-2xl font-bold text-red-600">
            {weakSubjects.length}
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="analysis/_components/InternalGPAChart.tsx">
"use client";

import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";

type InternalGPAChartProps = {
  data: Array<{
    grade: number;
    semester: number;
    gpa: number;
    term: string;
  }>;
};

export default function InternalGPAChart({ data }: InternalGPAChartProps) {
  const { recharts, loading } = useRecharts();

  if (data.length === 0) {
    return (
      <div className="h-64 flex items-center justify-center text-gray-500">
        <p className="text-sm">GPA ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={300} />;
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = recharts;

  return (
    <ResponsiveContainer width="100%" height={300}>
      <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
        <XAxis
          dataKey="term"
          tick={{ fontSize: 12 }}
          stroke="#6b7280"
        />
        <YAxis
          domain={[1, 9]}
          reversed
          tick={{ fontSize: 12 }}
          stroke="#6b7280"
          label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
        />
        <Tooltip
          contentStyle={{
            backgroundColor: "#fff",
            border: "1px solid #e5e7eb",
            borderRadius: "8px",
            fontSize: "12px",
          }}
          formatter={(value: any) => [`${value}ë“±ê¸‰`, "GPA"]}
        />
        <Legend
          wrapperStyle={{ fontSize: "12px" }}
        />
        <Line
          type="monotone"
          dataKey="gpa"
          stroke="#4f46e5"
          strokeWidth={2}
          dot={{ fill: "#4f46e5", r: 4 }}
          activeDot={{ r: 6 }}
          name="GPA"
        />
      </LineChart>
    </ResponsiveContainer>
  );
}
</file>

<file path="analysis/_components/InternalSubjectTable.tsx">
"use client";

import { useState, useMemo } from "react";

type InternalSubjectTableProps = {
  scores: any[];
  ranking: Array<{
    subject_id: string;
    subject_name: string;
    subject_group_name: string;
    average_grade: number;
    count: number;
  }>;
};

type SortKey = "subject_name" | "average_grade" | "count";
type SortOrder = "asc" | "desc";

export default function InternalSubjectTable({
  scores,
  ranking,
}: InternalSubjectTableProps) {
  const [sortKey, setSortKey] = useState<SortKey>("average_grade");
  const [sortOrder, setSortOrder] = useState<SortOrder>("asc");

  // ì •ë ¬ëœ ë°ì´í„°
  const sortedRanking = useMemo(() => {
    return [...ranking].sort((a, b) => {
      let comparison = 0;

      if (sortKey === "subject_name") {
        comparison = a.subject_name.localeCompare(b.subject_name);
      } else if (sortKey === "average_grade") {
        comparison = a.average_grade - b.average_grade;
      } else if (sortKey === "count") {
        comparison = a.count - b.count;
      }

      return sortOrder === "asc" ? comparison : -comparison;
    });
  }, [ranking, sortKey, sortOrder]);

  // ì •ë ¬ í† ê¸€
  const toggleSort = (key: SortKey) => {
    if (sortKey === key) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortKey(key);
      setSortOrder("asc");
    }
  };

  if (ranking.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        <p className="text-sm">ê³¼ëª©ë³„ ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm">
        <thead className="bg-gray-50 border-b border-gray-200">
          <tr>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ìˆœìœ„
            </th>
            <th
              className="px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100"
              onClick={() => toggleSort("subject_name")}
            >
              ê³¼ëª©ëª… {sortKey === "subject_name" && (sortOrder === "asc" ? "â†‘" : "â†“")}
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              êµê³¼êµ°
            </th>
            <th
              className="px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100"
              onClick={() => toggleSort("average_grade")}
            >
              í‰ê·  ë“±ê¸‰ {sortKey === "average_grade" && (sortOrder === "asc" ? "â†‘" : "â†“")}
            </th>
            <th
              className="px-4 py-3 text-left font-medium text-gray-700 cursor-pointer hover:bg-gray-100"
              onClick={() => toggleSort("count")}
            >
              ì‹œí—˜ íšŸìˆ˜ {sortKey === "count" && (sortOrder === "asc" ? "â†‘" : "â†“")}
            </th>
          </tr>
        </thead>
        <tbody>
          {sortedRanking.map((subject, index) => (
            <tr key={subject.subject_id} className="border-b border-gray-100 hover:bg-gray-50">
              <td className="px-4 py-3 text-gray-900 font-medium">
                {index + 1}
              </td>
              <td className="px-4 py-3 text-gray-900">
                {subject.subject_name}
              </td>
              <td className="px-4 py-3 text-gray-600">
                {subject.subject_group_name}
              </td>
              <td className="px-4 py-3">
                <span
                  className={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                    subject.average_grade <= 2
                      ? "bg-green-100 text-green-800"
                      : subject.average_grade <= 4
                      ? "bg-blue-100 text-blue-800"
                      : subject.average_grade <= 6
                      ? "bg-yellow-100 text-yellow-800"
                      : "bg-red-100 text-red-800"
                  }`}
                >
                  {subject.average_grade.toFixed(1)}ë“±ê¸‰
                </span>
              </td>
              <td className="px-4 py-3 text-gray-600">
                {subject.count}íšŒ
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="analysis/_components/MockComparisonTable.tsx">
"use client";

type MockComparisonTableProps = {
  data: Array<{
    subject_id: string;
    subject_name: string;
    recent_score: {
      exam_title: string;
      grade_score: number | null;
      percentile: number | null;
    };
    previous_score: {
      exam_title: string;
      grade_score: number | null;
      percentile: number | null;
    } | null;
    change: {
      grade_change: number | null;
      percentile_change: number | null;
    };
  }>;
};

export default function MockComparisonTable({ data }: MockComparisonTableProps) {
  if (data.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        <p className="text-sm">ë¹„êµí•  ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm">
        <thead className="bg-gray-50 border-b border-gray-200">
          <tr>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ê³¼ëª©
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ìµœê·¼ ì‹œí—˜
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ë“±ê¸‰
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ë°±ë¶„ìœ„
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ì´ì „ ì‹œí—˜
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ë“±ê¸‰
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ë°±ë¶„ìœ„
            </th>
            <th className="px-4 py-3 text-left font-medium text-gray-700">
              ë³€í™”
            </th>
          </tr>
        </thead>
        <tbody>
          {data.map((subject) => (
            <tr key={subject.subject_id} className="border-b border-gray-100 hover:bg-gray-50">
              <td className="px-4 py-3 text-gray-900 font-medium">
                {subject.subject_name}
              </td>
              <td className="px-4 py-3 text-gray-600 text-xs">
                {subject.recent_score.exam_title}
              </td>
              <td className="px-4 py-3">
                {subject.recent_score.grade_score ? (
                  <span
                    className={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                      subject.recent_score.grade_score <= 2
                        ? "bg-green-100 text-green-800"
                        : subject.recent_score.grade_score <= 4
                        ? "bg-blue-100 text-blue-800"
                        : subject.recent_score.grade_score <= 6
                        ? "bg-yellow-100 text-yellow-800"
                        : "bg-red-100 text-red-800"
                    }`}
                  >
                    {subject.recent_score.grade_score}
                  </span>
                ) : (
                  "-"
                )}
              </td>
              <td className="px-4 py-3 text-gray-600">
                {subject.recent_score.percentile !== null
                  ? `${subject.recent_score.percentile}%`
                  : "-"}
              </td>
              <td className="px-4 py-3 text-gray-600 text-xs">
                {subject.previous_score?.exam_title || "-"}
              </td>
              <td className="px-4 py-3">
                {subject.previous_score?.grade_score ? (
                  <span
                    className={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                      subject.previous_score.grade_score <= 2
                        ? "bg-green-100 text-green-800"
                        : subject.previous_score.grade_score <= 4
                        ? "bg-blue-100 text-blue-800"
                        : subject.previous_score.grade_score <= 6
                        ? "bg-yellow-100 text-yellow-800"
                        : "bg-red-100 text-red-800"
                    }`}
                  >
                    {subject.previous_score.grade_score}
                  </span>
                ) : (
                  "-"
                )}
              </td>
              <td className="px-4 py-3 text-gray-600">
                {subject.previous_score?.percentile != null
                  ? `${subject.previous_score?.percentile}%`
                  : "-"}
              </td>
              <td className="px-4 py-3">
                <div className="flex flex-col gap-1">
                  {subject.change.grade_change !== null && (
                    <span
                      className={`text-xs font-medium ${
                        subject.change.grade_change > 0
                          ? "text-green-600"
                          : subject.change.grade_change < 0
                          ? "text-red-600"
                          : "text-gray-600"
                      }`}
                    >
                      ë“±ê¸‰:{" "}
                      {subject.change.grade_change > 0
                        ? `â†‘${subject.change.grade_change}`
                        : subject.change.grade_change < 0
                        ? `â†“${Math.abs(subject.change.grade_change)}`
                        : "="}
                    </span>
                  )}
                  {subject.change.percentile_change !== null && (
                    <span
                      className={`text-xs font-medium ${
                        subject.change.percentile_change > 0
                          ? "text-green-600"
                          : subject.change.percentile_change < 0
                          ? "text-red-600"
                          : "text-gray-600"
                      }`}
                    >
                      ë°±ë¶„ìœ„:{" "}
                      {subject.change.percentile_change > 0
                        ? `+${subject.change.percentile_change.toFixed(1)}`
                        : subject.change.percentile_change.toFixed(1)}
                    </span>
                  )}
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="analysis/_components/MockDetailAnalysis.tsx">
"use client";

import { useMemo } from "react";
import { analyzeMockTrend, compareTwoRecentMockScores } from "@/lib/analysis/scoreAnalyzer";
import MockTrendChart from "./MockTrendChart";
import MockComparisonTable from "./MockComparisonTable";

type MockDetailAnalysisProps = {
  studentId: string;
  tenantId: string;
  scores: any[];
};

export default function MockDetailAnalysis({
  studentId,
  tenantId,
  scores,
}: MockDetailAnalysisProps) {
  // ë°±ë¶„ìœ„ ì¶”ì´ ë¶„ì„
  const trendAnalysis = useMemo(() => analyzeMockTrend(scores), [scores]);

  // ìµœê·¼ 2íšŒ ë¹„êµ
  const recentComparison = useMemo(() => {
    const scoresWithNames = scores.map((s) => ({
      ...s,
      subject_name: s.subjects?.name || "ì•Œ ìˆ˜ ì—†ìŒ",
    }));
    return compareTwoRecentMockScores(scoresWithNames);
  }, [scores]);

  // ì‹œê°„ìˆœ ì •ë ¬ëœ ë°ì´í„° (ì°¨íŠ¸ìš©)
  const sortedScores = useMemo(() => {
    return [...scores].sort(
      (a, b) =>
        new Date(a.exam_date).getTime() - new Date(b.exam_date).getTime()
    );
  }, [scores]);

  if (scores.length === 0) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-12">
        <div className="flex flex-col gap-2 text-center">
          <p className="text-gray-600">ëª¨ì˜ê³ ì‚¬ ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          <p className="text-sm text-gray-500">
            ì„±ì  ì…ë ¥ í˜ì´ì§€ì—ì„œ ì„±ì ì„ ì…ë ¥í•˜ì„¸ìš”.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      {/* ì¶”ì´ ìš”ì•½ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="flex flex-col gap-1 bg-white rounded-lg border border-gray-200 p-4">
          <p className="text-sm text-gray-600">ì „ì²´ ì‹œí—˜ ìˆ˜</p>
          <p className="text-2xl font-bold text-gray-900">
            {scores.length}
          </p>
        </div>
        <div className="flex flex-col gap-1 bg-white rounded-lg border border-gray-200 p-4">
          <p className="text-sm text-gray-600">ìµœê·¼ í‰ê·  ë°±ë¶„ìœ„</p>
          <p className="text-2xl font-bold text-indigo-600">
            {trendAnalysis.recent_average_percentile !== null
              ? `${trendAnalysis.recent_average_percentile}%`
              : "N/A"}
          </p>
        </div>
        <div className="flex flex-col gap-1 bg-white rounded-lg border border-gray-200 p-4">
          <p className="text-sm text-gray-600">ì¶”ì´</p>
          <p
            className={`text-2xl font-bold ${
              trendAnalysis.trend === "ìƒìŠ¹"
                ? "text-green-600"
                : trendAnalysis.trend === "í•˜ë½"
                ? "text-red-600"
                : "text-gray-600"
            }`}
          >
            {trendAnalysis.trend}
            {trendAnalysis.change_from_previous !== null &&
              ` (${trendAnalysis.change_from_previous > 0 ? "+" : ""}${trendAnalysis.change_from_previous})`}
          </p>
        </div>
      </div>

      {/* ë°±ë¶„ìœ„ ì¶”ì´ ì°¨íŠ¸ */}
      <div className="flex flex-col gap-4 bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <h2 className="text-lg font-semibold text-gray-900">
          ë°±ë¶„ìœ„ ì¶”ì´
        </h2>
        <MockTrendChart scores={sortedScores} />
      </div>

      {/* ìµœê·¼ 2íšŒ ë¹„êµ í…Œì´ë¸” */}
      {recentComparison.length > 0 && (
        <div className="flex flex-col gap-4 bg-white rounded-lg border border-gray-200 p-4 md:p-6">
          <h2 className="text-lg font-semibold text-gray-900">
            ìµœê·¼ 2íšŒ ì„±ì  ë¹„êµ
          </h2>
          <MockComparisonTable data={recentComparison} />
        </div>
      )}

      {/* ê³¼ëª©ë³„ ìƒì„¸ ì„±ì  */}
      <div className="flex flex-col gap-4 bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <h2 className="text-lg font-semibold text-gray-900">
          ì‹œí—˜ë³„ ìƒì„¸ ì„±ì 
        </h2>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50 border-b border-gray-200">
              <tr>
                <th className="px-4 py-3 text-left font-medium text-gray-700">
                  ì‹œí—˜ì¼
                </th>
                <th className="px-4 py-3 text-left font-medium text-gray-700">
                  ì‹œí—˜ëª…
                </th>
                <th className="px-4 py-3 text-left font-medium text-gray-700">
                  ê³¼ëª©
                </th>
                <th className="px-4 py-3 text-left font-medium text-gray-700">
                  ë“±ê¸‰
                </th>
                <th className="px-4 py-3 text-left font-medium text-gray-700">
                  ë°±ë¶„ìœ„
                </th>
                <th className="px-4 py-3 text-left font-medium text-gray-700">
                  í‘œì¤€ì ìˆ˜
                </th>
              </tr>
            </thead>
            <tbody>
              {sortedScores.map((score, index) => (
                <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                  <td className="px-4 py-3 text-gray-900">
                    {new Date(score.exam_date).toLocaleDateString("ko-KR")}
                  </td>
                  <td className="px-4 py-3 text-gray-900">
                    {score.exam_title}
                  </td>
                  <td className="px-4 py-3 text-gray-900">
                    {score.subjects?.name || "ì•Œ ìˆ˜ ì—†ìŒ"}
                  </td>
                  <td className="px-4 py-3">
                    {score.grade_score ? (
                      <span
                        className={`inline-flex px-2 py-1 rounded-full text-xs font-medium ${
                          score.grade_score <= 2
                            ? "bg-green-100 text-green-800"
                            : score.grade_score <= 4
                            ? "bg-blue-100 text-blue-800"
                            : score.grade_score <= 6
                            ? "bg-yellow-100 text-yellow-800"
                            : "bg-red-100 text-red-800"
                        }`}
                      >
                        {score.grade_score}ë“±ê¸‰
                      </span>
                    ) : (
                      "-"
                    )}
                  </td>
                  <td className="px-4 py-3 text-gray-600">
                    {score.percentile !== null ? `${score.percentile}%` : "-"}
                  </td>
                  <td className="px-4 py-3 text-gray-600">
                    {score.standard_score !== null ? score.standard_score : "-"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="analysis/_components/MockTrendChart.tsx">
"use client";

import { useMemo } from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import { getChartColor } from "@/lib/constants/colors";

type MockTrendChartProps = {
  scores: any[];
};

export default function MockTrendChart({ scores }: MockTrendChartProps) {
  const { recharts, loading } = useRecharts();
  // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
  const chartData = useMemo(() => {
    // ì‹œí—˜ì¼ë³„ë¡œ ê·¸ë£¹í™”
    const groupedByExam = scores.reduce((acc, score) => {
      const key = `${score.exam_date}-${score.exam_title}`;
      if (!acc[key]) {
        acc[key] = {
          exam_date: score.exam_date,
          exam_title: score.exam_title,
          label: `${new Date(score.exam_date).toLocaleDateString("ko-KR", {
            month: "short",
            day: "numeric",
          })} ${score.exam_title}`,
          scores: [],
        };
      }

      if (score.percentile !== null) {
        acc[key].scores.push(score.percentile);
      }

      return acc;
    }, {} as Record<string, { exam_date: string; exam_title: string; label: string; scores: number[] }>);

    // í‰ê·  ë°±ë¶„ìœ„ ê³„ì‚°
    type ExamGroup = { exam_date: string; exam_title: string; label: string; scores: number[] };
    return (Object.values(groupedByExam) as ExamGroup[])
      .map((exam) => ({
        label: exam.label,
        exam_date: exam.exam_date,
        average_percentile:
          exam.scores.length > 0
            ? exam.scores.reduce((sum, s) => sum + s, 0) / exam.scores.length
            : null,
      }))
      .filter((d) => d.average_percentile !== null)
      .sort((a, b) => new Date(a.exam_date).getTime() - new Date(b.exam_date).getTime());
  }, [scores]);

  if (chartData.length === 0) {
    return (
      <div className="h-64 flex items-center justify-center text-gray-500">
        <p className="text-sm">ë°±ë¶„ìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={300} />;
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = recharts;

  return (
    <ResponsiveContainer width="100%" height={300}>
      <LineChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" stroke="rgb(229 231 235)" />
        <XAxis
          dataKey="label"
          tick={{ fontSize: 11 }}
          stroke="rgb(107 114 128)"
          angle={-15}
          textAnchor="end"
          height={60}
        />
        <YAxis
          domain={[0, 100]}
          tick={{ fontSize: 12 }}
          stroke="rgb(107 114 128)"
          label={{ value: "ë°±ë¶„ìœ„ (%)", angle: -90, position: "insideLeft" }}
        />
        <Tooltip
          contentStyle={{
            backgroundColor: "#fff",
            border: "1px solid rgb(229 231 235)",
            borderRadius: "8px",
            fontSize: "12px",
          }}
          formatter={(value: any) => [`${value.toFixed(1)}%`, "í‰ê·  ë°±ë¶„ìœ„"]}
        />
        <Legend wrapperStyle={{ fontSize: "12px" }} />
        <Line
          type="monotone"
          dataKey="average_percentile"
          stroke={getChartColor(0)}
          strokeWidth={2}
          dot={{ fill: getChartColor(0), r: 4 }}
          activeDot={{ r: 6 }}
          name="í‰ê·  ë°±ë¶„ìœ„"
        />
      </LineChart>
    </ResponsiveContainer>
  );
}
</file>

<file path="analysis/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/auth/getCurrentUser";
import { getInternalScoresByTerm, getMockScoresByPeriod } from "@/lib/data/scoreDetails";
import { SectionHeader } from "@/components/ui/SectionHeader";
import AnalysisLayout from "./_components/AnalysisLayout";
import { getContainerClass } from "@/lib/constants/layout";

export default async function ScoreAnalysisPage() {
  // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
  const currentUser = await getCurrentUser();
  if (!currentUser || currentUser.role !== "student") {
    redirect("/login");
  }

  const studentId = currentUser.userId;
  const tenantId = currentUser.tenantId;

  // tenantIdê°€ ì—†ìœ¼ë©´ í•™ìƒ ì„¤ì • í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  if (!tenantId) {
    redirect("/student-setup");
  }

  // ë‚´ì‹  ì„±ì  ì¡°íšŒ (ì „ì²´)
  const internalScores = await getInternalScoresByTerm(studentId, tenantId);

  // ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ (ìµœê·¼ 1ë…„)
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  const mockScores = await getMockScoresByPeriod(
    studentId,
    tenantId,
    oneYearAgo.toISOString().split("T")[0]
  );

  return (
    <div className="min-h-screen bg-gray-50">
      <div className={getContainerClass("DASHBOARD", "md")}>
        <div className="flex flex-col gap-6">
          {/* í—¤ë” */}
          <SectionHeader
            level="h1"
            title="ì„±ì  ìƒì„¸ ë¶„ì„"
            description="ë‚´ì‹ ê³¼ ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ì‹¬ì¸µ ë¶„ì„í•©ë‹ˆë‹¤."
          />

          {/* ë¶„ì„ ë ˆì´ì•„ì›ƒ */}
          <AnalysisLayout
            studentId={studentId}
            tenantId={tenantId}
            internalScores={internalScores}
            mockScores={mockScores}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="dashboard/_components/CompareSection.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SchoolScoreRow, MockScoreRow } from "../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";

type CompareSectionProps = {
  schoolScores: SchoolScoreRow[];
  mockScores: MockScoreRow[];
};

const COMPARABLE_SUBJECTS = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´"];

export function CompareSection({
  schoolScores,
  mockScores,
}: CompareSectionProps) {
  const { recharts, loading } = useRecharts();

  const chartData = React.useMemo(() => {
    const result: Array<{
      subject: string;
      ë‚´ì‹ : number | null;
      ëª¨ì˜ê³ ì‚¬: number | null;
    }> = [];

    COMPARABLE_SUBJECTS.forEach((subject) => {
      // ë‚´ì‹  í‰ê·  ë“±ê¸‰ ê³„ì‚°
      const schoolScoresForSubject = schoolScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );
      const schoolAverage =
        schoolScoresForSubject.length > 0
          ? schoolScoresForSubject.reduce(
              (sum, s) => sum + (s.grade_score ?? 0),
              0
            ) / schoolScoresForSubject.length
          : null;

      // ëª¨ì˜ê³ ì‚¬ í‰ê·  ë“±ê¸‰ ê³„ì‚°
      const mockScoresForSubject = mockScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );
      const mockAverage =
        mockScoresForSubject.length > 0
          ? mockScoresForSubject.reduce(
              (sum, s) => sum + (s.grade_score ?? 0),
              0
            ) / mockScoresForSubject.length
          : null;

      // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€
      if (schoolAverage !== null || mockAverage !== null) {
        result.push({
          subject,
          ë‚´ì‹ : schoolAverage !== null ? Number(schoolAverage.toFixed(1)) : null,
          ëª¨ì˜ê³ ì‚¬: mockAverage !== null ? Number(mockAverage.toFixed(1)) : null,
        });
      }
    });

    return result;
  }, [schoolScores, mockScores]);

  if (chartData.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-12 text-center">
        <div className="mx-auto flex max-w-md flex-col gap-4">
          <div className="text-6xl">âš–ï¸</div>
          <div className="flex flex-col gap-2">
            <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
              ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </h3>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              ë‚´ì‹ ê³¼ ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ëª¨ë‘ ë“±ë¡í•˜ë©´ ë¹„êµ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </div>
    );
  }

  // Show loading skeleton while recharts is loading
  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={400} />;
  }

  const {
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    Legend,
    ResponsiveContainer,
  } = recharts;

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
      <h2 className="text-xl font-semibold text-gray-900 dark:text-gray-100">
        ë‚´ì‹  vs ëª¨ì˜ê³ ì‚¬ ë¹„êµ
      </h2>
      <ResponsiveContainer width="100%" height={400}>
        <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="subject" />
          <YAxis
            domain={[1, 9]}
            reversed
            label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
          />
          <Tooltip
            formatter={(value: any) => {
              if (value === null || value === undefined) return "ë°ì´í„° ì—†ìŒ";
              return `${value}ë“±ê¸‰`;
            }}
          />
          <Legend />
          <Bar dataKey="ë‚´ì‹ " fill={getChartColor(0)} name="ë‚´ì‹  í‰ê·  ë“±ê¸‰" />
          <Bar dataKey="ëª¨ì˜ê³ ì‚¬" fill={getChartColor(1)} name="ëª¨ì˜ê³ ì‚¬ í‰ê·  ë“±ê¸‰" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
}
</file>

<file path="dashboard/_components/CourseAverageChart.tsx">
"use client";

import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { CourseAverageGrade } from "../_utils";
import { getChartColor } from "@/lib/constants/colors";

type CourseAverageChartProps = {
  data: CourseAverageGrade[];
};

export function CourseAverageChart({ data }: CourseAverageChartProps) {
  const { recharts, loading } = useRecharts();

  if (data.length === 0) {
    return (
      <div className="p-8 text-center text-sm text-gray-500">
        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={400} />;
  }

  const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;

  const chartData = data.map((item) => ({
    name: item.course,
    "í‰ê·  ë“±ê¸‰": Number(item.averageGrade.toFixed(1)),
    "ì„±ì  ê°œìˆ˜": item.count,
  }));

  return (
    <ResponsiveContainer width="100%" height={400}>
      <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis
          dataKey="name"
          angle={-45}
          textAnchor="end"
          height={80}
          interval={0}
        />
        <YAxis
          domain={[0, 9]}
          reversed
          label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
        />
        <Tooltip
          formatter={(value: number, name: string) => {
            if (name === "í‰ê·  ë“±ê¸‰") {
              return [`${value.toFixed(1)}ë“±ê¸‰`, "í‰ê·  ë“±ê¸‰"];
            }
            return [value, name];
          }}
        />
        <Legend />
        <Bar dataKey="í‰ê·  ë“±ê¸‰" fill={getChartColor(0)} name="í‰ê·  ë“±ê¸‰" />
      </BarChart>
    </ResponsiveContainer>
  );
}
</file>

<file path="dashboard/_components/DashboardSubTabs.tsx">
"use client";

/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */

import { usePathname, useRouter } from "next/navigation";
import { useCallback, useRef, useEffect } from "react";

const dashboardTabs = [
  { value: "integrated", label: "í†µí•©", href: "/scores/dashboard/unified" },
  { value: "school", label: "ë‚´ì‹ ", href: "/scores/dashboard/school" },
  { value: "mock", label: "ëª¨ì˜ê³ ì‚¬", href: "/scores/dashboard/mock" },
];

export function DashboardSubTabs() {
  const pathname = usePathname();
  const router = useRouter();
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const isActive = (href: string) => {
    if (href === "/scores/dashboard") {
      return pathname === "/scores/dashboard";
    }
    return pathname.startsWith(href);
  };

  const handleTabClick = useCallback(
    (href: string) => {
      // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì´ë©´ ë¬´ì‹œ
      if (isActive(href)) return;

      // ì´ì „ timeout ì·¨ì†Œ
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }

      // 150ms debounce (ì—°ì† í´ë¦­ ë°©ì§€)
      timeoutRef.current = setTimeout(() => {
        router.push(href);
      }, 150);
    },
    [pathname, router]
  );

  // cleanup: ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ timeout ì •ë¦¬
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <div className="flex gap-2 border-b border-gray-200">
      {dashboardTabs.map((tab) => {
        const active = isActive(tab.href);
        return (
          <button
            key={tab.value}
            onClick={() => handleTabClick(tab.href)}
            className={`px-4 py-2 text-sm font-medium transition ${
              active
                ? "border-b-2 border-indigo-600 text-indigo-600"
                : "text-gray-500 hover:text-gray-900"
            }`}
          >
            {tab.label}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="dashboard/_components/InsightPanel.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React from "react";
import type { SchoolScoreRow, MockScoreRow } from "../_utils/scoreQueries";
import { EmptyState } from "@/components/molecules/EmptyState";
import { Card, CardContent } from "@/components/molecules/Card";

type InsightPanelProps = {
  schoolScores: SchoolScoreRow[];
  mockScores: MockScoreRow[];
};

export function InsightPanel({
  schoolScores,
  mockScores,
}: InsightPanelProps) {
  const insights = React.useMemo(() => {
    const result: string[] = [];

    // 1. êµê³¼ë³„ ìµœê·¼ í•˜ë½ ì¶”ì„¸ ë¶„ì„
    const schoolBySubject = new Map<string, SchoolScoreRow[]>();
    schoolScores.forEach((score) => {
      if (!score.subject_group || score.grade_score === null) return;
      const key = score.subject_group;
      if (!schoolBySubject.has(key)) {
        schoolBySubject.set(key, []);
      }
      schoolBySubject.get(key)!.push(score);
    });

    schoolBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        if (a.semester !== b.semester) return b.semester - a.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });

      if (sorted.length >= 2) {
        const recent2 = sorted.slice(0, 2);
        const grades = recent2
          .map((s) => s.grade_score)
          .filter((g): g is number => g !== null);

        if (grades.length === 2 && grades[0] > grades[1]) {
          // ë“±ê¸‰ì´ ë†’ì•„ì¡Œë‹¤ëŠ” ê²ƒì€ ë‚˜ë¹ ì¡Œë‹¤ëŠ” ì˜ë¯¸
          result.push(
            `${subject} ê³¼ëª©ì€ ìµœê·¼ ë‘ ë²ˆ ì—°ì† ë“±ê¸‰ì´ í•˜ë½í–ˆìŠµë‹ˆë‹¤. (${grades[1]}ë“±ê¸‰ â†’ ${grades[0]}ë“±ê¸‰) ê¸°ì´ˆ ê°œë… ë³µìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`
          );
        }
      }
    });

    // 2. ëª¨ì˜ê³ ì‚¬ ë°±ë¶„ìœ„ ë‚®ì€ ê³¼ëª©
    const mockBySubject = new Map<string, MockScoreRow[]>();
    mockScores.forEach((score) => {
      if (!score.subject_group || score.percentile === null) return;
      const key = score.subject_group;
      if (!mockBySubject.has(key)) {
        mockBySubject.set(key, []);
      }
      mockBySubject.get(key)!.push(score);
    });

    mockBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });

      const recent = sorted[0];
      if (recent && recent.percentile !== null && recent.percentile < 50) {
        result.push(
          `${subject} ëª¨ì˜ê³ ì‚¬ ë°±ë¶„ìœ„ê°€ ${recent.percentile.toFixed(1)}%ë¡œ ë‚®ì•„, ë‹¨ì›ë³„ ê¸°ì´ˆ ë¬¸ì œ ë³µìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`
        );
      }
    });

    // 3. ë‚´ì‹  vs ëª¨ì˜ê³ ì‚¬ í¸ì°¨ ë¶„ì„
    const comparableSubjects = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´"];
    comparableSubjects.forEach((subject) => {
      const schoolScoresForSubject = schoolScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );
      const mockScoresForSubject = mockScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );

      if (schoolScoresForSubject.length > 0 && mockScoresForSubject.length > 0) {
        const schoolAvg =
          schoolScoresForSubject.reduce(
            (sum, s) => sum + (s.grade_score ?? 0),
            0
          ) / schoolScoresForSubject.length;
        const mockAvg =
          mockScoresForSubject.reduce(
            (sum, s) => sum + (s.grade_score ?? 0),
            0
          ) / mockScoresForSubject.length;

        const diff = Math.abs(schoolAvg - mockAvg);
        if (diff >= 1.5) {
          if (schoolAvg < mockAvg) {
            result.push(
              `${subject} ê³¼ëª©ì€ ë‚´ì‹ (${schoolAvg.toFixed(1)}ë“±ê¸‰)ì´ ëª¨ì˜ê³ ì‚¬(${mockAvg.toFixed(1)}ë“±ê¸‰)ë³´ë‹¤ ì¢‹ìŠµë‹ˆë‹¤. ë‚´ì‹  ìœ ì§€ì— ì§‘ì¤‘í•˜ì„¸ìš”.`
            );
          } else {
            result.push(
              `${subject} ê³¼ëª©ì€ ëª¨ì˜ê³ ì‚¬(${mockAvg.toFixed(1)}ë“±ê¸‰)ê°€ ë‚´ì‹ (${schoolAvg.toFixed(1)}ë“±ê¸‰)ë³´ë‹¤ ì¢‹ìŠµë‹ˆë‹¤. ë‚´ì‹  ì„±ì  í–¥ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.`
            );
          }
        }
      }
    });

    // 4. ì•ˆì •ì ì¸ ê³¼ëª© ì¹­ì°¬
    schoolBySubject.forEach((scores, subject) => {
      if (scores.length >= 3) {
        const grades = scores
          .map((s) => s.grade_score)
          .filter((g): g is number => g !== null)
          .slice(0, 3);

        if (grades.length === 3) {
          const variance =
            grades.reduce((sum, g) => {
              const mean = grades.reduce((a, b) => a + b, 0) / grades.length;
              return sum + Math.pow(g - mean, 2);
            }, 0) / grades.length;

          if (variance < 0.5) {
            // í¸ì°¨ê°€ ì‘ìœ¼ë©´ ì•ˆì •ì 
            result.push(
              `${subject} ë‚´ì‹ ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. í˜„ì¬ í•™ìŠµ íŒ¨í„´ì„ ê³„ì† ìœ ì§€í•˜ì„¸ìš”.`
            );
          }
        }
      }
    });

    return result.slice(0, 5); // ìµœëŒ€ 5ê°œ
  }, [schoolScores, mockScores]);

  if (insights.length === 0) {
    return (
      <EmptyState
        icon="ğŸ’¡"
        title="ì¸ì‚¬ì´íŠ¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤"
        description="ë” ë§ì€ ì„±ì  ë°ì´í„°ë¥¼ ë“±ë¡í•˜ë©´ í•™ìŠµ ì¸ì‚¬ì´íŠ¸ê°€ ì œê³µë©ë‹ˆë‹¤."
      />
    );
  }

  return (
    <Card className="border-primary-200 bg-primary-50">
      <CardContent className="flex flex-col gap-4">
        <h2 className="text-h2 text-primary-900">
          í•™ìŠµ ì¸ì‚¬ì´íŠ¸
        </h2>
        <div className="flex flex-col gap-3">
          {insights.map((insight, index) => (
            <div
              key={index}
              className="rounded-lg border border-primary-200 bg-white p-4"
            >
              <div className="flex items-start gap-3">
                <span className="text-body-1">ğŸ’¡</span>
                <p className="text-body-2 text-text-secondary flex-1">{insight}</p>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="dashboard/_components/IntegratedComparisonChart.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React, { useState } from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SchoolScoreRow, MockScoreRow } from "../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";

type IntegratedComparisonChartProps = {
  schoolScores: SchoolScoreRow[];
  mockScores: MockScoreRow[];
};

type ChartType = "trend" | "subject";

export function IntegratedComparisonChart({
  schoolScores,
  mockScores,
}: IntegratedComparisonChartProps) {
  const { recharts, loading } = useRecharts();
  const [chartType, setChartType] = useState<ChartType>("trend");

  // ì‹œê°„ë³„ ì¶”ì„¸ ë¹„êµ ë°ì´í„°
  const trendData = React.useMemo(() => {
    const result: Array<Record<string, number | string | null>> = [];

    // ë‚´ì‹  ë°ì´í„°: í•™ê¸°ë³„ í‰ê·  ë“±ê¸‰
    const schoolSemesterMap = new Map<string, number[]>();
    schoolScores.forEach((score) => {
      if (score.grade && score.semester && score.grade_score !== null) {
        const key = `${score.grade}-${score.semester}`;
        if (!schoolSemesterMap.has(key)) {
          schoolSemesterMap.set(key, []);
        }
        schoolSemesterMap.get(key)!.push(score.grade_score);
      }
    });

    const schoolData: Array<{ period: string; average: number }> = [];
    schoolSemesterMap.forEach((grades, key) => {
      const [grade, semester] = key.split("-");
      const average = grades.reduce((a, b) => a + b, 0) / grades.length;
      schoolData.push({
        period: `${grade}í•™ë…„ ${semester}í•™ê¸°`,
        average: Number(average.toFixed(1)),
      });
    });

    // ëª¨ì˜ê³ ì‚¬ ë°ì´í„°: íšŒì°¨ë³„ í‰ê·  ë“±ê¸‰
    const mockRoundMap = new Map<string, number[]>();
    mockScores.forEach((score) => {
      if (score.exam_round && score.grade_score !== null) {
        if (!mockRoundMap.has(score.exam_round)) {
          mockRoundMap.set(score.exam_round, []);
        }
        mockRoundMap.get(score.exam_round)!.push(score.grade_score);
      }
    });

    const mockData: Array<{ period: string; average: number }> = [];
    const roundOrder = ["3ì›”", "4ì›”", "6ì›”", "9ì›”", "11ì›”", "ì‚¬ì„¤"];
    roundOrder.forEach((round) => {
      const grades = mockRoundMap.get(round);
      if (grades && grades.length > 0) {
        const average = grades.reduce((a, b) => a + b, 0) / grades.length;
        mockData.push({
          period: `${round} ëª¨ì˜ê³ ì‚¬`,
          average: Number(average.toFixed(1)),
        });
      }
    });

    // ëª¨ë“  ê¸°ê°„ ìˆ˜ì§‘ ë° ì •ë ¬
    const allPeriods = new Set<string>();
    schoolData.forEach((d) => allPeriods.add(d.period));
    mockData.forEach((d) => allPeriods.add(d.period));

    const sortedPeriods = Array.from(allPeriods).sort((a, b) => {
      // í•™ê¸° ë°ì´í„°ì™€ ëª¨ì˜ê³ ì‚¬ ë°ì´í„°ë¥¼ í•¨ê»˜ ì •ë ¬
      const aIsSchool = a.includes("í•™ê¸°");
      const bIsSchool = b.includes("í•™ê¸°");
      
      if (aIsSchool && !bIsSchool) return -1;
      if (!aIsSchool && bIsSchool) return 1;
      
      // ê°™ì€ íƒ€ì… ë‚´ì—ì„œ ì •ë ¬
      if (aIsSchool && bIsSchool) {
        const aMatch = a.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
        const bMatch = b.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
        if (aMatch && bMatch) {
          const aGrade = parseInt(aMatch[1]);
          const bGrade = parseInt(bMatch[1]);
          if (aGrade !== bGrade) return aGrade - bGrade;
          return parseInt(aMatch[2]) - parseInt(bMatch[2]);
        }
      }
      
      return a.localeCompare(b);
    });

    sortedPeriods.forEach((period) => {
      const dataPoint: Record<string, number | string | null> = { period };
      const schoolItem = schoolData.find((d) => d.period === period);
      const mockItem = mockData.find((d) => d.period === period);
      
      dataPoint["ë‚´ì‹ "] = schoolItem ? schoolItem.average : null;
      dataPoint["ëª¨ì˜ê³ ì‚¬"] = mockItem ? mockItem.average : null;
      
      result.push(dataPoint);
    });

    return result;
  }, [schoolScores, mockScores]);

  // ê³¼ëª©ë³„ ë¹„êµ ë°ì´í„°
  const subjectData = React.useMemo(() => {
    const comparableSubjects = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´"];
    const result: Array<{
      subject: string;
      ë‚´ì‹ : number | null;
      ëª¨ì˜ê³ ì‚¬: number | null;
      ì°¨ì´: number | null;
    }> = [];

    comparableSubjects.forEach((subject) => {
      // ë‚´ì‹  í‰ê·  ë“±ê¸‰
      const schoolScoresForSubject = schoolScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );
      const schoolAverage =
        schoolScoresForSubject.length > 0
          ? schoolScoresForSubject.reduce(
              (sum, s) => sum + (s.grade_score ?? 0),
              0
            ) / schoolScoresForSubject.length
          : null;

      // ëª¨ì˜ê³ ì‚¬ í‰ê·  ë“±ê¸‰
      const mockScoresForSubject = mockScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );
      const mockAverage =
        mockScoresForSubject.length > 0
          ? mockScoresForSubject.reduce(
              (sum, s) => sum + (s.grade_score ?? 0),
              0
            ) / mockScoresForSubject.length
          : null;

      const diff =
        schoolAverage !== null && mockAverage !== null
          ? Number((schoolAverage - mockAverage).toFixed(1))
          : null;

      if (schoolAverage !== null || mockAverage !== null) {
        result.push({
          subject,
          ë‚´ì‹ : schoolAverage !== null ? Number(schoolAverage.toFixed(1)) : null,
          ëª¨ì˜ê³ ì‚¬: mockAverage !== null ? Number(mockAverage.toFixed(1)) : null,
          ì°¨ì´: diff,
        });
      }
    });

    return result;
  }, [schoolScores, mockScores]);

  if (schoolScores.length === 0 && mockScores.length === 0) {
    return null;
  }

  // Show loading skeleton while recharts is loading
  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={400} />;
  }

  const {
    LineChart,
    Line,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    Legend,
    ResponsiveContainer,
    BarChart,
    Bar,
  } = recharts;

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900 dark:text-gray-100">
          í†µí•© ì„±ì  ë¹„êµ ë¶„ì„
        </h2>
        <div className="flex gap-2">
          <button
            onClick={() => setChartType("trend")}
            className={`rounded-lg px-3 py-1.5 text-sm font-medium transition ${
              chartType === "trend"
                ? "bg-indigo-600 dark:bg-indigo-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            ì‹œê°„ë³„ ì¶”ì„¸
          </button>
          <button
            onClick={() => setChartType("subject")}
            className={`rounded-lg px-3 py-1.5 text-sm font-medium transition ${
              chartType === "subject"
                ? "bg-indigo-600 dark:bg-indigo-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            ê³¼ëª©ë³„ ë¹„êµ
          </button>
        </div>
      </div>

      {chartType === "trend" ? (
        <ResponsiveContainer width="100%" height={400}>
          <LineChart
            data={trendData}
            margin={{ top: 20, right: 30, left: 20, bottom: 60 }}
          >
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="period"
              angle={-45}
              textAnchor="end"
              height={100}
              interval={0}
            />
            <YAxis
              domain={[1, 9]}
              reversed
              label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
            />
            <Tooltip
              formatter={(value: any) => {
                if (value === null || value === undefined) return "ë°ì´í„° ì—†ìŒ";
                return `${value}ë“±ê¸‰`;
              }}
            />
            <Legend />
            <Line
              type="monotone"
              dataKey="ë‚´ì‹ "
              stroke={getChartColor(0)}
              strokeWidth={2}
              name="ë‚´ì‹  í‰ê·  ë“±ê¸‰"
              dot={{ r: 6 }}
              connectNulls={false}
            />
            <Line
              type="monotone"
              dataKey="ëª¨ì˜ê³ ì‚¬"
              stroke={getChartColor(1)}
              strokeWidth={2}
              name="ëª¨ì˜ê³ ì‚¬ í‰ê·  ë“±ê¸‰"
              dot={{ r: 6 }}
              connectNulls={false}
            />
          </LineChart>
        </ResponsiveContainer>
      ) : (
        <div className="flex flex-col gap-4">
          <ResponsiveContainer width="100%" height={300}>
            <BarChart
              data={subjectData}
              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="subject" />
              <YAxis
                domain={[1, 9]}
                reversed
                label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
              />
              <Tooltip
                formatter={(value: any) => {
                  if (value === null || value === undefined) return "ë°ì´í„° ì—†ìŒ";
                  return `${value}ë“±ê¸‰`;
                }}
              />
              <Legend />
              <Bar dataKey="ë‚´ì‹ " fill={getChartColor(0)} name="ë‚´ì‹  í‰ê·  ë“±ê¸‰" />
              <Bar dataKey="ëª¨ì˜ê³ ì‚¬" fill={getChartColor(1)} name="ëª¨ì˜ê³ ì‚¬ í‰ê·  ë“±ê¸‰" />
            </BarChart>
          </ResponsiveContainer>
          
          {/* ì°¨ì´ ë¶„ì„ í…Œì´ë¸” */}
          <div className="flex flex-col gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-4">
            <h3 className="text-sm font-semibold text-gray-900 dark:text-gray-100">
              ë“±ê¸‰ ì°¨ì´ ë¶„ì„
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b border-gray-200 dark:border-gray-700">
                    <th className="text-left py-2 px-3 font-semibold text-gray-700 dark:text-gray-300">
                      ê³¼ëª©
                    </th>
                    <th className="text-center py-2 px-3 font-semibold text-gray-700 dark:text-gray-300">
                      ë‚´ì‹ 
                    </th>
                    <th className="text-center py-2 px-3 font-semibold text-gray-700 dark:text-gray-300">
                      ëª¨ì˜ê³ ì‚¬
                    </th>
                    <th className="text-center py-2 px-3 font-semibold text-gray-700 dark:text-gray-300">
                      ì°¨ì´
                    </th>
                    <th className="text-center py-2 px-3 font-semibold text-gray-700 dark:text-gray-300">
                      ë¶„ì„
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {subjectData.map((item) => {
                    const diff = item.ì°¨ì´;
                    const analysis =
                      diff === null
                        ? "-"
                        : diff < -0.5
                        ? "ë‚´ì‹ ì´ ë” ì¢‹ìŒ"
                        : diff > 0.5
                        ? "ëª¨ì˜ê³ ì‚¬ê°€ ë” ì¢‹ìŒ"
                        : "ë¹„ìŠ·í•¨";
                    const analysisColor =
                      diff === null
                        ? "text-gray-500 dark:text-gray-400"
                        : diff < -0.5
                        ? "text-green-600 dark:text-green-400"
                        : diff > 0.5
                        ? "text-orange-600 dark:text-orange-400"
                        : "text-gray-600 dark:text-gray-400";

                    return (
                      <tr
                        key={item.subject}
                        className="border-b border-gray-100 dark:border-gray-700 hover:bg-white dark:hover:bg-gray-800"
                      >
                        <td className="py-2 px-3 font-medium text-gray-900 dark:text-gray-100">
                          {item.subject}
                        </td>
                        <td className="py-2 px-3 text-center text-gray-600 dark:text-gray-400">
                          {item.ë‚´ì‹  !== null ? `${item.ë‚´ì‹ }ë“±ê¸‰` : "-"}
                        </td>
                        <td className="py-2 px-3 text-center text-gray-600 dark:text-gray-400">
                          {item.ëª¨ì˜ê³ ì‚¬ !== null ? `${item.ëª¨ì˜ê³ ì‚¬}ë“±ê¸‰` : "-"}
                        </td>
                        <td className="py-2 px-3 text-center">
                          {diff !== null ? (
                            <span
                              className={`font-semibold ${
                                diff < 0
                                  ? "text-green-600 dark:text-green-400"
                                  : diff > 0
                                  ? "text-red-600 dark:text-red-400"
                                  : "text-gray-600 dark:text-gray-400"
                              }`}
                            >
                              {diff > 0 ? "+" : ""}
                              {diff}ë“±ê¸‰
                            </span>
                          ) : (
                            <span className="text-gray-400 dark:text-gray-500">-</span>
                          )}
                        </td>
                        <td className={`py-2 px-3 text-center font-medium ${analysisColor}`}>
                          {analysis}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="dashboard/_components/MockExamTrendSection.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React, { useState } from "react";
import { Card, CardContent } from "@/components/molecules/Card";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { MockScoreRow } from "../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";
import { EmptyState } from "@/components/molecules/EmptyState";

type MockExamTrendSectionProps = {
  mockScores: MockScoreRow[];
};

type MetricType = "percentile" | "grade_score" | "raw_score";

export function MockExamTrendSection({
  mockScores,
}: MockExamTrendSectionProps) {
  const { recharts, loading } = useRecharts();
  const [metric, setMetric] = useState<MetricType>("percentile");

  // exam_roundë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
  const chartData = React.useMemo(() => {
    const roundMap = new Map<string, MockScoreRow[]>();

    mockScores.forEach((score) => {
      if (!score.exam_round) return;
      const round = score.exam_round;
      if (!roundMap.has(round)) {
        roundMap.set(round, []);
      }
      roundMap.get(round)!.push(score);
    });

    // exam_round ìˆœì„œ ì •ì˜
    const roundOrder = ["3ì›”", "4ì›”", "6ì›”", "9ì›”", "11ì›”", "ì‚¬ì„¤"];
    const sortedRounds = Array.from(roundMap.entries()).sort((a, b) => {
      const indexA = roundOrder.indexOf(a[0]);
      const indexB = roundOrder.indexOf(b[0]);
      if (indexA === -1 && indexB === -1) return 0;
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return indexA - indexB;
    });

    // exam_typeë³„ë¡œ í‰ê·  ê³„ì‚°
    const typeMap = new Map<string, number[]>();

    sortedRounds.forEach(([round, scores]) => {
      scores.forEach((score) => {
        const type = score.exam_type;
        let value: number | null = null;

        if (metric === "percentile" && score.percentile !== null) {
          value = score.percentile;
        } else if (metric === "grade_score" && score.grade_score !== null) {
          value = score.grade_score;
        } else if (metric === "raw_score" && score.raw_score !== null) {
          value = score.raw_score;
        }

        if (value !== null) {
          if (!typeMap.has(`${round}_${type}`)) {
            typeMap.set(`${round}_${type}`, []);
          }
          typeMap.get(`${round}_${type}`)!.push(value);
        }
      });
    });

    // ì°¨íŠ¸ ë°ì´í„° ìƒì„±
    const result: Array<Record<string, number | null | string>> = [];

    sortedRounds.forEach(([round]) => {
      const dataPoint: Record<string, number | null | string> = { round };
      const types = ["í‰ê°€ì›", "êµìœ¡ì²­", "ì‚¬ì„¤"];

      types.forEach((type) => {
        const key = `${round}_${type}`;
        const values = typeMap.get(key);
        if (values && values.length > 0) {
          const avg = values.reduce((a, b) => a + b, 0) / values.length;
          dataPoint[type] = Number(avg.toFixed(1));
        } else {
          dataPoint[type] = null;
        }
      });

      result.push(dataPoint);
    });

    return result;
  }, [mockScores, metric]);

  const hasData = mockScores.length > 0 && chartData.length > 0;

  if (!hasData) {
    return (
      <EmptyState
        icon="ğŸ“Š"
        title="ëª¨ì˜ê³ ì‚¬ ì„±ì  íŠ¸ë Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"
        description="ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ë“±ë¡í•˜ë©´ ë³€í™” ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤."
      />
    );
  }

  const metricLabel =
    metric === "percentile"
      ? "ë°±ë¶„ìœ„"
      : metric === "grade_score"
      ? "ë“±ê¸‰"
      : "ì›ì ìˆ˜";

  const yAxisDomain =
    metric === "percentile"
      ? [0, 100]
      : metric === "grade_score"
      ? [1, 9]
      : undefined;

  const yAxisReversed = metric === "grade_score";

  if (loading || !recharts) {
    return (
      <Card padding="md">
        <CardContent className="flex flex-col gap-4">
          <ChartLoadingSkeleton height={400} />
        </CardContent>
      </Card>
    );
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;

  return (
    <Card padding="md">
      <CardContent className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <h2 className="text-h2 text-text-primary">
          ëª¨ì˜ê³ ì‚¬ ì„±ì  íŠ¸ë Œë“œ
        </h2>
        <div className="flex gap-2">
          <button
            onClick={() => setMetric("percentile")}
            className={`rounded-lg px-3 py-1.5 text-body-2 font-medium transition ${
              metric === "percentile"
                ? "bg-primary-600 text-white"
                : "bg-secondary-100 text-text-secondary hover:bg-secondary-200"
            }`}
          >
            ë°±ë¶„ìœ„
          </button>
          <button
            onClick={() => setMetric("grade_score")}
            className={`rounded-lg px-3 py-1.5 text-body-2 font-medium transition ${
              metric === "grade_score"
                ? "bg-primary-600 text-white"
                : "bg-secondary-100 text-text-secondary hover:bg-secondary-200"
            }`}
          >
            ë“±ê¸‰
          </button>
          <button
            onClick={() => setMetric("raw_score")}
            className={`rounded-lg px-3 py-1.5 text-body-2 font-medium transition ${
              metric === "raw_score"
                ? "bg-primary-600 text-white"
                : "bg-secondary-100 text-text-secondary hover:bg-secondary-200"
            }`}
          >
            ì›ì ìˆ˜
          </button>
        </div>
      </div>
      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="round" />
          <YAxis
            domain={yAxisDomain}
            reversed={yAxisReversed}
            label={{
              value: metricLabel,
              angle: -90,
              position: "insideLeft",
            }}
          />
          <Tooltip
            formatter={(value: any) => {
              if (value === null || value === undefined) return "ë°ì´í„° ì—†ìŒ";
              if (metric === "percentile") return `${value}%`;
              if (metric === "grade_score") return `${value}ë“±ê¸‰`;
              return value;
            }}
          />
          <Legend />
          <Line
            type="monotone"
            dataKey="í‰ê°€ì›"
            stroke={getChartColor(0)}
            strokeWidth={2}
            name="í‰ê°€ì›"
            dot={{ r: 4 }}
            connectNulls={false}
          />
          <Line
            type="monotone"
            dataKey="êµìœ¡ì²­"
            stroke={getChartColor(1)}
            strokeWidth={2}
            name="êµìœ¡ì²­"
            dot={{ r: 4 }}
            connectNulls={false}
          />
          <Line
            type="monotone"
            dataKey="ì‚¬ì„¤"
            stroke={getChartColor(2)}
            strokeWidth={2}
            name="ì‚¬ì„¤"
            dot={{ r: 4 }}
            connectNulls={false}
          />
        </LineChart>
      </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
</file>

<file path="dashboard/_components/ScoreConsistencyAnalysis.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React from "react";
import type { SchoolScoreRow, MockScoreRow } from "../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";

type ScoreConsistencyAnalysisProps = {
  schoolScores: SchoolScoreRow[];
  mockScores: MockScoreRow[];
};

export function ScoreConsistencyAnalysis({
  schoolScores,
  mockScores,
}: ScoreConsistencyAnalysisProps) {
  // ë‚´ì‹  ì„±ì  ì¼ê´€ì„± ë¶„ì„
  const schoolConsistency = React.useMemo(() => {
    if (schoolScores.length === 0) return null;

    const validGrades = schoolScores
      .map((s) => s.grade_score)
      .filter((g): g is number => g !== null && g !== undefined);

    if (validGrades.length < 2) return null;

    const mean = validGrades.reduce((a, b) => a + b, 0) / validGrades.length;
    const variance =
      validGrades.reduce((sum, grade) => sum + Math.pow(grade - mean, 2), 0) /
      validGrades.length;
    const stdDev = Math.sqrt(variance);

    // ì¼ê´€ì„± ì ìˆ˜ (í‘œì¤€í¸ì°¨ê°€ ë‚®ì„ìˆ˜ë¡ ë†’ìŒ, 0-100ì )
    const consistencyScore = Math.max(0, 100 - stdDev * 20);

    let level: "high" | "medium" | "low" = "medium";
    if (consistencyScore >= 80) level = "high";
    else if (consistencyScore < 50) level = "low";

    return {
      mean: Number(mean.toFixed(1)),
      stdDev: Number(stdDev.toFixed(2)),
      consistencyScore: Number(consistencyScore.toFixed(1)),
      level,
    };
  }, [schoolScores]);

  // ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¼ê´€ì„± ë¶„ì„
  const mockConsistency = React.useMemo(() => {
    if (mockScores.length === 0) return null;

    const validPercentiles = mockScores
      .map((s) => s.percentile)
      .filter((p): p is number => p !== null && p !== undefined);

    if (validPercentiles.length < 2) return null;

    const mean = validPercentiles.reduce((a, b) => a + b, 0) / validPercentiles.length;
    const variance =
      validPercentiles.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) /
      validPercentiles.length;
    const stdDev = Math.sqrt(variance);

    // ì¼ê´€ì„± ì ìˆ˜ (í‘œì¤€í¸ì°¨ê°€ ë‚®ì„ìˆ˜ë¡ ë†’ìŒ, 0-100ì )
    const consistencyScore = Math.max(0, 100 - (stdDev / 100) * 100);

    let level: "high" | "medium" | "low" = "medium";
    if (consistencyScore >= 80) level = "high";
    else if (consistencyScore < 50) level = "low";

    return {
      mean: Number(mean.toFixed(1)),
      stdDev: Number(stdDev.toFixed(2)),
      consistencyScore: Number(consistencyScore.toFixed(1)),
      level,
    };
  }, [mockScores]);

  // ë‚´ì‹ ê³¼ ëª¨ì˜ê³ ì‚¬ ê°„ ì¼ê´€ì„±
  const crossConsistency = React.useMemo(() => {
    if (schoolScores.length === 0 || mockScores.length === 0) return null;

    const comparableSubjects = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´"];
    const differences: number[] = [];

    comparableSubjects.forEach((subject) => {
      const schoolScoresForSubject = schoolScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );
      const mockScoresForSubject = mockScores.filter(
        (s) => s.subject_group === subject && s.grade_score !== null
      );

      if (schoolScoresForSubject.length > 0 && mockScoresForSubject.length > 0) {
        const schoolAvg =
          schoolScoresForSubject.reduce(
            (sum, s) => sum + (s.grade_score ?? 0),
            0
          ) / schoolScoresForSubject.length;
        const mockAvg =
          mockScoresForSubject.reduce(
            (sum, s) => sum + (s.grade_score ?? 0),
            0
          ) / mockScoresForSubject.length;

        differences.push(Math.abs(schoolAvg - mockAvg));
      }
    });

    if (differences.length === 0) return null;

    const avgDiff = differences.reduce((a, b) => a + b, 0) / differences.length;
    const consistencyScore = Math.max(0, 100 - avgDiff * 20);

    let level: "high" | "medium" | "low" = "medium";
    if (consistencyScore >= 80) level = "high";
    else if (consistencyScore < 50) level = "low";

    return {
      avgDiff: Number(avgDiff.toFixed(2)),
      consistencyScore: Number(consistencyScore.toFixed(1)),
      level,
    };
  }, [schoolScores, mockScores]);

  const getLevelColor = (level: "high" | "medium" | "low") => {
    if (level === "high") return "text-green-600 bg-green-50 border-green-200";
    if (level === "low") return "text-red-600 bg-red-50 border-red-200";
    return "text-yellow-600 bg-yellow-50 border-yellow-200";
  };

  const getLevelText = (level: "high" | "medium" | "low") => {
    if (level === "high") return "ë†’ìŒ";
    if (level === "low") return "ë‚®ìŒ";
    return "ë³´í†µ";
  };

  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {/* ë‚´ì‹  ì¼ê´€ì„± */}
      {schoolConsistency && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-3">
              <h3 className="text-base font-semibold text-gray-900">
                ë‚´ì‹  ì„±ì  ì¼ê´€ì„±
              </h3>
              <div className="flex flex-col gap-3">
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">ì¼ê´€ì„± ì ìˆ˜</span>
                <span className="text-2xl font-bold text-gray-900">
                  {schoolConsistency.consistencyScore}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">í‰ê·  ë“±ê¸‰</span>
                <span className="text-sm font-medium text-gray-900">
                  {schoolConsistency.mean}ë“±ê¸‰
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">í‘œì¤€í¸ì°¨</span>
                <span className="text-sm font-medium text-gray-900">
                  {schoolConsistency.stdDev}
                </span>
              </div>
              <div
                className={`rounded-lg border p-3 text-center ${getLevelColor(
                  schoolConsistency.level
                )}`}
              >
                <span className="text-sm font-semibold">
                  {getLevelText(schoolConsistency.level)}
                </span>
              </div>
            </div>
          </div>
          </div>
        </Card>
      )}

      {/* ëª¨ì˜ê³ ì‚¬ ì¼ê´€ì„± */}
      {mockConsistency && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-3">
              <h3 className="text-base font-semibold text-gray-900">
                ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¼ê´€ì„±
              </h3>
              <div className="flex flex-col gap-3">
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">ì¼ê´€ì„± ì ìˆ˜</span>
                <span className="text-2xl font-bold text-gray-900">
                  {mockConsistency.consistencyScore}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">í‰ê·  ë°±ë¶„ìœ„</span>
                <span className="text-sm font-medium text-gray-900">
                  {mockConsistency.mean}%
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">í‘œì¤€í¸ì°¨</span>
                <span className="text-sm font-medium text-gray-900">
                  {mockConsistency.stdDev}
                </span>
              </div>
              <div
                className={`rounded-lg border p-3 text-center ${getLevelColor(
                  mockConsistency.level
                )}`}
              >
                <span className="text-sm font-semibold">
                  {getLevelText(mockConsistency.level)}
                </span>
              </div>
            </div>
          </div>
          </div>
        </Card>
      )}

      {/* ë‚´ì‹ -ëª¨ì˜ê³ ì‚¬ ê°„ ì¼ê´€ì„± */}
      {crossConsistency && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-3">
              <h3 className="text-base font-semibold text-gray-900">
                ë‚´ì‹ -ëª¨ì˜ê³ ì‚¬ ì¼ê´€ì„±
              </h3>
              <div className="flex flex-col gap-3">
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">ì¼ê´€ì„± ì ìˆ˜</span>
                <span className="text-2xl font-bold text-gray-900">
                  {crossConsistency.consistencyScore}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-600">í‰ê·  ë“±ê¸‰ ì°¨ì´</span>
                <span className="text-sm font-medium text-gray-900">
                  {crossConsistency.avgDiff}ë“±ê¸‰
                </span>
              </div>
              <div className="text-xs text-gray-500">
                í•µì‹¬ ê³¼ëª©(êµ­ì–´, ìˆ˜í•™, ì˜ì–´)ì˜
                <br />
                ë‚´ì‹ -ëª¨ì˜ê³ ì‚¬ ë“±ê¸‰ ì°¨ì´ ê¸°ì¤€
              </div>
              <div
                className={`rounded-lg border p-3 text-center ${getLevelColor(
                  crossConsistency.level
                )}`}
              >
                <span className="text-sm font-semibold">
                  {getLevelText(crossConsistency.level)}
                </span>
              </div>
            </div>
          </div>
          </div>
        </Card>
      )}

      {!schoolConsistency && !mockConsistency && !crossConsistency && (
        <div className="col-span-full rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
          <div className="mx-auto flex max-w-md flex-col gap-4">
            <div className="text-6xl">ğŸ“Š</div>
            <div className="flex flex-col gap-2">
              <h3 className="text-lg font-semibold text-gray-900">
                ì¼ê´€ì„± ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
              </h3>
              <p className="text-sm text-gray-500">
                ì¶©ë¶„í•œ ì„±ì  ë°ì´í„°ë¥¼ ë“±ë¡í•˜ë©´ ì¼ê´€ì„± ë¶„ì„ì´ ì œê³µë©ë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="dashboard/_components/ScoreTypeComparison.tsx">
import type { ScoreTypeComparison as ScoreTypeComparisonData } from "../_utils";

type ScoreTypeComparisonProps = {
  data: ScoreTypeComparisonData[];
};

export function ScoreTypeComparison({ data }: ScoreTypeComparisonProps) {
  if (data.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center text-sm text-gray-500 shadow-sm">
        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {data.map((item) => (
        <div
          key={item.score_type}
          className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-6 shadow-sm"
        >
          <h3 className="text-lg font-semibold text-gray-900">
            {item.score_type}
          </h3>
          <div className="flex flex-col gap-2">
            <div>
              <p className="text-xs text-gray-500">í‰ê·  ë“±ê¸‰</p>
              <p className="text-2xl font-bold text-indigo-600">
                {item.averageGrade.toFixed(1)}ë“±ê¸‰
              </p>
            </div>
            {item.averageRawScore > 0 && (
              <div>
                <p className="text-xs text-gray-500">í‰ê·  ì›ì ìˆ˜</p>
                <p className="text-xl font-semibold text-gray-900">
                  {item.averageRawScore.toFixed(1)}ì 
                </p>
              </div>
            )}
            <div>
              <p className="text-xs text-gray-500">ì„±ì  ê°œìˆ˜</p>
              <p className="text-sm text-gray-700">{item.count}ê°œ</p>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="dashboard/_components/SemesterChartsSection.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React from "react";
import { Card, CardContent } from "@/components/molecules/Card";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SchoolScoreRow } from "../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";
import { EmptyState } from "@/components/molecules/EmptyState";

type SemesterChartsSectionProps = {
  schoolScores: SchoolScoreRow[];
};

export function SemesterChartsSection({
  schoolScores,
}: SemesterChartsSectionProps) {
  const { recharts, loading } = useRecharts();
  // í•™ë…„Â·í•™ê¸°ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
  const chartData = React.useMemo(() => {
    const grouped = new Map<string, SchoolScoreRow[]>();

    schoolScores.forEach((score) => {
      if (!score.grade || !score.semester) return;
      const key = `${score.grade}í•™ë…„ ${score.semester}í•™ê¸°`;
      if (!grouped.has(key)) {
        grouped.set(key, []);
      }
      grouped.get(key)!.push(score);
    });

    // ê° í•™ê¸°ë³„ë¡œ í‰ê·  ë“±ê¸‰ ê³„ì‚°
    const result: Array<{
      period: string;
      averageGrade: number;
      count: number;
    }> = [];

    grouped.forEach((scores, period) => {
      const validGrades = scores
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);
      if (validGrades.length === 0) return;

      const average =
        validGrades.reduce((a, b) => a + b, 0) / validGrades.length;
      result.push({
        period,
        averageGrade: Number(average.toFixed(1)),
        count: validGrades.length,
      });
    });

    // í•™ë…„Â·í•™ê¸° ìˆœì„œë¡œ ì •ë ¬
    return result.sort((a, b) => {
      const aMatch = a.period.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      const bMatch = b.period.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      if (!aMatch || !bMatch) return 0;
      const aGrade = parseInt(aMatch[1]);
      const bGrade = parseInt(bMatch[1]);
      if (aGrade !== bGrade) return aGrade - bGrade;
      const aSemester = parseInt(aMatch[2]);
      const bSemester = parseInt(bMatch[2]);
      return aSemester - bSemester;
    });
  }, [schoolScores]);

  if (schoolScores.length === 0 || chartData.length === 0) {
    return (
      <EmptyState
        icon="ğŸ“ˆ"
        title="ë‚´ì‹  í•™ê¸°ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"
        description="ë‚´ì‹  ì„±ì ì„ ë“±ë¡í•˜ë©´ í•™ê¸°ë³„ ë³€í™” ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤."
      />
    );
  }

  if (loading || !recharts) {
    return (
      <Card padding="md">
        <CardContent className="flex flex-col gap-4">
          <ChartLoadingSkeleton height={400} />
        </CardContent>
      </Card>
    );
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;

  return (
    <Card padding="md">
      <CardContent className="flex flex-col gap-4">
        <h2 className="text-h2 text-text-primary">
          ë‚´ì‹  í•™ê¸°ë³„ ë³€í™”
        </h2>
      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis
            dataKey="period"
            angle={-45}
            textAnchor="end"
            height={80}
            interval={0}
          />
          <YAxis
            domain={[1, 9]}
            reversed
            label={{ value: "í‰ê·  ë“±ê¸‰", angle: -90, position: "insideLeft" }}
          />
          <Tooltip
            formatter={(value: number) => [`${value}ë“±ê¸‰`, "í‰ê·  ë“±ê¸‰"]}
            labelFormatter={(label) => `ê¸°ê°„: ${label}`}
          />
          <Legend />
          <Line
            type="monotone"
            dataKey="averageGrade"
            stroke={getChartColor(0)}
            strokeWidth={2}
            name="í‰ê·  ë“±ê¸‰"
            dot={{ r: 6 }}
            activeDot={{ r: 8 }}
          />
        </LineChart>
      </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
</file>

<file path="dashboard/_components/SemesterSummaryTable.tsx">
import type { SemesterSummary } from "../_utils";

type SemesterSummaryTableProps = {
  data: SemesterSummary[];
};

export function SemesterSummaryTable({
  data,
}: SemesterSummaryTableProps) {
  if (data.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center text-sm text-gray-500 shadow-sm">
        í•™ê¸°ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  return (
    <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
      <table className="w-full">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
              í•™ê¸°
            </th>
            <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
              ì„±ì  ê°œìˆ˜
            </th>
            <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
              í‰ê·  ë“±ê¸‰
            </th>
            <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
              í‰ê·  ì›ì ìˆ˜
            </th>
            <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
              êµê³¼ ëª©ë¡
            </th>
          </tr>
        </thead>
        <tbody className="divide-y divide-gray-200">
          {data.map((summary) => (
            <tr key={summary.semester} className="hover:bg-gray-50">
              <td className="px-4 py-3 text-sm font-medium text-gray-900">
                {summary.semester}
              </td>
              <td className="px-4 py-3 text-sm text-gray-700">
                {summary.totalScores}ê°œ
              </td>
              <td className="px-4 py-3 text-sm text-gray-900">
                <span className="font-semibold">
                  {summary.averageGrade.toFixed(1)}ë“±ê¸‰
                </span>
              </td>
              <td className="px-4 py-3 text-sm text-gray-700">
                {summary.averageRawScore > 0
                  ? `${summary.averageRawScore.toFixed(1)}ì `
                  : "-"}
              </td>
              <td className="px-4 py-3 text-sm text-gray-700">
                <div className="flex flex-wrap gap-1">
                  {summary.courses.map((course) => (
                    <span
                      key={course}
                      className="rounded bg-gray-100 px-2 py-1 text-xs"
                    >
                      {course}
                    </span>
                  ))}
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="dashboard/_components/SubjectGradeHistoryChart.tsx">
"use client";

import { useState } from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SubjectGradeHistory } from "../_utils";
import { getChartColor } from "@/lib/constants/colors";

type SubjectGradeHistoryChartProps = {
  data: SubjectGradeHistory[];
};

export function SubjectGradeHistoryChart({
  data,
}: SubjectGradeHistoryChartProps) {
  const { recharts, loading } = useRecharts();
  const [selectedSubjects, setSelectedSubjects] = useState<string[]>(
    data.slice(0, 5).map((d) => `${d.course}:${d.course_detail}`)
  );

  if (data.length === 0) {
    return (
      <div className="p-8 text-center text-sm text-gray-500">
        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={400} />;
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;

  // ëª¨ë“  ì‹œí—˜ì¼ ìˆ˜ì§‘
  const allDates = new Set<string>();
  data.forEach((subject) => {
    subject.history.forEach((h) => {
      if (h.test_date) allDates.add(h.test_date);
    });
  });

  const sortedDates = Array.from(allDates).sort();

  // ì°¨íŠ¸ ë°ì´í„° ìƒì„±
  const chartData = sortedDates.map((date) => {
    const point: Record<string, any> = { date: date.slice(5) }; // MM-DD í˜•ì‹
    data.forEach((subject) => {
      const key = `${subject.course}:${subject.course_detail}`;
      if (selectedSubjects.includes(key)) {
        const historyPoint = subject.history.find((h) => h.test_date === date);
        point[key] = historyPoint ? historyPoint.grade : null;
      }
    });
    return point;
  });

  const handleSubjectToggle = (key: string) => {
    setSelectedSubjects((prev) =>
      prev.includes(key)
        ? prev.filter((k) => k !== key)
        : [...prev, key].slice(0, 8) // ìµœëŒ€ 8ê°œê¹Œì§€ë§Œ
    );
  };

  return (
    <div className="flex flex-col gap-4">
      {/* ê³¼ëª© ì„ íƒ ì²´í¬ë°•ìŠ¤ */}
      <div className="flex flex-wrap gap-3">
        {data.map((subject, index) => {
          const key = `${subject.course}:${subject.course_detail}`;
          const isSelected = selectedSubjects.includes(key);
          return (
            <label
              key={key}
              className="flex items-center gap-2 cursor-pointer"
            >
              <input
                type="checkbox"
                checked={isSelected}
                onChange={() => handleSubjectToggle(key)}
                className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"
              />
              <span
                className={`text-sm ${isSelected ? "text-chart-" + (index % 8) : "text-secondary-500"}`}
              >
                {subject.course_detail}
              </span>
            </label>
          );
        })}
      </div>

      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis
            dataKey="date"
            angle={-45}
            textAnchor="end"
            height={80}
            interval={0}
          />
          <YAxis
            domain={[1, 9]}
            reversed
            label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
          />
          <Tooltip
            formatter={(value: any) => {
              if (value === null || value === undefined) return "ë°ì´í„° ì—†ìŒ";
              return `${value}ë“±ê¸‰`;
            }}
          />
          <Legend />
          {data.map((subject, index) => {
            const key = `${subject.course}:${subject.course_detail}`;
            if (!selectedSubjects.includes(key)) return null;
            return (
              <Line
                key={key}
                type="monotone"
                dataKey={key}
                stroke={getChartColor(index)}
                strokeWidth={2}
                name={subject.course_detail}
                connectNulls={false}
              />
            );
          })}
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
</file>

<file path="dashboard/_components/SubjectTrendSection.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React, { useState } from "react";
import { Card, CardContent } from "@/components/molecules/Card";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SchoolScoreRow } from "../_utils/scoreQueries";
import { EmptyState } from "@/components/molecules/EmptyState";

type SubjectTrendSectionProps = {
  schoolScores: SchoolScoreRow[];
};

const SUBJECT_GROUPS = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ì‚¬íšŒ", "ê³¼í•™"];
const COLORS = ["#6366f1", "#8b5cf6", "#ec4899", "#f59e0b", "#10b981"];

export function SubjectTrendSection({
  schoolScores,
}: SubjectTrendSectionProps) {
  const { recharts, loading } = useRecharts();
  const [showAll, setShowAll] = useState(false);

  // êµê³¼ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™” ë° ìµœê·¼ ì„±ì  ì¶”ì¶œ
  const chartData = React.useMemo(() => {
    const subjectMap = new Map<string, SchoolScoreRow[]>();

    schoolScores.forEach((score) => {
      if (!score.subject_group || score.grade_score === null) return;
      if (!subjectMap.has(score.subject_group)) {
        subjectMap.set(score.subject_group, []);
      }
      subjectMap.get(score.subject_group)!.push(score);
    });

    // ê° êµê³¼ë³„ë¡œ í•™ë…„/í•™ê¸° ìˆœ ì •ë ¬
    subjectMap.forEach((scores, group) => {
      scores.sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return a.grade - b.grade;
        if (a.semester !== b.semester) return a.semester - b.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateA - dateB;
      });
    });

    // í•™ë…„/í•™ê¸°ë³„ë¡œ ë°ì´í„° í¬ì¸íŠ¸ ìƒì„±
    const dateMap = new Map<string, Record<string, number | null>>();

    subjectMap.forEach((scores, group) => {
      const displayScores = showAll ? scores : scores.slice(-3); // ìµœê·¼ 3ê°œ ë˜ëŠ” ì „ì²´

      displayScores.forEach((score) => {
        const dateKey = `${score.grade}í•™ë…„ ${score.semester}í•™ê¸°`;

        if (!dateMap.has(dateKey)) {
          dateMap.set(dateKey, {});
        }
        dateMap.get(dateKey)![group] = score.grade_score;
      });
    });

    // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
    const sortedDates = Array.from(dateMap.entries()).sort((a, b) => {
      const dateA = new Date(a[0]).getTime();
      const dateB = new Date(b[0]).getTime();
      return dateA - dateB;
    });

    return sortedDates.map(([date, values]) => ({
      date,
      ...values,
    }));
  }, [schoolScores, showAll]);

  const availableSubjects = React.useMemo(() => {
    const subjects = new Set<string>();
    schoolScores.forEach((score) => {
      if (score.subject_group) subjects.add(score.subject_group);
    });
    return Array.from(subjects).filter((s) => SUBJECT_GROUPS.includes(s));
  }, [schoolScores]);

  if (schoolScores.length === 0 || availableSubjects.length === 0) {
    return (
      <EmptyState
        icon="ğŸ“ˆ"
        title="êµê³¼ë³„ ì„±ì  íŠ¸ë Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"
        description="ë‚´ì‹  ì„±ì ì„ ë“±ë¡í•˜ë©´ êµê³¼ë³„ ë³€í™” ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤."
      />
    );
  }

  if (loading || !recharts) {
    return (
      <Card padding="md">
        <CardContent className="flex flex-col gap-4">
          <ChartLoadingSkeleton height={400} />
        </CardContent>
      </Card>
    );
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;

  return (
    <Card padding="md">
      <CardContent className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <h2 className="text-h2 text-text-primary">
          êµê³¼ë³„ ì„±ì  ë³€í™”
        </h2>
        <label className="flex items-center gap-2 text-body-2 text-text-secondary">
          <input
            type="checkbox"
            checked={showAll}
            onChange={(e) => setShowAll(e.target.checked)}
            className="h-4 w-4 rounded border-secondary-300 text-primary-600 focus:ring-primary-500"
          />
          <span>ì „ì²´ í‘œì‹œ</span>
        </label>
      </div>
      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis
            dataKey="date"
            angle={-45}
            textAnchor="end"
            height={80}
            interval={0}
          />
          <YAxis
            domain={[1, 9]}
            reversed
            label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
          />
          <Tooltip
            formatter={(value: any) => {
              if (value === null || value === undefined) return "ë°ì´í„° ì—†ìŒ";
              return `${value}ë“±ê¸‰`;
            }}
          />
          <Legend />
          {availableSubjects.map((subject, index) => (
            <Line
              key={subject}
              type="monotone"
              dataKey={subject}
              stroke={COLORS[index % COLORS.length]}
              strokeWidth={2}
              name={subject}
              connectNulls={false}
              dot={{ r: 4 }}
            />
          ))}
        </LineChart>
      </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
</file>

<file path="dashboard/_components/SummarySection.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 * ìƒˆë¡œìš´ ëŒ€ì‹œë³´ë“œëŠ” /api/students/[id]/score-dashboard APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
"use client";

import React from "react";
import type { SchoolScoreRow, MockScoreRow } from "../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";
import { getGradeColor, getTrendColor } from "@/lib/constants/colors";

type SummarySectionProps = {
  schoolScores: SchoolScoreRow[];
  mockScores: MockScoreRow[];
};

export function SummarySection({
  schoolScores,
  mockScores,
}: SummarySectionProps) {
  // ë‚´ì‹  í‰ê·  ë“±ê¸‰ ê³„ì‚°
  const schoolAverageGrade = React.useMemo(() => {
    if (schoolScores.length === 0) return null;
    const validGrades = schoolScores
      .map((s) => s.grade_score)
      .filter((g): g is number => g !== null && g !== undefined);
    if (validGrades.length === 0) return null;
    const sum = validGrades.reduce((a, b) => a + b, 0);
    return sum / validGrades.length;
  }, [schoolScores]);

  // ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„ ê³„ì‚°
  const mockAveragePercentile = React.useMemo(() => {
    if (mockScores.length === 0) return null;
    const validPercentiles = mockScores
      .map((s) => s.percentile)
      .filter((p): p is number => p !== null && p !== undefined);
    if (validPercentiles.length === 0) return null;
    const sum = validPercentiles.reduce((a, b) => a + b, 0);
    return sum / validPercentiles.length;
  }, [mockScores]);

  // ìµœê·¼ ë‚´ì‹  ì„±ì  (ìµœì‹  2ê°œ)
  const recentSchoolScores = React.useMemo(() => {
    const sorted = [...schoolScores]
      .filter((s) => s.grade_score !== null)
      .sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        if (a.semester !== b.semester) return b.semester - a.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });
    return sorted.slice(0, 2);
  }, [schoolScores]);

  // ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  (ìµœì‹  2ê°œ)
  const recentMockScores = React.useMemo(() => {
    const sorted = [...mockScores]
      .filter((s) => s.percentile !== null)
      .sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });
    return sorted.slice(0, 2);
  }, [mockScores]);

  // ë‚´ì‹  ì¶”ì„¸ ê³„ì‚°
  const schoolTrend = React.useMemo(() => {
    if (recentSchoolScores.length < 2) return null;
    const [latest, previous] = recentSchoolScores;
    if (!latest.grade_score || !previous.grade_score) return null;
    // ë“±ê¸‰ì€ ë‚®ì„ìˆ˜ë¡ ì¢‹ìœ¼ë¯€ë¡œ, ë“±ê¸‰ì´ ë‚®ì•„ì§€ë©´(ìˆ«ìê°€ ì‘ì•„ì§€ë©´) ê°œì„ 
    return latest.grade_score < previous.grade_score
      ? "improved"
      : latest.grade_score > previous.grade_score
      ? "declined"
      : "stable";
  }, [recentSchoolScores]);

  // ëª¨ì˜ê³ ì‚¬ ì¶”ì„¸ ê³„ì‚°
  const mockTrend = React.useMemo(() => {
    if (recentMockScores.length < 2) return null;
    const [latest, previous] = recentMockScores;
    if (!latest.percentile || !previous.percentile) return null;
    return latest.percentile > previous.percentile
      ? "improved"
      : latest.percentile < previous.percentile
      ? "declined"
      : "stable";
  }, [recentMockScores]);

  const hasData = schoolScores.length > 0 || mockScores.length > 0;

  if (!hasData) {
    return (
      <Card>
        <div className="flex flex-col items-center justify-center gap-4 p-8 text-center">
          <div className="text-6xl">ğŸ“Š</div>
          <div className="flex flex-col gap-2">
            <h3 className="text-lg font-semibold text-gray-900">
              ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </h3>
            <p className="text-sm text-gray-600">
              ë‚´ì‹  ë˜ëŠ” ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ë“±ë¡í•˜ë©´ ìš”ì•½ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </Card>
    );
  }

  const schoolGradeColor = getGradeColor(
    schoolAverageGrade ? Math.round(schoolAverageGrade) : null
  );
  const trendColor = getTrendColor(schoolTrend);

  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {/* ë‚´ì‹  í‰ê·  ë“±ê¸‰ */}
      <Card>
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-600">ë‚´ì‹  í‰ê·  ë“±ê¸‰</p>
              <div className="flex items-baseline gap-2">
                {schoolAverageGrade !== null ? (
                  <>
                    <span
                      className={`text-3xl font-bold ${schoolGradeColor.text}`}
                    >
                      {schoolAverageGrade.toFixed(1)}
                    </span>
                    <span className="text-lg text-gray-500">ë“±ê¸‰</span>
                  </>
                ) : (
                  <span className="text-3xl font-bold text-gray-400">-</span>
                )}
              </div>
              {schoolScores.length > 0 && (
                <p className="text-xs text-gray-500">
                  {schoolScores.length}ê°œ ì„±ì  ê¸°ì¤€
                </p>
              )}
            </div>
            <div className="text-4xl">ğŸ“š</div>
          </div>
          {schoolTrend && (
            <div
              className={`flex items-center gap-2 rounded-lg px-3 py-2 ${trendColor.bg}`}
            >
              <span className={`text-sm font-medium ${trendColor.text}`}>
                {trendColor.icon}
              </span>
              <span className={`text-sm font-medium ${trendColor.text}`}>
                {schoolTrend === "improved"
                  ? "ê°œì„ "
                  : schoolTrend === "declined"
                  ? "í•˜ë½"
                  : "ìœ ì§€"}
              </span>
            </div>
          )}
        </div>
      </Card>

      {/* ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„ */}
      <Card>
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-600">
                ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„
              </p>
              <div className="flex items-baseline gap-2">
                {mockAveragePercentile !== null ? (
                  <>
                    <span className="text-3xl font-bold text-indigo-600">
                      {mockAveragePercentile.toFixed(1)}
                    </span>
                    <span className="text-lg text-gray-500">%</span>
                  </>
                ) : (
                  <span className="text-3xl font-bold text-gray-400">-</span>
                )}
              </div>
              {mockScores.length > 0 && (
                <p className="text-xs text-gray-500">
                  {mockScores.length}ê°œ ì„±ì  ê¸°ì¤€
                </p>
              )}
            </div>
            <div className="text-4xl">ğŸ“Š</div>
          </div>
          {mockTrend && (
            <div
              className={`flex items-center gap-2 rounded-lg px-3 py-2 ${getTrendColor(mockTrend).bg}`}
            >
              <span
                className={`text-sm font-medium ${getTrendColor(mockTrend).text}`}
              >
                {getTrendColor(mockTrend).icon}
              </span>
              <span
                className={`text-sm font-medium ${getTrendColor(mockTrend).text}`}
              >
                {mockTrend === "improved"
                  ? "ê°œì„ "
                  : mockTrend === "declined"
                  ? "í•˜ë½"
                  : "ìœ ì§€"}
              </span>
            </div>
          )}
        </div>
      </Card>

      {/* ìµœê·¼ ë‚´ì‹  ì„±ì  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">ìµœê·¼ ë‚´ì‹  ì„±ì </p>
          {recentSchoolScores.length > 0 ? (
            <div className="flex flex-col gap-2">
              {recentSchoolScores.map((score) => {
                const gradeColor = getGradeColor(score.grade_score);
                return (
                  <div
                    key={score.id}
                    className={`flex items-center justify-between rounded-lg border px-3 py-2 ${gradeColor.border} ${gradeColor.bg}`}
                  >
                    <span className="text-xs text-gray-600">
                      {score.grade}í•™ë…„ {score.semester}í•™ê¸°
                    </span>
                    <span
                      className={`rounded-full px-2 py-1 text-sm font-semibold ${gradeColor.badge}`}
                    >
                      {score.grade_score !== null
                        ? `${score.grade_score}ë“±ê¸‰`
                        : "-"}
                    </span>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>

      {/* ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì </p>
          {recentMockScores.length > 0 ? (
            <div className="flex flex-col gap-2">
              {recentMockScores.map((score) => {
                const gradeColor = getGradeColor(score.grade_score);
                return (
                  <div
                    key={score.id}
                    className="flex items-center justify-between rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-2"
                  >
                    <span className="text-xs text-gray-600">
                      {score.grade}í•™ë…„
                    </span>
                    <div className="flex items-center gap-2">
                      {score.percentile !== null && (
                        <span className="text-sm font-semibold text-indigo-700">
                          {score.percentile.toFixed(1)}%
                        </span>
                      )}
                      {score.grade_score !== null && (
                        <span
                          className={`rounded-full px-2 py-1 text-xs font-semibold ${gradeColor.badge}`}
                        >
                          {score.grade_score}ë“±ê¸‰
                        </span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="dashboard/_components/WeakSubjectSection.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */
"use client";

import React from "react";
import type { SchoolScoreRow, MockScoreRow } from "../_utils/scoreQueries";
import { EmptyState } from "@/components/molecules/EmptyState";

type WeakSubjectSectionProps = {
  schoolScores: SchoolScoreRow[];
  mockScores: MockScoreRow[];
};

type WeakSubject = {
  subject: string;
  type: "school" | "mock";
  riskScore: number;
  reasons: string[];
  recentGrades: number[];
  averageGrade: number;
};

export function WeakSubjectSection({
  schoolScores,
  mockScores,
}: WeakSubjectSectionProps) {
  const weakSubjects = React.useMemo(() => {
    const results: WeakSubject[] = [];

    // ë‚´ì‹  ì·¨ì•½ ê³¼ëª© ë¶„ì„
    const schoolBySubject = new Map<string, SchoolScoreRow[]>();
    schoolScores.forEach((score) => {
      if (!score.subject_group || score.grade_score === null) return;
      const key = score.subject_group;
      if (!schoolBySubject.has(key)) {
        schoolBySubject.set(key, []);
      }
      schoolBySubject.get(key)!.push(score);
    });

    schoolBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        if (a.semester !== b.semester) return b.semester - a.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA; // ìµœì‹ ìˆœ
      });

      const recent3 = sorted.slice(0, 3);
      const recentGrades = recent3
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null);

      if (recentGrades.length === 0) return;

      const averageGrade =
        recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length;

      const reasons: string[] = [];
      let riskScore = 0;

      // 1. ìµœê·¼ 3íšŒ í‰ê·  ê¸°ì¤€ (6ë“±ê¸‰ ì´í•˜)
      if (averageGrade >= 6) {
        riskScore += 40;
        reasons.push(`í‰ê·  ë“±ê¸‰ ${averageGrade.toFixed(1)}ë“±ê¸‰ (ë‚®ìŒ)`);
      } else if (averageGrade >= 5) {
        riskScore += 20;
        reasons.push(`í‰ê·  ë“±ê¸‰ ${averageGrade.toFixed(1)}ë“±ê¸‰`);
      }

      // 2. ìµœê·¼ ì ìˆ˜ í•˜ë½ ê°€ì¤‘ì¹˜
      if (recentGrades.length >= 2) {
        const latest = recentGrades[0];
        const previous = recentGrades[1];
        if (latest > previous) {
          // ë“±ê¸‰ì´ ë†’ì•„ì¡Œë‹¤ëŠ” ê²ƒì€ ë‚˜ë¹ ì¡Œë‹¤ëŠ” ì˜ë¯¸
          const decline = latest - previous;
          riskScore += decline * 15;
          reasons.push(`ìµœê·¼ ë“±ê¸‰ ${decline}ë‹¨ê³„ í•˜ë½`);
        }
      }

      // 3. ì›ì ìˆ˜ í¸ì°¨
      const rawScores = recent3
        .map((s) => s.raw_score)
        .filter((r): r is number => r !== null && r !== undefined);

      if (rawScores.length >= 2) {
        const mean = rawScores.reduce((a, b) => a + b, 0) / rawScores.length;
        const variance =
          rawScores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) /
          rawScores.length;
        const stdDev = Math.sqrt(variance);

        if (stdDev > mean * 0.2) {
          riskScore += 20;
          reasons.push(`ì ìˆ˜ í¸ì°¨ í¼ (ë¶ˆì•ˆì •)`);
        }
      }

      if (riskScore >= 30) {
        results.push({
          subject,
          type: "school",
          riskScore: Math.min(100, riskScore),
          reasons,
          recentGrades,
          averageGrade,
        });
      }
    });

    // ëª¨ì˜ê³ ì‚¬ ì·¨ì•½ ê³¼ëª© ë¶„ì„
    const mockBySubject = new Map<string, MockScoreRow[]>();
    mockScores.forEach((score) => {
      if (!score.subject_group || (score.percentile === null && score.grade_score === null))
        return;
      const key = score.subject_group;
      if (!mockBySubject.has(key)) {
        mockBySubject.set(key, []);
      }
      mockBySubject.get(key)!.push(score);
    });

    mockBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA; // ìµœì‹ ìˆœ
      });

      const recent3 = sorted.slice(0, 3);
      const recentPercentiles = recent3
        .map((s) => s.percentile)
        .filter((p): p is number => p !== null && p !== undefined);
      const recentGrades = recent3
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);

      if (recentPercentiles.length === 0 && recentGrades.length === 0) return;

      const reasons: string[] = [];
      let riskScore = 0;

      // ë°±ë¶„ìœ„ 50 ë¯¸ë§Œ
      if (recentPercentiles.length > 0) {
        const avgPercentile =
          recentPercentiles.reduce((a, b) => a + b, 0) / recentPercentiles.length;
        if (avgPercentile < 50) {
          riskScore += 50;
          reasons.push(`í‰ê·  ë°±ë¶„ìœ„ ${avgPercentile.toFixed(1)}% (ë‚®ìŒ)`);
        }
      }

      // ë“±ê¸‰ 6 ì´ìƒ
      if (recentGrades.length > 0) {
        const avgGrade =
          recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length;
        if (avgGrade >= 6) {
          riskScore += 40;
          reasons.push(`í‰ê·  ë“±ê¸‰ ${avgGrade.toFixed(1)}ë“±ê¸‰ (ë‚®ìŒ)`);
        }
      }

      // ìµœê·¼ í•˜ë½
      if (recentPercentiles.length >= 2) {
        const latest = recentPercentiles[0];
        const previous = recentPercentiles[1];
        if (latest < previous) {
          const decline = previous - latest;
          riskScore += decline * 2;
          reasons.push(`ìµœê·¼ ë°±ë¶„ìœ„ ${decline.toFixed(1)}%p í•˜ë½`);
        }
      }

      if (riskScore >= 30) {
        results.push({
          subject,
          type: "mock",
          riskScore: Math.min(100, riskScore),
          reasons,
          recentGrades: recentGrades.length > 0 ? recentGrades : [],
          averageGrade:
            recentGrades.length > 0
              ? recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length
              : 0,
        });
      }
    });

    // Risk Score ìˆœìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìˆœ)
    return results.sort((a, b) => b.riskScore - a.riskScore).slice(0, 3);
  }, [schoolScores, mockScores]);

  if (weakSubjects.length === 0) {
    return (
      <EmptyState
        icon="âœ…"
        title="ì·¨ì•½ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤"
        description="í˜„ì¬ ì„±ì ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ê³„ì† ìœ ì§€í•˜ì„¸ìš”!"
      />
    );
  }

  const getRiskColor = (riskScore: number) => {
    if (riskScore >= 70) return "text-red-600 bg-red-50 border-red-200";
    if (riskScore >= 50) return "text-orange-600 bg-orange-50 border-orange-200";
    return "text-yellow-600 bg-yellow-50 border-yellow-200";
  };

  return (
    <div className="flex flex-col gap-4">
      {weakSubjects.map((item, index) => (
        <div
          key={`${item.subject}-${item.type}-${index}`}
          className={`rounded-lg border p-6 ${getRiskColor(item.riskScore)}`}
        >
          <div className="flex items-start justify-between">
            <div className="flex-1 flex flex-col gap-2">
              <div className="flex items-center gap-3">
                <h3 className="text-lg font-semibold">{item.subject}</h3>
                <span className="text-xs font-medium px-2 py-1 rounded bg-white/50">
                  {item.type === "school" ? "ë‚´ì‹ " : "ëª¨ì˜ê³ ì‚¬"}
                </span>
                <span className="text-sm font-bold">
                  Risk Score: {item.riskScore}
                </span>
              </div>
              <div className="flex flex-col gap-1">
                {item.reasons.map((reason, idx) => (
                  <p key={idx} className="text-sm">
                    â€¢ {reason}
                  </p>
                ))}
              </div>
              {item.recentGrades.length > 0 && (
                <p className="text-xs opacity-75">
                  ìµœê·¼ ë“±ê¸‰: {item.recentGrades.join(", ")} (í‰ê· :{" "}
                  {item.averageGrade.toFixed(1)})
                </p>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="dashboard/_components/WeakSubjectsList.tsx">
import type { WeakSubject } from "../_utils";

type WeakSubjectsListProps = {
  data: WeakSubject[];
};

export function WeakSubjectsList({ data }: WeakSubjectsListProps) {
  if (data.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center text-sm text-gray-500 shadow-sm">
        ì·¨ì•½ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white shadow-sm">
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                êµê³¼
              </th>
              <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                ì„¸ë¶€ ê³¼ëª©
              </th>
              <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                í‰ê·  ë“±ê¸‰
              </th>
              <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                ì·¨ì•½ ì‚¬ìœ 
              </th>
              <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700">
                ì„±ì  ê°œìˆ˜
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {data.map((subject, index) => (
              <tr
                key={`${subject.course}:${subject.course_detail}`}
                className="hover:bg-gray-50"
              >
                <td className="px-4 py-3 text-sm text-gray-700">
                  {subject.course}
                </td>
                <td className="px-4 py-3 text-sm font-medium text-gray-900">
                  {subject.course_detail}
                </td>
                <td className="px-4 py-3 text-sm">
                  <span className="font-semibold text-red-600">
                    {subject.averageGrade.toFixed(1)}ë“±ê¸‰
                  </span>
                </td>
                <td className="px-4 py-3 text-sm text-gray-700">
                  <span className="inline-block rounded bg-red-50 px-2 py-1 text-xs text-red-700">
                    {subject.reason}
                  </span>
                </td>
                <td className="px-4 py-3 text-sm text-gray-700">
                  {subject.count}ê°œ
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="dashboard/_utils/scoreQueries.ts">
/**
 * ì„±ì  ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬ ìœ í‹¸ë¦¬í‹°
 * 
 * âš ï¸ ì£¼ì˜: ì´ íŒŒì¼ì€ ë ˆê±°ì‹œ ëŒ€ì‹œë³´ë“œ(/scores/dashboard)ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ëŠ” API ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
 * 
 * ìƒˆ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ /api/students/[id]/score-dashboard ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
 */

import { createSupabaseServerClient } from "@/lib/supabase/server";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

/**
 * âš ï¸ ë ˆê±°ì‹œ íƒ€ì…: student_internal_scores í…Œì´ë¸” ê¸°ë°˜
 * ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” lib/types/scoreDashboard.ts ì˜ íƒ€ì…ì„ ì‚¬ìš©í•˜ì„¸ìš”.
 */
export type SchoolScoreRow = {
  id: string;
  student_id: string;
  grade: number;
  semester: number;
  subject_group: string;
  subject_type: string | null;
  subject_name: string | null;
  raw_score: number | null;
  grade_score: number | null;
  class_rank: number | null;
  created_at: string | null;
};

/**
 * âš ï¸ ë ˆê±°ì‹œ íƒ€ì…: student_mock_scores í…Œì´ë¸” ê¸°ë°˜
 * ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” lib/types/scoreDashboard.ts ì˜ íƒ€ì…ì„ ì‚¬ìš©í•˜ì„¸ìš”.
 */
export type MockScoreRow = {
  id: string;
  student_id: string;
  grade: number;
  subject_group: string;
  exam_type: string;
  subject_name: string | null;
  raw_score: number | null;
  percentile: number | null;
  grade_score: number | null;
  exam_round: string | null;
  created_at: string | null;
};

/**
 * ë‚´ì‹  ì„±ì  ì¡°íšŒ (ë ˆê±°ì‹œ)
 * 
 * âš ï¸ ì´ í•¨ìˆ˜ëŠ” student_internal_scores í…Œì´ë¸”ì„ ì§ì ‘ ì¡°íšŒí•©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” fetchScoreDashboard() APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
 * 
 * @deprecated ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” lib/api/scoreDashboard.ts ì˜ fetchScoreDashboard ì‚¬ìš©
 */
export async function fetchSchoolScores(
  studentId: string
): Promise<SchoolScoreRow[]> {
  try {
    const supabase = await createSupabaseServerClient();

    // tenant_idë„ í•¨ê»˜ ì¡°íšŒ (RLS ì •ì±… ì¤€ìˆ˜)
    const { data: user } = await supabase.auth.getUser();
    if (!user?.user?.id) {
      console.warn("[dashboard] ì‚¬ìš©ì ì •ë³´ ì—†ìŒ");
      return [];
    }

    // tenant_id ì¡°íšŒ (RLS ì •ì±… ì¤€ìˆ˜)
    const { data: student } = await supabase
      .from("students")
      .select("tenant_id")
      .eq("id", studentId)
      .single();

    if (!student?.tenant_id) {
      console.warn("[dashboard] í•™ìƒì˜ tenant_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
      return [];
    }

    const { data: scores, error } = await supabase
      .from("student_internal_scores")
      .select("*")
      .eq("student_id", studentId)
      .eq("tenant_id", student.tenant_id)
      .order("grade", { ascending: true })
      .order("semester", { ascending: true })
      .order("created_at", { ascending: false });

    if (error) {
      console.error("[dashboard] ë‚´ì‹  ì„±ì  ì¡°íšŒ ì‹¤íŒ¨", {
        message: error.message,
        code: error.code,
        details: error.details,
        hint: error.hint,
        error,
      });
      return [];
    }

    return (scores as SchoolScoreRow[] | null) ?? [];
  } catch (err) {
    console.error("[dashboard] ë‚´ì‹  ì„±ì  ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ", err);
    return [];
  }
}

/**
 * ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ (ë ˆê±°ì‹œ)
 * 
 * âš ï¸ ì´ í•¨ìˆ˜ëŠ” student_mock_scores í…Œì´ë¸”ì„ ì§ì ‘ ì¡°íšŒí•©ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” fetchScoreDashboard() APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
 * 
 * @deprecated ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” lib/api/scoreDashboard.ts ì˜ fetchScoreDashboard ì‚¬ìš©
 */
export async function fetchMockScores(
  studentId: string
): Promise<MockScoreRow[]> {
  try {
    const supabase = await createSupabaseServerClient();

    // tenant_idë„ í•¨ê»˜ ì¡°íšŒ (RLS ì •ì±… ì¤€ìˆ˜)
    const { data: user } = await supabase.auth.getUser();
    if (!user?.user?.id) {
      console.warn("[dashboard] ì‚¬ìš©ì ì •ë³´ ì—†ìŒ");
      return [];
    }

    // tenant_id ì¡°íšŒ (RLS ì •ì±… ì¤€ìˆ˜)
    const { data: student } = await supabase
      .from("students")
      .select("tenant_id")
      .eq("id", studentId)
      .single();

    if (!student?.tenant_id) {
      console.warn("[dashboard] í•™ìƒì˜ tenant_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
      return [];
    }

    const { data: scores, error } = await supabase
      .from("student_mock_scores")
      .select("*")
      .eq("student_id", studentId)
      .eq("tenant_id", student.tenant_id)
      .order("exam_date", { ascending: false })
      .order("created_at", { ascending: false });

    if (error) {
      console.error("[dashboard] ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ ì‹¤íŒ¨", {
        message: error.message,
        code: error.code,
        details: error.details,
        hint: error.hint,
        error,
      });
      return [];
    }

    return (scores as MockScoreRow[] | null) ?? [];
  } catch (err) {
    console.error("[dashboard] ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ", err);
    return [];
  }
}
</file>

<file path="dashboard/mock/_components/MockDetailedMetrics.tsx">
"use client";

import React from "react";
import type { MockScoreRow } from "../../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";
import { getGradeColor } from "@/lib/constants/colors";

type MockDetailedMetricsProps = {
  mockScores: MockScoreRow[];
};

export function MockDetailedMetrics({
  mockScores,
}: MockDetailedMetricsProps) {
  // íšŒì°¨ë³„ ìƒì„¸ í†µê³„
  const roundStats = React.useMemo(() => {
    const roundMap = new Map<string, MockScoreRow[]>();
    mockScores.forEach((score) => {
      if (score.exam_round) {
        if (!roundMap.has(score.exam_round)) {
          roundMap.set(score.exam_round, []);
        }
        roundMap.get(score.exam_round)!.push(score);
      }
    });

    const roundOrder = ["3ì›”", "4ì›”", "6ì›”", "9ì›”", "11ì›”", "ì‚¬ì„¤"];
    const result: Array<{
      round: string;
      averagePercentile: number;
      averageGrade: number;
      subjectCount: number;
      totalScores: number;
    }> = [];

    roundMap.forEach((scores, round) => {
      const validPercentiles = scores
        .map((s) => s.percentile)
        .filter((p): p is number => p !== null && p !== undefined);
      const validGrades = scores
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);

      if (validPercentiles.length === 0 && validGrades.length === 0) return;

      const averagePercentile =
        validPercentiles.length > 0
          ? validPercentiles.reduce((a, b) => a + b, 0) / validPercentiles.length
          : 0;
      const averageGrade =
        validGrades.length > 0
          ? validGrades.reduce((a, b) => a + b, 0) / validGrades.length
          : 0;

      const subjectSet = new Set<string>();
      scores.forEach((score) => {
        if (score.subject_group) {
          subjectSet.add(score.subject_group);
        }
      });

      result.push({
        round,
        averagePercentile: Number(averagePercentile.toFixed(1)),
        averageGrade: Number(averageGrade.toFixed(1)),
        subjectCount: subjectSet.size,
        totalScores: scores.length,
      });
    });

    return result.sort((a, b) => {
      const indexA = roundOrder.indexOf(a.round);
      const indexB = roundOrder.indexOf(b.round);
      if (indexA === -1 && indexB === -1) return 0;
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return indexA - indexB;
    });
  }, [mockScores]);

  // ì‹œí—˜ ìœ í˜•ë³„ ìƒì„¸ í†µê³„
  const examTypeStats = React.useMemo(() => {
    const typeMap = new Map<string, MockScoreRow[]>();
    mockScores.forEach((score) => {
      if (score.exam_type) {
        if (!typeMap.has(score.exam_type)) {
          typeMap.set(score.exam_type, []);
        }
        typeMap.get(score.exam_type)!.push(score);
      }
    });

    const typeOrder = ["í‰ê°€ì›", "êµìœ¡ì²­", "ì‚¬ì„¤"];
    const result: Array<{
      type: string;
      averagePercentile: number;
      averageGrade: number;
      subjectCount: number;
      totalScores: number;
      bestSubject: string | null;
      worstSubject: string | null;
    }> = [];

    typeMap.forEach((scores, type) => {
      const validPercentiles = scores
        .map((s) => s.percentile)
        .filter((p): p is number => p !== null && p !== undefined);
      const validGrades = scores
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);

      if (validPercentiles.length === 0 && validGrades.length === 0) return;

      const averagePercentile =
        validPercentiles.length > 0
          ? validPercentiles.reduce((a, b) => a + b, 0) / validPercentiles.length
          : 0;
      const averageGrade =
        validGrades.length > 0
          ? validGrades.reduce((a, b) => a + b, 0) / validGrades.length
          : 0;

      const subjectSet = new Set<string>();
      const subjectPercentileMap = new Map<string, number[]>();
      scores.forEach((score) => {
        if (score.subject_group) {
          subjectSet.add(score.subject_group);
          if (score.percentile !== null) {
            if (!subjectPercentileMap.has(score.subject_group)) {
              subjectPercentileMap.set(score.subject_group, []);
            }
            subjectPercentileMap.get(score.subject_group)!.push(score.percentile);
          }
        }
      });

      let bestSubject: string | null = null;
      let worstSubject: string | null = null;
      let bestPercentile = 0;
      let worstPercentile = 100;

      subjectPercentileMap.forEach((percentiles, subject) => {
        const avg = percentiles.reduce((a, b) => a + b, 0) / percentiles.length;
        if (avg > bestPercentile) {
          bestPercentile = avg;
          bestSubject = subject;
        }
        if (avg < worstPercentile) {
          worstPercentile = avg;
          worstSubject = subject;
        }
      });

      result.push({
        type,
        averagePercentile: Number(averagePercentile.toFixed(1)),
        averageGrade: Number(averageGrade.toFixed(1)),
        subjectCount: subjectSet.size,
        totalScores: scores.length,
        bestSubject,
        worstSubject,
      });
    });

    return result.sort((a, b) => {
      const indexA = typeOrder.indexOf(a.type);
      const indexB = typeOrder.indexOf(b.type);
      if (indexA === -1 && indexB === -1) return 0;
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return indexA - indexB;
    });
  }, [mockScores]);

  // ê³¼ëª©ë³„ í‰ê·  ë°±ë¶„ìœ„
  const subjectAverages = React.useMemo(() => {
    const subjectMap = new Map<string, { percentiles: number[]; grades: number[] }>();
    mockScores.forEach((score) => {
      if (score.subject_group) {
        if (!subjectMap.has(score.subject_group)) {
          subjectMap.set(score.subject_group, { percentiles: [], grades: [] });
        }
        const data = subjectMap.get(score.subject_group)!;
        if (score.percentile !== null) {
          data.percentiles.push(score.percentile);
        }
        if (score.grade_score !== null) {
          data.grades.push(score.grade_score);
        }
      }
    });

    const result: Array<{
      subject: string;
      averagePercentile: number | null;
      averageGrade: number | null;
      count: number;
      trend: "improved" | "declined" | "stable" | null;
    }> = [];

    subjectMap.forEach((data, subject) => {
      const averagePercentile =
        data.percentiles.length > 0
          ? data.percentiles.reduce((a, b) => a + b, 0) / data.percentiles.length
          : null;
      const averageGrade =
        data.grades.length > 0
          ? data.grades.reduce((a, b) => a + b, 0) / data.grades.length
          : null;

      // ìµœê·¼ 2ê°œ ì„±ì  ë¹„êµë¡œ ì¶”ì„¸ ê³„ì‚°
      const sortedScores = mockScores
        .filter((s) => s.subject_group === subject && s.percentile !== null)
        .sort((a, b) => {
          // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
          if (a.grade !== b.grade) return b.grade - a.grade;
          const roundA = a.exam_round || "";
          const roundB = b.exam_round || "";
          if (roundA !== roundB) return roundB.localeCompare(roundA);
          const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
          const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
          return dateB - dateA;
        })
        .slice(0, 2);

      let trend: "improved" | "declined" | "stable" | null = null;
      if (
        sortedScores.length >= 2 &&
        sortedScores[0].percentile !== null &&
        sortedScores[1].percentile !== null
      ) {
        const latest = sortedScores[0].percentile;
        const previous = sortedScores[1].percentile;
        if (latest > previous) trend = "improved";
        else if (latest < previous) trend = "declined";
        else trend = "stable";
      }

      result.push({
        subject,
        averagePercentile: averagePercentile ? Number(averagePercentile.toFixed(1)) : null,
        averageGrade: averageGrade ? Number(averageGrade.toFixed(1)) : null,
        count: data.percentiles.length + data.grades.length,
        trend,
      });
    });

    return result.sort((a, b) => {
      const aVal = a.averagePercentile ?? 0;
      const bVal = b.averagePercentile ?? 0;
      return bVal - aVal; // ë°±ë¶„ìœ„ ë†’ì€ ìˆœ
    });
  }, [mockScores]);

  if (mockScores.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-col gap-6">
      {/* íšŒì°¨ë³„ ìƒì„¸ í†µê³„ */}
      {roundStats.length > 0 && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-4">
              <h3 className="text-lg font-semibold text-gray-900">
                íšŒì°¨ë³„ ìƒì„¸ í†µê³„
              </h3>
              <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-gray-200">
                    <th className="text-left py-3 px-4 text-sm font-semibold text-gray-700">
                      íšŒì°¨
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      í‰ê·  ë°±ë¶„ìœ„
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      í‰ê·  ë“±ê¸‰
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      êµê³¼ ìˆ˜
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      ì„±ì  ìˆ˜
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {roundStats.map((stat) => {
                    const gradeColor = getGradeColor(
                      stat.averageGrade > 0 ? Math.round(stat.averageGrade) : null
                    );
                    return (
                      <tr
                        key={stat.round}
                        className="border-b border-gray-100 hover:bg-gray-50"
                      >
                        <td className="py-3 px-4 text-sm font-medium text-gray-900">
                          {stat.round}
                        </td>
                        <td className="py-3 px-4 text-center">
                          {stat.averagePercentile > 0 ? (
                            <span className="text-sm font-semibold text-indigo-600">
                              {stat.averagePercentile}%
                            </span>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                        <td className="py-3 px-4 text-center">
                          {stat.averageGrade > 0 ? (
                            <span
                              className={`inline-block rounded-full px-3 py-1 text-sm font-semibold ${gradeColor.badge}`}
                            >
                              {stat.averageGrade}ë“±ê¸‰
                            </span>
                          ) : (
                            <span className="text-sm text-gray-400">-</span>
                          )}
                        </td>
                        <td className="py-3 px-4 text-center text-sm text-gray-600">
                          {stat.subjectCount}ê°œ
                        </td>
                        <td className="py-3 px-4 text-center text-sm text-gray-600">
                          {stat.totalScores}ê°œ
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            </div>
          </div>
        </Card>
      )}

      {/* ì‹œí—˜ ìœ í˜•ë³„ ìƒì„¸ í†µê³„ */}
      {examTypeStats.length > 0 && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-4">
              <h3 className="text-lg font-semibold text-gray-900">
                ì‹œí—˜ ìœ í˜•ë³„ ìƒì„¸ í†µê³„
              </h3>
              <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {examTypeStats.map((stat) => {
                const gradeColor = getGradeColor(
                  stat.averageGrade > 0 ? Math.round(stat.averageGrade) : null
                );
                return (
                  <div
                    key={stat.type}
                    className="rounded-lg border border-gray-200 p-4"
                  >
                    <div className="flex items-center justify-between">
                      <h4 className="text-base font-semibold text-gray-900">
                        {stat.type}
                      </h4>
                      {stat.averagePercentile > 0 && (
                        <span className="text-sm font-semibold text-indigo-600">
                          {stat.averagePercentile}%
                        </span>
                      )}
                    </div>
                    <div className="space-y-2 text-sm">
                      {stat.averageGrade > 0 && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">í‰ê·  ë“±ê¸‰</span>
                          <span
                            className={`rounded-full px-2 py-1 text-xs font-semibold ${gradeColor.badge}`}
                          >
                            {stat.averageGrade}ë“±ê¸‰
                          </span>
                        </div>
                      )}
                      <div className="flex justify-between">
                        <span className="text-gray-600">ê³¼ëª© ìˆ˜</span>
                        <span className="font-medium text-gray-900">
                          {stat.subjectCount}ê°œ
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">ì„±ì  ìˆ˜</span>
                        <span className="font-medium text-gray-900">
                          {stat.totalScores}ê°œ
                        </span>
                      </div>
                      {stat.bestSubject && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">ìµœê³  ê³¼ëª©</span>
                          <span className="font-medium text-green-600">
                            {stat.bestSubject}
                          </span>
                        </div>
                      )}
                      {stat.worstSubject && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">ì·¨ì•½ ê³¼ëª©</span>
                          <span className="font-medium text-red-600">
                            {stat.worstSubject}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          </div>
        </Card>
      )}

      {/* ê³¼ëª©ë³„ í‰ê·  ë°±ë¶„ìœ„ */}
      {subjectAverages.length > 0 && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-4">
              <h3 className="text-lg font-semibold text-gray-900">
                ê³¼ëª©ë³„ í‰ê·  ì„±ì 
              </h3>
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {subjectAverages.map((item) => {
                const gradeColor = getGradeColor(
                  item.averageGrade ? Math.round(item.averageGrade) : null
                );
                const trendIcon =
                  item.trend === "improved"
                    ? "â†‘"
                    : item.trend === "declined"
                    ? "â†“"
                    : item.trend === "stable"
                    ? "â†’"
                    : "";
                const trendColor =
                  item.trend === "improved"
                    ? "text-green-600"
                    : item.trend === "declined"
                    ? "text-red-600"
                    : "text-gray-600";

                return (
                  <div
                    key={item.subject}
                    className="flex items-center justify-between rounded-lg border border-gray-200 p-3"
                  >
                    <div className="flex flex-col gap-1">
                      <span className="text-sm font-medium text-gray-900">
                        {item.subject}
                      </span>
                      <span className="text-xs text-gray-500">
                        {item.count}ê°œ ì„±ì 
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      {item.trend && (
                        <span className={`text-sm font-semibold ${trendColor}`}>
                          {trendIcon}
                        </span>
                      )}
                      {item.averagePercentile !== null ? (
                        <span className="text-sm font-semibold text-indigo-600">
                          {item.averagePercentile}%
                        </span>
                      ) : item.averageGrade !== null ? (
                        <span
                          className={`rounded-full px-3 py-1 text-sm font-semibold ${gradeColor.badge}`}
                        >
                          {item.averageGrade}ë“±ê¸‰
                        </span>
                      ) : null}
                    </div>
                  </div>
                );
              })}
            </div>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="dashboard/mock/_components/MockExamTypeComparisonChart.tsx">
"use client";

import React, { useState } from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { MockScoreRow } from "../../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";

type MockExamTypeComparisonChartProps = {
  mockScores: MockScoreRow[];
};

type MetricType = "percentile" | "grade_score";

export function MockExamTypeComparisonChart({
  mockScores,
}: MockExamTypeComparisonChartProps) {
  const { recharts, loading } = useRecharts();
  const [metric, setMetric] = useState<MetricType>("percentile");
  const [chartType, setChartType] = useState<"bar" | "radar">("bar");

  // ì‹œí—˜ ìœ í˜•ë³„/ê³¼ëª©ë³„ í‰ê·  ê³„ì‚°
  const comparisonData = React.useMemo(() => {
    const typeMap = new Map<string, Map<string, number[]>>();

    mockScores.forEach((score) => {
      if (!score.exam_type || !score.subject_group) return;

      let value: number | null = null;
      if (metric === "percentile" && score.percentile !== null) {
        value = score.percentile;
      } else if (metric === "grade_score" && score.grade_score !== null) {
        value = score.grade_score;
      }

      if (value === null) return;

      if (!typeMap.has(score.exam_type)) {
        typeMap.set(score.exam_type, new Map());
      }
      const subjectMap = typeMap.get(score.exam_type)!;

      if (!subjectMap.has(score.subject_group)) {
        subjectMap.set(score.subject_group, []);
      }
      subjectMap.get(score.subject_group)!.push(value);
    });

    // ëª¨ë“  ê³¼ëª© ìˆ˜ì§‘
    const allSubjects = new Set<string>();
    typeMap.forEach((subjectMap) => {
      subjectMap.forEach((_, subject) => {
        allSubjects.add(subject);
      });
    });

    // ì°¨íŠ¸ ë°ì´í„° ìƒì„±
    const result: Array<Record<string, number | string>> = [];

    allSubjects.forEach((subject) => {
      const dataPoint: Record<string, number | string> = { subject };

      typeMap.forEach((subjectMap, examType) => {
        const values = subjectMap.get(subject);
        if (values && values.length > 0) {
          const average = values.reduce((a, b) => a + b, 0) / values.length;
          dataPoint[examType] = Number(average.toFixed(1));
        } else {
          dataPoint[examType] = 0;
        }
      });

      result.push(dataPoint);
    });

    return result;
  }, [mockScores, metric]);

  // ë ˆì´ë” ì°¨íŠ¸ìš© ë°ì´í„° ë³€í™˜
  const radarData = React.useMemo(() => {
    if (chartType !== "radar") return [];

    const typeMap = new Map<string, Map<string, number[]>>();

    mockScores.forEach((score) => {
      if (!score.exam_type || !score.subject_group) return;

      let value: number | null = null;
      if (metric === "percentile" && score.percentile !== null) {
        value = score.percentile;
      } else if (metric === "grade_score" && score.grade_score !== null) {
        value = score.grade_score;
      }

      if (value === null) return;

      if (!typeMap.has(score.exam_type)) {
        typeMap.set(score.exam_type, new Map());
      }
      const subjectMap = typeMap.get(score.exam_type)!;

      if (!subjectMap.has(score.subject_group)) {
        subjectMap.set(score.subject_group, []);
      }
      subjectMap.get(score.subject_group)!.push(value);
    });

    const result: Array<Record<string, number | string>> = [];

    typeMap.forEach((subjectMap, examType) => {
      const dataPoint: Record<string, number | string> = { examType };

      subjectMap.forEach((values, subject) => {
        if (values.length > 0) {
          const average = values.reduce((a, b) => a + b, 0) / values.length;
          dataPoint[subject] = Number(average.toFixed(1));
        }
      });

      result.push(dataPoint);
    });

    return result;
  }, [mockScores, metric, chartType]);

  if (mockScores.length === 0 || comparisonData.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-12 text-center">
        <div className="mx-auto flex flex-col gap-2 max-w-md">
          <div className="text-6xl">ğŸ“Š</div>
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            ë¹„êµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
          </h3>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ë“±ë¡í•˜ë©´ ë¹„êµ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  // Show loading skeleton while recharts is loading
  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={400} />;
  }

  const {
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    Legend,
    ResponsiveContainer,
    RadarChart,
    PolarGrid,
    PolarAngleAxis,
    PolarRadiusAxis,
    Radar,
  } = recharts;

  const metricLabel = metric === "percentile" ? "ë°±ë¶„ìœ„" : "ë“±ê¸‰";
  const yAxisDomain: [number, number] = metric === "percentile" ? [0, 100] : [1, 9];
  const yAxisReversed = metric === "grade_score";

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <h2 className="text-xl font-semibold text-gray-900 dark:text-gray-100">
          ì‹œí—˜ ìœ í˜•ë³„ ë¹„êµ
        </h2>
        <div className="flex gap-2">
          <div className="flex gap-2">
            <button
              onClick={() => setMetric("percentile")}
              className={`rounded-lg px-3 py-1.5 text-sm font-medium transition ${
                metric === "percentile"
                  ? "bg-indigo-600 dark:bg-indigo-500 text-white"
                  : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600"
              }`}
            >
              ë°±ë¶„ìœ„
            </button>
            <button
              onClick={() => setMetric("grade_score")}
              className={`rounded-lg px-3 py-1.5 text-sm font-medium transition ${
                metric === "grade_score"
                  ? "bg-indigo-600 dark:bg-indigo-500 text-white"
                  : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600"
              }`}
            >
              ë“±ê¸‰
            </button>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setChartType("bar")}
              className={`rounded-lg px-3 py-1.5 text-sm font-medium transition ${
                chartType === "bar"
                  ? "bg-purple-600 dark:bg-purple-500 text-white"
                  : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600"
              }`}
            >
              ë§‰ëŒ€
            </button>
            <button
              onClick={() => setChartType("radar")}
              className={`rounded-lg px-3 py-1.5 text-sm font-medium transition ${
                chartType === "radar"
                  ? "bg-purple-600 dark:bg-purple-500 text-white"
                  : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600"
              }`}
            >
              ë ˆì´ë”
            </button>
          </div>
        </div>
      </div>

      {chartType === "bar" ? (
        <ResponsiveContainer width="100%" height={400}>
          <BarChart
            data={comparisonData}
            margin={{ top: 20, right: 30, left: 20, bottom: 60 }}
          >
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="subject"
              angle={-45}
              textAnchor="end"
              height={100}
              interval={0}
            />
            <YAxis
              domain={yAxisDomain}
              reversed={yAxisReversed}
              label={{
                value: metricLabel,
                angle: -90,
                position: "insideLeft",
              }}
            />
            <Tooltip
              formatter={(value: number, name: string) => {
                if (value === 0) return ["ë°ì´í„° ì—†ìŒ", name];
                if (metric === "percentile") return [`${value}%`, name];
                return [`${value}ë“±ê¸‰`, name];
              }}
            />
            <Legend />
            <Bar dataKey="í‰ê°€ì›" fill={getChartColor(0)} name="í‰ê°€ì›" />
            <Bar dataKey="êµìœ¡ì²­" fill={getChartColor(1)} name="êµìœ¡ì²­" />
            <Bar dataKey="ì‚¬ì„¤" fill={getChartColor(2)} name="ì‚¬ì„¤" />
          </BarChart>
        </ResponsiveContainer>
      ) : (
        <ResponsiveContainer width="100%" height={400}>
          <RadarChart data={radarData}>
            <PolarGrid />
            <PolarAngleAxis
              dataKey="examType"
              tick={{ fontSize: 12 }}
            />
            <PolarRadiusAxis
              angle={90}
              domain={yAxisDomain}
              tick={{ fontSize: 10 }}
            />
            <Radar
              name="í‰ê°€ì›"
              dataKey="í‰ê°€ì›"
              stroke={getChartColor(0)}
              fill={getChartColor(0)}
              fillOpacity={0.6}
            />
            <Radar
              name="êµìœ¡ì²­"
              dataKey="êµìœ¡ì²­"
              stroke={getChartColor(1)}
              fill={getChartColor(1)}
              fillOpacity={0.6}
            />
            <Radar
              name="ì‚¬ì„¤"
              dataKey="ì‚¬ì„¤"
              stroke={getChartColor(2)}
              fill={getChartColor(2)}
              fillOpacity={0.6}
            />
            <Tooltip
              formatter={(value: number) => {
                if (metric === "percentile") return `${value}%`;
                return `${value}ë“±ê¸‰`;
              }}
            />
            <Legend />
          </RadarChart>
        </ResponsiveContainer>
      )}
    </div>
  );
}
</file>

<file path="dashboard/mock/_components/MockInsightPanel.tsx">
"use client";

import React from "react";
import type { MockScoreRow } from "../../_utils/scoreQueries";

type MockInsightPanelProps = {
  mockScores: MockScoreRow[];
};

export function MockInsightPanel({
  mockScores,
}: MockInsightPanelProps) {
  const insights = React.useMemo(() => {
    const result: string[] = [];

    // 1. êµê³¼ë³„ ìµœê·¼ í•˜ë½ ì¶”ì„¸ ë¶„ì„
    const mockBySubject = new Map<string, MockScoreRow[]>();
    mockScores.forEach((score) => {
      if (!score.subject_group || (score.percentile === null && score.grade_score === null)) return;
      const key = score.subject_group;
      if (!mockBySubject.has(key)) {
        mockBySubject.set(key, []);
      }
      mockBySubject.get(key)!.push(score);
    });

    mockBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });

      if (sorted.length >= 2) {
        const recent2 = sorted.slice(0, 2);
        const percentiles = recent2
          .map((s) => s.percentile)
          .filter((p): p is number => p !== null && p !== undefined);
        const grades = recent2
          .map((s) => s.grade_score)
          .filter((g): g is number => g !== null && g !== undefined);

        if (percentiles.length === 2 && percentiles[0] < percentiles[1]) {
          result.push(
            `${subject} ê³¼ëª©ì€ ìµœê·¼ ë‘ ë²ˆ ì—°ì† ë°±ë¶„ìœ„ê°€ í•˜ë½í–ˆìŠµë‹ˆë‹¤. (${percentiles[1].toFixed(1)}% â†’ ${percentiles[0].toFixed(1)}%) ê¸°ì´ˆ ê°œë… ë³µìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`
          );
        }

        if (grades.length === 2 && grades[0] > grades[1]) {
          result.push(
            `${subject} ê³¼ëª©ì€ ìµœê·¼ ë‘ ë²ˆ ì—°ì† ë“±ê¸‰ì´ í•˜ë½í–ˆìŠµë‹ˆë‹¤. (${grades[1]}ë“±ê¸‰ â†’ ${grades[0]}ë“±ê¸‰) ë‹¨ì›ë³„ ê¸°ì´ˆ ë¬¸ì œ ë³µìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`
          );
        }
      }
    });

    // 2. ëª¨ì˜ê³ ì‚¬ ë°±ë¶„ìœ„ ë‚®ì€ ê³¼ëª©
    mockBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });

      const recent = sorted[0];
      if (recent && recent.percentile !== null && recent.percentile < 50) {
        result.push(
          `${subject} ëª¨ì˜ê³ ì‚¬ ë°±ë¶„ìœ„ê°€ ${recent.percentile.toFixed(1)}%ë¡œ ë‚®ì•„, ë‹¨ì›ë³„ ê¸°ì´ˆ ë¬¸ì œ ë³µìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`
        );
      }
    });

    // 3. ì‹œí—˜ ìœ í˜•ë³„ ì„±ì  í¸ì°¨
    const typeBySubject = new Map<string, Map<string, number[]>>();
    mockScores.forEach((score) => {
      if (!score.subject_group || !score.exam_type || score.percentile === null) return;
      const subject = score.subject_group;
      const type = score.exam_type;

      if (!typeBySubject.has(subject)) {
        typeBySubject.set(subject, new Map());
      }
      const subjectMap = typeBySubject.get(subject)!;

      if (!subjectMap.has(type)) {
        subjectMap.set(type, []);
      }
      subjectMap.get(type)!.push(score.percentile);
    });

    typeBySubject.forEach((typeMap, subject) => {
      const typeAverages = Array.from(typeMap.entries()).map(([type, percentiles]) => ({
        type,
        average: percentiles.reduce((a, b) => a + b, 0) / percentiles.length,
      }));

      if (typeAverages.length >= 2) {
        const max = Math.max(...typeAverages.map((t) => t.average));
        const min = Math.min(...typeAverages.map((t) => t.average));
        const diff = max - min;

        if (diff > 20) {
          const bestType = typeAverages.find((t) => t.average === max)?.type;
          const worstType = typeAverages.find((t) => t.average === min)?.type;
          result.push(
            `${subject} ê³¼ëª©ì€ ì‹œí—˜ ìœ í˜•ë³„ í¸ì°¨ê°€ í½ë‹ˆë‹¤. (${worstType}: ${min.toFixed(1)}%, ${bestType}: ${max.toFixed(1)}%) ${worstType} ìœ í˜• ë¬¸ì œì— ì§‘ì¤‘í•˜ì„¸ìš”.`
          );
        }
      }
    });

    // 4. íšŒì°¨ë³„ ì„±ì  í–¥ìƒ
    const roundBySubject = new Map<string, Map<string, number[]>>();
    mockScores.forEach((score) => {
      if (!score.subject_group || !score.exam_round || score.percentile === null) return;
      const subject = score.subject_group;
      const round = score.exam_round;

      if (!roundBySubject.has(subject)) {
        roundBySubject.set(subject, new Map());
      }
      const subjectMap = roundBySubject.get(subject)!;

      if (!subjectMap.has(round)) {
        subjectMap.set(round, []);
      }
      subjectMap.get(round)!.push(score.percentile);
    });

    roundBySubject.forEach((roundMap, subject) => {
      const roundAverages = Array.from(roundMap.entries())
        .map(([round, percentiles]) => ({
          round,
          average: percentiles.reduce((a, b) => a + b, 0) / percentiles.length,
        }))
        .sort((a, b) => {
          const order = ["3ì›”", "4ì›”", "6ì›”", "9ì›”", "11ì›”", "ì‚¬ì„¤"];
          const indexA = order.indexOf(a.round);
          const indexB = order.indexOf(b.round);
          if (indexA === -1 && indexB === -1) return 0;
          if (indexA === -1) return 1;
          if (indexB === -1) return -1;
          return indexA - indexB;
        });

      if (roundAverages.length >= 2) {
        const latest = roundAverages[roundAverages.length - 1];
        const previous = roundAverages[roundAverages.length - 2];
        if (latest.average > previous.average + 5) {
          result.push(
            `${subject} ê³¼ëª©ì€ ${previous.round} ëŒ€ë¹„ ${latest.round} ë°±ë¶„ìœ„ê°€ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤. (${previous.average.toFixed(1)}% â†’ ${latest.average.toFixed(1)}%)`
          );
        }
      }
    });

    // 5. ì•ˆì •ì ì¸ ê³¼ëª© ì¹­ì°¬
    mockBySubject.forEach((scores, subject) => {
      if (scores.length >= 3) {
        const percentiles = scores
          .map((s) => s.percentile)
          .filter((p): p is number => p !== null && p !== undefined)
          .slice(0, 3);

        if (percentiles.length === 3) {
          const mean = percentiles.reduce((a, b) => a + b, 0) / percentiles.length;
          const variance =
            percentiles.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) /
            percentiles.length;

          if (variance < 50) {
            // í¸ì°¨ê°€ ì‘ìœ¼ë©´ ì•ˆì •ì 
            result.push(
              `${subject} ëª¨ì˜ê³ ì‚¬ëŠ” ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. (í‰ê·  ${mean.toFixed(1)}%) í˜„ì¬ í•™ìŠµ íŒ¨í„´ì„ ê³„ì† ìœ ì§€í•˜ì„¸ìš”.`
            );
          }
        }
      }
    });

    return result.slice(0, 5); // ìµœëŒ€ 5ê°œ
  }, [mockScores]);

  if (insights.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
        <div className="mx-auto flex flex-col gap-2 max-w-md">
          <div className="text-6xl">ğŸ’¡</div>
          <h3 className="text-lg font-semibold text-gray-900">
            ì¸ì‚¬ì´íŠ¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤
          </h3>
          <p className="text-sm text-gray-500">
            ë” ë§ì€ ëª¨ì˜ê³ ì‚¬ ì„±ì  ë°ì´í„°ë¥¼ ë“±ë¡í•˜ë©´ í•™ìŠµ ì¸ì‚¬ì´íŠ¸ê°€ ì œê³µë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-purple-200 bg-purple-50 p-6 shadow-sm">
      <h2 className="text-xl font-semibold text-purple-900">
        ëª¨ì˜ê³ ì‚¬ í•™ìŠµ ì¸ì‚¬ì´íŠ¸
      </h2>
      <div className="flex flex-col gap-3">
        {insights.map((insight, index) => (
          <div
            key={index}
            className="rounded-lg border border-purple-200 bg-white p-4"
          >
            <div className="flex items-start gap-3">
              <span className="text-lg">ğŸ’¡</span>
              <p className="text-sm text-gray-700 flex-1">{insight}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="dashboard/mock/_components/MockPercentileDistributionChart.tsx">
"use client";

import React from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { MockScoreRow } from "../../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";

type MockPercentileDistributionChartProps = {
  mockScores: MockScoreRow[];
};

export function MockPercentileDistributionChart({
  mockScores,
}: MockPercentileDistributionChartProps) {
  const { recharts, loading } = useRecharts();
  // ë°±ë¶„ìœ„ êµ¬ê°„ë³„ ë¶„í¬
  const percentileDistribution = React.useMemo(() => {
    const ranges = [
      { label: "0-20%", min: 0, max: 20 },
      { label: "21-40%", min: 21, max: 40 },
      { label: "41-60%", min: 41, max: 60 },
      { label: "61-80%", min: 61, max: 80 },
      { label: "81-100%", min: 81, max: 100 },
    ];

    const result: Array<{ range: string; count: number; percentage: number }> = [];
    const validScores = mockScores.filter((s) => s.percentile !== null);
    const total = validScores.length;

    ranges.forEach((range) => {
      const count = validScores.filter((s) => {
        const percentile = s.percentile!;
        return percentile >= range.min && percentile <= range.max;
      }).length;
      const percentage = total > 0 ? (count / total) * 100 : 0;
      result.push({
        range: range.label,
        count,
        percentage: Number(percentage.toFixed(1)),
      });
    });

    return result;
  }, [mockScores]);

  // ì‹œí—˜ ìœ í˜•ë³„ ë°±ë¶„ìœ„ ë¶„í¬
  const typeDistribution = React.useMemo(() => {
    const typeMap = new Map<string, number[]>();

    mockScores.forEach((score) => {
      if (score.exam_type && score.percentile !== null) {
        if (!typeMap.has(score.exam_type)) {
          typeMap.set(score.exam_type, []);
        }
        typeMap.get(score.exam_type)!.push(score.percentile);
      }
    });

    const ranges = [
      { label: "0-20%", min: 0, max: 20 },
      { label: "21-40%", min: 21, max: 40 },
      { label: "41-60%", min: 41, max: 60 },
      { label: "61-80%", min: 61, max: 80 },
      { label: "81-100%", min: 81, max: 100 },
    ];

    const result: Array<Record<string, number | string>> = [];

    ranges.forEach((range) => {
      const dataPoint: Record<string, number | string> = { range: range.label };

      typeMap.forEach((percentiles, type) => {
        const count = percentiles.filter(
          (p) => p >= range.min && p <= range.max
        ).length;
        const total = percentiles.length;
        const percentage = total > 0 ? (count / total) * 100 : 0;
        dataPoint[type] = Number(percentage.toFixed(1));
      });

      result.push(dataPoint);
    });

    return { data: result, types: Array.from(typeMap.keys()) };
  }, [mockScores]);

  // íšŒì°¨ë³„ í‰ê·  ë°±ë¶„ìœ„ ì¶”ì´
  const roundTrend = React.useMemo(() => {
    const roundMap = new Map<string, number[]>();

    mockScores.forEach((score) => {
      if (score.exam_round && score.percentile !== null) {
        if (!roundMap.has(score.exam_round)) {
          roundMap.set(score.exam_round, []);
        }
        roundMap.get(score.exam_round)!.push(score.percentile);
      }
    });

    const roundOrder = ["3ì›”", "4ì›”", "6ì›”", "9ì›”", "11ì›”", "ì‚¬ì„¤"];
    const result: Array<{ round: string; average: number }> = [];

    roundOrder.forEach((round) => {
      const percentiles = roundMap.get(round);
      if (percentiles && percentiles.length > 0) {
        const average = percentiles.reduce((a, b) => a + b, 0) / percentiles.length;
        result.push({
          round,
          average: Number(average.toFixed(1)),
        });
      }
    });

    return result;
  }, [mockScores]);

  if (mockScores.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-12 text-center">
        <div className="mx-auto flex flex-col gap-2 max-w-md">
          <div className="text-6xl">ğŸ“Š</div>
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
          </h3>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ë“±ë¡í•˜ë©´ ë¶„í¬ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  // Show loading skeleton while recharts is loading
  if (loading || !recharts) {
    return (
      <div className="grid gap-6 lg:grid-cols-2">
        <ChartLoadingSkeleton height={300} />
        <ChartLoadingSkeleton height={300} />
        <div className="lg:col-span-2">
          <ChartLoadingSkeleton height={300} />
        </div>
      </div>
    );
  }

  const {
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    Legend,
    ResponsiveContainer,
    LineChart,
    Line,
  } = recharts;

  return (
    <div className="grid gap-6 lg:grid-cols-2">
      {/* ë°±ë¶„ìœ„ êµ¬ê°„ë³„ ë¶„í¬ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
          ë°±ë¶„ìœ„ êµ¬ê°„ë³„ ë¶„í¬
        </h3>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart
            data={percentileDistribution}
            margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="range" />
            <YAxis />
            <Tooltip
              formatter={(value: number, name: string) => {
                if (name === "count") return [`${value}ê°œ`, "ê°œìˆ˜"];
                if (name === "percentage") return [`${value}%`, "ë¹„ìœ¨"];
                return [value, name];
              }}
            />
            <Legend />
            <Bar dataKey="count" fill={getChartColor(0)} name="ê°œìˆ˜" />
            <Bar dataKey="percentage" fill={getChartColor(1)} name="ë¹„ìœ¨(%)" />
          </BarChart>
        </ResponsiveContainer>
      </div>

      {/* ì‹œí—˜ ìœ í˜•ë³„ ë°±ë¶„ìœ„ ë¶„í¬ */}
      {typeDistribution.types.length > 0 && (
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            ì‹œí—˜ ìœ í˜•ë³„ ë°±ë¶„ìœ„ ë¶„í¬
          </h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart
              data={typeDistribution.data}
              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="range" />
              <YAxis />
              <Tooltip formatter={(value: number) => `${value}%`} />
              <Legend />
              {typeDistribution.types.map((type, index) => {
                return (
                  <Bar
                    key={type}
                    dataKey={type}
                    fill={getChartColor(index)}
                    name={type}
                  />
                );
              })}
            </BarChart>
          </ResponsiveContainer>
        </div>
      )}

      {/* íšŒì°¨ë³„ í‰ê·  ë°±ë¶„ìœ„ ì¶”ì´ */}
      {roundTrend.length > 0 && (
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm lg:col-span-2">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            íšŒì°¨ë³„ í‰ê·  ë°±ë¶„ìœ„ ì¶”ì´
          </h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart
              data={roundTrend}
              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="round" />
              <YAxis domain={[0, 100]} />
              <Tooltip formatter={(value: number) => `${value}%`} />
              <Legend />
              <Line
                type="monotone"
                dataKey="average"
                stroke={getChartColor(0)}
                strokeWidth={2}
                name="í‰ê·  ë°±ë¶„ìœ„"
                dot={{ r: 6 }}
                activeDot={{ r: 8 }}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}
    </div>
  );
}
</file>

<file path="dashboard/mock/_components/MockSummarySection.tsx">
"use client";

import React from "react";
import type { MockScoreRow } from "../../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";
import { getGradeColor, getTrendColor } from "@/lib/constants/colors";

type MockSummarySectionProps = {
  mockScores: MockScoreRow[];
};

export function MockSummarySection({
  mockScores,
}: MockSummarySectionProps) {
  // ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„ ê³„ì‚°
  const mockAveragePercentile = React.useMemo(() => {
    if (mockScores.length === 0) return null;
    const validPercentiles = mockScores
      .map((s) => s.percentile)
      .filter((p): p is number => p !== null && p !== undefined);
    if (validPercentiles.length === 0) return null;
    const sum = validPercentiles.reduce((a, b) => a + b, 0);
    return sum / validPercentiles.length;
  }, [mockScores]);

  // ëª¨ì˜ê³ ì‚¬ í‰ê·  ë“±ê¸‰ ê³„ì‚°
  const mockAverageGrade = React.useMemo(() => {
    if (mockScores.length === 0) return null;
    const validGrades = mockScores
      .map((s) => s.grade_score)
      .filter((g): g is number => g !== null && g !== undefined);
    if (validGrades.length === 0) return null;
    const sum = validGrades.reduce((a, b) => a + b, 0);
    return sum / validGrades.length;
  }, [mockScores]);

  // ì‹œí—˜ ìœ í˜•ë³„ í‰ê·  ë°±ë¶„ìœ„
  const examTypeAverages = React.useMemo(() => {
    const typeMap = new Map<string, number[]>();
    mockScores.forEach((score) => {
      if (score.exam_type && score.percentile !== null) {
        if (!typeMap.has(score.exam_type)) {
          typeMap.set(score.exam_type, []);
        }
        typeMap.get(score.exam_type)!.push(score.percentile);
      }
    });

    const result: Array<{ type: string; average: number }> = [];
    typeMap.forEach((percentiles, type) => {
      const average = percentiles.reduce((a, b) => a + b, 0) / percentiles.length;
      result.push({ type, average: Number(average.toFixed(1)) });
    });
    return result.sort((a, b) => {
      const order = ["í‰ê°€ì›", "êµìœ¡ì²­", "ì‚¬ì„¤"];
      return order.indexOf(a.type) - order.indexOf(b.type);
    });
  }, [mockScores]);

  // íšŒì°¨ë³„ í‰ê·  ë°±ë¶„ìœ„
  const roundAverages = React.useMemo(() => {
    const roundMap = new Map<string, number[]>();
    mockScores.forEach((score) => {
      if (score.exam_round && score.percentile !== null) {
        if (!roundMap.has(score.exam_round)) {
          roundMap.set(score.exam_round, []);
        }
        roundMap.get(score.exam_round)!.push(score.percentile);
      }
    });

    const result: Array<{ round: string; average: number }> = [];
    roundMap.forEach((percentiles, round) => {
      const average = percentiles.reduce((a, b) => a + b, 0) / percentiles.length;
      result.push({ round, average: Number(average.toFixed(1)) });
    });
    return result.sort((a, b) => {
      const order = ["3ì›”", "4ì›”", "6ì›”", "9ì›”", "11ì›”", "ì‚¬ì„¤"];
      const indexA = order.indexOf(a.round);
      const indexB = order.indexOf(b.round);
      if (indexA === -1 && indexB === -1) return 0;
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return indexA - indexB;
    });
  }, [mockScores]);

  // ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  (ìµœì‹  3ê°œ)
  const recentMockScores = React.useMemo(() => {
    const sorted = [...mockScores]
      .filter((s) => s.percentile !== null || s.grade_score !== null)
      .sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });
    return sorted.slice(0, 3);
  }, [mockScores]);

  // ëª¨ì˜ê³ ì‚¬ ì¶”ì„¸ ê³„ì‚°
  const mockTrend = React.useMemo(() => {
    if (recentMockScores.length < 2) return null;
    const [latest, previous] = recentMockScores;
    if (!latest.percentile || !previous.percentile) return null;
    return latest.percentile > previous.percentile
      ? "improved"
      : latest.percentile < previous.percentile
      ? "declined"
      : "stable";
  }, [recentMockScores]);

  const trendColor = getTrendColor(mockTrend);
  const gradeColor = getGradeColor(
    mockAverageGrade ? Math.round(mockAverageGrade) : null
  );

  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {/* ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„ */}
      <Card>
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-600">
                ì „ì²´ í‰ê·  ë°±ë¶„ìœ„
              </p>
              <div className="flex items-baseline gap-2">
                {mockAveragePercentile !== null ? (
                  <>
                    <span className="text-3xl font-bold text-indigo-600">
                      {mockAveragePercentile.toFixed(1)}
                    </span>
                    <span className="text-lg text-gray-500">%</span>
                  </>
                ) : (
                  <span className="text-3xl font-bold text-gray-400">-</span>
                )}
              </div>
              {mockScores.length > 0 && (
                <p className="text-xs text-gray-500">
                  {mockScores.length}ê°œ ì„±ì  ê¸°ì¤€
                </p>
              )}
            </div>
            <div className="text-4xl">ğŸ“Š</div>
          </div>
          {mockTrend && (
            <div
              className={`flex items-center gap-2 rounded-lg px-3 py-2 ${trendColor.bg}`}
            >
              <span className={`text-sm font-medium ${trendColor.text}`}>
                {trendColor.icon}
              </span>
              <span className={`text-sm font-medium ${trendColor.text}`}>
                {mockTrend === "improved"
                  ? "ê°œì„ "
                  : mockTrend === "declined"
                  ? "í•˜ë½"
                  : "ìœ ì§€"}
              </span>
            </div>
          )}
        </div>
      </Card>

      {/* í‰ê·  ë“±ê¸‰ */}
      <Card>
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-600">í‰ê·  ë“±ê¸‰</p>
              <div className="flex items-baseline gap-2">
                {mockAverageGrade !== null ? (
                  <>
                    <span
                      className={`text-3xl font-bold ${gradeColor.text}`}
                    >
                      {mockAverageGrade.toFixed(1)}
                    </span>
                    <span className="text-lg text-gray-500">ë“±ê¸‰</span>
                  </>
                ) : (
                  <span className="text-3xl font-bold text-gray-400">-</span>
                )}
              </div>
            </div>
            <div className="text-4xl">â­</div>
          </div>
        </div>
      </Card>

      {/* ì‹œí—˜ ìœ í˜•ë³„ í‰ê·  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">ì‹œí—˜ ìœ í˜•ë³„ í‰ê· </p>
          {examTypeAverages.length > 0 ? (
            <div className="flex flex-col gap-2">
              {examTypeAverages.map((item) => (
                <div
                  key={item.type}
                  className="flex items-center justify-between rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-2"
                >
                  <span className="text-xs text-gray-600">{item.type}</span>
                  <span className="text-sm font-semibold text-indigo-700">
                    {item.average}%
                  </span>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>

      {/* ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì </p>
          {recentMockScores.length > 0 ? (
            <div className="flex flex-col gap-2">
              {recentMockScores.map((score) => {
                const gradeColor = getGradeColor(score.grade_score);
                return (
                  <div
                    key={score.id}
                    className="flex items-center justify-between rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-2"
                  >
                    <span className="text-xs text-gray-600">
                      {score.grade}í•™ë…„ {score.exam_round || "-"}íšŒì°¨
                    </span>
                    <div className="flex items-center gap-2">
                      {score.percentile !== null && (
                        <span className="text-sm font-semibold text-indigo-700">
                          {score.percentile.toFixed(1)}%
                        </span>
                      )}
                      {score.grade_score !== null && (
                        <span
                          className={`rounded-full px-2 py-1 text-xs font-semibold ${gradeColor.badge}`}
                        >
                          {score.grade_score}ë“±ê¸‰
                        </span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="dashboard/mock/_components/MockWeakSubjectSection.tsx">
"use client";

import React from "react";
import type { MockScoreRow } from "../../_utils/scoreQueries";
import { getRiskColorClasses, textPrimary, textMuted, borderDefault, bgPage } from "@/lib/utils/darkMode";
import { cn } from "@/lib/cn";

type MockWeakSubjectSectionProps = {
  mockScores: MockScoreRow[];
};

type WeakSubject = {
  subject: string;
  riskScore: number;
  reasons: string[];
  recentPercentiles: number[];
  recentGrades: number[];
  averagePercentile: number;
  averageGrade: number;
};

export function MockWeakSubjectSection({
  mockScores,
}: MockWeakSubjectSectionProps) {
  const weakSubjects = React.useMemo(() => {
    const results: WeakSubject[] = [];

    // ëª¨ì˜ê³ ì‚¬ ì·¨ì•½ ê³¼ëª© ë¶„ì„
    const mockBySubject = new Map<string, MockScoreRow[]>();
    mockScores.forEach((score) => {
      if (!score.subject_group || (score.percentile === null && score.grade_score === null))
        return;
      const key = score.subject_group;
      if (!mockBySubject.has(key)) {
        mockBySubject.set(key, []);
      }
      mockBySubject.get(key)!.push(score);
    });

    mockBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ íšŒì°¨ â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        const roundA = a.exam_round || "";
        const roundB = b.exam_round || "";
        if (roundA !== roundB) return roundB.localeCompare(roundA);
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA; // ìµœì‹ ìˆœ
      });

      const recent3 = sorted.slice(0, 3);
      const recentPercentiles = recent3
        .map((s) => s.percentile)
        .filter((p): p is number => p !== null && p !== undefined);
      const recentGrades = recent3
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);

      if (recentPercentiles.length === 0 && recentGrades.length === 0) return;

      const reasons: string[] = [];
      let riskScore = 0;

      // ë°±ë¶„ìœ„ 50 ë¯¸ë§Œ
      if (recentPercentiles.length > 0) {
        const avgPercentile =
          recentPercentiles.reduce((a, b) => a + b, 0) / recentPercentiles.length;
        if (avgPercentile < 50) {
          riskScore += 50;
          reasons.push(`í‰ê·  ë°±ë¶„ìœ„ ${avgPercentile.toFixed(1)}% (ë‚®ìŒ)`);
        } else if (avgPercentile < 60) {
          riskScore += 25;
          reasons.push(`í‰ê·  ë°±ë¶„ìœ„ ${avgPercentile.toFixed(1)}%`);
        }
      }

      // ë“±ê¸‰ 6 ì´ìƒ
      if (recentGrades.length > 0) {
        const avgGrade =
          recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length;
        if (avgGrade >= 6) {
          riskScore += 40;
          reasons.push(`í‰ê·  ë“±ê¸‰ ${avgGrade.toFixed(1)}ë“±ê¸‰ (ë‚®ìŒ)`);
        } else if (avgGrade >= 5) {
          riskScore += 20;
          reasons.push(`í‰ê·  ë“±ê¸‰ ${avgGrade.toFixed(1)}ë“±ê¸‰`);
        }
      }

      // ìµœê·¼ í•˜ë½
      if (recentPercentiles.length >= 2) {
        const latest = recentPercentiles[0];
        const previous = recentPercentiles[1];
        if (latest < previous) {
          const decline = previous - latest;
          riskScore += decline * 2;
          reasons.push(`ìµœê·¼ ë°±ë¶„ìœ„ ${decline.toFixed(1)}%p í•˜ë½`);
        }
      }

      // ë“±ê¸‰ í•˜ë½
      if (recentGrades.length >= 2) {
        const latest = recentGrades[0];
        const previous = recentGrades[1];
        if (latest > previous) {
          const decline = latest - previous;
          riskScore += decline * 15;
          reasons.push(`ìµœê·¼ ë“±ê¸‰ ${decline}ë‹¨ê³„ í•˜ë½`);
        }
      }

      // ì‹œí—˜ ìœ í˜•ë³„ í¸ì°¨
      const typeMap = new Map<string, number[]>();
      scores.forEach((score) => {
        if (score.exam_type && score.percentile !== null) {
          if (!typeMap.has(score.exam_type)) {
            typeMap.set(score.exam_type, []);
          }
          typeMap.get(score.exam_type)!.push(score.percentile);
        }
      });

      if (typeMap.size >= 2) {
        const typeAverages = Array.from(typeMap.entries()).map(([type, percentiles]) => ({
          type,
          average: percentiles.reduce((a, b) => a + b, 0) / percentiles.length,
        }));

        const max = Math.max(...typeAverages.map((t) => t.average));
        const min = Math.min(...typeAverages.map((t) => t.average));
        const diff = max - min;

        if (diff > 15) {
          riskScore += 20;
          reasons.push(`ì‹œí—˜ ìœ í˜•ë³„ í¸ì°¨ í¼ (${diff.toFixed(1)}%p)`);
        }
      }

      if (riskScore >= 30) {
        results.push({
          subject,
          riskScore: Math.min(100, riskScore),
          reasons,
          recentPercentiles,
          recentGrades,
          averagePercentile:
            recentPercentiles.length > 0
              ? recentPercentiles.reduce((a, b) => a + b, 0) / recentPercentiles.length
              : 0,
          averageGrade:
            recentGrades.length > 0
              ? recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length
              : 0,
        });
      }
    });

    // Risk Score ìˆœìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìˆœ)
    return results.sort((a, b) => b.riskScore - a.riskScore).slice(0, 5);
  }, [mockScores]);

  if (weakSubjects.length === 0) {
    return (
      <div className={cn("rounded-xl border border-dashed p-12 text-center", "border-gray-300 dark:border-gray-700", bgPage)}>
        <div className="mx-auto flex flex-col gap-2 max-w-md">
          <div className="text-6xl">âœ…</div>
          <h3 className={cn("text-lg font-semibold", textPrimary)}>
            ì·¨ì•½ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤
          </h3>
          <p className={cn("text-sm", textMuted)}>
            í˜„ì¬ ëª¨ì˜ê³ ì‚¬ ì„±ì ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ê³„ì† ìœ ì§€í•˜ì„¸ìš”!
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {weakSubjects.map((item, index) => (
        <div
          key={`${item.subject}-${index}`}
          className={cn("rounded-lg border p-6", getRiskColorClasses(item.riskScore))}
        >
          <div className="flex items-start justify-between">
            <div className="flex flex-col gap-2 flex-1">
              <div className="flex items-center gap-3">
                <h3 className={cn("text-lg font-semibold", textPrimary)}>{item.subject}</h3>
                <span className="text-xs font-medium px-2 py-1 rounded bg-white/50 dark:bg-gray-800/50">
                  ëª¨ì˜ê³ ì‚¬
                </span>
                <span className={cn("text-sm font-bold", textPrimary)}>
                  Risk Score: {item.riskScore}
                </span>
              </div>
              <div className="flex flex-col gap-1">
                {item.reasons.map((reason, idx) => (
                  <p key={idx} className={cn("text-sm", textPrimary)}>
                    â€¢ {reason}
                  </p>
                ))}
              </div>
              <div className={cn("flex flex-wrap gap-4 text-xs", textMuted)}>
                {item.recentPercentiles.length > 0 && (
                  <p>
                    ìµœê·¼ ë°±ë¶„ìœ„: {item.recentPercentiles.map(p => p.toFixed(1)).join(", ")}% (í‰ê· : {item.averagePercentile.toFixed(1)}%)
                  </p>
                )}
                {item.recentGrades.length > 0 && (
                  <p>
                    ìµœê·¼ ë“±ê¸‰: {item.recentGrades.join(", ")} (í‰ê· : {item.averageGrade.toFixed(1)})
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="dashboard/mock/page.tsx">
export const dynamic = 'force-dynamic';

import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ScoreTypeTabs } from "../../_components/ScoreTypeTabs";
import { DashboardSubTabs } from "../_components/DashboardSubTabs";
import { fetchMockScores } from "../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";
import { MockExamTrendSection } from "../_components/MockExamTrendSection";
import { MockSummarySection } from "./_components/MockSummarySection";
import { MockWeakSubjectSection } from "./_components/MockWeakSubjectSection";
import { MockInsightPanel } from "./_components/MockInsightPanel";
import { MockDetailedMetrics } from "./_components/MockDetailedMetrics";
import { MockExamTypeComparisonChart } from "./_components/MockExamTypeComparisonChart";
import { MockPercentileDistributionChart } from "./_components/MockPercentileDistributionChart";
import { getContainerClass } from "@/lib/constants/layout";
import { PageHeader } from "@/components/layout/PageHeader";

export default async function MockScoresDashboardPage() {
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ
  const mockScores = await fetchMockScores(user.id);

  return (
    <section className={getContainerClass("DASHBOARD", "md")}>
      <div className="flex flex-col gap-6">
        <PageHeader
          title="ëª¨ì˜ê³ ì‚¬ ì„±ì  ëŒ€ì‹œë³´ë“œ"
          description="ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ì‹œí—˜ ìœ í˜•Â·íšŒì°¨ë³„ë¡œ ë¶„ì„í•˜ê³  ì‹œê°í™”í•©ë‹ˆë‹¤."
        />

        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
        <div className="flex flex-col gap-4">
        <ScoreTypeTabs />
        <DashboardSubTabs />
      </div>

      {mockScores.length === 0 ? (
        <Card>
          <div className="flex flex-col items-center justify-center gap-4 p-8 text-center">
            <div className="text-6xl">ğŸ“Š</div>
            <div className="flex flex-col gap-2">
              <h3 className="text-xl font-semibold text-gray-900">
                ë“±ë¡ëœ ëª¨ì˜ê³ ì‚¬ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤
              </h3>
              <p className="text-sm text-gray-600">
                ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ë“±ë¡í•˜ë©´ ëŒ€ì‹œë³´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.
              </p>
            </div>
            <Link
              href="/scores/mock/1/3/í‰ê°€ì›"
              className="inline-flex items-center justify-center rounded-lg bg-purple-600 px-6 py-3 text-sm font-semibold text-white transition hover:bg-purple-700"
            >
              ëª¨ì˜ê³ ì‚¬ ì„±ì  ì…ë ¥
            </Link>
          </div>
        </Card>
      ) : (
        <div className="flex flex-col gap-8">
          {/* ëª¨ì˜ê³ ì‚¬ ì„±ì  ìš”ì•½ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ëª¨ì˜ê³ ì‚¬ ì„±ì  ìš”ì•½</h2>
            <MockSummarySection mockScores={mockScores} />
          </div>

          {/* ëª¨ì˜ê³ ì‚¬ ì„±ì  íŠ¸ë Œë“œ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ëª¨ì˜ê³ ì‚¬ ì„±ì  íŠ¸ë Œë“œ</h2>
            <Card>
              <MockExamTrendSection mockScores={mockScores} />
            </Card>
          </div>

          {/* ìƒì„¸ ì§€í‘œ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ìƒì„¸ ì§€í‘œ</h2>
            <MockDetailedMetrics mockScores={mockScores} />
          </div>

          {/* ì‹œí—˜ ìœ í˜•ë³„ ë¹„êµ ë° ë¶„í¬ ì°¨íŠ¸ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ì‹œí—˜ ìœ í˜•ë³„ ë¹„êµ ë° ë¶„í¬ ë¶„ì„</h2>
            <Card>
              <MockExamTypeComparisonChart mockScores={mockScores} />
            </Card>
            <Card>
              <MockPercentileDistributionChart mockScores={mockScores} />
            </Card>
          </div>

          {/* ì·¨ì•½ ê³¼ëª© ë¶„ì„ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ì·¨ì•½ ê³¼ëª© ë¶„ì„</h2>
            <MockWeakSubjectSection mockScores={mockScores} />
          </div>

          {/* í•™ìŠµ ì¸ì‚¬ì´íŠ¸ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">í•™ìŠµ ì¸ì‚¬ì´íŠ¸</h2>
            <MockInsightPanel mockScores={mockScores} />
          </div>
        </div>
      )}
      </div>
    </section>
  );
}
</file>

<file path="dashboard/school/_components/SchoolDetailedMetrics.tsx">
"use client";

import React from "react";
import type { SchoolScoreRow } from "../../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";
import { getGradeColor } from "@/lib/constants/colors";

type SchoolDetailedMetricsProps = {
  schoolScores: SchoolScoreRow[];
};

export function SchoolDetailedMetrics({
  schoolScores,
}: SchoolDetailedMetricsProps) {
  // í•™ë…„ë³„ ìƒì„¸ í†µê³„
  const gradeStats = React.useMemo(() => {
    const gradeMap = new Map<number, SchoolScoreRow[]>();
    schoolScores.forEach((score) => {
      if (score.grade) {
        if (!gradeMap.has(score.grade)) {
          gradeMap.set(score.grade, []);
        }
        gradeMap.get(score.grade)!.push(score);
      }
    });

    const result: Array<{
      grade: number;
      averageGrade: number;
      subjectCount: number;
      bestSubject: string | null;
      worstSubject: string | null;
    }> = [];

    gradeMap.forEach((scores, grade) => {
      const validGrades = scores
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);
      
      if (validGrades.length === 0) return;

      const averageGrade = validGrades.reduce((a, b) => a + b, 0) / validGrades.length;

      // ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰ ê³„ì‚°
      const subjectMap = new Map<string, number[]>();
      scores.forEach((score) => {
        if (score.subject_group && score.grade_score !== null) {
          if (!subjectMap.has(score.subject_group)) {
            subjectMap.set(score.subject_group, []);
          }
          subjectMap.get(score.subject_group)!.push(score.grade_score);
        }
      });

      let bestSubject: string | null = null;
      let worstSubject: string | null = null;
      let bestAverage = 10;
      let worstAverage = 0;

      subjectMap.forEach((grades, subject) => {
        const avg = grades.reduce((a, b) => a + b, 0) / grades.length;
        if (avg < bestAverage) {
          bestAverage = avg;
          bestSubject = subject;
        }
        if (avg > worstAverage) {
          worstAverage = avg;
          worstSubject = subject;
        }
      });

      result.push({
        grade,
        averageGrade: Number(averageGrade.toFixed(1)),
        subjectCount: subjectMap.size,
        bestSubject,
        worstSubject,
      });
    });

    return result.sort((a, b) => a.grade - b.grade);
  }, [schoolScores]);

  // í•™ê¸°ë³„ ìƒì„¸ í†µê³„
  const semesterStats = React.useMemo(() => {
    const semesterMap = new Map<string, SchoolScoreRow[]>();
    schoolScores.forEach((score) => {
      if (score.grade && score.semester) {
        const key = `${score.grade}-${score.semester}`;
        if (!semesterMap.has(key)) {
          semesterMap.set(key, []);
        }
        semesterMap.get(key)!.push(score);
      }
    });

    const result: Array<{
      period: string;
      averageGrade: number;
      subjectCount: number;
      totalSubjects: number;
    }> = [];

    semesterMap.forEach((scores, key) => {
      const [grade, semester] = key.split("-");
      const validGrades = scores
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null && g !== undefined);
      
      if (validGrades.length === 0) return;

      const averageGrade = validGrades.reduce((a, b) => a + b, 0) / validGrades.length;
      const subjectSet = new Set<string>();
      scores.forEach((score) => {
        if (score.subject_group) {
          subjectSet.add(score.subject_group);
        }
      });

      result.push({
        period: `${grade}í•™ë…„ ${semester}í•™ê¸°`,
        averageGrade: Number(averageGrade.toFixed(1)),
        subjectCount: subjectSet.size,
        totalSubjects: scores.length,
      });
    });

    return result.sort((a, b) => {
      const aMatch = a.period.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      const bMatch = b.period.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      if (!aMatch || !bMatch) return 0;
      const aGrade = parseInt(aMatch[1]);
      const bGrade = parseInt(bMatch[1]);
      if (aGrade !== bGrade) return aGrade - bGrade;
      const aSemester = parseInt(aMatch[2]);
      const bSemester = parseInt(bMatch[2]);
      return aSemester - bSemester;
    });
  }, [schoolScores]);

  // ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰
  const subjectAverages = React.useMemo(() => {
    const subjectMap = new Map<string, number[]>();
    schoolScores.forEach((score) => {
      if (score.subject_group && score.grade_score !== null) {
        if (!subjectMap.has(score.subject_group)) {
          subjectMap.set(score.subject_group, []);
        }
        subjectMap.get(score.subject_group)!.push(score.grade_score);
      }
    });

    const result: Array<{
      subject: string;
      average: number;
      count: number;
      trend: "improved" | "declined" | "stable" | null;
    }> = [];

    subjectMap.forEach((grades, subject) => {
      const average = grades.reduce((a, b) => a + b, 0) / grades.length;
      
      // ìµœê·¼ 2ê°œ ì„±ì  ë¹„êµë¡œ ì¶”ì„¸ ê³„ì‚°
      const sortedScores = schoolScores
        .filter((s) => s.subject_group === subject && s.grade_score !== null)
        .sort((a, b) => {
          // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
          if (a.grade !== b.grade) return b.grade - a.grade;
          if (a.semester !== b.semester) return b.semester - a.semester;
          const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
          const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
          return dateB - dateA;
        })
        .slice(0, 2);

      let trend: "improved" | "declined" | "stable" | null = null;
      if (sortedScores.length >= 2 && sortedScores[0].grade_score !== null && sortedScores[1].grade_score !== null) {
        const latest = sortedScores[0].grade_score;
        const previous = sortedScores[1].grade_score;
        if (latest < previous) trend = "improved";
        else if (latest > previous) trend = "declined";
        else trend = "stable";
      }

      result.push({
        subject,
        average: Number(average.toFixed(1)),
        count: grades.length,
        trend,
      });
    });

    return result.sort((a, b) => a.average - b.average); // ë“±ê¸‰ ë‚®ì€ ìˆœ (ì¢‹ì€ ìˆœ)
  }, [schoolScores]);

  if (schoolScores.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-col gap-6">
      {/* í•™ë…„ë³„ ìƒì„¸ í†µê³„ */}
      {gradeStats.length > 0 && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-4">
              <h3 className="text-lg font-semibold text-gray-900">
                í•™ë…„ë³„ ìƒì„¸ í†µê³„
              </h3>
              <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {gradeStats.map((stat) => {
                const gradeColor = getGradeColor(Math.round(stat.averageGrade));
                return (
                  <div
                    key={stat.grade}
                    className="rounded-lg border border-gray-200 p-4"
                  >
                    <div className="flex items-center justify-between">
                      <h4 className="text-base font-semibold text-gray-900">
                        {stat.grade}í•™ë…„
                      </h4>
                      <span
                        className={`rounded-full px-3 py-1 text-sm font-semibold ${gradeColor.badge}`}
                      >
                        {stat.averageGrade}ë“±ê¸‰
                      </span>
                    </div>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">ê³¼ëª© ìˆ˜</span>
                        <span className="font-medium text-gray-900">
                          {stat.subjectCount}ê°œ
                        </span>
                      </div>
                      {stat.bestSubject && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">ìµœê³  ê³¼ëª©</span>
                          <span className="font-medium text-green-600">
                            {stat.bestSubject}
                          </span>
                        </div>
                      )}
                      {stat.worstSubject && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">ì·¨ì•½ ê³¼ëª©</span>
                          <span className="font-medium text-red-600">
                            {stat.worstSubject}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
            </div>
          </div>
        </Card>
      )}

      {/* í•™ê¸°ë³„ ìƒì„¸ í†µê³„ */}
      {semesterStats.length > 0 && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-4">
              <h3 className="text-lg font-semibold text-gray-900">
                í•™ê¸°ë³„ ìƒì„¸ í†µê³„
              </h3>
              <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-gray-200">
                    <th className="text-left py-3 px-4 text-sm font-semibold text-gray-700">
                      í•™ê¸°
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      í‰ê·  ë“±ê¸‰
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      êµê³¼ ìˆ˜
                    </th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-gray-700">
                      ì„±ì  ìˆ˜
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {semesterStats.map((stat) => {
                    const gradeColor = getGradeColor(Math.round(stat.averageGrade));
                    return (
                      <tr
                        key={stat.period}
                        className="border-b border-gray-100 hover:bg-gray-50"
                      >
                        <td className="py-3 px-4 text-sm font-medium text-gray-900">
                          {stat.period}
                        </td>
                        <td className="py-3 px-4 text-center">
                          <span
                            className={`inline-block rounded-full px-3 py-1 text-sm font-semibold ${gradeColor.badge}`}
                          >
                            {stat.averageGrade}ë“±ê¸‰
                          </span>
                        </td>
                        <td className="py-3 px-4 text-center text-sm text-gray-600">
                          {stat.subjectCount}ê°œ
                        </td>
                        <td className="py-3 px-4 text-center text-sm text-gray-600">
                          {stat.totalSubjects}ê°œ
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            </div>
          </div>
        </Card>
      )}

      {/* ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰ */}
      {subjectAverages.length > 0 && (
        <Card>
          <div className="p-6">
            <div className="flex flex-col gap-4">
              <h3 className="text-lg font-semibold text-gray-900">
                ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰
              </h3>
              <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {subjectAverages.map((item) => {
                const gradeColor = getGradeColor(Math.round(item.average));
                const trendIcon =
                  item.trend === "improved"
                    ? "â†‘"
                    : item.trend === "declined"
                    ? "â†“"
                    : item.trend === "stable"
                    ? "â†’"
                    : "";
                const trendColor =
                  item.trend === "improved"
                    ? "text-green-600"
                    : item.trend === "declined"
                    ? "text-red-600"
                    : "text-gray-600";

                return (
                  <div
                    key={item.subject}
                    className="flex items-center justify-between rounded-lg border border-gray-200 p-3"
                  >
                    <div className="flex flex-col gap-1">
                      <span className="text-sm font-medium text-gray-900">
                        {item.subject}
                      </span>
                      <span className="text-xs text-gray-500">
                        {item.count}ê°œ ì„±ì 
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      {item.trend && (
                        <span className={`text-sm font-semibold ${trendColor}`}>
                          {trendIcon}
                        </span>
                      )}
                      <span
                        className={`rounded-full px-3 py-1 text-sm font-semibold ${gradeColor.badge}`}
                      >
                        {item.average}ë“±ê¸‰
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
            </div>
          </div>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="dashboard/school/_components/SchoolGradeDistributionChart.tsx">
"use client";

import React from "react";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SchoolScoreRow } from "../../_utils/scoreQueries";
import { getChartColor } from "@/lib/constants/colors";

type SchoolGradeDistributionChartProps = {
  schoolScores: SchoolScoreRow[];
};

export function SchoolGradeDistributionChart({
  schoolScores,
}: SchoolGradeDistributionChartProps) {
  const { recharts, loading } = useRecharts();

  // ë“±ê¸‰ë³„ ë¶„í¬ ë°ì´í„° ìƒì„±
  const distributionData = React.useMemo(() => {
    const gradeCount = new Map<number, number>();
    
    schoolScores.forEach((score) => {
      if (score.grade_score !== null && score.grade_score !== undefined) {
        const grade = Math.round(score.grade_score);
        gradeCount.set(grade, (gradeCount.get(grade) || 0) + 1);
      }
    });

    const result: Array<{ grade: string; count: number; percentage: number }> = [];
    const total = schoolScores.filter((s) => s.grade_score !== null).length;

    for (let i = 1; i <= 9; i++) {
      const count = gradeCount.get(i) || 0;
      const percentage = total > 0 ? (count / total) * 100 : 0;
      result.push({
        grade: `${i}ë“±ê¸‰`,
        count,
        percentage: Number(percentage.toFixed(1)),
      });
    }

    return result;
  }, [schoolScores]);

  // í•™ë…„ë³„ ë“±ê¸‰ ë¶„í¬
  const gradeDistribution = React.useMemo(() => {
    const gradeMap = new Map<number, Map<number, number>>();

    schoolScores.forEach((score) => {
      if (score.grade && score.grade_score !== null) {
        if (!gradeMap.has(score.grade)) {
          gradeMap.set(score.grade, new Map());
        }
        const distribution = gradeMap.get(score.grade)!;
        const grade = Math.round(score.grade_score);
        distribution.set(grade, (distribution.get(grade) || 0) + 1);
      }
    });

    const result: Array<Record<string, number | string>> = [];

    for (let grade = 1; grade <= 9; grade++) {
      const dataPoint: Record<string, number | string> = { grade: `${grade}ë“±ê¸‰` };
      
      gradeMap.forEach((distribution, studentGrade) => {
        dataPoint[`${studentGrade}í•™ë…„`] = distribution.get(grade) || 0;
      });

      result.push(dataPoint);
    }

    return { data: result, grades: Array.from(gradeMap.keys()).sort() };
  }, [schoolScores]);

  if (schoolScores.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-12 text-center">
        <div className="mx-auto flex flex-col gap-2 max-w-md">
          <div className="text-6xl">ğŸ“Š</div>
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
          </h3>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            ë‚´ì‹  ì„±ì ì„ ë“±ë¡í•˜ë©´ ë¶„í¬ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  // Show loading skeleton while recharts is loading
  if (loading || !recharts) {
    return (
      <div className="grid gap-6 lg:grid-cols-2">
        <ChartLoadingSkeleton height={300} />
        <ChartLoadingSkeleton height={300} />
      </div>
    );
  }

  const {
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    Legend,
    ResponsiveContainer,
  } = recharts;

  return (
    <div className="grid gap-6 lg:grid-cols-2">
      {/* ì „ì²´ ë“±ê¸‰ ë¶„í¬ */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
          ì „ì²´ ë“±ê¸‰ ë¶„í¬
        </h3>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={distributionData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="grade" />
            <YAxis />
            <Tooltip
              formatter={(value: number, name: string) => {
                if (name === "count") return [`${value}ê°œ`, "ê°œìˆ˜"];
                if (name === "percentage") return [`${value}%`, "ë¹„ìœ¨"];
                return [value, name];
              }}
            />
            <Legend />
            <Bar dataKey="count" fill={getChartColor(0)} name="ê°œìˆ˜" />
            <Bar dataKey="percentage" fill={getChartColor(1)} name="ë¹„ìœ¨(%)" />
          </BarChart>
        </ResponsiveContainer>
      </div>

      {/* í•™ë…„ë³„ ë“±ê¸‰ ë¶„í¬ */}
      {gradeDistribution.grades.length > 0 && (
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
            í•™ë…„ë³„ ë“±ê¸‰ ë¶„í¬
          </h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart
              data={gradeDistribution.data}
              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="grade" />
              <YAxis />
              <Tooltip />
              <Legend />
              {gradeDistribution.grades.map((grade, index) => {
                const colors = ["#6366f1", "#8b5cf6", "#ec4899"];
                return (
                  <Bar
                    key={grade}
                    dataKey={`${grade}í•™ë…„`}
                    fill={colors[index % colors.length]}
                    name={`${grade}í•™ë…„`}
                  />
                );
              })}
            </BarChart>
          </ResponsiveContainer>
        </div>
      )}
    </div>
  );
}
</file>

<file path="dashboard/school/_components/SchoolHeatmapChart.tsx">
"use client";

import React from "react";
import { Card, CardContent } from "@/components/molecules/Card";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { SchoolScoreRow } from "../../_utils/scoreQueries";
import { getGradeColorHex, getChartColor } from "@/lib/constants/colors";
import { EmptyState } from "@/components/molecules/EmptyState";

type SchoolHeatmapChartProps = {
  schoolScores: SchoolScoreRow[];
};

export function SchoolHeatmapChart({
  schoolScores,
}: SchoolHeatmapChartProps) {
  const { recharts, loading } = useRecharts();
  // í•™ê¸°ë³„/ê³¼ëª©ë³„ ë“±ê¸‰ íˆíŠ¸ë§µ ë°ì´í„° ìƒì„±
  const heatmapData = React.useMemo(() => {
    const semesterMap = new Map<string, Map<string, number[]>>();

    schoolScores.forEach((score) => {
      if (!score.grade || !score.semester || !score.subject_group || score.grade_score === null) return;
      
      const periodKey = `${score.grade}í•™ë…„ ${score.semester}í•™ê¸°`;
      if (!semesterMap.has(periodKey)) {
        semesterMap.set(periodKey, new Map());
      }
      const subjectMap = semesterMap.get(periodKey)!;
      
      if (!subjectMap.has(score.subject_group)) {
        subjectMap.set(score.subject_group, []);
      }
      subjectMap.get(score.subject_group)!.push(score.grade_score);
    });

    // ëª¨ë“  ê³¼ëª© ìˆ˜ì§‘
    const allSubjects = new Set<string>();
    semesterMap.forEach((subjectMap) => {
      subjectMap.forEach((_, subject) => {
        allSubjects.add(subject);
      });
    });

    // í•™ê¸° ìˆœì„œ ì •ë ¬
    const sortedPeriods = Array.from(semesterMap.keys()).sort((a, b) => {
      const aMatch = a.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      const bMatch = b.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      if (!aMatch || !bMatch) return 0;
      const aGrade = parseInt(aMatch[1]);
      const bGrade = parseInt(bMatch[1]);
      if (aGrade !== bGrade) return aGrade - bGrade;
      const aSemester = parseInt(aMatch[2]);
      const bSemester = parseInt(bMatch[2]);
      return aSemester - bSemester;
    });

    // ì°¨íŠ¸ ë°ì´í„° ìƒì„±
    const result: Array<Record<string, number | string>> = [];

    sortedPeriods.forEach((period) => {
      const dataPoint: Record<string, number | string> = { period };
      const subjectMap = semesterMap.get(period)!;

      allSubjects.forEach((subject) => {
        const grades = subjectMap.get(subject);
        if (grades && grades.length > 0) {
          const average = grades.reduce((a, b) => a + b, 0) / grades.length;
          dataPoint[subject] = Number(average.toFixed(1));
        } else {
          dataPoint[subject] = 0; // ë°ì´í„° ì—†ìŒ
        }
      });

      result.push(dataPoint);
    });

    return { data: result, subjects: Array.from(allSubjects) };
  }, [schoolScores]);

  if (schoolScores.length === 0 || heatmapData.subjects.length === 0) {
    return (
      <EmptyState
        icon="ğŸ“Š"
        title="íˆíŠ¸ë§µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"
        description="ë‚´ì‹  ì„±ì ì„ ë“±ë¡í•˜ë©´ íˆíŠ¸ë§µì´ í‘œì‹œë©ë‹ˆë‹¤."
      />
    );
  }

  if (loading || !recharts) {
    return (
      <Card padding="md">
        <CardContent className="flex flex-col gap-4">
          <ChartLoadingSkeleton height={400} />
        </CardContent>
      </Card>
    );
  }

  const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } = recharts;

  // ë“±ê¸‰ë³„ ìƒ‰ìƒì€ getGradeColorHex í•¨ìˆ˜ ì‚¬ìš©

  return (
    <Card padding="md">
      <CardContent className="flex flex-col gap-4">
      <h2 className="text-h2 text-text-primary">
        í•™ê¸°ë³„/ê³¼ëª©ë³„ ë“±ê¸‰ íˆíŠ¸ë§µ
      </h2>
      <div className="flex flex-col gap-2 text-body-2 text-text-secondary">
        <p>ê° ì…€ì˜ ìƒ‰ìƒì€ í•´ë‹¹ í•™ê¸°/ê³¼ëª©ì˜ í‰ê·  ë“±ê¸‰ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2">
            <div className="h-4 w-4 rounded bg-info-500"></div>
            <span className="text-body-2">1-2ë“±ê¸‰</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="h-4 w-4 rounded bg-primary-500"></div>
            <span className="text-body-2">3ë“±ê¸‰</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="h-4 w-4 rounded bg-warning-500"></div>
            <span className="text-body-2">5ë“±ê¸‰</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="h-4 w-4 rounded bg-error-500"></div>
            <span className="text-body-2">6-9ë“±ê¸‰</span>
          </div>
        </div>
      </div>
      <ResponsiveContainer width="100%" height={400}>
        <BarChart
          data={heatmapData.data}
          margin={{ top: 20, right: 30, left: 20, bottom: 60 }}
        >
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis
            dataKey="period"
            angle={-45}
            textAnchor="end"
            height={100}
            interval={0}
          />
          <YAxis
            domain={[1, 9]}
            reversed
            label={{ value: "ë“±ê¸‰", angle: -90, position: "insideLeft" }}
          />
          <Tooltip
            formatter={(value: number, name: string) => {
              if (value === 0) return ["ë°ì´í„° ì—†ìŒ", name];
              return [`${value}ë“±ê¸‰`, name];
            }}
          />
          <Legend />
          {heatmapData.subjects.map((subject, index) => (
            <Bar
              key={subject}
              dataKey={subject}
              stackId="a"
              name={subject}
              fill={getChartColor(index)}
            >
              {heatmapData.data.map((entry, idx) => {
                const grade = entry[subject] as number;
                if (grade === 0) return <Cell key={idx} fill="rgb(243 244 246)" />;
                return <Cell key={idx} fill={getGradeColorHex(grade)} />;
              })}
            </Bar>
          ))}
        </BarChart>
      </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
</file>

<file path="dashboard/school/_components/SchoolInsightPanel.tsx">
"use client";

import React from "react";
import type { SchoolScoreRow } from "../../_utils/scoreQueries";

type SchoolInsightPanelProps = {
  schoolScores: SchoolScoreRow[];
};

export function SchoolInsightPanel({
  schoolScores,
}: SchoolInsightPanelProps) {
  const insights = React.useMemo(() => {
    const result: string[] = [];

    // 1. êµê³¼ë³„ ìµœê·¼ í•˜ë½ ì¶”ì„¸ ë¶„ì„
    const schoolBySubject = new Map<string, SchoolScoreRow[]>();
    schoolScores.forEach((score) => {
      if (!score.subject_group || score.grade_score === null) return;
      const key = score.subject_group;
      if (!schoolBySubject.has(key)) {
        schoolBySubject.set(key, []);
      }
      schoolBySubject.get(key)!.push(score);
    });

    schoolBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        if (a.semester !== b.semester) return b.semester - a.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });

      if (sorted.length >= 2) {
        const recent2 = sorted.slice(0, 2);
        const grades = recent2
          .map((s) => s.grade_score)
          .filter((g): g is number => g !== null);

        if (grades.length === 2 && grades[0] > grades[1]) {
          // ë“±ê¸‰ì´ ë†’ì•„ì¡Œë‹¤ëŠ” ê²ƒì€ ë‚˜ë¹ ì¡Œë‹¤ëŠ” ì˜ë¯¸
          result.push(
            `${subject} ê³¼ëª©ì€ ìµœê·¼ ë‘ ë²ˆ ì—°ì† ë“±ê¸‰ì´ í•˜ë½í–ˆìŠµë‹ˆë‹¤. (${grades[1]}ë“±ê¸‰ â†’ ${grades[0]}ë“±ê¸‰) ê¸°ì´ˆ ê°œë… ë³µìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.`
          );
        }
      }
    });

    // 2. í•™ê¸°ë³„ í•˜ë½ ì¶”ì„¸
    const semesterBySubject = new Map<string, Map<string, number[]>>();
    schoolScores.forEach((score) => {
      if (!score.subject_group || !score.grade || !score.semester || score.grade_score === null) return;
      const subject = score.subject_group;
      const semesterKey = `${score.grade}-${score.semester}`;
      
      if (!semesterBySubject.has(subject)) {
        semesterBySubject.set(subject, new Map());
      }
      const subjectMap = semesterBySubject.get(subject)!;
      
      if (!subjectMap.has(semesterKey)) {
        subjectMap.set(semesterKey, []);
      }
      subjectMap.get(semesterKey)!.push(score.grade_score);
    });

    semesterBySubject.forEach((semesterMap, subject) => {
      const semesterAverages = Array.from(semesterMap.entries())
        .map(([key, grades]) => ({
          key,
          average: grades.reduce((a, b) => a + b, 0) / grades.length,
        }))
        .sort((a, b) => {
          const [aGrade, aSem] = a.key.split("-").map(Number);
          const [bGrade, bSem] = b.key.split("-").map(Number);
          if (aGrade !== bGrade) return aGrade - bGrade;
          return aSem - bSem;
        });

      if (semesterAverages.length >= 2) {
        const latest = semesterAverages[semesterAverages.length - 1];
        const previous = semesterAverages[semesterAverages.length - 2];
        if (latest.average > previous.average + 0.5) {
          result.push(
            `${subject} ê³¼ëª©ì€ ${previous.key.replace("-", "í•™ë…„ ").replace("-", "í•™ê¸°")}ì—ì„œ ${latest.key.replace("-", "í•™ë…„ ").replace("-", "í•™ê¸°")}ë¡œ ë“±ê¸‰ì´ í•˜ë½í–ˆìŠµë‹ˆë‹¤. (${previous.average.toFixed(1)}ë“±ê¸‰ â†’ ${latest.average.toFixed(1)}ë“±ê¸‰)`
          );
        }
      }
    });

    // 3. ì•ˆì •ì ì¸ ê³¼ëª© ì¹­ì°¬
    schoolBySubject.forEach((scores, subject) => {
      if (scores.length >= 3) {
        const grades = scores
          .map((s) => s.grade_score)
          .filter((g): g is number => g !== null)
          .slice(0, 3);

        if (grades.length === 3) {
          const mean = grades.reduce((a, b) => a + b, 0) / grades.length;
          const variance =
            grades.reduce((sum, g) => sum + Math.pow(g - mean, 2), 0) /
            grades.length;

          if (variance < 0.5) {
            // í¸ì°¨ê°€ ì‘ìœ¼ë©´ ì•ˆì •ì 
            result.push(
              `${subject} ë‚´ì‹ ì€ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤. (í‰ê·  ${mean.toFixed(1)}ë“±ê¸‰) í˜„ì¬ í•™ìŠµ íŒ¨í„´ì„ ê³„ì† ìœ ì§€í•˜ì„¸ìš”.`
            );
          }
        }
      }
    });

    // 4. í•™ë…„ë³„ ì„±ì  í–¥ìƒ
    const gradeMap = new Map<number, number[]>();
    schoolScores.forEach((score) => {
      if (score.grade && score.grade_score !== null) {
        if (!gradeMap.has(score.grade)) {
          gradeMap.set(score.grade, []);
        }
        gradeMap.get(score.grade)!.push(score.grade_score);
      }
    });

    const gradeAverages = Array.from(gradeMap.entries())
      .map(([grade, grades]) => ({
        grade,
        average: grades.reduce((a, b) => a + b, 0) / grades.length,
      }))
      .sort((a, b) => a.grade - b.grade);

    if (gradeAverages.length >= 2) {
      const latest = gradeAverages[gradeAverages.length - 1];
      const previous = gradeAverages[gradeAverages.length - 2];
      if (latest.average < previous.average - 0.3) {
        result.push(
          `${previous.grade}í•™ë…„ ëŒ€ë¹„ ${latest.grade}í•™ë…„ í‰ê·  ë“±ê¸‰ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤. (${previous.average.toFixed(1)}ë“±ê¸‰ â†’ ${latest.average.toFixed(1)}ë“±ê¸‰)`
        );
      }
    }

    return result.slice(0, 5); // ìµœëŒ€ 5ê°œ
  }, [schoolScores]);

  if (insights.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
        <div className="mx-auto flex flex-col gap-2 max-w-md">
          <div className="text-6xl">ğŸ’¡</div>
          <h3 className="text-lg font-semibold text-gray-900">
            ì¸ì‚¬ì´íŠ¸ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤
          </h3>
          <p className="text-sm text-gray-500">
            ë” ë§ì€ ë‚´ì‹  ì„±ì  ë°ì´í„°ë¥¼ ë“±ë¡í•˜ë©´ í•™ìŠµ ì¸ì‚¬ì´íŠ¸ê°€ ì œê³µë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-indigo-200 bg-indigo-50 p-6 shadow-sm">
      <h2 className="text-xl font-semibold text-indigo-900">
        ë‚´ì‹  í•™ìŠµ ì¸ì‚¬ì´íŠ¸
      </h2>
      <div className="flex flex-col gap-3">
        {insights.map((insight, index) => (
          <div
            key={index}
            className="rounded-lg border border-indigo-200 bg-white p-4"
          >
            <div className="flex items-start gap-3">
              <span className="text-lg">ğŸ’¡</span>
              <p className="text-sm text-gray-700 flex-1">{insight}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="dashboard/school/_components/SchoolSummarySection.tsx">
"use client";

import React from "react";
import type { SchoolScoreRow } from "../../_utils/scoreQueries";
import { Card } from "@/components/molecules/Card";
import { getGradeColor, getTrendColor } from "@/lib/constants/colors";

type SchoolSummarySectionProps = {
  schoolScores: SchoolScoreRow[];
};

export function SchoolSummarySection({
  schoolScores,
}: SchoolSummarySectionProps) {
  // ë‚´ì‹  í‰ê·  ë“±ê¸‰ ê³„ì‚°
  const schoolAverageGrade = React.useMemo(() => {
    if (schoolScores.length === 0) return null;
    const validGrades = schoolScores
      .map((s) => s.grade_score)
      .filter((g): g is number => g !== null && g !== undefined);
    if (validGrades.length === 0) return null;
    const sum = validGrades.reduce((a, b) => a + b, 0);
    return sum / validGrades.length;
  }, [schoolScores]);

  // í•™ë…„ë³„ í‰ê·  ë“±ê¸‰
  const gradeAverages = React.useMemo(() => {
    const gradeMap = new Map<number, number[]>();
    schoolScores.forEach((score) => {
      if (score.grade && score.grade_score !== null) {
        if (!gradeMap.has(score.grade)) {
          gradeMap.set(score.grade, []);
        }
        gradeMap.get(score.grade)!.push(score.grade_score);
      }
    });

    const result: Array<{ grade: number; average: number }> = [];
    gradeMap.forEach((grades, grade) => {
      const average = grades.reduce((a, b) => a + b, 0) / grades.length;
      result.push({ grade, average: Number(average.toFixed(1)) });
    });
    return result.sort((a, b) => a.grade - b.grade);
  }, [schoolScores]);

  // í•™ê¸°ë³„ í‰ê·  ë“±ê¸‰
  const semesterAverages = React.useMemo(() => {
    const semesterMap = new Map<string, number[]>();
    schoolScores.forEach((score) => {
      if (score.grade && score.semester && score.grade_score !== null) {
        const key = `${score.grade}-${score.semester}`;
        if (!semesterMap.has(key)) {
          semesterMap.set(key, []);
        }
        semesterMap.get(key)!.push(score.grade_score);
      }
    });

    const result: Array<{ period: string; average: number }> = [];
    semesterMap.forEach((grades, key) => {
      const [grade, semester] = key.split("-");
      const average = grades.reduce((a, b) => a + b, 0) / grades.length;
      result.push({
        period: `${grade}í•™ë…„ ${semester}í•™ê¸°`,
        average: Number(average.toFixed(1)),
      });
    });
    return result.sort((a, b) => {
      const aMatch = a.period.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      const bMatch = b.period.match(/(\d)í•™ë…„ (\d)í•™ê¸°/);
      if (!aMatch || !bMatch) return 0;
      const aGrade = parseInt(aMatch[1]);
      const bGrade = parseInt(bMatch[1]);
      if (aGrade !== bGrade) return aGrade - bGrade;
      const aSemester = parseInt(aMatch[2]);
      const bSemester = parseInt(bMatch[2]);
      return aSemester - bSemester;
    });
  }, [schoolScores]);

  // ìµœê·¼ ë‚´ì‹  ì„±ì  (ìµœì‹  3ê°œ)
  const recentSchoolScores = React.useMemo(() => {
    const sorted = [...schoolScores]
      .filter((s) => s.grade_score !== null)
      .sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        if (a.semester !== b.semester) return b.semester - a.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA;
      });
    return sorted.slice(0, 3);
  }, [schoolScores]);

  // ë‚´ì‹  ì¶”ì„¸ ê³„ì‚°
  const schoolTrend = React.useMemo(() => {
    if (recentSchoolScores.length < 2) return null;
    const [latest, previous] = recentSchoolScores;
    if (!latest.grade_score || !previous.grade_score) return null;
    // ë“±ê¸‰ì€ ë‚®ì„ìˆ˜ë¡ ì¢‹ìœ¼ë¯€ë¡œ, ë“±ê¸‰ì´ ë‚®ì•„ì§€ë©´(ìˆ«ìê°€ ì‘ì•„ì§€ë©´) ê°œì„ 
    return latest.grade_score < previous.grade_score
      ? "improved"
      : latest.grade_score > previous.grade_score
      ? "declined"
      : "stable";
  }, [recentSchoolScores]);

  const schoolGradeColor = getGradeColor(
    schoolAverageGrade ? Math.round(schoolAverageGrade) : null
  );
  const trendColor = getTrendColor(schoolTrend);

  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {/* ë‚´ì‹  í‰ê·  ë“±ê¸‰ */}
      <Card>
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <div className="flex flex-col gap-1">
              <p className="text-sm font-medium text-gray-600">ì „ì²´ í‰ê·  ë“±ê¸‰</p>
              <div className="flex items-baseline gap-2">
                {schoolAverageGrade !== null ? (
                  <>
                    <span
                      className={`text-3xl font-bold ${schoolGradeColor.text}`}
                    >
                      {schoolAverageGrade.toFixed(1)}
                    </span>
                    <span className="text-lg text-gray-500">ë“±ê¸‰</span>
                  </>
                ) : (
                  <span className="text-3xl font-bold text-gray-400">-</span>
                )}
              </div>
              {schoolScores.length > 0 && (
                <p className="text-xs text-gray-500">
                  {schoolScores.length}ê°œ ì„±ì  ê¸°ì¤€
                </p>
              )}
            </div>
            <div className="text-4xl">ğŸ“š</div>
          </div>
          {schoolTrend && (
            <div
              className={`flex items-center gap-2 rounded-lg px-3 py-2 ${trendColor.bg}`}
            >
              <span className={`text-sm font-medium ${trendColor.text}`}>
                {trendColor.icon}
              </span>
              <span className={`text-sm font-medium ${trendColor.text}`}>
                {schoolTrend === "improved"
                  ? "ê°œì„ "
                  : schoolTrend === "declined"
                  ? "í•˜ë½"
                  : "ìœ ì§€"}
              </span>
            </div>
          )}
        </div>
      </Card>

      {/* í•™ë…„ë³„ í‰ê·  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">í•™ë…„ë³„ í‰ê· </p>
          {gradeAverages.length > 0 ? (
            <div className="flex flex-col gap-2">
              {gradeAverages.map((item) => {
                const gradeColor = getGradeColor(Math.round(item.average));
                return (
                  <div
                    key={item.grade}
                    className="flex items-center justify-between rounded-lg border px-3 py-2"
                  >
                    <span className="text-xs text-gray-600">
                      {item.grade}í•™ë…„
                    </span>
                    <span
                      className={`rounded-full px-2 py-1 text-sm font-semibold ${gradeColor.badge}`}
                    >
                      {item.average}ë“±ê¸‰
                    </span>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>

      {/* ìµœê·¼ í•™ê¸° í‰ê·  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">ìµœê·¼ í•™ê¸° í‰ê· </p>
          {semesterAverages.length > 0 ? (
            <div className="flex flex-col gap-2">
              {semesterAverages.slice(-2).map((item) => {
                const gradeColor = getGradeColor(Math.round(item.average));
                return (
                  <div
                    key={item.period}
                    className="flex items-center justify-between rounded-lg border px-3 py-2"
                  >
                    <span className="text-xs text-gray-600">{item.period}</span>
                    <span
                      className={`rounded-full px-2 py-1 text-sm font-semibold ${gradeColor.badge}`}
                    >
                      {item.average}ë“±ê¸‰
                    </span>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>

      {/* ìµœê·¼ ë‚´ì‹  ì„±ì  */}
      <Card>
        <div className="flex flex-col gap-3">
          <p className="text-sm font-medium text-gray-600">ìµœê·¼ ë‚´ì‹  ì„±ì </p>
          {recentSchoolScores.length > 0 ? (
            <div className="flex flex-col gap-2">
              {recentSchoolScores.map((score) => {
                const gradeColor = getGradeColor(score.grade_score);
                return (
                  <div
                    key={score.id}
                    className={`flex items-center justify-between rounded-lg border px-3 py-2 ${gradeColor.border} ${gradeColor.bg}`}
                  >
                    <span className="text-xs text-gray-600">
                      {score.grade}í•™ë…„ {score.semester}í•™ê¸°
                    </span>
                    <span
                      className={`rounded-full px-2 py-1 text-sm font-semibold ${gradeColor.badge}`}
                    >
                      {score.grade_score !== null
                        ? `${score.grade_score}ë“±ê¸‰`
                        : "-"}
                    </span>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</p>
          )}
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="dashboard/school/_components/SchoolWeakSubjectSection.tsx">
"use client";

import React from "react";
import type { SchoolScoreRow } from "../../_utils/scoreQueries";
import { EmptyState } from "@/components/molecules/EmptyState";
import { getRiskColorClasses, textPrimary, textMuted } from "@/lib/utils/darkMode";
import { cn } from "@/lib/cn";

type SchoolWeakSubjectSectionProps = {
  schoolScores: SchoolScoreRow[];
};

type WeakSubject = {
  subject: string;
  riskScore: number;
  reasons: string[];
  recentGrades: number[];
  averageGrade: number;
};

export function SchoolWeakSubjectSection({
  schoolScores,
}: SchoolWeakSubjectSectionProps) {
  const weakSubjects = React.useMemo(() => {
    const results: WeakSubject[] = [];

    // ë‚´ì‹  ì·¨ì•½ ê³¼ëª© ë¶„ì„
    const schoolBySubject = new Map<string, SchoolScoreRow[]>();
    schoolScores.forEach((score) => {
      if (!score.subject_group || score.grade_score === null) return;
      const key = score.subject_group;
      if (!schoolBySubject.has(key)) {
        schoolBySubject.set(key, []);
      }
      schoolBySubject.get(key)!.push(score);
    });

    schoolBySubject.forEach((scores, subject) => {
      const sorted = scores.sort((a, b) => {
        // í•™ë…„ â†’ í•™ê¸° â†’ ìƒì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
        if (a.grade !== b.grade) return b.grade - a.grade;
        if (a.semester !== b.semester) return b.semester - a.semester;
        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return dateB - dateA; // ìµœì‹ ìˆœ
      });

      const recent3 = sorted.slice(0, 3);
      const recentGrades = recent3
        .map((s) => s.grade_score)
        .filter((g): g is number => g !== null);

      if (recentGrades.length === 0) return;

      const averageGrade =
        recentGrades.reduce((a, b) => a + b, 0) / recentGrades.length;

      const reasons: string[] = [];
      let riskScore = 0;

      // 1. ìµœê·¼ 3íšŒ í‰ê·  ê¸°ì¤€ (6ë“±ê¸‰ ì´í•˜)
      if (averageGrade >= 6) {
        riskScore += 40;
        reasons.push(`í‰ê·  ë“±ê¸‰ ${averageGrade.toFixed(1)}ë“±ê¸‰ (ë‚®ìŒ)`);
      } else if (averageGrade >= 5) {
        riskScore += 20;
        reasons.push(`í‰ê·  ë“±ê¸‰ ${averageGrade.toFixed(1)}ë“±ê¸‰`);
      }

      // 2. ìµœê·¼ ì ìˆ˜ í•˜ë½ ê°€ì¤‘ì¹˜
      if (recentGrades.length >= 2) {
        const latest = recentGrades[0];
        const previous = recentGrades[1];
        if (latest > previous) {
          // ë“±ê¸‰ì´ ë†’ì•„ì¡Œë‹¤ëŠ” ê²ƒì€ ë‚˜ë¹ ì¡Œë‹¤ëŠ” ì˜ë¯¸
          const decline = latest - previous;
          riskScore += decline * 15;
          reasons.push(`ìµœê·¼ ë“±ê¸‰ ${decline}ë‹¨ê³„ í•˜ë½`);
        }
      }

      // 3. ì›ì ìˆ˜ í¸ì°¨
      const rawScores = recent3
        .map((s) => s.raw_score)
        .filter((r): r is number => r !== null && r !== undefined);

      if (rawScores.length >= 2) {
        const mean = rawScores.reduce((a, b) => a + b, 0) / rawScores.length;
        const variance =
          rawScores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) /
          rawScores.length;
        const stdDev = Math.sqrt(variance);

        if (stdDev > mean * 0.2) {
          riskScore += 20;
          reasons.push(`ì ìˆ˜ í¸ì°¨ í¼ (ë¶ˆì•ˆì •)`);
        }
      }

      // 4. í•™ê¸°ë³„ í•˜ë½ ì¶”ì„¸
      const semesterMap = new Map<string, number[]>();
      scores.forEach((score) => {
        if (score.grade && score.semester && score.grade_score !== null) {
          const key = `${score.grade}-${score.semester}`;
          if (!semesterMap.has(key)) {
            semesterMap.set(key, []);
          }
          semesterMap.get(key)!.push(score.grade_score);
        }
      });

      if (semesterMap.size >= 2) {
        const semesterAverages = Array.from(semesterMap.entries())
          .map(([key, grades]) => ({
            key,
            average: grades.reduce((a, b) => a + b, 0) / grades.length,
          }))
          .sort((a, b) => {
            const [aGrade, aSem] = a.key.split("-").map(Number);
            const [bGrade, bSem] = b.key.split("-").map(Number);
            if (aGrade !== bGrade) return aGrade - bGrade;
            return aSem - bSem;
          });

        if (semesterAverages.length >= 2) {
          const latest = semesterAverages[semesterAverages.length - 1];
          const previous = semesterAverages[semesterAverages.length - 2];
          if (latest.average > previous.average) {
            const decline = latest.average - previous.average;
            riskScore += decline * 10;
            reasons.push(`í•™ê¸°ë³„ ë“±ê¸‰ í•˜ë½ ì¶”ì„¸`);
          }
        }
      }

      if (riskScore >= 30) {
        results.push({
          subject,
          riskScore: Math.min(100, riskScore),
          reasons,
          recentGrades,
          averageGrade,
        });
      }
    });

    // Risk Score ìˆœìœ¼ë¡œ ì •ë ¬ (ë†’ì€ ìˆœ)
    return results.sort((a, b) => b.riskScore - a.riskScore).slice(0, 5);
  }, [schoolScores]);

  if (weakSubjects.length === 0) {
    return (
      <EmptyState
        icon="âœ…"
        title="ì·¨ì•½ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤"
        description="í˜„ì¬ ë‚´ì‹  ì„±ì ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ê³„ì† ìœ ì§€í•˜ì„¸ìš”!"
      />
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {weakSubjects.map((item, index) => (
        <div
          key={`${item.subject}-${index}`}
          className={cn("rounded-lg border p-6", getRiskColorClasses(item.riskScore))}
        >
          <div className="flex items-start justify-between">
            <div className="flex-1 flex flex-col gap-2">
              <div className="flex items-center gap-3">
                <h3 className={cn("text-lg font-semibold", textPrimary)}>{item.subject}</h3>
                <span className="text-xs font-medium px-2 py-1 rounded bg-white/50 dark:bg-gray-800/50">
                  ë‚´ì‹ 
                </span>
                <span className={cn("text-sm font-bold", textPrimary)}>
                  Risk Score: {item.riskScore}
                </span>
              </div>
              <div className="flex flex-col gap-1">
                {item.reasons.map((reason, idx) => (
                  <p key={idx} className={cn("text-sm", textPrimary)}>
                    â€¢ {reason}
                  </p>
                ))}
              </div>
              {item.recentGrades.length > 0 && (
                <p className={cn("text-xs", textMuted)}>
                  ìµœê·¼ ë“±ê¸‰: {item.recentGrades.join(", ")} (í‰ê· :{" "}
                  {item.averageGrade.toFixed(1)})
                </p>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="dashboard/school/page.tsx">
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ScoreTypeTabs } from "../../_components/ScoreTypeTabs";
import { DashboardSubTabs } from "../_components/DashboardSubTabs";
import { fetchSchoolScores } from "../_utils/scoreQueries";
import { SemesterChartsSection } from "../_components/SemesterChartsSection";
import { SubjectTrendSection } from "../_components/SubjectTrendSection";
import { Card } from "@/components/molecules/Card";
import { EmptyState } from "@/components/molecules/EmptyState";
import { SchoolSummarySection } from "./_components/SchoolSummarySection";
import { SchoolWeakSubjectSection } from "./_components/SchoolWeakSubjectSection";
import { SchoolInsightPanel } from "./_components/SchoolInsightPanel";
import { SchoolDetailedMetrics } from "./_components/SchoolDetailedMetrics";
import { SchoolHeatmapChart } from "./_components/SchoolHeatmapChart";
import { SchoolGradeDistributionChart } from "./_components/SchoolGradeDistributionChart";
import { getContainerClass } from "@/lib/constants/layout";
import { PageHeader } from "@/components/layout/PageHeader";

export default async function SchoolScoresDashboardPage() {
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // ë‚´ì‹  ì„±ì  ì¡°íšŒ
  const schoolScores = await fetchSchoolScores(user.id);

  return (
    <section className={getContainerClass("DASHBOARD", "md")}>
      <div className="flex flex-col gap-6">
        <PageHeader
          title="ë‚´ì‹  ì„±ì  ëŒ€ì‹œë³´ë“œ"
          description="ë‚´ì‹  ì„±ì ì„ í•™ë…„Â·í•™ê¸°ë³„ë¡œ ë¶„ì„í•˜ê³  ì‹œê°í™”í•©ë‹ˆë‹¤."
        />

        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
        <div className="flex flex-col gap-4">
        <ScoreTypeTabs />
        <DashboardSubTabs />
      </div>

      {schoolScores.length === 0 ? (
        <EmptyState
          icon="ğŸ“š"
          title="ë“±ë¡ëœ ë‚´ì‹  ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤"
          description="ë‚´ì‹  ì„±ì ì„ ë“±ë¡í•˜ë©´ ëŒ€ì‹œë³´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤."
          actionLabel="ë‚´ì‹  ì„±ì  ì…ë ¥"
          actionHref="/scores/school/1/1"
        />
      ) : (
        <div className="flex flex-col gap-8">
          {/* ë‚´ì‹  ì„±ì  ìš”ì•½ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ë‚´ì‹  ì„±ì  ìš”ì•½</h2>
            <SchoolSummarySection schoolScores={schoolScores} />
          </div>

          {/* ë‚´ì‹  í•™ê¸°ë³„ ë³€í™” */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">í•™ê¸°ë³„ ë³€í™”</h2>
            <Card>
              <SemesterChartsSection schoolScores={schoolScores} />
            </Card>
          </div>

          {/* êµê³¼ë³„ ì„±ì  íŠ¸ë Œë“œ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">êµê³¼ë³„ ì„±ì  ë³€í™”</h2>
            <Card>
              <SubjectTrendSection schoolScores={schoolScores} />
            </Card>
          </div>

          {/* ìƒì„¸ ì§€í‘œ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ìƒì„¸ ì§€í‘œ</h2>
            <SchoolDetailedMetrics schoolScores={schoolScores} />
          </div>

          {/* íˆíŠ¸ë§µ ë° ë¶„í¬ ì°¨íŠ¸ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">íˆíŠ¸ë§µ ë° ë¶„í¬ ë¶„ì„</h2>
            <Card>
              <SchoolHeatmapChart schoolScores={schoolScores} />
            </Card>
            <Card>
              <SchoolGradeDistributionChart schoolScores={schoolScores} />
            </Card>
          </div>

          {/* ì·¨ì•½ ê³¼ëª© ë¶„ì„ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">ì·¨ì•½ ê³¼ëª© ë¶„ì„</h2>
            <SchoolWeakSubjectSection schoolScores={schoolScores} />
          </div>

          {/* í•™ìŠµ ì¸ì‚¬ì´íŠ¸ */}
          <div className="flex flex-col gap-4">
            <h2 className="text-h2 text-gray-900">í•™ìŠµ ì¸ì‚¬ì´íŠ¸</h2>
            <SchoolInsightPanel schoolScores={schoolScores} />
          </div>
        </div>
      )}
      </div>
    </section>
  );
}
</file>

<file path="dashboard/unified/_components/InfoMessage.tsx">
"use client";

import { cn } from "@/lib/cn";

type InfoMessageProps = {
  message: string;
  variant?: "warning" | "info" | "error" | "success";
  className?: string;
};

const variantClasses = {
  warning: "bg-yellow-50 text-yellow-800 border-yellow-200",
  info: "bg-blue-50 text-blue-800 border-blue-200",
  error: "bg-red-50 text-red-800 border-red-200",
  success: "bg-green-50 text-green-800 border-green-200",
};

export function InfoMessage({
  message,
  variant = "warning",
  className,
}: InfoMessageProps) {
  return (
    <div
      className={cn(
        "rounded-lg border p-3",
        variantClasses[variant],
        className
      )}
    >
      <p className="text-xs leading-relaxed">{message}</p>
    </div>
  );
}
</file>

<file path="dashboard/unified/_components/InternalAnalysisCard.tsx">
import { SectionCard } from "@/components/ui/SectionCard";
import type { InternalAnalysis } from "@/lib/types/scoreDashboard";
import { MetricCard } from "./MetricCard";
import { InfoMessage } from "./InfoMessage";

interface InternalAnalysisCardProps {
  analysis: InternalAnalysis;
}

export function InternalAnalysisCard({ analysis }: InternalAnalysisCardProps) {
  const { totalGpa, zIndex, subjectStrength } = analysis;

  // subjectStrengthë¥¼ ë°°ì—´ë¡œ ë³€í™˜ (ì •ë ¬)
  const subjectEntries = Object.entries(subjectStrength).sort(
    ([, gpaA], [, gpaB]) => gpaB - gpaA // ë†’ì€ GPA ìˆœ
  );

  return (
    <SectionCard
      title="ë‚´ì‹  ë¶„ì„"
      description="ì „ì²´ GPA ë° êµê³¼êµ°ë³„ ì„±ì "
    >
      {/* ì „ì²´ ì§€í‘œ */}
      <div className="grid grid-cols-2 gap-4">
        <MetricCard
          label="ì „ì²´ GPA"
          value={totalGpa !== null ? totalGpa.toFixed(2) : "N/A"}
          color="indigo"
        />
        <MetricCard
          label="Z-Index"
          value={zIndex !== null ? zIndex.toFixed(2) : "N/A"}
          color="purple"
        />
      </div>

      {/* êµê³¼êµ°ë³„ GPA */}
      <div className="flex flex-col gap-2">
        <div className="text-sm font-semibold text-gray-700">
          êµê³¼êµ°ë³„ í‰ì 
        </div>
        {subjectEntries.length > 0 ? (
          <div className="flex flex-col gap-2">
            {subjectEntries.map(([subjectName, gpa]) => (
              <div
                key={subjectName}
                className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
              >
                <div className="text-sm font-medium text-gray-700">
                  {subjectName}
                </div>
                <div className="text-sm font-bold text-gray-900">
                  {gpa.toFixed(2)}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="flex items-center justify-center rounded-lg border border-gray-200 bg-gray-50 py-8">
            <p className="text-sm text-gray-500">êµê³¼êµ° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
          </div>
        )}
      </div>

      {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
      {totalGpa === null && zIndex === null && (
        <InfoMessage
          message="ë‚´ì‹  ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì„±ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
          variant="warning"
        />
      )}
    </SectionCard>
  );
}
</file>

<file path="dashboard/unified/_components/MetricCard.tsx">
"use client";

import { cn } from "@/lib/cn";

type MetricCardProps = {
  label: string;
  value: string | number;
  color?: "indigo" | "purple" | "blue" | "green" | "red" | "orange" | "yellow";
  className?: string;
};

const colorClasses = {
  indigo: "bg-indigo-50 text-indigo-700",
  purple: "bg-purple-50 text-purple-700",
  blue: "bg-blue-50 text-blue-700",
  green: "bg-green-50 text-green-700",
  red: "bg-red-50 text-red-700",
  orange: "bg-orange-50 text-orange-700",
  yellow: "bg-yellow-50 text-yellow-700",
};

const valueColorClasses = {
  indigo: "text-indigo-900",
  purple: "text-purple-900",
  blue: "text-blue-900",
  green: "text-green-900",
  red: "text-red-900",
  orange: "text-orange-900",
  yellow: "text-yellow-900",
};

export function MetricCard({
  label,
  value,
  color = "indigo",
  className,
}: MetricCardProps) {
  return (
    <div
      className={cn(
        "flex flex-col gap-1 rounded-lg p-4",
        colorClasses[color],
        className
      )}
    >
      <div className="text-xs font-medium">{label}</div>
      <div className={cn("text-2xl font-bold", valueColorClasses[color])}>
        {value}
      </div>
    </div>
  );
}
</file>

<file path="dashboard/unified/_components/MockAnalysisCard.tsx">
import { SectionCard } from "@/components/ui/SectionCard";
import type { MockAnalysis } from "@/lib/types/scoreDashboard";
import { InfoMessage } from "./InfoMessage";

interface MockAnalysisCardProps {
  analysis: MockAnalysis;
}

export function MockAnalysisCard({ analysis }: MockAnalysisCardProps) {
  const { recentExam, avgPercentile, totalStdScore, best3GradeSum } = analysis;

  return (
    <SectionCard
      title="ëª¨ì˜ê³ ì‚¬ ë¶„ì„"
      description="ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  ìš”ì•½"
    >
      {/* ìµœê·¼ ì‹œí—˜ ì •ë³´ */}
      {recentExam ? (
        <div className="flex flex-col gap-1 rounded-lg bg-blue-50 p-4">
          <div className="text-xs font-medium text-blue-700">ìµœê·¼ ì‹œí—˜</div>
          <div className="text-base font-bold text-blue-900">
            {recentExam.examTitle}
          </div>
          <div className="text-xs text-blue-600">{recentExam.examDate}</div>
        </div>
      ) : (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
          <p className="text-sm text-gray-500">
            ìµœê·¼ ëª¨ì˜ê³ ì‚¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
          </p>
        </div>
      )}

      {/* ì£¼ìš” ì§€í‘œ */}
      <div className="flex flex-col gap-3">
        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3">
          <div className="text-sm font-medium text-gray-700">í‰ê·  ë°±ë¶„ìœ„</div>
          <div className="text-lg font-bold text-gray-900">
            {avgPercentile !== null ? `${avgPercentile.toFixed(1)}%` : "N/A"}
          </div>
        </div>

        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3">
          <div className="text-sm font-medium text-gray-700">
            í‘œì¤€ì ìˆ˜ í•©ê³„
          </div>
          <div className="text-lg font-bold text-gray-900">
            {totalStdScore !== null ? totalStdScore.toFixed(0) : "N/A"}
          </div>
        </div>

        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3">
          <div className="text-sm font-medium text-gray-700">
            ìƒìœ„ 3ê°œ ë“±ê¸‰ í•©
          </div>
          <div className="text-lg font-bold text-gray-900">
            {best3GradeSum !== null ? best3GradeSum : "N/A"}
          </div>
        </div>
      </div>

      {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
      {!recentExam && avgPercentile === null && (
        <InfoMessage
          message="ëª¨ì˜ê³ ì‚¬ ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì„±ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
          variant="warning"
        />
      )}
    </SectionCard>
  );
}
</file>

<file path="dashboard/unified/_components/StrategyCard.tsx">
import { SectionCard } from "@/components/ui/SectionCard";
import type { StrategyResult, StrategyType } from "@/lib/types/scoreDashboard";
import { cn } from "@/lib/cn";
import { InfoMessage } from "./InfoMessage";

interface StrategyCardProps {
  strategy: StrategyResult;
}

/**
 * ì „ëµ ìœ í˜•ë³„ ìŠ¤íƒ€ì¼ ë§¤í•‘
 */
const strategyStyles: Record<
  StrategyType,
  {
    badgeBg: string;
    badgeText: string;
    label: string;
  }
> = {
  BALANCED: {
    badgeBg: "bg-green-100",
    badgeText: "text-green-800",
    label: "ê· í˜•í˜•",
  },
  MOCK_ADVANTAGE: {
    badgeBg: "bg-blue-100",
    badgeText: "text-blue-800",
    label: "ëª¨ì˜ê³ ì‚¬ ìš°ì„¸",
  },
  INTERNAL_ADVANTAGE: {
    badgeBg: "bg-purple-100",
    badgeText: "text-purple-800",
    label: "ë‚´ì‹  ìš°ì„¸",
  },
};

export function StrategyCard({ strategy }: StrategyCardProps) {
  const { type, message, data } = strategy;
  const style = strategyStyles[type];

  return (
    <SectionCard
      title="ìˆ˜ì‹œ/ì •ì‹œ ì „ëµ ë¶„ì„"
      description="ë‚´ì‹ ê³¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  ë¹„êµ ê¸°ë°˜ ì¶”ì²œ"
    >
      {/* ì „ëµ ìœ í˜• ë°°ì§€ */}
      <span
        className={cn(
          "inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold",
          style.badgeBg,
          style.badgeText
        )}
      >
        {style.label}
      </span>

      {/* ì „ëµ ë©”ì‹œì§€ */}
      <div className="rounded-lg bg-gray-50 p-4">
        <p className="text-sm leading-relaxed text-gray-800">{message}</p>
      </div>

      {/* ë¹„êµ ë°ì´í„° */}
      <div className="flex flex-col gap-2">
        <div className="text-sm font-semibold text-gray-700">
          ì„±ì  ë¹„êµ ì§€í‘œ
        </div>
        <div className="grid gap-3 md:grid-cols-3">
          {/* ë‚´ì‹  ë°±ë¶„ìœ„ */}
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-3">
            <div className="text-xs font-medium text-gray-500">
              ë‚´ì‹  í™˜ì‚° ë°±ë¶„ìœ„
            </div>
            <div className="text-xl font-bold text-purple-700">
              {data.internalPct !== null
                ? `${data.internalPct.toFixed(1)}%`
                : "N/A"}
            </div>
          </div>

          {/* ëª¨ì˜ê³ ì‚¬ ë°±ë¶„ìœ„ */}
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-3">
            <div className="text-xs font-medium text-gray-500">
              ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„
            </div>
            <div className="text-xl font-bold text-blue-700">
              {data.mockPct !== null ? `${data.mockPct.toFixed(1)}%` : "N/A"}
            </div>
          </div>

          {/* ì°¨ì´ */}
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-3">
            <div className="text-xs font-medium text-gray-500">
              ë°±ë¶„ìœ„ ì°¨ì´
            </div>
            <div
              className={cn(
                "text-xl font-bold",
                data.diff !== null
                  ? data.diff > 0
                    ? "text-blue-700"
                    : data.diff < 0
                      ? "text-purple-700"
                      : "text-gray-700"
                  : "text-gray-400"
              )}
            >
              {data.diff !== null
                ? data.diff > 0
                  ? `+${data.diff.toFixed(1)}%`
                  : `${data.diff.toFixed(1)}%`
                : "N/A"}
            </div>
          </div>
        </div>
      </div>

      {/* ì•ˆë‚´ ë¬¸êµ¬ */}
      <InfoMessage
        message="ğŸ’¡ ì´ ë¶„ì„ì€ í˜„ì¬ê¹Œì§€ ì…ë ¥ëœ ì„±ì ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤. ì •í™•í•œ ì „ëµ ìˆ˜ë¦½ì„ ìœ„í•´ ìµœì‹  ì„±ì ì„ ê¾¸ì¤€íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."
        variant="info"
      />
    </SectionCard>
  );
}
</file>

<file path="dashboard/unified/_components/StudentProfileCard.tsx">
import { SectionCard } from "@/components/ui/SectionCard";
import type { StudentProfile } from "@/lib/types/scoreDashboard";

interface StudentProfileCardProps {
  profile: StudentProfile;
}

export function StudentProfileCard({ profile }: StudentProfileCardProps) {
  return (
    <SectionCard
      title="í•™ìƒ í”„ë¡œí•„"
      description="ê¸°ë³¸ ì •ë³´ ë° í˜„ì¬ í•™ê¸°"
    >
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        {/* ì´ë¦„ */}
        <div className="flex flex-col gap-1">
          <div className="text-xs font-medium text-gray-500">ì´ë¦„</div>
          <div className="text-base font-semibold text-gray-900">
            {profile.name}
          </div>
        </div>

        {/* í•™ë…„ */}
        <div className="flex flex-col gap-1">
          <div className="text-xs font-medium text-gray-500">í•™ë…„</div>
          <div className="text-base font-semibold text-gray-900">
            {profile.grade ? `${profile.grade}í•™ë…„` : "N/A"}
          </div>
        </div>

        {/* í•™êµ ìœ í˜• */}
        <div className="flex flex-col gap-1">
          <div className="text-xs font-medium text-gray-500">í•™êµ ìœ í˜•</div>
          <div className="text-base font-semibold text-gray-900">
            {profile.schoolType || "N/A"}
          </div>
        </div>

        {/* í•™ê¸° ì •ë³´ */}
        <div className="flex flex-col gap-1">
          <div className="text-xs font-medium text-gray-500">í•™ê¸°</div>
          <div className="text-base font-semibold text-gray-900">
            {profile.termGrade && profile.semester
              ? `${profile.termGrade}í•™ë…„ ${profile.semester}í•™ê¸°`
              : "N/A"}
          </div>
        </div>
      </div>

      {/* í•™êµ ì—°ë„ */}
      {profile.schoolYear && (
        <div className="border-t border-gray-100 pt-3">
          <div className="text-xs text-gray-500">
            í•™êµ ì—°ë„: <span className="font-medium">{profile.schoolYear}ë…„</span>
          </div>
        </div>
      )}
    </SectionCard>
  );
}
</file>

<file path="dashboard/unified/page.tsx">
import { redirect } from "next/navigation";
import { cookies } from "next/headers";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { fetchScoreDashboard } from "@/lib/api/scoreDashboard";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  getStudentWithTenant,
  getEffectiveTenantId,
  validateTenantIdMismatch,
  handleScoreDashboardError,
} from "@/lib/api/scoreDashboardUtils";
import { StudentProfileCard } from "./_components/StudentProfileCard";
import { InternalAnalysisCard } from "./_components/InternalAnalysisCard";
import { MockAnalysisCard } from "./_components/MockAnalysisCard";
import { StrategyCard } from "./_components/StrategyCard";
import { Card } from "@/components/molecules/Card";
import { PageHeader } from "@/components/layout/PageHeader";
import Link from "next/link";
import { getContainerClass } from "@/lib/constants/layout";

/**
 * í†µí•© ì„±ì  ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
 * 
 * /api/students/[id]/score-dashboard ë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„
 * 
 * êµ¬ì„±:
 * - í•™ìƒ í”„ë¡œí•„ ì¹´ë“œ
 * - ë‚´ì‹  ë¶„ì„ ì¹´ë“œ
 * - ëª¨ì˜ê³ ì‚¬ ë¶„ì„ ì¹´ë“œ
 * - ìˆ˜ì‹œ/ì •ì‹œ ì „ëµ ì¹´ë“œ
 */
export default async function UnifiedScoreDashboardPage() {
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // Tenant ì •ë³´ ì¡°íšŒ
  const tenantContext = await getTenantContext();
  if (!tenantContext) {
    return (
      <section className={getContainerClass("DASHBOARD", "md")}>
        <Card>
          <div className="flex flex-col items-center gap-4 p-8 text-center">
            <div className="text-lg font-semibold text-red-600">
              í…Œë„ŒíŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </div>
            <p className="text-sm text-gray-600">
              í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
            </p>
          </div>
        </Card>
      </section>
    );
  }

  // í•™ìƒ ì •ë³´ ì¡°íšŒ (tenant_id í¬í•¨) - ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
  const student = await getStudentWithTenant(supabase, user.id);

  if (!student) {
    return (
      <section className={getContainerClass("DASHBOARD", "md")}>
        <Card>
          <div className="flex flex-col items-center gap-4 p-8 text-center">
            <div className="text-lg font-semibold text-red-600">
              í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </div>
            <p className="text-sm text-gray-600">
              í•™ìƒ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.
            </p>
            <Link
              href="/settings"
              className="inline-flex items-center justify-center gap-2 rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2"
            >
              í•™ìƒ ì„¤ì •í•˜ê¸°
            </Link>
          </div>
        </Card>
      </section>
    );
  }

  // í•™ìƒì˜ grade ì •ë³´ ì¡°íšŒ (ì¶”ê°€)
  const { data: studentWithGrade } = await supabase
    .from("students")
    .select("grade")
    .eq("id", student.id)
    .maybeSingle();

  // effectiveTenantId ê²°ì • - ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
  const effectiveTenantId = getEffectiveTenantId(tenantContext, student.tenant_id);

  // tenantIdê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°˜í™˜
  if (!effectiveTenantId) {
    return (
      <section className={getContainerClass("DASHBOARD", "md")}>
        <Card>
          <div className="flex flex-col items-center gap-4 p-8 text-center">
            <div className="text-lg font-semibold text-red-600">
              í…Œë„ŒíŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </div>
            <p className="text-sm text-gray-600">
              í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
            </p>
          </div>
        </Card>
      </section>
    );
  }

  // tenantId ë¶ˆì¼ì¹˜ ê²€ì¦ - ê³µí†µ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
  validateTenantIdMismatch(
    tenantContext,
    student.tenant_id,
    student.id,
    "unified-dashboard"
  );

  // ì„±ì  ëŒ€ì‹œë³´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì¿ í‚¤ ì „ë‹¬)
  let dashboardData;
  let error: string | null = null;

  try {
    const cookieStore = await cookies();
    dashboardData = await fetchScoreDashboard(
      {
        studentId: student.id,
        tenantId: effectiveTenantId,
        grade: studentWithGrade?.grade || undefined,
        semester: 1, // ê¸°ë³¸ê°’: 1í•™ê¸°
      },
      {
        cookies: cookieStore,
      }
    );
  } catch (err) {
    error = handleScoreDashboardError(err, "unified-dashboard");
  }

  // ì—ëŸ¬ ì²˜ë¦¬
  if (error || !dashboardData) {
    return (
      <section className={getContainerClass("DASHBOARD", "md")}>
        <div className="flex flex-col gap-6">
          <PageHeader
            title="ì„±ì  ëŒ€ì‹œë³´ë“œ"
            description="ë‚´ì‹  ë° ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ í†µí•© ë¶„ì„í•˜ê³  ì…ì‹œ ì „ëµì„ ì œì‹œí•©ë‹ˆë‹¤."
          />

          <Card>
            <div className="flex flex-col items-center gap-4 p-8 text-center">
              <div className="text-lg font-semibold text-red-600">
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤
              </div>
              <p className="text-sm text-gray-600">{error}</p>
              <Link
                href="/scores"
                className="inline-flex items-center justify-center gap-2 rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2"
              >
                ì„±ì  ê´€ë¦¬ë¡œ ì´ë™
              </Link>
            </div>
          </Card>
        </div>
      </section>
    );
  }

  const {
    studentProfile,
    internalAnalysis,
    mockAnalysis,
    strategyResult,
  } = dashboardData;

  return (
    <section className={getContainerClass("DASHBOARD", "md")}>
      <div className="flex flex-col gap-6">
        <PageHeader
          title="ì„±ì  ëŒ€ì‹œë³´ë“œ"
          description="ë‚´ì‹  ë° ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ í†µí•© ë¶„ì„í•˜ê³  ì…ì‹œ ì „ëµì„ ì œì‹œí•©ë‹ˆë‹¤."
        />

        {/* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ì„¹ì…˜ */}
        <div className="flex flex-col gap-6">
          {/* í•™ìƒ í”„ë¡œí•„ */}
          <StudentProfileCard profile={studentProfile} />

          {/* 2ì—´ ë ˆì´ì•„ì›ƒ: ë‚´ì‹  + ëª¨ì˜ê³ ì‚¬ */}
          <div className="grid gap-6 md:grid-cols-2">
            <InternalAnalysisCard analysis={internalAnalysis} />
            <MockAnalysisCard analysis={mockAnalysis} />
          </div>

          {/* ìˆ˜ì‹œ/ì •ì‹œ ì „ëµ */}
          <StrategyCard strategy={strategyResult} />
        </div>

        {/* ì¶”ê°€ ì•¡ì…˜ */}
        <div className="flex flex-wrap gap-4">
          <Link
            href="/scores/input"
            className="inline-flex items-center justify-center gap-2 rounded-lg border border-transparent bg-indigo-600 px-6 py-2.5 text-sm font-semibold text-white transition-colors hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2"
          >
            ì„±ì  ì…ë ¥í•˜ê¸°
          </Link>
          <Link
            href="/scores/analysis"
            className="rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          >
            ìƒì„¸ ë¶„ì„ ë³´ê¸°
          </Link>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="dashboard/_utils.ts">
/**
 * âš ï¸ DEPRECATED: ì´ íŒŒì¼ì€ ë ˆê±°ì‹œ student_scores í…Œì´ë¸”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * 
 * ìƒˆ êµ¬ì¡°ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”:
 * - ë‚´ì‹  ì„±ì : student_internal_scores í…Œì´ë¸” ì‚¬ìš©
 * - ëª¨ì˜ê³ ì‚¬ ì„±ì : student_mock_scores í…Œì´ë¸” ì‚¬ìš©
 * 
 * ìƒˆ êµ¬ì¡°ëŠ” student_termsë¥¼ í†µí•´ í•™ê¸° ì •ë³´ë¥¼ ê´€ë¦¬í•˜ë©°,
 * student_term_id FKë¥¼ í†µí•´ ì—°ê²°ë©ë‹ˆë‹¤.
 * 
 * @see lib/data/scoreQueries.ts - getTermScores, getAllTermScores
 * @see lib/data/studentScores.ts - getInternalScores, getMockScores
 */

type SupabaseServerClient = Awaited<
  ReturnType<typeof import("@/lib/supabase/server").createSupabaseServerClient>
>;

/** @deprecated student_scores í…Œì´ë¸” ì‚¬ìš©. ìƒˆ êµ¬ì¡°ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” */
export type ScoreRow = {
  id: string;
  subject_type: string | null;
  semester: string | null;
  course: string | null;
  course_detail: string | null;
  raw_score: number | null;
  grade: number | null;
  score_type_detail: string | null;
  test_date: string | null;
  created_at: string | null;
};

/**
 * ëª¨ë“  ì„±ì  ì¡°íšŒ
 * @deprecated student_scores í…Œì´ë¸” ì‚¬ìš©. getInternalScores, getMockScores ì‚¬ìš© ê¶Œì¥
 */
export async function fetchAllScores(
  supabase: SupabaseServerClient,
  studentId: string
): Promise<ScoreRow[]> {
  try {
    const selectScores = () =>
      supabase
        .from("student_scores")
        .select(
          "id,subject_type,semester,course,course_detail,raw_score,grade,score_type_detail,test_date,created_at"
        )
        .order("test_date", { ascending: true })
        .order("created_at", { ascending: true });

    let { data, error } = await selectScores().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data, error } = await selectScores());
    }

    if (error) throw error;

    return (data as ScoreRow[] | null) ?? [];
  } catch (error) {
    console.error("[dashboard] ì„±ì  ì¡°íšŒ ì‹¤íŒ¨", error);
    return [];
  }
}

// í•™ê¸°ë³„ ì„±ì  ìš”ì•½
export type SemesterSummary = {
  semester: string;
  totalScores: number;
  averageGrade: number;
  averageRawScore: number;
  courses: string[];
};

export function calculateSemesterSummary(
  scores: ScoreRow[]
): SemesterSummary[] {
  const semesterMap = new Map<string, ScoreRow[]>();

  scores.forEach((score) => {
    if (!score.semester) return;
    const existing = semesterMap.get(score.semester) ?? [];
    existing.push(score);
    semesterMap.set(score.semester, existing);
  });

  const summaries: SemesterSummary[] = [];

  semesterMap.forEach((semesterScores, semester) => {
    const validGrades = semesterScores
      .map((s) => s.grade)
      .filter((g): g is number => g !== null && g !== undefined);
    const validRawScores = semesterScores
      .map((s) => s.raw_score)
      .filter((r): r is number => r !== null && r !== undefined);

    const courses = new Set<string>();
    semesterScores.forEach((s) => {
      if (s.course) courses.add(s.course);
    });

    summaries.push({
      semester,
      totalScores: semesterScores.length,
      averageGrade:
        validGrades.length > 0
          ? validGrades.reduce((a, b) => a + b, 0) / validGrades.length
          : 0,
      averageRawScore:
        validRawScores.length > 0
          ? validRawScores.reduce((a, b) => a + b, 0) / validRawScores.length
          : 0,
      courses: Array.from(courses).sort(),
    });
  });

  return summaries.sort((a, b) => a.semester.localeCompare(b.semester));
}

// êµê³¼ë³„ í‰ê·  ë“±ê¸‰
export type CourseAverageGrade = {
  course: string;
  averageGrade: number;
  count: number;
};

export function calculateCourseAverageGrades(
  scores: ScoreRow[]
): CourseAverageGrade[] {
  const courseMap = new Map<string, number[]>();

  scores.forEach((score) => {
    if (!score.course || score.grade === null) return;
    const existing = courseMap.get(score.course) ?? [];
    existing.push(score.grade);
    courseMap.set(score.course, existing);
  });

  const averages: CourseAverageGrade[] = [];

  courseMap.forEach((grades, course) => {
    const average =
      grades.length > 0
        ? grades.reduce((a, b) => a + b, 0) / grades.length
        : 0;

    averages.push({
      course,
      averageGrade: average,
      count: grades.length,
    });
  });

  return averages.sort((a, b) => a.averageGrade - b.averageGrade);
}

// ê³¼ëª©ë³„ ë“±ê¸‰ ë³€í™” (ì‹œí—˜ì¼ ê¸°ì¤€)
export type SubjectGradeHistory = {
  course_detail: string;
  course: string;
  history: Array<{
    test_date: string;
    grade: number;
    raw_score: number | null;
    score_type_detail: string | null;
  }>;
};

export function calculateSubjectGradeHistory(
  scores: ScoreRow[]
): SubjectGradeHistory[] {
  const subjectMap = new Map<string, ScoreRow[]>();

  scores.forEach((score) => {
    if (!score.course_detail || score.grade === null) return;
    const key = `${score.course}:${score.course_detail}`;
    const existing = subjectMap.get(key) ?? [];
    existing.push(score);
    subjectMap.set(key, existing);
  });

  const histories: SubjectGradeHistory[] = [];

  subjectMap.forEach((subjectScores, key) => {
    const [course, course_detail] = key.split(":");
    const sortedScores = subjectScores.sort((a, b) => {
      const dateA = a.test_date ? new Date(a.test_date).getTime() : 0;
      const dateB = b.test_date ? new Date(b.test_date).getTime() : 0;
      return dateA - dateB;
    });

    histories.push({
      course_detail,
      course,
      history: sortedScores.map((s) => ({
        test_date: s.test_date ?? "",
        grade: s.grade!,
        raw_score: s.raw_score,
        score_type_detail: s.score_type_detail,
      })),
    });
  });

  return histories.sort((a, b) => a.course_detail.localeCompare(b.course_detail));
}

// ë‚´ì‹  vs ëª¨ì˜ê³ ì‚¬ ë¹„êµ
export type ScoreTypeComparison = {
  score_type: string;
  averageGrade: number;
  count: number;
  averageRawScore: number;
};

export function calculateScoreTypeComparison(
  scores: ScoreRow[]
): ScoreTypeComparison[] {
  const typeMap = new Map<string, ScoreRow[]>();

  scores.forEach((score) => {
    if (!score.score_type_detail || score.grade === null) return;
    const existing = typeMap.get(score.score_type_detail) ?? [];
    existing.push(score);
    typeMap.set(score.score_type_detail, existing);
  });

  const comparisons: ScoreTypeComparison[] = [];

  typeMap.forEach((typeScores, score_type) => {
    const validGrades = typeScores
      .map((s) => s.grade)
      .filter((g): g is number => g !== null && g !== undefined);
    const validRawScores = typeScores
      .map((s) => s.raw_score)
      .filter((r): r is number => r !== null && r !== undefined);

    comparisons.push({
      score_type,
      averageGrade:
        validGrades.length > 0
          ? validGrades.reduce((a, b) => a + b, 0) / validGrades.length
          : 0,
      count: typeScores.length,
      averageRawScore:
        validRawScores.length > 0
          ? validRawScores.reduce((a, b) => a + b, 0) / validRawScores.length
          : 0,
    });
  });

  return comparisons.sort((a, b) => a.averageGrade - b.averageGrade);
}

// ì·¨ì•½ê³¼ëª© íƒì§€
export type WeakSubject = {
  course_detail: string;
  course: string;
  reason: string;
  averageGrade: number;
  recentDecline?: number; // ìµœê·¼ 2ë²ˆ ë“±ê¸‰ í•˜ë½
  scoreVariance?: number; // raw_score í¸ì°¨
  count: number;
};

export function detectWeakSubjects(scores: ScoreRow[]): WeakSubject[] {
  const subjectMap = new Map<string, ScoreRow[]>();

  scores.forEach((score) => {
    if (!score.course_detail || score.grade === null) return;
    const key = `${score.course}:${score.course_detail}`;
    const existing = subjectMap.get(key) ?? [];
    existing.push(score);
    subjectMap.set(key, existing);
  });

  const weakSubjects: WeakSubject[] = [];

  subjectMap.forEach((subjectScores, key) => {
    const [course, course_detail] = key.split(":");
    const sortedScores = subjectScores.sort((a, b) => {
      const dateA = a.test_date ? new Date(a.test_date).getTime() : 0;
      const dateB = b.test_date ? new Date(b.test_date).getTime() : 0;
      return dateB - dateA; // ìµœì‹ ìˆœ
    });

    const validGrades = sortedScores
      .map((s) => s.grade)
      .filter((g): g is number => g !== null && g !== undefined);
    const validRawScores = sortedScores
      .map((s) => s.raw_score)
      .filter((r): r is number => r !== null && r !== undefined);

    if (validGrades.length === 0) return;

    const averageGrade =
      validGrades.reduce((a, b) => a + b, 0) / validGrades.length;

    const reasons: string[] = [];

    // 1. ìµœê·¼ 2ë²ˆ ë“±ê¸‰ í•˜ë½ ì²´í¬
    if (validGrades.length >= 2) {
      const recent2 = validGrades.slice(0, 2);
      if (recent2[0] > recent2[1]) {
        // ë“±ê¸‰ì´ ë†’ì•„ì¡Œë‹¤ëŠ” ê²ƒì€ ë‚˜ë¹ ì¡Œë‹¤ëŠ” ì˜ë¯¸ (1ë“±ê¸‰ì´ ìµœê³ )
        const decline = recent2[0] - recent2[1];
        reasons.push(`ìµœê·¼ 2ë²ˆ ë“±ê¸‰ ${decline}ë‹¨ê³„ í•˜ë½`);
        weakSubjects.push({
          course_detail,
          course,
          reason: reasons.join(", "),
          averageGrade,
          recentDecline: decline,
          count: validGrades.length,
        });
        return; // ì´ë¯¸ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ ë‹¤ìŒ ê³¼ëª©ìœ¼ë¡œ
      }
    }

    // 2. í‰ê·  ë“±ê¸‰ì´ ë‚®ì€ ìˆœ (5ë“±ê¸‰ ì´ìƒ)
    if (averageGrade >= 5) {
      reasons.push(`í‰ê·  ë“±ê¸‰ ${averageGrade.toFixed(1)}ë“±ê¸‰ (ë‚®ìŒ)`);
    }

    // 3. raw_score í¸ì°¨ê°€ í° ê³¼ëª©
    if (validRawScores.length >= 2) {
      const mean =
        validRawScores.reduce((a, b) => a + b, 0) / validRawScores.length;
      const variance =
        validRawScores.reduce((sum, score) => {
          return sum + Math.pow(score - mean, 2);
        }, 0) / validRawScores.length;
      const stdDev = Math.sqrt(variance);

      // í¸ì°¨ê°€ í‰ê· ì˜ 20% ì´ìƒì´ë©´ ë¶ˆì•ˆì •
      if (stdDev > mean * 0.2) {
        reasons.push(`ì ìˆ˜ í¸ì°¨ í¼ (í‘œì¤€í¸ì°¨: ${stdDev.toFixed(1)})`);
        weakSubjects.push({
          course_detail,
          course,
          reason: reasons.join(", "),
          averageGrade,
          scoreVariance: stdDev,
          count: validGrades.length,
        });
        return;
      }
    }

    // í‰ê·  ë“±ê¸‰ì´ ë‚®ì€ ê²½ìš°ë§Œ ì¶”ê°€
    if (averageGrade >= 5 && reasons.length > 0) {
      weakSubjects.push({
        course_detail,
        course,
        reason: reasons.join(", "),
        averageGrade,
        count: validGrades.length,
      });
    }
  });

  // í‰ê·  ë“±ê¸‰ ìˆœìœ¼ë¡œ ì •ë ¬
  return weakSubjects.sort((a, b) => b.averageGrade - a.averageGrade);
}
</file>

<file path="dashboard/page.tsx">
/**
 * @deprecated ì´ í˜ì´ì§€ëŠ” ë ˆê±°ì‹œ ì„±ì  ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.
 * ìƒˆë¡œìš´ í†µí•© ì„±ì  ëŒ€ì‹œë³´ë“œ(/scores/dashboard/unified)ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë©ë‹ˆë‹¤.
 * 
 * ë ˆê±°ì‹œ ì»´í¬ë„ŒíŠ¸ë“¤:
 * - SummarySection, SemesterChartsSection, SubjectTrendSection
 * - MockExamTrendSection, CompareSection, WeakSubjectSection
 * - InsightPanel, IntegratedComparisonChart, ScoreConsistencyAnalysis
 * 
 * ìƒˆë¡œìš´ ëŒ€ì‹œë³´ë“œëŠ” /api/students/[id]/score-dashboard APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * ìì„¸í•œ ë‚´ìš©ì€ docs/score-dashboard-frontend-implementation.mdë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
 */
import { redirect } from "next/navigation";

export default async function ScoresDashboardPage() {
  // í†µí•© ì„±ì  ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  redirect("/scores/dashboard/unified");
}
</file>

<file path="input/_components/InternalScoreInput.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import type { SubjectGroup, SubjectType } from "@/lib/data/subjects";
import type { InternalScoreInputForm } from "@/lib/types/scoreInput";
import { calculateSchoolYear } from "@/lib/utils/schoolYear";

type InternalScoreInputProps = {
  studentId: string;
  tenantId: string;
  curriculumRevisionId: string;
  subjectGroups: (SubjectGroup & {
    subjects: Array<{
      id: string;
      subject_group_id: string;
      name: string;
      subject_type_id?: string | null;
      subject_type?: string | null;
    }>;
  })[];
  subjectTypes: SubjectType[];
};

type ScoreRow = InternalScoreInputForm & {
  id: string; // í´ë¼ì´ì–¸íŠ¸ìš© ì„ì‹œ ID
};

export default function InternalScoreInput({
  studentId,
  tenantId,
  curriculumRevisionId,
  subjectGroups,
  subjectTypes,
}: InternalScoreInputProps) {
  const router = useRouter();
  const [grade, setGrade] = useState<number>(1);
  const [semester, setSemester] = useState<number>(1);
  const [scores, setScores] = useState<ScoreRow[]>([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ìƒˆë¡œìš´ ì„±ì  í–‰ ì¶”ê°€
  const addScoreRow = () => {
    const newRow: ScoreRow = {
      id: `temp-${Date.now()}`,
      subject_group_id: "",
      subject_id: "",
      subject_type_id: "",
      grade,
      semester,
      credit_hours: 4,
      rank_grade: 1,
      raw_score: null,
      avg_score: null,
      std_dev: null,
      total_students: null,
    };
    setScores([...scores, newRow]);
  };

  // ì„±ì  í–‰ ì‚­ì œ
  const removeScoreRow = (id: string) => {
    setScores(scores.filter((row) => row.id !== id));
  };

  // í•„ë“œ ì—…ë°ì´íŠ¸
  const updateScoreField = <K extends keyof ScoreRow>(
    id: string,
    field: K,
    value: ScoreRow[K]
  ) => {
    setScores(
      scores.map((row) => (row.id === id ? { ...row, [field]: value } : row))
    );
  };

  // êµê³¼êµ° ë³€ê²½ ì‹œ ê³¼ëª© ì´ˆê¸°í™”
  const handleSubjectGroupChange = (id: string, subjectGroupId: string) => {
    setScores(
      scores.map((row) =>
        row.id === id
          ? { ...row, subject_group_id: subjectGroupId, subject_id: "" }
          : row
      )
    );
  };

  // ì„ íƒëœ êµê³¼êµ°ì˜ ê³¼ëª© ëª©ë¡
  const getSubjectsForGroup = (subjectGroupId: string) => {
    const group = subjectGroups.find((g) => g.id === subjectGroupId);
    return group?.subjects || [];
  };

  // í¼ ì œì¶œ
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // ìœ íš¨ì„± ê²€ì¦
    if (scores.length === 0) {
      setError("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì„±ì ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    for (const score of scores) {
      if (
        !score.subject_group_id ||
        !score.subject_id ||
        !score.subject_type_id
      ) {
        setError("êµê³¼êµ°, ê³¼ëª©, ê³¼ëª©êµ¬ë¶„ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
        return;
      }
      if (score.credit_hours <= 0) {
        setError("í•™ì ìˆ˜ëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
      if (score.rank_grade < 1 || score.rank_grade > 9) {
        setError("ì„ì°¨ë“±ê¸‰ì€ 1~9 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
    }

    setIsSubmitting(true);

    try {
      const response = await fetch("/api/scores/internal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          studentId,
          tenantId,
          curriculumRevisionId,
          schoolYear: calculateSchoolYear(),
          scores: scores.map((s) => {
            const { id, ...scoreData } = s;
            return scoreData;
          }),
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "ì„±ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }

      // ì„±ê³µ ì‹œ í†µí•© ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
      router.push("/scores/dashboard/unified");
    } catch (err) {
      setError(err instanceof Error ? err.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6">
      {/* í•™ë…„/í•™ê¸° ì„ íƒ */}
      <div className="bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <div className="flex flex-col gap-4">
          <h2 className="text-lg font-semibold text-gray-900">ê¸°ë³¸ ì •ë³´</h2>
          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                í•™ë…„ <span className="text-red-500">*</span>
              </label>
              <select
                value={grade}
                onChange={(e) => setGrade(Number(e.target.value))}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value={1}>1í•™ë…„</option>
                <option value={2}>2í•™ë…„</option>
                <option value={3}>3í•™ë…„</option>
              </select>
            </div>
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                í•™ê¸° <span className="text-red-500">*</span>
              </label>
              <select
                value={semester}
                onChange={(e) => setSemester(Number(e.target.value))}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value={1}>1í•™ê¸°</option>
                <option value={2}>2í•™ê¸°</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {/* ì„±ì  ì…ë ¥ í…Œì´ë¸” */}
      <div className="bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold text-gray-900">ì„±ì  ì…ë ¥</h2>
            <button
              type="button"
              onClick={addScoreRow}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            >
              + ê³¼ëª© ì¶”ê°€
            </button>
          </div>

          {scores.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <p className="text-sm">ê³¼ëª© ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„±ì ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      êµê³¼êµ°
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ê³¼ëª©
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ê³¼ëª©êµ¬ë¶„
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      í•™ì 
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ì„ì°¨ë“±ê¸‰
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ì›ì ìˆ˜
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ê³¼ëª©í‰ê· 
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      í‘œì¤€í¸ì°¨
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ìˆ˜ê°•ììˆ˜
                    </th>
                    <th className="px-3 py-3"></th>
                  </tr>
                </thead>
                <tbody>
                  {scores.map((row) => (
                    <tr key={row.id} className="border-b border-gray-100">
                      <td className="px-3 py-3">
                        <select
                          value={row.subject_group_id}
                          onChange={(e) =>
                            handleSubjectGroupChange(row.id, e.target.value)
                          }
                          className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        >
                          <option value="">ì„ íƒ</option>
                          {subjectGroups.map((group) => (
                            <option key={group.id} value={group.id}>
                              {group.name}
                            </option>
                          ))}
                        </select>
                      </td>
                      <td className="px-3 py-3">
                        <select
                          value={row.subject_id}
                          onChange={(e) =>
                            updateScoreField(row.id, "subject_id", e.target.value)
                          }
                          disabled={!row.subject_group_id}
                          className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-50"
                        >
                          <option value="">ì„ íƒ</option>
                          {getSubjectsForGroup(row.subject_group_id).map(
                            (subject) => (
                              <option key={subject.id} value={subject.id}>
                                {subject.name}
                              </option>
                            )
                          )}
                        </select>
                      </td>
                      <td className="px-3 py-3">
                        <select
                          value={row.subject_type_id}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "subject_type_id",
                              e.target.value
                            )
                          }
                          className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        >
                          <option value="">ì„ íƒ</option>
                          {subjectTypes.map((type) => (
                            <option key={type.id} value={type.id}>
                              {type.name}
                            </option>
                          ))}
                        </select>
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.credit_hours}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "credit_hours",
                              Number(e.target.value)
                            )
                          }
                          min="1"
                          step="1"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.rank_grade}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "rank_grade",
                              Number(e.target.value)
                            )
                          }
                          min="1"
                          max="9"
                          step="1"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.raw_score ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "raw_score",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="0.1"
                          placeholder="85.5"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.avg_score ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "avg_score",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="0.1"
                          placeholder="78.2"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.std_dev ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "std_dev",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="0.1"
                          placeholder="12.5"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.total_students ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "total_students",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="1"
                          placeholder="30"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <button
                          type="button"
                          onClick={() => removeScoreRow(row.id)}
                          className="text-red-600 hover:text-red-800 text-xs font-medium"
                        >
                          ì‚­ì œ
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
      {error && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <p className="text-sm text-red-800">{error}</p>
        </div>
      )}

      {/* ì œì¶œ ë²„íŠ¼ */}
      <div className="flex gap-3 justify-end">
        <button
          type="button"
          onClick={() => router.back()}
          className="rounded-lg border border-gray-300 px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="submit"
          disabled={isSubmitting || scores.length === 0}
          className="rounded-lg bg-indigo-600 px-6 py-2.5 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          {isSubmitting ? "ì €ì¥ ì¤‘..." : "ì €ì¥í•˜ê¸°"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="input/_components/MockScoreInput.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import type { SubjectGroup } from "@/lib/data/subjects";
import type { MockScoreInputForm } from "@/lib/types/scoreInput";

type MockScoreInputProps = {
  studentId: string;
  tenantId: string;
  subjectGroups: (SubjectGroup & {
    subjects: Array<{
      id: string;
      subject_group_id: string;
      name: string;
      subject_type_id?: string | null;
      subject_type?: string | null;
    }>;
  })[];
};

type ScoreRow = MockScoreInputForm & {
  id: string; // í´ë¼ì´ì–¸íŠ¸ìš© ì„ì‹œ ID
};

export default function MockScoreInput({
  studentId,
  tenantId,
  subjectGroups,
}: MockScoreInputProps) {
  const router = useRouter();
  const [examDate, setExamDate] = useState<string>("");
  const [examTitle, setExamTitle] = useState<string>("");
  const [grade, setGrade] = useState<number>(1);
  const [scores, setScores] = useState<ScoreRow[]>([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ìƒˆë¡œìš´ ì„±ì  í–‰ ì¶”ê°€
  const addScoreRow = () => {
    if (!examDate || !examTitle) {
      setError("ì‹œí—˜ì¼ê³¼ ì‹œí—˜ëª…ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const newRow: ScoreRow = {
      id: `temp-${Date.now()}`,
      exam_date: examDate,
      exam_title: examTitle,
      grade,
      subject_id: "",
      subject_group_id: "",
      grade_score: 1,
      standard_score: null,
      percentile: null,
      raw_score: null,
    };
    setScores([...scores, newRow]);
    setError(null);
  };

  // ì„±ì  í–‰ ì‚­ì œ
  const removeScoreRow = (id: string) => {
    setScores(scores.filter((row) => row.id !== id));
  };

  // í•„ë“œ ì—…ë°ì´íŠ¸
  const updateScoreField = <K extends keyof ScoreRow>(
    id: string,
    field: K,
    value: ScoreRow[K]
  ) => {
    setScores(
      scores.map((row) => (row.id === id ? { ...row, [field]: value } : row))
    );
  };

  // êµê³¼êµ° ë³€ê²½ ì‹œ ê³¼ëª© ì´ˆê¸°í™”
  const handleSubjectGroupChange = (id: string, subjectGroupId: string) => {
    setScores(
      scores.map((row) =>
        row.id === id
          ? { ...row, subject_group_id: subjectGroupId, subject_id: "" }
          : row
      )
    );
  };

  // ì„ íƒëœ êµê³¼êµ°ì˜ ê³¼ëª© ëª©ë¡
  const getSubjectsForGroup = (subjectGroupId: string) => {
    const group = subjectGroups.find((g) => g.id === subjectGroupId);
    return group?.subjects || [];
  };

  // í¼ ì œì¶œ
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // ìœ íš¨ì„± ê²€ì¦
    if (!examDate || !examTitle) {
      setError("ì‹œí—˜ì¼ê³¼ ì‹œí—˜ëª…ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
      return;
    }

    if (scores.length === 0) {
      setError("ìµœì†Œ 1ê°œ ì´ìƒì˜ ê³¼ëª© ì„±ì ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    for (const score of scores) {
      if (!score.subject_group_id || !score.subject_id) {
        setError("êµê³¼êµ°ê³¼ ê³¼ëª©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
        return;
      }
      if (score.grade_score < 1 || score.grade_score > 9) {
        setError("ë“±ê¸‰ì€ 1~9 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
    }

    setIsSubmitting(true);

    try {
      const response = await fetch("/api/scores/mock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          studentId,
          tenantId,
          scores: scores.map((s) => {
            const { id, ...scoreData } = s;
            return scoreData;
          }),
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "ì„±ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }

      // ì„±ê³µ ì‹œ í†µí•© ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
      router.push("/scores/dashboard/unified");
    } catch (err) {
      setError(err instanceof Error ? err.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6">
      {/* ì‹œí—˜ ì •ë³´ */}
      <div className="bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <div className="flex flex-col gap-4">
          <h2 className="text-lg font-semibold text-gray-900">ì‹œí—˜ ì •ë³´</h2>
          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                ì‹œí—˜ì¼ <span className="text-red-500">*</span>
              </label>
              <input
                type="date"
                value={examDate}
                onChange={(e) => setExamDate(e.target.value)}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                ì‹œí—˜ëª… <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={examTitle}
                onChange={(e) => setExamTitle(e.target.value)}
                placeholder="ì˜ˆ: 3ì›” í•™ë ¥í‰ê°€"
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                í•™ë…„ <span className="text-red-500">*</span>
              </label>
              <select
                value={grade}
                onChange={(e) => setGrade(Number(e.target.value))}
                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value={1}>1í•™ë…„</option>
                <option value={2}>2í•™ë…„</option>
                <option value={3}>3í•™ë…„</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {/* ê³¼ëª©ë³„ ì„±ì  ì…ë ¥ */}
      <div className="bg-white rounded-lg border border-gray-200 p-4 md:p-6">
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold text-gray-900">ê³¼ëª©ë³„ ì„±ì </h2>
            <button
              type="button"
              onClick={addScoreRow}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            >
              + ê³¼ëª© ì¶”ê°€
            </button>
          </div>

          {scores.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <p className="text-sm">
                ì‹œí—˜ ì •ë³´ë¥¼ ì…ë ¥í•œ í›„, ê³¼ëª© ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
              </p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      êµê³¼êµ°
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ê³¼ëª©
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ë“±ê¸‰
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      í‘œì¤€ì ìˆ˜
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ë°±ë¶„ìœ„
                    </th>
                    <th className="px-3 py-3 text-left font-medium text-gray-700">
                      ì›ì ìˆ˜
                    </th>
                    <th className="px-3 py-3"></th>
                  </tr>
                </thead>
                <tbody>
                  {scores.map((row) => (
                    <tr key={row.id} className="border-b border-gray-100">
                      <td className="px-3 py-3">
                        <select
                          value={row.subject_group_id}
                          onChange={(e) =>
                            handleSubjectGroupChange(row.id, e.target.value)
                          }
                          className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        >
                          <option value="">ì„ íƒ</option>
                          {subjectGroups.map((group) => (
                            <option key={group.id} value={group.id}>
                              {group.name}
                            </option>
                          ))}
                        </select>
                      </td>
                      <td className="px-3 py-3">
                        <select
                          value={row.subject_id}
                          onChange={(e) =>
                            updateScoreField(row.id, "subject_id", e.target.value)
                          }
                          disabled={!row.subject_group_id}
                          className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-50"
                        >
                          <option value="">ì„ íƒ</option>
                          {getSubjectsForGroup(row.subject_group_id).map(
                            (subject) => (
                              <option key={subject.id} value={subject.id}>
                                {subject.name}
                              </option>
                            )
                          )}
                        </select>
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.grade_score}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "grade_score",
                              Number(e.target.value)
                            )
                          }
                          min="1"
                          max="9"
                          step="1"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.standard_score ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "standard_score",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="1"
                          placeholder="130"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.percentile ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "percentile",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="0.1"
                          min="0"
                          max="100"
                          placeholder="95.5"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <input
                          type="number"
                          value={row.raw_score ?? ""}
                          onChange={(e) =>
                            updateScoreField(
                              row.id,
                              "raw_score",
                              e.target.value ? Number(e.target.value) : null
                            )
                          }
                          step="0.1"
                          placeholder="85.5"
                          className="w-20 rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        />
                      </td>
                      <td className="px-3 py-3">
                        <button
                          type="button"
                          onClick={() => removeScoreRow(row.id)}
                          className="text-red-600 hover:text-red-800 text-xs font-medium"
                        >
                          ì‚­ì œ
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
      {error && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <p className="text-sm text-red-800">{error}</p>
        </div>
      )}

      {/* ì œì¶œ ë²„íŠ¼ */}
      <div className="flex gap-3 justify-end">
        <button
          type="button"
          onClick={() => router.back()}
          className="rounded-lg border border-gray-300 px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          ì·¨ì†Œ
        </button>
        <button
          type="submit"
          disabled={isSubmitting || scores.length === 0}
          className="rounded-lg bg-indigo-600 px-6 py-2.5 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          {isSubmitting ? "ì €ì¥ ì¤‘..." : "ì €ì¥í•˜ê¸°"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="input/_components/ScoreInputLayout.tsx">
"use client";

import { useState, useEffect } from "react";
import { useSearchParams } from "next/navigation";
import type { SubjectGroup, SubjectType } from "@/lib/data/subjects";
import InternalScoreInput from "./InternalScoreInput";
import MockScoreInput from "./MockScoreInput";

type ScoreInputLayoutProps = {
  studentId: string;
  tenantId: string;
  curriculum: {
    id: string;
    name: string;
    year?: number | null;
  };
  subjectGroups: (SubjectGroup & {
    subjects: Array<{
      id: string;
      subject_group_id: string;
      name: string;
      subject_type_id?: string | null;
      subject_type?: string | null;
    }>;
  })[];
  subjectTypes: SubjectType[];
};

type ScoreType = "internal" | "mock";

export default function ScoreInputLayout({
  studentId,
  tenantId,
  curriculum,
  subjectGroups,
  subjectTypes,
}: ScoreInputLayoutProps) {
  const searchParams = useSearchParams();
  const tabParam = searchParams?.get("tab");
  
  const [scoreType, setScoreType] = useState<ScoreType>(() => {
    return tabParam === "mock" ? "mock" : "internal";
  });

  // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ íƒ­ ì „í™˜
  useEffect(() => {
    if (tabParam === "internal") setScoreType("internal");
    else if (tabParam === "mock") setScoreType("mock");
  }, [tabParam]);

  return (
    <div className="flex flex-col gap-6">
      {/* ì„±ì  ìœ í˜• ì„ íƒ íƒ­ */}
      <div className="flex gap-2 border-b border-gray-200">
        <button
          onClick={() => setScoreType("internal")}
          className={`px-4 py-3 text-sm font-medium transition-colors ${
            scoreType === "internal"
              ? "border-b-2 border-indigo-600 text-indigo-600"
              : "text-gray-600 hover:text-gray-900"
          }`}
        >
          ë‚´ì‹  ì„±ì 
        </button>
        <button
          onClick={() => setScoreType("mock")}
          className={`px-4 py-3 text-sm font-medium transition-colors ${
            scoreType === "mock"
              ? "border-b-2 border-indigo-600 text-indigo-600"
              : "text-gray-600 hover:text-gray-900"
          }`}
        >
          ëª¨ì˜ê³ ì‚¬ ì„±ì 
        </button>
      </div>

      {/* ì„±ì  ì…ë ¥ í¼ */}
      {scoreType === "internal" ? (
        <InternalScoreInput
          studentId={studentId}
          tenantId={tenantId}
          curriculumRevisionId={curriculum.id}
          subjectGroups={subjectGroups}
          subjectTypes={subjectTypes}
        />
      ) : (
        <MockScoreInput
          studentId={studentId}
          tenantId={tenantId}
          subjectGroups={subjectGroups}
        />
      )}
    </div>
  );
}
</file>

<file path="input/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/auth/getCurrentUser";
import { getActiveCurriculumRevision, getSubjectHierarchyOptimized } from "@/lib/data/subjects";
import { SectionHeader } from "@/components/ui/SectionHeader";
import ScoreInputLayout from "./_components/ScoreInputLayout";
import { getContainerClass } from "@/lib/constants/layout";

export default async function ScoreInputPage() {
  // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
  const currentUser = await getCurrentUser();
  if (!currentUser || currentUser.role !== "student") {
    redirect("/login");
  }

  // í™œì„±í™”ëœ ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ
  const activeCurriculum = await getActiveCurriculumRevision();
  if (!activeCurriculum) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <div className="flex flex-col gap-2 text-center">
          <h2 className="text-lg font-semibold text-gray-900">
            ê°œì •êµìœ¡ê³¼ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤
          </h2>
          <p className="text-sm text-gray-600">
            ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
          </p>
        </div>
      </div>
    );
  }

  // êµê³¼ ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ (êµê³¼êµ° â†’ ê³¼ëª© â†’ ê³¼ëª©êµ¬ë¶„)
  const hierarchy = await getSubjectHierarchyOptimized(activeCurriculum.id);

  return (
    <div className="min-h-screen bg-gray-50">
      <div className={getContainerClass("DASHBOARD", "md")}>
        <div className="flex flex-col gap-6">
          {/* í—¤ë” */}
          <SectionHeader
            level="h1"
            title="ì„±ì  ì…ë ¥"
            description="ë‚´ì‹  ì„±ì ê³¼ ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ì…ë ¥í•˜ì„¸ìš”."
          />

          {/* ì„±ì  ì…ë ¥ ë ˆì´ì•„ì›ƒ */}
          <ScoreInputLayout
            studentId={currentUser.userId}
            tenantId={currentUser.tenantId || ""}
            curriculum={hierarchy.curriculumRevision}
            subjectGroups={hierarchy.subjectGroups}
            subjectTypes={hierarchy.subjectTypes}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="mock/[grade]/[month]/[exam-type]/_components/MockScoreCard.tsx">
"use client";

import { memo } from "react";
import { MockScore } from "@/lib/data/studentScores";
import { getGradeColor } from "@/lib/constants/colors";
import { BaseScoreCard } from "@/app/(student)/scores/_components/BaseScoreCard";
import { cn } from "@/lib/cn";

type MockScoreCardProps = {
  score: MockScore;
  subjectGroupName?: string;
  subjectName?: string;
  subjectTypeName?: string;
  onEdit: (score: MockScore) => void;
  onDelete: (scoreId: string) => void;
};

function MockScoreCardComponent({
  score,
  subjectGroupName,
  subjectName,
  subjectTypeName,
  onEdit,
  onDelete,
}: MockScoreCardProps) {
  const gradeColor = getGradeColor(score.grade_score);

  // ë“±ê¸‰ ë°°ì§€
  const gradeBadge =
    score.grade_score !== null ? (
      <div
        className={cn(
          "flex h-7 w-7 items-center justify-center rounded-full text-sm font-bold shrink-0 shadow-sm",
          gradeColor.badge
        )}
      >
        {score.grade_score}
      </div>
    ) : null;

  // ê¸°ê°„ ë°°ì§€
  const periodBadge = (
    <span className="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-200">
      {score.grade}í•™ë…„ {new Date(score.exam_date).getMonth() + 1}ì›” {score.exam_title}
    </span>
  );

  // ì„±ì  ì •ë³´ í•„ë“œ
  const scoreFields = (
    <>
      {score.standard_score !== null && (
        <div className="flex flex-col gap-1">
          <span className="text-xs font-medium text-gray-500">í‘œì¤€ì ìˆ˜</span>
          <span className="text-base font-semibold text-gray-900">
            {score.standard_score.toLocaleString()}
          </span>
        </div>
      )}
      {score.percentile !== null && (
        <div className="flex flex-col gap-1">
          <span className="text-xs font-medium text-gray-500">ë°±ë¶„ìœ„</span>
          <span className="text-base font-semibold text-gray-900">
            {score.percentile}%
          </span>
        </div>
      )}
      {score.standard_score === null && score.percentile === null && (
        <>
          <div className="flex flex-col gap-1">
            <span className="text-xs font-medium text-gray-500">í‘œì¤€ì ìˆ˜</span>
            <span className="text-base font-semibold text-gray-900">-</span>
          </div>
          <div className="flex flex-col gap-1">
            <span className="text-xs font-medium text-gray-500">ë°±ë¶„ìœ„</span>
            <span className="text-base font-semibold text-gray-900">-</span>
          </div>
        </>
      )}
    </>
  );

  // ìƒì„¸ ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ìš©
  const detailDialogContent = (
    <>
      {/* ê¸°ë³¸ ì •ë³´ */}
      <div className="grid gap-4 sm:grid-cols-2">
        <div className="flex flex-col gap-1">
          <span className="text-xs text-gray-500">ê³¼ëª©ëª…</span>
          <p className="text-sm font-medium text-gray-900">
            {subjectName || "-"}
          </p>
        </div>
        <div className="flex flex-col gap-1">
          <span className="text-xs text-gray-500">êµê³¼</span>
          <p className="text-sm font-medium text-gray-900">
            {subjectGroupName || "-"}
          </p>
        </div>
        <div className="flex flex-col gap-1">
          <span className="text-xs text-gray-500">ê³¼ëª© ìœ í˜•</span>
          <p className="text-sm font-medium text-gray-900">
            {subjectTypeName || "-"}
          </p>
        </div>
        <div className="flex flex-col gap-1">
          <span className="text-xs text-gray-500">í•™ë…„/íšŒì°¨/ì‹œí—˜ìœ í˜•</span>
          <p className="text-sm font-medium text-gray-900">
            {score.grade}í•™ë…„ {new Date(score.exam_date).getMonth() + 1}ì›” {score.exam_title}
          </p>
        </div>
      </div>

      {/* ì„±ì  ì •ë³´ */}
      <div className="flex flex-col gap-4 border-t border-gray-200 pt-4">
        <h3 className="text-sm font-semibold text-gray-900">ì„±ì  ì •ë³´</h3>
        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div className="flex flex-col gap-1">
            <span className="text-xs text-gray-500">ë“±ê¸‰</span>
            <div className="flex items-center gap-2">
              {score.grade_score !== null && (
                <div
                  className={cn(
                    "flex h-8 w-8 items-center justify-center rounded-full text-sm font-bold",
                    gradeColor.badge
                  )}
                >
                  {score.grade_score}
                </div>
              )}
              {score.grade_score === null && (
                <span className="text-sm font-medium text-gray-900">-</span>
              )}
            </div>
          </div>
          {score.standard_score !== null && (
            <div className="flex flex-col gap-1">
              <span className="text-xs text-gray-500">í‘œì¤€ì ìˆ˜</span>
              <p className="text-sm font-medium text-gray-900">
                {score.standard_score}
              </p>
            </div>
          )}
          {score.percentile !== null && (
            <div className="flex flex-col gap-1">
              <span className="text-xs text-gray-500">ë°±ë¶„ìœ„</span>
              <p className="text-sm font-medium text-gray-900">
                {score.percentile}%
              </p>
            </div>
          )}
        </div>
      </div>
    </>
  );

  return (
    <BaseScoreCard
      score={score}
      subjectGroupName={subjectGroupName}
      subjectName={subjectName}
      subjectTypeName={subjectTypeName}
      gradeBadge={gradeBadge}
      periodBadge={periodBadge}
      scoreFields={scoreFields}
      detailDialogContent={detailDialogContent}
      onEdit={onEdit}
      onDelete={onDelete}
    />
  );
}

export const MockScoreCard = memo(MockScoreCardComponent);
</file>

<file path="mock/[grade]/[month]/[exam-type]/_components/MockScoreCardGrid.tsx">
"use client";

import { useMemo, useState } from "react";
import { MockScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { MockScoreCard } from "./MockScoreCard";
import { EmptyState } from "@/components/molecules/EmptyState";
import { Plus, Filter, ArrowUpDown, FileText } from "lucide-react";
import { cn } from "@/lib/cn";

type MockScoreCardGridProps = {
  initialGrade?: number;
  initialExamType?: string;
  initialMonth?: string;
  scores: MockScore[];
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
  onAddClick?: () => void;
  onEdit: (score: MockScore) => void;
  onDelete: (scoreId: string) => void;
};

type SortField = "grade" | "examType" | "month" | "grade_score" | "standard_score" | "percentile" | "subject_name";
type SortOrder = "asc" | "desc";

const examTypes = ["í‰ê°€ì›", "êµìœ¡ì²­", "ì‚¬ì„¤"];
const months = ["3", "4", "5", "6", "7", "8", "9", "10", "11"];

export function MockScoreCardGrid({
  initialGrade,
  initialExamType,
  initialMonth,
  scores,
  subjectGroups,
  subjectTypes,
  onAddClick,
  onEdit,
  onDelete,
}: MockScoreCardGridProps) {
  const [sortField, setSortField] = useState<SortField>("grade");
  const [sortOrder, setSortOrder] = useState<SortOrder>("asc");
  const [filterGrade, setFilterGrade] = useState<string>(initialGrade?.toString() || "all");
  const [filterExamType, setFilterExamType] = useState<string>(initialExamType || "all");
  const [filterMonth, setFilterMonth] = useState<string>(initialMonth || "all");
  const [filterSubjectGroup, setFilterSubjectGroup] = useState<string>("all");
  const [filterSubject, setFilterSubject] = useState<string>("all");
  const [filterSubjectType, setFilterSubjectType] = useState<string>("all");
  const [showFilters, setShowFilters] = useState(false);

  // ì„±ì  ë°ì´í„°ì— ê³¼ëª© ì •ë³´ ë§¤í•‘
  const scoresWithInfo = useMemo(() => {
    return scores.map((score) => {
      const group = score.subject_group_id
        ? subjectGroups.find((g) => g.id === score.subject_group_id)
        : null;
      const subject = score.subject_id && group
        ? group.subjects.find((s) => s.id === score.subject_id)
        : null;
      // MockScore íƒ€ì…ì— subject_type_idê°€ ì—†ìœ¼ë¯€ë¡œ subjectTypeì€ í•­ìƒ null
      const subjectType = null;

      return {
        score,
        subjectGroupName: group?.name || "",
        subjectName: subject?.name || "",
        subjectTypeName: "", // MockScore íƒ€ì…ì— subject_type_idê°€ ì—†ìœ¼ë¯€ë¡œ í•­ìƒ ë¹ˆ ë¬¸ìì—´
      };
    });
  }, [scores, subjectGroups, subjectTypes]);

  // í•„í„°ë§ ë° ì •ë ¬
  const filteredAndSortedScores = useMemo(() => {
    let filtered = [...scoresWithInfo];

    // í•™ë…„ í•„í„°ë§
    if (filterGrade !== "all") {
      filtered = filtered.filter(
        (item) => item.score.grade === parseInt(filterGrade)
      );
    }

    // ì‹œí—˜ ìœ í˜• í•„í„°ë§ (exam_titleì—ì„œ ì¶”ì¶œ)
    if (filterExamType !== "all") {
      filtered = filtered.filter(
        (item) => item.score.exam_title.includes(filterExamType)
      );
    }

    // íšŒì°¨ í•„í„°ë§ (exam_dateì—ì„œ ì›” ì¶”ì¶œ)
    if (filterMonth !== "all") {
      filtered = filtered.filter(
        (item) => {
          const month = (new Date(item.score.exam_date).getMonth() + 1).toString();
          return month === filterMonth;
        }
      );
    }

    // êµê³¼ í•„í„°ë§
    if (filterSubjectGroup !== "all") {
      filtered = filtered.filter(
        (item) => item.subjectGroupName === filterSubjectGroup
      );
    }

    // ê³¼ëª© í•„í„°ë§
    if (filterSubject !== "all") {
      filtered = filtered.filter(
        (item) => item.subjectName === filterSubject
      );
    }

    // ê³¼ëª© ìœ í˜• í•„í„°ë§
    if (filterSubjectType !== "all") {
      filtered = filtered.filter((item) => item.subjectTypeName === filterSubjectType);
    }

    // ì •ë ¬
    filtered.sort((a, b) => {
      let aValue: number | string | null = null;
      let bValue: number | string | null = null;

      switch (sortField) {
        case "grade":
          aValue = a.score.grade ?? 0;
          bValue = b.score.grade ?? 0;
          break;
        case "examType":
          aValue = a.score.exam_title ?? "";
          bValue = b.score.exam_title ?? "";
          break;
        case "month":
          aValue = (new Date(a.score.exam_date).getMonth() + 1).toString();
          bValue = (new Date(b.score.exam_date).getMonth() + 1).toString();
          break;
        case "grade_score":
          aValue = a.score.grade_score ?? 999;
          bValue = b.score.grade_score ?? 999;
          break;
        case "standard_score":
          aValue = a.score.standard_score ?? 0;
          bValue = b.score.standard_score ?? 0;
          break;
        case "percentile":
          aValue = a.score.percentile ?? 0;
          bValue = b.score.percentile ?? 0;
          break;
        case "subject_name":
          aValue = a.subjectName;
          bValue = b.subjectName;
          break;
      }

      if (aValue < bValue) return sortOrder === "asc" ? -1 : 1;
      if (aValue > bValue) return sortOrder === "asc" ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [scoresWithInfo, sortField, sortOrder, filterGrade, filterExamType, filterMonth, filterSubjectGroup, filterSubject, filterSubjectType]);

  // ê³ ìœ í•œ êµê³¼ ë° ê³¼ëª© ìœ í˜• ëª©ë¡
  const availableSubjectGroups = useMemo(() => {
    const groups = new Set<string>();
    scoresWithInfo.forEach((item) => {
      if (item.subjectGroupName) groups.add(item.subjectGroupName);
    });
    return Array.from(groups).sort();
  }, [scoresWithInfo]);

  const availableSubjectTypes = useMemo(() => {
    const types = new Set<string>();
    scoresWithInfo.forEach((item) => {
      if (item.subjectTypeName) types.add(item.subjectTypeName);
    });
    return Array.from(types).sort();
  }, [scoresWithInfo]);

  const availableSubjects = useMemo(() => {
    const subjects = new Set<string>();
    scoresWithInfo.forEach((item) => {
      if (item.subjectName) subjects.add(item.subjectName);
    });
    return Array.from(subjects).sort();
  }, [scoresWithInfo]);

  const availableGrades = useMemo(() => {
    const grades = new Set<number>();
    scoresWithInfo.forEach((item) => {
      if (item.score.grade) grades.add(item.score.grade);
    });
    return Array.from(grades).sort();
  }, [scoresWithInfo]);

  const availableExamTypes = useMemo(() => {
    const types = new Set<string>();
    scoresWithInfo.forEach((item) => {
      // exam_titleì—ì„œ ì‹œí—˜ ìœ í˜• ì¶”ì¶œ (ì˜ˆ: "2024í•™ë…„ë„ 3ì›” í‰ê°€ì› ëª¨ì˜ê³ ì‚¬" -> "í‰ê°€ì›")
      const examTitle = item.score.exam_title || "";
      if (examTitle.includes("í‰ê°€ì›")) types.add("í‰ê°€ì›");
      if (examTitle.includes("êµìœ¡ì²­")) types.add("êµìœ¡ì²­");
      if (examTitle.includes("ì‚¬ì„¤")) types.add("ì‚¬ì„¤");
    });
    return Array.from(types).sort();
  }, [scoresWithInfo]);

  const availableMonths = useMemo(() => {
    const monthsSet = new Set<string>();
    scoresWithInfo.forEach((item) => {
      const month = (new Date(item.score.exam_date).getMonth() + 1).toString();
      monthsSet.add(month);
    });
    return Array.from(monthsSet).sort((a, b) => parseInt(a) - parseInt(b));
  }, [scoresWithInfo]);

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortOrder("desc");
    }
  };

  if (scores.length === 0) {
    return (
      <EmptyState
        icon={<FileText className="h-8 w-8 text-gray-400" />}
        title="ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤."
        description="ì„±ì ì„ ì¶”ê°€í•˜ì—¬ í•™ìŠµ ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•˜ì„¸ìš”."
        actionLabel="ì„±ì  ì¶”ê°€í•˜ê¸°"
        onAction={onAddClick}
      />
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {/* í•„í„° ë° ì •ë ¬ ë°” */}
      <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className={cn(
                "inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition",
                showFilters
                  ? "border-indigo-500 bg-indigo-50 text-indigo-700"
                  : "border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
              )}
            >
              <Filter className="h-4 w-4" />
              í•„í„°
            </button>
            {onAddClick && (
              <button
                onClick={onAddClick}
                className="inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                <Plus className="h-4 w-4" />
                ì„±ì  ì¶”ê°€
              </button>
            )}
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">
              ì´ {filteredAndSortedScores.length}ê°œ
            </span>
          </div>
        </div>

        {/* í•„í„° íŒ¨ë„ */}
        {showFilters && (
          <div className="flex flex-col gap-4 border-t border-gray-200 pt-4">
            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6">
            {/* í•™ë…„ í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                í•™ë…„
              </label>
              <select
                value={filterGrade}
                onChange={(e) => setFilterGrade(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableGrades.map((grade) => (
                  <option key={grade} value={grade.toString()}>
                    {grade}í•™ë…„
                  </option>
                ))}
              </select>
            </div>

            {/* ì‹œí—˜ ìœ í˜• í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ì‹œí—˜ ìœ í˜•
              </label>
              <select
                value={filterExamType}
                onChange={(e) => setFilterExamType(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableExamTypes.map((examType) => (
                  <option key={examType} value={examType}>
                    {examType}
                  </option>
                ))}
              </select>
            </div>

            {/* íšŒì°¨ í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                íšŒì°¨
              </label>
              <select
                value={filterMonth}
                onChange={(e) => setFilterMonth(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableMonths.map((month) => (
                  <option key={month} value={month}>
                    {month}ì›”
                  </option>
                ))}
              </select>
            </div>

            {/* êµê³¼ í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                êµê³¼
              </label>
              <select
                value={filterSubjectGroup}
                onChange={(e) => {
                  setFilterSubjectGroup(e.target.value);
                  setFilterSubject("all"); // êµê³¼ ë³€ê²½ ì‹œ ê³¼ëª© í•„í„° ì´ˆê¸°í™”
                }}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSubjectGroups.map((group) => (
                  <option key={group} value={group}>
                    {group}
                  </option>
                ))}
              </select>
            </div>

            {/* ê³¼ëª© í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ê³¼ëª©
              </label>
              <select
                value={filterSubject}
                onChange={(e) => setFilterSubject(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSubjects.map((subject) => (
                  <option key={subject} value={subject}>
                    {subject}
                  </option>
                ))}
              </select>
            </div>

            {/* ê³¼ëª© ìœ í˜• í•„í„° */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ê³¼ëª© ìœ í˜•
              </label>
              <select
                value={filterSubjectType}
                onChange={(e) => setFilterSubjectType(e.target.value)}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="all">ì „ì²´</option>
                {availableSubjectTypes.map((type) => (
                  <option key={type} value={type}>
                    {type}
                  </option>
                ))}
              </select>
            </div>

            {/* ì •ë ¬ ìˆœì„œ */}
            <div className="flex flex-col gap-2">
              <label className="block text-xs font-medium text-gray-700">
                ì •ë ¬ ìˆœì„œ
              </label>
              <button
                onClick={() => setSortOrder(sortOrder === "asc" ? "desc" : "asc")}
                className="flex w-full items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm transition hover:bg-gray-50"
              >
                <ArrowUpDown className="h-4 w-4" />
                {sortOrder === "asc" ? "ì˜¤ë¦„ì°¨ìˆœ" : "ë‚´ë¦¼ì°¨ìˆœ"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>

      {/* í•„í„° ì ìš© ì¤‘ì¼ ë•Œ ê²°ê³¼ê°€ ì—†ì„ ê²½ìš° */}
      {(filterGrade !== "all" || filterExamType !== "all" || filterMonth !== "all" || filterSubjectGroup !== "all" || filterSubject !== "all" || filterSubjectType !== "all") &&
        filteredAndSortedScores.length === 0 && (
          <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-8 text-center">
            <p className="text-sm text-gray-500">
              ì„ íƒí•œ í•„í„° ì¡°ê±´ì— ë§ëŠ” ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <button
              onClick={() => {
                setFilterGrade("all");
                setFilterExamType("all");
                setFilterMonth("all");
                setFilterSubjectGroup("all");
                setFilterSubject("all");
                setFilterSubjectType("all");
              }}
              className="text-sm font-medium text-indigo-600 hover:text-indigo-700"
            >
              í•„í„° ì´ˆê¸°í™”
            </button>
          </div>
        )}

      {/* ì¹´ë“œ ê·¸ë¦¬ë“œ */}
      {filteredAndSortedScores.length > 0 && (
        <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
          {filteredAndSortedScores.map((item) => (
            <MockScoreCard
              key={item.score.id}
              score={item.score}
              subjectGroupName={item.subjectGroupName}
              subjectName={item.subjectName}
              subjectTypeName={item.subjectTypeName}
              onEdit={onEdit}
              onDelete={onDelete}
            />
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="mock/[grade]/[month]/[exam-type]/_components/MockScoreFormModal.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * ìƒˆ ìŠ¤í‚¤ë§ˆ(student_mock_scores)ì— ë§ì¶° ì¬êµ¬ì¶•ì´ í•„ìš”í•©ë‹ˆë‹¤.
 * 
 * í–¥í›„ ê°œì„  ì‚¬í•­:
 * - subject_id, subject_group_id FK í•„ë“œ ì‚¬ìš©
 * - exam_year, exam_month í•„ë“œ ì¶”ê°€
 * - createMockScore (app/actions/scores-internal.ts) ì‚¬ìš©
 */
"use client";

import { useTransition, useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";
import { MockScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { addMockScore, updateMockScoreAction } from "@/app/(student)/actions/scoreActions";
import { useToast } from "@/components/ui/ToastProvider";

type MockScoreFormModalProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  initialGrade?: number;
  initialExamType?: string;
  initialMonth?: string;
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
  editingScore?: MockScore | null;
  onSuccess?: () => void;
};

type FormErrors = {
  grade?: string;
  examType?: string;
  examRound?: string;
  subject_id?: string;
  standard_score?: string;
  percentile?: string;
  grade_score?: string;
};

const examTypes = ["í‰ê°€ì›", "êµìœ¡ì²­", "ì‚¬ì„¤"];
const months = ["3", "4", "5", "6", "7", "8", "9", "10", "11"];

export function MockScoreFormModal({
  open,
  onOpenChange,
  initialGrade,
  initialExamType,
  initialMonth,
  subjectGroups,
  subjectTypes,
  editingScore,
  onSuccess,
}: MockScoreFormModalProps) {
  const router = useRouter();
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  const [errors, setErrors] = useState<FormErrors>({});
  const [touched, setTouched] = useState<Record<string, boolean>>({});

  // í¼ ìƒíƒœ
  const [formData, setFormData] = useState({
    grade: initialGrade?.toString() || "",
    examType: initialExamType || "",
    examRound: initialMonth || "",
    subject_group_id: "",
    subject_id: "",
    standard_score: "",
    percentile: "",
    grade_score: "",
  });

  // í¸ì§‘ ëª¨ë“œì¼ ë•Œ ì´ˆê¸°ê°’ ì„¤ì •
  useEffect(() => {
    if (editingScore && open) {
      // exam_titleì—ì„œ ì‹œí—˜ ìœ í˜• ì¶”ì¶œ (ì˜ˆ: "2024í•™ë…„ë„ 3ì›” í‰ê°€ì› ëª¨ì˜ê³ ì‚¬" -> "í‰ê°€ì›")
      const examTitle = editingScore.exam_title || "";
      let extractedExamType = initialExamType || "";
      if (examTitle.includes("í‰ê°€ì›")) extractedExamType = "í‰ê°€ì›";
      else if (examTitle.includes("êµìœ¡ì²­")) extractedExamType = "êµìœ¡ì²­";
      else if (examTitle.includes("ì‚¬ì„¤")) extractedExamType = "ì‚¬ì„¤";
      
      // exam_dateì—ì„œ ì›” ì¶”ì¶œ
      const examDate = editingScore.exam_date ? new Date(editingScore.exam_date) : null;
      const extractedMonth = examDate ? (examDate.getMonth() + 1).toString() : initialMonth || "";
      
      setFormData({
        grade: editingScore.grade?.toString() || initialGrade?.toString() || "",
        examType: extractedExamType,
        examRound: extractedMonth,
        subject_group_id: editingScore.subject_group_id || "",
        subject_id: editingScore.subject_id || "",
        standard_score: editingScore.standard_score?.toString() || "",
        percentile: editingScore.percentile?.toString() || "",
        grade_score: editingScore.grade_score?.toString() || "",
      });
    } else if (!editingScore && open) {
      // ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš° ì´ˆê¸°í™”
      setFormData({
        grade: initialGrade?.toString() || "",
        examType: initialExamType || "",
        examRound: initialMonth || "",
        subject_group_id: "",
        subject_id: "",
        standard_score: "",
        percentile: "",
        grade_score: "",
      });
    }
    // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì—ëŸ¬ ìƒíƒœ ì´ˆê¸°í™”
    if (!open) {
      setError(null);
      setErrors({});
      setTouched({});
    }
  }, [editingScore, open, initialGrade, initialExamType, initialMonth]);

  const validateField = (name: string, value: string | number | null): string | undefined => {
    switch (name) {
      case "grade":
        if (!value || value === "") {
          return "í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        const gradeNum = Number(value);
        if (isNaN(gradeNum) || gradeNum < 1 || gradeNum > 3) {
          return "í•™ë…„ì€ 1~3 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "examType":
        if (!value || value === "") {
          return "ì‹œí—˜ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        break;
      case "examRound":
        if (!value || value === "") {
          return "íšŒì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        break;
      case "subject_id":
        // ì‚¬íšŒ/ê³¼í•™ì¼ ë•Œë§Œ í•„ìˆ˜
        const group = subjectGroups.find((g) => g.id === formData.subject_group_id);
        const needsSubject = group && ["ì‚¬íšŒ", "ê³¼í•™"].includes(group.name);
        if (needsSubject && (!value || value === "")) {
          return "ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        break;
      case "grade_score":
        if (!value || value === "") {
          return "ë“±ê¸‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const gradeScoreNum = Number(value);
        if (isNaN(gradeScoreNum) || gradeScoreNum < 1 || gradeScoreNum > 9) {
          return "ë“±ê¸‰ì€ 1~9 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "standard_score":
        // ì˜ì–´/í•œêµ­ì‚¬ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í•„ìˆ˜
        const standardGroup = subjectGroups.find((g) => g.id === formData.subject_group_id);
        const isEnglishOrKoreanHistoryForStandard = standardGroup?.name === "ì˜ì–´" || standardGroup?.name === "í•œêµ­ì‚¬";
        if (!isEnglishOrKoreanHistoryForStandard) {
          if (!value || value === "") {
            return "í‘œì¤€ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          }
          const standardNum = Number(value);
          if (isNaN(standardNum)) {
            return "í‘œì¤€ì ìˆ˜ëŠ” ì˜¬ë°”ë¥¸ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
      case "percentile":
        // ì˜ì–´/í•œêµ­ì‚¬ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í•„ìˆ˜
        const percentileGroup = subjectGroups.find((g) => g.id === formData.subject_group_id);
        const isEnglishOrKoreanHistoryForPercentile = percentileGroup?.name === "ì˜ì–´" || percentileGroup?.name === "í•œêµ­ì‚¬";
        if (!isEnglishOrKoreanHistoryForPercentile) {
          if (!value || value === "") {
            return "ë°±ë¶„ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          }
          const percentileNum = Number(value);
          if (isNaN(percentileNum) || percentileNum < 0 || percentileNum > 100) {
            return "ë°±ë¶„ìœ„ëŠ” 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
    }
    return undefined;
  };

  const handleBlur = (e: React.FocusEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setTouched((prev) => ({ ...prev, [name]: true }));
    const error = validateField(name, value);
    setErrors((prev) => ({ ...prev, [name]: error }));
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));

    // êµê³¼ ì„ íƒ ì‹œ ê³¼ëª© ì´ˆê¸°í™”
    if (name === "subject_group_id") {
      const group = subjectGroups.find((g) => g.id === value);
      const needsSubject = group && ["ì‚¬íšŒ", "ê³¼í•™"].includes(group.name);
      const firstSubject = group?.subjects[0];
      setFormData((prev) => ({
        ...prev,
        subject_group_id: value,
        subject_id: needsSubject ? (firstSubject?.id || "") : "",
      }));
    }

    if (touched[name]) {
      const error = validateField(name, value);
      setErrors((prev) => ({ ...prev, [name]: error }));
    }
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError(null);
    setErrors({});

    const group = subjectGroups.find((g) => g.id === formData.subject_group_id);
    const isEnglishOrKoreanHistory = group?.name === "ì˜ì–´" || group?.name === "í•œêµ­ì‚¬";

    const formErrors: FormErrors = {};

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const requiredFields = [
      "grade",
      "examType",
      "examRound",
      "subject_group_id",
      "grade_score",
    ];
    requiredFields.forEach((field) => {
      const value = formData[field as keyof typeof formData];
      const error = validateField(field, value);
      if (error) {
        formErrors[field as keyof FormErrors] = error;
        setTouched((prev) => ({ ...prev, [field]: true }));
      }
    });

    // ì‚¬íšŒ/ê³¼í•™ì¼ ë•Œë§Œ ê³¼ëª© í•„ìˆ˜
    const needsSubject = group && ["ì‚¬íšŒ", "ê³¼í•™"].includes(group.name);
    if (needsSubject) {
      const subjectError = validateField("subject_id", formData.subject_id);
      if (subjectError) {
        formErrors.subject_id = subjectError;
        setTouched((prev) => ({ ...prev, subject_id: true }));
      }
    }

    // ì˜ì–´/í•œêµ­ì‚¬ê°€ ì•„ë‹Œ ê²½ìš° í‘œì¤€ì ìˆ˜, ë°±ë¶„ìœ„ í•„ìˆ˜
    if (!isEnglishOrKoreanHistory) {
      const standardError = validateField("standard_score", formData.standard_score);
      if (standardError) {
        formErrors.standard_score = standardError;
        setTouched((prev) => ({ ...prev, standard_score: true }));
      }
      const percentileError = validateField("percentile", formData.percentile);
      if (percentileError) {
        formErrors.percentile = percentileError;
        setTouched((prev) => ({ ...prev, percentile: true }));
      }
    }

    if (Object.keys(formErrors).length > 0) {
      setErrors(formErrors);
      return;
    }

    startTransition(async () => {
      try {
        const group = subjectGroups.find((g) => g.id === formData.subject_group_id);
        const needsSubject = group && ["ì‚¬íšŒ", "ê³¼í•™"].includes(group.name);
        const subject = needsSubject && formData.subject_id
          ? group?.subjects.find((s) => s.id === formData.subject_id)
          : null;

        if (!group || (needsSubject && !subject)) {
          throw new Error("êµê³¼ ë˜ëŠ” ê³¼ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const submitFormData = new FormData();
        submitFormData.append("grade", formData.grade);
        submitFormData.append("exam_type", formData.examType);
        submitFormData.append("exam_round", formData.examRound);
        submitFormData.append("subject_group_id", group.id);
        if (needsSubject && subject) {
          submitFormData.append("subject_id", subject.id);
          submitFormData.append("subject_name", subject.name);
        } else {
          // êµ­ì–´/ìˆ˜í•™/ì˜ì–´ëŠ” subject_idë¥¼ ë¹ˆ ë¬¸ìì—´ë¡œ ì €ì¥
          submitFormData.append("subject_id", "");
          submitFormData.append("subject_name", "");
        }
        // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ í…ìŠ¤íŠ¸ í•„ë“œë„ í•¨ê»˜ ì „ë‹¬
        submitFormData.append("subject_group", group.name);
        if (formData.standard_score) submitFormData.append("standard_score", formData.standard_score);
        if (formData.percentile) submitFormData.append("percentile", formData.percentile);
        submitFormData.append("grade_score", formData.grade_score);
        // ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ë•ŒëŠ” redirect ë°©ì§€
        submitFormData.append("skipRedirect", "true");

        if (editingScore) {
          await updateMockScoreAction(editingScore.id, submitFormData);
          showSuccess("ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          await addMockScore(submitFormData);
          showSuccess("ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        onOpenChange(false);
        router.refresh();
        onSuccess?.();
      } catch (err) {
        const errorMessage = err instanceof Error ? err.message : "ì„±ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        setError(errorMessage);
        showError(errorMessage);
      }
    });
  };

  const getSubjectsByGroupId = (groupId: string): Subject[] => {
    if (!groupId) return [];
    const group = subjectGroups.find((g) => g.id === groupId);
    return group?.subjects || [];
  };

  const shouldShowSubjectSelect = (groupName: string | null): boolean => {
    if (!groupName) return false;
    return ["ì‚¬íšŒ", "ê³¼í•™"].includes(groupName);
  };

  const group = subjectGroups.find((g) => g.id === formData.subject_group_id);
  const isEnglishOrKoreanHistory = group?.name === "ì˜ì–´" || group?.name === "í•œêµ­ì‚¬";
  const needsSubject = shouldShowSubjectSelect(group?.name || null);

  return (
    <Dialog
      open={open}
      onOpenChange={onOpenChange}
      title={editingScore ? "ì„±ì  ìˆ˜ì •" : "ì„±ì  ì¶”ê°€"}
      description={`ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ${editingScore ? "ìˆ˜ì •" : "ì¶”ê°€"}í•©ë‹ˆë‹¤.`}
      maxWidth="2xl"
    >
      <form onSubmit={handleSubmit} className="flex flex-col gap-6">
        {error && (
          <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {error}
          </div>
        )}

        <div className="grid gap-6 sm:grid-cols-2">
          {/* í•™ë…„ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="grade"
              className="block text-sm font-medium text-gray-700"
            >
              í•™ë…„ <span className="text-red-500">*</span>
            </label>
            <select
              id="grade"
              name="grade"
              value={formData.grade}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.grade
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="1">1í•™ë…„</option>
              <option value="2">2í•™ë…„</option>
              <option value="3">3í•™ë…„</option>
            </select>
            {errors.grade && touched.grade && (
              <p className="text-xs text-red-600">{errors.grade}</p>
            )}
          </div>

          {/* ì‹œí—˜ ìœ í˜• */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="examType"
              className="block text-sm font-medium text-gray-700"
            >
              ì‹œí—˜ ìœ í˜• <span className="text-red-500">*</span>
            </label>
            <select
              id="examType"
              name="examType"
              value={formData.examType}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.examType
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {examTypes.map((type) => (
                <option key={type} value={type}>
                  {type}
                </option>
              ))}
            </select>
            {errors.examType && touched.examType && (
              <p className="text-xs text-red-600">{errors.examType}</p>
            )}
          </div>

          {/* íšŒì°¨ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="examRound"
              className="block text-sm font-medium text-gray-700"
            >
              íšŒì°¨ <span className="text-red-500">*</span>
            </label>
            <select
              id="examRound"
              name="examRound"
              value={formData.examRound}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.examRound
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {months.map((month) => (
                <option key={month} value={month}>
                  {month}ì›”
                </option>
              ))}
            </select>
            {errors.examRound && touched.examRound && (
              <p className="text-xs text-red-600">{errors.examRound}</p>
            )}
          </div>

          {/* êµê³¼ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_group_id"
              className="block text-sm font-medium text-gray-700"
            >
              êµê³¼ <span className="text-red-500">*</span>
            </label>
            <select
              id="subject_group_id"
              name="subject_group_id"
              value={formData.subject_group_id}
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.subject_id && !formData.subject_group_id
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {subjectGroups.map((group) => (
                <option key={group.id} value={group.id}>
                  {group.name}
                </option>
              ))}
            </select>
          </div>

          {/* ê³¼ëª© */}
          {needsSubject && (
            <div className="flex flex-col gap-2">
              <label htmlFor="subject_id" className="block text-sm font-medium text-gray-700">
                ê³¼ëª© <span className="text-red-500">*</span>
              </label>
              <select
                id="subject_id"
                name="subject_id"
                value={formData.subject_id}
                onBlur={handleBlur}
                onChange={handleChange}
                disabled={!formData.subject_group_id}
                className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                  errors.subject_id
                    ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                    : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
                }`}
              >
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                {getSubjectsByGroupId(formData.subject_group_id).map((subject) => (
                  <option key={subject.id} value={subject.id}>
                    {subject.name}
                  </option>
                ))}
              </select>
              {errors.subject_id && touched.subject_id && (
                <p className="text-xs text-red-600">{errors.subject_id}</p>
              )}
            </div>
          )}

          {/* í‘œì¤€ì ìˆ˜ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="standard_score" className="block text-sm font-medium text-gray-700">
              í‘œì¤€ì ìˆ˜ {!isEnglishOrKoreanHistory && <span className="text-red-500">*</span>}
              {isEnglishOrKoreanHistory && (
                <span className="text-xs text-gray-500 font-normal">(ì˜ì–´/í•œêµ­ì‚¬ ì œì™¸)</span>
              )}
            </label>
            <input
              type="number"
              id="standard_score"
              name="standard_score"
              step="0.1"
              value={formData.standard_score}
              onBlur={handleBlur}
              onChange={handleChange}
              disabled={isEnglishOrKoreanHistory}
              placeholder="130"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                errors.standard_score
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.standard_score && touched.standard_score && (
              <p className="text-xs text-red-600">{errors.standard_score}</p>
            )}
          </div>

          {/* ë°±ë¶„ìœ„ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="percentile" className="block text-sm font-medium text-gray-700">
              ë°±ë¶„ìœ„ {!isEnglishOrKoreanHistory && <span className="text-red-500">*</span>}
              {isEnglishOrKoreanHistory && (
                <span className="text-xs text-gray-500 font-normal">(ì˜ì–´/í•œêµ­ì‚¬ ì œì™¸)</span>
              )}
            </label>
            <input
              type="number"
              id="percentile"
              name="percentile"
              step="0.1"
              min="0"
              max="100"
              value={formData.percentile}
              onBlur={handleBlur}
              onChange={handleChange}
              disabled={isEnglishOrKoreanHistory}
              placeholder="95.5"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                errors.percentile
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.percentile && touched.percentile && (
              <p className="text-xs text-red-600">{errors.percentile}</p>
            )}
          </div>

          {/* ë“±ê¸‰ */}
          <div className="flex flex-col gap-2">
            <label htmlFor="grade_score" className="block text-sm font-medium text-gray-700">
              ë“±ê¸‰ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="grade_score"
              name="grade_score"
              min="1"
              max="9"
              value={formData.grade_score}
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="1~9"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.grade_score
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.grade_score && touched.grade_score && (
              <p className="text-xs text-red-600">{errors.grade_score}</p>
            )}
            <p className="text-xs text-gray-500">1ë“±ê¸‰ì´ ê°€ì¥ ë†’ê³ , 9ë“±ê¸‰ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>

        <DialogFooter>
          <button
            type="button"
            onClick={() => onOpenChange(false)}
            disabled={isPending}
            className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            ì·¨ì†Œ
          </button>
          <button
            type="submit"
            disabled={isPending}
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isPending ? (editingScore ? "ìˆ˜ì • ì¤‘..." : "ë“±ë¡ ì¤‘...") : editingScore ? "ìˆ˜ì •í•˜ê¸°" : "ë“±ë¡í•˜ê¸°"}
          </button>
        </DialogFooter>
      </form>
    </Dialog>
  );
}
</file>

<file path="mock/[grade]/[month]/[exam-type]/_components/MockScoresTable.tsx">
"use client";

import React, { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { MockScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { addMockScore, updateMockScoreAction, deleteMockScoreAction } from "@/app/(student)/actions/scoreActions";

type MockScoresTableProps = {
  grade: number;
  examType: string;
  month: string;
  initialScores: MockScore[];
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
};

type MockScoreFormData = {
  id?: string; // ê¸°ì¡´ ì„±ì  ID (ìˆ˜ì • ì‹œ)
  subject_group_id: string;
  subject_id: string;
  standard_score: string;
  percentile: string;
  grade_score: string; // ìˆ«ì ë“±ê¸‰ (1~9)
  exam_round: string; // íšŒì°¨ (ì›”) - íƒ­ì˜ ì›” ê°’ìœ¼ë¡œ ìë™ ì„¤ì •ë¨ (UIì—ì„œ ì…ë ¥ ë¶ˆê°€)
};

// ê¸°ë³¸ êµê³¼ ëª©ë¡ (í•­ìƒ í‘œì‹œ) - ëª¨ì˜ê³ ì‚¬ ê¸°ë³¸ ì„¸íŠ¸
const DEFAULT_SUBJECT_GROUP_NAMES = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ì‚¬íšŒ", "ê³¼í•™"];

export default function MockScoresTable({
  grade,
  examType,
  month,
  initialScores,
  subjectGroups,
  subjectTypes,
}: MockScoresTableProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [selectedRows, setSelectedRows] = useState<Set<number>>(new Set());

  // ëª¨ë“  ì„±ì ì„ ë‹¨ì¼ ë°°ì—´ë¡œ ê´€ë¦¬
  const [scores, setScores] = useState<MockScoreFormData[]>(() => {
    const scoreMap = new Map<string, MockScoreFormData>();

    // ê¸°ì¡´ ì„±ì  ë°ì´í„°ë¥¼ ë§µì— ì €ì¥ (subject_group_id:subject_idë¥¼ í‚¤ë¡œ ì‚¬ìš©)
    initialScores.forEach((score) => {
      // FK ê¸°ë°˜ìœ¼ë¡œ êµê³¼/ê³¼ëª© ì°¾ê¸°
      const group = score.subject_group_id
        ? subjectGroups.find((g) => g.id === score.subject_group_id)
        : null;
      if (!group) return;

      const subject = score.subject_id
        ? group.subjects.find((s) => s.id === score.subject_id)
        : null;

      const key = `${group.id}:${subject?.id || ""}`;
      scoreMap.set(key, {
        id: score.id,
        subject_group_id: group.id,
        subject_id: subject?.id || "",
        standard_score: score.standard_score?.toString() || "",
        percentile: score.percentile?.toString() || "",
        grade_score: score.grade_score?.toString() || "",
        exam_round: month, // íƒ­ì˜ ì›” ê°’ì„ ìë™ ì‚¬ìš©
      });
    });

    // ê¸°ë³¸ êµê³¼ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë°°ì—´ ìƒì„±
    const result: MockScoreFormData[] = DEFAULT_SUBJECT_GROUP_NAMES.map((groupName) => {
      // í•´ë‹¹ êµê³¼ ê·¸ë£¹ ì°¾ê¸°
      const defaultGroup = subjectGroups.find((g) => g.name === groupName);
      if (!defaultGroup) {
        // êµê³¼ ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ë¹ˆ í–‰
      return {
        subject_group_id: "",
        subject_id: "",
        standard_score: "",
        percentile: "",
        grade_score: "",
        exam_round: month, // íƒ­ì˜ ì›” ê°’ì„ ìë™ ì‚¬ìš©
      };
      }

      // êµ­ì–´/ìˆ˜í•™/ì˜ì–´ëŠ” ê³¼ëª©ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
      const shouldUseSubject = ["ì‚¬íšŒ", "ê³¼í•™"].includes(groupName);
      const firstSubject = defaultGroup.subjects[0];
      const key = firstSubject ? `${groupName}:${firstSubject.name}` : null;
      const existingScore = key ? scoreMap.get(key) : undefined;

      if (existingScore) {
        return existingScore;
      }

      return {
        subject_group_id: defaultGroup.id,
        subject_id: shouldUseSubject ? (firstSubject?.id || "") : "",
        standard_score: "",
        percentile: "",
        grade_score: "",
        exam_round: month, // íƒ­ì˜ ì›” ê°’ì„ ìë™ ì‚¬ìš©
      };
    });

    // ê¸°ë³¸ êµê³¼ ì™¸ ì¶”ê°€ëœ ì„±ì ë“¤ ì¶”ê°€
    scoreMap.forEach((score, key) => {
      const [groupName] = key.split(":");
      if (!DEFAULT_SUBJECT_GROUP_NAMES.includes(groupName)) {
        result.push(score);
      }
    });

    return result;
  });

  // ì²´í¬ë°•ìŠ¤ í† ê¸€
  const toggleRowSelection = (index: number) => {
    setSelectedRows((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(index)) {
        newSet.delete(index);
      } else {
        newSet.add(index);
      }
      return newSet;
    });
  };

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const toggleAllSelection = () => {
    if (selectedRows.size === scores.length) {
      setSelectedRows(new Set());
    } else {
      setSelectedRows(new Set(scores.map((_, i) => i)));
    }
  };

  // ì„ íƒëœ í–‰ë“¤ ì‚­ì œ
  const handleDeleteSelected = async () => {
    if (selectedRows.size === 0) {
      alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!confirm(`ì„ íƒí•œ ${selectedRows.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }

    const selectedIndices = Array.from(selectedRows).sort((a, b) => b - a);
    const rowsToDelete = selectedIndices
      .map((index) => scores[index])
      .filter((row) => row.id);

    startTransition(async () => {
      try {
        // DBì—ì„œ ì‚­ì œ
        await Promise.all(rowsToDelete.map((row) => deleteMockScoreAction(row.id!)));
        // ì„ íƒëœ í–‰ë“¤ì„ ìƒíƒœì—ì„œ ì œê±° (ë’¤ì—ì„œë¶€í„° ì œê±°í•˜ì—¬ ì¸ë±ìŠ¤ ë¬¸ì œ ë°©ì§€)
        setScores((prev) => prev.filter((_, i) => !selectedRows.has(i)));
        setSelectedRows(new Set());
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "ì„±ì  ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  };

  // í•„ë“œ ê°’ ë³€ê²½
  const updateField = (
    index: number,
    field: keyof MockScoreFormData,
    value: string
  ) => {
    setScores((prev) =>
      prev.map((row, i) => (i === index ? { ...row, [field]: value } : row))
    );
  };

  // êµê³¼ ì„ íƒ ì‹œ ê³¼ëª© í•„í„°ë§
  const handleSubjectGroupChange = (index: number, groupId: string) => {
    const group = subjectGroups.find((g) => g.id === groupId);
    if (!group) {
      updateField(index, "subject_group_id", groupId);
      updateField(index, "subject_id", "");
      return;
    }

    // ì‚¬íšŒ/ê³¼í•™ì¼ ë•Œë§Œ ê³¼ëª© ì„ íƒ, êµ­ì–´/ìˆ˜í•™/ì˜ì–´ëŠ” ê³¼ëª©ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    const shouldUseSubject = ["ì‚¬íšŒ", "ê³¼í•™"].includes(group.name);
    const firstSubject = group.subjects[0];

    setScores((prev) =>
      prev.map((row, i) =>
        i === index
          ? {
              ...row,
              subject_group_id: group.id,
              subject_id: shouldUseSubject ? (firstSubject?.id || "") : "",
            }
          : row
      )
    );
  };

  // ê³¼ëª© ì„ íƒ ì‹œ êµê³¼ ê·¸ë£¹ ìë™ ì„¤ì •
  const handleSubjectChange = (index: number, subjectId: string) => {
    const group = subjectGroups.find((g) =>
      g.subjects.some((s) => s.id === subjectId)
    );
    if (group) {
      setScores((prev) =>
        prev.map((row, i) =>
          i === index
            ? {
                ...row,
                subject_id: subjectId,
                subject_group_id: group.id,
              }
            : row
        )
      );
    } else {
      updateField(index, "subject_id", subjectId);
    }
  };

  // ì„ íƒëœ êµê³¼ ê·¸ë£¹ì˜ ê³¼ëª© ëª©ë¡ë§Œ ë°˜í™˜
  const getSubjectsByGroupId = (groupId: string): Subject[] => {
    if (!groupId) return [];
    const group = subjectGroups.find((g) => g.id === groupId);
    return group?.subjects || [];
  };

  // ë¹ˆ í–‰ ì¶”ê°€
  const handleAddRow = () => {
    setScores((prev) => [
      ...prev,
      {
        subject_group_id: "",
        subject_id: "",
        standard_score: "",
        percentile: "",
        grade_score: "",
        exam_round: month,
      },
    ]);
  };

  // ê³¼ëª© ì„ íƒì´ í•„ìš”í•œ êµê³¼ì¸ì§€ í™•ì¸
  const shouldShowSubjectSelect = (groupName: string | null): boolean => {
    if (!groupName) return false;
    return ["ì‚¬íšŒ", "ê³¼í•™"].includes(groupName);
  };

  // í•„ìˆ˜ í•„ë“œ ê²€ì¦
  const validateRow = (row: MockScoreFormData): string[] => {
    const missingFields: string[] = [];
    const group = subjectGroups.find((g) => g.id === row.subject_group_id);
    const isEnglishOrKoreanHistory = group?.name === "ì˜ì–´" || group?.name === "í•œêµ­ì‚¬";
    const needsSubject = shouldShowSubjectSelect(group?.name || null);
    
    if (!row.subject_group_id) missingFields.push("êµê³¼");
    if (needsSubject && !row.subject_id) missingFields.push("ê³¼ëª©");
    if (!row.grade_score) missingFields.push("ë“±ê¸‰");
    if (!isEnglishOrKoreanHistory) {
      if (!row.standard_score) missingFields.push("í‘œì¤€ì ìˆ˜");
      if (!row.percentile) missingFields.push("ë°±ë¶„ìœ„");
    }
    return missingFields;
  };

  // ì „ì²´ ì €ì¥
  const handleSaveAll = async () => {
    const rowsToSave = scores.filter((row) => {
      // í•„ìˆ˜ í•„ë“œê°€ ëª¨ë‘ ì±„ì›Œì§„ í–‰ë§Œ ì €ì¥
      // ì˜ì–´/í•œêµ­ì‚¬ê°€ ì•„ë‹Œ ê²½ìš° í‘œì¤€ì ìˆ˜, ë°±ë¶„ìœ„ë„ í•„ìˆ˜
      const group = subjectGroups.find((g) => g.id === row.subject_group_id);
      const isEnglishOrKoreanHistory = group?.name === "ì˜ì–´" || group?.name === "í•œêµ­ì‚¬";
      
      const needsSubject = shouldShowSubjectSelect(group?.name || null);
      return (
        row.subject_group_id &&
        (!needsSubject || row.subject_id) &&
        row.grade_score &&
        (isEnglishOrKoreanHistory || (row.standard_score && row.percentile))
      );
    });

    if (rowsToSave.length === 0) {
      // ì–´ë–¤ í•„ë“œê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
      const incompleteRows: Array<{ index: number; missingFields: string[] }> = [];
      scores.forEach((row, index) => {
        const missingFields = validateRow(row);
        if (missingFields.length > 0 && (row.subject_group_id || row.subject_id || row.grade_score)) {
          incompleteRows.push({ index: index + 1, missingFields });
        }
      });

      if (incompleteRows.length > 0) {
        const message = `ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.\n\në¹„ì–´ìˆëŠ” í•„ìˆ˜ í•„ë“œ:\n${incompleteRows
          .slice(0, 3)
          .map((r) => `  ${r.index}í–‰: ${r.missingFields.join(", ")}`)
          .join("\n")}${incompleteRows.length > 3 ? `\n  ... ì™¸ ${incompleteRows.length - 3}ê°œ í–‰` : ""}`;
        alert(message);
      } else {
        alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í•„ìˆ˜ í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\ní•„ìˆ˜ í•„ë“œ: êµê³¼, ê³¼ëª©, ë“±ê¸‰, í‘œì¤€ì ìˆ˜(ì˜ì–´/í•œêµ­ì‚¬ ì œì™¸), ë°±ë¶„ìœ„(ì˜ì–´/í•œêµ­ì‚¬ ì œì™¸)");
      }
      return;
    }

    startTransition(async () => {
      try {
        const savePromises = rowsToSave.map((row) => {
          const group = subjectGroups.find((g) => g.id === row.subject_group_id);
          const needsSubject = shouldShowSubjectSelect(group?.name || null);
          const subject = needsSubject && row.subject_id 
            ? group?.subjects.find((s) => s.id === row.subject_id)
            : null;

          if (!group || (needsSubject && !subject)) {
            return Promise.resolve();
          }

          const formData = new FormData();
          formData.append("grade", grade.toString());
          formData.append("exam_type", examType);
          // FK í•„ë“œ ì „ë‹¬
          formData.append("subject_group_id", group.id);
          if (needsSubject && subject) {
            formData.append("subject_id", subject.id);
            formData.append("subject_name", subject.name);
          } else {
            // êµ­ì–´/ìˆ˜í•™/ì˜ì–´ëŠ” subject_idë¥¼ ë¹ˆ ë¬¸ìì—´ë¡œ ì €ì¥
            formData.append("subject_id", "");
            formData.append("subject_name", "");
          }
          // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ í…ìŠ¤íŠ¸ í•„ë“œë„ í•¨ê»˜ ì „ë‹¬
          formData.append("subject_group", group.name);
          // raw_scoreëŠ” null (ëª¨ì˜ê³ ì‚¬ì—ëŠ” ì›ì ìˆ˜ê°€ ì—†ìŒ)
          if (row.standard_score) formData.append("standard_score", row.standard_score);
          if (row.percentile) formData.append("percentile", row.percentile);
          formData.append("grade_score", row.grade_score);
          formData.append("exam_round", month); // íƒ­ì˜ ì›” ê°’ì„ ìë™ ì‚¬ìš©

          if (row.id) {
            return updateMockScoreAction(row.id, formData);
          } else {
            return addMockScore(formData);
          }
        });

        await Promise.all(savePromises);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "ì„±ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  };

  return (
    <div className="flex flex-col gap-4">
      {/* ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ */}
      <div className="flex items-center justify-between">
        <div className="flex gap-2">
          <button
            type="button"
            onClick={handleAddRow}
            disabled={isPending}
            className="rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-green-700 disabled:opacity-50"
          >
            + ê³¼ëª© ì¶”ê°€
          </button>
          <button
            type="button"
            onClick={handleSaveAll}
            disabled={isPending}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
          >
            ì „ì²´ ì €ì¥
          </button>
          {selectedRows.size > 0 && (
            <>
              <button
                type="button"
                onClick={handleDeleteSelected}
                disabled={isPending}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
              >
                ì„ íƒ ì‚­ì œ ({selectedRows.size})
              </button>
              <button
                type="button"
                onClick={() => setSelectedRows(new Set())}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                ì„ íƒ ì·¨ì†Œ
              </button>
            </>
          )}
        </div>
      </div>

      <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr className="border-b border-gray-200">
              <th className="w-12 px-2 py-3 text-center text-sm font-semibold text-gray-700">
                <input
                  type="checkbox"
                  checked={selectedRows.size === scores.length && scores.length > 0}
                  onChange={toggleAllSelection}
                  className="h-4 w-4 cursor-pointer rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                />
              </th>
              <th className="w-24 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                êµê³¼ <span className="text-red-500">*</span>
              </th>
              <th className="w-28 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ê³¼ëª© <span className="text-red-500">*</span>
              </th>
              <th className="w-22 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                í‘œì¤€ì ìˆ˜ <span className="text-red-500 text-xs">*</span>
                <span className="text-xs text-gray-500 block font-normal">(ì˜ì–´/í•œêµ­ì‚¬ ì œì™¸)</span>
              </th>
              <th className="w-22 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ë°±ë¶„ìœ„ <span className="text-red-500 text-xs">*</span>
                <span className="text-xs text-gray-500 block font-normal">(ì˜ì–´/í•œêµ­ì‚¬ ì œì™¸)</span>
              </th>
              <th className="w-20 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ë“±ê¸‰ <span className="text-red-500">*</span>
              </th>
            </tr>
          </thead>
          <tbody>
            {scores.map((row, index) => {
              const subjectsInGroup = getSubjectsByGroupId(row.subject_group_id);
              const missingFields = validateRow(row);
              const group = subjectGroups.find((g) => g.id === row.subject_group_id);
              const isEnglishOrKoreanHistory = group?.name === "ì˜ì–´" || group?.name === "í•œêµ­ì‚¬";
              const needsSubject = shouldShowSubjectSelect(group?.name || null);
              const hasIncompleteRequiredFields = missingFields.length > 0 && (row.subject_group_id || (needsSubject && row.subject_id) || row.grade_score);
              
              return (
                <tr
                  key={index}
                  className={`border-b border-gray-100 transition hover:bg-gray-50 ${
                    hasIncompleteRequiredFields ? "bg-red-50/30" : ""
                  }`}
                >
                  <td className="px-2 py-3 text-center">
                    <input
                      type="checkbox"
                      checked={selectedRows.has(index)}
                      onChange={() => toggleRowSelection(index)}
                      className="h-4 w-4 cursor-pointer rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <select
                      value={row.subject_group_id}
                      onChange={(e) => handleSubjectGroupChange(index, e.target.value)}
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.subject_group_id && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                    >
                      <option value="">ì„ íƒ</option>
                      {subjectGroups.map((group) => (
                        <option key={group.id} value={group.id}>
                          {group.name}
                        </option>
                      ))}
                    </select>
                  </td>
                  {needsSubject ? (
                    <td className="px-3 py-3">
                      <select
                        value={row.subject_id}
                        onChange={(e) => handleSubjectChange(index, e.target.value)}
                        disabled={!row.subject_group_id}
                        className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                          !row.subject_id && hasIncompleteRequiredFields
                            ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                            : "border-gray-300 focus:ring-indigo-500"
                        }`}
                      >
                        <option value="">ì„ íƒ</option>
                        {subjectsInGroup.map((subject) => (
                          <option key={subject.id} value={subject.id}>
                            {subject.name}
                          </option>
                        ))}
                      </select>
                    </td>
                  ) : (
                    <td className="px-3 py-3 text-xs text-gray-500">-</td>
                  )}
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      step="0.1"
                      value={row.standard_score}
                      onChange={(e) =>
                        updateField(index, "standard_score", e.target.value)
                      }
                      disabled={isEnglishOrKoreanHistory}
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                        !row.standard_score && hasIncompleteRequiredFields && !isEnglishOrKoreanHistory
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                      placeholder="130"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      step="0.1"
                      min="0"
                      max="100"
                      value={row.percentile}
                      onChange={(e) =>
                        updateField(index, "percentile", e.target.value)
                      }
                      disabled={isEnglishOrKoreanHistory}
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                        !row.percentile && hasIncompleteRequiredFields && !isEnglishOrKoreanHistory
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                      placeholder="95.5"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      min="1"
                      max="9"
                      step="1"
                      value={row.grade_score}
                      onChange={(e) =>
                        updateField(index, "grade_score", e.target.value)
                      }
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.grade_score && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                      placeholder="1~9"
                    />
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="mock/[grade]/[month]/[exam-type]/_components/MockScoresView.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { MockScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { MockScoreCardGrid } from "./MockScoreCardGrid";
import { MockScoreFormModal } from "./MockScoreFormModal";
import { Dialog } from "@/components/ui/Dialog";
import { deleteMockScoreAction } from "@/app/(student)/actions/scoreActions";
import { useToast } from "@/components/ui/ToastProvider";

type MockScoresViewProps = {
  initialGrade?: number;
  initialExamType?: string;
  initialMonth?: string;
  scores: MockScore[];
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
};

export function MockScoresView({
  initialGrade,
  initialExamType,
  initialMonth,
  scores,
  subjectGroups,
  subjectTypes,
}: MockScoresViewProps) {
  const router = useRouter();
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingScore, setEditingScore] = useState<MockScore | null>(null);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [deletingScoreId, setDeletingScoreId] = useState<string | null>(null);

  const handleAddClick = () => {
    setEditingScore(null);
    setIsModalOpen(true);
  };

  const handleEdit = (score: MockScore) => {
    setEditingScore(score);
    setIsModalOpen(true);
  };

  const handleDelete = (scoreId: string) => {
    setDeletingScoreId(scoreId);
    setDeleteConfirmOpen(true);
  };

  const handleDeleteConfirm = async () => {
    if (!deletingScoreId) return;

    startTransition(async () => {
      try {
        await deleteMockScoreAction(deletingScoreId);
        showSuccess("ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        setDeleteConfirmOpen(false);
        setDeletingScoreId(null);
        router.refresh();
      } catch (err) {
        const errorMessage = err instanceof Error ? err.message : "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        showError(errorMessage);
      }
    });
  };

  const handleModalSuccess = () => {
    setIsModalOpen(false);
    setEditingScore(null);
  };

  return (
    <>
      <MockScoreCardGrid
        initialGrade={initialGrade}
        initialExamType={initialExamType}
        initialMonth={initialMonth}
        scores={scores}
        subjectGroups={subjectGroups}
        subjectTypes={subjectTypes}
        onAddClick={handleAddClick}
        onEdit={handleEdit}
        onDelete={handleDelete}
      />

      {/* ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ */}
      <MockScoreFormModal
        open={isModalOpen}
        onOpenChange={setIsModalOpen}
        initialGrade={initialGrade}
        initialExamType={initialExamType}
        initialMonth={initialMonth}
        subjectGroups={subjectGroups}
        subjectTypes={subjectTypes}
        editingScore={editingScore}
        onSuccess={handleModalSuccess}
      />

      {/* ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */}
      <Dialog
        open={deleteConfirmOpen}
        onOpenChange={setDeleteConfirmOpen}
        title="ì„±ì  ì‚­ì œ í™•ì¸"
        description="ì •ë§ë¡œ ì´ ì„±ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        variant="destructive"
        maxWidth="sm"
      >
        <div className="flex justify-end gap-3 pt-4">
          <button
            onClick={() => {
              setDeleteConfirmOpen(false);
              setDeletingScoreId(null);
            }}
            disabled={isPending}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            ì·¨ì†Œ
          </button>
          <button
            onClick={handleDeleteConfirm}
            disabled={isPending}
            className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
          </button>
        </div>
      </Dialog>
    </>
  );
}
</file>

<file path="mock/[grade]/[month]/[exam-type]/page.tsx">
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { ScoreTypeTabs } from "../../../../_components/ScoreTypeTabs";
import { getMockScores } from "@/lib/data/studentScores";
import { getSubjectHierarchyOptimized, getActiveCurriculumRevision } from "@/lib/data/subjects";
import { MockScoresView } from "./_components/MockScoresView";
import { getContainerClass } from "@/lib/constants/layout";

type PageProps = {
  params: Promise<{
    grade: string;
    month: string;
    "exam-type": string;
  }>;
  searchParams: Promise<Record<string, string | undefined>>;
};

const validGrades = ["1", "2", "3"];
const validMonths = ["3", "4", "5", "6", "7", "8", "9", "10", "11"];
const validExamTypes = ["í‰ê°€ì›", "êµìœ¡ì²­", "ì‚¬ì„¤"];

export default async function MockScoresPage({
  params,
  searchParams,
}: PageProps) {
  const { grade, month, "exam-type": examTypeRaw } = await params;
  const paramsQuery = await searchParams;
  const examType = decodeURIComponent(examTypeRaw);
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // ìœ íš¨ì„± ê²€ì¦
  if (
    !validGrades.includes(grade) ||
    !validMonths.includes(month) ||
    !validExamTypes.includes(examType)
  ) {
    redirect("/scores/mock/1/3/í‰ê°€ì›");
  }

  // Tenant ì •ë³´ ì¡°íšŒ
  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  // ëª¨ë“  ì„±ì  ë°ì´í„° ì¡°íšŒ (í•„í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬)
  // âœ… getMockScoresëŠ” ì´ë¯¸ student_mock_scores í…Œì´ë¸”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  const scores = await getMockScores(user.id, tenantContext.tenantId);

  // í™œì„±í™”ëœ ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ
  const activeCurriculum = await getActiveCurriculumRevision();
  if (!activeCurriculum) {
    throw new Error("í™œì„±í™”ëœ ê°œì •êµìœ¡ê³¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // êµê³¼/ê³¼ëª©/ê³¼ëª©êµ¬ë¶„ ë°ì´í„° ì¡°íšŒ (ê°œì •êµìœ¡ê³¼ì •ë³„)
  const subjectHierarchy = await getSubjectHierarchyOptimized(activeCurriculum.id);
  const subjectGroupsWithSubjects = subjectHierarchy.subjectGroups;
  const subjectTypes = subjectHierarchy.subjectTypes;

  return (
    <section className={getContainerClass("DASHBOARD", "md")}>
      <div className="flex flex-col gap-6">
        <div className="flex flex-col gap-2">
          <h1 className="text-3xl font-bold text-gray-900">ëª¨ì˜ê³ ì‚¬ ì„±ì </h1>
          <p className="text-sm text-gray-600">
            ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ì…ë ¥í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
          </p>
        </div>

        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
        <div>
          <ScoreTypeTabs />
        </div>
      </div>

      {/* ì„±ì  ì¹´ë“œ ê·¸ë¦¬ë“œ */}
      <MockScoresView
        initialGrade={parseInt(grade)}
        initialExamType={examType}
        initialMonth={month}
        scores={scores}
        subjectGroups={subjectGroupsWithSubjects}
        subjectTypes={subjectTypes}
      />
    </section>
  );
}
</file>

<file path="school/[grade]/[semester]/_components/SchoolScoresTable.tsx">
"use client";

import React, { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { SchoolScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { numericToAlphabetGrade, alphabetToNumericGrade, ALPHABET_GRADES } from "@/lib/scores/gradeScoreUtils";
import { addSchoolScore, updateSchoolScoreAction, deleteSchoolScoreAction } from "@/app/(student)/actions/scoreActions";

type SchoolScoresTableProps = {
  grade: number;
  semester: number;
  initialScores: SchoolScore[];
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
};

type ScoreFormData = {
  id?: string; // ê¸°ì¡´ ì„±ì  ID (ìˆ˜ì • ì‹œ)
  subject_type_id: string; // ê³¼ëª©êµ¬ë¶„ ID (FK)
  subject_group_id: string;
  subject_id: string;
  credit_hours: string;
  raw_score: string;
  subject_average: string;
  standard_deviation: string;
  grade_score: string; // ì•ŒíŒŒë²³ (A~E)
  total_students: string;
  rank_grade: string;
};

// ê¸°ë³¸ êµê³¼ ëª©ë¡ (í•­ìƒ í‘œì‹œ) - 2022 ê°œì • êµìœ¡ê³¼ì • ê¸°ì¤€
const DEFAULT_SUBJECT_GROUP_NAMES = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "í•œêµ­ì‚¬", "ì‚¬íšŒ", "ê³¼í•™"];

export default function SchoolScoresTable({
  grade,
  semester,
  initialScores,
  subjectGroups,
  subjectTypes,
}: SchoolScoresTableProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [selectedRows, setSelectedRows] = useState<Set<number>>(new Set());

  // ëª¨ë“  ì„±ì ì„ ë‹¨ì¼ ë°°ì—´ë¡œ ê´€ë¦¬
  const [scores, setScores] = useState<ScoreFormData[]>(() => {
    const scoreMap = new Map<string, ScoreFormData>();

    // ê¸°ì¡´ ì„±ì  ë°ì´í„°ë¥¼ ë§µì— ì €ì¥ (subject_group:subject_nameì„ í‚¤ë¡œ ì‚¬ìš©)
    initialScores.forEach((score) => {
      // FK ê¸°ë°˜ìœ¼ë¡œ êµê³¼/ê³¼ëª© ì°¾ê¸°
      const group = score.subject_group_id
        ? subjectGroups.find((g) => g.id === score.subject_group_id)
        : subjectGroups.find((g) => g.name === score.subject_group);
      if (!group) return;

      const subject = score.subject_id
        ? group.subjects.find((s) => s.id === score.subject_id)
        : group.subjects.find((s) => s.name === score.subject_name);
      if (!subject) return;

      // ê³¼ëª©êµ¬ë¶„ ID ì°¾ê¸° (FK ìš°ì„ , ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸°)
      let subjectTypeId = score.subject_type_id || "";
      if (!subjectTypeId && score.subject_type) {
        const subjectType = subjectTypes.find((st) => st.name === score.subject_type);
        subjectTypeId = subjectType?.id || "";
      }
      // ê³¼ëª©ì— ê³¼ëª©êµ¬ë¶„ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©
      if (!subjectTypeId && subject.subject_type_id) {
        subjectTypeId = subject.subject_type_id;
      }

      const key = `${group.id}:${subject.id}`;
      scoreMap.set(key, {
        id: score.id,
        subject_type_id: subjectTypeId,
        subject_group_id: group.id,
        subject_id: subject.id,
        credit_hours: score.credit_hours?.toString() || "",
        raw_score: score.raw_score?.toString() || "",
        subject_average: score.subject_average?.toString() || "",
        standard_deviation: score.standard_deviation?.toString() || "",
        grade_score: numericToAlphabetGrade(score.grade_score),
        total_students: score.total_students?.toString() || "",
        rank_grade: score.rank_grade?.toString() || "",
      });
    });

    // ê¸°ë³¸ êµê³¼ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë°°ì—´ ìƒì„±
    const result: ScoreFormData[] = DEFAULT_SUBJECT_GROUP_NAMES.map((groupName) => {
      // í•´ë‹¹ êµê³¼ ê·¸ë£¹ ì°¾ê¸°
      const defaultGroup = subjectGroups.find((g) => g.name === groupName);
      if (!defaultGroup) {
        // êµê³¼ ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ë¹ˆ í–‰
        // êµê³¼ ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ë¹ˆ ê°’
        return {
          subject_type_id: "",
          subject_group_id: "",
          subject_id: "",
          credit_hours: "",
          raw_score: "",
          subject_average: "",
          standard_deviation: "",
          grade_score: "",
          total_students: "",
          rank_grade: "",
        };
      }

      // í•´ë‹¹ êµê³¼ì˜ ëª¨ë“  ê³¼ëª© ì¤‘ ê¸°ì¡´ ì„±ì ì´ ìˆëŠ” ê²ƒ ì°¾ê¸°
      let existingScore: ScoreFormData | undefined;
      for (const subject of defaultGroup.subjects) {
        const key = `${groupName}:${subject.name}`;
        const score = scoreMap.get(key);
        if (score) {
          existingScore = score;
          break;
        }
      }

      if (existingScore) {
        return existingScore;
      }

      // ì²« ë²ˆì§¸ ê³¼ëª©ì˜ ê³¼ëª©êµ¬ë¶„ ID ì‚¬ìš© (ì—†ìœ¼ë©´ ë¹ˆ ê°’)
      const firstSubject = defaultGroup.subjects[0];
      return {
        subject_type_id: firstSubject?.subject_type_id || "",
        subject_group_id: defaultGroup.id,
        subject_id: firstSubject?.id || "",
        credit_hours: "",
        raw_score: "",
        subject_average: "",
        standard_deviation: "",
        grade_score: "",
        total_students: "",
        rank_grade: "",
      };
    });

    // ê¸°ë³¸ êµê³¼ ì™¸ ì¶”ê°€ëœ ì„±ì ë“¤ ì¶”ê°€
    scoreMap.forEach((score, key) => {
      const [groupName] = key.split(":");
      if (!DEFAULT_SUBJECT_GROUP_NAMES.includes(groupName)) {
        result.push(score);
      }
    });

    return result;
  });


  // ì²´í¬ë°•ìŠ¤ í† ê¸€
  const toggleRowSelection = (index: number) => {
    setSelectedRows((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(index)) {
        newSet.delete(index);
      } else {
        newSet.add(index);
      }
      return newSet;
    });
  };

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const toggleAllSelection = () => {
    if (selectedRows.size === scores.length) {
      setSelectedRows(new Set());
    } else {
      setSelectedRows(new Set(scores.map((_, i) => i)));
    }
  };

  // ì„ íƒëœ í–‰ë“¤ ì‚­ì œ
  const handleDeleteSelected = async () => {
    if (selectedRows.size === 0) {
      alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!confirm(`ì„ íƒí•œ ${selectedRows.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }

    const selectedIndices = Array.from(selectedRows).sort((a, b) => b - a);
    const rowsToDelete = selectedIndices
      .map((index) => scores[index])
      .filter((row) => row.id);

    startTransition(async () => {
      try {
        // DBì—ì„œ ì‚­ì œ
        await Promise.all(rowsToDelete.map((row) => deleteSchoolScoreAction(row.id!)));
        // ì„ íƒëœ í–‰ë“¤ì„ ìƒíƒœì—ì„œ ì œê±° (ë’¤ì—ì„œë¶€í„° ì œê±°í•˜ì—¬ ì¸ë±ìŠ¤ ë¬¸ì œ ë°©ì§€)
        setScores((prev) => prev.filter((_, i) => !selectedRows.has(i)));
        setSelectedRows(new Set());
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "ì„±ì  ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  };

  // í•„ë“œ ê°’ ë³€ê²½
  const updateField = (
    index: number,
    field: keyof ScoreFormData,
    value: string
  ) => {
    setScores((prev) =>
      prev.map((row, i) => (i === index ? { ...row, [field]: value } : row))
    );
  };


  // êµê³¼ ì„ íƒ ì‹œ ê³¼ëª© í•„í„°ë§ ë° ê³¼ëª©êµ¬ë¶„ ìë™ ì„¤ì •
  const handleSubjectGroupChange = (index: number, groupId: string) => {
    const group = subjectGroups.find((g) => g.id === groupId);
    if (!group) {
      updateField(index, "subject_group_id", groupId);
      updateField(index, "subject_id", "");
      updateField(index, "subject_type_id", "");
      return;
    }

    // êµê³¼ ì„ íƒ ì‹œ ì²« ë²ˆì§¸ ê³¼ëª© ìë™ ì„ íƒ (ì—†ìœ¼ë©´ ë¹ˆ ê°’)
    const firstSubject = group.subjects[0];
    // ì²« ë²ˆì§¸ ê³¼ëª©ì˜ ê³¼ëª©êµ¬ë¶„ ID ì‚¬ìš© (ì—†ìœ¼ë©´ ë¹ˆ ê°’)
    const autoSubjectTypeId = firstSubject?.subject_type_id || "";

    setScores((prev) =>
      prev.map((row, i) =>
        i === index
          ? {
              ...row,
              subject_group_id: group.id,
              subject_id: firstSubject?.id || "",
              subject_type_id: autoSubjectTypeId,
            }
          : row
      )
    );
  };

  // ê³¼ëª© ì„ íƒ ì‹œ êµê³¼ ê·¸ë£¹ ìë™ ì„¤ì • ë° ê³¼ëª©êµ¬ë¶„ ìë™ ì„¤ì •
  const handleSubjectChange = (index: number, subjectId: string) => {
    const group = subjectGroups.find((g) =>
      g.subjects.some((s) => s.id === subjectId)
    );
    if (group) {
      const subject = group.subjects.find((s) => s.id === subjectId);
      // ê³¼ëª©ì˜ ê³¼ëª©êµ¬ë¶„ ID ì‚¬ìš© (ì—†ìœ¼ë©´ ë¹ˆ ê°’)
      const autoSubjectTypeId = subject?.subject_type_id || "";

      setScores((prev) =>
        prev.map((row, i) =>
          i === index
            ? {
                ...row,
                subject_id: subjectId,
                subject_group_id: group.id,
                subject_type_id: autoSubjectTypeId,
              }
            : row
        )
      );
    } else {
      updateField(index, "subject_id", subjectId);
    }
  };

  // ì„ íƒëœ êµê³¼ ê·¸ë£¹ì˜ ê³¼ëª© ëª©ë¡ë§Œ ë°˜í™˜
  const getSubjectsByGroupId = (groupId: string): Subject[] => {
    if (!groupId) return [];
    const group = subjectGroups.find((g) => g.id === groupId);
    return group?.subjects || [];
  };

  // ë¹ˆ í–‰ ì¶”ê°€
  const handleAddRow = () => {
    setScores((prev) => [
      ...prev,
      {
        subject_type_id: "",
        subject_group_id: "",
        subject_id: "",
        credit_hours: "",
        raw_score: "",
        subject_average: "",
        standard_deviation: "",
        grade_score: "",
        total_students: "",
        rank_grade: "",
      },
    ]);
  };

  // í•„ìˆ˜ í•„ë“œ ê²€ì¦
  const validateRow = (row: ScoreFormData): string[] => {
    const missingFields: string[] = [];
    if (!row.subject_group_id) missingFields.push("êµê³¼");
    if (!row.subject_id) missingFields.push("ê³¼ëª©");
    if (!row.subject_type_id) missingFields.push("ê³¼ëª©êµ¬ë¶„");
    if (!row.credit_hours) missingFields.push("í•™ì ìˆ˜");
    if (!row.raw_score) missingFields.push("ì›ì ìˆ˜");
    if (!row.grade_score) missingFields.push("ì„±ì·¨ë„");
    return missingFields;
  };

  // ì „ì²´ ì €ì¥
  const handleSaveAll = async () => {
    const rowsToSave = scores.filter((row) => {
      // í•„ìˆ˜ í•„ë“œê°€ ëª¨ë‘ ì±„ì›Œì§„ í–‰ë§Œ ì €ì¥
      return (
        row.subject_group_id &&
        row.subject_id &&
        row.subject_type_id &&
        row.credit_hours &&
        row.raw_score &&
        row.grade_score
      );
    });

    if (rowsToSave.length === 0) {
      // ì–´ë–¤ í•„ë“œê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
      const incompleteRows: Array<{ index: number; missingFields: string[] }> = [];
      scores.forEach((row, index) => {
        const missingFields = validateRow(row);
        if (missingFields.length > 0 && (row.subject_group_id || row.subject_id || row.raw_score)) {
          incompleteRows.push({ index: index + 1, missingFields });
        }
      });

      if (incompleteRows.length > 0) {
        const message = `ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.\n\në¹„ì–´ìˆëŠ” í•„ìˆ˜ í•„ë“œ:\n${incompleteRows
          .slice(0, 3)
          .map((r) => `  ${r.index}í–‰: ${r.missingFields.join(", ")}`)
          .join("\n")}${incompleteRows.length > 3 ? `\n  ... ì™¸ ${incompleteRows.length - 3}ê°œ í–‰` : ""}`;
        alert(message);
      } else {
        alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í•„ìˆ˜ í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\ní•„ìˆ˜ í•„ë“œ: êµê³¼, ê³¼ëª©, ê³¼ëª© ìœ í˜•, í•™ì ìˆ˜, ì›ì ìˆ˜, ì„±ì·¨ë„");
      }
      return;
    }

    startTransition(async () => {
      try {
        const savePromises = rowsToSave.map((row) => {
          const group = subjectGroups.find((g) => g.id === row.subject_group_id);
          const subject = group?.subjects.find((s) => s.id === row.subject_id);

          if (!group || !subject) {
            return Promise.resolve();
          }

          const formData = new FormData();
          formData.append("grade", grade.toString());
          formData.append("semester", semester.toString());
          // FK í•„ë“œ ì „ë‹¬
          formData.append("subject_group_id", group.id);
          formData.append("subject_id", subject.id);
          if (row.subject_type_id) formData.append("subject_type_id", row.subject_type_id);
          // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ í…ìŠ¤íŠ¸ í•„ë“œë„ í•¨ê»˜ ì „ë‹¬
          formData.append("subject_group", group.name);
          const subjectType = subjectTypes.find((st) => st.id === row.subject_type_id);
          if (subjectType) formData.append("subject_type", subjectType.name);
          formData.append("subject_name", subject.name);
          formData.append("credit_hours", row.credit_hours);
          formData.append("raw_score", row.raw_score);
          if (row.subject_average) formData.append("subject_average", row.subject_average);
          if (row.standard_deviation)
            formData.append("standard_deviation", row.standard_deviation);
          formData.append("grade_score", alphabetToNumericGrade(row.grade_score).toString());
          if (row.total_students) formData.append("total_students", row.total_students);
          if (row.rank_grade) formData.append("rank_grade", row.rank_grade);

          if (row.id) {
            return updateSchoolScoreAction(row.id, formData);
          } else {
            return addSchoolScore(formData);
          }
        });

        await Promise.all(savePromises);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "ì„±ì  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  };

  return (
    <div className="flex flex-col gap-4">
      {/* ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ */}
      <div className="flex items-center justify-between">
        <div className="flex gap-2">
          <button
            type="button"
            onClick={handleAddRow}
            disabled={isPending}
            className="rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-green-700 disabled:opacity-50"
          >
            + ê³¼ëª© ì¶”ê°€
          </button>
          <button
            type="button"
            onClick={handleSaveAll}
            disabled={isPending}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
          >
            ì „ì²´ ì €ì¥
          </button>
          {selectedRows.size > 0 && (
            <>
              <button
                type="button"
                onClick={handleDeleteSelected}
                disabled={isPending}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
              >
                ì„ íƒ ì‚­ì œ ({selectedRows.size})
              </button>
              <button
                type="button"
                onClick={() => setSelectedRows(new Set())}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                ì„ íƒ ì·¨ì†Œ
              </button>
            </>
          )}
        </div>
      </div>

      <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr className="border-b border-gray-200">
              <th className="w-12 px-2 py-3 text-center text-sm font-semibold text-gray-700">
                <input
                  type="checkbox"
                  checked={selectedRows.size === scores.length && scores.length > 0}
                  onChange={toggleAllSelection}
                  className="h-4 w-4 cursor-pointer rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                />
              </th>
              <th className="w-24 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ê³¼ëª© ìœ í˜• <span className="text-red-500">*</span>
              </th>
              <th className="w-24 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                êµê³¼ <span className="text-red-500">*</span>
              </th>
              <th className="w-28 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ê³¼ëª© <span className="text-red-500">*</span>
              </th>
              <th className="w-20 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                í•™ì ìˆ˜ <span className="text-red-500">*</span>
              </th>
              <th className="w-20 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ì›ì ìˆ˜ <span className="text-red-500">*</span>
              </th>
              <th className="w-22 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ê³¼ëª©í‰ê· 
              </th>
              <th className="w-22 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                í‘œì¤€í¸ì°¨
              </th>
              <th className="w-20 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ì„±ì·¨ë„ <span className="text-red-500">*</span>
              </th>
              <th className="w-20 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ìˆ˜ê°•ììˆ˜
              </th>
              <th className="w-22 px-3 py-3 text-left text-sm font-semibold text-gray-700">
                ì„ì°¨ë“±ê¸‰
              </th>
            </tr>
          </thead>
          <tbody>
            {scores.map((row, index) => {
              const subjectsInGroup = getSubjectsByGroupId(row.subject_group_id);
              const missingFields = validateRow(row);
              const hasIncompleteRequiredFields = missingFields.length > 0 && (row.subject_group_id || row.subject_id || row.raw_score);
              
              return (
                <tr
                  key={index}
                  className={`border-b border-gray-100 transition hover:bg-gray-50 ${
                    hasIncompleteRequiredFields ? "bg-red-50/30" : ""
                  }`}
                >
                  <td className="px-2 py-3 text-center">
                    <input
                      type="checkbox"
                      checked={selectedRows.has(index)}
                      onChange={() => toggleRowSelection(index)}
                      className="h-4 w-4 cursor-pointer rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <select
                      value={row.subject_type_id}
                      onChange={(e) =>
                        updateField(index, "subject_type_id", e.target.value)
                      }
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.subject_type_id && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                    >
                      <option value="">ì„ íƒ</option>
                      {subjectTypes.map((subjectType) => (
                        <option key={subjectType.id} value={subjectType.id}>
                          {subjectType.name}
                        </option>
                      ))}
                    </select>
                  </td>
                  <td className="px-3 py-3">
                    <select
                      value={row.subject_group_id}
                      onChange={(e) => handleSubjectGroupChange(index, e.target.value)}
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.subject_group_id && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                    >
                      <option value="">ì„ íƒ</option>
                      {subjectGroups.map((group) => (
                        <option key={group.id} value={group.id}>
                          {group.name}
                        </option>
                      ))}
                    </select>
                  </td>
                  <td className="px-3 py-3">
                    <select
                      value={row.subject_id}
                      onChange={(e) => handleSubjectChange(index, e.target.value)}
                      disabled={!row.subject_group_id}
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 disabled:bg-gray-100 disabled:cursor-not-allowed ${
                        !row.subject_id && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                    >
                      <option value="">ì„ íƒ</option>
                      {subjectsInGroup.map((subject) => (
                        <option key={subject.id} value={subject.id}>
                          {subject.name}
                        </option>
                      ))}
                    </select>
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      step="0.5"
                      min="0.5"
                      value={row.credit_hours}
                      onChange={(e) =>
                        updateField(index, "credit_hours", e.target.value)
                      }
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.credit_hours && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                      placeholder="4"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      step="0.1"
                      min="0"
                      value={row.raw_score}
                      onChange={(e) =>
                        updateField(index, "raw_score", e.target.value)
                      }
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.raw_score && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                      placeholder="85.5"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      step="0.1"
                      value={row.subject_average}
                      onChange={(e) =>
                        updateField(index, "subject_average", e.target.value)
                      }
                      className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500"
                      placeholder="78.5"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      step="0.1"
                      min="0"
                      value={row.standard_deviation}
                      onChange={(e) =>
                        updateField(index, "standard_deviation", e.target.value)
                      }
                      className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500"
                      placeholder="12.5"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <select
                      value={row.grade_score}
                      onChange={(e) =>
                        updateField(index, "grade_score", e.target.value)
                      }
                      className={`w-full rounded-lg border px-2 py-1.5 text-xs focus:outline-none focus:ring-1 ${
                        !row.grade_score && hasIncompleteRequiredFields
                          ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                          : "border-gray-300 focus:ring-indigo-500"
                      }`}
                    >
                      <option value="">ì„ íƒ</option>
                      {ALPHABET_GRADES.map((grade) => (
                        <option key={grade} value={grade}>
                          {grade}
                        </option>
                      ))}
                    </select>
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      min="1"
                      value={row.total_students}
                      onChange={(e) =>
                        updateField(index, "total_students", e.target.value)
                      }
                      className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500"
                      placeholder="120"
                    />
                  </td>
                  <td className="px-3 py-3">
                    <input
                      type="number"
                      min="1"
                      max="9"
                      value={row.rank_grade}
                      onChange={(e) =>
                        updateField(index, "rank_grade", e.target.value)
                      }
                      className="w-full rounded-lg border border-gray-300 px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500"
                      placeholder="1~9"
                    />
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="school/[grade]/[semester]/_components/SchoolScoresView.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { SchoolScore } from "@/lib/data/studentScores";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { ScoreCardGrid } from "@/app/(student)/scores/_components/ScoreCardGrid";
import { ScoreFormModal } from "@/app/(student)/scores/_components/ScoreFormModal";
import { Dialog } from "@/components/ui/Dialog";
import { deleteSchoolScoreAction } from "@/app/(student)/actions/scoreActions";
import { useToast } from "@/components/ui/ToastProvider";

type SchoolScoresViewProps = {
  initialGrade?: number;
  initialSemester?: number;
  scores: SchoolScore[];
  subjectGroups: (SubjectGroup & { subjects: Subject[] })[];
  subjectTypes: SubjectType[];
};

export function SchoolScoresView({
  initialGrade,
  initialSemester,
  scores,
  subjectGroups,
  subjectTypes,
}: SchoolScoresViewProps) {
  const router = useRouter();
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingScore, setEditingScore] = useState<SchoolScore | null>(null);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [deletingScoreId, setDeletingScoreId] = useState<string | null>(null);

  const handleAddClick = () => {
    setEditingScore(null);
    setIsModalOpen(true);
  };

  const handleEdit = (score: SchoolScore) => {
    setEditingScore(score);
    setIsModalOpen(true);
  };

  const handleDelete = (scoreId: string) => {
    setDeletingScoreId(scoreId);
    setDeleteConfirmOpen(true);
  };

  const handleDeleteConfirm = async () => {
    if (!deletingScoreId) return;

    startTransition(async () => {
      try {
        await deleteSchoolScoreAction(deletingScoreId, {
          skipRedirect: true,
          grade: initialGrade,
          semester: initialSemester,
        });
        showSuccess("ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        setDeleteConfirmOpen(false);
        setDeletingScoreId(null);
        router.refresh();
      } catch (err) {
        const errorMessage = err instanceof Error ? err.message : "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        showError(errorMessage);
      }
    });
  };

  const handleModalSuccess = () => {
    setIsModalOpen(false);
    setEditingScore(null);
  };

  return (
    <>
      <ScoreCardGrid
        initialGrade={initialGrade}
        initialSemester={initialSemester}
        scores={scores}
        subjectGroups={subjectGroups}
        subjectTypes={subjectTypes}
        onAddClick={handleAddClick}
        onEdit={handleEdit}
        onDelete={handleDelete}
      />

      {/* ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ */}
      <ScoreFormModal
        open={isModalOpen}
        onOpenChange={setIsModalOpen}
        initialGrade={initialGrade}
        initialSemester={initialSemester}
        subjectGroups={subjectGroups}
        subjectTypes={subjectTypes}
        editingScore={editingScore}
        onSuccess={handleModalSuccess}
      />

      {/* ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */}
      <Dialog
        open={deleteConfirmOpen}
        onOpenChange={setDeleteConfirmOpen}
        title="ì„±ì  ì‚­ì œ í™•ì¸"
        description="ì •ë§ë¡œ ì´ ì„±ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        variant="destructive"
        maxWidth="sm"
      >
        <div className="flex justify-end gap-3 pt-4">
          <button
            onClick={() => {
              setDeleteConfirmOpen(false);
              setDeletingScoreId(null);
            }}
            disabled={isPending}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            ì·¨ì†Œ
          </button>
          <button
            onClick={handleDeleteConfirm}
            disabled={isPending}
            className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
          </button>
        </div>
      </Dialog>
    </>
  );
}
</file>

<file path="school/[grade]/[semester]/[subject-group]/_components/DeleteSchoolScoreButton.tsx">
"use client";

import { useTransition, useState } from "react";
import { useRouter } from "next/navigation";
import { deleteSchoolScore } from "@/app/actions/scores/school";

type DeleteSchoolScoreButtonProps = {
  id: string;
};

export function DeleteSchoolScoreButton({ id }: DeleteSchoolScoreButtonProps) {
  const [isPending, startTransition] = useTransition();
  const [showConfirm, setShowConfirm] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  const handleDelete = async () => {
    setError(null);
    startTransition(async () => {
      try {
        await deleteSchoolScore(id);
        router.refresh();
      } catch (err) {
        setError(err instanceof Error ? err.message : "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      } finally {
        setShowConfirm(false);
      }
    });
  };

  return (
    <>
      <button
        onClick={() => setShowConfirm(true)}
        disabled={isPending}
        className="inline-flex items-center justify-center rounded-lg border border-red-300 bg-white px-3 py-1.5 text-xs font-semibold text-red-700 transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"
      >
        ì‚­ì œ
      </button>

      {showConfirm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 px-4">
          <div className="flex flex-col gap-6 rounded-lg bg-white p-6 shadow-xl max-w-md w-full">
            <div className="flex flex-col gap-2">
              <h3 className="text-lg font-semibold text-gray-900">ì„±ì  ì‚­ì œ í™•ì¸</h3>
              <p className="text-sm text-gray-600">
                ì •ë§ë¡œ ì´ ì„±ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </p>
            </div>
            {error && (
              <p className="rounded-md bg-red-50 p-3 text-sm text-red-600">
                {error}
              </p>
            )}
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setShowConfirm(false)}
                disabled={isPending}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleDelete}
                disabled={isPending}
                className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
              >
                {isPending ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
</file>

<file path="school/[grade]/[semester]/[subject-group]/[id]/edit/_components/SchoolScoreEditForm.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * ìƒˆ ìŠ¤í‚¤ë§ˆ(student_internal_scores)ì— ë§ì¶° ì¬êµ¬ì¶•ì´ í•„ìš”í•©ë‹ˆë‹¤.
 */
"use client";

import React, { useTransition } from "react";
import { useRouter } from "next/navigation";
import { updateSchoolScore } from "@/app/actions/scores/school";

type SchoolScoreRow = {
  id: string;
  grade: number;
  semester: number;
  subject_group: string;
  subject_type: string | null;
  subject_name: string | null;
  raw_score: number | null;
  grade_score: number | null;
  class_rank: number | null;
};

type SchoolScoreEditFormProps = {
  id: string;
  grade: string;
  semester: string;
  subjectGroup: string;
  defaultValue: SchoolScoreRow;
};

export function SchoolScoreEditForm({
  id,
  grade,
  semester,
  subjectGroup,
  defaultValue,
}: SchoolScoreEditFormProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = React.useState<string | null>(null);

  const handleSubmit = async (formData: FormData) => {
    setError(null);
    startTransition(async () => {
      try {
        await updateSchoolScore(id, formData);
      } catch (err) {
        setError(err instanceof Error ? err.message : "ì„±ì  ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  };

  // ë‚ ì§œ í¬ë§·íŒ… (YYYY-MM-DD)
  const formatDate = (dateString: string | null) => {
    if (!dateString) return "";
    const date = new Date(dateString);
    return date.toISOString().split("T")[0];
  };

  return (
    <form action={handleSubmit} className="flex flex-col gap-6">
      {/* Hidden fields */}
      <input type="hidden" name="grade" value={grade} />
      <input type="hidden" name="semester" value={semester} />
      <input type="hidden" name="subject_group" value={subjectGroup} />

      {error && (
        <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
          {error}
        </div>
      )}

      <div className="grid gap-6 sm:grid-cols-2">
        <div className="flex flex-col gap-2">
          <label
            htmlFor="subject_type"
            className="block text-sm font-medium text-gray-700"
          >
            ê³¼ëª© ìœ í˜• <span className="text-red-500">*</span>
          </label>
          <select
            id="subject_type"
            name="subject_type"
            required
            defaultValue={defaultValue.subject_type || ""}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ê³µí†µ">ê³µí†µ</option>
            <option value="ì¼ë°˜ì„ íƒ">ì¼ë°˜ì„ íƒ</option>
            <option value="ì§„ë¡œì„ íƒ">ì§„ë¡œì„ íƒ</option>
          </select>
        </div>

        <div className="flex flex-col gap-2">
          <label
            htmlFor="subject_name"
            className="block text-sm font-medium text-gray-700"
          >
            ì„¸ë¶€ ê³¼ëª©ëª… <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="subject_name"
            name="subject_name"
            required
            defaultValue={defaultValue.subject_name || ""}
            placeholder="ì˜ˆ: ìˆ˜í•™â… "
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        <div className="flex flex-col gap-2">
          <label
            htmlFor="raw_score"
            className="block text-sm font-medium text-gray-700"
          >
            ì›ì ìˆ˜
          </label>
          <input
            type="number"
            id="raw_score"
            name="raw_score"
            step="0.1"
            defaultValue={defaultValue.raw_score ?? ""}
            placeholder="ì˜ˆ: 85.5"
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        <div className="flex flex-col gap-2">
          <label
            htmlFor="grade_score"
            className="block text-sm font-medium text-gray-700"
          >
            ì„±ì·¨ë„ ë“±ê¸‰ <span className="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="grade_score"
            name="grade_score"
            required
            min="1"
            max="9"
            defaultValue={defaultValue.grade_score ?? ""}
            placeholder="1~9"
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        <div className="flex flex-col gap-2">
          <label
            htmlFor="class_rank"
            className="block text-sm font-medium text-gray-700"
          >
            ë°˜ ì„ì°¨
          </label>
          <input
            type="number"
            id="class_rank"
            name="class_rank"
            min="1"
            defaultValue={defaultValue.class_rank ?? ""}
            placeholder="ì˜ˆ: 5"
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

      </div>

      <div className="flex gap-3 pt-4">
        <button
          type="submit"
          disabled={isPending}
          className="flex-1 rounded-lg bg-indigo-600 px-6 py-3 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isPending ? "ìˆ˜ì • ì¤‘..." : "ìˆ˜ì •í•˜ê¸°"}
        </button>
        <button
          type="button"
          onClick={() => router.back()}
          disabled={isPending}
          className="rounded-lg border border-gray-300 bg-white px-6 py-3 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
        >
          ì·¨ì†Œ
        </button>
      </div>
    </form>
  );
}
</file>

<file path="school/[grade]/[semester]/[subject-group]/[id]/edit/page.tsx">
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { SchoolScoreEditForm } from "./_components/SchoolScoreEditForm";

type PageProps = {
  params: Promise<{
    grade: string;
    semester: string;
    "subject-group": string;
    id: string;
  }>;
};

const validGrades = ["1", "2", "3"];
const validSemesters = ["1", "2"];
const validSubjects = ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ì‚¬íšŒ", "ê³¼í•™"];

type SchoolScoreRow = {
  id: string;
  grade: number;
  semester: number;
  subject_group: string;
  subject_type: string | null;
  subject_name: string | null;
  raw_score: number | null;
  grade_score: number | null;
  class_rank: number | null;
  test_date: string | null;
};

export default async function EditSchoolScorePage({ params }: PageProps) {
  const { grade, semester, "subject-group": subjectGroupRaw, id } = await params;
  const subjectGroup = decodeURIComponent(subjectGroupRaw);
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // ìœ íš¨ì„± ê²€ì¦
  if (
    !validGrades.includes(grade) ||
    !validSemesters.includes(semester) ||
    !validSubjects.includes(subjectGroup)
  ) {
    redirect("/scores/school/1/1/êµ­ì–´");
  }

  // ë°ì´í„° ì¡°íšŒ
  const selectScore = () =>
    supabase
      .from("student_school_scores")
      .select("*")
      .eq("id", id);

  let { data: score, error } = await selectScore().eq("student_id", user.id);
  if (error && error.code === "42703") {
    ({ data: score, error } = await selectScore());
  }

  if (error || !score) {
    redirect(`/scores/school/${grade}/${semester}/${encodeURIComponent(subjectGroup)}`);
  }

  const scoreData = (score as SchoolScoreRow[] | null)?.[0];
  if (!scoreData) {
    redirect(`/scores/school/${grade}/${semester}/${encodeURIComponent(subjectGroup)}`);
  }

  return (
    <section className="mx-auto max-w-2xl px-4 py-10 flex flex-col gap-8">
      <div className="flex items-center justify-between">
        <div className="flex flex-col gap-2">
          <h1 className="text-3xl font-semibold text-gray-900">ë‚´ì‹  ì„±ì  ìˆ˜ì •</h1>
          <p className="text-sm text-gray-500">
            {grade}í•™ë…„ {semester}í•™ê¸° {subjectGroup} ë‚´ì‹  ì„±ì ì„ ìˆ˜ì •í•˜ì„¸ìš”.
          </p>
        </div>
        <Link
          href={`/scores/school/${grade}/${semester}/${encodeURIComponent(subjectGroup)}`}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          ëª©ë¡ìœ¼ë¡œ
        </Link>
      </div>

      <div className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <SchoolScoreEditForm
          id={id}
          grade={grade}
          semester={semester}
          subjectGroup={subjectGroup}
          defaultValue={scoreData}
        />
      </div>
    </section>
  );
}
</file>

<file path="school/[grade]/[semester]/[subject-group]/new/_components/SchoolScoreForm.tsx">
/**
 * @deprecated ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë ˆê±°ì‹œ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * ìƒˆ ìŠ¤í‚¤ë§ˆ(student_internal_scores)ì— ë§ì¶° ì¬êµ¬ì¶•ì´ í•„ìš”í•©ë‹ˆë‹¤.
 * 
 * í–¥í›„ ê°œì„  ì‚¬í•­:
 * - subject_id, subject_group_id, subject_type_id FK í•„ë“œ ì‚¬ìš©
 * - createInternalScore (app/actions/scores-internal.ts) ì‚¬ìš©
 * - term_id ìë™ ìƒì„± ë¡œì§ ì¶”ê°€
 */
"use client";

import React, { useTransition } from "react";
import { useRouter } from "next/navigation";
import { addSchoolScore } from "@/app/(student)/actions/scoreActions";
import { Card } from "@/components/molecules/Card";

type SchoolScoreFormProps = {
  grade: string;
  semester: string;
  subjectGroup: string;
};

type FormErrors = {
  subject_type?: string;
  subject_name?: string;
  credit_hours?: string;
  raw_score?: string;
  subject_average?: string;
  standard_deviation?: string;
  grade_score?: string;
  total_students?: string;
  rank_grade?: string;
  class_rank?: string;
};

export default function SchoolScoreForm({
  grade,
  semester,
  subjectGroup,
}: SchoolScoreFormProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = React.useState<string | null>(null);
  const [errors, setErrors] = React.useState<FormErrors>({});
  const [touched, setTouched] = React.useState<Record<string, boolean>>({});

  const validateField = (name: string, value: string | number | null): string | undefined => {
    switch (name) {
      case "subject_type":
        if (!value || value === "") {
          return "ê³¼ëª© ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        }
        break;
      case "subject_name":
        if (!value || (typeof value === "string" && value.trim() === "")) {
          return "ì„¸ë¶€ ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        break;
      case "credit_hours":
        if (value === null || value === undefined || value === "") {
          return "í•™ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const creditNum = Number(value);
        if (isNaN(creditNum) || creditNum <= 0) {
          return "í•™ì ìˆ˜ëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "raw_score":
        if (value === null || value === undefined || value === "") {
          return "ì›ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const rawNum = Number(value);
        if (isNaN(rawNum) || rawNum < 0) {
          return "ì›ì ìˆ˜ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "subject_average":
        if (value !== null && value !== undefined && value !== "") {
          const avgNum = Number(value);
          if (isNaN(avgNum)) {
            return "ê³¼ëª©í‰ê· ì€ ì˜¬ë°”ë¥¸ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
      case "standard_deviation":
        if (value !== null && value !== undefined && value !== "") {
          const stdNum = Number(value);
          if (isNaN(stdNum)) {
            return "í‘œì¤€í¸ì°¨ëŠ” ì˜¬ë°”ë¥¸ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
      case "grade_score":
        if (value === null || value === undefined || value === "") {
          return "ì„±ì·¨ë„ ë“±ê¸‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        }
        const gradeNum = Number(value);
        if (isNaN(gradeNum) || gradeNum < 1 || gradeNum > 9) {
          return "ë“±ê¸‰ì€ 1~9 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
        }
        break;
      case "total_students":
        if (value !== null && value !== undefined && value !== "") {
          const totalNum = Number(value);
          if (isNaN(totalNum) || totalNum <= 0) {
            return "ìˆ˜ê°•ììˆ˜ëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
      case "rank_grade":
        if (value !== null && value !== undefined && value !== "") {
          const rankGradeNum = Number(value);
          if (isNaN(rankGradeNum) || rankGradeNum < 1 || rankGradeNum > 9) {
            return "ì„ì°¨ë“±ê¸‰ì€ 1~9 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
      case "class_rank":
        if (value !== null && value !== undefined && value !== "") {
          const rankNum = Number(value);
          if (isNaN(rankNum) || rankNum < 1) {
            return "ë°˜ ì„ì°¨ëŠ” 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.";
          }
        }
        break;
    }
    return undefined;
  };

  const handleBlur = (e: React.FocusEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setTouched((prev) => ({ ...prev, [name]: true }));
    const error = validateField(name, value);
    setErrors((prev) => ({ ...prev, [name]: error }));
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    if (touched[name]) {
      const error = validateField(name, value);
      setErrors((prev) => ({ ...prev, [name]: error }));
    }
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError(null);
    setErrors({});

    const formData = new FormData(e.currentTarget);
    const formErrors: FormErrors = {};

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const requiredFields = ["subject_type", "subject_name", "credit_hours", "raw_score", "grade_score"];
    requiredFields.forEach((field) => {
      const value = formData.get(field);
      const error = validateField(field, value as string);
      if (error) {
        formErrors[field as keyof FormErrors] = error;
        setTouched((prev) => ({ ...prev, [field]: true }));
      }
    });

    // ì„ íƒì  í•„ë“œ ê²€ì¦
    const optionalFields = ["subject_average", "standard_deviation", "total_students", "rank_grade", "class_rank"];
    optionalFields.forEach((field) => {
      const value = formData.get(field);
      if (value) {
        const error = validateField(field, value as string);
        if (error) {
          formErrors[field as keyof FormErrors] = error;
          setTouched((prev) => ({ ...prev, [field]: true }));
        }
      }
    });

    if (Object.keys(formErrors).length > 0) {
      setErrors(formErrors);
      return;
    }

    startTransition(async () => {
      try {
        await addSchoolScore(formData);
      } catch (err) {
        setError(err instanceof Error ? err.message : "ì„±ì  ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    });
  };

  return (
    <Card>
      <form onSubmit={handleSubmit} className="flex flex-col gap-6">
        {/* Hidden fields */}
        <input type="hidden" name="grade" value={grade} />
        <input type="hidden" name="semester" value={semester} />
        <input type="hidden" name="subject_group" value={subjectGroup} />

        {error && (
          <div className="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {error}
          </div>
        )}

        <div className="grid gap-6 sm:grid-cols-2">
          {/* ê³¼ëª© ìœ í˜• */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_type"
              className="block text-sm font-medium text-gray-700"
            >
              ê³¼ëª© ìœ í˜• <span className="text-red-500">*</span>
            </label>
            <select
              id="subject_type"
              name="subject_type"
              onBlur={handleBlur}
              onChange={handleChange}
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.subject_type
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="ê³µí†µ">ê³µí†µ</option>
              <option value="ì¼ë°˜ì„ íƒ">ì¼ë°˜ì„ íƒ</option>
              <option value="ì§„ë¡œì„ íƒ">ì§„ë¡œì„ íƒ</option>
            </select>
            {errors.subject_type && touched.subject_type && (
              <p className="text-xs text-red-600">{errors.subject_type}</p>
            )}
          </div>

          {/* ì„¸ë¶€ ê³¼ëª©ëª… */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_name"
              className="block text-sm font-medium text-gray-700"
            >
              ì„¸ë¶€ ê³¼ëª©ëª… <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="subject_name"
              name="subject_name"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: ìˆ˜í•™â… "
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.subject_name
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.subject_name && touched.subject_name && (
              <p className="text-xs text-red-600">{errors.subject_name}</p>
            )}
          </div>

          {/* í•™ì ìˆ˜ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="credit_hours"
              className="block text-sm font-medium text-gray-700"
            >
              í•™ì ìˆ˜ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="credit_hours"
              name="credit_hours"
              step="0.5"
              min="0.5"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 4"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.credit_hours
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.credit_hours && touched.credit_hours && (
              <p className="text-xs text-red-600">{errors.credit_hours}</p>
            )}
          </div>

          {/* ì›ì ìˆ˜ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="raw_score"
              className="block text-sm font-medium text-gray-700"
            >
              ì›ì ìˆ˜ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="raw_score"
              name="raw_score"
              step="0.1"
              min="0"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 85.5"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.raw_score
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.raw_score && touched.raw_score && (
              <p className="text-xs text-red-600">{errors.raw_score}</p>
            )}
          </div>

          {/* ê³¼ëª©í‰ê·  */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="subject_average"
              className="block text-sm font-medium text-gray-700"
            >
              ê³¼ëª©í‰ê· 
            </label>
            <input
              type="number"
              id="subject_average"
              name="subject_average"
              step="0.1"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 78.5"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.subject_average
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.subject_average && touched.subject_average && (
              <p className="text-xs text-red-600">{errors.subject_average}</p>
            )}
          </div>

          {/* í‘œì¤€í¸ì°¨ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="standard_deviation"
              className="block text-sm font-medium text-gray-700"
            >
              í‘œì¤€í¸ì°¨
            </label>
            <input
              type="number"
              id="standard_deviation"
              name="standard_deviation"
              step="0.1"
              min="0"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 12.5"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.standard_deviation
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.standard_deviation && touched.standard_deviation && (
              <p className="text-xs text-red-600">{errors.standard_deviation}</p>
            )}
          </div>

          {/* ì„±ì·¨ë„ ë“±ê¸‰ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="grade_score"
              className="block text-sm font-medium text-gray-700"
            >
              ì„±ì·¨ë„ ë“±ê¸‰ <span className="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="grade_score"
              name="grade_score"
              min="1"
              max="9"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="1~9"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.grade_score
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.grade_score && touched.grade_score && (
              <p className="text-xs text-red-600">{errors.grade_score}</p>
            )}
            <p className="text-xs text-gray-500">1ë“±ê¸‰ì´ ê°€ì¥ ë†’ê³ , 9ë“±ê¸‰ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.</p>
          </div>

          {/* ìˆ˜ê°•ììˆ˜ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="total_students"
              className="block text-sm font-medium text-gray-700"
            >
              ìˆ˜ê°•ììˆ˜
            </label>
            <input
              type="number"
              id="total_students"
              name="total_students"
              min="1"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 120"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.total_students
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.total_students && touched.total_students && (
              <p className="text-xs text-red-600">{errors.total_students}</p>
            )}
          </div>

          {/* ì„ì°¨ë“±ê¸‰ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="rank_grade"
              className="block text-sm font-medium text-gray-700"
            >
              ì„ì°¨ë“±ê¸‰
            </label>
            <input
              type="number"
              id="rank_grade"
              name="rank_grade"
              min="1"
              max="9"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="1~9"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.rank_grade
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.rank_grade && touched.rank_grade && (
              <p className="text-xs text-red-600">{errors.rank_grade}</p>
            )}
          </div>

          {/* ë°˜ ì„ì°¨ */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="class_rank"
              className="block text-sm font-medium text-gray-700"
            >
              ë°˜ ì„ì°¨
            </label>
            <input
              type="number"
              id="class_rank"
              name="class_rank"
              min="1"
              onBlur={handleBlur}
              onChange={handleChange}
              placeholder="ì˜ˆ: 5"
              className={`w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 ${
                errors.class_rank
                  ? "border-red-300 focus:border-red-500 focus:ring-red-500"
                  : "border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
              }`}
            />
            {errors.class_rank && touched.class_rank && (
              <p className="text-xs text-red-600">{errors.class_rank}</p>
            )}
          </div>

        </div>

        <div className="flex gap-3 pt-2">
          <button
            type="submit"
            disabled={isPending}
            className="flex-1 rounded-lg bg-indigo-600 px-6 py-3 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isPending ? "ë“±ë¡ ì¤‘..." : "ë“±ë¡í•˜ê¸°"}
          </button>
          <button
            type="button"
            onClick={() => router.back()}
            disabled={isPending}
            className="rounded-lg border border-gray-300 bg-white px-6 py-3 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            ì·¨ì†Œ
          </button>
        </div>
      </form>
    </Card>
  );
}
</file>

<file path="school/[grade]/[semester]/page.tsx">
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { ScoreTypeTabs } from "../../../_components/ScoreTypeTabs";
import { getSchoolScores } from "@/lib/data/studentScores";
import { getSubjectHierarchyOptimized, getActiveCurriculumRevision } from "@/lib/data/subjects";
import { SchoolScoresView } from "./_components/SchoolScoresView";
import { getContainerClass } from "@/lib/constants/layout";

type PageProps = {
  params: Promise<{
    grade: string;
    semester: string;
  }>;
  searchParams: Promise<Record<string, string | undefined>>;
};

const validGrades = ["1", "2", "3"];
const validSemesters = ["1", "2"];

export default async function SchoolScoresPage({
  params,
  searchParams,
}: PageProps) {
  const { grade, semester } = await params;
  const paramsQuery = await searchParams;
  const supabase = await createSupabaseServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) redirect("/login");

  // ìœ íš¨ì„± ê²€ì¦
  if (!validGrades.includes(grade) || !validSemesters.includes(semester)) {
    redirect("/scores/school/1/1");
  }

  // Tenant ì •ë³´ ì¡°íšŒ
  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  // ëª¨ë“  ì„±ì  ë°ì´í„° ì¡°íšŒ (í•„í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬)
  // âš ï¸ getSchoolScoresëŠ” deprecatedì…ë‹ˆë‹¤. getInternalScoresë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ í†µí•© ëŒ€ì‹œë³´ë“œ APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
  const scores = await getSchoolScores(user.id, tenantContext.tenantId);

  // í™œì„±í™”ëœ ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ
  const activeCurriculum = await getActiveCurriculumRevision();
  if (!activeCurriculum) {
    throw new Error("í™œì„±í™”ëœ ê°œì •êµìœ¡ê³¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // êµê³¼/ê³¼ëª©/ê³¼ëª©êµ¬ë¶„ ë°ì´í„° ì¡°íšŒ (ê°œì •êµìœ¡ê³¼ì •ë³„)
  const subjectHierarchy = await getSubjectHierarchyOptimized(activeCurriculum.id);
  const subjectGroupsWithSubjects = subjectHierarchy.subjectGroups;
  const subjectTypes = subjectHierarchy.subjectTypes;

  const successMessage = paramsQuery.success;

  return (
    <section className={getContainerClass("DASHBOARD", "md")}>
      <div className="flex flex-col gap-6">
        <div className="flex flex-col gap-2">
          <h1 className="text-3xl font-bold text-gray-900">ë‚´ì‹  ì„±ì </h1>
          <p className="text-sm text-gray-600">
            ë‚´ì‹  ì„±ì ì„ ì…ë ¥í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
          </p>
        </div>

        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
        <div>
          <ScoreTypeTabs />
        </div>
      </div>

      {/* ì„±ì  ì¹´ë“œ ê·¸ë¦¬ë“œ */}
      <SchoolScoresView
        initialGrade={parseInt(grade)}
        initialSemester={parseInt(semester)}
        scores={scores}
        subjectGroups={subjectGroupsWithSubjects}
        subjectTypes={subjectTypes}
      />
    </section>
  );
}
</file>

<file path="page.tsx">
import { redirect } from "next/navigation";

export default async function ScoresPage() {
  // ê¸°ë³¸ì ìœ¼ë¡œ í†µí•© ëŒ€ì‹œë³´ë“œë¡œ redirect
  redirect("/scores/dashboard/unified");
}
</file>

<file path="page.tsx">
import { redirect } from "next/navigation";

export default async function ScoresPage() {
  // ê¸°ë³¸ì ìœ¼ë¡œ í†µí•© ëŒ€ì‹œë³´ë“œë¡œ redirect
  redirect("/scores/dashboard/unified");
}
</file>

<file path="generators/planDataPreparer.ts">
/**
 * í”Œëœ ìƒì„±ì— í•„ìš”í•œ ë°ì´í„° ì¤€ë¹„
 * í”Œëœ ìƒì„± ì „ì— í•„ìš”í•œ ëª¨ë“  ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ì¤€ë¹„í•˜ëŠ” ìœ í‹¸ë¦¬í‹°
 */

import type { SupabaseServerClient } from "@/lib/data/core/types";
import type {
  PlanGroup,
  PlanContent,
  PlanExclusion,
  AcademySchedule,
} from "@/lib/types/plan";
import {
  copyMasterBookToStudent,
  copyMasterLectureToStudent,
} from "@/lib/data/contentMasters";
import {
  DUMMY_NON_LEARNING_CONTENT_ID,
  DUMMY_SELF_STUDY_CONTENT_ID,
} from "@/lib/constants/plan";

/**
 * ë¸”ë¡ ì •ë³´ íƒ€ì…
 */
export type BlockInfo = {
  day_of_week: number;
  start_time: string;
  end_time: string;
};

/**
 * ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° íƒ€ì…
 */
export type ContentMetadata = {
  title?: string | null;
  subject?: string | null;
  subject_category?: string | null;
  category?: string | null;
};

/**
 * ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ì •ë³´ íƒ€ì…
 */
export type ContentDurationInfo = {
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  total_pages?: number | null;
  duration?: number | null;
  total_page_or_time?: number | null;
};

/**
 * í”Œëœ ìƒì„±ì— í•„ìš”í•œ ë°ì´í„°
 */
export type PlanGenerationData = {
  group: PlanGroup;
  contents: PlanContent[];
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  baseBlocks: BlockInfo[];
  contentIdMap: Map<string, string>; // ë§ˆìŠ¤í„° ì½˜í…ì¸  ID -> í•™ìƒ ì½˜í…ì¸  ID
  contentMetadataMap: Map<string, ContentMetadata>;
  contentDurationMap: Map<string, ContentDurationInfo>;
  dateAvailableTimeRanges: Map<string, Array<{ start: string; end: string }>>;
  dateTimeSlots: Map<
    string,
    Array<{
      type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
      start: string;
      end: string;
      label?: string;
    }>
  >;
  dateMetadataMap: Map<
    string,
    {
      day_type: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •" | null;
      week_number: number | null;
    }
  >;
  weekDatesMap: Map<number, string[]>;
  riskIndexMap?: Map<string, { riskScore: number }>;
  contentSubjects: Map<string, { subject?: string | null; subject_category?: string | null }>;
};

/**
 * ë¸”ë¡ ì •ë³´ ì¡°íšŒ
 */
/**
 * @deprecated ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  `getBlockSetForPlanGroup`ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
 * í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ë˜ì§€ë§Œ, ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
 */
export async function prepareBaseBlocks(
  supabase: SupabaseServerClient,
  group: PlanGroup,
  studentId: string
): Promise<BlockInfo[]> {
  // ìƒˆë¡œìš´ í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©
  const { getBlockSetForPlanGroup } = await import("@/lib/plan/blocks");
  const { getCurrentUser } = await import("@/lib/auth/getCurrentUser");
  const { requireTenantContext } = await import("@/lib/tenant/requireTenantContext");

  const user = await getCurrentUser();
  if (!user) {
    throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  const tenantContext = await requireTenantContext();
  const role = user.role as "student" | "admin" | "consultant";

  return getBlockSetForPlanGroup(
    group,
    studentId,
    user.userId,
    role,
    tenantContext.tenantId
  );
}

/**
 * ë§ˆìŠ¤í„° ì½˜í…ì¸ ë¥¼ í•™ìƒ ì½˜í…ì¸ ë¡œ ë³µì‚¬í•˜ê³  ID ë§¤í•‘ ìƒì„±
 */
export async function prepareContentIdMap(
  supabase: SupabaseServerClient,
  contents: PlanContent[],
  studentId: string,
  tenantId: string
): Promise<Map<string, string>> {
  const contentIdMap = new Map<string, string>();

  for (const content of contents) {
    let studentContentId = content.content_id;

    // ë¨¼ì € ì´ë¯¸ í•™ìƒ ì½˜í…ì¸ ë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (content.content_type === "book") {
      const { data: existingStudentBook } = await supabase
        .from("books")
        .select("id")
        .eq("student_id", studentId)
        .eq("master_content_id", content.content_id)
        .maybeSingle();

      if (existingStudentBook) {
        studentContentId = existingStudentBook.id;
        contentIdMap.set(content.content_id, studentContentId);
        continue;
      }

      // ë§ˆìŠ¤í„° ì½˜í…ì¸ ì¸ì§€ í™•ì¸
      const { data: masterBook } = await supabase
        .from("master_books")
        .select("id")
        .eq("id", content.content_id)
        .maybeSingle();

      if (masterBook) {
        try {
          const { bookId } = await copyMasterBookToStudent(
            content.content_id,
            studentId,
            tenantId
          );
          studentContentId = bookId;
          contentIdMap.set(content.content_id, studentContentId);
        } catch (error) {
          console.error(
            `[planDataPreparer] ë§ˆìŠ¤í„° êµì¬ ë³µì‚¬ ì‹¤íŒ¨: ${content.content_id}`,
            error
          );
        }
      }
    } else if (content.content_type === "lecture") {
      const { data: existingStudentLecture } = await supabase
        .from("lectures")
        .select("id")
        .eq("student_id", studentId)
        .eq("master_content_id", content.content_id)
        .maybeSingle();

      if (existingStudentLecture) {
        studentContentId = existingStudentLecture.id;
        contentIdMap.set(content.content_id, studentContentId);
        continue;
      }

      // ë§ˆìŠ¤í„° ì½˜í…ì¸ ì¸ì§€ í™•ì¸
      const { data: masterLecture } = await supabase
        .from("master_lectures")
        .select("id")
        .eq("id", content.content_id)
        .maybeSingle();

      if (masterLecture) {
        try {
          const { lectureId } = await copyMasterLectureToStudent(
            content.content_id,
            studentId,
            tenantId
          );
          studentContentId = lectureId;
          contentIdMap.set(content.content_id, studentContentId);
        } catch (error) {
          console.error(
            `[planDataPreparer] ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹¤íŒ¨: ${content.content_id}`,
            error
          );
        }
      }
    }
  }

  return contentIdMap;
}

/**
 * ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ì¡°íšŒ
 */
export async function prepareContentMetadata(
  supabase: SupabaseServerClient,
  contents: PlanContent[],
  contentIdMap: Map<string, string>,
  studentId: string
): Promise<Map<string, ContentMetadata>> {
  const contentMetadataMap = new Map<string, ContentMetadata>();

  for (const content of contents) {
    const finalContentId =
      contentIdMap.get(content.content_id) || content.content_id;

    if (content.content_type === "book") {
      const { data: book } = await supabase
        .from("books")
        .select("title, subject, subject_category, content_category")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();

      if (book) {
        contentMetadataMap.set(content.content_id, {
          title: book.title || null,
          subject: book.subject || null,
          subject_category: book.subject_category || null,
          category: book.content_category || null,
        });
      } else {
        // ë§ˆìŠ¤í„° êµì¬ ì¡°íšŒ
        const { data: masterBook } = await supabase
          .from("master_books")
          .select("title, subject, subject_category, content_category")
          .eq("id", content.content_id)
          .maybeSingle();

        if (masterBook) {
          contentMetadataMap.set(content.content_id, {
            title: masterBook.title || null,
            subject: masterBook.subject || null,
            subject_category: masterBook.subject_category || null,
            category: masterBook.content_category || null,
          });
        }
      }
    } else if (content.content_type === "lecture") {
      const { data: lecture } = await supabase
        .from("lectures")
        .select("title, subject, subject_category, content_category")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();

      if (lecture) {
        contentMetadataMap.set(content.content_id, {
          title: lecture.title || null,
          subject: lecture.subject || null,
          subject_category: lecture.subject_category || null,
          category: lecture.content_category || null,
        });
      } else {
        // ë§ˆìŠ¤í„° ê°•ì˜ ì¡°íšŒ
        const { data: masterLecture } = await supabase
          .from("master_lectures")
          .select("title, subject, subject_category, content_category")
          .eq("id", content.content_id)
          .maybeSingle();

        if (masterLecture) {
          contentMetadataMap.set(content.content_id, {
            title: masterLecture.title || null,
            subject: masterLecture.subject || null,
            subject_category: masterLecture.subject_category || null,
            category: masterLecture.content_category || null,
          });
        }
      }
    } else if (content.content_type === "custom") {
      const { data: customContent } = await supabase
        .from("student_custom_contents")
        .select("title, subject, subject_category, content_category")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();

      if (customContent) {
        contentMetadataMap.set(content.content_id, {
          title: customContent.title || null,
          subject: customContent.subject || null,
          subject_category: customContent.subject_category || null,
          category: customContent.content_category || null,
        });
      }
    }
  }

  return contentMetadataMap;
}

/**
 * ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ì •ë³´ ì¡°íšŒ
 */
export async function prepareContentDuration(
  supabase: SupabaseServerClient,
  contents: PlanContent[],
  contentIdMap: Map<string, string>,
  studentId: string
): Promise<Map<string, ContentDurationInfo>> {
  const contentDurationMap = new Map<string, ContentDurationInfo>();

  // ë”ë¯¸ UUIDì— ëŒ€í•œ ê¸°ë³¸ê°’ ì¶”ê°€ (ë¹„í•™ìŠµ í•­ëª© ë° ììœ¨í•™ìŠµìš©)
  // ìƒìˆ˜ëŠ” lib/constants/plan.tsì—ì„œ import
  contentDurationMap.set(DUMMY_NON_LEARNING_CONTENT_ID, {
    content_type: "custom",
    content_id: DUMMY_NON_LEARNING_CONTENT_ID,
    total_page_or_time: 0,
  });

  contentDurationMap.set(DUMMY_SELF_STUDY_CONTENT_ID, {
    content_type: "custom",
    content_id: DUMMY_SELF_STUDY_CONTENT_ID,
    total_page_or_time: 0,
  });

  for (const content of contents) {
    const finalContentId =
      contentIdMap.get(content.content_id) || content.content_id;

    if (content.content_type === "book") {
      // í•™ìƒ êµì¬ ì¡°íšŒ
      let studentBook = await supabase
        .from("books")
        .select("id, total_pages, master_content_id")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();

      // finalContentIdë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš°, ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¸ì§€ í™•ì¸í•˜ê³  í•™ìƒ êµì¬ ì°¾ê¸°
      if (!studentBook.data) {
        const { data: masterBook } = await supabase
          .from("master_books")
          .select("id")
          .eq("id", finalContentId)
          .maybeSingle();

        if (masterBook) {
          const { data: studentBookByMaster } = await supabase
            .from("books")
            .select("id, total_pages, master_content_id")
            .eq("student_id", studentId)
            .eq("master_content_id", finalContentId)
            .maybeSingle();

          if (studentBookByMaster) {
            studentBook = { data: studentBookByMaster, error: null } as typeof studentBook;
          }
        }
      }

      if (studentBook.data) {
        const bookData = studentBook.data;

        if (bookData.total_pages) {
          contentDurationMap.set(content.content_id, {
            content_type: "book",
            content_id: content.content_id,
            total_pages: bookData.total_pages,
          });
        } else if (bookData.master_content_id) {
          // ë§ˆìŠ¤í„° êµì¬ ì¡°íšŒ
          const { data: masterBook } = await supabase
            .from("master_books")
            .select("id, total_pages")
            .eq("id", bookData.master_content_id)
            .maybeSingle();

          if (masterBook?.total_pages) {
            contentDurationMap.set(content.content_id, {
              content_type: "book",
              content_id: content.content_id,
              total_pages: masterBook.total_pages,
            });
          }
        }
      }
    } else if (content.content_type === "lecture") {
      // í•™ìƒ ê°•ì˜ ì¡°íšŒ
      let studentLecture = await supabase
        .from("lectures")
        .select("id, duration, master_content_id")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();

      // finalContentIdë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš°, ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¸ì§€ í™•ì¸í•˜ê³  í•™ìƒ ê°•ì˜ ì°¾ê¸°
      if (!studentLecture.data) {
        const { data: masterLecture } = await supabase
          .from("master_lectures")
          .select("id")
          .eq("id", finalContentId)
          .maybeSingle();

        if (masterLecture) {
          const { data: studentLectureByMaster } = await supabase
            .from("lectures")
            .select("id, duration, master_content_id")
            .eq("student_id", studentId)
            .eq("master_content_id", finalContentId)
            .maybeSingle();

          if (studentLectureByMaster) {
            studentLecture = { data: studentLectureByMaster, error: null } as typeof studentLecture;
          }
        }
      }

      if (studentLecture.data) {
        const lectureData = studentLecture.data;

        if (lectureData.duration) {
          contentDurationMap.set(content.content_id, {
            content_type: "lecture",
            content_id: content.content_id,
            duration: lectureData.duration,
          });
        } else if (lectureData.master_content_id) {
          // ë§ˆìŠ¤í„° ê°•ì˜ ì¡°íšŒ
          const { data: masterLecture } = await supabase
            .from("master_lectures")
            .select("id, duration")
            .eq("id", lectureData.master_content_id)
            .maybeSingle();

          if (masterLecture?.duration) {
            contentDurationMap.set(content.content_id, {
              content_type: "lecture",
              content_id: content.content_id,
              duration: masterLecture.duration,
            });
          }
        }
      }
    } else if (content.content_type === "custom") {
      // ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ
      const { data: customContent } = await supabase
        .from("student_custom_contents")
        .select("id, total_page_or_time")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();

      if (customContent?.total_page_or_time !== undefined) {
        contentDurationMap.set(content.content_id, {
          content_type: "custom",
          content_id: content.content_id,
          total_page_or_time: customContent.total_page_or_time,
        });
      }
    }
  }

  return contentDurationMap;
}

/**
 * ìŠ¤ì¼€ì¤„ ê²°ê³¼ì—ì„œ ë‚ ì§œë³„ ì •ë³´ ì¶”ì¶œ
 */
export function extractScheduleData(
  scheduleResult: {
    daily_schedule: Array<{
      date: string;
      day_type?: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •" | null;
      week_number?: number | null;
      available_time_ranges: Array<{ start: string; end: string }>;
      time_slots?: Array<{
        type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
        start: string;
        end: string;
        label?: string;
      }>;
    }>;
  }
): {
  dateAvailableTimeRanges: Map<string, Array<{ start: string; end: string }>>;
  dateTimeSlots: Map<
    string,
    Array<{
      type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
      start: string;
      end: string;
      label?: string;
    }>
  >;
  dateMetadataMap: Map<
    string,
    {
      day_type: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •" | null;
      week_number: number | null;
    }
  >;
  weekDatesMap: Map<number, string[]>;
} {
  const dateAvailableTimeRanges = new Map<
    string,
    Array<{ start: string; end: string }>
  >();
  const dateTimeSlots = new Map<
    string,
    Array<{
      type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
      start: string;
      end: string;
      label?: string;
    }>
  >();
  const dateMetadataMap = new Map<
    string,
    {
      day_type: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •" | null;
      week_number: number | null;
    }
  >();
  const weekDatesMap = new Map<number, string[]>();

  scheduleResult.daily_schedule.forEach((daily) => {
    if (daily.day_type === "í•™ìŠµì¼" && daily.available_time_ranges.length > 0) {
      dateAvailableTimeRanges.set(
        daily.date,
        daily.available_time_ranges.map((range) => ({
          start: range.start,
          end: range.end,
        }))
      );
    }

    // time_slots ì •ë³´ë„ ì €ì¥
    if (daily.time_slots && daily.time_slots.length > 0) {
      dateTimeSlots.set(
        daily.date,
        daily.time_slots.map((slot) => ({
          type: slot.type,
          start: slot.start,
          end: slot.end,
          label: slot.label,
        }))
      );
    }

    // ë‚ ì§œë³„ ë©”íƒ€ë°ì´í„° ì €ì¥
    dateMetadataMap.set(daily.date, {
      day_type: daily.day_type || null,
      week_number: daily.week_number || null,
    });

    // ì£¼ì°¨ë³„ ë‚ ì§œ ëª©ë¡ êµ¬ì„±
    if (daily.week_number) {
      if (!weekDatesMap.has(daily.week_number)) {
        weekDatesMap.set(daily.week_number, []);
      }
      // ì œì™¸ì¼ì´ ì•„ë‹Œ ë‚ ì§œë§Œ ì£¼ì°¨ì— í¬í•¨
      if (
        daily.day_type &&
        daily.day_type !== "íœ´ê°€" &&
        daily.day_type !== "ê°œì¸ì¼ì •" &&
        daily.day_type !== "ì§€ì •íœ´ì¼"
      ) {
        weekDatesMap.get(daily.week_number)!.push(daily.date);
      }
    }
  });

  // ì£¼ì°¨ë³„ ë‚ ì§œ ëª©ë¡ ì •ë ¬ (ë‚ ì§œ ìˆœ)
  weekDatesMap.forEach((dates) => {
    dates.sort();
  });

  return {
    dateAvailableTimeRanges,
    dateTimeSlots,
    dateMetadataMap,
    weekDatesMap,
  };
}
</file>

<file path="1730TimetableLogic.ts">
/**
 * 1730 Timetable í”Œëœ ìƒì„± ë¡œì§
 *
 * ë¬¸ì„œ ê¸°ë°˜:
 * - 1730Timetable-ì†”ë£¨ì…˜-ìš”êµ¬ì‚¬í•­-ë°-í”Œëœ-ì˜ˆì‹œ.md
 * - í”Œëœ-ìƒì„±-ë¡œì§-ì„¤ê³„.md
 * - í•™ìŠµì¼-ë³µìŠµì¼-ì£¼ê¸°-ì„¤ì •.md
 * - ìš”êµ¬ì‚¬í•­-ì •ë¦¬.md
 */

import {
  PlanGroup,
  PlanExclusion,
  AcademySchedule,
  StudyReviewCycle,
  SubjectConstraints,
  NonStudyTimeBlock,
} from "@/lib/types/plan";
import { getEffectiveAllocation } from "@/lib/utils/subjectAllocation";

export type DayType = "study" | "review" | "exclusion";

export type CycleDayInfo = {
  date: string; // YYYY-MM-DD
  day_type: DayType;
  cycle_day_number: number; // ì£¼ê¸° ë‚´ ì¼ì ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
  cycle_number: number; // ì£¼ì°¨ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
};

export type SubjectAllocation = {
  subject_id: string;
  subject_name: string;
  subject_type: "strategy" | "weakness";
  weekly_days?: number; // ì „ëµê³¼ëª©ì¸ ê²½ìš° ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜ (2, 3, 4)
};

export type ContentDurationInfo = {
  content_id: string;
  content_type: "book" | "lecture" | "custom";
  base_duration_per_unit: number; // ë‹¨ìœ„ë‹¹ ê¸°ë³¸ ì†Œìš”ì‹œê°„ (ë¶„)
  total_units: number; // ì´ ë‹¨ìœ„ ìˆ˜ (í˜ì´ì§€, ê°•ì˜ ìˆ˜ ë“±)
};

export type StudentLevel = "high" | "medium" | "low";

export type DurationCalculationResult = {
  base_duration: number; // ê¸°ë³¸ ì†Œìš”ì‹œê°„ (ë¶„)
  student_level_factor: number; // í•™ìƒ ìˆ˜ì¤€ ë³´ì • ê³„ìˆ˜
  subject_factor: number; // ê³¼ëª©ë³„ ë³´ì • ê³„ìˆ˜
  difficulty_factor: number; // ë‚œì´ë„ ë³´ì • ê³„ìˆ˜
  review_factor?: number; // ë³µìŠµ ë³´ì • ê³„ìˆ˜ (ë³µìŠµì¼ì¸ ê²½ìš°)
  review_of_review_factor?: number; // ë³µìŠµì˜ ë³µìŠµ ë³´ì • ê³„ìˆ˜ (ì¶”ê°€ ê¸°ê°„ì¸ ê²½ìš°)
  final_duration: number; // ìµœì¢… ì†Œìš”ì‹œê°„ (ë¶„)
};

/**
 * í•™ìŠµì¼/ë³µìŠµì¼ ì£¼ê¸° ê³„ì‚°
 * ì œì™¸ì¼ì€ ì£¼ê¸° ê³„ì‚°ì—ì„œ ì™„ì „íˆ ì œì™¸ë¨
 */
export function calculateStudyReviewCycle(
  periodStart: string,
  periodEnd: string,
  cycle: StudyReviewCycle,
  exclusions: PlanExclusion[]
): CycleDayInfo[] {
  const result: CycleDayInfo[] = [];
  const startDate = new Date(periodStart);
  const endDate = new Date(periodEnd);

  // ì œì™¸ì¼ Set ìƒì„±
  const exclusionDates = new Set(
    exclusions.map((e) => e.exclusion_date.split("T")[0])
  );

  // ë‚ ì§œ ë²”ìœ„ ìƒì„±
  const dates: Date[] = [];
  const current = new Date(startDate);
  current.setHours(0, 0, 0, 0);

  const end = new Date(endDate);
  end.setHours(23, 59, 59, 999);

  while (current <= end) {
    dates.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }

  // ì£¼ê¸° ê³„ì‚° (ì œì™¸ì¼ ì œì™¸)
  let cycleDayNumber = 0;
  let cycleNumber = 1;
  const cycleLength = cycle.study_days + cycle.review_days;

  for (const date of dates) {
    const dateStr = formatDate(date);

    // ì œì™¸ì¼ ì²´í¬
    if (exclusionDates.has(dateStr)) {
      result.push({
        date: dateStr,
        day_type: "exclusion",
        cycle_day_number: 0, // ì œì™¸ì¼ì€ ì£¼ê¸° ì¼ì ë²ˆí˜¸ ì—†ìŒ
        cycle_number: cycleNumber,
      });
      continue;
    }

    // ì£¼ê¸° ì¼ì ì¹´ìš´íŠ¸ ì¦ê°€
    cycleDayNumber++;

    // ì£¼ê¸° ê²½ê³„ ì²˜ë¦¬
    if (cycleDayNumber > cycleLength) {
      cycleDayNumber = 1;
      cycleNumber++;
    }

    // í•™ìŠµì¼/ë³µìŠµì¼ êµ¬ë¶„
    const dayType: DayType =
      cycleDayNumber <= cycle.study_days ? "study" : "review";

    result.push({
      date: dateStr,
      day_type: dayType,
      cycle_day_number: cycleDayNumber,
      cycle_number: cycleNumber,
    });
  }

  return result;
}

/**
 * ì½˜í…ì¸ ì˜ ì „ëµ/ì·¨ì•½ ì„¤ì •ì„ ê°€ì ¸ì˜´ (í´ë°± ë©”ì»¤ë‹ˆì¦˜)
 * 
 * @deprecated ì´ í•¨ìˆ˜ëŠ” í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ë˜ì§€ë§Œ, 
 * ìƒˆë¡œìš´ ì½”ë“œì—ì„œëŠ” `lib/utils/subjectAllocation.ts`ì˜ `getEffectiveAllocation` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
 * 
 * @param content - ì½˜í…ì¸  ì •ë³´ (content_type, content_id, subject_category, subject, subject_id í¬í•¨)
 * @param contentAllocations - ì½˜í…ì¸ ë³„ ì„¤ì • (ì„ íƒì‚¬í•­)
 * @param subjectAllocations - êµê³¼ë³„ ì„¤ì • (ì„ íƒì‚¬í•­)
 * @returns ì „ëµ/ì·¨ì•½ ì„¤ì • ë° ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜
 */
export function getContentAllocation(
  content: { 
    content_type: string; 
    content_id: string; 
    subject_category?: string;
    subject?: string | null;
    subject_id?: string;
  },
  contentAllocations?: Array<{
    content_type: string;
    content_id: string;
    subject_type: "strategy" | "weakness";
    weekly_days?: number;
  }>,
  subjectAllocations?: Array<{
    subject_id?: string;
    subject_name: string;
    subject_type: "strategy" | "weakness";
    weekly_days?: number;
  }>
): { subject_type: "strategy" | "weakness"; weekly_days?: number } {
  // ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì‚¬ìš© (ë¡œê¹… í™œì„±í™”)
  const result = getEffectiveAllocation(
    {
      content_type: content.content_type,
      content_id: content.content_id,
      subject_category: content.subject_category || undefined,
      subject: content.subject || undefined,
      subject_id: content.subject_id,
    },
    contentAllocations?.map((a) => ({
      content_type: a.content_type as "book" | "lecture" | "custom",
      content_id: a.content_id,
      subject_type: a.subject_type,
      weekly_days: a.weekly_days,
    })),
    subjectAllocations?.map((a) => ({
      subject_id: a.subject_id,
      subject_name: a.subject_name,
      subject_type: a.subject_type,
      weekly_days: a.weekly_days,
    })),
    true // ì„œë²„ ë¡œì§ì—ì„œëŠ” ë¡œê¹… í™œì„±í™”
  );

  // ê¸°ì¡´ ë°˜í™˜ íƒ€ì…ê³¼ í˜¸í™˜ë˜ë„ë¡ source í•„ë“œ ì œê±°
  return {
    subject_type: result.subject_type,
    weekly_days: result.weekly_days,
  };
}

/**
 * ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ë°°ì • ë‚ ì§œ ê³„ì‚°
 */
export function calculateSubjectAllocationDates(
  cycleDays: CycleDayInfo[],
  allocation: SubjectAllocation
): string[] {
  const studyDates = cycleDays
    .filter((d) => d.day_type === "study")
    .map((d) => d.date);

  if (allocation.subject_type === "weakness") {
    // ì·¨ì•½ê³¼ëª©: ì „ì²´ í•™ìŠµì¼ ë°°ì •
    return studyDates;
  } else {
    // ì „ëµê³¼ëª©: ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜ì— ë”°ë¼ ë°°ì •
    const weeklyDays = allocation.weekly_days || 3;
    const allocatedDates: string[] = [];

    // ì£¼ì°¨ë³„ë¡œ ê·¸ë£¹í™”
    const weeks = new Map<number, string[]>();
    for (const cycleDay of cycleDays) {
      if (cycleDay.day_type === "study") {
        if (!weeks.has(cycleDay.cycle_number)) {
          weeks.set(cycleDay.cycle_number, []);
        }
        weeks.get(cycleDay.cycle_number)!.push(cycleDay.date);
      }
    }

    // ê° ì£¼ì°¨ì—ì„œ ì£¼ë‹¹ ë°°ì • ì¼ìˆ˜ë§Œí¼ ê· ë“±í•˜ê²Œ ì„ íƒ
    for (const [_, weekDates] of weeks.entries()) {
      const selectedCount = Math.min(weeklyDays, weekDates.length);
      if (selectedCount === 0) continue;
      
      // ê· ë“±í•˜ê²Œ ë¶„ë°°í•˜ê¸° ìœ„í•œ ê°„ê²© ê³„ì‚°
      const step = weekDates.length / selectedCount;
      
      for (let i = 0; i < selectedCount; i++) {
        // ì¤‘ê°„ê°’ì„ ì‚¬ìš©í•˜ì—¬ ë” ê· ë“±í•˜ê²Œ ë¶„ë°°
        const index = Math.floor((i + 0.5) * step);
        allocatedDates.push(weekDates[index]);
      }
    }

    return allocatedDates;
  }
}

/**
 * í•™ìŠµ ë²”ìœ„ ë¶„í• 
 */
export function divideContentRange(
  totalRange: number,
  allocatedDates: string[],
  contentId: string
): Map<string, { start: number; end: number }> {
  const result = new Map<string, { start: number; end: number }>();

  if (allocatedDates.length === 0) {
    return result;
  }

  const dailyRange = totalRange / allocatedDates.length;
  let currentStart = 0;

  for (let i = 0; i < allocatedDates.length; i++) {
    const date = allocatedDates[i];
    const isLast = i === allocatedDates.length - 1;
    const dayRange = isLast
      ? totalRange - currentStart
      : Math.round(dailyRange);
    const dayEnd = currentStart + dayRange;

    result.set(date, {
      start: Math.round(currentStart),
      end: Math.round(dayEnd),
    });

    currentStart = dayEnd;
  }

  return result;
}

/**
 * ì†Œìš”ì‹œê°„ ê³„ì‚°
 */
export function calculateDuration(
  range: { start: number; end: number },
  durationInfo: ContentDurationInfo,
  studentLevel: StudentLevel,
  subjectType: "strategy" | "weakness",
  isReview: boolean = false,
  isReviewOfReview: boolean = false
): DurationCalculationResult {
  const amount = range.end - range.start;

  // ê¸°ë³¸ ì†Œìš”ì‹œê°„
  const baseDuration = amount * durationInfo.base_duration_per_unit;

  // í•™ìƒ ìˆ˜ì¤€ ë³´ì • ê³„ìˆ˜
  let studentLevelFactor = 1.0;
  switch (studentLevel) {
    case "high":
      studentLevelFactor = 0.85; // 0.8~0.9 í‰ê· 
      break;
    case "medium":
      studentLevelFactor = 1.0;
      break;
    case "low":
      studentLevelFactor = 1.2; // 1.1~1.3 í‰ê· 
      break;
  }

  // ê³¼ëª©ë³„ ë³´ì • ê³„ìˆ˜
  let subjectFactor = 1.0;
  if (subjectType === "weakness") {
    subjectFactor = 1.2; // ì·¨ì•½ê³¼ëª©
  } else {
    subjectFactor = 1.05; // ì „ëµê³¼ëª© (1.0~1.1 í‰ê· )
  }

  // ë‚œì´ë„ ë³´ì • ê³„ìˆ˜ (ê¸°ë³¸ê°’ 1.0, í–¥í›„ í™•ì¥ ê°€ëŠ¥)
  const difficultyFactor = 1.0;

  // ë³µìŠµ ë³´ì • ê³„ìˆ˜
  let reviewFactor: number | undefined;
  if (isReview) {
    reviewFactor = 0.4; // 0.3~0.5 í‰ê· 
  }

  // ë³µìŠµì˜ ë³µìŠµ ë³´ì • ê³„ìˆ˜
  let reviewOfReviewFactor: number | undefined;
  if (isReviewOfReview) {
    reviewOfReviewFactor = 0.25; // 0.2~0.3 í‰ê· 
  }

  // ìµœì¢… ì†Œìš”ì‹œê°„ ê³„ì‚°
  let finalDuration =
    baseDuration * studentLevelFactor * subjectFactor * difficultyFactor;

  if (isReview && reviewFactor) {
    finalDuration *= reviewFactor;
  }

  if (isReviewOfReview && reviewOfReviewFactor) {
    finalDuration *= reviewOfReviewFactor;
  }

  return {
    base_duration: baseDuration,
    student_level_factor: studentLevelFactor,
    subject_factor: subjectFactor,
    difficulty_factor: difficultyFactor,
    review_factor: reviewFactor,
    review_of_review_factor: reviewOfReviewFactor,
    final_duration: Math.round(finalDuration),
  };
}

/**
 * ë³µìŠµì¼ ì†Œìš”ì‹œê°„ ê³„ì‚°
 * ì§ì „ í•™ìŠµì¼(6ì¼) ë™ì•ˆ í•™ìŠµí•œ ì „ì²´ ë²”ìœ„ë¥¼ ë³µìŠµ
 */
export function calculateReviewDuration(
  previousStudyDays: CycleDayInfo[],
  contentRanges: Map<string, { start: number; end: number }>,
  durationInfo: ContentDurationInfo,
  studentLevel: StudentLevel,
  subjectType: "strategy" | "weakness"
): DurationCalculationResult {
  // ì§ì „ í•™ìŠµì¼ì˜ í•™ìŠµ ë²”ìœ„ ê³„ì‚°
  let totalStart = Infinity;
  let totalEnd = -Infinity;

  for (const day of previousStudyDays) {
    const range = contentRanges.get(day.date);
    if (range) {
      totalStart = Math.min(totalStart, range.start);
      totalEnd = Math.max(totalEnd, range.end);
    }
  }

  if (totalStart === Infinity || totalEnd === -Infinity) {
    // ì§ì „ í•™ìŠµì¼ ë²”ìœ„ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
    return {
      base_duration: 0,
      student_level_factor: 1.0,
      subject_factor: 1.0,
      difficulty_factor: 1.0,
      review_factor: 0.4,
      final_duration: 0,
    };
  }

  // ì§ì „ í•™ìŠµì¼ì˜ í•™ìŠµ ì†Œìš”ì‹œê°„ ê³„ì‚°
  const previousRange = { start: totalStart, end: totalEnd };
  const previousDuration = calculateDuration(
    previousRange,
    durationInfo,
    studentLevel,
    subjectType,
    false // í•™ìŠµì¼
  );

  // ë³µìŠµ ë³´ì • ê³„ìˆ˜ ì ìš©
  const reviewFactor = 0.4; // 0.3~0.5 í‰ê· 
  const reviewDuration = previousDuration.final_duration * reviewFactor;

  return {
    base_duration: previousDuration.base_duration,
    student_level_factor: previousDuration.student_level_factor,
    subject_factor: previousDuration.subject_factor,
    difficulty_factor: previousDuration.difficulty_factor,
    review_factor: reviewFactor,
    final_duration: Math.round(reviewDuration),
  };
}

/**
 * êµê³¼ ì œì•½ ì¡°ê±´ ê²€ì¦
 * ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª© ê²€ì¦ ì§€ì›
 */
export function validateSubjectConstraints(
  plans: Array<{ 
    subject_id?: string; 
    subject_name?: string;
    detail_subject?: string; // ì„¸ë¶€ ê³¼ëª© (ì„ íƒì‚¬í•­)
  }>,
  constraints: SubjectConstraints,
  studentCurriculumRevisionId?: string // í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì • ID (ì„ íƒì‚¬í•­)
): { valid: boolean; errors: string[] } {
  const errors: string[] = [];

  // í•„ìˆ˜ êµê³¼ ê²€ì¦
  if (
    constraints.required_subjects &&
    constraints.required_subjects.length > 0
  ) {
    for (const req of constraints.required_subjects) {
      // ê°œì •êµìœ¡ê³¼ì •ë³„ ì„¸ë¶€ ê³¼ëª©ì´ ìˆëŠ” ê²½ìš°
      if (req.subjects_by_curriculum && req.subjects_by_curriculum.length > 0) {
        // í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì •ì— í•´ë‹¹í•˜ëŠ” ì„¸ë¶€ ê³¼ëª© ì°¾ê¸°
        const curriculumSubject = studentCurriculumRevisionId
          ? req.subjects_by_curriculum.find(
              (s) => s.curriculum_revision_id === studentCurriculumRevisionId
            )
          : undefined;

        if (curriculumSubject && curriculumSubject.subject_id) {
          // ì„¸ë¶€ ê³¼ëª©ê¹Œì§€ ê²€ì¦
          const matchingCount = plans.filter(
            (p) =>
              p.subject_id === curriculumSubject.subject_id ||
              (p.detail_subject === curriculumSubject.subject_name &&
                (p.subject_name || "").toLowerCase().includes(req.subject_category.toLowerCase()))
          ).length;

          if (matchingCount < req.min_count) {
            errors.push(
              `í•„ìˆ˜ êµê³¼ "${req.subject_category} - ${curriculumSubject.subject_name}"ì˜ ì½˜í…ì¸ ê°€ ${req.min_count}ê°œ í•„ìš”í•˜ì§€ë§Œ ${matchingCount}ê°œë§Œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`
            );
          }
        } else {
          // í•™ìƒì˜ ê°œì •êµìœ¡ê³¼ì •ì— í•´ë‹¹í•˜ëŠ” ì„¸ë¶€ ê³¼ëª©ì´ ì—†ìœ¼ë©´ êµê³¼ë§Œ ê²€ì¦
          const matchingCount = plans.filter(
            (p) =>
              (p.subject_name || "").toLowerCase().includes(req.subject_category.toLowerCase())
          ).length;

          if (matchingCount < req.min_count) {
            errors.push(
              `í•„ìˆ˜ êµê³¼ "${req.subject_category}"ì˜ ì½˜í…ì¸ ê°€ ${req.min_count}ê°œ í•„ìš”í•˜ì§€ë§Œ ${matchingCount}ê°œë§Œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`
            );
          }
        }
      } else {
        // ì„¸ë¶€ ê³¼ëª© ì§€ì •ì´ ì—†ìœ¼ë©´ êµê³¼ë§Œ ê²€ì¦
        const matchingCount = plans.filter(
          (p) =>
            (p.subject_name || "").toLowerCase().includes(req.subject_category.toLowerCase())
        ).length;

        if (matchingCount < req.min_count) {
          errors.push(
            `í•„ìˆ˜ êµê³¼ "${req.subject_category}"ì˜ ì½˜í…ì¸ ê°€ ${req.min_count}ê°œ í•„ìš”í•˜ì§€ë§Œ ${matchingCount}ê°œë§Œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
        }
      }
    }
  }

  // ì œì™¸ êµê³¼ ê²€ì¦
  if (
    constraints.excluded_subjects &&
    constraints.excluded_subjects.length > 0
  ) {
    const planSubjects = new Set<string>();
    for (const plan of plans) {
      const subject = plan.subject_id || plan.subject_name;
      if (subject) {
        planSubjects.add(subject.toLowerCase().trim());
      }
    }

    const includedExcludedSubjects = constraints.excluded_subjects.filter(
      (subject) => planSubjects.has(subject.toLowerCase().trim())
    );

    if (includedExcludedSubjects.length > 0) {
      errors.push(
        `ì œì™¸ëœ êµê³¼ê°€ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤: ${includedExcludedSubjects.join(", ")}`
      );
    }
  }

  // ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ë²•ì— ë”°ë¥¸ ê²°ê³¼ ë°˜í™˜
  if (errors.length > 0) {
    if (constraints.constraint_handling === "strict") {
      return { valid: false, errors };
    } else if (constraints.constraint_handling === "warning") {
      // ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ê³„ì† ì§„í–‰
      return { valid: true, errors };
    } else {
      // auto_fix: ìë™ ë³´ì™„ (í–¥í›„ êµ¬í˜„)
      return { valid: true, errors };
    }
  }

  return { valid: true, errors: [] };
}

/**
 * íƒ€ì„ë¼ì¸ êµ¬ì„± (ì œì™¸ ì‹œê°„ìœ¼ë¡œ ì¸í•œ ë¶„í•  ì²˜ë¦¬ í¬í•¨)
 */
export type TimeSlot = {
  start: string; // HH:mm
  end: string; // HH:mm
  type: "study" | "self_study";
};

export type PlanTimeline = {
  plan_id: string;
  date: string;
  time_slots: TimeSlot[];
  total_duration: number; // ë¶„
  split_info?: {
    original_plan_id: string;
    split_order: number;
    total_split_count: number;
  };
};

export function buildPlanTimeline(
  planDuration: number, // ë¶„
  date: string,
  availableTimeRanges: Array<{ start: string; end: string }>,
  useSelfStudy: boolean = false,
  selfStudyRanges?: Array<{ start: string; end: string }>
): PlanTimeline {
  const timeSlots: TimeSlot[] = [];
  let remainingDuration = planDuration;

  // í•™ìŠµ ì‹œê°„ëŒ€ì— ë¨¼ì € ë°°ì •
  for (const range of availableTimeRanges) {
    if (remainingDuration <= 0) break;

    const rangeDuration = timeToMinutes(range.end) - timeToMinutes(range.start);
    const assignedDuration = Math.min(remainingDuration, rangeDuration);

    timeSlots.push({
      start: range.start,
      end: minutesToTime(timeToMinutes(range.start) + assignedDuration),
      type: "study",
    });

    remainingDuration -= assignedDuration;
  }

  // ë°°ì • ê°€ëŠ¥í•œ ì‹œê°„ì´ ë¶€ì¡±í•œ ê²½ìš° ììœ¨ í•™ìŠµ ì‹œê°„ ì‚¬ìš©
  if (remainingDuration > 0 && useSelfStudy && selfStudyRanges) {
    for (const range of selfStudyRanges) {
      if (remainingDuration <= 0) break;

      const rangeDuration =
        timeToMinutes(range.end) - timeToMinutes(range.start);
      const assignedDuration = Math.min(remainingDuration, rangeDuration);

      timeSlots.push({
        start: range.start,
        end: minutesToTime(timeToMinutes(range.start) + assignedDuration),
        type: "self_study",
      });

      remainingDuration -= assignedDuration;
    }
  }

  // ë¶„í•  ì •ë³´ ìƒì„± (ì œì™¸ ì‹œê°„ìœ¼ë¡œ ì¸í•´ ë¶„í• ëœ ê²½ìš°)
  const splitInfo =
    timeSlots.length > 1
      ? {
          original_plan_id: `plan_${date}_${Date.now()}`,
          split_order: 1,
          total_split_count: timeSlots.length,
        }
      : undefined;

  return {
    plan_id: `plan_${date}_${Date.now()}`,
    date,
    time_slots: timeSlots,
    total_duration: planDuration - remainingDuration,
    split_info: splitInfo,
  };
}

/**
 * ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 */

function formatDate(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

function minutesToTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}
</file>

<file path="assignPlanTimes.ts">
/**
 * í”Œëœ ì‹œê°„ ë°°ì¹˜ ìœ í‹¸ë¦¬í‹°
 * Step7ì˜ TimeSlotsWithPlans ë¡œì§ì„ ì„œë²„ ì•¡ì…˜ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í•¨ìˆ˜
 *
 * @see docs/refactoring/timeline_strategy.md
 */

import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";

// ============================================
// ì…ë ¥ íƒ€ì… ì •ì˜
// ============================================

/**
 * ì½˜í…ì¸  ìœ í˜•
 */
export type ContentType = "book" | "lecture" | "custom";

/**
 * í”Œëœ ì‹œê°„ ë°°ì¹˜ ì…ë ¥ í”Œëœ íƒ€ì…
 */
export type PlanTimeInput = {
  content_id: string;
  content_type: ContentType;
  planned_start_page_or_time: number;
  planned_end_page_or_time: number;
  chapter?: string | null;
  block_index?: number;
};

/**
 * í•™ìŠµ ì‹œê°„ ìŠ¬ë¡¯
 */
export type StudyTimeSlot = {
  start: string; // HH:mm
  end: string; // HH:mm
};

/**
 * ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° (ì†Œìš”ì‹œê°„ ê³„ì‚°ìš©)
 */
export type ContentDurationInfo = {
  content_type: ContentType;
  content_id: string;
  total_pages?: number | null;
  duration?: number | null;
  total_page_or_time?: number | null;
};

/**
 * í”Œëœ ì˜ˆìƒ ì†Œìš”ì‹œê°„ ê³„ì‚° ì…ë ¥ íƒ€ì…
 */
export type PlanEstimateInput = {
  content_type: ContentType;
  content_id?: string | null;
  planned_start_page_or_time: number | null;
  planned_end_page_or_time: number | null;
};

// ============================================
// ì¶œë ¥ íƒ€ì… ì •ì˜
// ============================================

// ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
export function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

// ë¶„ì„ ì‹œê°„ ë¬¸ìì—´ë¡œ ë³€í™˜
export function minutesToTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}

/**
 * í”Œëœì˜ ì˜ˆìƒ ì†Œìš”ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
 *
 * @param plan - í”Œëœ ì •ë³´ (content_type, ë²”ìœ„)
 * @param contentDurationMap - ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ë§µ (content_id â†’ ì •ë³´)
 * @param dayType - ì¼ ìœ í˜• ('í•™ìŠµì¼' | 'ë³µìŠµì¼' ë“±)
 * @returns ì˜ˆìƒ ì†Œìš”ì‹œê°„ (ë¶„)
 */
export function calculatePlanEstimatedTime(
  plan: PlanEstimateInput,
  contentDurationMap: Map<string, ContentDurationInfo>,
  dayType?: string
): number {
  if (
    plan.planned_start_page_or_time === null ||
    plan.planned_end_page_or_time === null
  ) {
    const baseTime = 60; // ê¸°ë³¸ê°’ 1ì‹œê°„
    // ë³µìŠµì¼ì´ë©´ ì†Œìš”ì‹œê°„ ë‹¨ì¶• (í•™ìŠµì¼ ëŒ€ë¹„ 50%ë¡œ ë‹¨ì¶•)
    return dayType === "ë³µìŠµì¼" ? Math.round(baseTime * 0.5) : baseTime;
  }

  const amount = plan.planned_end_page_or_time - plan.planned_start_page_or_time;
  if (amount <= 0) {
    const baseTime = 60;
    return dayType === "ë³µìŠµì¼" ? Math.round(baseTime * 0.5) : baseTime;
  }

  let baseTime = 0;

  if (plan.content_type === "book") {
    // ì±…: ì„¤ì • ê¸°ë°˜ ì‹œê°„ ê³„ì‚°
    const pagesPerHour = defaultRangeRecommendationConfig.pagesPerHour;
    const minutesPerPage = 60 / pagesPerHour;
    baseTime = Math.round(amount * minutesPerPage);
  } else if (plan.content_type === "lecture") {
    // ê°•ì˜: duration ì •ë³´ ì‚¬ìš©
    const contentInfo = contentDurationMap.get(plan.content_id || "");
    if (contentInfo?.duration && contentInfo.duration > 0) {
      // ê°•ì˜ì˜ ê²½ìš° planned_start_page_or_timeê³¼ planned_end_page_or_timeì´ íšŒì°¨ë¥¼ ë‚˜íƒ€ëƒ„
      const episodeCount = amount; // íšŒì°¨ ìˆ˜
      const totalDuration = contentInfo.duration;
      // íšŒì°¨ë‹¹ í‰ê·  ì‹œê°„ ê³„ì‚°
      baseTime = Math.round(totalDuration / Math.max(episodeCount, 1));
    } else {
      baseTime = 60; // ê¸°ë³¸ê°’
    }
  } else {
    baseTime = 60; // ê¸°ë³¸ê°’
  }

  // ë³µìŠµì¼ì´ë©´ ì†Œìš”ì‹œê°„ ë‹¨ì¶• (í•™ìŠµì¼ ëŒ€ë¹„ 50%ë¡œ ë‹¨ì¶•)
  if (dayType === "ë³µìŠµì¼") {
    return Math.round(baseTime * 0.5);
  }

  return baseTime;
}

/**
 * í”Œëœ ì‹œê°„ ë°°ì¹˜ ê²°ê³¼ (ì¶œë ¥)
 */
export type PlanTimeSegment = {
  /** ì›ë³¸ í”Œëœ ì •ë³´ */
  plan: PlanTimeInput;
  /** ë°°ì¹˜ëœ ì‹œì‘ ì‹œê°„ (HH:mm) */
  start: string;
  /** ë°°ì¹˜ëœ ì¢…ë£Œ ì‹œê°„ (HH:mm) */
  end: string;
  /** ì¼ë¶€ë§Œ ë°°ì¹˜ë¨ (ë‹¤ìŒ ìŠ¬ë¡¯ì— ê³„ì†) */
  isPartial: boolean;
  /** ì´ì „ ìŠ¬ë¡¯ì—ì„œ ì´ì–´ì„œ ë°°ì¹˜ë¨ */
  isContinued: boolean;
  /** ì›ë˜ ì˜ˆìƒ ì†Œìš”ì‹œê°„ (ë¶„) */
  originalEstimatedTime: number;
};

/**
 * í”Œëœì„ í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì— ë°°ì¹˜
 *
 * Step7ì˜ TimeSlotsWithPlans ë¡œì§ê³¼ ë™ì¼
 *
 * @param plans - ë°°ì¹˜í•  í”Œëœ ëª©ë¡
 * @param studyTimeSlots - í•™ìŠµ ê°€ëŠ¥ ì‹œê°„ ìŠ¬ë¡¯
 * @param contentDurationMap - ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ë§µ
 * @param dayType - ì¼ ìœ í˜• ('í•™ìŠµì¼' | 'ë³µìŠµì¼' ë“±)
 * @param totalStudyHours - ì´ í•™ìŠµ ê°€ëŠ¥ ì‹œê°„ (ì‹œê°„ ë‹¨ìœ„)
 * @returns ì‹œê°„ì´ ë°°ì¹˜ëœ í”Œëœ ì„¸ê·¸ë¨¼íŠ¸ ë°°ì—´
 *
 * @example
 * ```typescript
 * const segments = assignPlanTimes(
 *   plans,
 *   [{ start: "09:00", end: "12:00" }, { start: "13:00", end: "18:00" }],
 *   contentDurationMap,
 *   "í•™ìŠµì¼",
 *   8
 * );
 * ```
 */
export function assignPlanTimes(
  plans: PlanTimeInput[],
  studyTimeSlots: StudyTimeSlot[],
  contentDurationMap: Map<string, ContentDurationInfo>,
  dayType: string,
  totalStudyHours: number
): PlanTimeSegment[] {
  // í”Œëœ ì •ë³´ ì¤€ë¹„
  const plansWithInfo = plans.map((plan) => {
    const estimatedTime = calculatePlanEstimatedTime(plan, contentDurationMap, dayType);
    return {
      plan,
      originalEstimatedTime: estimatedTime,
      estimatedTime, // ë°°ì¹˜ì— ì‚¬ìš©í•  ì‹œê°„
      remainingTime: estimatedTime, // ë‚¨ì€ ì‹œê°„ ì¶”ì 
      blockIndex: plan.block_index || 0,
    };
  });

  // ë³µìŠµì¼ì´ê³  ì˜ˆìƒ ì†Œìš”ì‹œê°„ì´ ì´ í•™ìŠµì‹œê°„ë³´ë‹¤ í° ê²½ìš° í‰ê·  ì‹œê°„ìœ¼ë¡œ ì¡°ì •
  const isReviewDay = dayType === "ë³µìŠµì¼";
  const totalEstimatedTime = plansWithInfo.reduce((sum, p) => sum + p.originalEstimatedTime, 0);
  const totalStudyMinutes = totalStudyHours * 60;

  if (isReviewDay && totalEstimatedTime > totalStudyMinutes && plans.length > 0) {
    // í‰ê·  ì‹œê°„ ê³„ì‚°
    const averageTime = Math.floor(totalStudyMinutes / plans.length);
    plansWithInfo.forEach((p) => {
      p.estimatedTime = averageTime;
      p.remainingTime = averageTime;
      // originalEstimatedTimeì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ê°•ì¡° í‘œì‹œìš©)
    });
  }

  // í”Œëœì„ block_index ìˆœìœ¼ë¡œ ì •ë ¬
  const sortedPlans = [...plansWithInfo].sort((a, b) => {
    return (a.blockIndex || 0) - (b.blockIndex || 0);
  });

  // ê° í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì— í”Œëœ ë°°ì¹˜
  const segments: PlanTimeSegment[] = [];

  studyTimeSlots.forEach((slot) => {
    const slotStart = timeToMinutes(slot.start);
    const slotEnd = timeToMinutes(slot.end);
    let currentTime = slotStart;

    // í”Œëœ ë°°ì¹˜
    for (const planInfo of sortedPlans) {
      if (planInfo.remainingTime <= 0) continue;

      const timeToUse = Math.min(planInfo.remainingTime, slotEnd - currentTime);
      if (timeToUse > 0) {
        const wasPartial = planInfo.remainingTime < planInfo.originalEstimatedTime;
        const willBePartial = planInfo.remainingTime > timeToUse;
        
        segments.push({
          plan: planInfo.plan,
          start: minutesToTime(currentTime),
          end: minutesToTime(currentTime + timeToUse),
          isPartial: willBePartial,
          isContinued: wasPartial,
          originalEstimatedTime: planInfo.originalEstimatedTime,
        });
        
        planInfo.remainingTime -= timeToUse;
        currentTime += timeToUse;

        if (currentTime >= slotEnd) break;
      }
    }
  });

  // ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
  segments.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));

  return segments;
}
</file>

<file path="blocks.ts">
import type { PlanGroup } from "@/lib/types/plan";
import type { SupabaseClientForStudentQuery } from "@/lib/supabase/clientSelector";
import { selectClientForBlockSetQuery } from "@/lib/supabase/clientSelector";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import type { PlanGroupAllowedRole } from "@/lib/auth/planGroupAuth";
import { PlanGroupError, PlanGroupErrorCodes, ErrorUserMessages } from "@/lib/errors/planGroupErrors";
import { logError } from "@/lib/errors/handler";
import { getCampTemplate } from "@/lib/data/campTemplates";

export type BlockInfo = {
  day_of_week: number;
  start_time: string;
  end_time: string;
};

export type BlockSetInfo = {
  id: string;
  name: string;
  blocks: Array<{
    id: string;
    day_of_week: number;
    start_time: string;
    end_time: string;
  }>;
};

/**
 * í”Œëœ ê·¸ë£¹ì— ë§ëŠ” ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * ì¡°íšŒ ìˆœì„œ:
 * 1. ìº í”„ ëª¨ë“œ: í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ (ì—°ê²° í…Œì´ë¸” â†’ í•˜ìœ„ í˜¸í™˜ì„± â†’ template_data)
 * 2. ì¼ë°˜ ëª¨ë“œ: í•™ìƒ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ (block_set_id â†’ active_block_set_id)
 *
 * ì—ëŸ¬ ì²˜ë¦¬:
 * - ìº í”„ ëª¨ë“œì—ì„œ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ PlanGroupErrorë¥¼ throwí•©ë‹ˆë‹¤.
 * - ì¼ë°˜ ëª¨ë“œì—ì„œ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í•˜ê³  ê²½ê³  ë¡œê·¸ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.
 *
 * @param group í”Œëœ ê·¸ë£¹ ê°ì²´
 * @param studentId í•™ìƒ ID
 * @param currentUserId í˜„ì¬ ì‚¬ìš©ì ID
 * @param role í˜„ì¬ ì‚¬ìš©ì ì—­í•  (student, admin, consultant ë“±)
 * @param tenantId í…Œë„ŒíŠ¸ ID (ìº í”„ ëª¨ë“œì—ì„œ í•„ìš”)
 * @returns ë¸”ë¡ ì •ë³´ ë°°ì—´ (day_of_week, start_time, end_time í¬í•¨)
 * @throws PlanGroupError - ìº í”„ ëª¨ë“œì—ì„œ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
 *
 * @example
 * ```typescript
 * // ìº í”„ ëª¨ë“œ
 * const blocks = await getBlockSetForPlanGroup(
 *   { plan_type: "camp", camp_template_id: "template-123", ... },
 *   "student-id",
 *   "user-id",
 *   "student",
 *   "tenant-id"
 * );
 *
 * // ì¼ë°˜ ëª¨ë“œ
 * const blocks = await getBlockSetForPlanGroup(
 *   { plan_type: "individual", block_set_id: "block-set-123", ... },
 *   "student-id",
 *   "user-id",
 *   "student"
 * );
 * ```
 */
export async function getBlockSetForPlanGroup(
  group: PlanGroup,
  studentId: string,
  currentUserId: string,
  role: PlanGroupAllowedRole,
  tenantId?: string | null
): Promise<BlockInfo[]> {
  let baseBlocks: BlockInfo[] = [];

  // ìº í”„ ëª¨ë“œ: í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
  if (group.plan_type === "camp" && group.camp_template_id) {
    const templateBlocks = await getTemplateBlockSet(
      group.camp_template_id,
      tenantId
    );
    if (templateBlocks && templateBlocks.length > 0) {
      baseBlocks = templateBlocks;
    }
  }

  // ì¼ë°˜ ëª¨ë“œ: í•™ìƒ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
  if (baseBlocks.length === 0 && group.block_set_id) {
    const studentBlocks = await getStudentBlockSet(
      group.block_set_id,
      studentId,
      currentUserId,
      role
    );
    if (studentBlocks && studentBlocks.length > 0) {
      baseBlocks = studentBlocks;
    }
  }

  // ê¸°ë³¸ ë¸”ë¡ ì„¸íŠ¸ ì‚¬ìš© (ìº í”„ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
  if (baseBlocks.length === 0 && group.plan_type !== "camp") {
    const activeBlocks = await getActiveBlockSet(
      studentId,
      currentUserId,
      role
    );
    if (activeBlocks && activeBlocks.length > 0) {
      baseBlocks = activeBlocks;
    }
  }

  // ëª¨ë“  ì¡°íšŒ ë°©ë²•ì´ ì‹¤íŒ¨í•œ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬
  if (baseBlocks.length === 0) {
    const errorContext = {
      groupId: group.id,
      studentId,
      planType: group.plan_type,
      campTemplateId: group.camp_template_id,
      blockSetId: group.block_set_id,
      tenantId,
    };
    
    // ìº í”„ ëª¨ë“œì—ì„œ ë¸”ë¡ ì„¸íŠ¸ê°€ í•„ìˆ˜ì¸ ê²½ìš° ì—ëŸ¬ throw
    if (group.plan_type === "camp") {
      const error = new PlanGroupError(
        `ìº í”„ í…œí”Œë¦¿(${group.camp_template_id})ì— ì—°ê²°ëœ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
        PlanGroupErrorCodes.BLOCK_SET_NOT_FOUND,
        ErrorUserMessages[PlanGroupErrorCodes.BLOCK_SET_NOT_FOUND],
        false,
        errorContext
      );
      logError(error, {
        function: "getBlockSetForPlanGroup",
        ...errorContext,
      });
      throw error;
    }
    
    // ì¼ë°˜ ëª¨ë“œì—ì„œë„ ë¸”ë¡ ì„¸íŠ¸ê°€ ì—†ìœ¼ë©´ ê²½ê³  (ë¹ˆ ë°°ì—´ ë°˜í™˜)
    logError(
      new Error("ë¸”ë¡ ì„¸íŠ¸ê°€ ì—†ì–´ ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤."),
      {
        function: "getBlockSetForPlanGroup",
        level: "warn",
        ...errorContext,
      }
    );
  }

  return baseBlocks;
}

/**
 * í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * ì¡°íšŒ ìˆœì„œ:
 * 1. ì—°ê²° í…Œì´ë¸”(camp_template_block_sets)ì—ì„œ í…œí”Œë¦¿ì— ì—°ê²°ëœ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
 * 2. í•˜ìœ„ í˜¸í™˜ì„±: template_data.block_set_id í™•ì¸ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°ì´í„°ìš©)
 * 3. tenant_blocksì—ì„œ ì‹¤ì œ ë¸”ë¡ ì •ë³´ ì¡°íšŒ
 *
 * @param templateId ìº í”„ í…œí”Œë¦¿ ID
 * @param tenantId í…Œë„ŒíŠ¸ ID (ì„ íƒì‚¬í•­)
 * @returns ë¸”ë¡ ì •ë³´ ë°°ì—´ ë˜ëŠ” null (ì¡°íšŒ ì‹¤íŒ¨ ì‹œ)
 */
async function getTemplateBlockSet(
  templateId: string,
  tenantId?: string | null
): Promise<BlockInfo[] | null> {
  const supabase = await createSupabaseServerClient();

  // 1. ì—°ê²° í…Œì´ë¸”ì—ì„œ í…œí”Œë¦¿ì— ì—°ê²°ëœ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
  const { data: templateBlockSetLink } = await supabase
    .from("camp_template_block_sets")
    .select("tenant_block_set_id")
    .eq("camp_template_id", templateId)
    .maybeSingle();

  let templateBlockSetId: string | null = null;
  if (templateBlockSetLink) {
    templateBlockSetId = templateBlockSetLink.tenant_block_set_id;
  } else {
    // 2. í•˜ìœ„ í˜¸í™˜ì„±: template_data.block_set_id í™•ì¸ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°ì´í„°ìš©)
    const template = await getCampTemplate(templateId);
    if (template?.template_data?.block_set_id) {
      templateBlockSetId = template.template_data.block_set_id;
    }
  }

  if (!templateBlockSetId) {
    return null;
  }

  // 3. tenant_blocksì—ì„œ ë¸”ë¡ ì¡°íšŒ
  const { data: blockRows, error: blocksError } = await supabase
    .from("tenant_blocks")
    .select("day_of_week, start_time, end_time")
    .eq("tenant_block_set_id", templateBlockSetId)
    .order("day_of_week", { ascending: true })
    .order("start_time", { ascending: true });

  if (blocksError) {
    const errorContext = {
      templateId,
      templateBlockSetId,
      error: blocksError.message,
      code: blocksError.code,
      details: blocksError.details,
      hint: blocksError.hint,
    };
    logError(blocksError, {
      function: "getTemplateBlockSet",
      ...errorContext,
    });
    // ë¸”ë¡ ì¡°íšŒ ì‹¤íŒ¨ëŠ” null ë°˜í™˜ (ìƒìœ„ì—ì„œ ì²˜ë¦¬)
    return null;
  }

  if (!blockRows || blockRows.length === 0) {
    return null;
  }

  return blockRows.map((b) => ({
    day_of_week: b.day_of_week || 0,
    start_time: b.start_time || "00:00",
    end_time: b.end_time || "00:00",
  }));
}

/**
 * í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * ì¡°íšŒ ìˆœì„œ:
 * 1. ì—°ê²° í…Œì´ë¸”(camp_template_block_sets)ì—ì„œ ì§ì ‘ ì¡°íšŒ
 * 2. scheduler_options.template_block_set_id í™•ì¸ (Fallback)
 * 3. template_data.block_set_id í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
 *
 * ì´ í•¨ìˆ˜ëŠ” ë¸”ë¡ ì„¸íŠ¸ IDë§Œ ë°˜í™˜í•˜ë©°, ì‹¤ì œ ë¸”ë¡ ì •ë³´ëŠ” ì¡°íšŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 * ë¸”ë¡ ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš° `getTemplateBlockSet` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
 *
 * @param templateId ìº í”„ í…œí”Œë¦¿ ID
 * @param schedulerOptions scheduler_options ê°ì²´ (Fallbackìš©, ì„ íƒì‚¬í•­)
 * @param tenantId í…Œë„ŒíŠ¸ ID (ì„ íƒì‚¬í•­)
 * @returns tenant_block_set_id ë˜ëŠ” null (ì¡°íšŒ ì‹¤íŒ¨ ì‹œ)
 *
 * @example
 * ```typescript
 * const blockSetId = await getTemplateBlockSetId(
 *   "template-123",
 *   { template_block_set_id: "fallback-id" }, // Fallbackìš©
 *   "tenant-id"
 * );
 * ```
 */
export async function getTemplateBlockSetId(
  templateId: string,
  schedulerOptions?: Record<string, any> | null,
  tenantId?: string | null
): Promise<string | null> {
  const supabase = await createSupabaseServerClient();

  // 1. ì—°ê²° í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ
  const { data: templateBlockSetLink, error: linkError } = await supabase
    .from("camp_template_block_sets")
    .select("tenant_block_set_id")
    .eq("camp_template_id", templateId)
    .maybeSingle();

  if (linkError) {
    logError(linkError, {
      function: "getTemplateBlockSetId",
      templateId,
      code: linkError.code,
      details: linkError.details,
      hint: linkError.hint,
      level: "warn", // ì—°ê²° í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê²½ê³  ë ˆë²¨
    });
    // ì—°ê²° í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ fallbackìœ¼ë¡œ ì§„í–‰
  } else if (templateBlockSetLink) {
    return templateBlockSetLink.tenant_block_set_id;
  }

  // 2. scheduler_optionsì—ì„œ template_block_set_id í™•ì¸ (Fallback)
  if (schedulerOptions?.template_block_set_id) {
    return schedulerOptions.template_block_set_id;
  }

  // 3. template_dataì—ì„œ block_set_id í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
  const template = await getCampTemplate(templateId);
  if (template?.template_data) {
    try {
      let templateData: { block_set_id?: string } | null = null;
      if (typeof template.template_data === "string") {
        templateData = JSON.parse(template.template_data) as { block_set_id?: string };
      } else {
        templateData = template.template_data as { block_set_id?: string };
      }

      if (templateData?.block_set_id) {
        return templateData.block_set_id;
      }
    } catch (parseError) {
      logError(parseError, {
        function: "getTemplateBlockSetId",
        templateId,
        level: "warn", // íŒŒì‹± ì—ëŸ¬ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ê²½ê³  ë ˆë²¨
      });
      // íŒŒì‹± ì—ëŸ¬ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ null ë°˜í™˜
    }
  }

  // ëª¨ë“  ì¡°íšŒ ë°©ë²•ì´ ì‹¤íŒ¨í•œ ê²½ìš° null ë°˜í™˜ (ì •ìƒì ì¸ ê²½ìš°ì¼ ìˆ˜ ìˆìŒ)
  // í•˜ì§€ë§Œ ë¡œê¹…ì€ ê°•í™”
  logError(
    new Error("í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
    {
      function: "getTemplateBlockSetId",
      templateId,
      tenantId,
      hasSchedulerOptions: !!schedulerOptions,
      level: "warn",
    }
  );
  
  return null;
}

/**
 * í•™ìƒ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 */
/**
 * í•™ìƒ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * ë¸”ë¡ ì„¸íŠ¸ ì†Œìœ ìë¥¼ í™•ì¸í•œ í›„, í•´ë‹¹ í•™ìƒì˜ ë¸”ë¡ ìŠ¤ì¼€ì¤„ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
 * ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ê°€ ë‹¤ë¥¸ í•™ìƒ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ê²½ìš° Admin í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * @param blockSetId ë¸”ë¡ ì„¸íŠ¸ ID
 * @param studentId í•™ìƒ ID
 * @param currentUserId í˜„ì¬ ì‚¬ìš©ì ID
 * @param role í˜„ì¬ ì‚¬ìš©ì ì—­í• 
 * @returns ë¸”ë¡ ì •ë³´ ë°°ì—´ ë˜ëŠ” null (ì¡°íšŒ ì‹¤íŒ¨ ì‹œ)
 */
async function getStudentBlockSet(
  blockSetId: string,
  studentId: string,
  currentUserId: string,
  role: PlanGroupAllowedRole
): Promise<BlockInfo[] | null> {
  // ì ì ˆí•œ í´ë¼ì´ì–¸íŠ¸ ì„ íƒ (ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ê°€ ë‹¤ë¥¸ í•™ìƒ ë°ì´í„° ì¡°íšŒ ì‹œ Admin í´ë¼ì´ì–¸íŠ¸)
  const isAdminOrConsultant = role === "admin" || role === "consultant";
  const queryClient = await selectClientForBlockSetQuery(
    studentId,
    currentUserId,
    isAdminOrConsultant
  );

  if (!queryClient) {
    throw new Error("ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // ë¸”ë¡ ì„¸íŠ¸ ì†Œìœ ì í™•ì¸
  const { data: blockSet } = await queryClient
    .from("student_block_sets")
    .select("id, name, student_id")
    .eq("id", blockSetId)
    .maybeSingle();

  if (!blockSet) {
    return null;
  }

  const blockSetOwnerId = blockSet.student_id;

  // ë¸”ë¡ ì¡°íšŒ
  const { data: blockRows, error: blocksError } = await queryClient
    .from("student_block_schedule")
    .select("day_of_week, start_time, end_time")
    .eq("block_set_id", blockSetId)
    .eq("student_id", blockSetOwnerId)
    .order("day_of_week", { ascending: true })
    .order("start_time", { ascending: true });

  if (blocksError) {
    logError(blocksError, {
      function: "getStudentBlockSet",
      blockSetId,
      studentId,
    });
    return null;
  }

  if (!blockRows || blockRows.length === 0) {
    return null;
  }

  return blockRows.map((b) => ({
    day_of_week: b.day_of_week || 0,
    start_time: b.start_time || "00:00",
    end_time: b.end_time || "00:00",
  }));
}

/**
 * í•™ìƒì˜ í™œì„± ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 *
 * í•™ìƒì˜ `active_block_set_id`ë¥¼ í™•ì¸í•œ í›„, í•´ë‹¹ ë¸”ë¡ ì„¸íŠ¸ì˜ ë¸”ë¡ ìŠ¤ì¼€ì¤„ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
 * ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ê°€ ë‹¤ë¥¸ í•™ìƒ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ê²½ìš° Admin í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
 *
 * @param studentId í•™ìƒ ID
 * @param currentUserId í˜„ì¬ ì‚¬ìš©ì ID
 * @param role í˜„ì¬ ì‚¬ìš©ì ì—­í• 
 * @returns ë¸”ë¡ ì •ë³´ ë°°ì—´ ë˜ëŠ” null (í™œì„± ë¸”ë¡ ì„¸íŠ¸ê°€ ì—†ê±°ë‚˜ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ)
 */
async function getActiveBlockSet(
  studentId: string,
  currentUserId: string,
  role: PlanGroupAllowedRole
): Promise<BlockInfo[] | null> {
  // ì ì ˆí•œ í´ë¼ì´ì–¸íŠ¸ ì„ íƒ
  const isAdminOrConsultant = role === "admin" || role === "consultant";
  const queryClient = await selectClientForBlockSetQuery(
    studentId,
    currentUserId,
    isAdminOrConsultant
  );

  if (!queryClient) {
    throw new Error("ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // í•™ìƒì˜ í™œì„± ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ
  const { data: student } = await queryClient
    .from("students")
    .select("active_block_set_id")
    .eq("id", studentId)
    .maybeSingle();

  if (!student?.active_block_set_id) {
    return null;
  }

  // í™œì„± ë¸”ë¡ ì„¸íŠ¸ì˜ ë¸”ë¡ ì¡°íšŒ
  const { data: blockRows, error: blocksError } = await queryClient
    .from("student_block_schedule")
    .select("day_of_week, start_time, end_time")
    .eq("block_set_id", student.active_block_set_id)
    .eq("student_id", studentId)
    .order("day_of_week", { ascending: true })
    .order("start_time", { ascending: true });

  if (blocksError) {
    logError(blocksError, {
      function: "getActiveBlockSet",
      studentId,
      activeBlockSetId: student.active_block_set_id,
    });
    return null;
  }

  if (!blockRows || blockRows.length === 0) {
    return null;
  }

  return blockRows.map((b) => ({
    day_of_week: b.day_of_week || 0,
    start_time: b.start_time || "00:00",
    end_time: b.end_time || "00:00",
  }));
}

/**
 * ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * í”Œëœ ê·¸ë£¹ì˜ íƒ€ì…(ìº í”„ ëª¨ë“œ/ì¼ë°˜ ëª¨ë“œ)ì— ë”°ë¼ ì ì ˆí•œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 *
 * @param group í”Œëœ ê·¸ë£¹ ê°ì²´
 * @param hasBlocks ë¸”ë¡ì´ ì¡´ì¬í•˜ëŠ”ì§€ ì—¬ë¶€ (í˜„ì¬ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
 * @returns ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ì—ëŸ¬ ë©”ì‹œì§€
 */
export function getBlockSetErrorMessage(
  group: PlanGroup,
  hasBlocks: boolean
): string {
  if (group.plan_type === "camp") {
    return hasBlocks
      ? "í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, í…œí”Œë¦¿ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”."
      : "í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, í…œí”Œë¦¿ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.";
  }

  return hasBlocks
    ? "ë¸”ë¡ ì„¸íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, í™œì„± ë¸”ë¡ ì„¸íŠ¸ì— ë“±ë¡ëœ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„¤ì •í•˜ê³  ë¸”ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”."
    : "ë¸”ë¡ ì„¸íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, í™œì„± ë¸”ë¡ ì„¸íŠ¸ì— ë“±ë¡ëœ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì„¤ì •í•˜ê³  ë¸”ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.";
}
</file>

<file path="contentResolver.ts">
/**
 * ì½˜í…ì¸  ë¦¬ì¡¸ë²„
 *
 * í”Œëœ ìƒì„±/ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì½˜í…ì¸  ê´€ë ¨ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
 * - ë§ˆìŠ¤í„° ì½˜í…ì¸  â†’ í•™ìƒ ì½˜í…ì¸  ID ë§¤í•‘
 * - ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ì¡°íšŒ (ì œëª©, ê³¼ëª©, ì¹´í…Œê³ ë¦¬)
 * - ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ì¡°íšŒ
 *
 * @module lib/plan/contentResolver
 */

import type { SupabaseClient } from "@supabase/supabase-js";
import type { PlanContent } from "@/lib/types/plan";
import type {
  ContentIdMap,
  ContentMetadataMap,
  ContentDurationMap,
  ContentSubjectsMap,
  ContentResolutionResult,
} from "@/lib/types/plan-generation";

// ============================================
// íƒ€ì… ì •ì˜
// ============================================

// eslint-disable-next-line @typescript-eslint/no-explicit-any
type SupabaseAnyClient = SupabaseClient<any>;

// ============================================
// ì½˜í…ì¸  ID ë§¤í•‘ í•¨ìˆ˜
// ============================================

/**
 * ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ í•™ìƒ ì½˜í…ì¸  IDë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.
 *
 * @param contents í”Œëœ ì½˜í…ì¸  ë°°ì—´
 * @param studentId í•™ìƒ ID
 * @param queryClient í•™ìƒìš© Supabase í´ë¼ì´ì–¸íŠ¸
 * @param masterQueryClient ë§ˆìŠ¤í„° ì¡°íšŒìš© Supabase í´ë¼ì´ì–¸íŠ¸
 * @returns ì½˜í…ì¸  ID ë§¤í•‘
 */
export async function resolveContentIds(
  contents: PlanContent[],
  studentId: string,
  queryClient: SupabaseAnyClient,
  masterQueryClient: SupabaseAnyClient
): Promise<ContentIdMap> {
  const contentIdMap: ContentIdMap = new Map();

  // ì½˜í…ì¸  íƒ€ì…ë³„ë¡œ ë¶„ë¥˜
  const bookContents = contents.filter((c) => c.content_type === "book");
  const lectureContents = contents.filter((c) => c.content_type === "lecture");
  const customContents = contents.filter((c) => c.content_type === "custom");

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  í™•ì¸ (ë³‘ë ¬)
  type MasterCheckResult = { content: PlanContent; isMaster: boolean };

  const masterBookQueries = bookContents.map(async (content): Promise<MasterCheckResult> => {
    try {
      const result = await masterQueryClient
        .from("master_books")
        .select("id")
        .eq("id", content.content_id)
        .maybeSingle();
      return { content, isMaster: !!result.data };
    } catch {
      return { content, isMaster: false };
    }
  });

  const masterLectureQueries = lectureContents.map(async (content): Promise<MasterCheckResult> => {
    try {
      const result = await masterQueryClient
        .from("master_lectures")
        .select("id")
        .eq("id", content.content_id)
        .maybeSingle();
      return { content, isMaster: !!result.data };
    } catch {
      return { content, isMaster: false };
    }
  });

  const [masterBookResults, masterLectureResults] = await Promise.all([
    Promise.all(masterBookQueries),
    Promise.all(masterLectureQueries),
  ]);

  // í•™ìƒ ì½˜í…ì¸  í™•ì¸ (ë³‘ë ¬)
  type StudentContentResult = { content: PlanContent; studentContentId: string };

  const studentBookQueries = masterBookResults
    .filter((r) => r.isMaster)
    .map(async ({ content }): Promise<StudentContentResult> => {
      try {
        const result = await queryClient
          .from("books")
          .select("id")
          .eq("student_id", studentId)
          .eq("master_content_id", content.content_id)
          .maybeSingle();
        return {
          content,
          studentContentId: result.data?.id || content.content_id,
        };
      } catch {
        return { content, studentContentId: content.content_id };
      }
    });

  const studentLectureQueries = masterLectureResults
    .filter((r) => r.isMaster)
    .map(async ({ content }): Promise<StudentContentResult> => {
      try {
        const result = await queryClient
          .from("lectures")
          .select("id")
          .eq("student_id", studentId)
          .eq("master_content_id", content.content_id)
          .maybeSingle();
        return {
          content,
          studentContentId: result.data?.id || content.content_id,
        };
      } catch {
        return { content, studentContentId: content.content_id };
      }
    });

  const [studentBookResults, studentLectureResults] = await Promise.all([
    Promise.all(studentBookQueries),
    Promise.all(studentLectureQueries),
  ]);

  // contentIdMap êµ¬ì„±
  masterBookResults
    .filter((r) => !r.isMaster)
    .forEach(({ content }) => {
      contentIdMap.set(content.content_id, content.content_id);
    });

  masterLectureResults
    .filter((r) => !r.isMaster)
    .forEach(({ content }) => {
      contentIdMap.set(content.content_id, content.content_id);
    });

  studentBookResults.forEach(({ content, studentContentId }) => {
    contentIdMap.set(content.content_id, studentContentId);
  });

  studentLectureResults.forEach(({ content, studentContentId }) => {
    contentIdMap.set(content.content_id, studentContentId);
  });

  customContents.forEach((content) => {
    contentIdMap.set(content.content_id, content.content_id);
  });

  return contentIdMap;
}

// ============================================
// ì½˜í…ì¸  ë©”íƒ€ë°ì´í„° ë¡œë”© í•¨ìˆ˜
// ============================================

type ContentMetadataResult = {
  title?: string | null;
  subject?: string | null;
  subject_category?: string | null;
  category?: string | null;
};

/**
 * ì½˜í…ì¸  ë©”íƒ€ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤ (ì œëª©, ê³¼ëª©, ì¹´í…Œê³ ë¦¬).
 */
export async function loadContentMetadata(
  contents: PlanContent[],
  contentIdMap: ContentIdMap,
  studentId: string,
  queryClient: SupabaseAnyClient,
  masterQueryClient: SupabaseAnyClient
): Promise<ContentMetadataMap> {
  const contentMetadataMap: ContentMetadataMap = new Map();

  for (const content of contents) {
    const finalContentId =
      contentIdMap.get(content.content_id) || content.content_id;

    let metadata: ContentMetadataResult | null = null;

    if (content.content_type === "book") {
      metadata = await loadBookMetadata(
        content.content_id,
        finalContentId,
        content.master_content_id,
        studentId,
        queryClient,
        masterQueryClient
      );
    } else if (content.content_type === "lecture") {
      metadata = await loadLectureMetadata(
        content.content_id,
        finalContentId,
        content.master_content_id,
        studentId,
        queryClient,
        masterQueryClient
      );
    } else if (content.content_type === "custom") {
      metadata = await loadCustomContentMetadata(
        finalContentId,
        studentId,
        queryClient
      );
    }

    if (metadata) {
      contentMetadataMap.set(content.content_id, metadata);
    }
  }

  return contentMetadataMap;
}

async function loadBookMetadata(
  contentId: string,
  finalContentId: string,
  masterContentId: string | null | undefined,
  studentId: string,
  queryClient: SupabaseAnyClient,
  masterQueryClient: SupabaseAnyClient
): Promise<ContentMetadataResult | null> {
  // í•™ìƒ êµì¬ ì¡°íšŒ
  const { data: book } = await queryClient
    .from("books")
    .select("title, subject, subject_category, master_content_id")
    .eq("id", finalContentId)
    .eq("student_id", studentId)
    .maybeSingle();

  if (book) {
    return {
      title: book.title || null,
      subject: book.subject || null,
      subject_category: book.subject_category || null,
      category: null,
    };
  }

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¡œ í•™ìƒ êµì¬ ì°¾ê¸°
  const actualMasterContentId = masterContentId || contentId;
  const { data: bookByMaster } = await queryClient
    .from("books")
    .select("title, subject, subject_category")
    .eq("student_id", studentId)
    .eq("master_content_id", actualMasterContentId)
    .maybeSingle();

  if (bookByMaster) {
    return {
      title: bookByMaster.title || null,
      subject: bookByMaster.subject || null,
      subject_category: bookByMaster.subject_category || null,
      category: null,
    };
  }

  // ë§ˆìŠ¤í„° êµì¬ ì¡°íšŒ
  const { data: masterBook } = await masterQueryClient
    .from("master_books")
    .select("title, subject, subject_category, content_category")
    .eq("id", actualMasterContentId)
    .maybeSingle();

  if (masterBook) {
    return {
      title: masterBook.title || null,
      subject: masterBook.subject || null,
      subject_category: masterBook.subject_category || null,
      category: masterBook.content_category || null,
    };
  }

  return null;
}

async function loadLectureMetadata(
  contentId: string,
  finalContentId: string,
  masterContentId: string | null | undefined,
  studentId: string,
  queryClient: SupabaseAnyClient,
  masterQueryClient: SupabaseAnyClient
): Promise<ContentMetadataResult | null> {
  // í•™ìƒ ê°•ì˜ ì¡°íšŒ
  const { data: lecture } = await queryClient
    .from("lectures")
    .select("title, subject, subject_category, master_content_id")
    .eq("id", finalContentId)
    .eq("student_id", studentId)
    .maybeSingle();

  if (lecture) {
    return {
      title: lecture.title || null,
      subject: lecture.subject || null,
      subject_category: lecture.subject_category || null,
      category: null,
    };
  }

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¡œ í•™ìƒ ê°•ì˜ ì°¾ê¸°
  const actualMasterContentId = masterContentId || contentId;
  const { data: lectureByMaster } = await queryClient
    .from("lectures")
    .select("title, subject, subject_category")
    .eq("student_id", studentId)
    .eq("master_content_id", actualMasterContentId)
    .maybeSingle();

  if (lectureByMaster) {
    return {
      title: lectureByMaster.title || null,
      subject: lectureByMaster.subject || null,
      subject_category: lectureByMaster.subject_category || null,
      category: null,
    };
  }

  // ë§ˆìŠ¤í„° ê°•ì˜ ì¡°íšŒ
  const { data: masterLecture } = await masterQueryClient
    .from("master_lectures")
    .select("title, subject, subject_category, content_category")
    .eq("id", actualMasterContentId)
    .maybeSingle();

  if (masterLecture) {
    return {
      title: masterLecture.title || null,
      subject: masterLecture.subject || null,
      subject_category: masterLecture.subject_category || null,
      category: masterLecture.content_category || null,
    };
  }

  return null;
}

async function loadCustomContentMetadata(
  finalContentId: string,
  studentId: string,
  queryClient: SupabaseAnyClient
): Promise<ContentMetadataResult | null> {
  const { data: customContent } = await queryClient
    .from("student_custom_contents")
    .select("title, subject, subject_category, content_category")
    .eq("id", finalContentId)
    .eq("student_id", studentId)
    .maybeSingle();

  if (customContent) {
    return {
      title: customContent.title || null,
      subject: customContent.subject || null,
      subject_category: customContent.subject_category || null,
      category: customContent.content_category || null,
    };
  }

  return null;
}

// ============================================
// ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ë¡œë”© í•¨ìˆ˜
// ============================================

/**
 * ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ì •ë³´ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
 */
export async function loadContentDurations(
  contents: PlanContent[],
  contentIdMap: ContentIdMap,
  studentId: string,
  queryClient: SupabaseAnyClient,
  masterQueryClient: SupabaseAnyClient
): Promise<ContentDurationMap> {
  const contentDurationMap: ContentDurationMap = new Map();

  // ì½˜í…ì¸  íƒ€ì…ë³„ë¡œ ë¶„ë¥˜
  const bookContents = contents.filter((c) => c.content_type === "book");
  const lectureContents = contents.filter((c) => c.content_type === "lecture");
  const customContents = contents.filter((c) => c.content_type === "custom");

  // í•™ìƒ ì½˜í…ì¸  ì¡°íšŒ (ë³‘ë ¬)
  type BookDurationResult = {
    content: PlanContent;
    studentBook: { id: string; total_pages: number | null; master_content_id: string | null } | null;
  };
  type LectureDurationResult = {
    content: PlanContent;
    studentLecture: { id: string; duration: number | null; master_content_id: string | null } | null;
  };
  type CustomDurationResult = {
    content: PlanContent;
    customContent: { id: string; total_page_or_time: number | null } | null;
  };

  const bookDurationQueries = bookContents.map(async (content): Promise<BookDurationResult> => {
    const finalContentId = contentIdMap.get(content.content_id) || content.content_id;
    try {
      const result = await queryClient
        .from("books")
        .select("id, total_pages, master_content_id")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();
      return { content, studentBook: result.data };
    } catch {
      return { content, studentBook: null };
    }
  });

  const lectureDurationQueries = lectureContents.map(async (content): Promise<LectureDurationResult> => {
    const finalContentId = contentIdMap.get(content.content_id) || content.content_id;
    try {
      const result = await queryClient
        .from("lectures")
        .select("id, duration, master_content_id")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();
      return { content, studentLecture: result.data };
    } catch {
      return { content, studentLecture: null };
    }
  });

  const customDurationQueries = customContents.map(async (content): Promise<CustomDurationResult> => {
    const finalContentId = contentIdMap.get(content.content_id) || content.content_id;
    try {
      const result = await queryClient
        .from("student_custom_contents")
        .select("id, total_page_or_time")
        .eq("id", finalContentId)
        .eq("student_id", studentId)
        .maybeSingle();
      return { content, customContent: result.data };
    } catch {
      return { content, customContent: null };
    }
  });

  const [bookResults, lectureResults, customResults] = await Promise.all([
    Promise.all(bookDurationQueries),
    Promise.all(lectureDurationQueries),
    Promise.all(customDurationQueries),
  ]);

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  ì¡°íšŒê°€ í•„ìš”í•œ í•­ëª© ìˆ˜ì§‘
  type MasterBookResult = { content: PlanContent; masterBook: { id: string; total_pages: number | null } | null };
  type MasterLectureResult = { content: PlanContent; masterLecture: { id: string; total_duration: number | null } | null };

  const masterBookQueries: Promise<MasterBookResult>[] = [];
  const masterLectureQueries: Promise<MasterLectureResult>[] = [];

  // í•™ìƒ êµì¬ ê²°ê³¼ ì²˜ë¦¬
  for (const { content, studentBook } of bookResults) {
    if (studentBook?.total_pages) {
      contentDurationMap.set(content.content_id, {
        content_type: "book",
        content_id: content.content_id,
        total_pages: studentBook.total_pages,
      });
    } else if (studentBook?.master_content_id) {
      const masterId = studentBook.master_content_id;
      masterBookQueries.push(
        (async (): Promise<MasterBookResult> => {
          try {
            const result = await masterQueryClient
              .from("master_books")
              .select("id, total_pages")
              .eq("id", masterId)
              .maybeSingle();
            return { content, masterBook: result.data };
          } catch {
            return { content, masterBook: null };
          }
        })()
      );
    }
  }

  // í•™ìƒ ê°•ì˜ ê²°ê³¼ ì²˜ë¦¬
  for (const { content, studentLecture } of lectureResults) {
    if (studentLecture?.duration) {
      contentDurationMap.set(content.content_id, {
        content_type: "lecture",
        content_id: content.content_id,
        duration: studentLecture.duration,
      });
    } else if (studentLecture?.master_content_id) {
      const masterId = studentLecture.master_content_id;
      masterLectureQueries.push(
        (async (): Promise<MasterLectureResult> => {
          try {
            const result = await masterQueryClient
              .from("master_lectures")
              .select("id, total_duration")
              .eq("id", masterId)
              .maybeSingle();
            return { content, masterLecture: result.data };
          } catch {
            return { content, masterLecture: null };
          }
        })()
      );
    }
  }

  // ì»¤ìŠ¤í…€ ì½˜í…ì¸  ê²°ê³¼ ì²˜ë¦¬
  for (const { content, customContent } of customResults) {
    if (customContent?.total_page_or_time) {
      contentDurationMap.set(content.content_id, {
        content_type: "custom",
        content_id: content.content_id,
        total_page_or_time: customContent.total_page_or_time,
      });
    }
  }

  // ë§ˆìŠ¤í„° ì½˜í…ì¸  ì¡°íšŒ (ë³‘ë ¬)
  if (masterBookQueries.length > 0 || masterLectureQueries.length > 0) {
    const [masterBookResults, masterLectureResults] = await Promise.all([
      Promise.all(masterBookQueries),
      Promise.all(masterLectureQueries),
    ]);

    for (const { content, masterBook } of masterBookResults) {
      if (masterBook?.total_pages) {
        contentDurationMap.set(content.content_id, {
          content_type: "book",
          content_id: content.content_id,
          total_pages: masterBook.total_pages,
        });
      }
    }

    for (const { content, masterLecture } of masterLectureResults) {
      if (masterLecture?.total_duration) {
        contentDurationMap.set(content.content_id, {
          content_type: "lecture",
          content_id: content.content_id,
          duration: masterLecture.total_duration,
        });
      }
    }
  }

  return contentDurationMap;
}

// ============================================
// í†µí•© í•¨ìˆ˜
// ============================================

/**
 * ì½˜í…ì¸  ê´€ë ¨ ëª¨ë“  ë°ì´í„°ë¥¼ í•´ì„í•©ë‹ˆë‹¤.
 */
export async function resolveAllContentData(
  contents: PlanContent[],
  studentId: string,
  queryClient: SupabaseAnyClient,
  masterQueryClient: SupabaseAnyClient
): Promise<ContentResolutionResult> {
  // 1. ì½˜í…ì¸  ID ë§¤í•‘
  const contentIdMap = await resolveContentIds(
    contents,
    studentId,
    queryClient,
    masterQueryClient
  );

  // 2. ë©”íƒ€ë°ì´í„° ë° ì†Œìš”ì‹œê°„ ë¡œë“œ (ë³‘ë ¬)
  const [contentMetadataMap, contentDurationMap] = await Promise.all([
    loadContentMetadata(
      contents,
      contentIdMap,
      studentId,
      queryClient,
      masterQueryClient
    ),
    loadContentDurations(
      contents,
      contentIdMap,
      studentId,
      queryClient,
      masterQueryClient
    ),
  ]);

  // 3. ì½˜í…ì¸  ê³¼ëª© ë§µ ìƒì„± (ë©”íƒ€ë°ì´í„°ì—ì„œ ì¶”ì¶œ)
  const contentSubjects: ContentSubjectsMap = new Map();
  contentMetadataMap.forEach((metadata, contentId) => {
    contentSubjects.set(contentId, {
      subject: metadata.subject,
      subject_category: metadata.subject_category,
    });
  });

  return {
    contentIdMap,
    contentMetadataMap,
    contentDurationMap,
    contentSubjects,
  };
}
</file>

<file path="planDataLoader.ts">
/**
 * í”Œëœ ë°ì´í„° ë¡œë”
 *
 * í”Œëœ ìƒì„±/ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë°ì´í„° ë¡œë”© ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
 *
 * @module lib/plan/planDataLoader
 */

import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getPlanGroupWithDetailsByRole } from "@/lib/auth/planGroupAuth";
import { getBlockSetForPlanGroup } from "@/lib/plan/blocks";
import { getMergedSchedulerSettings } from "@/lib/data/schedulerSettings";
import { calculateAvailableDates } from "@/lib/scheduler/calculateAvailableDates";
import type {
  LoadedPlanGroupData,
  ScheduleCalculationResult,
  DateAvailableTimeRangesMap,
  DateTimeSlotsMap,
  DateMetadataMap,
  WeekDatesMap,
} from "@/lib/types/plan-generation";
import type { PlanGroup, NonStudyTimeBlock } from "@/lib/types/plan";
import { validateAllocations } from "@/lib/utils/subjectAllocation";

// ============================================
// íƒ€ì… ì •ì˜
// ============================================

/**
 * ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜ (ë³‘í•©ëœ)
 */
export type MergedSchedulerOptions = {
  study_days: number;
  review_days: number;
  weak_subject_focus?: "low" | "medium" | "high" | boolean;
  review_scope?: string;
  lunch_time?: { start: string; end: string };
  camp_study_hours?: { start: string; end: string };
  self_study_hours?: { start: string; end: string };
};

/**
 * ê¸°ë³¸ ë¸”ë¡ ì •ë³´
 */
export type BaseBlock = {
  day_of_week: number;
  start_time: string;
  end_time: string;
};

/**
 * ìŠ¤ì¼€ì¤„ ê³„ì‚° ì˜µì…˜
 */
export type ScheduleCalculationOptions = {
  scheduler_type: string;
  scheduler_options: Record<string, unknown> | null;
  use_self_study_with_blocks: boolean;
  enable_self_study_for_holidays: boolean;
  enable_self_study_for_study_days: boolean;
  lunch_time?: { start: string; end: string };
  camp_study_hours?: { start: string; end: string };
  camp_self_study_hours?: { start: string; end: string };
  designated_holiday_hours?: { start: string; end: string };
  non_study_time_blocks?: NonStudyTimeBlock[] | null;
};

// ============================================
// ë°ì´í„° ë¡œë”© í•¨ìˆ˜
// ============================================

/**
 * í”Œëœ ê·¸ë£¹ê³¼ ê´€ë ¨ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
 *
 * @param groupId í”Œëœ ê·¸ë£¹ ID
 * @param userId í˜„ì¬ ì‚¬ìš©ì ID
 * @param role ì‚¬ìš©ì ì—­í• 
 * @param tenantId í…Œë„ŒíŠ¸ ID
 * @returns ë¡œë“œëœ í”Œëœ ê·¸ë£¹ ë°ì´í„°
 */
export async function loadPlanGroupData(
  groupId: string,
  userId: string,
  role: "student" | "admin" | "consultant",
  tenantId: string
): Promise<LoadedPlanGroupData | null> {
  const result = await getPlanGroupWithDetailsByRole(
    groupId,
    userId,
    role,
    tenantId
  );

  if (!result.group) {
    return null;
  }

  return {
    group: result.group,
    contents: result.contents,
    exclusions: result.exclusions,
    academySchedules: result.academySchedules,
  };
}

/**
 * ë³‘í•©ëœ ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •ì„ ë¡œë“œí•©ë‹ˆë‹¤.
 *
 * @param tenantId í…Œë„ŒíŠ¸ ID
 * @param campTemplateId ìº í”„ í…œí”Œë¦¿ ID (ì„ íƒ)
 * @param schedulerOptions í”Œëœ ê·¸ë£¹ì˜ ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜
 * @returns ë³‘í•©ëœ ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜
 */
export async function loadSchedulerSettings(
  tenantId: string,
  campTemplateId?: string | null,
  schedulerOptions?: Record<string, unknown> | null
): Promise<MergedSchedulerOptions> {
  const mergedSettings = await getMergedSchedulerSettings(
    tenantId,
    campTemplateId || undefined,
    schedulerOptions || undefined
  );

  return {
    study_days: mergedSettings.study_review_ratio.study_days,
    review_days: mergedSettings.study_review_ratio.review_days,
    weak_subject_focus: mergedSettings.weak_subject_focus,
    review_scope: mergedSettings.review_scope,
    lunch_time: mergedSettings.lunch_time,
    camp_study_hours: mergedSettings.study_hours,
    self_study_hours: mergedSettings.self_study_hours,
  };
}

/**
 * í”Œëœ ê·¸ë£¹ì˜ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
 *
 * @param group í”Œëœ ê·¸ë£¹
 * @param studentId í•™ìƒ ID
 * @param userId í˜„ì¬ ì‚¬ìš©ì ID
 * @param role ì‚¬ìš©ì ì—­í• 
 * @param tenantId í…Œë„ŒíŠ¸ ID
 * @returns ê¸°ë³¸ ë¸”ë¡ ë°°ì—´
 */
export async function loadBaseBlocks(
  group: PlanGroup,
  studentId: string,
  userId: string,
  role: "student" | "admin" | "consultant",
  tenantId: string
): Promise<BaseBlock[]> {
  const blocks = await getBlockSetForPlanGroup(
    group,
    studentId,
    userId,
    role,
    tenantId
  );

  return blocks.map((b) => ({
    day_of_week: b.day_of_week,
    start_time: b.start_time,
    end_time: b.end_time,
  }));
}

// ============================================
// ìŠ¤ì¼€ì¤„ ê³„ì‚° í•¨ìˆ˜
// ============================================

/**
 * ìŠ¤ì¼€ì¤„ ê²°ê³¼ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
 *
 * @param group í”Œëœ ê·¸ë£¹
 * @param baseBlocks ê¸°ë³¸ ë¸”ë¡ ë°°ì—´
 * @param exclusions ì œì™¸ì¼ ë°°ì—´
 * @param academySchedules í•™ì› ì¼ì • ë°°ì—´
 * @param options ìŠ¤ì¼€ì¤„ ê³„ì‚° ì˜µì…˜
 * @returns ìŠ¤ì¼€ì¤„ ê³„ì‚° ê²°ê³¼
 */
export function calculateSchedule(
  group: PlanGroup,
  baseBlocks: BaseBlock[],
  exclusions: Array<{
    exclusion_date: string;
    exclusion_type: string;
    reason?: string | null;
  }>,
  academySchedules: Array<{
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string | null;
    subject?: string | null;
    travel_time?: number | null;
  }>,
  options: ScheduleCalculationOptions
): ScheduleCalculationResult {
  // calculateAvailableDates í˜¸ì¶œ
  const scheduleResult = calculateAvailableDates(
    group.period_start,
    group.period_end,
    baseBlocks.map((b) => ({
      day_of_week: b.day_of_week,
      start_time: b.start_time,
      end_time: b.end_time,
    })),
    exclusions.map((e) => ({
      exclusion_date: e.exclusion_date,
      exclusion_type: e.exclusion_type as
        | "íœ´ê°€"
        | "ê°œì¸ì‚¬ì •"
        | "íœ´ì¼ì§€ì •"
        | "ê¸°íƒ€",
      reason: e.reason || undefined,
    })),
    academySchedules.map((a) => ({
      day_of_week: a.day_of_week,
      start_time: a.start_time,
      end_time: a.end_time,
      academy_name: a.academy_name || undefined,
      subject: a.subject || undefined,
      travel_time: a.travel_time || undefined,
    })),
    {
      scheduler_type: options.scheduler_type as "1730_timetable",
      scheduler_options: options.scheduler_options as { study_days?: number; review_days?: number } | undefined,
      use_self_study_with_blocks: options.use_self_study_with_blocks,
      enable_self_study_for_holidays: options.enable_self_study_for_holidays,
      enable_self_study_for_study_days: options.enable_self_study_for_study_days,
      lunch_time: options.lunch_time,
      camp_study_hours: options.camp_study_hours,
      camp_self_study_hours: options.camp_self_study_hours,
      designated_holiday_hours: options.designated_holiday_hours,
      non_study_time_blocks: options.non_study_time_blocks || undefined,
    }
  );

  // ê²°ê³¼ì—ì„œ Map ì¶”ì¶œ
  return extractScheduleMaps(scheduleResult);
}

/**
 * ìŠ¤ì¼€ì¤„ ê²°ê³¼ì—ì„œ Mapë“¤ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
 *
 * @param scheduleResult calculateAvailableDates ê²°ê³¼
 * @returns ì¶”ì¶œëœ Mapë“¤
 */
export function extractScheduleMaps(
  scheduleResult: ReturnType<typeof calculateAvailableDates>
): ScheduleCalculationResult {
  const dateAvailableTimeRanges: DateAvailableTimeRangesMap = new Map();
  const dateTimeSlots: DateTimeSlotsMap = new Map();
  const dateMetadataMap: DateMetadataMap = new Map();
  const weekDatesMap: WeekDatesMap = new Map();

  scheduleResult.daily_schedule.forEach((daily) => {
    // í•™ìŠµì¼ê³¼ ë³µìŠµì¼ ëª¨ë‘ í¬í•¨
    if (
      (daily.day_type === "í•™ìŠµì¼" || daily.day_type === "ë³µìŠµì¼") &&
      daily.available_time_ranges.length > 0
    ) {
      dateAvailableTimeRanges.set(
        daily.date,
        daily.available_time_ranges.map((range) => ({
          start: range.start,
          end: range.end,
        }))
      );
    }

    // time_slots ì •ë³´ ì €ì¥
    if (daily.time_slots && daily.time_slots.length > 0) {
      dateTimeSlots.set(
        daily.date,
        daily.time_slots.map((slot) => ({
          type: slot.type as
            | "í•™ìŠµì‹œê°„"
            | "ì ì‹¬ì‹œê°„"
            | "í•™ì›ì¼ì •"
            | "ì´ë™ì‹œê°„"
            | "ììœ¨í•™ìŠµ",
          start: slot.start,
          end: slot.end,
          label: slot.label,
        }))
      );
    }

    // ë‚ ì§œë³„ ë©”íƒ€ë°ì´í„° ì €ì¥
    dateMetadataMap.set(daily.date, {
      day_type: (daily.day_type as
        | "í•™ìŠµì¼"
        | "ë³µìŠµì¼"
        | "ì§€ì •íœ´ì¼"
        | "íœ´ê°€"
        | "ê°œì¸ì¼ì •") || null,
      week_number: daily.week_number || null,
    });

    // ì£¼ì°¨ë³„ ë‚ ì§œ ëª©ë¡ êµ¬ì„±
    if (daily.week_number) {
      if (!weekDatesMap.has(daily.week_number)) {
        weekDatesMap.set(daily.week_number, []);
      }
      // ì œì™¸ì¼ì´ ì•„ë‹Œ ë‚ ì§œë§Œ ì£¼ì°¨ì— í¬í•¨
      if (
        daily.day_type &&
        daily.day_type !== "íœ´ê°€" &&
        daily.day_type !== "ê°œì¸ì¼ì •" &&
        daily.day_type !== "ì§€ì •íœ´ì¼"
      ) {
        weekDatesMap.get(daily.week_number)!.push(daily.date);
      }
    }
  });

  // ì£¼ì°¨ë³„ ë‚ ì§œ ëª©ë¡ ì •ë ¬
  weekDatesMap.forEach((dates) => {
    dates.sort();
  });

  return {
    dateAvailableTimeRanges,
    dateTimeSlots,
    dateMetadataMap,
    weekDatesMap,
  };
}

/**
 * ìŠ¤ì¼€ì¤„ ê³„ì‚° ì˜µì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * @param group í”Œëœ ê·¸ë£¹
 * @param schedulerOptions ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜
 * @returns ìŠ¤ì¼€ì¤„ ê³„ì‚° ì˜µì…˜
 */
export function createScheduleCalculationOptions(
  group: PlanGroup,
  schedulerOptions: MergedSchedulerOptions
): ScheduleCalculationOptions {
  const groupOptions = group.scheduler_options as Record<string, unknown> | null;

  // subject_allocationsì™€ content_allocations ì¶”ì¶œ ë° ê²€ì¦
  const subjectAllocations = groupOptions?.subject_allocations as
    | Array<{
        subject_id?: string;
        subject_name: string;
        subject_type: "strategy" | "weakness";
        weekly_days?: number;
      }>
    | undefined;
  const contentAllocations = groupOptions?.content_allocations as
    | Array<{
        content_type: "book" | "lecture" | "custom";
        content_id: string;
        subject_type: "strategy" | "weakness";
        weekly_days?: number;
      }>
    | undefined;

  // ë°ì´í„° ê²€ì¦
  if (subjectAllocations || contentAllocations) {
    const validation = validateAllocations(contentAllocations, subjectAllocations);
    if (!validation.valid) {
      console.warn("[createScheduleCalculationOptions] ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì • ê²€ì¦ ì‹¤íŒ¨:", {
        groupId: group.id,
        errors: validation.errors,
        subjectAllocations,
        contentAllocations,
      });
      // ê²€ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì§„í–‰í•˜ë˜, ì˜ëª»ëœ ì„¤ì •ì€ ë¬´ì‹œ
    }
  }

  return {
    scheduler_type: group.scheduler_type || "1730_timetable",
    scheduler_options: {
      study_days: schedulerOptions.study_days,
      review_days: schedulerOptions.review_days,
      weak_subject_focus: schedulerOptions.weak_subject_focus,
      review_scope: schedulerOptions.review_scope,
      lunch_time: schedulerOptions.lunch_time,
      camp_study_hours: schedulerOptions.camp_study_hours,
      self_study_hours: schedulerOptions.self_study_hours,
      // subject_allocationsì™€ content_allocationsë¥¼ scheduler_optionsì— í¬í•¨
      subject_allocations: subjectAllocations,
      content_allocations: contentAllocations,
    },
    use_self_study_with_blocks: true,
    enable_self_study_for_holidays:
      (groupOptions?.enable_self_study_for_holidays as boolean) === true,
    enable_self_study_for_study_days:
      (groupOptions?.enable_self_study_for_study_days as boolean) === true,
    lunch_time: schedulerOptions.lunch_time,
    camp_study_hours: schedulerOptions.camp_study_hours,
    camp_self_study_hours: schedulerOptions.self_study_hours,
    designated_holiday_hours: groupOptions?.designated_holiday_hours as
      | { start: string; end: string }
      | undefined,
    non_study_time_blocks: group.non_study_time_blocks,
  };
}
</file>

<file path="rangeRecommendation.ts">
/**
 * í•™ìŠµ ë²”ìœ„ ì¶”ì²œ ë¡œì§
 * 
 * ìŠ¤ì¼€ì¤„ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê° ì½˜í…ì¸ ì— ëŒ€í•œ ì ì • í•™ìŠµ ë²”ìœ„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
 */

import type { RangeRecommendationConfig } from "@/lib/recommendations/config/types";
import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";

export type ScheduleSummary = {
  total_study_days: number;
  total_study_hours: number;
};

export type ContentInfo = {
  content_id: string;
  content_type: "book" | "lecture";
  total_amount: number; // êµì¬: ì´ í˜ì´ì§€ ìˆ˜, ê°•ì˜: ì´ íšŒì°¨ ìˆ˜
};

export type RecommendedRange = {
  start: number;
  end: number;
  reason: string;
};

export type RangeRecommendationResult = {
  ranges: Map<string, RecommendedRange>;
  unavailableReasons: Map<string, string>;
};

/**
 * ë²”ìœ„ ì¶”ì²œì´ ë¶ˆê°€ëŠ¥í•œ ì´ìœ ë¥¼ ë°˜í™˜
 */
export function getUnavailableReason(
  scheduleSummary: ScheduleSummary | null | undefined,
  totalAmount: number | null | undefined
): string | null {
  if (!scheduleSummary) {
    return "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ";
  }

  const { total_study_days, total_study_hours } = scheduleSummary;
  if (total_study_days === 0 || total_study_hours === 0) {
    return "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ";
  }

  if (totalAmount === null || totalAmount === undefined) {
    return "ì´ëŸ‰ ì •ë³´ ì—†ìŒ";
  }

  if (totalAmount <= 0) {
    return "ì´ëŸ‰ ì •ë³´ ì˜¤ë¥˜";
  }

  return null;
}

/**
 * ì½˜í…ì¸  ëª©ë¡ì— ëŒ€í•œ í•™ìŠµ ë²”ìœ„ ì¶”ì²œ ê³„ì‚°
 * 
 * @param scheduleSummary ìŠ¤ì¼€ì¤„ ìš”ì•½ ì •ë³´
 * @param contents ì½˜í…ì¸  ì •ë³´ ëª©ë¡
 * @param options ì„ íƒì  ì„¤ì • ì˜µì…˜
 * @param options.config ì§ì ‘ ì œê³µëœ ë²”ìœ„ ì¶”ì²œ ì„¤ì • (ìš°ì„ ìˆœìœ„ 1)
 * @param options.tenantId í…Œë„ŒíŠ¸ ID (ì„¤ì •ì„ DBì—ì„œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©)
 * @returns ì¶”ì²œ ë²”ìœ„ ë° ë¶ˆê°€ëŠ¥í•œ ì´ìœ 
 */
export async function calculateRecommendedRanges(
  scheduleSummary: ScheduleSummary | null | undefined,
  contents: ContentInfo[],
  options?: {
    config?: Partial<RangeRecommendationConfig>;
    tenantId?: string | null;
  }
): Promise<RangeRecommendationResult> {
  const ranges = new Map<string, RecommendedRange>();
  const unavailableReasons = new Map<string, string>();

  // ìŠ¤ì¼€ì¤„ ì •ë³´ ê²€ì¦
  if (!scheduleSummary) {
    contents.forEach((content) => {
      unavailableReasons.set(content.content_id, "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ");
    });
    return { ranges, unavailableReasons };
  }

  const { total_study_days, total_study_hours } = scheduleSummary;
  if (total_study_days === 0 || total_study_hours === 0) {
    contents.forEach((content) => {
      unavailableReasons.set(content.content_id, "ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ìŒ");
    });
    return { ranges, unavailableReasons };
  }

  // ì „ì²´ ì½˜í…ì¸  ê°œìˆ˜
  const totalContents = contents.length;
  if (totalContents === 0) {
    return { ranges, unavailableReasons };
  }

  // ì„¤ì • ê²°ì •: ì§ì ‘ ì œê³µëœ config â†’ ê¸°ë³¸ê°’
  // í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” ì„œë²„ ì „ìš© ì½”ë“œë¥¼ importí•˜ì§€ ì•Šë„ë¡ í•¨
  let config: RangeRecommendationConfig;
  if (options?.config) {
    // ì§ì ‘ ì œê³µëœ configì™€ ê¸°ë³¸ê°’ì„ ë³‘í•©
    config = {
      ...defaultRangeRecommendationConfig,
      ...options.config,
    };
  } else {
    // ì˜µì…˜ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    // tenantIdê°€ ì œê³µë˜ì–´ë„ í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” DB ì¡°íšŒë¥¼ í•˜ì§€ ì•ŠìŒ
    // ì„œë²„ ì•¡ì…˜ì„ í†µí•´ ë²”ìœ„ ì¶”ì²œì„ ê³„ì‚°í•´ì•¼ í•¨
    config = defaultRangeRecommendationConfig;
  }

  // ì¼ì¼ í‰ê·  í•™ìŠµ ì‹œê°„ ê³„ì‚°
  const avgDailyHours = total_study_hours / total_study_days;

  // ê° ì½˜í…ì¸ ì— í• ë‹¹í•  ì¼ì¼ í•™ìŠµëŸ‰ ê³„ì‚°
  // ì˜ˆ: 9ê°œ ì½˜í…ì¸ , í•˜ë£¨ 3ì‹œê°„ â†’ ê° ì½˜í…ì¸ ë‹¹ ì•½ 20ë¶„
  const hoursPerContentPerDay = avgDailyHours / totalContents;

  // ê° ì½˜í…ì¸ ë³„ ì¶”ì²œ ë²”ìœ„ ê³„ì‚°
  for (const content of contents) {
    const unavailableReason = getUnavailableReason(
      scheduleSummary,
      content.total_amount
    );

    if (unavailableReason) {
      unavailableReasons.set(content.content_id, unavailableReason);
      continue;
    }

    if (content.content_type === "book") {
      // êµì¬: ì¼ì¼ í•™ìŠµëŸ‰ì„ í˜ì´ì§€ë¡œ í™˜ì‚°
      const pagesPerHour = config.pagesPerHour;
      const dailyPages = Math.round(hoursPerContentPerDay * pagesPerHour);
      const recommendedEnd = Math.min(
        dailyPages * total_study_days,
        content.total_amount
      );

      ranges.set(content.content_id, {
        start: 1,
        end: recommendedEnd,
        reason: `${totalContents}ê°œ ì½˜í…ì¸  ë¶„ë°°, ì¼ì¼ ${dailyPages}í˜ì´ì§€ Ã— ${total_study_days}ì¼`,
      });
    } else if (content.content_type === "lecture") {
      // ê°•ì˜: ì¼ì¼ í•™ìŠµëŸ‰ì„ íšŒì°¨ë¡œ í™˜ì‚°
      const episodesPerHour = config.episodesPerHour;
      const dailyEpisodes = Math.round(
        hoursPerContentPerDay * episodesPerHour
      );
      const recommendedEnd = Math.min(
        dailyEpisodes * total_study_days,
        content.total_amount
      );

      ranges.set(content.content_id, {
        start: 1,
        end: recommendedEnd,
        reason: `${totalContents}ê°œ ì½˜í…ì¸  ë¶„ë°°, ì¼ì¼ ${dailyEpisodes}íšŒì°¨ Ã— ${total_study_days}ì¼`,
      });
    } else {
      unavailableReasons.set(content.content_id, "ì§€ì›í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸  íƒ€ì…");
    }
  }

  return { ranges, unavailableReasons };
}
</file>

<file path="scheduleProcessor.ts">
/**
 * ìŠ¤ì¼€ì¤„ í”„ë¡œì„¸ì„œ
 *
 * í”Œëœ ìƒì„±/ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ìŠ¤ì¼€ì¤„ ì²˜ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
 * - ì‹œê°„ ì„¸ê·¸ë¨¼íŠ¸ ì²˜ë¦¬
 * - í”Œëœ ë²ˆí˜¸ ê³„ì‚°
 * - ì£¼ì°¨ë³„ ì¼ì°¨ ê³„ì‚°
 *
 * @module lib/plan/scheduleProcessor
 */

import { assignPlanTimes } from "@/lib/plan/assignPlanTimes";
import type {
  DateTimeSlotsMap,
  DateMetadataMap,
  WeekDatesMap,
  ContentIdMap,
  ContentMetadataMap,
  ContentDurationMap,
  DayType,
  PlanNumberMap,
  UsedBlockIndicesByDateMap,
  GeneratePlanPayload,
  PreviewPlanPayload,
} from "@/lib/types/plan-generation";
import type { ScheduledPlan } from "@/lib/plan/scheduler";
import type { PlanGroup } from "@/lib/types/plan";

// ============================================
// íƒ€ì… ì •ì˜
// ============================================

/**
 * ì‹œê°„ ì„¸ê·¸ë¨¼íŠ¸ ì²˜ë¦¬ ê²°ê³¼
 */
export type TimeSegmentResult = {
  plan: {
    content_id: string;
    content_type: "book" | "lecture" | "custom";
    planned_start_page_or_time: number;
    planned_end_page_or_time: number;
    chapter: string | null;
    block_index?: number;
  };
  start: string;
  end: string;
  isPartial: boolean;
  isContinued: boolean;
  originalEstimatedTime: number;
};

/**
 * ë‚ ì§œë³„ ì²˜ë¦¬ ì»¨í…ìŠ¤íŠ¸
 */
export type DateProcessingContext = {
  date: string;
  dateMetadata: {
    day_type: DayType;
    week_number: number | null;
  };
  studyTimeSlots: Array<{ start: string; end: string }>;
  totalStudyHours: number;
};

// ============================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
// ============================================

/**
 * ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
 */
export function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

/**
 * ë¶„ì„ ì‹œê°„ ë¬¸ìì—´ë¡œ ë³€í™˜
 */
export function minutesToTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}

/**
 * í•™ìŠµ ì‹œê°„ ìŠ¬ë¡¯ì„ ì¶”ì¶œí•˜ê³  ì •ë ¬í•©ë‹ˆë‹¤.
 */
export function extractStudyTimeSlots(
  dateTimeSlots: DateTimeSlotsMap,
  date: string
): Array<{ start: string; end: string }> {
  const timeSlots = dateTimeSlots.get(date) || [];
  return timeSlots
    .filter((slot) => slot.type === "í•™ìŠµì‹œê°„")
    .map((slot) => ({ start: slot.start, end: slot.end }))
    .sort((a, b) => {
      const aStart = a.start.split(":").map(Number);
      const bStart = b.start.split(":").map(Number);
      const aMinutes = aStart[0] * 60 + aStart[1];
      const bMinutes = bStart[0] * 60 + bStart[1];
      return aMinutes - bMinutes;
    });
}

/**
 * ì£¼ì°¨ë³„ ì¼ì°¨(day)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
 */
export function calculateWeekDay(
  date: string,
  weekNumber: number | null,
  weekDatesMap: WeekDatesMap,
  periodStart: string,
  schedulerType?: string | null
): number | null {
  if (!weekNumber) {
    return null;
  }

  if (schedulerType === "1730_timetable") {
    const weekDates = weekDatesMap.get(weekNumber) || [];
    const dayIndex = weekDates.indexOf(date);
    if (dayIndex >= 0) {
      return dayIndex + 1;
    }
  }

  // ê¸°ë³¸ ê³„ì‚°: ê¸°ê°„ ê¸°ì¤€ ë‹¨ìˆœ ê³„ì‚°
  const start = new Date(periodStart);
  const current = new Date(date);
  start.setHours(0, 0, 0, 0);
  current.setHours(0, 0, 0, 0);
  const diffTime = current.getTime() - start.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return (diffDays % 7) + 1;
}

// ============================================
// í”Œëœ ë²ˆí˜¸ ê³„ì‚°
// ============================================

/**
 * í”Œëœ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 */
export function createPlanKey(
  date: string,
  contentId: string,
  startPageOrTime: number,
  endPageOrTime: number
): string {
  return `${date}:${contentId}:${startPageOrTime}:${endPageOrTime}`;
}

/**
 * í”Œëœ ë²ˆí˜¸ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
 */
export function assignPlanNumber(
  planKey: string,
  planNumberMap: PlanNumberMap,
  nextPlanNumber: { value: number }
): number {
  if (planNumberMap.has(planKey)) {
    return planNumberMap.get(planKey)!;
  }

  const planNumber = nextPlanNumber.value;
  planNumberMap.set(planKey, planNumber);
  nextPlanNumber.value++;
  return planNumber;
}

// ============================================
// ì‹œê°„ ì„¸ê·¸ë¨¼íŠ¸ ì²˜ë¦¬
// ============================================

/**
 * ë‚ ì§œë³„ë¡œ í”Œëœì„ ê·¸ë£¹í™”í•©ë‹ˆë‹¤.
 */
export function groupPlansByDate(
  scheduledPlans: ScheduledPlan[]
): Map<string, ScheduledPlan[]> {
  const plansByDate = new Map<string, ScheduledPlan[]>();
  scheduledPlans.forEach((plan) => {
    if (!plansByDate.has(plan.plan_date)) {
      plansByDate.set(plan.plan_date, []);
    }
    plansByDate.get(plan.plan_date)!.push(plan);
  });
  return plansByDate;
}

/**
 * ë‚ ì§œë³„ í”Œëœì„ ì‹œê°„ ì„¸ê·¸ë¨¼íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 */
export function processDatePlans(
  date: string,
  datePlans: ScheduledPlan[],
  contentIdMap: ContentIdMap,
  context: DateProcessingContext,
  contentDurationMap: ContentDurationMap
): TimeSegmentResult[] {
  // í”Œëœ ì¤€ë¹„ (ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ í•™ìƒ ì½˜í…ì¸  IDë¡œ ë³€í™˜)
  const plansForAssign = datePlans.map((plan) => {
    const finalContentId =
      contentIdMap.get(plan.content_id) || plan.content_id;
    return {
      content_id: finalContentId,
      content_type: plan.content_type,
      planned_start_page_or_time: plan.planned_start_page_or_time,
      planned_end_page_or_time: plan.planned_end_page_or_time,
      chapter: plan.chapter || null,
      block_index: plan.block_index,
    };
  });

  // assignPlanTimes í˜¸ì¶œí•˜ì—¬ ì‹œê°„ ì„¸ê·¸ë¨¼íŠ¸ ê³„ì‚°
  const dayType = context.dateMetadata.day_type || "í•™ìŠµì¼";
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const durationMap = contentDurationMap as Map<string, any>;
  const segments = assignPlanTimes(
    plansForAssign,
    context.studyTimeSlots,
    durationMap,
    dayType,
    context.totalStudyHours
  );
  
  // ë°˜í™˜ íƒ€ì… ë³€í™˜
  return segments.map((seg): TimeSegmentResult => ({
    plan: {
      content_id: seg.plan.content_id,
      content_type: seg.plan.content_type as "book" | "lecture" | "custom",
      planned_start_page_or_time: seg.plan.planned_start_page_or_time,
      planned_end_page_or_time: seg.plan.planned_end_page_or_time,
      chapter: seg.plan.chapter || null,
      block_index: seg.plan.block_index,
    },
    start: seg.start,
    end: seg.end,
    isPartial: seg.isPartial,
    isContinued: seg.isContinued,
    originalEstimatedTime: seg.originalEstimatedTime,
  }));
}

// ============================================
// ë¯¸ë¦¬ë³´ê¸° í”Œëœ ìƒì„±
// ============================================

/**
 * ë¯¸ë¦¬ë³´ê¸° í”Œëœ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 */
export function createPreviewPlanPayload(
  date: string,
  blockIndex: number,
  segment: TimeSegmentResult,
  originalContentId: string,
  contentMetadataMap: ContentMetadataMap,
  dateMetadata: { day_type: DayType; week_number: number | null },
  weekDay: number | null,
  planNumber: number
): PreviewPlanPayload {
  const metadata = contentMetadataMap.get(originalContentId) || {};

  return {
    plan_date: date,
    block_index: blockIndex,
    content_type: segment.plan.content_type,
    content_id: segment.plan.content_id,
    content_title: metadata.title || null,
    content_subject: metadata.subject || null,
    content_subject_category: metadata.subject_category || null,
    content_category: metadata.category || null,
    planned_start_page_or_time: segment.plan.planned_start_page_or_time,
    planned_end_page_or_time: segment.plan.planned_end_page_or_time,
    chapter: segment.plan.chapter || null,
    start_time: segment.start,
    end_time: segment.end,
    day_type: dateMetadata.day_type,
    week: dateMetadata.week_number,
    day: weekDay,
    is_partial: segment.isPartial,
    is_continued: segment.isContinued,
    plan_number: planNumber,
  };
}

// ============================================
// ìƒì„± í”Œëœ í˜ì´ë¡œë“œ
// ============================================

/**
 * ìƒì„± í”Œëœ í˜ì´ë¡œë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 */
export function createGeneratePlanPayload(
  tenantId: string,
  studentId: string,
  groupId: string,
  date: string,
  blockIndex: number,
  segment: TimeSegmentResult,
  originalContentId: string,
  originalPlan: ScheduledPlan | undefined,
  contentMetadataMap: ContentMetadataMap,
  dateMetadata: { day_type: DayType; week_number: number | null },
  weekDay: number | null,
  planNumber: number
): GeneratePlanPayload {
  const metadata = contentMetadataMap.get(originalContentId) || {};

  return {
    tenant_id: tenantId,
    student_id: studentId,
    plan_group_id: groupId,
    plan_date: date,
    block_index: blockIndex,
    content_type: segment.plan.content_type,
    content_id: segment.plan.content_id,
    chapter: segment.plan.chapter || null,
    planned_start_page_or_time: segment.plan.planned_start_page_or_time,
    planned_end_page_or_time: segment.plan.planned_end_page_or_time,
    is_reschedulable: originalPlan?.is_reschedulable ?? true,
    // Denormalized í•„ë“œ
    content_title: metadata.title || null,
    content_subject: metadata.subject || null,
    content_subject_category: metadata.subject_category || null,
    content_category: metadata.category || null,
    // ì‹œê°„ ì •ë³´
    start_time: segment.start,
    end_time: segment.end,
    // ë‚ ì§œ ìœ í˜• ë° ì£¼ì°¨ ì •ë³´
    day_type: dateMetadata.day_type,
    week: dateMetadata.week_number,
    day: weekDay,
    // ìƒíƒœë±ƒì§€ ì •ë³´
    is_partial: segment.isPartial,
    is_continued: segment.isContinued,
    // í”Œëœ ë²ˆí˜¸
    plan_number: planNumber,
    // íšŒì°¨ (ë‚˜ì¤‘ì— ê³„ì‚°í•˜ì—¬ ì—…ë°ì´íŠ¸)
    sequence: null,
  };
}

// ============================================
// ë¸”ë¡ ì¸ë±ìŠ¤ ê´€ë¦¬
// ============================================

/**
 * ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¤ìŒ ë¸”ë¡ ì¸ë±ìŠ¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
 */
export function findNextAvailableBlockIndex(
  usedIndices: Set<number>,
  currentIndex: number
): number {
  let nextIndex = currentIndex;
  while (usedIndices.has(nextIndex)) {
    nextIndex++;
  }
  return nextIndex;
}

/**
 * ë¸”ë¡ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©ëœ ê²ƒìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
 */
export function markBlockIndexAsUsed(
  usedBlockIndicesByDate: UsedBlockIndicesByDateMap,
  date: string,
  blockIndex: number
): void {
  if (!usedBlockIndicesByDate.has(date)) {
    usedBlockIndicesByDate.set(date, new Set());
  }
  usedBlockIndicesByDate.get(date)!.add(blockIndex);
}

// ============================================
// ì›ë³¸ ì½˜í…ì¸  ID ì°¾ê¸°
// ============================================

/**
 * ì„¸ê·¸ë¨¼íŠ¸ì— í•´ë‹¹í•˜ëŠ” ì›ë³¸ ì½˜í…ì¸  IDë¥¼ ì°¾ìŠµë‹ˆë‹¤.
 */
export function findOriginalContentId(
  segment: TimeSegmentResult,
  datePlans: ScheduledPlan[],
  contentIdMap: ContentIdMap
): string {
  const found = datePlans.find(
    (p) =>
      p.content_id === segment.plan.content_id ||
      contentIdMap.get(p.content_id) === segment.plan.content_id
  );
  return found?.content_id || segment.plan.content_id;
}

/**
 * ì›ë³¸ í”Œëœì„ ì°¾ìŠµë‹ˆë‹¤.
 */
export function findOriginalPlan(
  segment: TimeSegmentResult,
  datePlans: ScheduledPlan[],
  contentIdMap: ContentIdMap
): ScheduledPlan | undefined {
  return datePlans.find(
    (p) =>
      p.content_id === segment.plan.content_id ||
      contentIdMap.get(p.content_id) === segment.plan.content_id
  );
}
</file>

<file path="scheduler.ts">
import {
  PlanGroup,
  PlanContent,
  PlanExclusion,
  AcademySchedule,
  SchedulerType,
} from "@/lib/types/plan";
import {
  getContentAllocation,
  calculateSubjectAllocationDates,
  divideContentRange,
  calculateStudyReviewCycle,
  type CycleDayInfo,
} from "@/lib/plan/1730TimetableLogic";
import { validateAllocations } from "@/lib/utils/subjectAllocation";

export type BlockInfo = {
  id: string;
  day_of_week: number;
  block_index: number;
  start_time: string;
  end_time: string;
  duration_minutes: number;
  plan_date?: string; // ë‚ ì§œë³„ ë¸”ë¡ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì¶”ê°€ (Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ ì‚¬ìš© ì‹œ)
};

export type ContentInfo = {
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  start_range: number;
  end_range: number;
  total_amount: number; // end_range - start_range
  subject?: string | null; // ê³¼ëª©ëª… (ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ë¡œì§ìš©)
  subject_category?: string | null; // ê³¼ëª© ì¹´í…Œê³ ë¦¬
};

export type ScheduledPlan = {
  plan_date: string;
  block_index: number;
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  planned_start_page_or_time: number;
  planned_end_page_or_time: number;
  chapter?: string | null;
  is_reschedulable: boolean;
  start_time?: string; // HH:mm í˜•ì‹
  end_time?: string; // HH:mm í˜•ì‹
};

/**
 * í”Œëœ ê·¸ë£¹ì—ì„œ ê°œë³„ í”Œëœ ìƒì„±
 */
export type DateAvailableTimeRanges = Map<string, Array<{ start: string; end: string }>>;
export type DateTimeSlots = Map<string, Array<{
  type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
  start: string; // HH:mm
  end: string; // HH:mm
  label?: string;
}>>;

/**
 * ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ì •ë³´
 */
export type ContentDurationInfo = {
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  total_pages?: number | null; // ì±…ì˜ ê²½ìš°
  duration?: number | null; // ê°•ì˜ì˜ ê²½ìš° (ë¶„)
  total_page_or_time?: number | null; // ì»¤ìŠ¤í…€ì˜ ê²½ìš°
};

export type ContentDurationMap = Map<string, ContentDurationInfo>;

export function generatePlansFromGroup(
  group: PlanGroup,
  contents: PlanContent[],
  exclusions: PlanExclusion[],
  academySchedules: AcademySchedule[],
  blocks: BlockInfo[],
  contentSubjects?: Map<string, { subject?: string | null; subject_category?: string | null }>,
  riskIndexMap?: Map<string, { riskScore: number }>,
  dateAvailableTimeRanges?: DateAvailableTimeRanges, // Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ (ë‚ ì§œë³„ ì‚¬ìš© ê°€ëŠ¥ ì‹œê°„ ë²”ìœ„)
  dateTimeSlots?: DateTimeSlots, // Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ (ë‚ ì§œë³„ ì‹œê°„ íƒ€ì„ë¼ì¸)
  contentDurationMap?: ContentDurationMap, // ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ì •ë³´
  periodStart?: string, // ì¬ì¡°ì • ì‹œ ì‚¬ìš©í•  ê¸°ê°„ ì‹œì‘ì¼ (ì„ íƒì‚¬í•­)
  periodEnd?: string // ì¬ì¡°ì • ì‹œ ì‚¬ìš©í•  ê¸°ê°„ ì¢…ë£Œì¼ (ì„ íƒì‚¬í•­)
): ScheduledPlan[] {
  // 1. í•™ìŠµ ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ ìƒì„± (ì œì™¸ì¼ ì œì™¸)
  // ì¬ì¡°ì • ì‹œì—ëŠ” ì „ë‹¬ëœ periodStart/periodEnd ì‚¬ìš©, ì•„ë‹ˆë©´ groupì˜ ê¸°ê°„ ì‚¬ìš©
  const startDate = periodStart || group.period_start;
  const endDate = periodEnd || group.period_end;
  
  const availableDates = calculateAvailableDates(
    startDate,
    endDate,
    exclusions
  );

  if (availableDates.length === 0) {
    throw new Error("í•™ìŠµ ê°€ëŠ¥í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„ê³¼ ì œì™¸ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }

  // 2. ì½˜í…ì¸  ì •ë³´ ë³€í™˜ (ê³¼ëª© ì •ë³´ í¬í•¨)
  const contentInfos: ContentInfo[] = contents.map((c) => {
    const subjectInfo = contentSubjects?.get(c.content_id);
    return {
      content_type: c.content_type,
      content_id: c.content_id,
      start_range: c.start_range,
      end_range: c.end_range,
      total_amount: c.end_range - c.start_range,
      subject: subjectInfo?.subject || null,
      subject_category: subjectInfo?.subject_category || null,
    };
  });

  // 3. ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜•ë³„ë¡œ í”Œëœ ìƒì„±
  let plans: ScheduledPlan[] = [];
  switch (group.scheduler_type) {
    case "1730_timetable":
      plans = generate1730TimetablePlans(
        availableDates,
        contentInfos,
        blocks,
        academySchedules,
        exclusions,
        group.scheduler_options,
        riskIndexMap,
        dateAvailableTimeRanges,
        dateTimeSlots,
        contentDurationMap
      );
      break;
    default:
      plans = generateDefaultPlans(
        availableDates,
        contentInfos,
        blocks,
        academySchedules,
        exclusions,
        riskIndexMap,
        dateAvailableTimeRanges,
        dateTimeSlots,
        contentDurationMap
      );
      break;
  }

  // 4. ì¶”ê°€ ê¸°ê°„ ì¬ë°°ì¹˜ ì²˜ë¦¬ (ë³µìŠµì˜ ë³µìŠµ)
  const additionalReallocation = (group as any).additional_period_reallocation as {
    period_start: string;
    period_end: string;
    type: "additional_review";
    original_period_start: string;
    original_period_end: string;
    subjects?: string[];
    review_of_review_factor?: number;
  } | null | undefined;

  if (additionalReallocation && additionalReallocation.type === "additional_review") {
    const reallocatedPlans = generateAdditionalPeriodReallocationPlans(
      plans,
      additionalReallocation,
      group,
      exclusions,
      blocks,
      academySchedules,
      contentSubjects,
      riskIndexMap,
      dateAvailableTimeRanges,
      dateTimeSlots,
      contentDurationMap
    );
    plans = [...plans, ...reallocatedPlans];
  }

  return plans;
}

/**
 * ì¶”ê°€ ê¸°ê°„ ì¬ë°°ì¹˜ í”Œëœ ìƒì„± (ë³µìŠµì˜ ë³µìŠµ)
 */
function generateAdditionalPeriodReallocationPlans(
  originalPlans: ScheduledPlan[],
  reallocation: {
    period_start: string;
    period_end: string;
    type: "additional_review";
    original_period_start: string;
    original_period_end: string;
    subjects?: string[];
    review_of_review_factor?: number;
  },
  group: PlanGroup,
  exclusions: PlanExclusion[],
  blocks: BlockInfo[],
  academySchedules: AcademySchedule[],
  contentSubjects?: Map<string, { subject?: string | null; subject_category?: string | null }>,
  riskIndexMap?: Map<string, { riskScore: number }>,
  dateAvailableTimeRanges?: DateAvailableTimeRanges,
  dateTimeSlots?: DateTimeSlots,
  contentDurationMap?: ContentDurationMap
): ScheduledPlan[] {
  const reallocatedPlans: ScheduledPlan[] = [];
  const reviewOfReviewFactor = reallocation.review_of_review_factor ?? 0.25;

  // 1. ì›ë³¸ í”Œëœ ê¸°ê°„ì˜ í”Œëœë“¤ì„ í•„í„°ë§ (ì›ë³¸ ê¸°ê°„ ë‚´ì˜ í”Œëœë§Œ)
  const originalPeriodPlans = originalPlans.filter((plan) => {
    const planDate = new Date(plan.plan_date);
    const originalStart = new Date(reallocation.original_period_start);
    const originalEnd = new Date(reallocation.original_period_end);
    return planDate >= originalStart && planDate <= originalEnd;
  });

  if (originalPeriodPlans.length === 0) {
    console.warn("[scheduler] ì¶”ê°€ ê¸°ê°„ ì¬ë°°ì¹˜: ì›ë³¸ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.");
    return reallocatedPlans;
  }

  // 2. ì›ë³¸ í”Œëœë“¤ì„ ì½˜í…ì¸ ë³„ë¡œ ê·¸ë£¹í™”
  const plansByContent = new Map<string, ScheduledPlan[]>();
  for (const plan of originalPeriodPlans) {
    const key = `${plan.content_type}:${plan.content_id}`;
    if (!plansByContent.has(key)) {
      plansByContent.set(key, []);
    }
    plansByContent.get(key)!.push(plan);
  }

  // 3. ê³¼ëª© í•„í„°ë§ (ì§€ì •ëœ ê²½ìš°)
  const targetSubjects = reallocation.subjects && reallocation.subjects.length > 0
    ? new Set(reallocation.subjects.map(s => s.toLowerCase().trim()))
    : null;

  // 4. ì¶”ê°€ ê¸°ê°„ì˜ ë‚ ì§œ ëª©ë¡ ìƒì„± (ì œì™¸ì¼ ì œì™¸)
  const additionalDates = calculateAvailableDatesSimple(
    reallocation.period_start,
    reallocation.period_end,
    exclusions
  );

  if (additionalDates.length === 0) {
    console.warn("[scheduler] ì¶”ê°€ ê¸°ê°„ ì¬ë°°ì¹˜: í•™ìŠµ ê°€ëŠ¥í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return reallocatedPlans;
  }

  // 5. ì¶”ê°€ ê¸°ê°„ì˜ í•™ìŠµì¼/ë³µìŠµì¼ ë¶„ë¥˜ (1730_timetableì¸ ê²½ìš°)
  const studyDays = (group.scheduler_options as any)?.study_days ?? 6;
  const reviewDays = (group.scheduler_options as any)?.review_days ?? 1;
  const weekSize = studyDays + reviewDays;

  const additionalStudyDates: string[] = [];
  const additionalReviewDates: string[] = [];

  // ì£¼ì°¨ë³„ë¡œ í•™ìŠµì¼/ë³µìŠµì¼ ë¶„ë¥˜ (ê¸°ë³¸ì ìœ¼ë¡œ 1730 Timetable íŒ¨í„´ ì ìš©)
  const weeks: string[][] = [];
  for (let i = 0; i < additionalDates.length; i += weekSize) {
    weeks.push(additionalDates.slice(i, i + weekSize));
  }

  weeks.forEach((weekDates) => {
    const studyDaysList = weekDates.slice(0, studyDays);
    const reviewDaysList = weekDates.slice(studyDays, weekSize);
    additionalStudyDates.push(...studyDaysList);
    additionalReviewDates.push(...reviewDaysList);
  });

  // 6. ê° ì½˜í…ì¸ ë³„ë¡œ ì¬ë°°ì¹˜ í”Œëœ ìƒì„±
  for (const [contentKey, contentPlans] of plansByContent.entries()) {
    const [contentType, contentId] = contentKey.split(":");
    
    // ê³¼ëª© í•„í„°ë§
    if (targetSubjects) {
      const subjectInfo = contentSubjects?.get(contentId);
      const subjectCategory = subjectInfo?.subject_category?.toLowerCase().trim();
      if (!subjectCategory || !targetSubjects.has(subjectCategory)) {
        continue;
      }
    }

    // ì›ë³¸ í”Œëœì˜ ì´ í•™ìŠµ ë²”ìœ„ ê³„ì‚°
    let totalStartRange = Infinity;
    let totalEndRange = -Infinity;
    for (const plan of contentPlans) {
      totalStartRange = Math.min(totalStartRange, plan.planned_start_page_or_time);
      totalEndRange = Math.max(totalEndRange, plan.planned_end_page_or_time);
    }

    const totalRange = totalEndRange - totalStartRange;
    if (totalRange <= 0) {
      continue;
    }

    // ì›ë³¸ í”Œëœì˜ ì´ ì†Œìš”ì‹œê°„ ê³„ì‚° (contentDurationMap ì‚¬ìš©)
    let originalTotalDuration = 0;
    if (contentDurationMap) {
      const durationInfo = contentDurationMap.get(contentId);
      if (durationInfo) {
        // í˜ì´ì§€ë‹¹ ë˜ëŠ” ì‹œê°„ë‹¹ ì†Œìš”ì‹œê°„ ê³„ì‚°
        if (contentType === "book" && durationInfo.total_pages) {
          const minutesPerPage = durationInfo.duration ? durationInfo.duration / durationInfo.total_pages : 1;
          originalTotalDuration = totalRange * minutesPerPage;
        } else if (contentType === "lecture" && durationInfo.duration) {
          // ê°•ì˜ì˜ ê²½ìš° ë²”ìœ„ê°€ ì‹œê°„(ë¶„) ë‹¨ìœ„
          originalTotalDuration = totalRange;
        } else {
          // ê¸°ë³¸ê°’: ë²”ìœ„ë‹¹ 1ë¶„
          originalTotalDuration = totalRange;
        }
      }
    } else {
      // contentDurationMapì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
      originalTotalDuration = totalRange;
    }

    // 7. ì¶”ê°€ ê¸°ê°„ í•™ìŠµì¼ì— ì¬ë°°ì¹˜
    const studyDaysCount = additionalStudyDates.length;
    if (studyDaysCount > 0) {
      const dailyRange = totalRange / studyDaysCount;
      const dailyOriginalDuration = originalTotalDuration / studyDaysCount;
      const dailyReallocatedDuration = dailyOriginalDuration * reviewOfReviewFactor;

      let currentStart = totalStartRange;
      for (let i = 0; i < studyDaysCount; i++) {
        const date = additionalStudyDates[i];
        const isLastDay = i === studyDaysCount - 1;
        const dayRange = isLastDay ? (totalEndRange - currentStart) : dailyRange;
        const dayEnd = currentStart + dayRange;

        // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œê°„ ë²”ìœ„ ì¡°íšŒ
        const availableRanges = dateAvailableTimeRanges?.get(date) || [];
        if (availableRanges.length === 0) {
          currentStart = dayEnd;
          continue;
        }

        // ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œê°„ ë²”ìœ„ ì‚¬ìš©
        const firstRange = availableRanges[0];
        const startTime = firstRange.start;
        
        // ì†Œìš”ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì¢…ë£Œ ì‹œê°„ ê³„ì‚°
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = startMinutes + Math.ceil(dailyReallocatedDuration);
        const endTime = minutesToTime(endMinutes);

        // ë¸”ë¡ ì¸ë±ìŠ¤ ê³„ì‚° (ë‚ ì§œë³„ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€)
        let blockIndex = 0;
        for (const existingPlan of reallocatedPlans) {
          if (existingPlan.plan_date === date) {
            blockIndex = Math.max(blockIndex, existingPlan.block_index + 1);
          }
        }

        reallocatedPlans.push({
          plan_date: date,
          block_index: blockIndex,
          content_type: contentType as "book" | "lecture" | "custom",
          content_id: contentId,
          planned_start_page_or_time: Math.round(currentStart),
          planned_end_page_or_time: Math.round(dayEnd),
          chapter: null,
          is_reschedulable: true,
          start_time: startTime,
          end_time: endTime,
        });

        currentStart = dayEnd;
      }
    }

    // 8. ì¶”ê°€ ê¸°ê°„ ë³µìŠµì¼ì— ì¬ë°°ì¹˜ (1730_timetableì¸ ê²½ìš°)
    if (group.scheduler_type === "1730_timetable" && additionalReviewDates.length > 0) {
      const reviewDaysCount = additionalReviewDates.length;
      const reviewRange = totalRange; // ì „ì²´ ë²”ìœ„ ë³µìŠµ
      const reviewOriginalDuration = originalTotalDuration;
      
      // ë³µìŠµ ë³´ì • ê³„ìˆ˜ (ê¸°ë³¸ê°’: 0.4)
      const reviewFactor = 0.4;
      const reviewDuration = reviewOriginalDuration * reviewFactor * reviewOfReviewFactor;

      for (let i = 0; i < reviewDaysCount; i++) {
        const date = additionalReviewDates[i];
        
        // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œê°„ ë²”ìœ„ ì¡°íšŒ
        const availableRanges = dateAvailableTimeRanges?.get(date) || [];
        if (availableRanges.length === 0) {
          continue;
        }

        // ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œê°„ ë²”ìœ„ ì‚¬ìš©
        const firstRange = availableRanges[0];
        const startTime = firstRange.start;
        
        // ì†Œìš”ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì¢…ë£Œ ì‹œê°„ ê³„ì‚°
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = startMinutes + Math.ceil(reviewDuration);
        const endTime = minutesToTime(endMinutes);

        // ë¸”ë¡ ì¸ë±ìŠ¤ ê³„ì‚°
        let blockIndex = 0;
        for (const existingPlan of reallocatedPlans) {
          if (existingPlan.plan_date === date) {
            blockIndex = Math.max(blockIndex, existingPlan.block_index + 1);
          }
        }

        reallocatedPlans.push({
          plan_date: date,
          block_index: blockIndex,
          content_type: contentType as "book" | "lecture" | "custom",
          content_id: contentId,
          planned_start_page_or_time: Math.round(totalStartRange),
          planned_end_page_or_time: Math.round(totalEndRange),
          chapter: null,
          is_reschedulable: true,
          start_time: startTime,
          end_time: endTime,
        });
      }
    }
  }

  return reallocatedPlans;
}

/**
 * ë‚ ì§œ ë²”ìœ„ì˜ ëª¨ë“  ë‚ ì§œ ìƒì„± (ì œì™¸ì¼ ì œì™¸) - ê°„ë‹¨í•œ ë²„ì „
 */
function calculateAvailableDatesSimple(
  periodStart: string,
  periodEnd: string,
  exclusions: PlanExclusion[]
): string[] {
  const startDate = new Date(periodStart);
  const endDate = new Date(periodEnd);
  const dates: string[] = [];
  const exclusionDates = new Set(exclusions.map(e => e.exclusion_date));

  const current = new Date(startDate);
  current.setHours(0, 0, 0, 0);

  const end = new Date(endDate);
  end.setHours(23, 59, 59, 999);

  while (current <= end) {
    const dateStr = formatDateSimple(current);
    if (!exclusionDates.has(dateStr)) {
      dates.push(dateStr);
    }
    current.setDate(current.getDate() + 1);
  }

  return dates;
}

/**
 * ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ - ê°„ë‹¨í•œ ë²„ì „
 */
function formatDateSimple(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

/**
 * ì‹œê°„ ë¬¸ìì—´ì„ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
 */
function timeToMinutes(time: string): number {
  const [hours, minutes] = time.split(":").map(Number);
  return hours * 60 + minutes;
}

/**
 * ë¶„ ë‹¨ìœ„ë¥¼ ì‹œê°„ ë¬¸ìì—´ë¡œ ë³€í™˜
 */
function minutesToTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}

/**
 * ì½˜í…ì¸ ì˜ íŠ¹ì • ë²”ìœ„ì— ëŒ€í•œ ì†Œìš”ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
 * - ê°•ì˜: duration ì‚¬ìš©
 * - ì±…: í˜ì´ì§€ë‹¹ ê¸°ë³¸ 2ë¶„ (ì´ í˜ì´ì§€ ìˆ˜ ê¸°ë°˜)
 * - ì»¤ìŠ¤í…€: total_page_or_time ì‚¬ìš© (í˜ì´ì§€ë©´ 2ë¶„/í˜ì´ì§€, ì‹œê°„ì´ë©´ ê·¸ëŒ€ë¡œ)
 */
function calculateContentDuration(
  content: ContentInfo,
  startPageOrTime: number,
  endPageOrTime: number,
  durationMap?: ContentDurationMap
): number {
  const durationInfo = durationMap?.get(content.content_id);
  const amount = endPageOrTime - startPageOrTime;

  if (content.content_type === "lecture") {
    // ê°•ì˜: duration ì •ë³´ ì‚¬ìš©
    if (durationInfo?.duration) {
      // ì „ì²´ ê°•ì˜ ì‹œê°„ì„ ì „ì²´ íšŒì°¨ë¡œ ë‚˜ëˆˆ ê°’ * ë°°ì •ëœ íšŒì°¨ ìˆ˜
      // TODO: ì‹¤ì œë¡œëŠ” ê°•ì˜ë³„ íšŒì°¨ë‹¹ ì‹œê°„ì„ ì¡°íšŒí•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬
      // durationì´ ì „ì²´ ê°•ì˜ ì‹œê°„ì´ë©´, ì „ì²´ íšŒì°¨ ìˆ˜ë¥¼ ì•Œì•„ì•¼ í•¨
      // ì¼ë‹¨ durationì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì „ì²´ ê°•ì˜ ì‹œê°„ì´ë¼ê³  ê°€ì •)
      return Math.round((durationInfo.duration / (content.end_range - content.start_range)) * amount);
    }
    // duration ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’: íšŒì°¨ë‹¹ 30ë¶„
    return amount * 30;
  } else if (content.content_type === "book") {
    // ì±…: í˜ì´ì§€ë‹¹ ê¸°ë³¸ 2ë¶„
    return amount * 2;
  } else {
    // ì»¤ìŠ¤í…€: total_page_or_timeì´ í˜ì´ì§€ë©´ 2ë¶„/í˜ì´ì§€, ì‹œê°„ì´ë©´ ê·¸ëŒ€ë¡œ
    if (durationInfo?.total_page_or_time) {
      // total_page_or_timeì´ 100 ì´ìƒì´ë©´ í˜ì´ì§€ë¡œ ê°„ì£¼, ì•„ë‹ˆë©´ ì‹œê°„(ë¶„)ìœ¼ë¡œ ê°„ì£¼
      if (durationInfo.total_page_or_time >= 100) {
        return amount * 2; // í˜ì´ì§€ë‹¹ 2ë¶„
      } else {
        // ì‹œê°„(ë¶„)ìœ¼ë¡œ ê°„ì£¼: ì „ì²´ ì‹œê°„ì„ ì „ì²´ ë²”ìœ„ë¡œ ë‚˜ëˆˆ ê°’ * ë°°ì •ëœ ë²”ìœ„
        return Math.round((durationInfo.total_page_or_time / (content.end_range - content.start_range)) * amount);
      }
    }
    // ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’: í˜ì´ì§€ë‹¹ 2ë¶„
    return amount * 2;
  }
}

/**
 * í•™ìŠµ ê°€ëŠ¥í•œ ë‚ ì§œ ëª©ë¡ ê³„ì‚° (ì œì™¸ì¼ ì œì™¸)
 */
function calculateAvailableDates(
  periodStart: string,
  periodEnd: string,
  exclusions: PlanExclusion[]
): string[] {
  const start = new Date(periodStart);
  const end = new Date(periodEnd);
  const exclusionDates = new Set(
    exclusions.map((e) => e.exclusion_date.split("T")[0])
  );

  const dates: string[] = [];
  const current = new Date(start);

  while (current <= end) {
    const dateStr = current.toISOString().split("T")[0];
    if (!exclusionDates.has(dateStr)) {
      dates.push(dateStr);
    }
    current.setDate(current.getDate() + 1);
  }

  return dates;
}

/**
 * ê¸°ë³¸ ìŠ¤ì¼€ì¤„ëŸ¬: í•™ìŠµ ë²”ìœ„ë¥¼ í•™ìŠµì¼ë¡œ ë‚˜ëˆ„ì–´ ë°°ì •
 */
function generateDefaultPlans(
  dates: string[],
  contents: ContentInfo[],
  blocks: BlockInfo[],
  academySchedules: AcademySchedule[],
  exclusions: PlanExclusion[],
  riskIndexMap?: Map<string, { riskScore: number }>,
  dateAvailableTimeRanges?: DateAvailableTimeRanges,
  dateTimeSlots?: DateTimeSlots,
  contentDurationMap?: ContentDurationMap
): ScheduledPlan[] {
  const plans: ScheduledPlan[] = [];
  const totalStudyDays = dates.length;

  if (totalStudyDays === 0 || contents.length === 0) {
    return plans;
  }

  // 1. ì½˜í…ì¸ ë³„ ì¼ì¼ ë°°ì •ëŸ‰ ê³„ì‚° (í•™ìŠµ ë²”ìœ„ë¥¼ í•™ìŠµì¼ë¡œ ë‚˜ëˆ„ê¸°)
  const contentDailyAmounts = new Map<string, number[]>();
  contents.forEach((content) => {
    const dailyAmount = Math.round(content.total_amount / totalStudyDays);
    const amounts: number[] = [];
    let remaining = content.total_amount;
    let currentStart = content.start_range;

    for (let i = 0; i < totalStudyDays; i++) {
      const amount = i === totalStudyDays - 1 ? remaining : dailyAmount;
      amounts.push(amount);
      remaining -= amount;
    }

    contentDailyAmounts.set(content.content_id, amounts);
  });

  // 2. ì·¨ì•½ê³¼ëª© ìš°ì„  ë°°ì • (Risk Index ê¸°ë°˜)
  const sortedContents = [...contents].sort((a, b) => {
    const aSubject = a.subject?.toLowerCase().trim() || "";
    const bSubject = b.subject?.toLowerCase().trim() || "";
    const aRisk = riskIndexMap?.get(aSubject)?.riskScore || 0;
    const bRisk = riskIndexMap?.get(bSubject)?.riskScore || 0;
    return bRisk - aRisk; // ìœ„í—˜ë„ê°€ ë†’ì€ ìˆœì„œëŒ€ë¡œ
  });

  // 3. ê° ë‚ ì§œë³„ë¡œ ì½˜í…ì¸  ë°°ì • (ë¨¼ì € í”Œëœ ìƒì„±, ë¸”ë¡ì€ ë‚˜ì¤‘ì— ë™ì  ìƒì„±)
  const plansByDate = new Map<string, Array<{
    content: ContentInfo;
    dailyAmount: number;
    currentStart: number;
  }>>();

  dates.forEach((date, dateIndex) => {
    const datePlans: Array<{
      content: ContentInfo;
      dailyAmount: number;
      currentStart: number;
    }> = [];

    sortedContents.forEach((content) => {
      const dailyAmounts = contentDailyAmounts.get(content.content_id) || [];
      const dailyAmount = dailyAmounts[dateIndex] || 0;

      if (dailyAmount === 0) return;

      const currentStart = content.start_range + dailyAmounts.slice(0, dateIndex).reduce((sum, amt) => sum + amt, 0);
      
      datePlans.push({
        content,
        dailyAmount,
        currentStart,
      });
    });

    if (datePlans.length > 0) {
      plansByDate.set(date, datePlans);
    }
  });

  // 4. ê° ë‚ ì§œë³„ë¡œ í•„ìš”í•œ ë§Œí¼ ë¸”ë¡ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê³  í”Œëœì— í• ë‹¹
  plansByDate.forEach((datePlans, date) => {
    // Step 2.5ì˜ available_time_ranges ì‚¬ìš© (ìˆìœ¼ë©´)
    const availableRanges = dateAvailableTimeRanges?.get(date) || [];
    
    // ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œê°„ ë²”ìœ„ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
    if (availableRanges.length === 0) {
      // ê¸°ì¡´ ë°©ì‹: ìš”ì¼ë³„ ë¸”ë¡ ì‚¬ìš©
      const dayOfWeek = new Date(date).getDay();
      const dayBlocks = blocks.filter((b) => b.day_of_week === dayOfWeek);
      const availableBlocks = filterBlocksByAcademySchedule(
        dayBlocks,
        date,
        academySchedules
      );

      if (availableBlocks.length === 0) return;

      availableBlocks.sort((a, b) => a.block_index - b.block_index);
      const totalBlockDuration = availableBlocks.reduce(
        (sum, block) => sum + block.duration_minutes,
        0
      );

      let blockIndex = 0;
      let currentBlockDuration = 0;

      datePlans.forEach(({ content, dailyAmount, currentStart: start }) => {
        const contentDuration = Math.round(
          (dailyAmount / content.total_amount) * totalBlockDuration
        );

        let remainingDuration = contentDuration;
        let currentStart = start;

        while (remainingDuration > 0 && blockIndex < availableBlocks.length) {
          const block = availableBlocks[blockIndex];
          const blockRemaining = block.duration_minutes - currentBlockDuration;
          const assignedDuration = Math.min(remainingDuration, blockRemaining);

          const amountRatio = assignedDuration / contentDuration;
          const assignedAmount = Math.round(dailyAmount * amountRatio);
          const endAmount = Math.min(
            currentStart + assignedAmount,
            content.end_range
          );

          plans.push({
            plan_date: date,
            block_index: block.block_index,
            content_type: content.content_type,
            content_id: content.content_id,
            planned_start_page_or_time: currentStart,
            planned_end_page_or_time: endAmount,
            is_reschedulable: true,
            start_time: block.start_time, // ë¸”ë¡ì˜ ì‹œì‘ ì‹œê°„
            end_time: block.end_time, // ë¸”ë¡ì˜ ì¢…ë£Œ ì‹œê°„
          });

          currentStart = endAmount;
          remainingDuration -= assignedDuration;
          currentBlockDuration += assignedDuration;

          if (currentBlockDuration >= block.duration_minutes) {
            blockIndex++;
            currentBlockDuration = 0;
          }
        }
      });
    } else {
      // Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ ì‚¬ìš©: ì½˜í…ì¸  ì†Œìš”ì‹œê°„ì— ë§ì¶° ì‹œê°„ ë°°ì •
      // time_slotsì—ì„œ "í•™ìŠµì‹œê°„" ìŠ¬ë¡¯ë§Œ ì¶”ì¶œí•˜ì—¬ ì‚¬ìš©
      const timeSlots = dateTimeSlots?.get(date) || [];
      const studyTimeSlots = timeSlots.filter((slot) => slot.type === "í•™ìŠµì‹œê°„");
      
      let slotIndex = 0;
      let blockIndex = 1; // ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë¸”ë¡ ì¸ë±ìŠ¤
      let currentSlotPosition = 0; // í˜„ì¬ ìŠ¬ë¡¯ ë‚´ì—ì„œ ì‚¬ìš©í•œ ì‹œê°„ (ë¶„)

      datePlans.forEach(({ content, dailyAmount, currentStart: start }) => {
        // ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ê³„ì‚°
        const endPageOrTime = Math.min(start + dailyAmount, content.end_range);
        const requiredMinutes = calculateContentDuration(
          content,
          start,
          endPageOrTime,
          contentDurationMap
        );

        let remainingMinutes = requiredMinutes;

        // í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ available_time_ranges ì‚¬ìš©
        if (studyTimeSlots.length > 0) {
          while (remainingMinutes > 0 && slotIndex < studyTimeSlots.length) {
            const slot = studyTimeSlots[slotIndex];
            const slotStart = timeToMinutes(slot.start);
            const slotEnd = timeToMinutes(slot.end);
            const slotAvailable = slotEnd - slotStart - currentSlotPosition;
            const slotUsed = Math.min(remainingMinutes, slotAvailable);

            const planStartTime = minutesToTime(slotStart + currentSlotPosition);
            const planEndTime = minutesToTime(slotStart + currentSlotPosition + slotUsed);

            plans.push({
              plan_date: date,
              block_index: blockIndex,
              content_type: content.content_type,
              content_id: content.content_id,
              planned_start_page_or_time: start,
              planned_end_page_or_time: endPageOrTime,
              is_reschedulable: true,
              start_time: planStartTime,
              end_time: planEndTime,
            });

            remainingMinutes -= slotUsed;
            currentSlotPosition += slotUsed;
            blockIndex++;

            // í˜„ì¬ ìŠ¬ë¡¯ì„ ëª¨ë‘ ì‚¬ìš©í–ˆìœ¼ë©´ ë‹¤ìŒ ìŠ¬ë¡¯ìœ¼ë¡œ
            if (currentSlotPosition >= (slotEnd - slotStart)) {
              slotIndex++;
              currentSlotPosition = 0;
            }
          }
        } else {
          // í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì´ ì—†ìœ¼ë©´ available_time_ranges ì‚¬ìš© (ê¸°ì¡´ ë°©ì‹)
          if (slotIndex >= availableRanges.length) {
            slotIndex = availableRanges.length - 1;
          }

          const timeRange = availableRanges[slotIndex];
          const startMinutes = timeToMinutes(timeRange.start);
          const endMinutes = timeToMinutes(timeRange.end);
          const rangeDuration = endMinutes > startMinutes ? endMinutes - startMinutes : 60;

          // ì†Œìš”ì‹œê°„ì´ ë²”ìœ„ë³´ë‹¤ ì‘ìœ¼ë©´ í•´ë‹¹ ì‹œê°„ë§Œí¼ë§Œ ì‚¬ìš©
          const actualDuration = Math.min(requiredMinutes, rangeDuration);
          const planStartTime = minutesToTime(startMinutes + currentSlotPosition);
          const planEndTime = minutesToTime(startMinutes + currentSlotPosition + actualDuration);

          plans.push({
            plan_date: date,
            block_index: blockIndex,
            content_type: content.content_type,
            content_id: content.content_id,
            planned_start_page_or_time: start,
            planned_end_page_or_time: endPageOrTime,
            is_reschedulable: true,
            start_time: planStartTime,
            end_time: planEndTime,
          });

          currentSlotPosition += actualDuration;
          blockIndex++;

          // í˜„ì¬ ë²”ìœ„ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìœ¼ë©´ ë‹¤ìŒ ë²”ìœ„ë¡œ
          if (currentSlotPosition >= rangeDuration) {
            slotIndex++;
            currentSlotPosition = 0;
          }
        }
      });
    }
  });

  return plans;
}

/**
 * 1730 Timetable ìŠ¤ì¼€ì¤„ëŸ¬: í•™ìŠµ ë²”ìœ„ë¥¼ í•™ìŠµì¼ë¡œ ë‚˜ëˆ„ê³  ë³µìŠµì¼ì—ëŠ” í•´ë‹¹ ì£¼ì°¨ ë²”ìœ„ ë³µìŠµ
 */
function generate1730TimetablePlans(
  dates: string[],
  contents: ContentInfo[],
  blocks: BlockInfo[],
  academySchedules: AcademySchedule[],
  exclusions: PlanExclusion[],
  options?: any,
  riskIndexMap?: Map<string, { riskScore: number }>,
  dateAvailableTimeRanges?: DateAvailableTimeRanges,
  dateTimeSlots?: DateTimeSlots,
  contentDurationMap?: ContentDurationMap
): ScheduledPlan[] {
  const plans: ScheduledPlan[] = [];
  const studyDays = options?.study_days ?? 6;
  const reviewDays = options?.review_days ?? 1;
  const weekSize = studyDays + reviewDays;

  // ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì • ì¶”ì¶œ
  const subjectAllocations = options?.subject_allocations as
    | Array<{
        subject_id?: string;
        subject_name: string;
        subject_type: "strategy" | "weakness";
        weekly_days?: number;
      }>
    | undefined;
  const contentAllocations = options?.content_allocations as
    | Array<{
        content_type: "book" | "lecture" | "custom";
        content_id: string;
        subject_type: "strategy" | "weakness";
        weekly_days?: number;
      }>
    | undefined;

  // ë°ì´í„° ê²€ì¦
  const validation = validateAllocations(contentAllocations, subjectAllocations);
  if (!validation.valid) {
    console.warn("[generate1730TimetablePlans] ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì • ê²€ì¦ ì‹¤íŒ¨:", {
      errors: validation.errors,
      subjectAllocations,
      contentAllocations,
    });
    // ê²€ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì§„í–‰í•˜ë˜, ì˜ëª»ëœ ì„¤ì •ì€ ë¬´ì‹œ
  }

  console.log("[generate1730TimetablePlans] ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì •:", {
    hasSubjectAllocations: !!subjectAllocations,
    subjectAllocationsCount: subjectAllocations?.length || 0,
    hasContentAllocations: !!contentAllocations,
    contentAllocationsCount: contentAllocations?.length || 0,
    validationPassed: validation.valid,
    subjectAllocations: subjectAllocations,
    contentAllocations: contentAllocations,
  });

  // í•™ìŠµì¼/ë³µìŠµì¼ ì£¼ê¸° ì •ë³´ ìƒì„±
  const periodStart = dates[0];
  const periodEnd = dates[dates.length - 1];
  const cycleDays = calculateStudyReviewCycle(
    periodStart,
    periodEnd,
    { study_days: studyDays, review_days: reviewDays },
    exclusions
  );

  // dates ë°°ì—´ê³¼ cycleDays ê°„ì˜ ì¼ê´€ì„± í™•ì¸
  const cycleDaysDates = new Set(cycleDays.map(d => d.date));
  const datesSet = new Set(dates);
  const missingInCycleDays = dates.filter(d => !cycleDaysDates.has(d));
  const missingInDates = cycleDays.filter(d => d.day_type !== "exclusion" && !datesSet.has(d.date));
  
  if (missingInCycleDays.length > 0 || missingInDates.length > 0) {
    console.warn("[generate1730TimetablePlans] dates ë°°ì—´ê³¼ cycleDays ê°„ ë¶ˆì¼ì¹˜:", {
      datesCount: dates.length,
      cycleDaysCount: cycleDays.length,
      missingInCycleDays: missingInCycleDays,
      missingInDates: missingInDates.map(d => ({ date: d.date, day_type: d.day_type })),
    });
  }

  console.log("[generate1730TimetablePlans] ê¸°ê°„ ë° ì£¼ê¸° ì •ë³´:", {
    periodStart,
    periodEnd,
    datesCount: dates.length,
    cycleDaysCount: cycleDays.length,
    studyDaysCount: cycleDays.filter(d => d.day_type === "study").length,
    reviewDaysCount: cycleDays.filter(d => d.day_type === "review").length,
    exclusionDaysCount: cycleDays.filter(d => d.day_type === "exclusion").length,
  });

  // ì·¨ì•½ê³¼ëª© ì§‘ì¤‘ ëª¨ë“œ í™•ì¸
  const weakSubjectFocus = options?.weak_subject_focus === "high" || options?.weak_subject_focus === true;
  
  // ì·¨ì•½ê³¼ëª© í•„í„°ë§ (Risk Score 30 ì´ìƒ)
  let filteredContents = contents;
  if (weakSubjectFocus && riskIndexMap) {
    filteredContents = contents.filter((content) => {
      const subject = content.subject?.toLowerCase().trim() || "";
      const risk = riskIndexMap.get(subject);
      return risk && risk.riskScore >= 30;
    });

    // í•„í„°ë§ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì „ì²´ ì½˜í…ì¸  ì‚¬ìš©
    if (filteredContents.length === 0) {
      filteredContents = contents;
    }
  }

  // ì½˜í…ì¸ ë³„ ë°°ì • ë‚ ì§œ ê³„ì‚° (ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì • ë°˜ì˜)
  const contentAllocationMap = new Map<string, string[]>();
  filteredContents.forEach((content) => {
    const allocation = getContentAllocation(
      {
        content_type: content.content_type,
        content_id: content.content_id,
        subject_category: content.subject_category || undefined,
        subject: content.subject || undefined,
      },
      contentAllocations,
      subjectAllocations
    );

    console.log("[generate1730TimetablePlans] ì½˜í…ì¸  ë°°ì • ì„¤ì •:", {
      content_id: content.content_id,
      content_type: content.content_type,
      subject: content.subject,
      subject_category: content.subject_category,
      allocation,
    });

    // SubjectAllocation í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const subjectAlloc = {
      subject_id: content.content_id, // ì„ì‹œ ID
      subject_name: content.subject_category || content.subject || "",
      subject_type: allocation.subject_type,
      weekly_days: allocation.weekly_days,
    };

    const allocatedDates = calculateSubjectAllocationDates(
      cycleDays,
      subjectAlloc
    );

    const totalStudyDates = cycleDays.filter((d) => d.day_type === "study").length;
    
    // í•™ìŠµì¼ ë°°ì • ê²€ì¦: allocatedDatesê°€ ì‹¤ì œë¡œ í•™ìŠµì¼ì¸ì§€ í™•ì¸
    const studyDatesSet = new Set(
      cycleDays.filter(d => d.day_type === "study").map(d => d.date)
    );
    const invalidDates = allocatedDates.filter(date => !studyDatesSet.has(date));
    
    if (invalidDates.length > 0) {
      console.warn("[generate1730TimetablePlans] í•™ìŠµì¼ì´ ì•„ë‹Œ ë‚ ì§œê°€ ë°°ì •ë¨:", {
        content_id: content.content_id,
        invalidDates,
        allocatedDates,
      });
    }
    
    // í•™ìŠµì¼ ë°°ì • ê²€ì¦
    if (allocatedDates.length === 0) {
      console.warn("[generate1730TimetablePlans] í•™ìŠµì¼ ë°°ì • ì‹¤íŒ¨:", {
        content_id: content.content_id,
        content_type: content.content_type,
        subject_type: allocation.subject_type,
        weekly_days: allocation.weekly_days,
        totalStudyDatesCount: totalStudyDates,
        message: "í•™ìŠµì¼ì´ ë°°ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ ì½˜í…ì¸ ëŠ” í”Œëœì´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
      });
      // í•™ìŠµì¼ì´ ë°°ì •ë˜ì§€ ì•Šì€ ê²½ìš° ë¹ˆ ë°°ì—´ ì €ì¥ (ë‚˜ì¤‘ì— ìŠ¤í‚µë¨)
      contentAllocationMap.set(content.content_id, []);
      return;
    }
    
    // í•™ìŠµì¼ ë°°ì • ê²€ì¦: ìµœì†Œ 1ê°œ ì´ìƒì˜ í•™ìŠµì¼ì´ ë°°ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
    const validAllocatedDates = allocatedDates.filter(date => studyDatesSet.has(date));
    if (validAllocatedDates.length === 0) {
      console.warn("[generate1730TimetablePlans] ìœ íš¨í•œ í•™ìŠµì¼ ë°°ì • ì—†ìŒ:", {
        content_id: content.content_id,
        allocatedDates,
        totalStudyDatesCount: totalStudyDates,
        message: "ìœ íš¨í•œ í•™ìŠµì¼ì´ ë°°ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ ì½˜í…ì¸ ëŠ” í”Œëœì´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
      });
      contentAllocationMap.set(content.content_id, []);
      return;
    }
    
    // ìœ íš¨í•œ í•™ìŠµì¼ë§Œ ì‚¬ìš©
    if (validAllocatedDates.length !== allocatedDates.length) {
      console.warn("[generate1730TimetablePlans] ì¼ë¶€ ë‚ ì§œê°€ í•™ìŠµì¼ì´ ì•„ë‹˜, í•„í„°ë§:", {
        content_id: content.content_id,
        originalCount: allocatedDates.length,
        validCount: validAllocatedDates.length,
        invalidDates: allocatedDates.filter(date => !studyDatesSet.has(date)),
      });
    }

    console.log("[generate1730TimetablePlans] ë°°ì • ë‚ ì§œ ê³„ì‚° ê²°ê³¼:", {
      content_id: content.content_id,
      subject_type: allocation.subject_type,
      weekly_days: allocation.weekly_days,
      allocatedDatesCount: validAllocatedDates.length,
      totalStudyDatesCount: totalStudyDates,
      allocatedDates: validAllocatedDates.slice(0, 10), // ì²˜ìŒ 10ê°œë§Œ
    });

    contentAllocationMap.set(content.content_id, validAllocatedDates);
  });

  // í•™ìŠµ ë²”ìœ„ ë¶„í•  (ë°°ì •ëœ ë‚ ì§œì— í•™ìŠµ ë²”ìœ„ ë¶„ë°°)
  const contentRangeMap = new Map<string, Map<string, { start: number; end: number }>>();
  filteredContents.forEach((content) => {
    const allocatedDates = contentAllocationMap.get(content.content_id) || [];
    
    // í•™ìŠµì¼ ë°°ì • ê²€ì¦: í•™ìŠµì¼ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    if (allocatedDates.length === 0) {
      console.warn("[generate1730TimetablePlans] í•™ìŠµ ë²”ìœ„ ë¶„í•  ìŠ¤í‚µ (í•™ìŠµì¼ ì—†ìŒ):", {
        content_id: content.content_id,
        content_type: content.content_type,
      });
      return;
    }
    
    const rangeMap = divideContentRange(
      content.total_amount,
      allocatedDates,
      content.content_id
    );
    
    // í•™ìŠµ ë²”ìœ„ ë¶„í•  ê²°ê³¼ ê²€ì¦
    if (rangeMap.size === 0) {
      console.warn("[generate1730TimetablePlans] í•™ìŠµ ë²”ìœ„ ë¶„í•  ê²°ê³¼ ì—†ìŒ:", {
        content_id: content.content_id,
        allocatedDatesCount: allocatedDates.length,
        total_amount: content.total_amount,
      });
      return;
    }
    
    // start_rangeë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜¤í”„ì…‹ ì ìš©
    const adjustedRangeMap = new Map<string, { start: number; end: number }>();
    rangeMap.forEach((range, date) => {
      adjustedRangeMap.set(date, {
        start: content.start_range + range.start,
        end: content.start_range + range.end,
      });
    });
    contentRangeMap.set(content.content_id, adjustedRangeMap);
  });

  // ì£¼ì°¨ë³„ë¡œ ê·¸ë£¹í™” (cycleDays ê¸°ë°˜ - ì œì™¸ì¼ ê³ ë ¤)
  const weeks = new Map<number, {
    studyDays: string[];
    reviewDays: string[];
    allDays: string[];
  }>();
  
  // cycleDaysë¥¼ ì£¼ì°¨ë³„ë¡œ ê·¸ë£¹í™”
  cycleDays.forEach((cycleDay) => {
    if (cycleDay.day_type === "exclusion") {
      // ì œì™¸ì¼ì€ ì£¼ì°¨ ê·¸ë£¹í™”ì—ì„œ ì œì™¸
      return;
    }
    
    const cycleNumber = cycleDay.cycle_number;
    if (!weeks.has(cycleNumber)) {
      weeks.set(cycleNumber, {
        studyDays: [],
        reviewDays: [],
        allDays: [],
      });
    }
    
    const week = weeks.get(cycleNumber)!;
    week.allDays.push(cycleDay.date);
    
    if (cycleDay.day_type === "study") {
      week.studyDays.push(cycleDay.date);
    } else if (cycleDay.day_type === "review") {
      week.reviewDays.push(cycleDay.date);
    }
  });

  // ê° ì£¼ì°¨ë³„ë¡œ í•™ìŠµì¼ê³¼ ë³µìŠµì¼ ë¶„ë¦¬
  console.log("[generate1730TimetablePlans] ì£¼ì°¨ë³„ ê·¸ë£¹í™” ê²°ê³¼:", {
    totalWeeks: weeks.size,
    weeksInfo: Array.from(weeks.entries()).map(([cycleNumber, week]) => ({
      cycleNumber,
      studyDaysCount: week.studyDays.length,
      reviewDaysCount: week.reviewDays.length,
      allDaysCount: week.allDays.length,
    })),
  });
  
  Array.from(weeks.entries()).forEach(([cycleNumber, week]) => {
    const studyDaysList = week.studyDays;
    const reviewDaysList = week.reviewDays;

    console.log("[generate1730TimetablePlans] ì£¼ì°¨ë³„ í•™ìŠµì¼/ë³µìŠµì¼:", {
      cycleNumber,
      studyDays: studyDaysList,
      reviewDays: reviewDaysList,
    });

    // ì´ë²ˆ ì£¼ í•™ìŠµì¼ì— ë°°ì •ëœ ì½˜í…ì¸  ë²”ìœ„ ì €ì¥ (ë³µìŠµìš©)
    const weekContentRanges = new Map<string, {
      startAmount: number;
      endAmount: number;
    }>();

    // 1. í•™ìŠµì¼: ë°°ì •ëœ ë‚ ì§œì—ë§Œ í”Œëœ ìƒì„± (ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì • ë°˜ì˜)
    // ì·¨ì•½ê³¼ëª© ìš°ì„  ë°°ì • (ì •ë ¬)
    const sortedContents = [...filteredContents].sort((a, b) => {
      const aSubject = a.subject?.toLowerCase().trim() || "";
      const bSubject = b.subject?.toLowerCase().trim() || "";
      const aRisk = riskIndexMap?.get(aSubject)?.riskScore || 0;
      const bRisk = riskIndexMap?.get(bSubject)?.riskScore || 0;
      return bRisk - aRisk;
    });

    // ë°°ì •ëœ ë‚ ì§œë³„ë¡œ í”Œëœ ìƒì„±
    const studyPlansByDate = new Map<string, Array<{
      content: ContentInfo;
      start: number;
      end: number;
    }>>();

    // ê° ì½˜í…ì¸ ì˜ ë°°ì •ëœ ë‚ ì§œì— ëŒ€í•´ í”Œëœ ìƒì„±
    sortedContents.forEach((content) => {
      const rangeMap = contentRangeMap.get(content.content_id);
      if (!rangeMap) return;

      rangeMap.forEach((range, date) => {
        // ì´ë²ˆ ì£¼ì˜ í•™ìŠµì¼ì— í¬í•¨ë˜ëŠ” ë‚ ì§œì¸ì§€ í™•ì¸
        if (!studyDaysList.includes(date)) return;

        if (!studyPlansByDate.has(date)) {
          studyPlansByDate.set(date, []);
        }
        studyPlansByDate.get(date)!.push({
          content,
          start: range.start,
          end: range.end,
        });
      });
    });

    // í•™ìŠµì¼ í”Œëœì— ë¸”ë¡ í• ë‹¹ (ë™ì  ìƒì„±)
    console.log("[generate1730TimetablePlans] í•™ìŠµì¼ í”Œëœ ìƒì„± ì‹œì‘:", {
      cycleNumber,
      studyDaysList,
      studyPlansByDateCount: studyPlansByDate.size,
      studyPlansByDateKeys: Array.from(studyPlansByDate.keys()),
      totalContentsCount: sortedContents.length,
      contentsWithRangeMap: Array.from(contentRangeMap.keys()).length,
    });
    
    // í•™ìŠµì¼ í”Œëœì´ ì—†ëŠ” ê²½ìš° ê²½ê³ 
    if (studyPlansByDate.size === 0) {
      const errorMessage = `ì´ ì£¼ì°¨(${cycleNumber}ì£¼ì°¨)ì—ëŠ” í•™ìŠµì¼ í”Œëœì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë³µìŠµì¼ í”Œëœë„ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
      console.warn("[generate1730TimetablePlans] í•™ìŠµì¼ í”Œëœì´ ìƒì„±ë˜ì§€ ì•ŠìŒ:", {
        cycleNumber,
        studyDaysList,
        studyDaysCount: studyDaysList.length,
        totalContentsCount: sortedContents.length,
        contentsWithRangeMap: Array.from(contentRangeMap.keys()),
        contentsWithRangeMapCount: contentRangeMap.size,
        message: errorMessage,
        possibleCauses: [
          "ì „ëµê³¼ëª©/ì·¨ì•½ê³¼ëª© ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ",
          "í•™ìŠµì¼ ë°°ì • ë¡œì§ ì˜¤ë¥˜",
          "ì½˜í…ì¸  ë²”ìœ„ ë¶„í•  ì‹¤íŒ¨",
        ],
      });
    }
    
    studyPlansByDate.forEach((datePlans, date) => {
      const availableRanges = dateAvailableTimeRanges?.get(date) || [];
      const timeSlots = dateTimeSlots?.get(date) || [];
      const studyTimeSlots = timeSlots.filter((slot) => slot.type === "í•™ìŠµì‹œê°„");
      
      console.log("[generate1730TimetablePlans] í•™ìŠµì¼ í”Œëœ ìƒì„±:", {
        date,
        cycleNumber,
        plansCount: datePlans.length,
        availableRangesCount: availableRanges.length,
        studyTimeSlotsCount: studyTimeSlots.length,
      });
      
      let slotIndex = 0;
      let blockIndex = 1;
      let currentSlotPosition = 0;

      datePlans.forEach(({ content, start, end: endAmount }) => {
        
        // ì½˜í…ì¸  ì†Œìš”ì‹œê°„ ê³„ì‚°
        const requiredMinutes = calculateContentDuration(
          content,
          start,
          endAmount,
          contentDurationMap
        );

        let remainingMinutes = requiredMinutes;

        // í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ available_time_ranges ì‚¬ìš©
        if (studyTimeSlots.length > 0) {
          while (remainingMinutes > 0 && slotIndex < studyTimeSlots.length) {
            const slot = studyTimeSlots[slotIndex];
            const slotStart = timeToMinutes(slot.start);
            const slotEnd = timeToMinutes(slot.end);
            const slotAvailable = slotEnd - slotStart - currentSlotPosition;
            const slotUsed = Math.min(remainingMinutes, slotAvailable);

            const planStartTime = minutesToTime(slotStart + currentSlotPosition);
            const planEndTime = minutesToTime(slotStart + currentSlotPosition + slotUsed);

            plans.push({
              plan_date: date,
              block_index: blockIndex,
              content_type: content.content_type,
              content_id: content.content_id,
              planned_start_page_or_time: start,
              planned_end_page_or_time: endAmount,
              is_reschedulable: true,
              start_time: planStartTime,
              end_time: planEndTime,
            });

            remainingMinutes -= slotUsed;
            currentSlotPosition += slotUsed;
            blockIndex++;

            if (currentSlotPosition >= (slotEnd - slotStart)) {
              slotIndex++;
              currentSlotPosition = 0;
            }
          }
        } else {
          // í•™ìŠµì‹œê°„ ìŠ¬ë¡¯ì´ ì—†ìœ¼ë©´ available_time_ranges ì‚¬ìš©
          if (slotIndex >= availableRanges.length) {
            slotIndex = availableRanges.length - 1;
          }

          const timeRange = availableRanges[slotIndex] || { start: "10:00", end: "19:00" };
          const startMinutes = timeToMinutes(timeRange.start);
          const endMinutes = timeToMinutes(timeRange.end);
          const rangeDuration = endMinutes > startMinutes ? endMinutes - startMinutes : 60;
          const actualDuration = Math.min(requiredMinutes, rangeDuration);
          const planStartTime = minutesToTime(startMinutes + currentSlotPosition);
          const planEndTime = minutesToTime(startMinutes + currentSlotPosition + actualDuration);

          plans.push({
            plan_date: date,
            block_index: blockIndex,
            content_type: content.content_type,
            content_id: content.content_id,
            planned_start_page_or_time: start,
            planned_end_page_or_time: endAmount,
            is_reschedulable: true,
            start_time: planStartTime,
            end_time: planEndTime,
          });

          currentSlotPosition += actualDuration;
          blockIndex++;

          if (currentSlotPosition >= rangeDuration) {
            slotIndex++;
            currentSlotPosition = 0;
          }
        }

        // ì£¼ì°¨ë³„ ë²”ìœ„ ì €ì¥ (ë³µìŠµìš©) - ì´ë²ˆ ì£¼ì— ë°°ì •ëœ ë‚ ì§œì˜ ë²”ìœ„ë§Œ ì €ì¥
        if (studyDaysList.includes(date)) {
          if (!weekContentRanges.has(content.content_id)) {
            weekContentRanges.set(content.content_id, {
              startAmount: start,
              endAmount: endAmount,
            });
          } else {
            const existing = weekContentRanges.get(content.content_id)!;
            existing.startAmount = Math.min(existing.startAmount, start);
            existing.endAmount = Math.max(existing.endAmount, endAmount);
          }
        }
      });
    });

    // 2. ë³µìŠµì¼: í•´ë‹¹ ì£¼ì°¨ì˜ í•™ìŠµ ë²”ìœ„ë¥¼ ë³µìŠµ
    // í•™ìŠµì¼ì— ì‹¤ì œë¡œ í”Œëœì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
    const hasStudyPlans = studyPlansByDate.size > 0;
    const studyPlansCount = Array.from(studyPlansByDate.values()).reduce(
      (sum, plans) => sum + plans.length,
      0
    );
    
    console.log("[generate1730TimetablePlans] ì£¼ì°¨ë³„ í•™ìŠµì¼/ë³µìŠµì¼ ìƒíƒœ:", {
      cycleNumber,
      studyDaysCount: studyDaysList.length,
      reviewDaysCount: reviewDaysList.length,
      studyDaysList,
      reviewDaysList,
      studyPlansByDateCount: studyPlansByDate.size,
      studyPlansCount,
      weekContentRangesCount: weekContentRanges.size,
      weekContentRangesKeys: Array.from(weekContentRanges.keys()),
      hasStudyPlans,
    });
    
    // ë³µìŠµì¼ í”Œëœ ìƒì„± ì „ ì „ì²´ ê²€ì¦
    if (reviewDaysList.length > 0 && (!hasStudyPlans || studyPlansCount === 0)) {
      console.warn("[generate1730TimetablePlans] ë³µìŠµì¼ í”Œëœ ìƒì„± ë¶ˆê°€ (í•™ìŠµì¼ í”Œëœ ì—†ìŒ):", {
        cycleNumber,
        reviewDaysList,
        studyPlansCount,
        weekContentRangesCount: weekContentRanges.size,
        message: "í•™ìŠµì¼ í”Œëœì´ ì—†ì–´ ë³µìŠµì¼ í”Œëœì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
      });
    }
    
    reviewDaysList.forEach((reviewDay) => {
      // ë³µìŠµì¼ í”Œëœ ìƒì„± ê°€ë“œ: í•™ìŠµì¼ì— í”Œëœì´ ì—†ìœ¼ë©´ ë³µìŠµì¼ì—ë„ í”Œëœ ìƒì„± ì•ˆ í•¨
      if (!reviewDay || weekContentRanges.size === 0 || !hasStudyPlans || studyPlansCount === 0) {
        if (!hasStudyPlans || studyPlansCount === 0) {
          console.warn("[generate1730TimetablePlans] ë³µìŠµì¼ í”Œëœ ìƒì„± ìŠ¤í‚µ (í•™ìŠµì¼ í”Œëœ ì—†ìŒ):", {
            reviewDay,
            cycleNumber,
            studyPlansCount,
            weekContentRangesCount: weekContentRanges.size,
            hasStudyPlans,
          });
        } else if (weekContentRanges.size === 0) {
          console.warn("[generate1730TimetablePlans] ë³µìŠµì¼ í”Œëœ ìƒì„± ìŠ¤í‚µ (ë³µìŠµ ë²”ìœ„ ì—†ìŒ):", {
            reviewDay,
            cycleNumber,
            weekContentRangesCount: weekContentRanges.size,
          });
        }
        return;
      }

      // ë³µìŠµ ì½˜í…ì¸  ëª©ë¡ ìƒì„± (ì´ë²ˆ ì£¼ì— í•™ìŠµí•œ ì½˜í…ì¸ ë§Œ)
      const reviewContents = sortedContents.filter((content) =>
        weekContentRanges.has(content.content_id)
      );

      if (reviewContents.length === 0) {
        console.warn("[generate1730TimetablePlans] ë³µìŠµì¼ í”Œëœ ìƒì„± ìŠ¤í‚µ (ë³µìŠµ ì½˜í…ì¸  ì—†ìŒ):", {
          reviewDay,
          cycleNumber,
          weekContentRangesCount: weekContentRanges.size,
        });
        return;
      }

      // Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ ì‚¬ìš©: ë³µìŠµ ì½˜í…ì¸  ê°œìˆ˜ë§Œí¼ ë¸”ë¡ì„ ë™ì ìœ¼ë¡œ ìƒì„±
      const availableRanges = dateAvailableTimeRanges?.get(reviewDay) || [];
      let rangeIndex = 0;
      let blockIndex = 1;

      console.log("[generate1730TimetablePlans] ë³µìŠµì¼ í”Œëœ ìƒì„±:", {
        reviewDay,
        cycleNumber,
        reviewContentsCount: reviewContents.length,
        availableRangesCount: availableRanges.length,
      });
      
      reviewContents.forEach((content) => {
        const range = weekContentRanges.get(content.content_id);
        if (!range) return;

        if (rangeIndex >= availableRanges.length) {
          rangeIndex = availableRanges.length - 1;
        }

        const timeRange = availableRanges[rangeIndex] || { start: "10:00", end: "19:00" };

        console.log("[generate1730TimetablePlans] ë³µìŠµì¼ í”Œëœ ìƒì„± (ê°œë³„):", {
          reviewDay,
          cycleNumber,
          content_id: content.content_id,
          range: `${range.startAmount}~${range.endAmount}`,
          timeRange: `${timeRange.start}~${timeRange.end}`,
        });

        plans.push({
          plan_date: reviewDay,
          block_index: blockIndex,
          content_type: content.content_type,
          content_id: content.content_id,
          planned_start_page_or_time: range.startAmount,
          planned_end_page_or_time: range.endAmount,
          is_reschedulable: true,
          start_time: timeRange.start, // Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ì˜ ì‹œì‘ ì‹œê°„
          end_time: timeRange.end, // Step 2.5 ìŠ¤ì¼€ì¤„ ê²°ê³¼ì˜ ì¢…ë£Œ ì‹œê°„
        });

        blockIndex++;
        rangeIndex++;
      });
    });
  });

  return plans;
}

/**
 * í•™ì› ì¼ì •ê³¼ ê²¹ì¹˜ëŠ” ë¸”ë¡ í•„í„°ë§
 */
export function filterBlocksByAcademySchedule(
  blocks: BlockInfo[],
  date: string,
  academySchedules: AcademySchedule[]
): BlockInfo[] {
  const dayOfWeek = new Date(date).getDay();
  const dayAcademySchedules = academySchedules.filter(
    (s) => s.day_of_week === dayOfWeek
  );

  if (dayAcademySchedules.length === 0) {
    return blocks;
  }

  // í•™ì› ì¼ì •ê³¼ ê²¹ì¹˜ëŠ” ë¸”ë¡ ì œì™¸
  return blocks.filter((block) => {
    const blockStart = timeToMinutes(block.start_time);
    const blockEnd = timeToMinutes(block.end_time);

    return !dayAcademySchedules.some((academy) => {
      const academyStart = timeToMinutes(academy.start_time);
      const academyEnd = timeToMinutes(academy.end_time);

      // ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
      return (
        (blockStart >= academyStart && blockStart < academyEnd) ||
        (blockEnd > academyStart && blockEnd <= academyEnd) ||
        (blockStart <= academyStart && blockEnd >= academyEnd)
      );
    });
  });
}
</file>

<file path="statusManager.ts">
// í”Œëœ ìƒíƒœ ê´€ë¦¬ ë¡œì§

import { PlanStatus, PlanStatusTransition } from "@/lib/types/plan";

/**
 * í”Œëœ ìƒíƒœ ì „ì´ ê·œì¹™
 */
const STATUS_TRANSITIONS: Record<PlanStatus, PlanStatus[]> = {
  draft: ["saved", "paused"], // ì¤‘ë‹¨ì€ ì¼ì‹œì •ì§€ë¡œ í†µí•©
  saved: ["active", "draft", "paused"], // ì¤‘ë‹¨ì€ ì¼ì‹œì •ì§€ë¡œ í†µí•©
  active: ["paused", "completed"], // ì¤‘ë‹¨ì€ ì¼ì‹œì •ì§€ë¡œ í†µí•©
  paused: ["active"], // ì¼ì‹œì •ì§€ì—ì„œ ì¬ê°œë§Œ ê°€ëŠ¥ (ì™„ë£Œ/ì¤‘ë‹¨ì€ activeë¡œ ê°€ì„œ ì²˜ë¦¬)
  completed: [], // ì™„ë£Œ ìƒíƒœëŠ” ë³€ê²½ ë¶ˆê°€
  cancelled: ["active"], // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ (UIì—ì„œëŠ” í‘œì‹œ ì•ˆ í•¨)
};

/**
 * ìƒíƒœë³„ ì œì•½ ì¡°ê±´
 */
const STATUS_CONSTRAINTS: Record<
  PlanStatus,
  {
    canEdit: boolean;
    canDelete: boolean;
    canModifyContents: boolean;
    canModifyExclusions: boolean;
    description: string;
  }
> = {
  draft: {
    canEdit: true,
    canDelete: true,
    canModifyContents: true,
    canModifyExclusions: true,
    description: "ì´ˆì•ˆ ìƒíƒœ - ëª¨ë“  ìˆ˜ì • ê°€ëŠ¥",
  },
  saved: {
    canEdit: true,
    canDelete: true,
    canModifyContents: true,
    canModifyExclusions: true,
    description: "ì €ì¥ë¨ - ìˆ˜ì • ë° ì‚­ì œ ê°€ëŠ¥",
  },
  active: {
    canEdit: false, // ë©”íƒ€ë°ì´í„° ìˆ˜ì • ë¶ˆê°€
    canDelete: false, // ì‚­ì œ ë¶ˆê°€
    canModifyContents: false, // ì½˜í…ì¸  ìˆ˜ì • ë¶ˆê°€
    canModifyExclusions: true, // ì œì™¸ì¼ì€ ì¶”ê°€ ê°€ëŠ¥
    description: "í™œì„± ìƒíƒœ - ì‹¤í–‰ ì¤‘, ì œí•œì  ìˆ˜ì •ë§Œ ê°€ëŠ¥",
  },
  paused: {
    canEdit: false,
    canDelete: true, // ì¼ì‹œì •ì§€ ìƒíƒœì—ì„œë„ ì‚­ì œ ê°€ëŠ¥
    canModifyContents: false,
    canModifyExclusions: true,
    description: "ì¼ì‹œì •ì§€ ìƒíƒœ - ì‚­ì œ ê°€ëŠ¥",
  },
  completed: {
    canEdit: false,
    canDelete: true, // ì™„ë£Œ ìƒíƒœì—ì„œë„ ì‚­ì œ ê°€ëŠ¥
    canModifyContents: false,
    canModifyExclusions: false,
    description: "ì™„ë£Œ ìƒíƒœ - ì‚­ì œ ê°€ëŠ¥",
  },
  cancelled: {
    canEdit: false,
    canDelete: false,
    canModifyContents: false,
    canModifyExclusions: false,
    description: "ì¤‘ë‹¨ ìƒíƒœ (ì¼ì‹œì •ì§€ë¡œ í†µí•©ë¨) - ì½ê¸° ì „ìš©",
  },
};

/**
 * í”Œëœ ìƒíƒœ ê´€ë¦¬ì
 */
export class PlanStatusManager {
  /**
   * ìƒíƒœ ì „ì´ê°€ ê°€ëŠ¥í•œì§€ í™•ì¸
   */
  static canTransition(from: PlanStatus, to: PlanStatus): boolean {
    return STATUS_TRANSITIONS[from].includes(to);
  }

  /**
   * ê°€ëŠ¥í•œ ë‹¤ìŒ ìƒíƒœ ëª©ë¡ ì¡°íšŒ
   */
  static getAvailableTransitions(from: PlanStatus): PlanStatus[] {
    return STATUS_TRANSITIONS[from];
  }

  /**
   * ìƒíƒœ ì „ì´ ê·œì¹™ ì¡°íšŒ
   */
  static getTransitionRules(): PlanStatusTransition[] {
    const rules: PlanStatusTransition[] = [];

    for (const [from, allowedTo] of Object.entries(STATUS_TRANSITIONS)) {
      for (const to of allowedTo) {
        rules.push({
          from: from as PlanStatus,
          to: to as PlanStatus,
          allowed: true,
          condition: this.getTransitionCondition(from as PlanStatus, to as PlanStatus),
        });
      }
    }

    return rules;
  }

  /**
   * ìƒíƒœë³„ ì œì•½ ì¡°ê±´ ì¡°íšŒ
   */
  static getConstraints(status: PlanStatus) {
    return STATUS_CONSTRAINTS[status];
  }

  /**
   * ìƒíƒœì—ì„œ ìˆ˜ì • ê°€ëŠ¥í•œì§€ í™•ì¸
   */
  static canEdit(status: PlanStatus): boolean {
    return STATUS_CONSTRAINTS[status].canEdit;
  }

  /**
   * ìƒíƒœì—ì„œ ì‚­ì œ ê°€ëŠ¥í•œì§€ í™•ì¸
   */
  static canDelete(status: PlanStatus): boolean {
    return STATUS_CONSTRAINTS[status].canDelete;
  }

  /**
   * ìƒíƒœì—ì„œ ì½˜í…ì¸  ìˆ˜ì • ê°€ëŠ¥í•œì§€ í™•ì¸
   */
  static canModifyContents(status: PlanStatus): boolean {
    return STATUS_CONSTRAINTS[status].canModifyContents;
  }

  /**
   * ìƒíƒœì—ì„œ ì œì™¸ì¼ ìˆ˜ì • ê°€ëŠ¥í•œì§€ í™•ì¸
   */
  static canModifyExclusions(status: PlanStatus): boolean {
    return STATUS_CONSTRAINTS[status].canModifyExclusions;
  }

  /**
   * ìƒíƒœ ì „ì´ ì¡°ê±´ ì„¤ëª…
   */
  private static getTransitionCondition(
    from: PlanStatus,
    to: PlanStatus
  ): string {
    const conditions: Record<string, string> = {
      "draft->saved": "í”Œëœ ì €ì¥ ì™„ë£Œ",
      "draft->paused": "í”Œëœ ì¤‘ë‹¨",
      "saved->active": "í”Œëœ í™œì„±í™” (ì‹œì‘)",
      "saved->draft": "ë‹¤ì‹œ ì´ˆì•ˆìœ¼ë¡œ ë³€ê²½",
      "saved->paused": "í”Œëœ ì¤‘ë‹¨",
      "active->paused": "í”Œëœ ì¼ì‹œì •ì§€",
      "active->completed": "í”Œëœ ì™„ë£Œ",
      "paused->active": "í”Œëœ ì¬ê°œ",
      "cancelled->active": "ì¤‘ë‹¨ í•´ì œ (ì¬ê°œ)",
    };

    return conditions[`${from}->${to}`] || "ìƒíƒœ ì „ì´";
  }

  /**
   * ì´ˆê¸° ìƒíƒœ ë°˜í™˜
   */
  static getInitialStatus(): PlanStatus {
    return "draft";
  }

  /**
   * ì™„ë£Œ ìƒíƒœ í™•ì¸
   */
  static isTerminalStatus(status: PlanStatus): boolean {
    return status === "completed" || status === "cancelled";
  }

  /**
   * í™œì„± ìƒíƒœ í™•ì¸ (ì§„í–‰ ì¤‘ì¸ í”Œëœ)
   */
  static isActiveStatus(status: PlanStatus): boolean {
    return status === "active" || status === "paused";
  }
}
</file>

<file path="admissionStrategy.ts">
/**
 * ìˆ˜ì‹œ/ì •ì‹œ ìœ ë¶ˆë¦¬ ë¶„ì„ ì—”ì§„
 * 
 * ë‚´ì‹ ê³¼ ëª¨ì˜ê³ ì‚¬ ì„±ì ì„ ë¹„êµí•˜ì—¬ ìˆ˜ì‹œ/ì •ì‹œ ì „ëµì„ ë¶„ì„í•©ë‹ˆë‹¤.
 */

import { createSupabaseServerClient } from "@/lib/supabase/server";

type SupabaseServerClient = Awaited<ReturnType<typeof createSupabaseServerClient>>;

/**
 * ì „ëµ ìœ í˜•
 */
export type StrategyType =
  | "MOCK_ADVANTAGE" // ëª¨ì˜ê³ ì‚¬/ì •ì‹œ ìš°ìœ„
  | "INTERNAL_ADVANTAGE" // ë‚´ì‹ /ìˆ˜ì‹œ ìš°ìœ„
  | "BALANCED" // ê· í˜•í˜•
  | "SPECIAL_HIGH_SCHOOL"; // íŠ¹ëª©/ìì‚¬ê³  íŒ¨í„´

/**
 * ì „ëµ ë¶„ì„ ê²°ê³¼
 */
export type StrategyResult = {
  type: StrategyType;
  message: string;
  data: {
    internalPct: number | null;
    mockPct: number | null;
    diff: number | null;
  };
};

/**
 * ë‚´ì‹  GPAë¥¼ ë°±ë¶„ìœ„ë¡œ í™˜ì‚°
 * 
 * @param curriculumRevisionId - êµìœ¡ê³¼ì • ê°œì • ID
 * @param totalGpa - ì „ì²´ ë‚´ì‹  í‰ê·  ë“±ê¸‰
 * @returns í™˜ì‚°ëœ ë°±ë¶„ìœ„ ë˜ëŠ” null
 */
export async function getInternalPercentile(
  curriculumRevisionId: string,
  totalGpa: number
): Promise<number | null> {
  // grade_conversion_rules í…Œì´ë¸”ì´ ì—†ìœ¼ë¯€ë¡œ ê°„ë‹¨í•œ í™˜ì‚° ê³µì‹ ì‚¬ìš©
  // GPA 1.0 = 100%, GPA 9.0 = 0% (ì„ í˜• í™˜ì‚°)
  // ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ í™˜ì‚° ê³µì‹ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
  
  // ê¸°ë³¸ í™˜ì‚° ê³µì‹: percentile = 100 - (totalGpa - 1) * 12.5
  // GPA 1.0 â†’ 100%, GPA 2.0 â†’ 87.5%, GPA 3.0 â†’ 75%, ..., GPA 9.0 â†’ 0%
  const percentile = Math.max(0, Math.min(100, 100 - (totalGpa - 1) * 12.5));
  
  console.log(`[scores/admissionStrategy] GPA ${totalGpa} â†’ ë°±ë¶„ìœ„ ${percentile.toFixed(2)}%`);
  
  return percentile;
}

/**
 * ìˆ˜ì‹œ/ì •ì‹œ ìœ ë¶ˆë¦¬ ì „ëµ ë¶„ì„
 * 
 * @param internalPct - ë‚´ì‹  í™˜ì‚° ë°±ë¶„ìœ„
 * @param mockPct - ëª¨ì˜ê³ ì‚¬ í‰ê·  ë°±ë¶„ìœ„
 * @param zIndex - ë‚´ì‹  Z-Index (í•™ì—…ì—­ëŸ‰ ì§€ìˆ˜)
 * @returns ì „ëµ ë¶„ì„ ê²°ê³¼
 */
export function analyzeAdmissionStrategy(
  internalPct: number | null,
  mockPct: number | null,
  zIndex: number | null
): StrategyResult {
  if (internalPct == null || mockPct == null) {
    return {
      type: "BALANCED",
      message: "ë‚´ì‹  ë˜ëŠ” ëª¨ì˜ê³ ì‚¬ ë°ì´í„°ê°€ ë¶€ì¡±í•´ ì •ë°€ ë¹„êµê°€ ì–´ë µìŠµë‹ˆë‹¤.",
      data: { internalPct, mockPct, diff: null },
    };
  }

  const diff = mockPct - internalPct;

  let type: StrategyType;
  let message: string;

  if (diff > 5) {
    type = "MOCK_ADVANTAGE";
    message = "ì •ì‹œ íŒŒì´í„° ì „ëµì´ ìœ ë¦¬í•©ë‹ˆë‹¤. ìˆ˜ëŠ¥ ì¤‘ì‹¬ ë¡œë“œë§µì´ í•„ìš”í•©ë‹ˆë‹¤.";
  } else if (diff < -5) {
    type = "INTERNAL_ADVANTAGE";
    message = "ìˆ˜ì‹œ/í•™ìƒë¶€ ìœ„ì£¼ ì „ëµì´ ìœ ë¦¬í•©ë‹ˆë‹¤. ë‚´ì‹ Â·í•™êµí™œë™ì— ì§‘ì¤‘í•˜ì„¸ìš”.";
  } else {
    type = "BALANCED";
    message = "ìˆ˜ì‹œ/ì •ì‹œ ê· í˜•í˜•ì…ë‹ˆë‹¤. ë‘ ì¶• ëª¨ë‘ ì¤€ë¹„í•˜ëŠ” ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.";
  }

  // íŠ¹ëª©/ìì‚¬ê³  íŒ¨í„´: ë‚´ì‹  ë“±ê¸‰ì€ ë‚®ì€ë°, ë‚´ì‹  Z-Index + ëª¨ì˜ê³ ì‚¬ ì‹¤ë ¥ì€ ë†’ì€ ê²½ìš°
  if (diff > 5 && zIndex != null && zIndex >= 1.5) {
    type = "SPECIAL_HIGH_SCHOOL";
    message =
      "íŠ¹ëª©/ìì‚¬ê³  ìœ í˜• íŒ¨í„´ì…ë‹ˆë‹¤. ë‚´ì‹  ë“±ê¸‰ ëŒ€ë¹„ ì›ì ìˆ˜ ê²½ìŸë ¥ì´ ë†’ì•„ í•™ì¢…Â·ì •ì‹œ ë³‘í–‰ ì „ëµì´ ìœ ë¦¬í•©ë‹ˆë‹¤.";
  }

  return {
    type,
    message,
    data: { internalPct, mockPct, diff },
  };
}
</file>

<file path="gradeColors.ts">
/**
 * ì„±ì  ë“±ê¸‰ë³„ ìƒ‰ìƒ ì‹œìŠ¤í…œ
 * @deprecated lib/constants/colors.tsì˜ getGradeColor ì‚¬ìš© ê¶Œì¥
 * ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ë¨
 */

import { getGradeColor as getGradeColorFromColors, getTrendColor as getTrendColorFromColors } from "@/lib/constants/colors";

/**
 * ë“±ê¸‰ë³„ ìƒ‰ìƒ ë°˜í™˜ (1ë“±ê¸‰ì´ ê°€ì¥ ì¢‹ìŒ)
 * @deprecated lib/constants/colors.tsì˜ getGradeColor ì‚¬ìš© ê¶Œì¥
 */
export function getGradeColor(grade: number | null | undefined): {
  text: string;
  bg: string;
  border: string;
  badge: string;
} {
  const color = getGradeColorFromColors(grade);
  // hex ì†ì„± ì œê±°í•˜ì—¬ ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ ìœ ì§€
  return {
    text: color.text,
    bg: color.bg,
    border: color.border,
    badge: color.badge,
  };
}

/**
 * ì¶”ì„¸ë³„ ìƒ‰ìƒ ë°˜í™˜
 * @deprecated lib/constants/colors.tsì˜ getTrendColor ì‚¬ìš© ê¶Œì¥
 */
export function getTrendColor(trend: "improved" | "declined" | "stable" | null): {
  text: string;
  bg: string;
  icon: string;
} {
  return getTrendColorFromColors(trend);
}
</file>

<file path="gradeScoreUtils.ts">
/**
 * ì„±ì·¨ë„ ë“±ê¸‰ ë³€í™˜ ìœ í‹¸ë¦¬í‹°
 * UIì—ì„œëŠ” ì•ŒíŒŒë²³(A~E, P)ì„ ì„ íƒí•˜ê³ , DBì—ëŠ” ìˆ«ìë¡œ ì €ì¥
 */

/**
 * ìˆ«ì ë“±ê¸‰ì„ ì•ŒíŒŒë²³ ë“±ê¸‰ìœ¼ë¡œ ë³€í™˜ (ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±)
 * @param numericGrade 1~9 ìˆ«ì ë“±ê¸‰
 * @returns ì•ŒíŒŒë²³ ëŒ€ë¬¸ì ë“±ê¸‰ (A, B, C, D, E)
 */
export function numericToAlphabetGrade(numericGrade: number | null | undefined): string {
  if (numericGrade === null || numericGrade === undefined) {
    return "";
  }

  const grade = Number(numericGrade);
  if (isNaN(grade) || grade < 1 || grade > 9) {
    return "";
  }

  // 1~2: A, 3~4: B, 5~6: C, 7~8: D, 9: E
  if (grade <= 2) return "A";
  if (grade <= 4) return "B";
  if (grade <= 6) return "C";
  if (grade <= 8) return "D";
  return "E";
}

/**
 * ì•ŒíŒŒë²³ ë“±ê¸‰ì„ ìˆ«ì ë“±ê¸‰ìœ¼ë¡œ ë³€í™˜ (DB ì €ì¥ìš©)
 * @param alphabetGrade ì•ŒíŒŒë²³ ëŒ€ë¬¸ì ë“±ê¸‰ (A, B, C, D, E, P)
 * @returns 1~9 ìˆ«ì ë“±ê¸‰ (PëŠ” 0ìœ¼ë¡œ ì €ì¥)
 */
export function alphabetToNumericGrade(alphabetGrade: string | null | undefined): number {
  if (!alphabetGrade) {
    return 0;
  }

  const grade = alphabetGrade.toUpperCase().trim();
  
  switch (grade) {
    case "A":
      return 2; // Aì˜ ì¤‘ê°„ê°’
    case "B":
      return 4; // Bì˜ ì¤‘ê°„ê°’
    case "C":
      return 6; // Cì˜ ì¤‘ê°„ê°’
    case "D":
      return 8; // Dì˜ ì¤‘ê°„ê°’
    case "E":
      return 9;
    case "P":
      return 0; // P (Pass)ëŠ” 0ìœ¼ë¡œ ì €ì¥
    default:
      return 0;
  }
}

/**
 * ì•ŒíŒŒë²³ ë“±ê¸‰ ëª©ë¡ (A, B, C, D, E, P)
 */
export const ALPHABET_GRADES = ["A", "B", "C", "D", "E", "P"] as const;

export type AlphabetGrade = typeof ALPHABET_GRADES[number];
</file>

<file path="internalAnalysis.ts">
/**
 * ë‚´ì‹  ë¶„ì„ ì„œë¹„ìŠ¤
 * 
 * student_internal_scores í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ ë‚´ì‹  ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * - ì „ì²´ GPA ê³„ì‚°
 * - Z-Index (í•™ì—…ì—­ëŸ‰ ì§€ìˆ˜) ê³„ì‚°
 * - êµê³¼êµ°ë³„ GPA ê³„ì‚°
 * 
 * ë³€ê²½ì‚¬í•­ (2025-01-XX):
 * - student_school_scores â†’ student_internal_scores í…Œì´ë¸” ì‚¬ìš©
 * - studentTermIdëŠ” UUID í˜•ì‹ì˜ student_term_id ì‚¬ìš©
 * - subject_group_idë¥¼ í†µí•´ subject_groups ì¡°ì¸í•˜ì—¬ êµê³¼êµ°ëª… ì¡°íšŒ
 */

import { createSupabaseServerClient } from "@/lib/supabase/server";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";

type SupabaseServerClient = Awaited<ReturnType<typeof createSupabaseServerClient>>;

/**
 * ë‚´ì‹  ë¶„ì„ ê²°ê³¼ íƒ€ì…
 */
export type InternalAnalysis = {
  totalGpa: number | null; // ì „ì²´ ë‚´ì‹  í‰ê·  ë“±ê¸‰
  zIndex: number | null; // í•™ì—…ì—­ëŸ‰ ì§€ìˆ˜(Z-Index)
  subjectStrength: Record<string, number>; // êµê³¼êµ°ëª… â†’ GPA
};

/**
 * ë‚´ì‹  ë¶„ì„ ìˆ˜í–‰
 * 
 * @param tenantId - í…Œë„ŒíŠ¸ ID
 * @param studentId - í•™ìƒ ID
 * @param studentTermId - í•™ìƒ í•™ê¸° ID (UUID í˜•ì‹, ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ ì „ì²´ í•™ê¸° ëŒ€ìƒ)
 * @returns ë‚´ì‹  ë¶„ì„ ê²°ê³¼
 */
export async function getInternalAnalysis(
  tenantId: string,
  studentId: string,
  studentTermId?: string
): Promise<InternalAnalysis> {
  const supabase = await createSupabaseServerClient();

  // 1. ì „ì²´ GPA ê³„ì‚°
  let gpaQuery = supabase
    .from("student_internal_scores")
    .select("rank_grade, credit_hours")
    .eq("tenant_id", tenantId)
    .eq("student_id", studentId)
    .not("rank_grade", "is", null)
    .not("credit_hours", "is", null);

  // studentTermIdê°€ ìˆìœ¼ë©´ student_term_idë¡œ í•„í„°ë§
  if (studentTermId) {
    gpaQuery = gpaQuery.eq("student_term_id", studentTermId);
  }

  const { data: gpaData, error: gpaError } = await gpaQuery;

  if (gpaError) {
    console.error("[scores/internalAnalysis] GPA ê³„ì‚° ì‹¤íŒ¨", gpaError);
  }

  // GPA ê³„ì‚°: SUM(rank_grade * credit_hours) / SUM(credit_hours)
  let totalGpa: number | null = null;
  if (gpaData && gpaData.length > 0) {
    const totalGradeCredit = gpaData.reduce(
      (sum, row) => sum + (Number(row.rank_grade) || 0) * (Number(row.credit_hours) || 0),
      0
    );
    const totalCredit = gpaData.reduce(
      (sum, row) => sum + (Number(row.credit_hours) || 0),
      0
    );

    if (totalCredit > 0) {
      totalGpa = totalGradeCredit / totalCredit;
    }
  }

  // 2. Z-Index ê³„ì‚°
  let zIndexQuery = supabase
    .from("student_internal_scores")
    .select("raw_score, avg_score, std_dev, credit_hours")
    .eq("tenant_id", tenantId)
    .eq("student_id", studentId)
    .not("raw_score", "is", null)
    .not("avg_score", "is", null)
    .not("std_dev", "is", null)
    .not("credit_hours", "is", null)
    .gt("std_dev", 0); // í‘œì¤€í¸ì°¨ê°€ 0ë³´ë‹¤ í° ê²½ìš°ë§Œ

  if (studentTermId) {
    zIndexQuery = zIndexQuery.eq("student_term_id", studentTermId);
  }

  const { data: zIndexData, error: zIndexError } = await zIndexQuery;

  if (zIndexError) {
    console.error("[scores/internalAnalysis] Z-Index ê³„ì‚° ì‹¤íŒ¨", zIndexError);
  }

  // Z-Index ê³„ì‚°: SUM(((raw_score - avg_score) / std_dev) * credit_hours) / SUM(credit_hours)
  let zIndex: number | null = null;
  if (zIndexData && zIndexData.length > 0) {
    const totalZCredit = zIndexData.reduce((sum, row) => {
      const rawScore = Number(row.raw_score) || 0;
      const avgScore = Number(row.avg_score) || 0;
      const stdDev = Number(row.std_dev) || 1;
      const creditHours = Number(row.credit_hours) || 0;

      if (stdDev > 0) {
        const z = (rawScore - avgScore) / stdDev;
        return sum + z * creditHours;
      }
      return sum;
    }, 0);

    const totalCredit = zIndexData.reduce(
      (sum, row) => sum + (Number(row.credit_hours) || 0),
      0
    );

    if (totalCredit > 0) {
      zIndex = totalZCredit / totalCredit;
    }
  }

  // 3. êµê³¼êµ°ë³„ GPA ê³„ì‚°
  // subject_group_idë¥¼ í†µí•´ subject_groups ì¡°ì¸ í•„ìš”
  let subjectQuery = supabase
    .from("student_internal_scores")
    .select("rank_grade, credit_hours, subject_group_id")
    .eq("tenant_id", tenantId)
    .eq("student_id", studentId)
    .not("rank_grade", "is", null)
    .not("credit_hours", "is", null);

  if (studentTermId) {
    subjectQuery = subjectQuery.eq("student_term_id", studentTermId);
  }

  const { data: subjectData, error: subjectError } = await subjectQuery;

  if (subjectError) {
    console.error("[scores/internalAnalysis] êµê³¼êµ°ë³„ GPA ê³„ì‚° ì‹¤íŒ¨", subjectError);
  }

  // êµê³¼êµ°ë³„ GPA ê³„ì‚°
  const subjectStrength: Record<string, number> = {};
  if (subjectData && subjectData.length > 0) {
    // subject_group_id ëª©ë¡ ì¶”ì¶œ
    const subjectGroupIds = subjectData
      .map((row) => row.subject_group_id)
      .filter((id): id is string => id != null);

    if (subjectGroupIds.length > 0) {
      // subject_groups ì¡°íšŒ (RLS ìš°íšŒë¥¼ ìœ„í•´ Admin í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)
      const adminClient = createSupabaseAdminClient();
      const groupsClient = adminClient || supabase;

      const { data: subjectGroupsData, error: sgError } = await groupsClient
        .from("subject_groups")
        .select("id, name")
        .in("id", subjectGroupIds);

      if (sgError) {
        console.error("[scores/internalAnalysis] êµê³¼ ê·¸ë£¹ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨", sgError);
      } else if (subjectGroupsData) {
        // subject_group_id â†’ êµê³¼êµ°ëª… ë§¤í•‘ ìƒì„±
        const subjectGroupMap = new Map(
          subjectGroupsData.map((sg) => [sg.id, sg.name])
        );

        // êµê³¼êµ°ë³„ë¡œ ê·¸ë£¹í™”
        const subjectGroups: Record<string, { totalGradeCredit: number; totalCredit: number }> = {};

        for (const row of subjectData) {
          const subjectGroupId = row.subject_group_id;
          if (!subjectGroupId) continue;

          const subjectGroupName = subjectGroupMap.get(subjectGroupId);
          if (!subjectGroupName) continue;

          const rankGrade = Number(row.rank_grade) || 0;
          const creditHours = Number(row.credit_hours) || 0;

          if (!subjectGroups[subjectGroupName]) {
            subjectGroups[subjectGroupName] = { totalGradeCredit: 0, totalCredit: 0 };
          }

          subjectGroups[subjectGroupName].totalGradeCredit += rankGrade * creditHours;
          subjectGroups[subjectGroupName].totalCredit += creditHours;
        }

        // êµê³¼êµ°ë³„ GPA ê³„ì‚°
        for (const [name, { totalGradeCredit, totalCredit }] of Object.entries(subjectGroups)) {
          if (totalCredit > 0) {
            subjectStrength[name] = totalGradeCredit / totalCredit;
          }
        }
      }
    }
  }

  return {
    totalGpa,
    zIndex,
    subjectStrength,
  };
}
</file>

<file path="mockAnalysis.ts">
/**
 * ëª¨ì˜ê³ ì‚¬ ë¶„ì„ ì„œë¹„ìŠ¤
 *
 * student_mock_scores í…Œì´ë¸”ì„ ê¸°ë°˜ìœ¼ë¡œ ëª¨ì˜ê³ ì‚¬ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * - ìµœê·¼ ì‹œí—˜ ì •ë³´ ì¡°íšŒ
 * - êµ­/ìˆ˜/íƒ(ìƒìœ„2) í‰ê·  ë°±ë¶„ìœ„ ê³„ì‚°
 * - êµ­/ìˆ˜/íƒ(ìƒìœ„2) í‘œì¤€ì ìˆ˜ í•© ê³„ì‚°
 * - êµ­Â·ìˆ˜Â·ì˜Â·íƒ ì¤‘ ìƒìœ„ 3ê°œ ë“±ê¸‰ í•© ê³„ì‚°
 */

import { createSupabaseServerClient } from "@/lib/supabase/server";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

/**
 * ëª¨ì˜ê³ ì‚¬ ê³¼ëª© ë°ì´í„° íƒ€ì…
 */
type MockRow = {
  subject_group_name: string;
  percentile: number | null;
  standard_score: number | null;
  grade_score: number | null;
};

/**
 * ëª¨ì˜ê³ ì‚¬ ë¶„ì„ ê²°ê³¼ íƒ€ì…
 */
export type MockAnalysis = {
  recentExam: { examDate: string; examTitle: string } | null;
  avgPercentile: number | null; // êµ­/ìˆ˜/íƒ(ìƒìœ„2) í‰ê·  ë°±ë¶„ìœ„
  totalStdScore: number | null; // êµ­/ìˆ˜/íƒ(ìƒìœ„2) í‘œì¤€ì ìˆ˜ í•©
  best3GradeSum: number | null; // êµ­Â·ìˆ˜Â·ì˜Â·íƒ ì¤‘ ìƒìœ„ 3ê°œ ë“±ê¸‰ í•©
};

/**
 * ëª¨ì˜ê³ ì‚¬ í†µê³„ ê³„ì‚°
 *
 * @param rows - ëª¨ì˜ê³ ì‚¬ ê³¼ëª© ë°ì´í„° ë°°ì—´
 * @returns ëª¨ì˜ê³ ì‚¬ í†µê³„ (recentExam ì œì™¸)
 */
function calculateMockStats(rows: MockRow[]): Omit<MockAnalysis, "recentExam"> {
  // êµ­ì–´, ìˆ˜í•™ ì¡°íšŒ
  const getOne = (name: string) =>
    rows.find((r) => r.subject_group_name === name && r.percentile != null);

  const korean = getOne("êµ­ì–´");
  const math = getOne("ìˆ˜í•™");

  // íƒêµ¬(ì‚¬/ê³¼) ì¤‘ ìƒìœ„ 2ê³¼ëª© ë°±ë¶„ìœ„ í‰ê· 
  const inquiryRows = rows
    .filter(
      (r) =>
        ["ì‚¬íšŒ", "ê³¼í•™"].includes(r.subject_group_name) && r.percentile != null
    )
    .sort((a, b) => (b.percentile ?? 0) - (a.percentile ?? 0))
    .slice(0, 2);

  const inquiryAvgPct =
    inquiryRows.length > 0
      ? inquiryRows.reduce((s, r) => s + (r.percentile ?? 0), 0) /
        inquiryRows.length
      : null;

  // êµ­/ìˆ˜/íƒ(ìƒìœ„2) í‰ê·  ë°±ë¶„ìœ„
  const avgPercentile =
    korean?.percentile != null &&
    math?.percentile != null &&
    inquiryAvgPct != null
      ? (korean.percentile + math.percentile + inquiryAvgPct) / 3
      : null;

  // êµ­/ìˆ˜/íƒ(ìƒìœ„2) í‘œì¤€ì ìˆ˜ í•©
  const totalStdScore =
    (korean?.standard_score ?? 0) +
    (math?.standard_score ?? 0) +
    inquiryRows.reduce((s, r) => s + (r.standard_score ?? 0), 0);

  // êµ­Â·ìˆ˜Â·ì˜Â·íƒ ì¤‘ ìƒìœ„ 3ê°œ ë“±ê¸‰ í•©
  const gradeCandidates = rows.filter(
    (r) =>
      ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´", "ì‚¬íšŒ", "ê³¼í•™"].includes(r.subject_group_name) &&
      r.grade_score != null
  );

  const best3GradeSum =
    gradeCandidates.length > 0
      ? gradeCandidates
          .sort((a, b) => (a.grade_score ?? 9) - (b.grade_score ?? 9)) // ë‚®ì„ìˆ˜ë¡ ì¢‹ì€ ë“±ê¸‰
          .slice(0, 3)
          .reduce((s, r) => s + (r.grade_score ?? 0), 0)
      : null;

  return {
    avgPercentile,
    totalStdScore: totalStdScore > 0 ? totalStdScore : null,
    best3GradeSum,
  };
}

/**
 * ëª¨ì˜ê³ ì‚¬ ë¶„ì„ ìˆ˜í–‰
 *
 * @param tenantId - í…Œë„ŒíŠ¸ ID
 * @param studentId - í•™ìƒ ID
 * @returns ëª¨ì˜ê³ ì‚¬ ë¶„ì„ ê²°ê³¼
 */
export async function getMockAnalysis(
  tenantId: string,
  studentId: string
): Promise<MockAnalysis> {
  const supabase = await createSupabaseServerClient();

  // 1. ê°€ì¥ ìµœê·¼ ì‹œí—˜ ì¡°íšŒ (exam_date ê¸°ì¤€)
  const { data: latestExam, error: latestError } = await supabase
    .from("student_mock_scores")
    .select("exam_date, exam_title")
    .eq("tenant_id", tenantId)
    .eq("student_id", studentId)
    .not("exam_date", "is", null)
    .order("exam_date", { ascending: false })
    .limit(1)
    .maybeSingle();

  if (latestError) {
    console.error("[scores/mockAnalysis] ìµœê·¼ ì‹œí—˜ ì¡°íšŒ ì‹¤íŒ¨", latestError);
  }

  if (!latestExam || !latestExam.exam_date) {
    return {
      recentExam: null,
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  const examDate = latestExam.exam_date;
  const examTitle = latestExam.exam_title || "";

  // 2. í•´ë‹¹ ì‹œí—˜ì˜ ê³¼ëª©ë³„ ì„±ì  ì¡°íšŒ
  // ê°™ì€ exam_dateì™€ exam_titleì˜ ì‹œí—˜ì„ ê·¸ë£¹í™”
  // student_mock_scores â†’ subjects â†’ subject_groups ìˆœìœ¼ë¡œ ì¡°ì¸
  // Supabaseì˜ ì¤‘ì²© ì¡°ì¸ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë‘ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ì¡°íšŒ
  let query = supabase
    .from("student_mock_scores")
    .select("percentile, standard_score, grade_score, subject_id")
    .eq("tenant_id", tenantId)
    .eq("student_id", studentId)
    .eq("exam_date", examDate)
    .not("subject_id", "is", null);

  // exam_titleë„ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ ì¡°íšŒ (ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ ì‹œí—˜ì´ ìˆì„ ìˆ˜ ìˆìŒ)
  if (examTitle) {
    query = query.eq("exam_title", examTitle);
  }

  const { data: mockScores, error: mockScoresError } = await query;

  if (mockScoresError) {
    console.error(
      "[scores/mockAnalysis] ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ ì‹¤íŒ¨",
      mockScoresError
    );
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  if (!mockScores || mockScores.length === 0) {
    console.warn("[scores/mockAnalysis] ëª¨ì˜ê³ ì‚¬ ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  console.log(
    "[scores/mockAnalysis] ì¡°íšŒëœ ëª¨ì˜ê³ ì‚¬ ì„±ì :",
    JSON.stringify(mockScores, null, 2)
  );

  // subject_id ëª©ë¡ ì¶”ì¶œ
  const subjectIds = mockScores
    .map((score) => score.subject_id)
    .filter((id): id is string => id != null);

  console.log("[scores/mockAnalysis] ì¶”ì¶œëœ subject_ids:", subjectIds);

  if (subjectIds.length === 0) {
    console.warn("[scores/mockAnalysis] subject_idê°€ ì—†ìŠµë‹ˆë‹¤");
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  // subjects ì¡°íšŒ (subject_group_id í¬í•¨)
  // ì£¼ì˜: subjects í…Œì´ë¸”ì€ ì „ì—­ ê´€ë¦¬ì´ë¯€ë¡œ tenant_id ì»¬ëŸ¼ì´ ì—†ìŒ
  // RLS ì •ì±…ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ Admin í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©
  const adminClient = createSupabaseAdminClient();
  const subjectsClient = adminClient || supabase;

  const { data: subjectsData, error: subjectsError } = await subjectsClient
    .from("subjects")
    .select("id, subject_group_id")
    .in("id", subjectIds);

  console.log(
    "[scores/mockAnalysis] ì¡°íšŒëœ subjects ë°ì´í„°:",
    JSON.stringify(subjectsData, null, 2)
  );

  if (subjectsError) {
    console.error("[scores/mockAnalysis] ê³¼ëª© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨", subjectsError);
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  if (!subjectsData || subjectsData.length === 0) {
    console.warn("[scores/mockAnalysis] subjects ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  // subject_group_id ëª©ë¡ ì¶”ì¶œ
  const subjectGroupIds = subjectsData
    .map((subject) => subject.subject_group_id)
    .filter((id): id is string => id != null);

  if (subjectGroupIds.length === 0) {
    console.warn("[scores/mockAnalysis] subject_group_idê°€ ì—†ìŠµë‹ˆë‹¤");
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  // subject_groups ì¡°íšŒ
  // ì£¼ì˜: subject_groups í…Œì´ë¸”ì€ ì „ì—­ ê´€ë¦¬ì´ë¯€ë¡œ tenant_id ì»¬ëŸ¼ì´ ì—†ìŒ
  // RLS ì •ì±…ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ Admin í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©
  const { data: subjectGroupsData, error: sgError } = await subjectsClient
    .from("subject_groups")
    .select("id, name")
    .in("id", subjectGroupIds);

  if (sgError) {
    console.error("[scores/mockAnalysis] êµê³¼ ê·¸ë£¹ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨", sgError);
    return {
      recentExam: {
        examDate: examDate || "",
        examTitle,
      },
      avgPercentile: null,
      totalStdScore: null,
      best3GradeSum: null,
    };
  }

  // subject_id â†’ subject_group_id â†’ subject_group_name ë§¤í•‘ ìƒì„±
  const subjectGroupMap = new Map(
    (subjectGroupsData || []).map((sg) => [sg.id, sg.name])
  );
  const subjectToGroupMap = new Map(
    subjectsData.map((s) => [s.id, s.subject_group_id])
  );

  const subjectMap = new Map<string, string>();
  for (const [subjectId, subjectGroupId] of subjectToGroupMap.entries()) {
    const subjectGroupName = subjectGroupId
      ? subjectGroupMap.get(subjectGroupId)
      : null;
    if (subjectGroupName) {
      subjectMap.set(subjectId, subjectGroupName);
    }
  }

  console.log(
    "[scores/mockAnalysis] ìƒì„±ëœ subjectMap:",
    Array.from(subjectMap.entries())
  );

  // ë°ì´í„° ë³€í™˜
  const rows: MockRow[] = mockScores
    .map((score) => {
      const subjectGroupName = subjectMap.get(score.subject_id) || "";
      return {
        subject_group_name: subjectGroupName,
        percentile: score.percentile != null ? Number(score.percentile) : null,
        standard_score:
          score.standard_score != null ? Number(score.standard_score) : null,
        grade_score:
          score.grade_score != null ? Number(score.grade_score) : null,
      };
    })
    .filter((row) => row.subject_group_name !== ""); // subject_group_nameì´ ì—†ëŠ” ê²½ìš° ì œì™¸

  console.log(
    "[scores/mockAnalysis] ë³€í™˜ëœ rows:",
    JSON.stringify(rows, null, 2)
  );

  // í†µê³„ ê³„ì‚°
  const stats = calculateMockStats(rows);

  console.log(
    "[scores/mockAnalysis] ê³„ì‚°ëœ í†µê³„:",
    JSON.stringify(stats, null, 2)
  );

  return {
    recentExam: {
      examDate,
      examTitle,
    },
    ...stats,
  };
}
</file>

<file path="getGoalStatus.ts">
import type { createSupabaseServerClient } from "@/lib/supabase/server";
import { getActiveGoals, getGoalProgress } from "@/lib/goals/queries";
import { calculateGoalProgress } from "@/lib/goals/calc";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type GoalStatusMetrics = {
  totalActiveGoals: number;
  goalsNearDeadline: number; // D-7 ì´ë‚´ ëª©í‘œ ìˆ˜
  goalsVeryNearDeadline: number; // D-3 ì´ë‚´ ëª©í‘œ ìˆ˜
  averageProgress: number; // í‰ê·  ì§„í–‰ë¥  (0-100)
  lowProgressGoals: number; // ì§„í–‰ë¥  30% ë¯¸ë§Œ ëª©í‘œ ìˆ˜
  veryLowProgressGoals: number; // ì§„í–‰ë¥  50% ë¯¸ë§Œ ëª©í‘œ ìˆ˜
  goals: Array<{
    id: string;
    title: string;
    daysRemaining: number | null;
    progressPercentage: number;
  }>;
};

/**
 * ëª©í‘œ ìƒíƒœ ë©”íŠ¸ë¦­ ì¡°íšŒ
 */
export async function getGoalStatus(
  supabase: SupabaseServerClient,
  studentId: string,
  todayDate: string
): Promise<GoalStatusMetrics> {
  try {
    const today = new Date(todayDate);
    today.setHours(0, 0, 0, 0);

    const activeGoals = await getActiveGoals(supabase, studentId, todayDate);

    const goalsWithProgress = await Promise.all(
      activeGoals.map(async (goal) => {
        const progressRows = await getGoalProgress(supabase, studentId, goal.id);
        const progress = calculateGoalProgress(goal, progressRows, today);

        return {
          id: goal.id,
          title: goal.title,
          daysRemaining: progress.daysRemaining,
          progressPercentage: progress.progressPercentage,
        };
      })
    );

    const totalActiveGoals = goalsWithProgress.length;
    const goalsNearDeadline = goalsWithProgress.filter(
      (g) => g.daysRemaining !== null && g.daysRemaining <= 7 && g.daysRemaining >= 0
    ).length;
    const goalsVeryNearDeadline = goalsWithProgress.filter(
      (g) => g.daysRemaining !== null && g.daysRemaining <= 3 && g.daysRemaining >= 0
    ).length;
    const averageProgress =
      goalsWithProgress.length > 0
        ? Math.round(
            goalsWithProgress.reduce((sum, g) => sum + g.progressPercentage, 0) /
              goalsWithProgress.length
          )
        : 0;
    const lowProgressGoals = goalsWithProgress.filter(
      (g) => g.progressPercentage < 30
    ).length;
    const veryLowProgressGoals = goalsWithProgress.filter(
      (g) => g.progressPercentage < 50
    ).length;

    return {
      totalActiveGoals,
      goalsNearDeadline,
      goalsVeryNearDeadline,
      averageProgress,
      lowProgressGoals,
      veryLowProgressGoals,
      goals: goalsWithProgress,
    };
  } catch (error) {
    console.error("[metrics/getGoalStatus] ëª©í‘œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      totalActiveGoals: 0,
      goalsNearDeadline: 0,
      goalsVeryNearDeadline: 0,
      averageProgress: 0,
      lowProgressGoals: 0,
      veryLowProgressGoals: 0,
      goals: [],
    };
  }
}
</file>

<file path="getHistoryPattern.ts">
import type { createSupabaseServerClient } from "@/lib/supabase/server";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type HistoryPatternMetrics = {
  consecutivePlanFailures: number; // ì—°ì† í”Œëœ ë¯¸ì™„ë£Œ íšŸìˆ˜
  consecutiveNoStudyDays: number; // ì—°ì† í•™ìŠµì„¸ì…˜ ì—†ëŠ” ë‚  ìˆ˜
  recentHistoryEvents: Array<{
    eventType: string;
    date: string;
  }>;
};

/**
 * íˆìŠ¤í† ë¦¬ íŒ¨í„´ ë©”íŠ¸ë¦­ ì¡°íšŒ
 */
export async function getHistoryPattern(
  supabase: SupabaseServerClient,
  studentId: string,
  todayDate: string
): Promise<HistoryPatternMetrics> {
  try {
    const today = new Date(todayDate);
    today.setHours(0, 0, 0, 0);

    // ìµœê·¼ 30ì¼ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().slice(0, 10);

    const selectHistory = () =>
      supabase
        .from("student_history")
        .select("event_type,created_at")
        .gte("created_at", thirtyDaysAgoStr)
        .order("created_at", { ascending: false });

    let { data: history, error } = await selectHistory().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data: history, error } = await selectHistory());
    }

    if (error) throw error;

    const historyRows = (history as Array<{
      event_type?: string | null;
      created_at?: string | null;
    }> | null) ?? [];

    // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
    const dateMap = new Map<string, Set<string>>();
    historyRows.forEach((row) => {
      if (!row.created_at || !row.event_type) return;
      const date = new Date(row.created_at).toISOString().slice(0, 10);
      const existing = dateMap.get(date) || new Set();
      existing.add(row.event_type);
      dateMap.set(date, existing);
    });

    // ì—°ì† í”Œëœ ë¯¸ì™„ë£Œ í™•ì¸
    let consecutivePlanFailures = 0;
    const sortedDates = Array.from(dateMap.keys()).sort((a, b) => b.localeCompare(a));
    for (const date of sortedDates) {
      const events = dateMap.get(date) || new Set();
      // plan_completed ì´ë²¤íŠ¸ê°€ ì—†ìœ¼ë©´ ë¯¸ì™„ë£Œë¡œ ê°„ì£¼
      if (!events.has("plan_completed")) {
        consecutivePlanFailures++;
      } else {
        break; // ì™„ë£Œëœ ë‚ ì´ ë‚˜ì˜¤ë©´ ì¤‘ë‹¨
      }
    }

    // ì—°ì† í•™ìŠµì„¸ì…˜ ì—†ëŠ” ë‚  í™•ì¸
    let consecutiveNoStudyDays = 0;
    const studySessionDates = new Set<string>();
    historyRows.forEach((row) => {
      if (row.event_type === "study_session" && row.created_at) {
        const date = new Date(row.created_at).toISOString().slice(0, 10);
        studySessionDates.add(date);
      }
    });

    // ì˜¤ëŠ˜ë¶€í„° ì—­ìˆœìœ¼ë¡œ í™•ì¸
    const checkDate = new Date(today);
    for (let i = 0; i < 30; i++) {
      const dateStr = checkDate.toISOString().slice(0, 10);
      if (!studySessionDates.has(dateStr)) {
        consecutiveNoStudyDays++;
      } else {
        break; // í•™ìŠµì„¸ì…˜ì´ ìˆëŠ” ë‚ ì´ ë‚˜ì˜¤ë©´ ì¤‘ë‹¨
      }
      checkDate.setDate(checkDate.getDate() - 1);
    }

    // ìµœê·¼ ì´ë²¤íŠ¸ ëª©ë¡
    const recentHistoryEvents = historyRows
      .slice(0, 20)
      .map((row) => ({
        eventType: row.event_type || "",
        date: row.created_at ? new Date(row.created_at).toISOString().slice(0, 10) : "",
      }));

    return {
      consecutivePlanFailures,
      consecutiveNoStudyDays,
      recentHistoryEvents,
    };
  } catch (error) {
    console.error("[metrics/getHistoryPattern] íˆìŠ¤í† ë¦¬ íŒ¨í„´ ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      consecutivePlanFailures: 0,
      consecutiveNoStudyDays: 0,
      recentHistoryEvents: [],
    };
  }
}
</file>

<file path="getPlanCompletion.ts">
import type { createSupabaseServerClient } from "@/lib/supabase/server";
import { isCompletedPlan, filterLearningPlans } from "@/lib/utils/planUtils";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type PlanCompletionMetrics = {
  totalPlans: number;
  completedPlans: number;
  completionRate: number; // 0-100
};

/**
 * ì£¼ê°„ í”Œëœ ì‹¤í–‰ë¥  ë©”íŠ¸ë¦­ ì¡°íšŒ
 */
export async function getPlanCompletion(
  supabase: SupabaseServerClient,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<PlanCompletionMetrics> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const selectPlans = () =>
      supabase
        .from("student_plan")
        .select("id,completed_amount,actual_end_time,progress,content_id")
        .gte("plan_date", weekStartStr)
        .lte("plan_date", weekEndStr);

    let { data: plans, error } = await selectPlans().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data: plans, error } = await selectPlans());
    }

    if (error) throw error;

    const planRows = (plans as Array<{
      id: string;
      completed_amount?: number | null;
      actual_end_time?: string | null;
      progress?: number | null;
      content_id?: string | null;
    }> | null) ?? [];

    // í•™ìŠµ í”Œëœë§Œ í•„í„°ë§ (ë”ë¯¸ ì½˜í…ì¸  ì œì™¸)
    const learningPlans = filterLearningPlans(planRows);

    const totalPlans = learningPlans.length;
    // í†µì¼ëœ ì™„ë£Œ ê¸°ì¤€ ì‚¬ìš© (actual_end_time ë˜ëŠ” progress >= 100)
    const completedPlans = learningPlans.filter((p) => isCompletedPlan(p)).length;
    const completionRate =
      totalPlans > 0 ? Math.round((completedPlans / totalPlans) * 100) : 0;

    return {
      totalPlans,
      completedPlans,
      completionRate,
    };
  } catch (error) {
    console.error("[metrics/getPlanCompletion] í”Œëœ ì‹¤í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      totalPlans: 0,
      completedPlans: 0,
      completionRate: 0,
    };
  }
}
</file>

<file path="getScoreTrend.ts">
import type { createSupabaseServerClient } from "@/lib/supabase/server";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type ScoreTrendMetrics = {
  hasDecliningTrend: boolean; // ìµœê·¼ 2íšŒ ì—°ì† ë“±ê¸‰ í•˜ë½
  decliningSubjects: string[]; // í•˜ë½í•œ ê³¼ëª© ëª©ë¡
  lowGradeSubjects: string[]; // 7ë“±ê¸‰ ì´í•˜ ê³¼ëª© ëª©ë¡
  recentScores: Array<{
    subject: string;
    scoreType: string; // "school" | "mock"
    grade: number;
    testDate: string;
  }>;
};

/**
 * ì„±ì  ì¶”ì´ ë©”íŠ¸ë¦­ ì¡°íšŒ
 */
export async function getScoreTrend(
  supabase: SupabaseServerClient,
  studentId: string
): Promise<ScoreTrendMetrics> {
  try {
    // ë‚´ì‹  ì„±ì  ì¡°íšŒ
    const selectSchoolScores = () =>
      supabase
        .from("student_school_scores")
        .select("subject_group,grade_score,test_date")
        .order("test_date", { ascending: false })
        .limit(20);

    let { data: schoolScores, error: schoolError } = await selectSchoolScores().eq(
      "student_id",
      studentId
    );

    if (schoolError && schoolError.code === "42703") {
      ({ data: schoolScores, error: schoolError } = await selectSchoolScores());
    }

    // ëª¨ì˜ê³ ì‚¬ ì„±ì  ì¡°íšŒ
    const selectMockScores = () =>
      supabase
        .from("student_mock_scores")
        .select("subject_group,grade_score,test_date")
        .order("test_date", { ascending: false })
        .limit(20);

    let { data: mockScores, error: mockError } = await selectMockScores().eq(
      "student_id",
      studentId
    );

    if (mockError && mockError.code === "42703") {
      ({ data: mockScores, error: mockError } = await selectMockScores());
    }

    const schoolRows = (schoolScores as Array<{
      subject_group?: string | null;
      grade_score?: number | null;
      test_date?: string | null;
    }> | null) ?? [];

    const mockRows = (mockScores as Array<{
      subject_group?: string | null;
      grade_score?: number | null;
      test_date?: string | null;
    }> | null) ?? [];

    // ëª¨ë“  ì„±ì ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê¸°
    const allScores: Array<{
      subject: string;
      scoreType: "school" | "mock";
      grade: number;
      testDate: string;
    }> = [];

    schoolRows.forEach((row) => {
      if (row.subject_group && row.grade_score !== null && row.grade_score !== undefined && row.test_date) {
        allScores.push({
          subject: row.subject_group,
          scoreType: "school",
          grade: row.grade_score,
          testDate: row.test_date,
        });
      }
    });

    mockRows.forEach((row) => {
      if (row.subject_group && row.grade_score !== null && row.grade_score !== undefined && row.test_date) {
        allScores.push({
          subject: row.subject_group,
          scoreType: "mock",
          grade: row.grade_score,
          testDate: row.test_date,
        });
      }
    });

    // ë‚ ì§œìˆœ ì •ë ¬
    allScores.sort((a, b) => b.testDate.localeCompare(a.testDate));

    // ê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¶”ì´ ë¶„ì„
    const subjectMap = new Map<string, Array<{ grade: number; testDate: string }>>();
    allScores.forEach((score) => {
      const existing = subjectMap.get(score.subject) || [];
      existing.push({ grade: score.grade, testDate: score.testDate });
      subjectMap.set(score.subject, existing);
    });

    const decliningSubjects: string[] = [];
    const lowGradeSubjects: string[] = [];

    subjectMap.forEach((scores, subject) => {
      // ìµœê·¼ 2íšŒ ì—°ì† í•˜ë½ í™•ì¸
      if (scores.length >= 2) {
        const sorted = scores.sort((a, b) => b.testDate.localeCompare(a.testDate));
        const recent2 = sorted.slice(0, 2);
        // ë“±ê¸‰ì´ ë†’ì•„ì§ˆìˆ˜ë¡ ë‚˜ì¨ (1ë“±ê¸‰ì´ ìµœê³ , 9ë“±ê¸‰ì´ ìµœì•…)
        if (recent2[0].grade > recent2[1].grade) {
          decliningSubjects.push(subject);
        }
      }

      // 7ë“±ê¸‰ ì´í•˜ ê³¼ëª© í™•ì¸
      const latestGrade = scores.sort((a, b) => b.testDate.localeCompare(a.testDate))[0]?.grade;
      if (latestGrade !== undefined && latestGrade >= 7) {
        lowGradeSubjects.push(subject);
      }
    });

    const hasDecliningTrend = decliningSubjects.length > 0;

    return {
      hasDecliningTrend,
      decliningSubjects,
      lowGradeSubjects,
      recentScores: allScores.slice(0, 10), // ìµœê·¼ 10ê°œë§Œ ë°˜í™˜
    };
  } catch (error) {
    console.error("[metrics/getScoreTrend] ì„±ì  ì¶”ì´ ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      hasDecliningTrend: false,
      decliningSubjects: [],
      lowGradeSubjects: [],
      recentScores: [],
    };
  }
}
</file>

<file path="getStudyTime.ts">
import type { createSupabaseServerClient } from "@/lib/supabase/server";
import { getSessionsByDateRange } from "@/lib/studySessions/queries";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type StudyTimeMetrics = {
  thisWeekMinutes: number;
  lastWeekMinutes: number;
  changePercent: number; // ì§€ë‚œì£¼ ëŒ€ë¹„ ë³€í™”ìœ¨ (%)
  changeMinutes: number; // ì§€ë‚œì£¼ ëŒ€ë¹„ ë³€í™”ëŸ‰ (ë¶„)
};

/**
 * ì£¼ê°„ í•™ìŠµì‹œê°„ ë©”íŠ¸ë¦­ ì¡°íšŒ
 */
export async function getStudyTime(
  supabase: SupabaseServerClient,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<StudyTimeMetrics> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    // ì§€ë‚œ ì£¼ ë²”ìœ„ ê³„ì‚°
    const lastWeekStart = new Date(weekStart);
    lastWeekStart.setDate(weekStart.getDate() - 7);
    const lastWeekEnd = new Date(weekEnd);
    lastWeekEnd.setDate(weekEnd.getDate() - 7);
    const lastWeekStartStr = lastWeekStart.toISOString().slice(0, 10);
    const lastWeekEndStr = lastWeekEnd.toISOString().slice(0, 10);

    // ì´ë²ˆ ì£¼ ë° ì§€ë‚œ ì£¼ ì„¸ì…˜ ì¡°íšŒ
    const [thisWeekSessions, lastWeekSessions] = await Promise.all([
      getSessionsByDateRange(supabase, studentId, weekStartStr, weekEndStr),
      getSessionsByDateRange(supabase, studentId, lastWeekStartStr, lastWeekEndStr),
    ]);

    // í•™ìŠµì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
    const thisWeekSeconds = thisWeekSessions.reduce(
      (sum, s) => sum + (s.duration_seconds || 0),
      0
    );
    const lastWeekSeconds = lastWeekSessions.reduce(
      (sum, s) => sum + (s.duration_seconds || 0),
      0
    );

    const thisWeekMinutes = Math.floor(thisWeekSeconds / 60);
    const lastWeekMinutes = Math.floor(lastWeekSeconds / 60);
    const changeMinutes = thisWeekMinutes - lastWeekMinutes;
    const changePercent =
      lastWeekMinutes > 0
        ? Math.round((changeMinutes / lastWeekMinutes) * 100)
        : thisWeekMinutes > 0
        ? 100
        : 0;

    return {
      thisWeekMinutes,
      lastWeekMinutes,
      changePercent,
      changeMinutes,
    };
  } catch (error) {
    console.error("[metrics/getStudyTime] í•™ìŠµì‹œê°„ ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      thisWeekMinutes: 0,
      lastWeekMinutes: 0,
      changePercent: 0,
      changeMinutes: 0,
    };
  }
}
</file>

<file path="getWeakSubjects.ts">
import type { createSupabaseServerClient } from "@/lib/supabase/server";
import { getSessionsByDateRange } from "@/lib/studySessions/queries";
import { getSubjectFromContent } from "@/lib/studySessions/summary";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type WeakSubjectMetrics = {
  weakSubjects: string[]; // ì·¨ì•½ ê³¼ëª© ëª©ë¡
  subjectStudyTime: Map<string, number>; // ê³¼ëª©ë³„ í•™ìŠµì‹œê°„ (ë¶„)
  totalStudyTime: number; // ì „ì²´ í•™ìŠµì‹œê°„ (ë¶„)
  weakSubjectStudyTimeRatio: number; // ì·¨ì•½ ê³¼ëª© í•™ìŠµì‹œê°„ ë¹„ìœ¨ (0-100)
};

/**
 * ì·¨ì•½ ê³¼ëª© ë©”íŠ¸ë¦­ ì¡°íšŒ
 */
export async function getWeakSubjects(
  supabase: SupabaseServerClient,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<WeakSubjectMetrics> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    // ì´ë²ˆ ì£¼ ì„¸ì…˜ ì¡°íšŒ
    const sessions = await getSessionsByDateRange(
      supabase,
      studentId,
      weekStartStr,
      weekEndStr
    );

    // ê³¼ëª©ë³„ í•™ìŠµì‹œê°„ ê³„ì‚°
    const subjectTimeMap = new Map<string, number>();

    for (const session of sessions) {
      if (!session.duration_seconds) continue;

      let subject: string | null = null;
      if (session.plan_id) {
        // í”Œëœ ì •ë³´ ì¡°íšŒ
        const selectPlan = () =>
          supabase
            .from("student_plan")
            .select("content_type,content_id")
            .eq("id", session.plan_id);

        let { data: plan, error } = await selectPlan().eq("student_id", studentId).maybeSingle();

        if (error && error.code === "42703") {
          ({ data: plan, error } = await selectPlan().maybeSingle());
        }

        if (!error && plan && plan.content_type && plan.content_id) {
          subject = await getSubjectFromContent(
            supabase,
            studentId,
            plan.content_type,
            plan.content_id
          );
        }
      } else if (session.content_type && session.content_id) {
        subject = await getSubjectFromContent(
          supabase,
          studentId,
          session.content_type,
          session.content_id
        );
      }

      if (subject) {
        const current = subjectTimeMap.get(subject) || 0;
        subjectTimeMap.set(subject, current + Math.floor(session.duration_seconds / 60));
      }
    }

    // ì·¨ì•½ ê³¼ëª© ì¡°íšŒ (student_analysis í…Œì´ë¸”)
    const selectAnalysis = () =>
      supabase
        .from("student_analysis")
        .select("subject,risk_score")
        .order("risk_score", { ascending: false });

    let { data: analyses, error } = await selectAnalysis().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data: analyses, error } = await selectAnalysis());
    }

    const analysisRows = (analyses as Array<{
      subject?: string | null;
      risk_score?: number | null;
    }> | null) ?? [];

    // ìœ„í—˜ë„ê°€ ë†’ì€ ê³¼ëª©ì„ ì·¨ì•½ ê³¼ëª©ìœ¼ë¡œ ê°„ì£¼ (risk_score >= 50)
    const weakSubjects = analysisRows
      .filter((a) => a.subject && a.risk_score !== null && a.risk_score !== undefined && a.risk_score >= 50)
      .map((a) => a.subject!);

    // ì „ì²´ í•™ìŠµì‹œê°„ ê³„ì‚°
    const totalStudyTime = Array.from(subjectTimeMap.values()).reduce(
      (sum, minutes) => sum + minutes,
      0
    );

    // ì·¨ì•½ ê³¼ëª© í•™ìŠµì‹œê°„ í•©ê³„
    const weakSubjectStudyTime = weakSubjects.reduce(
      (sum, subject) => sum + (subjectTimeMap.get(subject) || 0),
      0
    );

    // ì·¨ì•½ ê³¼ëª© í•™ìŠµì‹œê°„ ë¹„ìœ¨
    const weakSubjectStudyTimeRatio =
      totalStudyTime > 0 ? Math.round((weakSubjectStudyTime / totalStudyTime) * 100) : 0;

    return {
      weakSubjects,
      subjectStudyTime: subjectTimeMap,
      totalStudyTime,
      weakSubjectStudyTimeRatio,
    };
  } catch (error) {
    console.error("[metrics/getWeakSubjects] ì·¨ì•½ ê³¼ëª© ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      weakSubjects: [],
      subjectStudyTime: new Map(),
      totalStudyTime: 0,
      weakSubjectStudyTimeRatio: 0,
    };
  }
}
</file>

<file path="streak.ts">
import { getSessionsInRange } from "@/lib/data/studentSessions";

/**
 * ì—°ì† í•™ìŠµì¼ ê³„ì‚°
 * ìµœê·¼ 30ì¼ ì¤‘ í•™ìŠµì´ 30ë¶„ ì´ìƒ ìˆì—ˆë˜ ë‚ ì„ "í•™ìŠµì¼"ë¡œ ê³„ì‚°
 */
export async function calculateStreak(
  studentId: string,
  tenantId?: string | null
): Promise<number> {
  try {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // ìµœê·¼ 30ì¼ ë²”ìœ„ ê³„ì‚°
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    thirtyDaysAgo.setHours(0, 0, 0, 0);

    const startDate = thirtyDaysAgo.toISOString();
    const endDate = new Date(today);
    endDate.setHours(23, 59, 59, 999);
    const endDateStr = endDate.toISOString();

    // ìµœê·¼ 30ì¼ ì„¸ì…˜ ì¡°íšŒ
    const sessions = await getSessionsInRange({
      studentId,
      tenantId,
      dateRange: {
        start: startDate,
        end: endDateStr,
      },
    });

    // ë‚ ì§œë³„ í•™ìŠµ ì‹œê°„ ì§‘ê³„ (ë¶„ ë‹¨ìœ„)
    const dailyMinutes = new Map<string, number>();

    sessions.forEach((session) => {
      if (!session.ended_at || !session.duration_seconds) {
        return;
      }

      const sessionDate = new Date(session.started_at);
      sessionDate.setHours(0, 0, 0, 0);
      const dateKey = sessionDate.toISOString().slice(0, 10);

      const minutes = Math.floor(session.duration_seconds / 60);
      const currentMinutes = dailyMinutes.get(dateKey) || 0;
      dailyMinutes.set(dateKey, currentMinutes + minutes);
    });

    // ì—°ì† í•™ìŠµì¼ ê³„ì‚° (ì˜¤ëŠ˜ë¶€í„° ì—­ìˆœìœ¼ë¡œ)
    let streak = 0;
    const currentDate = new Date(today);

    for (let i = 0; i < 30; i++) {
      const checkDate = new Date(currentDate);
      checkDate.setDate(currentDate.getDate() - i);
      const dateKey = checkDate.toISOString().slice(0, 10);

      const minutes = dailyMinutes.get(dateKey) || 0;

      // 30ë¶„ ì´ìƒ í•™ìŠµí•œ ë‚ ì´ë©´ ì—°ì†ì¼ ì¦ê°€
      if (minutes >= 30) {
        streak++;
      } else {
        // ì—°ì†ì´ ëŠì–´ì§€ë©´ ì¢…ë£Œ
        break;
      }
    }

    return streak;
  } catch (error) {
    console.error("[metrics/streak] ì—°ì† í•™ìŠµì¼ ê³„ì‚° ì‹¤íŒ¨", error);
    return 0;
  }
}
</file>

<file path="studyTime.ts">
import type { StudySession } from "@/lib/data/studentSessions";

/**
 * í”Œëœì˜ í•™ìŠµ ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
 * Today í˜ì´ì§€ì™€ ëŒ€ì‹œë³´ë“œì—ì„œ ë™ì¼í•œ ë¡œì§ ì‚¬ìš©
 * 
 * @param plan í”Œëœ ì •ë³´ (actual_start_time, actual_end_time, total_duration_seconds, paused_duration_seconds í¬í•¨)
 * @param nowMs í˜„ì¬ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
 * @param activeSession í™œì„± ì„¸ì…˜ ì •ë³´ (í˜„ì¬ ì¼ì‹œì •ì§€ ì¤‘ì¸ ê²½ìš°)
 * @returns ìˆœìˆ˜ í•™ìŠµ ì‹œê°„ (ì´ˆ, ì¼ì‹œì •ì§€ ì œì™¸)
 */
export function calculatePlanStudySeconds(
  plan: {
    actual_start_time: string | null | undefined;
    actual_end_time: string | null | undefined;
    total_duration_seconds: number | null | undefined;
    paused_duration_seconds: number | null | undefined;
  },
  nowMs: number,
  activeSession?: StudySession | null
): number {
  if (!plan.actual_start_time) {
    return 0;
  }

  const startMs = new Date(plan.actual_start_time).getTime();
  if (!Number.isFinite(startMs)) {
    return 0;
  }

  let endMs = plan.actual_end_time ? new Date(plan.actual_end_time).getTime() : nowMs;
  if (!Number.isFinite(endMs) || endMs <= startMs) {
    return 0;
  }

  let elapsedSeconds: number;
  if (plan.total_duration_seconds && plan.actual_end_time) {
    // ì™„ë£Œëœ í”Œëœ: ì €ì¥ëœ total_duration_seconds ì‚¬ìš©
    elapsedSeconds = plan.total_duration_seconds;
  } else {
    // ì§„í–‰ ì¤‘ì¸ í”Œëœ: íƒ€ì„ìŠ¤íƒ¬í”„ ì°¨ì´ ê³„ì‚°
    elapsedSeconds = Math.floor((endMs - startMs) / 1000);
  }

  let pausedSeconds = plan.paused_duration_seconds ?? 0;

  // í˜„ì¬ ì¼ì‹œì •ì§€ ì¤‘ì¸ ê²½ìš° ì¶”ê°€ ê³„ì‚°
  if (!plan.actual_end_time && activeSession && activeSession.paused_at && !activeSession.resumed_at) {
    const pausedAtMs = new Date(activeSession.paused_at).getTime();
    if (Number.isFinite(pausedAtMs)) {
      pausedSeconds += Math.max(0, Math.floor((nowMs - pausedAtMs) / 1000));
    }
  }

  return Math.max(0, elapsedSeconds - pausedSeconds);
}

/**
 * í™œì„± ì„¸ì…˜ ë§µ ìƒì„±
 * @param sessions ì„¸ì…˜ ëª©ë¡
 * @returns plan_idë¥¼ í‚¤ë¡œ í•˜ëŠ” í™œì„± ì„¸ì…˜ ë§µ
 */
export function buildActiveSessionMap(sessions: StudySession[]): Map<string, StudySession> {
  const map = new Map<string, StudySession>();
  sessions.forEach((session) => {
    if (session.plan_id && !session.ended_at) {
      const existing = map.get(session.plan_id);
      if (!existing) {
        map.set(session.plan_id, session);
        return;
      }
      const existingStart = new Date(existing.started_at).getTime();
      const currentStart = new Date(session.started_at).getTime();
      if (currentStart >= existingStart) {
        map.set(session.plan_id, session);
      }
    }
  });
  return map;
}
</file>

<file path="todayProgress.ts">
import { getPlansForStudent } from "@/lib/data/studentPlans";
import type { Plan } from "@/lib/data/studentPlans";
import { getSessionsInRange } from "@/lib/data/studentSessions";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import {
  calculatePlanStudySeconds,
  buildActiveSessionMap,
} from "@/lib/metrics/studyTime";
import { getPlanGroupsForStudent } from "@/lib/data/planGroups";
import { isCompletedPlan, filterLearningPlans } from "@/lib/utils/planUtils";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export type TodayProgress = {
  todayStudyMinutes: number; // ì˜¤ëŠ˜ í•™ìŠµ ì‹œê°„ (ë¶„)
  planCompletedCount: number; // ì™„ë£Œí•œ í”Œëœ ìˆ˜
  planTotalCount: number; // ì „ì²´ í”Œëœ ìˆ˜
  achievementScore: number; // 0-100
};

/**
 * íŠ¹ì • ë‚ ì§œì˜ í•™ìŠµ ì§„í–‰ë¥  ê³„ì‚°
 * @param studentId í•™ìƒ ID
 * @param tenantId í…Œë„ŒíŠ¸ ID
 * @param targetDate ê³„ì‚°í•  ë‚ ì§œ (YYYY-MM-DD í˜•ì‹, ê¸°ë³¸ê°’: ì˜¤ëŠ˜)
 * @param excludeCampMode ìº í”„ ëª¨ë“œ í”Œëœ ì œì™¸ ì—¬ë¶€ (ê¸°ë³¸ê°’: false)
 */
export async function calculateTodayProgress(
  studentId: string,
  tenantId?: string | null,
  targetDate?: string,
  excludeCampMode: boolean = false
): Promise<TodayProgress> {
  try {
    // targetDateê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayDate = targetDate || today.toISOString().slice(0, 10);

    // ê³„ì‚°í•  ë‚ ì§œ ì„¤ì •
    const target = new Date(todayDate + "T00:00:00");
    const targetEnd = new Date(target);
    targetEnd.setHours(23, 59, 59, 999);
    const targetEndStr = targetEnd.toISOString();

    // 1. í•´ë‹¹ ë‚ ì§œì˜ í”Œëœ ì¡°íšŒ
    let planGroupIds: string[] | undefined = undefined;
    if (excludeCampMode) {
      // ì¼ë°˜ ëª¨ë“œ: ìº í”„ í”Œëœ ê·¸ë£¹ ì œì™¸
      const allPlanGroups = await getPlanGroupsForStudent({
        studentId,
        tenantId,
      });
      const nonCampPlanGroups = allPlanGroups.filter(
        (group) =>
          group.plan_type !== "camp" &&
          group.camp_template_id === null &&
          group.camp_invitation_id === null
      );
      planGroupIds = nonCampPlanGroups.map((g) => g.id);
    }

    const plans = await getPlansForStudent({
      studentId,
      tenantId,
      planDate: todayDate,
      planGroupIds:
        planGroupIds && planGroupIds.length > 0 ? planGroupIds : undefined,
    });

    // í•™ìŠµ í”Œëœë§Œ í•„í„°ë§ (ë”ë¯¸ ì½˜í…ì¸  ì œì™¸)
    const learningPlans = filterLearningPlans(plans);

    const planTotalCount = learningPlans.length;
    const planCompletedCount = learningPlans.filter((plan) =>
      isCompletedPlan(plan)
    ).length;

    // 2. í•´ë‹¹ ë‚ ì§œì˜ ì„¸ì…˜ ì¡°íšŒ ë° í•™ìŠµ ì‹œê°„ ê³„ì‚°
    const sessions = await getSessionsInRange({
      studentId,
      tenantId,
      dateRange: {
        start: target.toISOString(),
        end: targetEndStr,
      },
    });

    const activeSessionMap = buildActiveSessionMap(sessions);
    const nowMs = Date.now();
    const todayStudySeconds = plans.reduce((total, plan) => {
      return (
        total +
        calculatePlanStudySeconds(
          {
            actual_start_time: plan.actual_start_time,
            actual_end_time: plan.actual_end_time,
            total_duration_seconds: plan.total_duration_seconds,
            paused_duration_seconds: plan.paused_duration_seconds,
          },
          nowMs,
          plan.actual_end_time ? undefined : activeSessionMap.get(plan.id)
        )
      );
    }, 0);

    const todayStudyMinutes = Math.floor(todayStudySeconds / 60);

    // 3. Achievement Score ê³„ì‚°
    // (ì˜¤ëŠ˜ ì‹¤í–‰ë¥  * 0.7) + (ì§‘ì¤‘ íƒ€ì´ë¨¸ ëˆ„ì /ì˜ˆìƒ * 0.3)
    const executionRate =
      planTotalCount > 0 ? (planCompletedCount / planTotalCount) * 100 : 0;

    // ì˜ˆìƒ í•™ìŠµ ì‹œê°„ ê³„ì‚° (í”Œëœ ê¸°ë°˜, í‰ê·  60ë¶„ ê°€ì •)
    const expectedMinutes = planTotalCount * 60;
    const focusTimerRate =
      expectedMinutes > 0
        ? Math.min((todayStudyMinutes / expectedMinutes) * 100, 100)
        : 0;

    const achievementScore = Math.round(
      executionRate * 0.7 + focusTimerRate * 0.3
    );

    return {
      todayStudyMinutes,
      planCompletedCount,
      planTotalCount,
      achievementScore,
    };
  } catch (error) {
    console.error("[metrics/todayProgress] ì˜¤ëŠ˜ ì§„í–‰ë¥  ê³„ì‚° ì‹¤íŒ¨", error);
    return {
      todayStudyMinutes: 0,
      planCompletedCount: 0,
      planTotalCount: 0,
      achievementScore: 0,
    };
  }
}
</file>

<file path="calc.ts">
export type Goal = {
  id: string;
  student_id: string;
  goal_type: "range" | "exam" | "weekly" | "monthly" | "weak_subject";
  title: string;
  description: string | null;
  subject: string | null;
  content_id: string | null;
  start_date: string;
  end_date: string;
  expected_amount: number | null;
  target_score: number | null;
  created_at: string;
};

export type GoalProgress = {
  id: string;
  goal_id: string;
  student_id: string;
  plan_id: string | null;
  session_id: string | null;
  progress_amount: number | null;
  recorded_at: string;
};

export type GoalProgressResult = {
  currentAmount: number;
  expectedAmount: number;
  progressPercentage: number;
  status: "scheduled" | "in_progress" | "completed" | "failed";
  daysRemaining: number | null;
  daysUntilStart: number | null;
  dailyRequiredAmount: number | null; // í•˜ë£¨ì— í•„ìš”í•œ í•™ìŠµëŸ‰
  recent3DaysAmount: number; // ìµœê·¼ 3ì¼ í•™ìŠµëŸ‰
};

// ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°
export function calculateGoalProgress(
  goal: Goal,
  progressRows: GoalProgress[],
  today: Date = new Date()
): GoalProgressResult {
  const todayDate = today.toISOString().slice(0, 10);
  const startDate = new Date(goal.start_date);
  const endDate = new Date(goal.end_date);
  startDate.setHours(0, 0, 0, 0);
  endDate.setHours(0, 0, 0, 0);
  today.setHours(0, 0, 0, 0);

  // í˜„ì¬ ë‹¬ì„±ëŸ‰ ê³„ì‚°
  const currentAmount = progressRows.reduce(
    (sum, row) => sum + (row.progress_amount || 0),
    0
  );

  const expectedAmount = goal.expected_amount || 0;
  const progressPercentage =
    expectedAmount > 0 ? Math.min(100, Math.round((currentAmount / expectedAmount) * 100)) : 0;

  // ìƒíƒœ ê³„ì‚°
  let status: "scheduled" | "in_progress" | "completed" | "failed";
  if (today < startDate) {
    status = "scheduled";
  } else if (progressPercentage >= 100) {
    status = "completed";
  } else if (today > endDate) {
    status = "failed";
  } else {
    status = "in_progress";
  }

  // ë‚ ì§œ ê³„ì‚°
  const daysUntilStart = today < startDate ? Math.ceil((startDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)) : null;
  const daysRemaining = today <= endDate ? Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)) : null;

  // í•˜ë£¨ì— í•„ìš”í•œ í•™ìŠµëŸ‰ ê³„ì‚°
  let dailyRequiredAmount: number | null = null;
  if (status === "in_progress" && daysRemaining !== null && daysRemaining > 0) {
    const remainingAmount = expectedAmount - currentAmount;
    dailyRequiredAmount = Math.ceil(remainingAmount / daysRemaining);
  }

  // ìµœê·¼ 3ì¼ í•™ìŠµëŸ‰ ê³„ì‚°
  const threeDaysAgo = new Date(today);
  threeDaysAgo.setDate(today.getDate() - 3);
  const recent3DaysAmount = progressRows
    .filter((row) => {
      const recordedDate = new Date(row.recorded_at);
      return recordedDate >= threeDaysAgo;
    })
    .reduce((sum, row) => sum + (row.progress_amount || 0), 0);

  return {
    currentAmount,
    expectedAmount,
    progressPercentage,
    status,
    daysRemaining,
    daysUntilStart,
    dailyRequiredAmount,
    recent3DaysAmount,
  };
}

// ëª©í‘œ ìƒíƒœ ë¼ë²¨
export function getGoalStatusLabel(status: GoalProgressResult["status"]): string {
  switch (status) {
    case "scheduled":
      return "ì˜ˆì •";
    case "in_progress":
      return "ì§„í–‰ì¤‘";
    case "completed":
      return "ì™„ë£Œ";
    case "failed":
      return "ë¯¸ë‹¬ì„±";
    default:
      return "ì•Œ ìˆ˜ ì—†ìŒ";
  }
}

// ëª©í‘œ íƒ€ì… ë¼ë²¨
export function getGoalTypeLabel(goalType: Goal["goal_type"]): string {
  switch (goalType) {
    case "range":
      return "ë‹¨ì›/ë²”ìœ„";
    case "exam":
      return "ì‹œí—˜ ëŒ€ë¹„";
    case "weekly":
      return "ì£¼ê°„ ëª©í‘œ";
    case "monthly":
      return "ì›”ê°„ ëª©í‘œ";
    default:
      return goalType;
  }
}

// ëª©í‘œ íƒ€ì… ìƒ‰ìƒ
export function getGoalTypeColor(goalType: Goal["goal_type"]): string {
  switch (goalType) {
    case "range":
      return "bg-blue-100 text-blue-800";
    case "exam":
      return "bg-red-100 text-red-800";
    case "weekly":
      return "bg-green-100 text-green-800";
    case "monthly":
      return "bg-purple-100 text-purple-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}
</file>

<file path="queries.ts">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import type { Goal, GoalProgress } from "./calc";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

// ëª¨ë“  ëª©í‘œ ì¡°íšŒ
export async function getAllGoals(
  supabase: SupabaseServerClient,
  studentId: string
): Promise<Goal[]> {
  try {
    const selectGoals = () =>
      supabase
        .from("student_goals")
        .select("*")
        .order("created_at", { ascending: false });

    let { data, error } = await selectGoals().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data, error } = await selectGoals());
    }

    if (error) {
      console.error("[goals] ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
      return [];
    }

    return (data as Goal[] | null) ?? [];
  } catch (error) {
    console.error("[goals] ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
    return [];
  }
}

// ë‹¨ì¼ ëª©í‘œ ì¡°íšŒ
export async function getGoalById(
  supabase: SupabaseServerClient,
  studentId: string,
  goalId: string
): Promise<Goal | null> {
  try {
    const selectGoal = () =>
      supabase.from("student_goals").select("*").eq("id", goalId);

    let { data, error } = await selectGoal().eq("student_id", studentId).maybeSingle();

    if (error && error.code === "42703") {
      ({ data, error } = await selectGoal().maybeSingle());
    }

    if (error) {
      console.error("[goals] ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
      return null;
    }

    return (data as Goal | null) ?? null;
  } catch (error) {
    console.error("[goals] ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
    return null;
  }
}

// ëª©í‘œ ì§„í–‰ë¥  ê¸°ë¡ ì¡°íšŒ
export async function getGoalProgress(
  supabase: SupabaseServerClient,
  studentId: string,
  goalId: string
): Promise<GoalProgress[]> {
  try {
    const selectProgress = () =>
      supabase
        .from("student_goal_progress")
        .select("*")
        .eq("goal_id", goalId)
        .order("recorded_at", { ascending: false });

    let { data, error } = await selectProgress().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data, error } = await selectProgress());
    }

    if (error) {
      console.error("[goals] ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨", error);
      return [];
    }

    return (data as GoalProgress[] | null) ?? [];
  } catch (error) {
    console.error("[goals] ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨", error);
    return [];
  }
}

// í™œì„± ëª©í‘œ ì¡°íšŒ (ì˜¤ëŠ˜ ê¸°ì¤€)
export async function getActiveGoals(
  supabase: SupabaseServerClient,
  studentId: string,
  todayDate: string
): Promise<Goal[]> {
  try {
    const selectGoals = () =>
      supabase
        .from("student_goals")
        .select("*")
        .lte("start_date", todayDate)
        .gte("end_date", todayDate)
        .order("end_date", { ascending: true });

    let { data, error } = await selectGoals().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data, error } = await selectGoals());
    }

    if (error) {
      console.error("[goals] í™œì„± ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
      return [];
    }

    return (data as Goal[] | null) ?? [];
  } catch (error) {
    console.error("[goals] í™œì„± ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
    return [];
  }
}

// ì´ë²ˆ ì£¼ ëª©í‘œ ì¡°íšŒ
export async function getWeekGoals(
  supabase: SupabaseServerClient,
  studentId: string,
  weekStart: string,
  weekEnd: string
): Promise<Goal[]> {
  try {
    const selectGoals = () =>
      supabase
        .from("student_goals")
        .select("*")
        .lte("start_date", weekEnd)
        .gte("end_date", weekStart)
        .order("end_date", { ascending: true });

    let { data, error } = await selectGoals().eq("student_id", studentId);

    if (error && error.code === "42703") {
      ({ data, error } = await selectGoals());
    }

    if (error) {
      console.error("[goals] ì£¼ê°„ ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
      return [];
    }

    return (data as Goal[] | null) ?? [];
  } catch (error) {
    console.error("[goals] ì£¼ê°„ ëª©í‘œ ì¡°íšŒ ì‹¤íŒ¨", error);
    return [];
  }
}

// ëª©í‘œì— ì—°ê²°ëœ í”Œëœ ì¡°íšŒ
export async function getPlansForGoal(
  supabase: SupabaseServerClient,
  studentId: string,
  goalId: string
): Promise<Array<{
  id: string;
  plan_date: string;
  content_type: string | null;
  content_id: string | null;
  content_title: string | null;
}>> {
  try {
    // goal_progressì—ì„œ plan_id ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const selectProgress = () =>
      supabase
        .from("student_goal_progress")
        .select("plan_id")
        .eq("goal_id", goalId)
        .not("plan_id", "is", null);

    let { data: progressData, error: progressError } = await selectProgress()
      .eq("student_id", studentId);

    if (progressError && progressError.code === "42703") {
      ({ data: progressData, error: progressError } = await selectProgress());
    }

    if (progressError || !progressData || progressData.length === 0) {
      return [];
    }

    const planIds = progressData
      .map((p: any) => p.plan_id)
      .filter((id: string | null): id is string => id !== null);

    if (planIds.length === 0) {
      return [];
    }

    // í”Œëœ ì •ë³´ ì¡°íšŒ
    const selectPlans = () =>
      supabase
        .from("student_plan")
        .select("id,plan_date,content_type,content_id")
        .in("id", planIds);

    let { data: plans, error: plansError } = await selectPlans()
      .eq("student_id", studentId);

    if (plansError && plansError.code === "42703") {
      ({ data: plans, error: plansError } = await selectPlans());
    }

    if (plansError || !plans) {
      return [];
    }

    // ì½˜í…ì¸  ì •ë³´ ì¡°íšŒ
    const contentMap = new Map<string, string>();
    for (const plan of plans) {
      if (!plan.content_type || !plan.content_id) continue;

      const tableName =
        plan.content_type === "book"
          ? "books"
          : plan.content_type === "lecture"
          ? "lectures"
          : "student_custom_contents";

      const selectContent = () =>
        supabase.from(tableName).select("id,title").eq("id", plan.content_id);

      let { data: content, error: contentError } = await selectContent()
        .eq("student_id", studentId)
        .maybeSingle();

      if (contentError && contentError.code === "42703") {
        ({ data: content, error: contentError } = await selectContent().maybeSingle());
      }

      if (!contentError && content) {
        contentMap.set(`${plan.content_type}:${plan.content_id}`, (content as any).title || "ì œëª© ì—†ìŒ");
      }
    }

    return plans.map((plan) => ({
      id: plan.id,
      plan_date: plan.plan_date || "",
      content_type: plan.content_type,
      content_id: plan.content_id,
      content_title: plan.content_type && plan.content_id
        ? contentMap.get(`${plan.content_type}:${plan.content_id}`) || null
        : null,
    }));
  } catch (error) {
    console.error("[goals] ëª©í‘œ í”Œëœ ì¡°íšŒ ì‹¤íŒ¨", error);
    return [];
  }
}

// ëª©í‘œ ìš”ì•½ ì¡°íšŒ (ì˜¤ëŠ˜ ë° ì£¼ê°„)
export async function fetchGoalsSummary(
  supabase: SupabaseServerClient,
  studentId: string,
  todayDate: string,
  weekStart: string,
  weekEnd: string
): Promise<{
  todayGoals: Array<{
    id: string;
    title: string;
    goal_type: string;
    progressPercentage: number;
    status: "upcoming" | "active" | "completed" | "failed";
    daysRemaining: number | null;
  }>;
  weekGoals: Array<{
    id: string;
    title: string;
    goal_type: string;
    progressPercentage: number;
    status: "upcoming" | "active" | "completed" | "failed";
    daysRemaining: number | null;
  }>;
}> {
  try {
    const { calculateGoalProgress } = await import("./calc");

    const [activeGoals, weekGoals] = await Promise.all([
      getActiveGoals(supabase, studentId, todayDate),
      getWeekGoals(supabase, studentId, weekStart, weekEnd),
    ]);

    const today = new Date(todayDate);
    today.setHours(0, 0, 0, 0);

    // ì˜¤ëŠ˜ ëª©í‘œ ì§„í–‰ë¥  ê³„ì‚°
    const todayGoalsWithProgress = await Promise.all(
      activeGoals.map(async (goal) => {
        const progressRows = await getGoalProgress(supabase, studentId, goal.id);
        const progress = calculateGoalProgress(goal, progressRows, today);
        return {
          id: goal.id,
          title: goal.title,
          goal_type: goal.goal_type,
          progressPercentage: progress.progressPercentage,
          status:
            progress.status === "scheduled"
              ? ("upcoming" as const)
              : progress.status === "in_progress"
              ? ("active" as const)
              : progress.status === "completed"
              ? ("completed" as const)
              : ("failed" as const),
          daysRemaining: progress.daysRemaining,
        };
      })
    );

    // ì£¼ê°„ ëª©í‘œ ì§„í–‰ë¥  ê³„ì‚°
    const weekGoalsWithProgress = await Promise.all(
      weekGoals.map(async (goal) => {
        const progressRows = await getGoalProgress(supabase, studentId, goal.id);
        const progress = calculateGoalProgress(goal, progressRows, today);
        return {
          id: goal.id,
          title: goal.title,
          goal_type: goal.goal_type,
          progressPercentage: progress.progressPercentage,
          status:
            progress.status === "scheduled"
              ? ("upcoming" as const)
              : progress.status === "in_progress"
              ? ("active" as const)
              : progress.status === "completed"
              ? ("completed" as const)
              : ("failed" as const),
          daysRemaining: progress.daysRemaining,
        };
      })
    );

    return {
      todayGoals: todayGoalsWithProgress,
      weekGoals: weekGoalsWithProgress,
    };
  } catch (error) {
    console.error("[goals] ëª©í‘œ ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨", error);
    return {
      todayGoals: [],
      weekGoals: [],
    };
  }
}
</file>

</files>
