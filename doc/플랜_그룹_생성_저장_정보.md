# í”Œëœ ê·¸ë£¹ ìƒì„± ì‹œ ì €ì¥ ì •ë³´

## ğŸ“‹ ê°œìš”

í”Œëœ ê·¸ë£¹ ìƒì„± ì‹œ ì €ì¥ë˜ëŠ” ëª¨ë“  ì •ë³´ë¥¼ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” êµ¬ì¡°

### 1. `plan_groups` í…Œì´ë¸” (ë©”ì¸ í…Œì´ë¸”)

í”Œëœ ê·¸ë£¹ì˜ ë©”íƒ€ë°ì´í„°ê°€ ì €ì¥ë˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.

#### ê¸°ë³¸ í•„ë“œ

| í•„ë“œëª…           | íƒ€ì…         | ì„¤ëª…                                                                       | í•„ìˆ˜ ì—¬ë¶€            |
| ---------------- | ------------ | -------------------------------------------------------------------------- | -------------------- |
| `id`             | uuid         | í”Œëœ ê·¸ë£¹ ê³ ìœ  ID (ìë™ ìƒì„±)                                              | âœ…                   |
| `tenant_id`      | uuid         | ê¸°ê´€ ID                                                                    | âœ…                   |
| `student_id`     | uuid         | í•™ìƒ ID                                                                    | âœ…                   |
| `name`           | varchar(200) | í”Œëœ ì´ë¦„                                                                  | âŒ                   |
| `plan_purpose`   | varchar(50)  | í”Œëœ ëª©ì  (`ë‚´ì‹ ëŒ€ë¹„`, `ëª¨ì˜ê³ ì‚¬`, `ìˆ˜ëŠ¥`, `ê¸°íƒ€`)                         | âŒ                   |
| `scheduler_type` | varchar(50)  | ìŠ¤ì¼€ì¤„ëŸ¬ ìœ í˜• (`ìë™ìŠ¤ì¼€ì¤„ëŸ¬`, `1730_timetable`)                           | âŒ                   |
| `period_start`   | date         | í•™ìŠµ ê¸°ê°„ ì‹œì‘ì¼                                                           | âœ…                   |
| `period_end`     | date         | í•™ìŠµ ê¸°ê°„ ì¢…ë£Œì¼                                                           | âœ…                   |
| `target_date`    | date         | ëª©í‘œ ë‚ ì§œ (D-day, ì‹œí—˜ì¼ ë“±)                                               | âŒ                   |
| `block_set_id`   | uuid         | ë¸”ë¡ ì„¸íŠ¸ ID                                                               | âŒ                   |
| `status`         | varchar(20)  | í”Œëœ ìƒíƒœ (`draft`, `saved`, `active`, `paused`, `completed`, `cancelled`) | âœ… (ê¸°ë³¸ê°’: `draft`) |
| `deleted_at`     | timestamptz  | ì‚­ì œ ì‹œê°„ (Soft Delete)                                                    | âŒ                   |
| `created_at`     | timestamptz  | ìƒì„± ì‹œê°„ (ìë™ ìƒì„±)                                                      | âœ…                   |
| `updated_at`     | timestamptz  | ìˆ˜ì • ì‹œê°„ (ìë™ ìƒì„±)                                                      | âœ…                   |

#### JSONB í•„ë“œ

| í•„ë“œëª…                           | íƒ€ì…  | ì„¤ëª…                                   | ì €ì¥ ìœ„ì¹˜            |
| -------------------------------- | ----- | -------------------------------------- | -------------------- |
| `scheduler_options`              | jsonb | ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜ ì„¤ì •                     | `plan_groups` í…Œì´ë¸” |
| `daily_schedule`                 | jsonb | ì¼ë³„ ìŠ¤ì¼€ì¤„ ì •ë³´ (Step 7ì—ì„œ ìƒì„±)     | `plan_groups` í…Œì´ë¸” |
| `subject_constraints`            | jsonb | êµê³¼ ì œì•½ ì¡°ê±´ (1730 Timetable)        | `plan_groups` í…Œì´ë¸” |
| `additional_period_reallocation` | jsonb | ì¶”ê°€ ê¸°ê°„ ì¬ë°°ì¹˜ ì •ë³´ (1730 Timetable) | `plan_groups` í…Œì´ë¸” |
| `non_study_time_blocks`          | jsonb | í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª© (1730 Timetable)   | `plan_groups` í…Œì´ë¸” |

### 2. `plan_contents` í…Œì´ë¸”

í”Œëœ ê·¸ë£¹ì— í¬í•¨ëœ ì½˜í…ì¸  ì •ë³´ê°€ ì €ì¥ë˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.

| í•„ë“œëª…          | íƒ€ì…        | ì„¤ëª…                                      | í•„ìˆ˜ ì—¬ë¶€ |
| --------------- | ----------- | ----------------------------------------- | --------- |
| `id`            | uuid        | ì½˜í…ì¸  ê´€ê³„ ê³ ìœ  ID (ìë™ ìƒì„±)           | âœ…        |
| `tenant_id`     | uuid        | ê¸°ê´€ ID                                   | âœ…        |
| `plan_group_id` | uuid        | í”Œëœ ê·¸ë£¹ ID                              | âœ…        |
| `content_type`  | varchar(20) | ì½˜í…ì¸  íƒ€ì… (`book`, `lecture`, `custom`) | âœ…        |
| `content_id`    | uuid        | ì½˜í…ì¸  ID (ë§ˆìŠ¤í„° ì½˜í…ì¸  ID)              | âœ…        |
| `start_range`   | integer     | ì‹œì‘ ë²”ìœ„ (í˜ì´ì§€/íšŒì°¨)                   | âœ…        |
| `end_range`     | integer     | ì¢…ë£Œ ë²”ìœ„ (í˜ì´ì§€/íšŒì°¨)                   | âœ…        |
| `display_order` | integer     | í‘œì‹œ ìˆœì„œ                                 | âœ…        |
| `created_at`    | timestamptz | ìƒì„± ì‹œê°„ (ìë™ ìƒì„±)                     | âœ…        |
| `updated_at`    | timestamptz | ìˆ˜ì • ì‹œê°„ (ìë™ ìƒì„±)                     | âœ…        |

### 3. `plan_exclusions` í…Œì´ë¸”

í”Œëœ ê·¸ë£¹ë³„ ì œì™¸ì¼ ì •ë³´ê°€ ì €ì¥ë˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.

| í•„ë“œëª…           | íƒ€ì…        | ì„¤ëª…                                                 | í•„ìˆ˜ ì—¬ë¶€ |
| ---------------- | ----------- | ---------------------------------------------------- | --------- |
| `id`             | uuid        | ì œì™¸ì¼ ê³ ìœ  ID (ìë™ ìƒì„±)                           | âœ…        |
| `tenant_id`      | uuid        | ê¸°ê´€ ID                                              | âœ…        |
| `student_id`     | uuid        | í•™ìƒ ID                                              | âœ…        |
| `plan_group_id`  | uuid        | í”Œëœ ê·¸ë£¹ ID                                         | âœ…        |
| `exclusion_date` | date        | ì œì™¸ì¼                                               | âœ…        |
| `exclusion_type` | varchar(20) | ì œì™¸ì¼ ìœ í˜• (`íœ´ê°€`, `ê°œì¸ì‚¬ì •`, `íœ´ì¼ì§€ì •`, `ê¸°íƒ€`) | âœ…        |
| `reason`         | text        | ì œì™¸ ì‚¬ìœ                                             | âŒ        |
| `created_at`     | timestamptz | ìƒì„± ì‹œê°„ (ìë™ ìƒì„±)                                | âœ…        |

### 4. `academy_schedules` í…Œì´ë¸”

í•™ìƒë³„ í•™ì› ì¼ì • ì •ë³´ê°€ ì €ì¥ë˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤. (ì „ì—­ ê´€ë¦¬)

| í•„ë“œëª…         | íƒ€ì…         | ì„¤ëª…                            | í•„ìˆ˜ ì—¬ë¶€ |
| -------------- | ------------ | ------------------------------- | --------- |
| `id`           | uuid         | í•™ì› ì¼ì • ê³ ìœ  ID (ìë™ ìƒì„±)   | âœ…        |
| `tenant_id`    | uuid         | ê¸°ê´€ ID                         | âŒ        |
| `student_id`   | uuid         | í•™ìƒ ID                         | âœ…        |
| `academy_id`   | uuid         | í•™ì› ID                         | âœ…        |
| `day_of_week`  | integer      | ìš”ì¼ (0-6, ì¼-í† )               | âœ…        |
| `start_time`   | time         | ì‹œì‘ ì‹œê°„                       | âœ…        |
| `end_time`     | time         | ì¢…ë£Œ ì‹œê°„                       | âœ…        |
| `subject`      | varchar(100) | ê³¼ëª©                            | âŒ        |
| `academy_name` | varchar(200) | í•™ì›ëª… (í•˜ìœ„ í˜¸í™˜ì„±)            | âŒ        |
| `travel_time`  | integer      | ì´ë™ì‹œê°„ (ë¶„ ë‹¨ìœ„, í•˜ìœ„ í˜¸í™˜ì„±) | âŒ        |
| `created_at`   | timestamptz  | ìƒì„± ì‹œê°„ (ìë™ ìƒì„±)           | âœ…        |
| `updated_at`   | timestamptz  | ìˆ˜ì • ì‹œê°„ (ìë™ ìƒì„±)           | âœ…        |

### 5. `academies` í…Œì´ë¸”

í•™ìƒë³„ í•™ì› ì •ë³´ê°€ ì €ì¥ë˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤. (ì „ì—­ ê´€ë¦¬)

| í•„ë“œëª…        | íƒ€ì…         | ì„¤ëª…                                | í•„ìˆ˜ ì—¬ë¶€ |
| ------------- | ------------ | ----------------------------------- | --------- |
| `id`          | uuid         | í•™ì› ê³ ìœ  ID (ìë™ ìƒì„±)            | âœ…        |
| `tenant_id`   | uuid         | ê¸°ê´€ ID                             | âŒ        |
| `student_id`  | uuid         | í•™ìƒ ID                             | âœ…        |
| `name`        | varchar(200) | í•™ì›ëª…                              | âœ…        |
| `travel_time` | integer      | ê¸°ë³¸ ì´ë™ì‹œê°„ (ë¶„ ë‹¨ìœ„, ê¸°ë³¸ê°’: 60) | âœ…        |
| `created_at`  | timestamptz  | ìƒì„± ì‹œê°„ (ìë™ ìƒì„±)               | âœ…        |
| `updated_at`  | timestamptz  | ìˆ˜ì • ì‹œê°„ (ìë™ ìƒì„±)               | âœ…        |

## ğŸ“¦ ì €ì¥ë˜ëŠ” ë°ì´í„° êµ¬ì¡°

### `scheduler_options` (JSONB)

ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜ ì„¤ì •ì´ ì €ì¥ë©ë‹ˆë‹¤. `time_settings`ì™€ `study_review_cycle`ì´ ë³‘í•©ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.

```typescript
{
  // ìë™ ìŠ¤ì¼€ì¤„ëŸ¬ ì˜µì…˜
  difficulty_weight?: number;
  progress_weight?: number;
  score_weight?: number;
  weak_subject_focus?: "low" | "medium" | "high" | boolean;
  exam_urgency_enabled?: boolean;
  allow_consecutive?: boolean;

  // 1730 Timetable ì˜µì…˜
  study_days?: number; // í•™ìŠµì¼ ìˆ˜ (ê¸°ë³¸ê°’: 6)
  review_days?: number; // ë³µìŠµì¼ ìˆ˜ (ê¸°ë³¸ê°’: 1)
  review_scope?: "full" | "partial";

  // ì‹œê°„ ì„¤ì • (time_settingsì—ì„œ ë³‘í•©)
  lunch_time?: {
    start: string; // "12:00"
    end: string; // "13:00"
  };
  camp_study_hours?: {
    start: string; // "10:00"
    end: string; // "19:00"
  };
  camp_self_study_hours?: {
    start: string; // "19:00"
    end: string; // "22:00"
  };
  designated_holiday_hours?: {
    start: string; // "13:00"
    end: string; // "19:00"
  };
  use_self_study_with_blocks?: boolean;
  enable_self_study_for_holidays?: boolean;
  enable_self_study_for_study_days?: boolean;
}
```

### `subject_constraints` (JSONB)

êµê³¼ ì œì•½ ì¡°ê±´ì´ ì €ì¥ë©ë‹ˆë‹¤. (1730 Timetable ì „ìš©)

```typescript
{
  required_subjects?: string[]; // í•„ìˆ˜ êµê³¼ ëª©ë¡ (ì˜ˆ: ["êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´"])
  excluded_subjects?: string[]; // ì œì™¸ êµê³¼ ëª©ë¡
  constraint_handling: "strict" | "warning" | "auto_fix"; // ì œì•½ ì¡°ê±´ ì²˜ë¦¬ ë°©ë²•
}
```

### `additional_period_reallocation` (JSONB)

ì¶”ê°€ ê¸°ê°„ ì¬ë°°ì¹˜ ì •ë³´ê°€ ì €ì¥ë©ë‹ˆë‹¤. (1730 Timetable ì „ìš©)

```typescript
{
  period_start: string; // YYYY-MM-DD
  period_end: string; // YYYY-MM-DD
  type: "additional_review"; // ì¶”ê°€ ë³µìŠµ
  original_period_start: string; // ì›ë³¸ í”Œëœ ê¸°ê°„ ì‹œì‘ì¼
  original_period_end: string; // ì›ë³¸ í”Œëœ ê¸°ê°„ ì¢…ë£Œì¼
  subjects?: string[]; // ì¬ë°°ì¹˜í•  ê³¼ëª© ëª©ë¡ (ì—†ìœ¼ë©´ ì „ì²´)
  review_of_review_factor?: number; // ë³µìŠµì˜ ë³µìŠµ ë³´ì • ê³„ìˆ˜ (ê¸°ë³¸ê°’: 0.25)
}
```

### `non_study_time_blocks` (JSONB)

í•™ìŠµ ì‹œê°„ ì œì™¸ í•­ëª©ì´ ì €ì¥ë©ë‹ˆë‹¤. (1730 Timetable ì „ìš©)

```typescript
Array<{
  type: "ì•„ì¹¨ì‹ì‚¬" | "ì ì‹¬ì‹ì‚¬" | "ì €ë…ì‹ì‚¬" | "ìˆ˜ë©´" | "ê¸°íƒ€";
  start_time: string; // HH:mm
  end_time: string; // HH:mm
  day_of_week?: number[]; // ìš”ì¼ ì ìš© ë²”ìœ„ (0-6, ì—†ìœ¼ë©´ ë§¤ì¼)
  description?: string; // ì„¤ëª…
}>;
```

### `daily_schedule` (JSONB)

ì¼ë³„ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì €ì¥ë©ë‹ˆë‹¤. (Step 7ì—ì„œ ìƒì„±)

```typescript
Array<{
  date: string; // YYYY-MM-DD í˜•ì‹
  day_type: "í•™ìŠµì¼" | "ë³µìŠµì¼" | "ì§€ì •íœ´ì¼" | "íœ´ê°€" | "ê°œì¸ì¼ì •";
  study_hours: number; // í•™ìŠµ ê°€ëŠ¥ ì‹œê°„ (ì‹œê°„ ë‹¨ìœ„)
  time_slots?: Array<{
    type: "í•™ìŠµì‹œê°„" | "ì ì‹¬ì‹œê°„" | "í•™ì›ì¼ì •" | "ì´ë™ì‹œê°„" | "ììœ¨í•™ìŠµ";
    start: string; // HH:mm í˜•ì‹
    end: string; // HH:mm í˜•ì‹
    label?: string;
  }>;
  exclusion?: {
    exclusion_date: string;
    exclusion_type: string;
    reason?: string | null;
  } | null;
  academy_schedules?: Array<{
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string;
    subject?: string;
    travel_time?: number; // ì´ë™ì‹œê°„ (ë¶„ ë‹¨ìœ„)
  }>;
}>;
```

## ğŸ”„ ì €ì¥ í”„ë¡œì„¸ìŠ¤

### 1. í”Œëœ ê·¸ë£¹ ìƒì„± (`createPlanGroupAction`)

1. **ê²€ì¦**: `PlanValidator.validateCreation()`ìœ¼ë¡œ ì…ë ¥ê°’ ê²€ì¦
2. **ë°ì´í„° ë³‘í•©**:
   - `time_settings` â†’ `scheduler_options`ì— ë³‘í•©
   - `study_review_cycle` â†’ `scheduler_options`ì— ë³‘í•© (`study_days`, `review_days`)
3. **í”Œëœ ê·¸ë£¹ ìƒì„±**: `plan_groups` í…Œì´ë¸”ì— ì €ì¥
4. **ê´€ë ¨ ë°ì´í„° ìƒì„±**:
   - `plan_contents`: ì½˜í…ì¸  ì •ë³´ ì €ì¥
   - `plan_exclusions`: ì œì™¸ì¼ ì •ë³´ ì €ì¥ (í”Œëœ ê·¸ë£¹ë³„)
   - `academy_schedules`: í•™ì› ì¼ì • ì •ë³´ ì €ì¥ (í•™ìƒë³„ ì „ì—­, ì¤‘ë³µ ì²´í¬ í›„ ìƒì„±)
   - `academies`: í•™ì› ì •ë³´ ì €ì¥ (í•™ìƒë³„ ì „ì—­, ì¤‘ë³µ ì²´í¬ í›„ ìƒì„±)

### 2. ì„ì‹œ ì €ì¥ (`savePlanGroupDraftAction`)

1. **ìµœì†Œ ê²€ì¦**: ì´ë¦„ë§Œ í•„ìˆ˜
2. **ë°ì´í„° ë³‘í•©**: `createPlanGroupAction`ê³¼ ë™ì¼
3. **í”Œëœ ê·¸ë£¹ ìƒì„±**: `status = "draft"`ë¡œ ì €ì¥
4. **ê´€ë ¨ ë°ì´í„° ìƒì„±**: `createPlanGroupAction`ê³¼ ë™ì¼

### 3. í”Œëœ ìƒì„± (`generatePlansFromGroupAction`)

í”Œëœ ê·¸ë£¹ ìƒì„± í›„ Step 7ì—ì„œ í˜¸ì¶œë©ë‹ˆë‹¤.

1. **ìŠ¤ì¼€ì¤„ ê³„ì‚°**: ìŠ¤ì¼€ì¤„ëŸ¬ íƒ€ì…ì— ë”°ë¼ ì¼ë³„ ìŠ¤ì¼€ì¤„ ê³„ì‚°
2. **í”Œëœ ìƒì„±**: `student_plan` í…Œì´ë¸”ì— ê°œë³„ í”Œëœ í•­ëª© ìƒì„±
3. **ì¼ë³„ ìŠ¤ì¼€ì¤„ ì €ì¥**: `daily_schedule` JSONB í•„ë“œì— ì €ì¥

## ğŸ“ ì£¼ì˜ì‚¬í•­

### 1. ë°ì´í„° ë³‘í•© ê·œì¹™

- `time_settings`ëŠ” `scheduler_options`ì— ë³‘í•©ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
- `study_review_cycle`ì€ `scheduler_options`ì— `study_days`, `review_days`ë¡œ ë³‘í•©ë©ë‹ˆë‹¤.
- ì›ë³¸ `time_settings`ì™€ `study_review_cycle` í•„ë“œëŠ” ë³„ë„ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 2. í•™ì› ì¼ì • ê´€ë¦¬

- í•™ì› ì¼ì •ì€ **í•™ìƒë³„ ì „ì—­ ê´€ë¦¬**ì…ë‹ˆë‹¤.
- ê°™ì€ ìš”ì¼, ì‹œê°„ëŒ€ì˜ í•™ì› ì¼ì •ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- í•™ì›ëª…ë³„ë¡œ `academies` í…Œì´ë¸”ì— í•™ì› ì •ë³´ê°€ ì €ì¥ë©ë‹ˆë‹¤.

### 3. ì œì™¸ì¼ ê´€ë¦¬

- ì œì™¸ì¼ì€ **í”Œëœ ê·¸ë£¹ë³„ ê´€ë¦¬**ì…ë‹ˆë‹¤.
- ê°™ì€ ë‚ ì§œì˜ ì œì™¸ì¼ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 4. ì½˜í…ì¸  ì €ì¥

- ì½˜í…ì¸  IDëŠ” **ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥**í•©ë‹ˆë‹¤.
- ë³µì‚¬ëŠ” í”Œëœ ìƒì„± ì‹œì—ë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤.

## ğŸ” ì°¸ê³  íŒŒì¼

- íƒ€ì… ì •ì˜: `lib/types/plan.ts`
- ë°ì´í„° ì•¡ì„¸ìŠ¤: `lib/data/planGroups.ts`
- ì•¡ì…˜: `app/(student)/actions/planGroupActions.ts`
- ìœ„ì €ë“œ: `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`
- ë§ˆì´ê·¸ë ˆì´ì…˜: `supabase/migrations/20250127000000_add_1730_timetable_fields_to_plan_groups.sql`















