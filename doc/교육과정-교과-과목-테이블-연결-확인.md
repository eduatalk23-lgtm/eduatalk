# êµìœ¡ê³¼ì •, êµê³¼, ê³¼ëª©, ê³¼ëª©êµ¬ë¶„ í…Œì´ë¸” ì—°ê²° í™•ì¸

## ğŸ“‹ í…Œì´ë¸” êµ¬ì¡° ë° ê´€ê³„

### 1. curriculum_revisions (ê°œì •êµìœ¡ê³¼ì •)

**í…Œì´ë¸” êµ¬ì¡°:**
```sql
CREATE TABLE curriculum_revisions (
  id uuid PRIMARY KEY,
  name varchar(50) NOT NULL UNIQUE,
  display_order integer NOT NULL DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**ì„¤ëª…:**
- ê°œì •êµìœ¡ê³¼ì •ì„ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸” (ì˜ˆ: 2015ê°œì •, 2022ê°œì •)
- ê° ê°œì •êµìœ¡ê³¼ì •ì€ ê³ ìœ í•œ ì´ë¦„ì„ ê°€ì§
- `display_order`ë¡œ ì •ë ¬ ìˆœì„œ ê´€ë¦¬
- `is_active`ë¡œ í™œì„±í™” ì—¬ë¶€ ê´€ë¦¬

**ì£¼ìš” í•„ë“œ:**
- `id`: ê³ ìœ  ì‹ë³„ì (UUID)
- `name`: ê°œì •êµìœ¡ê³¼ì •ëª… (ì˜ˆ: "2022ê°œì •")
- `display_order`: í‘œì‹œ ìˆœì„œ
- `is_active`: í™œì„±í™” ì—¬ë¶€

---

### 2. subject_groups (êµê³¼)

**í…Œì´ë¸” êµ¬ì¡°:**
```sql
CREATE TABLE subject_groups (
  id uuid PRIMARY KEY,
  curriculum_revision_id uuid NOT NULL REFERENCES curriculum_revisions(id) ON DELETE RESTRICT,
  name varchar(50) NOT NULL,
  display_order integer NOT NULL DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(curriculum_revision_id, name)
);
```

**ì„¤ëª…:**
- êµê³¼ ê·¸ë£¹ì„ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸” (ì˜ˆ: êµ­ì–´, ìˆ˜í•™, ì˜ì–´, ì‚¬íšŒ, ê³¼í•™)
- **ì „ì—­ ê´€ë¦¬**: `tenant_id` ì œê±°ë¨ (2025-02-04 ë§ˆì´ê·¸ë ˆì´ì…˜)
- ê°œì •êµìœ¡ê³¼ì •ë³„ë¡œ ê´€ë¦¬ë¨ (`curriculum_revision_id`)

**ì£¼ìš” í•„ë“œ:**
- `id`: ê³ ìœ  ì‹ë³„ì (UUID)
- `curriculum_revision_id`: ê°œì •êµìœ¡ê³¼ì • ID (FK â†’ `curriculum_revisions`)
- `name`: êµê³¼ ê·¸ë£¹ëª… (ì˜ˆ: "êµ­ì–´", "ìˆ˜í•™", "ì˜ì–´")
- `display_order`: í‘œì‹œ ìˆœì„œ

**ì œì•½ì¡°ê±´:**
- `UNIQUE(curriculum_revision_id, name)`: ê°™ì€ ê°œì •êµìœ¡ê³¼ì • ë‚´ì—ì„œ êµê³¼ ê·¸ë£¹ëª…ì€ ê³ ìœ í•´ì•¼ í•¨

---

### 3. subjects (ê³¼ëª©)

**í…Œì´ë¸” êµ¬ì¡°:**
```sql
CREATE TABLE subjects (
  id uuid PRIMARY KEY,
  subject_group_id uuid NOT NULL REFERENCES subject_groups(id) ON DELETE RESTRICT,
  name varchar(50) NOT NULL,
  display_order integer NOT NULL DEFAULT 0,
  subject_type text, -- ê³¼ëª©ë³„ ê³¼ëª© ìœ í˜• (nullì´ë©´ êµê³¼ ê·¸ë£¹ì˜ default_subject_type ì‚¬ìš©)
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(subject_group_id, name)
);
```

**ì„¤ëª…:**
- ê³¼ëª©ì„ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸” (ì˜ˆ: ìˆ˜í•™â… , ìˆ˜í•™â…¡, ë¯¸ì ë¶„, í™•ë¥ ê³¼ í†µê³„)
- **ì „ì—­ ê´€ë¦¬**: `tenant_id` ì œê±°ë¨ (2025-02-04 ë§ˆì´ê·¸ë ˆì´ì…˜)
- êµê³¼ ê·¸ë£¹ë³„ë¡œ ê´€ë¦¬ë¨ (`subject_group_id`)
- ê³¼ëª©ë³„ ê³¼ëª© ìœ í˜•(`subject_type`)ì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ

**ì£¼ìš” í•„ë“œ:**
- `id`: ê³ ìœ  ì‹ë³„ì (UUID)
- `subject_group_id`: êµê³¼ ê·¸ë£¹ ID (FK â†’ `subject_groups`)
- `name`: ê³¼ëª©ëª… (ì˜ˆ: "ìˆ˜í•™â… ", "ìˆ˜í•™â…¡", "ë¯¸ì ë¶„")
- `display_order`: í‘œì‹œ ìˆœì„œ
- `subject_type`: ê³¼ëª©ë³„ ê³¼ëª© ìœ í˜• (nullable)
  - ê°’: `'ê³µí†µ'`, `'ì¼ë°˜ì„ íƒ'`, `'ì§„ë¡œì„ íƒ'` ë“±

**ì œì•½ì¡°ê±´:**
- `UNIQUE(subject_group_id, name)`: ê°™ì€ êµê³¼ ê·¸ë£¹ ë‚´ì—ì„œ ê³¼ëª©ëª…ì€ ê³ ìœ í•´ì•¼ í•¨

---

### 4. ê³¼ëª©êµ¬ë¶„ (subject_type)

**ì„¤ëª…:**
- ê³¼ëª©ì˜ ìœ í˜•ì„ ë‚˜íƒ€ë‚´ëŠ” í•„ë“œ
- `subjects.subject_type` í•„ë“œì—ì„œ ê´€ë¦¬ë¨

**ê°€ëŠ¥í•œ ê°’:**
- `'ê³µí†µ'`: ê³µí†µ ê³¼ëª©
- `'ì¼ë°˜ì„ íƒ'`: ì¼ë°˜ì„ íƒ ê³¼ëª©
- `'ì§„ë¡œì„ íƒ'`: ì§„ë¡œì„ íƒ ê³¼ëª©
- ê¸°íƒ€ êµìœ¡ê³¼ì •ì— ë”°ë¥¸ ê³¼ëª© ìœ í˜•
- `null`: ê³¼ëª© ìœ í˜•ì´ ì§€ì •ë˜ì§€ ì•ŠìŒ

**ì˜ˆì‹œ:**
```sql
-- ê³¼ëª©: ìˆ˜í•™â…  (ê³¼ëª© ìœ í˜•: ê³µí†µ)
INSERT INTO subjects (subject_group_id, name, subject_type)
VALUES ('...', 'ìˆ˜í•™â… ', 'ê³µí†µ');

-- ê³¼ëª©: ë¯¸ì ë¶„ (ê³¼ëª© ìœ í˜•: ì¼ë°˜ì„ íƒ)
INSERT INTO subjects (subject_group_id, name, subject_type)
VALUES ('...', 'ë¯¸ì ë¶„', 'ì¼ë°˜ì„ íƒ');

-- ê³¼ëª©: í™•ë¥ ê³¼ í†µê³„ (ê³¼ëª© ìœ í˜•: ì§€ì • ì•ˆ í•¨)
INSERT INTO subjects (subject_group_id, name, subject_type)
VALUES ('...', 'í™•ë¥ ê³¼ í†µê³„', NULL);
```

---

## ğŸ”— í…Œì´ë¸” ê´€ê³„ë„

```
curriculum_revisions (ê°œì •êµìœ¡ê³¼ì •)
  â”‚
  â”œâ”€ id (PK)
  â”‚
  â””â”€â–¶ subject_groups (êµê³¼)
        â”‚
        â”œâ”€ id (PK)
        â”œâ”€ curriculum_revision_id (FK â†’ curriculum_revisions)
        â”œâ”€ name
        â”‚
        â””â”€â–¶ subjects (ê³¼ëª©)
              â”‚
              â”œâ”€ id (PK)
              â”œâ”€ subject_group_id (FK â†’ subject_groups)
              â”œâ”€ name
              â””â”€ subject_type (ê³¼ëª©ë³„ ê³¼ëª© ìœ í˜•)
```

---

## ğŸ“Š ë°ì´í„° íë¦„

### 1. ê°œì •êµìœ¡ê³¼ì • â†’ êµê³¼ ê·¸ë£¹
```
curriculum_revisions (2022ê°œì •)
  â””â”€â–¶ subject_groups (êµ­ì–´, ìˆ˜í•™, ì˜ì–´, ...)
```

### 2. êµê³¼ ê·¸ë£¹ â†’ ê³¼ëª©
```
subject_groups (ìˆ˜í•™)
  â””â”€â–¶ subjects (ìˆ˜í•™â… , ìˆ˜í•™â…¡, ë¯¸ì ë¶„, í™•ë¥ ê³¼ í†µê³„, ...)
```

### 3. ê³¼ëª©êµ¬ë¶„ ê´€ë¦¬
```
subjects.subject_type
  â”œâ”€ ê°’ì´ ìˆìŒ â†’ í•´ë‹¹ ê°’ ì‚¬ìš©
  â””â”€ null â†’ ê³¼ëª© ìœ í˜• ì—†ìŒ
```

---

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë ¥

### 2025-02-05: default_subject_type ì œê±°
- `subject_groups` í…Œì´ë¸”ì—ì„œ `default_subject_type` ì»¬ëŸ¼ ì œê±°
- ê³¼ëª©êµ¬ë¶„ì€ `subjects.subject_type`ì—ì„œë§Œ ê´€ë¦¬

### 2025-02-04: ì „ì—­ ê´€ë¦¬ë¡œ ë³€ê²½
- `subject_groups`ì™€ `subjects` í…Œì´ë¸”ì—ì„œ `tenant_id` ì œê±°
- `subject_groups`ì— `curriculum_revision_id` ì¶”ê°€
- ì „ì—­ ë°ì´í„°ë¡œ í†µí•© ê´€ë¦¬

### 2025-02-04: subject_categories ì œê±°
- `subject_categories` í…Œì´ë¸” deprecated
- `subject_groups`ë¡œ ëŒ€ì²´ë¨

---

## ğŸ“ ì£¼ìš” ì¿¼ë¦¬ ì˜ˆì‹œ

### 1. ê°œì •êµìœ¡ê³¼ì •ë³„ êµê³¼ ê·¸ë£¹ ì¡°íšŒ
```sql
SELECT sg.*, cr.name as curriculum_name
FROM subject_groups sg
JOIN curriculum_revisions cr ON sg.curriculum_revision_id = cr.id
WHERE cr.name = '2022ê°œì •'
ORDER BY sg.display_order, sg.name;
```

### 2. êµê³¼ ê·¸ë£¹ë³„ ê³¼ëª© ì¡°íšŒ (ê³¼ëª©êµ¬ë¶„ í¬í•¨)
```sql
SELECT 
  s.*,
  sg.name as subject_group_name,
  s.subject_type
FROM subjects s
JOIN subject_groups sg ON s.subject_group_id = sg.id
WHERE sg.id = '...'
ORDER BY s.display_order, s.name;
```

### 3. ì „ì²´ ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ
```sql
SELECT 
  cr.name as curriculum_name,
  sg.name as subject_group_name,
  s.name as subject_name,
  s.subject_type
FROM curriculum_revisions cr
JOIN subject_groups sg ON sg.curriculum_revision_id = cr.id
LEFT JOIN subjects s ON s.subject_group_id = sg.id
WHERE cr.is_active = true
ORDER BY cr.display_order, sg.display_order, s.display_order;
```

---

## âœ… í™•ì¸ ì‚¬í•­

### í˜„ì¬ êµ¬ì¡° í™•ì¸
- âœ… `curriculum_revisions` í…Œì´ë¸” ì¡´ì¬
- âœ… `subject_groups` í…Œì´ë¸”ì´ `curriculum_revision_id`ë¡œ ì—°ê²°ë¨
- âœ… `subjects` í…Œì´ë¸”ì´ `subject_group_id`ë¡œ ì—°ê²°ë¨
- âœ… `subject_type` í•„ë“œê°€ `subjects` í…Œì´ë¸”ì— ì¡´ì¬
- âœ… `subject_categories` í…Œì´ë¸”ì€ ì œê±°ë¨ (deprecated)
- âœ… `default_subject_type` í•„ë“œëŠ” ì œê±°ë¨ (2025-02-05 ë§ˆì´ê·¸ë ˆì´ì…˜)

### ê´€ê³„ ë¬´ê²°ì„±
- âœ… `subject_groups.curriculum_revision_id` â†’ `curriculum_revisions.id` (FK)
- âœ… `subjects.subject_group_id` â†’ `subject_groups.id` (FK)
- âœ… UNIQUE ì œì•½ì¡°ê±´: `(curriculum_revision_id, name)` on `subject_groups`
- âœ… UNIQUE ì œì•½ì¡°ê±´: `(subject_group_id, name)` on `subjects`

---

## ğŸ“š ê´€ë ¨ íŒŒì¼

- **íƒ€ì… ì •ì˜**: `lib/data/subjects.ts`
- **ì•¡ì…˜ í•¨ìˆ˜**: `app/(admin)/actions/subjectActions.ts`
- **ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼**:
  - `supabase/migrations/20250204000000_make_subject_groups_global.sql`
  - `supabase/migrations/20250204000001_migrate_subject_data_to_global.sql`
  - `supabase/migrations/20250204000002_deprecate_subject_categories.sql`
  - `supabase/migrations/20250205000000_remove_default_subject_type.sql`

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-02-05

