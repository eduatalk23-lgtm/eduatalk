# 학습 시간 계산 통일 개선 가이드

## 📋 문제 상황

학습 관리(Today 페이지)에서 표시되는 총 학습 시간(일시정지 제외)과 대시보드의 학습 시간이 일치하지 않는 문제가 있었습니다.

## 🔍 원인 분석

### Today 페이지 계산 방식 (`lib/metrics/todayProgress.ts`)

1. **세션 조회**: `getSessionsInRange`로 해당 날짜의 세션 조회
2. **활성 세션 맵 생성**: `buildActiveSessionMap`으로 활성 세션 맵 생성
3. **학습 시간 계산**: `calculatePlanStudySeconds` 함수 사용
   - `actual_start_time`이 있으면 계산
   - `total_duration_seconds`가 있고 `actual_end_time`이 있으면 그것을 사용
   - 그렇지 않으면 타임스탬프 차이 계산
   - `paused_duration_seconds`를 빼고, 현재 일시정지 중이면 추가로 빼기

### 대시보드 계산 방식 (기존 `app/(student)/dashboard/page.tsx`)

1. **단순 계산**: `summarizeTodayPlans` 함수에서 계산
   - `total_duration_seconds`가 있는 경우만 합산
   - `paused_duration_seconds`를 빼기
   - **문제점**: 
     - `total_duration_seconds`가 없는 진행 중인 플랜은 계산되지 않음
     - 현재 일시정지 중인 경우를 고려하지 않음
     - 타임스탬프 기반 계산을 하지 않음

## ✅ 개선 사항

### 1. 공통 학습 시간 계산 함수 생성

`lib/metrics/studyTime.ts` 파일을 생성하여 공통 함수를 제공:

- `calculatePlanStudySeconds`: 플랜의 학습 시간 계산 (초 단위)
  - 타임스탬프 기반 계산
  - 현재 일시정지 중인 경우 고려
  - 완료된 플랜과 진행 중인 플랜 모두 처리

- `buildActiveSessionMap`: 활성 세션 맵 생성
  - plan_id를 키로 하는 활성 세션 맵 생성
  - 가장 최근 세션을 사용

### 2. Today 페이지 리팩토링

`lib/metrics/todayProgress.ts`에서 공통 함수를 사용하도록 수정:

```typescript
import {
  calculatePlanStudySeconds,
  buildActiveSessionMap,
} from "@/lib/metrics/studyTime";
```

### 3. 대시보드 계산 로직 통일

`app/(student)/dashboard/page.tsx`의 `summarizeTodayPlans` 함수를 수정:

**변경 전**:
- `total_duration_seconds`가 있는 경우만 계산
- 단순히 `total_duration_seconds - paused_duration_seconds` 계산

**변경 후**:
- 세션 조회 및 활성 세션 맵 생성
- `actual_start_time`이 있는 모든 플랜 계산
- `calculatePlanStudySeconds` 공통 함수 사용
- 현재 일시정지 중인 경우 고려

## 📊 계산 로직 상세

### `calculatePlanStudySeconds` 함수

```typescript
export function calculatePlanStudySeconds(
  plan: {
    actual_start_time: string | null | undefined;
    actual_end_time: string | null | undefined;
    total_duration_seconds: number | null | undefined;
    paused_duration_seconds: number | null | undefined;
  },
  nowMs: number,
  activeSession?: StudySession | null
): number
```

**계산 순서**:

1. `actual_start_time`이 없으면 0 반환
2. 시작/종료 시간 유효성 검사
3. 경과 시간 계산:
   - 완료된 플랜: `total_duration_seconds` 사용 (있는 경우)
   - 진행 중인 플랜: 타임스탬프 차이 계산
4. 일시정지 시간 계산:
   - `paused_duration_seconds` 사용
   - 현재 일시정지 중이면 추가 계산
5. 순수 학습 시간 반환: `Math.max(0, elapsedSeconds - pausedSeconds)`

## 🧪 테스트 시나리오

### 시나리오 1: 완료된 플랜
- 플랜 시작 → 학습 → 완료
- `total_duration_seconds`와 `paused_duration_seconds`가 저장됨
- **기대 결과**: Today 페이지와 대시보드 모두 동일한 시간 표시

### 시나리오 2: 진행 중인 플랜
- 플랜 시작 → 학습 중 (아직 완료하지 않음)
- `total_duration_seconds`가 없을 수 있음
- **기대 결과**: 타임스탬프 기반으로 실시간 계산, 두 페이지 동일

### 시나리오 3: 일시정지 중인 플랜
- 플랜 시작 → 학습 → 일시정지 → 재시작 안 함
- `paused_at`이 있고 `resumed_at`이 없음
- **기대 결과**: 현재 일시정지 시간까지 제외하여 계산, 두 페이지 동일

### 시나리오 4: 여러 플랜 혼합
- 완료된 플랜 + 진행 중인 플랜 + 일시정지 중인 플랜
- **기대 결과**: 모든 플랜의 학습 시간 합계가 두 페이지에서 동일

## 📝 체크리스트

- [x] 학습 시간 계산 로직 차이점 분석 (Today vs Dashboard)
- [x] 대시보드 계산 로직을 Today와 동일하게 통일 (타임스탬프 기반 + 현재 일시정지 고려)
- [x] 공통 학습 시간 계산 함수 생성 및 적용
- [ ] 테스트 및 검증

## 🔄 다음 단계

1. **테스트 실행**: 위 시나리오들을 실제로 테스트하여 두 페이지의 시간이 일치하는지 확인
2. **에러 처리**: 예외 상황 처리 확인 (null 값, 잘못된 타임스탬프 등)
3. **성능 최적화**: 세션 조회 최적화 (필요한 경우)

## 📚 관련 파일

- `lib/metrics/studyTime.ts`: 공통 학습 시간 계산 함수
- `lib/metrics/todayProgress.ts`: Today 페이지 진행률 계산
- `app/(student)/dashboard/page.tsx`: 대시보드 페이지
- `app/(student)/today/page.tsx`: Today 페이지









