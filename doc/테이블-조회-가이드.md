# êµìœ¡ê³¼ì •-êµê³¼-ê³¼ëª©-ê³¼ëª©êµ¬ë¶„ í…Œì´ë¸” ì¡°íšŒ ê°€ì´ë“œ

## ğŸ“‹ ìœ„ê³„ êµ¬ì¡°

```
ê°œì •êµìœ¡ê³¼ì • (curriculum_revisions)
  â”œâ”€â–¶ êµê³¼ (subject_groups)
  â”‚     â””â”€â–¶ ê³¼ëª© (subjects)
  â”‚           â””â”€â–¶ ê³¼ëª©êµ¬ë¶„ (subject_types) via subject_type_id
  â”‚
  â””â”€â–¶ ê³¼ëª©êµ¬ë¶„ (subject_types) - ê°œì •êµìœ¡ê³¼ì •ë³„ ê´€ë¦¬
```

## ğŸ” ì¡°íšŒ ë°©ë²•

### 1. ê°œë³„ ì¡°íšŒ (ë‹¨ê³„ë³„)

```typescript
import {
  getSubjectGroups,
  getSubjectsByGroup,
  getSubjectTypes,
} from "@/lib/data/subjects";

// 1. êµê³¼ ì¡°íšŒ
const groups = await getSubjectGroups(curriculumRevisionId);

// 2. ê° êµê³¼ì˜ ê³¼ëª© ì¡°íšŒ
const subjects = await getSubjectsByGroup(groupId);

// 3. ê³¼ëª©êµ¬ë¶„ ì¡°íšŒ
const subjectTypes = await getSubjectTypes(curriculumRevisionId);
```

**ì¥ì :** í•„ìš”í•œ ë°ì´í„°ë§Œ ì„ íƒì ìœ¼ë¡œ ì¡°íšŒ ê°€ëŠ¥  
**ë‹¨ì :** ì—¬ëŸ¬ ë²ˆì˜ ì¿¼ë¦¬ í•„ìš”

---

### 2. ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ (ê¶Œì¥)

```typescript
import { getSubjectGroupsWithSubjects } from "@/lib/data/subjects";

// êµê³¼ + ê³¼ëª© (ê³¼ëª©êµ¬ë¶„ í¬í•¨)
const groupsWithSubjects = await getSubjectGroupsWithSubjects(
  curriculumRevisionId
);

// ê²°ê³¼ êµ¬ì¡°:
// [
//   {
//     id: "group-id",
//     name: "ìˆ˜í•™",
//     subjects: [
//       {
//         id: "subject-id",
//         name: "ìˆ˜í•™â… ",
//         subject_type_id: "type-id",
//         subject_type: "ê³µí†µ" // JOIN ê²°ê³¼
//       }
//     ]
//   }
// ]
```

**ì¥ì :** êµê³¼ì™€ ê³¼ëª©ì„ í•œ ë²ˆì— ì¡°íšŒ, ê³¼ëª©êµ¬ë¶„ ì •ë³´ í¬í•¨  
**ë‹¨ì :** ê³¼ëª©êµ¬ë¶„ ëª©ë¡ì€ ë³„ë„ ì¡°íšŒ í•„ìš”

---

### 3. ì „ì²´ ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ (ì™„ì „í•œ êµ¬ì¡°)

```typescript
import { getFullSubjectHierarchy } from "@/lib/data/subjects";

// ê°œì •êµìœ¡ê³¼ì • + êµê³¼ + ê³¼ëª© + ê³¼ëª©êµ¬ë¶„ ì „ì²´
const hierarchy = await getFullSubjectHierarchy(curriculumRevisionId);

// ê²°ê³¼ êµ¬ì¡°:
// {
//   curriculumRevision: {
//     id: "revision-id",
//     name: "2022ê°œì •êµìœ¡ê³¼ì •",
//     year: 2022
//   },
//   subjectGroups: [
//     {
//       id: "group-id",
//       name: "ìˆ˜í•™",
//       subjects: [
//         {
//           id: "subject-id",
//           name: "ìˆ˜í•™â… ",
//           subject_type_id: "type-id",
//           subjectType: {
//             id: "type-id",
//             name: "ê³µí†µ"
//           }
//         }
//       ]
//     }
//   ],
//   subjectTypes: [
//     { id: "type-id", name: "ê³µí†µ" },
//     { id: "type-id", name: "ì¼ë°˜ì„ íƒ" },
//     { id: "type-id", name: "ì§„ë¡œì„ íƒ" }
//   ]
// }
```

**ì¥ì :** ëª¨ë“  ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì¡°íšŒ, ì™„ì „í•œ ê³„ì¸µ êµ¬ì¡°  
**ë‹¨ì :** ë°ì´í„°ê°€ ë§ì„ ê²½ìš° ì„±ëŠ¥ ì´ìŠˆ ê°€ëŠ¥

---

### 4. Supabase ì§ì ‘ JOIN ì¿¼ë¦¬ (ìµœì í™”)

```typescript
import { createSupabaseServerClient } from "@/lib/supabase/server";

const supabase = await createSupabaseServerClient();

// í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì „ì²´ ì¡°íšŒ
const { data, error } = await supabase
  .from("subject_groups")
  .select(
    `
    *,
    curriculum_revisions:curriculum_revision_id (
      id,
      name,
      year
    ),
    subjects:subjects (
      *,
      subject_types:subject_type_id (
        id,
        name
      )
    )
  `
  )
  .eq("curriculum_revision_id", curriculumRevisionId)
  .order("display_order", { ascending: true });

// ê²°ê³¼ êµ¬ì¡°:
// [
//   {
//     id: "group-id",
//     name: "ìˆ˜í•™",
//     curriculum_revisions: {
//       id: "revision-id",
//       name: "2022ê°œì •êµìœ¡ê³¼ì •",
//       year: 2022
//     },
//     subjects: [
//       {
//         id: "subject-id",
//         name: "ìˆ˜í•™â… ",
//         subject_type_id: "type-id",
//         subject_types: {
//           id: "type-id",
//           name: "ê³µí†µ"
//         }
//       }
//     ]
//   }
// ]
```

**ì¥ì :** ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ëª¨ë“  ë°ì´í„° ì¡°íšŒ, ê°€ì¥ íš¨ìœ¨ì   
**ë‹¨ì :** ê²°ê³¼ êµ¬ì¡°ê°€ ë³µì¡í•¨

---

## ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ë³„ ê¶Œì¥ ë°©ë²•

### ì‹œë‚˜ë¦¬ì˜¤ 1: êµê³¼ ëª©ë¡ë§Œ í•„ìš”í•  ë•Œ

```typescript
const groups = await getSubjectGroups(curriculumRevisionId);
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: êµê³¼ + ê³¼ëª© ëª©ë¡ í•„ìš”í•  ë•Œ (ê°€ì¥ ì¼ë°˜ì )

```typescript
const groupsWithSubjects = await getSubjectGroupsWithSubjects(
  curriculumRevisionId
);
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì „ì²´ êµ¬ì¡° + ê³¼ëª©êµ¬ë¶„ ëª©ë¡ í•„ìš”í•  ë•Œ

```typescript
const hierarchy = await getFullSubjectHierarchy(curriculumRevisionId);
```

### ì‹œë‚˜ë¦¬ì˜¤ 4: ì„±ëŠ¥ ìµœì í™”ê°€ ì¤‘ìš”í•  ë•Œ

```typescript
// Supabase ì§ì ‘ JOIN ì¿¼ë¦¬ ì‚¬ìš©
const { data } = await supabase
  .from("subject_groups")
  .select(
    `
    *,
    subjects:subjects (
      *,
      subject_types:subject_type_id (id, name)
    )
  `
  )
  .eq("curriculum_revision_id", curriculumRevisionId);
```

---

## ğŸ“ í•¨ìˆ˜ ë„¤ì´ë° ê·œì¹™

í˜„ì¬ í•¨ìˆ˜ë“¤ì˜ ë„¤ì´ë° íŒ¨í„´:

- `getSubjectGroups()` - êµê³¼ ëª©ë¡ ì¡°íšŒ
- `getSubjectsByGroup()` - íŠ¹ì • êµê³¼ì˜ ê³¼ëª© ëª©ë¡ ì¡°íšŒ
- `getSubjectTypes()` - ê³¼ëª©êµ¬ë¶„ ëª©ë¡ ì¡°íšŒ
- `getSubjectGroupsWithSubjects()` - êµê³¼ + ê³¼ëª© (ê³„ì¸µ êµ¬ì¡°)
- `getFullSubjectHierarchy()` - ì „ì²´ ê³„ì¸µ êµ¬ì¡° (ê°œì •êµìœ¡ê³¼ì • + êµê³¼ + ê³¼ëª© + ê³¼ëª©êµ¬ë¶„)

**ë„¤ì´ë° íŒ¨í„´:**

- `get[Entity]()` - ë‹¨ì¼ ì—”í‹°í‹° ëª©ë¡
- `get[Entity]By[Parent]()` - ë¶€ëª¨ ê¸°ì¤€ ì¡°íšŒ
- `get[Entity]With[Related]()` - ê´€ë ¨ ì—”í‹°í‹° í¬í•¨
- `getFull[Hierarchy]()` - ì „ì²´ ê³„ì¸µ êµ¬ì¡°

---

## ğŸ”§ ê°œì„  ì œì•ˆ

### ë” íš¨ìœ¨ì ì¸ ë‹¨ì¼ ì¿¼ë¦¬ í•¨ìˆ˜ ì¶”ê°€

```typescript
/**
 * ê°œì •êµìœ¡ê³¼ì •ë³„ ì „ì²´ êµ¬ì¡°ë¥¼ ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ì¡°íšŒ (ìµœì í™”)
 */
export async function getSubjectHierarchyOptimized(
  curriculumRevisionId: string
): Promise<{
  curriculumRevision: CurriculumRevision;
  subjectGroups: (SubjectGroup & {
    subjects: (Subject & { subjectType: SubjectType | null })[];
  })[];
  subjectTypes: SubjectType[];
}> {
  const supabase = await createSupabaseServerClient();

  // 1. ê°œì •êµìœ¡ê³¼ì • ì¡°íšŒ
  const { data: revision } = await supabase
    .from("curriculum_revisions")
    .select("*")
    .eq("id", curriculumRevisionId)
    .single();

  // 2. êµê³¼ + ê³¼ëª© + ê³¼ëª©êµ¬ë¶„ í•œ ë²ˆì— ì¡°íšŒ
  const { data: groups } = await supabase
    .from("subject_groups")
    .select(
      `
      *,
      subjects:subjects (
        *,
        subject_types:subject_type_id (
          id,
          name,
          display_order
        )
      )
    `
    )
    .eq("curriculum_revision_id", curriculumRevisionId)
    .order("display_order", { ascending: true });

  // 3. ê³¼ëª©êµ¬ë¶„ ëª©ë¡ ì¡°íšŒ
  const { data: subjectTypes } = await supabase
    .from("subject_types")
    .select("*")
    .eq("curriculum_revision_id", curriculumRevisionId)
    .eq("is_active", true)
    .order("display_order", { ascending: true });

  // ë°ì´í„° ë³€í™˜
  const groupsWithSubjects = (groups || []).map((group: any) => ({
    ...group,
    subjects: (group.subjects || []).map((subject: any) => ({
      ...subject,
      subject_type: subject.subject_types?.name || null,
      subjectType: subject.subject_types || null,
    })),
  }));

  return {
    curriculumRevision: revision as CurriculumRevision,
    subjectGroups: groupsWithSubjects,
    subjectTypes: (subjectTypes || []) as SubjectType[],
  };
}
```

---

## âœ… ê¶Œì¥ ì‚¬ìš©ë²•

**ëŒ€ë¶€ë¶„ì˜ ê²½ìš°:**

```typescript
// êµê³¼ + ê³¼ëª© (ê³¼ëª©êµ¬ë¶„ í¬í•¨)
const groupsWithSubjects = await getSubjectGroupsWithSubjects(
  curriculumRevisionId
);
```

**ì „ì²´ êµ¬ì¡°ê°€ í•„ìš”í•  ë•Œ:**

```typescript
// ê°œì •êµìœ¡ê³¼ì • + êµê³¼ + ê³¼ëª© + ê³¼ëª©êµ¬ë¶„
const hierarchy = await getFullSubjectHierarchy(curriculumRevisionId);
```

**ì„±ëŠ¥ì´ ì¤‘ìš”í•  ë•Œ:**

```typescript
// ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ìµœì í™”
const hierarchy = await getSubjectHierarchyOptimized(curriculumRevisionId);
```
