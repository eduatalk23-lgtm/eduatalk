# 타이머 로그 배치 처리 방식 분석

## 📋 개요

타이머 로그를 실시간 저장에서 배치 처리로 변경할 때 발생할 수 있는 문제점과 해결 방안을 정리합니다.

## ⚠️ 배치 처리 시 문제점

### 1. UI 실시간 표시 문제

**현재 상황:**
- `TimeCheckSection` 컴포넌트에서 서버의 로그를 조회하여 실시간으로 표시
- 시작/일시정지/재개/완료 시간을 즉시 화면에 표시

**배치 처리 시 문제:**
- 로컬에만 저장되면 서버 조회 시 최신 로그가 없음
- 사용자가 방금 일시정지한 시간이 화면에 표시되지 않음
- 다른 탭에서 열었을 때 최신 로그를 볼 수 없음

**영향도:** 🔴 높음

### 2. 다중 탭/기기 동기화 문제

**문제:**
- 여러 브라우저 탭에서 동시에 사용할 때
- 모바일/PC에서 동시에 사용할 때
- 로컬 저장소는 기기별로 독립적이므로 동기화 불가

**시나리오:**
1. PC에서 플랜 시작 → 로컬에 저장
2. 모바일에서 일시정지 → 로컬에 저장
3. PC에서 로그 조회 → 모바일의 일시정지 로그가 안 보임

**영향도:** 🟡 중간

### 3. 데이터 손실 위험

**위험 상황:**
- 브라우저 강제 종료
- 시스템 크래시
- 로컬 스토리지 용량 초과
- 사용자가 브라우저 데이터 삭제
- 시크릿 모드 사용

**영향도:** 🔴 높음 (데이터 영구 손실)

### 4. 로그 조회 지연

**문제:**
- 다른 화면에서 로그를 조회할 때
- 분석/리포트 기능에서 로그 사용 시
- 최신 로그가 서버에 없어서 불완전한 데이터

**영향도:** 🟡 중간

## ✅ 해결 방안: 하이브리드 방식

### 전략

**즉시 저장 (Critical Events):**
- `start`: 플랜 시작 - 즉시 저장
- `complete`: 플랜 완료 - 즉시 저장

**배치 저장 (Non-Critical Events):**
- `pause`: 일시정지 - 로컬 저장 후 배치
- `resume`: 재개 - 로컬 저장 후 배치

### 구현 계획

#### 1. 로컬 스토리지 관리

```typescript
// 로컬에 저장할 구조
interface PendingTimerLog {
  planId: string;
  eventType: "pause" | "resume";
  timestamp: string;
  durationSeconds?: number;
  synced: boolean; // 동기화 여부
}
```

#### 2. UI 표시 로직 개선

```typescript
// 서버 로그 + 로컬 로그 병합
const allLogs = [...serverLogs, ...localLogs].sort(
  (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
);
```

#### 3. 자동 동기화

- **주기적 동기화**: 30초마다 자동 전송
- **페이지 이탈 시**: `beforeunload` 이벤트로 저장
- **완료 시**: 반드시 동기화
- **수동 동기화**: 버튼으로 즉시 동기화 가능

#### 4. 데이터 손실 방지

- **IndexedDB 사용**: localStorage보다 안정적
- **중복 저장**: 로컬 + 서버 모두 저장
- **재시도 로직**: 실패 시 자동 재시도

## 📊 비교표

| 항목 | 현재 (실시간) | 완전 배치 | 하이브리드 |
|------|-------------|----------|-----------|
| 서버 부하 | 높음 (4회 호출) | 낮음 (1회 호출) | 중간 (2-3회 호출) |
| UI 실시간성 | ✅ 즉시 표시 | ❌ 지연 표시 | ✅ 즉시 표시 |
| 데이터 손실 위험 | 낮음 | 높음 | 낮음 |
| 다중 기기 동기화 | ✅ 가능 | ❌ 불가능 | ✅ 가능 |
| 네트워크 효율 | 낮음 | 높음 | 중간 |
| 구현 복잡도 | 낮음 | 중간 | 높음 |

## 🎯 권장 방안

**하이브리드 방식 추천**

이유:
1. ✅ 중요 이벤트는 즉시 저장하여 데이터 손실 방지
2. ✅ UI 실시간성 유지
3. ✅ 서버 부하 50% 감소 (4회 → 2-3회)
4. ✅ 부가 이벤트는 배치로 효율성 향상

## 📝 구현 시 주의사항

1. **로컬 스토리지 용량 관리**
   - 오래된 로그는 정기적으로 삭제
   - 동기화 완료된 로그는 즉시 삭제

2. **에러 처리**
   - 동기화 실패 시 재시도 로직
   - 사용자에게 알림 표시

3. **성능 최적화**
   - 배치 전송 시 한 번에 여러 로그 전송
   - 인덱싱으로 빠른 조회

4. **테스트 시나리오**
   - 오프라인 상태에서 동작 확인
   - 다중 탭 동시 사용 테스트
   - 브라우저 종료 후 복구 테스트

