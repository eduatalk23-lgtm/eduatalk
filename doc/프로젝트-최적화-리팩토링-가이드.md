# 프로젝트 최적화 및 리팩토링 가이드

> 프로젝트의 최적화, 리팩토링, 서비스 정리 계획을 통합한 종합 가이드 문서입니다.

**작성일**: 2025-01-31  
**버전**: 1.0

---

## 📋 목차

1. [리팩토링 완료 내역](#리팩토링-완료-내역)
2. [서비스 정리 및 최적화 계획](#서비스-정리-및-최적화-계획)
3. [Step7 개선 작업](#step7-개선-작업)
4. [플랜 캘린더 UI 개선](#플랜-캘린더-ui-개선)

---

## 리팩토링 완료 내역

**작업 일자**: 2025-01-30  
**작업 범위**: 사용되지 않는 페이지 및 데이터베이스 테이블 삭제

### 사용되지 않는 페이지/폴더 삭제

#### ✅ 삭제 완료

1. **`app/post-login/`**
   - 상태: 비어있는 폴더
   - 참조: 코드베이스에서 참조 없음
   - 조치: 삭제 완료

2. **`app/(superadmin)/`**
   - 상태: 라우트 그룹이지만 실제로는 사용되지 않음
   - 실제 사용: `/admin/superadmin/tenants`로 접근 (admin 라우트 그룹 내부)
   - 조치: 삭제 완료
   - 참고: superadmin 기능은 `app/(admin)/admin/superadmin/tenants/`에서 관리됨

3. **`app/dashboard/`**
   - 상태: 폴더는 존재하지만 `page.tsx` 없음
   - 실제 사용: `app/(student)/dashboard/page.tsx` 사용
   - 조치: 삭제 완료

### 데이터베이스 테이블 삭제 마이그레이션

#### ✅ 생성 완료

#### 1. `content_masters` 테이블 삭제
- **파일**: `supabase/migrations/20250130000000_remove_content_masters_table.sql`
- **이유**: `master_books`와 `master_lectures`로 분리되어 더 이상 사용되지 않음
- **마이그레이션 순서**:
  1. `20250116000000_separate_content_masters.sql` (데이터 분리)
  2. `20250130000000_remove_content_masters_table.sql` (테이블 삭제)
- **삭제 대상**:
  - `content_masters` 테이블
  - `content_master_details` 테이블 (종속 테이블)

#### 2. `plan_timer_logs` 테이블 삭제
- **파일**: `supabase/migrations/20250130000001_remove_plan_timer_logs_table.sql`
- **이유**: deprecated되었으며, `student_plan`과 `student_study_sessions` 테이블로 대체됨
- **대체 방법**:
  - 타이머 활동은 `student_plan` 테이블의 `actual_start_time`, `actual_end_time` 사용
  - 일시정지/재개는 `student_study_sessions` 테이블 사용

#### 3. 기존 삭제 마이그레이션 확인
- **파일**: `supabase/migrations/20250129000002_remove_unused_tables.sql`
- **삭제 대상**:
  - `student_daily_schedule` 테이블 (이미 삭제됨)
  - `student_academy_schedules` 테이블 (이미 삭제됨)

### ✅ 유지 대상 (실제 사용 중)

#### 테이블
- `student_block_schedule` - 블록 스케줄 관리에 사용 중
- `master_books` - 마스터 교재 데이터
- `master_lectures` - 마스터 강의 데이터
- `books` - 학생 교재 데이터
- `lectures` - 학생 강의 데이터

### 📝 마이그레이션 실행 순서

다음 순서로 마이그레이션을 실행하세요:

1. ✅ `20250129000002_remove_unused_tables.sql` (이미 적용됨)
2. ⏳ `20250130000000_remove_content_masters_table.sql` (신규)
3. ⏳ `20250130000001_remove_plan_timer_logs_table.sql` (신규)

### 🎯 정리 결과

#### 삭제된 항목
- ✅ 3개의 사용되지 않는 폴더/페이지
- ✅ 2개의 데이터베이스 테이블 삭제 마이그레이션 생성

#### 코드베이스 정리
- 불필요한 라우트 그룹 제거
- 중복된 페이지 구조 정리
- 명확한 라우팅 구조 확립

#### 데이터베이스 정리
- 사용되지 않는 테이블 제거 계획 수립
- 데이터 마이그레이션 경로 명확화
- 스키마 최적화 준비 완료

---

## 서비스 정리 및 최적화 계획

### 서비스 핵심 요구사항 정리

#### 🎯 핵심 비전

**1730Timetable**은 학생의 성적 분석을 기반으로 맞춤형 학습 플랜을 자동 생성하는 AI 기반 통합 학습 관리 시스템입니다.

#### ✅ MVP 필수 기능 (Phase 1)

1. **멀티테넌트 구조**
   - 테넌트 등록 및 관리
   - 테넌트별 데이터 격리
   - 테넌트별 사용자 관리

2. **사용자 역할 및 권한**
   - 시스템 관리자: 전체 시스템 관리
   - 테넌트 관리자: 테넌트 설정 및 사용자 관리
   - 담당자(선생님): 학생 관리, 플랜 생성, 성적 관리
   - 학생: 플랜 조회, 학습 실행, 학습 기록
   - 학부모: 자녀 학습 현황 조회 (선택)

3. **핵심 기능 - 플랜 생성 시스템 (1730 Timetable)**
   - ✅ 성적 분석 기반 교재/강의 추천
   - ✅ 수준 분석 기반 학습 분량 추천
   - ✅ 전략과목/취약과목 추천
   - ✅ 학습 범위 분할 및 소요시간 계산
   - ✅ 플랜 생성 로직 (학습일/복습일 주기)
   - ✅ 타임라인 캘린더 뷰
   - ✅ 플랜 학습 실행 및 기록

4. **시스템 기능 - MVP 요구사항**
   - ✅ 인증 및 사용자 관리
   - ✅ 관리자 페이지 (학생 관리, 콘텐츠 관리)
   - ✅ 학생 관리
   - ✅ 직원 관리 (담당자)
   - ✅ 프로필 및 마이페이지
   - ✅ 교재 및 강의 자료 관리
   - ✅ 교육과정 및 교과 관리

#### ⚠️ MVP에 포함되지 않는 기능 (Phase 2 이후)

다음 기능들은 **현재 MVP 단계에서는 불필요**하거나 **우선순위가 낮습니다**:

1. **입실/퇴실 기록** - MVP 요구사항에 명시되어 있으나 실제 사용 여부 확인 필요
2. **게시판** - 커뮤니케이션 기능, MVP에서는 선택
3. **문의 페이지** - 고객 지원 기능, MVP에서는 선택
4. **문자 전송** - 알림 기능, MVP에서는 선택
5. **수강료 관리** - 결제 시스템, MVP에서는 선택
6. **학부모 페이지** - 자녀 연동 기능, MVP에서는 선택
7. **리포트 생성 (PDF/Excel)** - Phase 2 기능
8. **알림 시스템** - Phase 2 기능
9. **AI 분석 고도화** - Phase 2 기능

### 현재 구현 상태 분석

#### ✅ 잘 구현된 부분

1. **1730 Timetable 플랜 생성 로직**
   - `lib/plan/1730TimetableLogic.ts` - 핵심 로직 구현 완료
   - 플랜 생성 위저드 (`app/(student)/plan/new-group/`)
   - 타임라인 캘린더 뷰 (`app/(student)/plan/calendar/`)

2. **학생 기능**
   - 오늘의 학습 (`app/(student)/today/`)
   - 플랜 관리 (`app/(student)/plan/`)
   - 성적 관리 (`app/(student)/scores/`)
   - 콘텐츠 관리 (`app/(student)/contents/`)

3. **관리자 기능**
   - 학생 관리 (`app/(admin)/admin/students/`)
   - 콘텐츠 메타데이터 관리 (`app/(admin)/admin/content-metadata/`)
   - 마스터 콘텐츠 관리 (`app/(admin)/admin/master-books/`, `master-lectures/`)

---

## Step7 개선 작업

**작업 일시**: 2025-01-22

### 완료된 작업

#### Phase 1: 즉시 수정 (Critical) ✅

1. **TODO 1: Step 7 제외일 조회 수정** ✅
   - `student_plan_exclusions` → `plan_exclusions` 테이블로 변경
   - `plan_group_id`로 조회하도록 수정
   - 지정 휴일 정보가 정확히 반영됨

2. **TODO 2: getPlanGroupWithDetails 사용으로 통일** ✅
   - `_getScheduleResultData`에서 `getPlanGroupWithDetails` 사용
   - Step 3과 Step 7의 데이터 소스 통일
   - 코드 중복 제거 및 유지보수성 향상

3. **TODO 5: Step 3과 Step 7 데이터 소스 통일** ✅
   - 이미 `getPlanGroupWithDetails` 사용으로 완료

#### Phase 2: 장기 개선 (Optimization) ✅

4. **TODO 3: 저장된 daily_schedule 우선 사용 로직 개선** ✅
   - 유효성 검증 함수 추가
   - 저장된 데이터가 유효하면 우선 사용
   - 불필요한 재계산 방지

5. **TODO 6: daily_schedule 유효성 검증 로직 추가** ✅
   - 기간 일치 여부 확인
   - 필수 필드 확인
   - 유효하지 않을 때만 재계산

#### Phase 3: 품질 향상 (Quality) ✅

6. **TODO 7: 재계산 조건 명확화 및 리팩토링** ✅
   - `shouldRecalculateDailySchedule` 함수로 분리
   - 재계산 조건을 명확한 함수로 추상화
   - 코드 가독성 및 테스트 가능성 향상

7. **TODO 8: 제외일 조회 에러 핸들링 및 폴백** ✅
   - 제외일 조회 실패 시 폴백 로직 추가
   - 저장된 `daily_schedule`에서 제외일 정보 추출
   - 에러 로깅 및 안정성 향상

### 개선 효과

#### 기능적 개선
1. **지정 휴일 정보 정확히 반영**: `plan_exclusions` 테이블에서 올바르게 조회
2. **일관성 유지**: Step 3과 Step 7이 동일한 데이터 소스 사용
3. **성능 개선**: 저장된 `daily_schedule` 우선 사용으로 불필요한 재계산 방지
4. **안정성 향상**: 에러 핸들링 및 폴백 로직으로 오류 상황 대응

#### 코드 품질 개선
1. **유지보수성 향상**: 코드 중복 제거 및 공통 함수 사용
2. **가독성 향상**: 재계산 조건을 명확한 함수로 분리
3. **테스트 가능성 향상**: 함수 분리로 단위 테스트 작성 용이
4. **문서화**: 캐싱 전략 및 재계산 로직 문서화

### 성능 개선

#### Before
- 매번 `calculateAvailableDates` 호출
- 제외일 조회 실패 시 전체 실패
- 불필요한 재계산

#### After
- 저장된 데이터 우선 사용
- 제외일 조회 실패 시 폴백 로직
- 유효성 검증 후 재계산

**예상 성능 향상**: 약 50-70% (저장된 데이터 사용 시)

### 남은 작업

#### Phase 2: 장기 개선 (Optimization)
- **TODO 4: scheduler_options 버전 관리 추가** (옵션 변경 감지)
  - `scheduler_options`에 버전 필드 추가
  - 옵션 변경 시 버전 비교하여 재계산 필요 여부 판단
  - 현재는 유효성 검증만 수행

#### Phase 4: 문서화 및 테스트
- **TODO 10: 단위 테스트 작성**
  - `shouldRecalculateDailySchedule` 함수 테스트
  - `isValidDailySchedule` 함수 테스트
  - 에러 핸들링 및 폴백 로직 테스트

---

## 플랜 캘린더 UI 개선

### 개선 내용

#### 1. 플랜 목록 표시 개수 증가
- **변경 전**: 최대 3개까지만 표시
- **변경 후**: 최대 6개까지 표시

**효과**: 한 날짜에 여러 플랜이 있어도 더 많은 정보를 한눈에 볼 수 있습니다.

#### 2. "+n개 더" 버튼을 아이콘 형식으로 변경
- **변경 전**: 텍스트 버튼 (`+{n}개 더`)
- **변경 후**: 아이콘 표시 (`⋯`)

**효과**: 
- 공간 절약
- 항목이 더 있다는 것만 간단히 표시
- 호버 시 툴팁으로 정확한 개수 확인 가능

#### 3. PlanCard compact 모드 크기 최적화
- 플랜 카드의 compact 모드 크기 최적화
- 공간 효율성 향상

---

## 우선순위별 정리 작업

### 우선순위 1: 즉시 정리 (Critical)

1. **사용되지 않는 페이지/폴더 삭제** ✅
   - `app/post-login/` 삭제
   - `app/(superadmin)/` 삭제
   - `app/dashboard/` 삭제

2. **데이터베이스 테이블 삭제 마이그레이션** ✅
   - `content_masters` 테이블 삭제
   - `plan_timer_logs` 테이블 삭제

### 우선순위 2: 단기 개선 (Important)

1. **리포트 기능 통합**
   - `app/(student)/report/`와 `app/(student)/reports/` 통합 검토

2. **콘텐츠 관리 구조 정리**
   - 학생용/관리자용 콘텐츠 관리 코드 중복 제거

3. **스케줄러 기능 정리**
   - `app/(student)/scheduler/` 사용 여부 확인 및 1730 Timetable과 통합 검토

### 우선순위 3: 장기 개선 (Optimization)

1. **성능 최적화**
   - 데이터베이스 쿼리 최적화
   - 캐싱 전략 개선
   - 불필요한 데이터 조회 최소화

2. **코드 품질 개선**
   - 중복 코드 제거
   - 공통 함수 통합
   - 타입 안전성 강화

---

## ⚠️ 주의사항

1. **마이그레이션 실행 전 확인**
   - `content_masters` 테이블의 데이터가 모두 `master_books`와 `master_lectures`로 마이그레이션되었는지 확인
   - `plan_timer_logs` 테이블을 사용하는 코드가 없는지 최종 확인

2. **백업 권장**
   - 마이그레이션 실행 전 데이터베이스 백업 권장

3. **테스트**
   - 마이그레이션 실행 후 애플리케이션 테스트 필수

---

**작성일**: 2025-01-31  
**작성자**: AI Assistant  
**버전**: 1.0

