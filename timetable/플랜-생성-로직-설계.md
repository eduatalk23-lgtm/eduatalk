# 플랜 생성 로직 설계 문서

## 개요

이 문서는 학습 플랜 생성 시 필요한 모든 입력 항목과 제약조건, 처리 로직을 정의합니다. 플랜 생성은 학생의 학습 가능한 시간대를 정확히 계산하고, 제외 시간을 고려하여 최적의 스케줄을 생성하는 것을 목표로 합니다.

---

## 1. 기간 정보 (Period)

### 필수 입력 항목

- **period_start** (시작일)
  - 형식: `YYYY-MM-DD` (date 타입)
  - 예시: `2025-01-01`

- **period_end** (종료일)
  - 형식: `YYYY-MM-DD` (date 타입)
  - 예시: `2025-03-31`

### 제약조건

- `period_end > period_start` (종료일이 시작일보다 이후여야 함)
- 날짜 형식이 유효해야 함

### 용도

1. **플랜 생성 범위 결정**: 플랜이 생성될 날짜 범위를 결정
2. **스케줄 계산 기준**: 기간 내 날짜만 처리하여 플랜 배정
3. **제외일 필터링**: 제외일(exclusions)이 기간 내에 있는지 검증
4. **기존 플랜 조회**: 기간 내 기존 플랜 조회 범위 결정

### 데이터 구조

```typescript
type Period = {
  period_start: string; // YYYY-MM-DD
  period_end: string;   // YYYY-MM-DD
};
```

---

## 2. 학습 시간 설정 (Study Hours)

### 필수 입력 항목

- **하루 중 학습 가능한 시간 범위**
  - 시작 시간: `HH:mm` (24시간 형식)
  - 종료 시간: `HH:mm` (24시간 형식)
  - 예시: `10:00 ~ 19:00` (오전 10시부터 오후 7시까지)

### 제약조건

- 시작 시간 < 종료 시간
- 시간 범위가 유효해야 함 (예: `00:00 ~ 23:59`)
- 시간 형식이 올바르야 함 (`HH:mm`)

### 용도

1. **플랜 배정 시간대 결정**: 플랜이 배정될 수 있는 시간대 결정
2. **스케줄 계산 기준**: 해당 시간 범위 내에서만 플랜 배정
3. **블록 생성 기준**: 블록(block) 생성 시 기준 시간 범위로 사용

### 고려사항

- 요일별로 다른 학습 시간 설정 가능 여부
- 점심 시간 등 제외 시간대 설정 여부 (별도 섹션 참조)

### 데이터 구조

```typescript
type StudyHours = {
  start_time: string; // HH:mm
  end_time: string;   // HH:mm
};

// 요일별 설정 가능한 경우
type StudyHoursByDay = {
  [day: number]: StudyHours; // 0: 일요일, 1: 월요일, ..., 6: 토요일
};
```

---

## 3. 자율학습 시간 설정 (Self-Study Hours)

### 선택 입력 항목

- **자율학습 가능한 시간 범위**
  - 시작 시간: `HH:mm` (24시간 형식)
  - 종료 시간: `HH:mm` (24시간 형식)
  - 예시: `19:00 ~ 22:00` (오후 7시부터 오후 10시까지)

### 제약조건

- 시작 시간 < 종료 시간
- 시간 범위가 유효해야 함 (예: `00:00 ~ 23:59`)
- 시간 형식이 올바르야 함 (`HH:mm`)

### 용도

1. **자율학습 시간대 정의**: 자율학습 시간대를 명확히 정의
2. **플랜 배정 제외**: 해당 시간대는 플랜 배정 대상에서 제외
3. **시간 구분 관리**: 학습 시간과 자율학습 시간을 구분하여 관리

### ⚠️ 중요 제약사항

- **자율학습 시간에는 플랜 배정을 하지 않음**
- **플랜은 오직 학습 시간(Study Hours) 내에서만 배정됨**

### 고려사항

1. **자율학습 시간 사용 여부**: 토글로 활성화/비활성화 가능
2. **시간 관계**: 학습 시간과 자율학습 시간의 관계 (연속/분리)
3. **요일별 설정**: 요일별로 다른 자율학습 시간 설정 가능 여부
4. **지정휴일 처리**: 학습일/복습일/지정휴일별로 자율학습 시간 적용 여부
   - 지정휴일에는 자율학습 시간을 배정할 수 있음 (선택사항)

### 데이터 구조

```typescript
type SelfStudyHours = {
  enabled: boolean;    // 자율학습 시간 사용 여부
  start_time: string;  // HH:mm
  end_time: string;    // HH:mm
};

// 지정휴일 자율학습 시간 배정 설정
type SelfStudyOnHoliday = {
  enabled: boolean;    // 지정휴일에 자율학습 시간 배정 여부
};
```

---

## 4. 학습 제외일 설정 (Exclusions)

### 선택 입력 항목

플랜 생성 기간 내에서 학습을 제외할 날짜들

### 제외일 유형

1. **휴가**: 학습 시간과 자율학습 시간 모두 제외
2. **개인일정**: 학습 시간과 자율학습 시간 모두 제외
3. **기타**: 학습 시간과 자율학습 시간 모두 제외
4. **지정휴일**: 특별 처리 필요 (아래 참조)

### 입력 항목

- **날짜**: `YYYY-MM-DD` (date 타입)
- **제외일 유형**: `"휴가" | "개인일정" | "기타" | "지정휴일"`
- **사유** (선택): 텍스트

### 제약조건

- 제외일은 `period_start ~ period_end` 범위 내에 있어야 함
- 같은 날짜에 여러 제외일 설정 불가 (중복 방지)

### 용도

1. **플랜 배정 제외**: 해당 날짜에는 플랜 배정하지 않음
2. **스케줄 계산 제외**: 제외일은 학습 가능한 날짜에서 제외
3. **시간 사용 제한**: 학습 시간과 자율학습 시간 모두 사용 불가

### 지정휴일 특별 처리

#### 일반 제외일과의 차이점

- **일반 제외일**: 학습 시간과 자율학습 시간 모두 사용 불가
- **지정휴일**: 일반 학습 시간에는 플랜 배정하지 않음, **하지만 자율학습 시간은 배정 가능** (선택사항)

#### 지정휴일 자율학습 시간 배정

- 자율학습 시간 배정 여부는 설정으로 제어 가능
- 예시: 지정휴일 `19:00 ~ 22:00`에 자율학습 시간 배정 가능

### 고려사항

1. **제외일 사유 입력**: 선택사항으로 사유 입력 가능
2. **제외일 목록 관리**: 추가/삭제/수정 기능 필요
3. **지정휴일 자율학습 시간 배정 토글**: 설정으로 제어 가능
4. **제외일 중복 검증**: 같은 날짜에 여러 제외일 설정 방지

### 데이터 구조

```typescript
type ExclusionType = "휴가" | "개인일정" | "기타" | "지정휴일";

type Exclusion = {
  date: string;              // YYYY-MM-DD
  type: ExclusionType;
  reason?: string;           // 선택사항
  allow_self_study?: boolean; // 지정휴일의 경우 자율학습 시간 배정 여부
};
```

---

## 5. 학원 일정 설정 (Academy Schedules)

### 선택 입력 항목

주간 학원 일정 (요일별 반복)

### 입력 항목

- **요일**: `0` (일요일) ~ `6` (토요일)
- **학원 시간**: 시작 시간 ~ 종료 시간
  - 형식: `HH:mm` (24시간 형식)
  - 예시: `14:00 ~ 17:00`
- **이동시간**: 학원 가는 시간 + 학원 오는 시간 (분 단위)
  - 형식: 숫자 (분)
  - 예시: `60` (60분 = 1시간)
- **학원명** (선택): 텍스트
- **과목** (선택): 텍스트

### 제약조건

- 시작 시간 < 종료 시간
- 이동시간은 0 이상의 정수
- 요일은 0~6 범위 내의 정수

### 용도

1. **플랜 배정 제외**: 학원 시간에는 플랜 배정하지 않음
2. **이동시간 제외**: 학원 시간 전후 이동시간 동안에도 플랜 배정하지 않음
3. **스케줄 계산**: 학원 시간과 이동시간을 제외한 시간에만 플랜 배정

### 시간 제외 계산

#### 계산 공식

```
실제 제외 시작 시간 = 학원 시작 시간 - 이동시간
실제 제외 종료 시간 = 학원 종료 시간 + 이동시간
```

#### 예시

- **학원 시간**: `14:00 ~ 17:00`
- **이동시간**: `60분`
- **실제 제외 시간**: `13:00 ~ 18:00`
  - 학원 시간 전 1시간 (13:00 ~ 14:00)
  - 학원 시간 3시간 (14:00 ~ 17:00)
  - 학원 시간 후 1시간 (17:00 ~ 18:00)

### 고려사항

1. **같은 요일에 여러 학원 일정**: 여러 학원 일정 설정 가능 여부
2. **학원 일정과 학습 시간 겹침**: 겹치는 경우 처리 방법
3. **학원 일정과 자율학습 시간 겹침**: 자율학습 시간은 플랜 배정 안 함 (자동 제외)
4. **학원 일정 목록 관리**: 추가/삭제/수정 기능 필요
5. **시간 겹침 검증**: 학원 일정 간 시간 겹침 검증 필요

### 데이터 구조

```typescript
type AcademySchedule = {
  day_of_week: number;      // 0: 일요일, 1: 월요일, ..., 6: 토요일
  start_time: string;       // HH:mm
  end_time: string;         // HH:mm
  travel_time_minutes: number; // 분 단위
  academy_name?: string;    // 선택사항
  subject?: string;         // 선택사항
};
```

---

## 6. 학습 시간 제외 항목 설정 (Non-Study Time Blocks)

### 선택 입력 항목

학습 시간 내에서 플랜 배정을 제외할 시간대들

### 제외 항목 유형

1. **아침식사**: 아침 식사 시간
2. **점심식사**: 점심 식사 시간
3. **저녁식사**: 저녁 식사 시간
4. **수면**: 수면 시간
5. **기타**: 기타 개인 시간

### 입력 항목

- **제외 항목 유형**: `"아침식사" | "점심식사" | "저녁식사" | "수면" | "기타"`
- **시간 범위**: 시작 시간 ~ 종료 시간
  - 형식: `HH:mm` (24시간 형식)
  - 예시: `12:00 ~ 13:00` (점심식사)
- **요일 적용 범위** (선택):
  - 매일 적용 (기본값)
  - 특정 요일만 적용
  - 특정 요일 제외
- **설명** (선택): 텍스트 (기타 항목의 경우)

### 제약조건

- 시작 시간 < 종료 시간
- 시간 범위가 **학습 시간(Study Hours) 내**에 있어야 함
- 같은 시간대에 여러 제외 항목이 겹치지 않아야 함

### 용도

1. **플랜 배정 제외**: 해당 시간대에는 플랜 배정하지 않음
2. **스케줄 계산**: 제외 항목 시간을 제외한 시간에만 플랜 배정
3. **실제 학습 가능 시간 계산**: 학습 시간에서 제외 항목 시간을 빼서 실제 학습 가능한 시간 계산

### 시간 제외 계산

#### 계산 방법

학습 시간에서 제외 항목 시간을 빼서 실제 학습 가능한 시간 계산

#### 예시

- **학습 시간**: `10:00 ~ 19:00`
- **점심식사**: `12:00 ~ 13:00`
- **실제 학습 가능 시간**: 
  - `10:00 ~ 12:00` (점심 전)
  - `13:00 ~ 19:00` (점심 후)

### 고려사항

1. **같은 요일에 여러 제외 항목**: 여러 제외 항목 설정 가능
2. **제외 항목 간 시간 겹침 검증**: 시간 겹침 방지 필요
3. **제외 항목 목록 관리**: 추가/삭제/수정 기능 필요
4. **요일별 설정**: 요일별로 다른 제외 항목 설정 가능 여부
5. **학원 일정과의 관계**: 제외 항목과 학원 일정이 겹치는 경우 처리 (학원 일정 우선)

### 데이터 구조

```typescript
type NonStudyTimeBlockType = 
  | "아침식사" 
  | "점심식사" 
  | "저녁식사" 
  | "수면" 
  | "기타";

type DayOfWeek = 0 | 1 | 2 | 3 | 4 | 5 | 6; // 0: 일요일, 6: 토요일

type NonStudyTimeBlock = {
  type: NonStudyTimeBlockType;
  start_time: string;      // HH:mm
  end_time: string;        // HH:mm
  days_of_week?: DayOfWeek[]; // 특정 요일만 적용 (없으면 매일)
  exclude_days?: DayOfWeek[]; // 특정 요일 제외
  description?: string;     // 기타 항목의 경우 설명
};
```

---

## 전체 데이터 구조 통합

### 플랜 생성 요청 데이터 구조

```typescript
type PlanCreationRequest = {
  // 1. 기간 정보
  period: {
    period_start: string; // YYYY-MM-DD
    period_end: string;   // YYYY-MM-DD
  };

  // 2. 학습 시간 설정
  study_hours: {
    start_time: string; // HH:mm
    end_time: string;   // HH:mm
  };

  // 3. 자율학습 시간 설정 (선택)
  self_study_hours?: {
    enabled: boolean;
    start_time: string; // HH:mm
    end_time: string;   // HH:mm
    allow_on_holiday?: boolean; // 지정휴일에 자율학습 시간 배정 여부
  };

  // 4. 학습 제외일 설정 (선택)
  exclusions?: Exclusion[];

  // 5. 학원 일정 설정 (선택)
  academy_schedules?: AcademySchedule[];

  // 6. 학습 시간 제외 항목 설정 (선택)
  non_study_time_blocks?: NonStudyTimeBlock[];
};
```

---

## 플랜 배정 우선순위 및 제외 규칙

### 시간 제외 우선순위

1. **제외일 (Exclusions)**
   - 일반 제외일: 학습 시간 + 자율학습 시간 모두 제외
   - 지정휴일: 학습 시간만 제외 (자율학습 시간은 설정에 따라 배정 가능)

2. **학원 일정 (Academy Schedules)**
   - 학원 시간 + 이동시간 제외
   - 학습 시간 내에서만 적용

3. **학습 시간 제외 항목 (Non-Study Time Blocks)**
   - 식사 시간, 수면 시간 등
   - 학습 시간 내에서만 적용

4. **자율학습 시간 (Self-Study Hours)**
   - 자율학습 시간에는 플랜 배정하지 않음
   - 지정휴일의 경우 설정에 따라 배정 가능

### 실제 학습 가능 시간 계산 예시

#### 시나리오

- **기간**: `2025-01-01 ~ 2025-01-31`
- **학습 시간**: `10:00 ~ 19:00`
- **자율학습 시간**: `19:00 ~ 22:00` (플랜 배정 제외)
- **점심식사**: `12:00 ~ 13:00`
- **학원 일정**: 수요일 `14:00 ~ 17:00`, 이동시간 `60분`
- **제외일**: `2025-01-15` (휴가)

#### 2025-01-01 (수요일) 실제 학습 가능 시간

1. **기본 학습 시간**: `10:00 ~ 19:00`
2. **점심식사 제외**: `12:00 ~ 13:00` 제외
3. **학원 일정 제외**: `13:00 ~ 18:00` 제외 (14:00-60분 ~ 17:00+60분)
4. **최종 학습 가능 시간**: `10:00 ~ 12:00` (1시간)

#### 2025-01-15 (제외일) 실제 학습 가능 시간

- **전체 제외**: 학습 시간과 자율학습 시간 모두 사용 불가

---

## 검증 규칙 요약

### 필수 검증

1. ✅ `period_end > period_start`
2. ✅ 학습 시간: `start_time < end_time`
3. ✅ 자율학습 시간: `start_time < end_time` (활성화된 경우)
4. ✅ 제외일이 기간 내에 있는지 확인
5. ✅ 학원 일정 시간: `start_time < end_time`
6. ✅ 제외 항목 시간: `start_time < end_time`
7. ✅ 제외 항목이 학습 시간 내에 있는지 확인

### 선택 검증

1. ⚠️ 같은 날짜에 여러 제외일 중복 방지
2. ⚠️ 같은 시간대에 여러 제외 항목 겹침 방지
3. ⚠️ 학원 일정과 학습 시간 겹침 확인
4. ⚠️ 제외 항목과 학원 일정 겹침 확인 (학원 일정 우선)

---

## 구현 고려사항

### 성능 최적화

1. **기간 내 날짜 계산**: 한 번만 계산하여 캐싱
2. **시간 겹침 검증**: 효율적인 알고리즘 사용 (예: 간격 트리)
3. **스케줄 계산**: 배치 처리로 최적화

### 사용자 경험

1. **실시간 검증**: 입력 시 즉시 검증 메시지 표시
2. **시각적 피드백**: 시간 겹침 시 시각적으로 표시
3. **기본값 제공**: 일반적인 설정값을 기본값으로 제공

### 데이터 일관성

1. **트랜잭션 처리**: 플랜 생성 시 원자성 보장
2. **롤백 지원**: 오류 발생 시 이전 상태로 복구
3. **데이터 무결성**: 외래키 제약조건 활용

---

## 참고사항

- 모든 시간은 `HH:mm` 형식의 24시간 형식 사용
- 모든 날짜는 `YYYY-MM-DD` 형식 사용
- 시간대(timezone)는 서버 기준으로 처리
- 요일은 0(일요일)부터 6(토요일)까지의 숫자로 표현

