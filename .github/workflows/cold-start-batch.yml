name: Cold Start Batch Processing

on:
  # ë§¤ì¼ ìƒˆë²½ 3ì‹œ (KST) = UTC 18:00 ì‹¤í–‰
  schedule:
    - cron: '0 18 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      preset:
        description: 'ë°°ì¹˜ í”„ë¦¬ì…‹'
        required: true
        default: 'core'
        type: choice
        options:
          - core
          - math
          - english
          - science
          - all
      limit:
        description: 'ì²˜ë¦¬ ëŒ€ìƒ ì œí•œ (0 = ì „ì²´)'
        required: false
        default: '0'
        type: string
      dry_run:
        description: 'ë“œë¼ì´ëŸ° ëª¨ë“œ (ì‹¤ì œ API í˜¸ì¶œ ì—†ìŒ)'
        required: false
        default: false
        type: boolean

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

jobs:
  batch:
    name: Run Cold Start Batch
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ìµœëŒ€ 1ì‹œê°„

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Cold Start Batch (Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "ðŸš€ ìŠ¤ì¼€ì¤„ ë°°ì¹˜ ì‹¤í–‰: core í”„ë¦¬ì…‹"
          npx tsx scripts/cold-start-batch.ts core --delay=5000
        env:
          NODE_ENV: production

      - name: Run Cold Start Batch (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          PRESET="${{ github.event.inputs.preset }}"
          LIMIT="${{ github.event.inputs.limit }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          echo "ðŸš€ ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰"
          echo "  - í”„ë¦¬ì…‹: $PRESET"
          echo "  - ì œí•œ: $LIMIT"
          echo "  - ë“œë¼ì´ëŸ°: $DRY_RUN"

          CMD="npx tsx scripts/cold-start-batch.ts $PRESET --delay=5000"

          if [ "$LIMIT" != "0" ] && [ -n "$LIMIT" ]; then
            CMD="$CMD --limit=$LIMIT"
          fi

          if [ "$DRY_RUN" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "ì‹¤í–‰ ëª…ë ¹: $CMD"
          eval $CMD
        env:
          NODE_ENV: production

      - name: Summary
        if: always()
        run: |
          echo "## Cold Start Batch ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°„**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **íŠ¸ë¦¬ê±°**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **í”„ë¦¬ì…‹**: ${{ github.event.inputs.preset }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **í”„ë¦¬ì…‹**: core (ìŠ¤ì¼€ì¤„)" >> $GITHUB_STEP_SUMMARY
          fi
