name: Carryover Batch Processing

on:
  # ë§¤ì¼ ìžì • ì§í›„ (KST 00:05) = UTC 15:05 ì‹¤í–‰
  schedule:
    - cron: '5 15 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      tenant_id:
        description: 'íŠ¹ì • í…Œë„ŒíŠ¸ ID (ë¹„ì›Œë‘ë©´ ì „ì²´)'
        required: false
        default: ''
        type: string
      student_id:
        description: 'íŠ¹ì • í•™ìƒ ID (tenant_id í•„ìˆ˜)'
        required: false
        default: ''
        type: string
      cutoff_date:
        description: 'ê¸°ì¤€ ë‚ ì§œ (YYYY-MM-DD, ë¹„ì›Œë‘ë©´ ì˜¤ëŠ˜)'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'ë“œë¼ì´ëŸ° ëª¨ë“œ (ì‹¤ì œ ì²˜ë¦¬ ì—†ìŒ)'
        required: false
        default: false
        type: boolean

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  carryover:
    name: Run Carryover Batch
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Carryover Batch (Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "ðŸš€ ìŠ¤ì¼€ì¤„ ë°°ì¹˜ ì‹¤í–‰: ì „ì²´ í…Œë„ŒíŠ¸/í•™ìƒ"
          npx tsx scripts/carryover-batch.ts
        env:
          NODE_ENV: production

      - name: Run Carryover Batch (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          TENANT_ID="${{ github.event.inputs.tenant_id }}"
          STUDENT_ID="${{ github.event.inputs.student_id }}"
          CUTOFF_DATE="${{ github.event.inputs.cutoff_date }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          echo "ðŸš€ ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰"
          echo "  - í…Œë„ŒíŠ¸: ${TENANT_ID:-ì „ì²´}"
          echo "  - í•™ìƒ: ${STUDENT_ID:-ì „ì²´}"
          echo "  - ê¸°ì¤€ ë‚ ì§œ: ${CUTOFF_DATE:-ì˜¤ëŠ˜}"
          echo "  - ë“œë¼ì´ëŸ°: $DRY_RUN"

          CMD="npx tsx scripts/carryover-batch.ts"

          if [ -n "$TENANT_ID" ]; then
            CMD="$CMD --tenant=$TENANT_ID"
          fi

          if [ -n "$STUDENT_ID" ]; then
            CMD="$CMD --student=$STUDENT_ID"
          fi

          if [ -n "$CUTOFF_DATE" ]; then
            CMD="$CMD --cutoff=$CUTOFF_DATE"
          fi

          if [ "$DRY_RUN" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "ì‹¤í–‰ ëª…ë ¹: $CMD"
          eval $CMD
        env:
          NODE_ENV: production

      - name: Summary
        if: always()
        run: |
          echo "## Carryover Batch ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°„**: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "- **íŠ¸ë¦¬ê±°**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **í…Œë„ŒíŠ¸**: ${{ github.event.inputs.tenant_id || 'ì „ì²´' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **í•™ìƒ**: ${{ github.event.inputs.student_id || 'ì „ì²´' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ë“œë¼ì´ëŸ°**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ëŒ€ìƒ**: ì „ì²´ (ìŠ¤ì¼€ì¤„)" >> $GITHUB_STEP_SUMMARY
          fi
