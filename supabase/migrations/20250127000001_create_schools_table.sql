-- Migration: Create schools table for school search
-- Description: 중학교, 고등학교, 대학교 정보를 저장하는 테이블 생성
-- Date: 2025-01-27

-- ============================================
-- 1. schools 테이블 생성
-- ============================================

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name = 'schools'
  ) THEN
    CREATE TABLE schools (
      id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
      name text NOT NULL,
      type text NOT NULL CHECK (type IN ('중학교', '고등학교', '대학교')),
      region text, -- 지역 (예: 서울, 경기, 부산 등)
      address text, -- 주소
      created_at timestamptz DEFAULT now(),
      updated_at timestamptz DEFAULT now(),
      UNIQUE(name, type) -- 학교명과 타입 조합으로 중복 방지
    );

    -- 인덱스 추가 (검색 성능 향상)
    CREATE INDEX idx_schools_name ON schools(name);
    CREATE INDEX idx_schools_type ON schools(type);
    CREATE INDEX idx_schools_region ON schools(region);
    CREATE INDEX idx_schools_name_type ON schools(name, type);
    -- 한국어 텍스트 검색 인덱스는 한국어 설정이 필요하므로 제외
    -- 필요시 기본 설정으로 변경: CREATE INDEX idx_schools_search ON schools USING gin(to_tsvector('simple', name || ' ' || COALESCE(region, '')));

    -- 코멘트 추가
    COMMENT ON TABLE schools IS '학교 정보 테이블 (중학교, 고등학교, 대학교)';
    COMMENT ON COLUMN schools.name IS '학교명';
    COMMENT ON COLUMN schools.type IS '학교 유형 (중학교, 고등학교, 대학교)';
    COMMENT ON COLUMN schools.region IS '지역';
    COMMENT ON COLUMN schools.address IS '주소';
  END IF;
END $$;

-- ============================================
-- 2. 기본 대학교 데이터 삽입 (주요 대학교)
-- ============================================

-- 대학교는 상대적으로 적으므로 주요 대학교를 미리 삽입 (중복 제거)
INSERT INTO schools (name, type, region) VALUES
  ('서울대학교', '대학교', '서울'),
  ('연세대학교', '대학교', '서울'),
  ('고려대학교', '대학교', '서울'),
  ('한국과학기술원', '대학교', '대전'),
  ('포스텍', '대학교', '포항'),
  ('성균관대학교', '대학교', '서울'),
  ('한양대학교', '대학교', '서울'),
  ('중앙대학교', '대학교', '서울'),
  ('경희대학교', '대학교', '서울'),
  ('이화여자대학교', '대학교', '서울'),
  ('서강대학교', '대학교', '서울'),
  ('동국대학교', '대학교', '서울'),
  ('건국대학교', '대학교', '서울'),
  ('홍익대학교', '대학교', '서울'),
  ('아주대학교', '대학교', '경기'),
  ('인하대학교', '대학교', '인천'),
  ('부산대학교', '대학교', '부산'),
  ('전남대학교', '대학교', '광주'),
  ('전북대학교', '대학교', '전주'),
  ('충남대학교', '대학교', '대전'),
  ('충북대학교', '대학교', '청주'),
  ('경북대학교', '대학교', '대구'),
  ('강원대학교', '대학교', '춘천'),
  ('제주대학교', '대학교', '제주'),
  ('가톨릭대학교', '대학교', '서울'),
  ('단국대학교', '대학교', '경기'),
  ('명지대학교', '대학교', '경기'),
  ('세종대학교', '대학교', '서울'),
  ('숭실대학교', '대학교', '서울'),
  ('인천대학교', '대학교', '인천'),
  ('한국외국어대학교', '대학교', '서울'),
  ('한국항공대학교', '대학교', '경기'),
  ('한국해양대학교', '대학교', '부산'),
  ('경상국립대학교', '대학교', '진주'),
  ('부경대학교', '대학교', '부산'),
  ('울산대학교', '대학교', '울산'),
  ('원광대학교', '대학교', '전주'),
  ('조선대학교', '대학교', '광주'),
  ('계명대학교', '대학교', '대구'),
  ('영남대학교', '대학교', '경산'),
  ('가천대학교', '대학교', '경기'),
  ('광운대학교', '대학교', '서울'),
  ('덕성여자대학교', '대학교', '서울'),
  ('동덕여자대학교', '대학교', '서울'),
  ('상명대학교', '대학교', '서울'),
  ('서울여자대학교', '대학교', '서울'),
  ('숙명여자대학교', '대학교', '서울'),
  ('한국예술종합학교', '대학교', '서울'),
  ('한국체육대학교', '대학교', '서울'),
  ('국민대학교', '대학교', '서울'),
  ('동의대학교', '대학교', '부산'),
  ('부산외국어대학교', '대학교', '부산'),
  ('서울시립대학교', '대학교', '서울'),
  ('인제대학교', '대학교', '부산'),
  ('전주대학교', '대학교', '전주'),
  ('중부대학교', '대학교', '경기'),
  ('한국기술교육대학교', '대학교', '천안'),
  ('한국산업기술대학교', '대학교', '경기'),
  ('한국전통문화대학교', '대학교', '전주'),
  ('한밭대학교', '대학교', '대전'),
  ('한성대학교', '대학교', '서울'),
  ('호서대학교', '대학교', '아산'),
  ('경인여자대학교', '대학교', '인천'),
  ('대구대학교', '대학교', '대구'),
  ('동아대학교', '대학교', '부산'),
  ('동양대학교', '대학교', '경북'),
  ('목포대학교', '대학교', '목포'),
  ('배재대학교', '대학교', '대전'),
  ('백석대학교', '대학교', '천안'),
  ('삼성전자기술원', '대학교', '서울'),
  ('서울과학기술대학교', '대학교', '서울'),
  ('서울신학대학교', '대학교', '서울'),
  ('순천향대학교', '대학교', '아산'),
  ('신라대학교', '대학교', '부산'),
  ('아신대학교', '대학교', '서울'),
  ('연세대학교 원주캠퍼스', '대학교', '원주'),
  ('영산대학교', '대학교', '양산'),
  ('제주국제대학교', '대학교', '제주'),
  ('중앙대학교 안성캠퍼스', '대학교', '안성'),
  ('창원대학교', '대학교', '창원'),
  ('청주대학교', '대학교', '청주'),
  ('평택대학교', '대학교', '평택'),
  ('한국교원대학교', '대학교', '청주'),
  ('한국방송통신대학교', '대학교', '서울'),
  ('한국산업기술대학교', '대학교', '경기'),
  ('한국장신대학교', '대학교', '서울'),
  ('한남대학교', '대학교', '대전'),
  ('한서대학교', '대학교', '태안'),
  ('한신대학교', '대학교', '오산'),
  ('협성대학교', '대학교', '경기')
ON CONFLICT DO NOTHING;

-- 중학교 샘플 데이터 (주요 지역별 확장)
INSERT INTO schools (name, type, region) VALUES
  -- 서울 지역
  ('서울중학교', '중학교', '서울'),
  ('강남중학교', '중학교', '서울'),
  ('강북중학교', '중학교', '서울'),
  ('서초중학교', '중학교', '서울'),
  ('송파중학교', '중학교', '서울'),
  ('은평중학교', '중학교', '서울'),
  ('마포중학교', '중학교', '서울'),
  ('용산중학교', '중학교', '서울'),
  ('성동중학교', '중학교', '서울'),
  ('광진중학교', '중학교', '서울'),
  ('강동중학교', '중학교', '서울'),
  ('강서중학교', '중학교', '서울'),
  ('관악중학교', '중학교', '서울'),
  ('구로중학교', '중학교', '서울'),
  ('금천중학교', '중학교', '서울'),
  ('노원중학교', '중학교', '서울'),
  ('도봉중학교', '중학교', '서울'),
  ('동대문중학교', '중학교', '서울'),
  ('양천중학교', '중학교', '서울'),
  ('영등포중학교', '중학교', '서울'),
  ('종로중학교', '중학교', '서울'),
  ('중랑중학교', '중학교', '서울'),
  -- 경기 지역
  ('수원중학교', '중학교', '경기'),
  ('성남중학교', '중학교', '경기'),
  ('부천중학교', '중학교', '경기'),
  ('안양중학교', '중학교', '경기'),
  ('안산중학교', '중학교', '경기'),
  ('고양중학교', '중학교', '경기'),
  ('용인중학교', '중학교', '경기'),
  ('평택중학교', '중학교', '경기'),
  ('의정부중학교', '중학교', '경기'),
  ('시흥중학교', '중학교', '경기'),
  ('김포중학교', '중학교', '경기'),
  ('광명중학교', '중학교', '경기'),
  ('하남중학교', '중학교', '경기'),
  ('오산중학교', '중학교', '경기'),
  ('이천중학교', '중학교', '경기'),
  -- 기타 광역시
  ('부산중학교', '중학교', '부산'),
  ('인천중학교', '중학교', '인천'),
  ('대구중학교', '중학교', '대구'),
  ('광주중학교', '중학교', '광주'),
  ('대전중학교', '중학교', '대전'),
  ('울산중학교', '중학교', '울산')
ON CONFLICT DO NOTHING;

-- 고등학교 샘플 데이터 (주요 지역별 확장)
INSERT INTO schools (name, type, region) VALUES
  -- 서울 지역
  ('서울고등학교', '고등학교', '서울'),
  ('강남고등학교', '고등학교', '서울'),
  ('강북고등학교', '고등학교', '서울'),
  ('서초고등학교', '고등학교', '서울'),
  ('송파고등학교', '고등학교', '서울'),
  ('은평고등학교', '고등학교', '서울'),
  ('마포고등학교', '고등학교', '서울'),
  ('용산고등학교', '고등학교', '서울'),
  ('성동고등학교', '고등학교', '서울'),
  ('광진고등학교', '고등학교', '서울'),
  ('강동고등학교', '고등학교', '서울'),
  ('강서고등학교', '고등학교', '서울'),
  ('관악고등학교', '고등학교', '서울'),
  ('구로고등학교', '고등학교', '서울'),
  ('금천고등학교', '고등학교', '서울'),
  ('노원고등학교', '고등학교', '서울'),
  ('도봉고등학교', '고등학교', '서울'),
  ('동대문고등학교', '고등학교', '서울'),
  ('양천고등학교', '고등학교', '서울'),
  ('영등포고등학교', '고등학교', '서울'),
  ('종로고등학교', '고등학교', '서울'),
  ('중랑고등학교', '고등학교', '서울'),
  -- 경기 지역
  ('수원고등학교', '고등학교', '경기'),
  ('성남고등학교', '고등학교', '경기'),
  ('부천고등학교', '고등학교', '경기'),
  ('안양고등학교', '고등학교', '경기'),
  ('안산고등학교', '고등학교', '경기'),
  ('고양고등학교', '고등학교', '경기'),
  ('용인고등학교', '고등학교', '경기'),
  ('평택고등학교', '고등학교', '경기'),
  ('의정부고등학교', '고등학교', '경기'),
  ('시흥고등학교', '고등학교', '경기'),
  ('김포고등학교', '고등학교', '경기'),
  ('광명고등학교', '고등학교', '경기'),
  ('하남고등학교', '고등학교', '경기'),
  ('오산고등학교', '고등학교', '경기'),
  ('이천고등학교', '고등학교', '경기'),
  -- 기타 광역시
  ('부산고등학교', '고등학교', '부산'),
  ('인천고등학교', '고등학교', '인천'),
  ('대구고등학교', '고등학교', '대구'),
  ('광주고등학교', '고등학교', '광주'),
  ('대전고등학교', '고등학교', '대전'),
  ('울산고등학교', '고등학교', '울산')
ON CONFLICT DO NOTHING;

-- ============================================
-- 3. 중복 데이터 제거 (일회성 작업)
-- ============================================

-- 같은 name과 type을 가진 레코드 중 가장 오래된 것(id가 가장 작은 것)을 유지하고 나머지 삭제
DO $$
DECLARE
  duplicate_record RECORD;
  keep_id uuid;
  delete_ids uuid[];
BEGIN
  -- 중복된 학교 그룹을 찾아서 처리
  FOR duplicate_record IN
    SELECT name, type, array_agg(id ORDER BY id) as ids, COUNT(*) as count
    FROM schools
    GROUP BY name, type
    HAVING COUNT(*) > 1
  LOOP
    -- 첫 번째 ID를 유지할 ID로 선택
    keep_id := duplicate_record.ids[1];
    
    -- 나머지 ID들을 삭제 대상으로 설정
    delete_ids := array_remove(duplicate_record.ids, keep_id);
    
    -- students 테이블에서 삭제 대상 ID를 참조하는 경우, 유지할 ID로 업데이트
    UPDATE students
    SET school = (
      SELECT name FROM schools WHERE id = keep_id
    )
    WHERE school IN (
      SELECT name FROM schools WHERE id = ANY(delete_ids)
    )
    AND school = duplicate_record.name;
    
    -- 중복 레코드 삭제
    DELETE FROM schools
    WHERE id = ANY(delete_ids);
    
    RAISE NOTICE '중복 제거: % (%) - 유지 ID: %, 삭제 ID: %', 
      duplicate_record.name, 
      duplicate_record.type,
      keep_id,
      array_to_string(delete_ids, ', ');
  END LOOP;
END $$;

-- ============================================
-- 4. RLS 설정 (모든 사용자가 읽기 가능)
-- ============================================

ALTER TABLE schools ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Anyone can view schools" ON schools;
CREATE POLICY "Anyone can view schools"
  ON schools
  FOR SELECT
  USING (true);

-- 관리자만 추가/수정/삭제 가능하도록 설정 (선택사항)
 DROP POLICY IF EXISTS "Admins can manage schools" ON schools;
 CREATE POLICY "Admins can manage schools"
   ON schools
   FOR ALL
   USING (
     EXISTS (
       SELECT 1 FROM admin_users
       WHERE admin_users.id = auth.uid()
     )
   );

