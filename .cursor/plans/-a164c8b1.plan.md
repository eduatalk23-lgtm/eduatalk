<!-- a164c8b1-ae2d-42c9-aa03-afeabec9b30c c39cdfe3-95fa-425c-b063-23016b265915 -->
# 강의 등록/수정 시 교재 추가 기능 구현 계획

## 1. 현재 상황 분석

### 데이터베이스 스키마

- `lectures` 테이블에 `linked_book_id` 컬럼 존재 (uuid, nullable)
- Foreign key: `lectures.linked_book_id` → `books.id` (ON DELETE SET NULL)

### 현재 구현 상태

- **강의 등록 페이지** (`app/(student)/contents/lectures/new/page.tsx`): 교재 연결 기능 없음
- **강의 수정 페이지** (`app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`): 교재 연결 기능 없음
- **강의 상세 페이지** (`app/(student)/contents/lectures/[id]/_components/LectureLinkedBookSection.tsx`): 교재 검색/등록/연결 기능 존재
- **액션 함수**:
  - `addLecture`: `linked_book_id` 처리 없음
  - `updateLecture`: `linked_book_id` 읽기는 하지만 주석 처리되어 업데이트 안 됨

### 중복 코드 발견

- 교재 목록 조회 함수가 여러 곳에 분산: `getBooks`, `fetchStudentBooks`
- 교재 등록 폼 로직이 `LectureLinkedBookSection`에 하드코딩됨

## 2. 구현 계획

### 2.1 공통 컴포넌트 생성

#### `BookSelector` 컴포넌트 생성

**위치**: `app/(student)/contents/_components/BookSelector.tsx`

**기능**:

- 기존 교재 목록 드롭다운 표시
- 교재 검색 기능 (인라인)
- "새 교재 등록" 버튼 (모달 또는 인라인 폼)
- 선택된 교재 표시 및 해제 기능

**Props**:

```typescript
type BookSelectorProps = {
  value?: string | null; // 현재 선택된 교재 ID
  onChange: (bookId: string | null) => void; // 교재 선택 변경 콜백
  studentBooks: Array<{ id: string; title: string }>; // 학생의 교재 목록
  onCreateBook?: (bookId: string) => void; // 새 교재 생성 후 콜백
  disabled?: boolean;
  className?: string;
};
```

**설계 원칙**:

- 제어 컴포넌트 패턴 사용 (controlled component)
- 재사용 가능한 독립 컴포넌트
- 기존 `LectureLinkedBookSection`의 로직을 추출하되, 강의 ID 의존성 제거

#### `BookCreateForm` 컴포넌트 생성 (선택사항)

**위치**: `app/(student)/contents/_components/BookCreateForm.tsx`

**기능**:

- 교재 등록 폼 (기존 `LectureLinkedBookSection`의 폼 로직 분리)
- `BookDetailsManager` 통합
- 성공 시 생성된 교재 ID 반환

**재사용성**:

- 강의 등록/수정 페이지에서 사용
- 강의 상세 페이지에서도 사용 가능

### 2.2 강의 등록 페이지 수정

**파일**: `app/(student)/contents/lectures/new/page.tsx`

**변경 사항**:

1. 교재 목록 조회 추가 (서버 컴포넌트로 전환 또는 클라이언트에서 조회)
2. `BookSelector` 컴포넌트 추가
3. 폼 제출 시 `linked_book_id` 포함

**구현 방법**:

```typescript
// 교재 목록 조회 (서버에서 전달 또는 클라이언트에서 조회)
const [studentBooks, setStudentBooks] = useState<Array<{ id: string; title: string }>>([]);
const [selectedBookId, setSelectedBookId] = useState<string>("");

// handleSubmit에서
if (selectedBookId) {
  formData.set("linked_book_id", selectedBookId);
}
```

### 2.3 강의 수정 페이지 수정

**파일**: `app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`

**변경 사항**:

1. 현재 연결된 교재 정보 조회 (서버 컴포넌트에서 전달)
2. `BookSelector` 컴포넌트 추가
3. 폼 제출 시 `linked_book_id` 포함

**서버 컴포넌트 수정**:

- `app/(student)/contents/lectures/[id]/edit/page.tsx`에서 교재 목록 및 연결된 교재 조회
- `LectureEditForm`에 props로 전달

### 2.4 액션 함수 수정

#### `addLecture` 함수 수정

**파일**: `app/(student)/actions/contentActions.ts`

**변경 사항**:

```typescript
const linkedBookId = String(formData.get("linked_book_id") || "");

const result = await createLectureData({
  // ... 기존 필드들
  linked_book_id: linkedBookId || null, // 추가
});
```

#### `updateLecture` 함수 수정

**파일**: `app/(student)/actions/contentActions.ts`

**변경 사항**:

```typescript
const linkedBookId = String(formData.get("linked_book_id") || "");

const result = await updateLectureData(id, user.userId, {
  // ... 기존 필드들
  linked_book_id: linkedBookId || null, // 주석 해제 및 활성화
});
```

**데이터 레이어 확인 필요**:

- `createLectureData`, `updateLectureData` 함수에서 `linked_book_id` 지원 여부 확인
- 필요 시 수정

### 2.5 중복 코드 최적화

#### 교재 목록 조회 통합

**현재 상태**:

- `lib/data/studentContents.ts`: `getBooks` 함수
- `lib/data/planContents.ts`: `fetchStudentBooks` 함수

**최적화 방안**:

- `getBooks` 함수를 기본으로 사용
- `fetchStudentBooks`는 `getBooks`를 래핑하여 사용
- 또는 공통 유틸리티 함수 생성

#### 교재 등록 폼 로직 분리

- `LectureLinkedBookSection`의 교재 등록 폼을 `BookCreateForm` 컴포넌트로 분리
- `LectureLinkedBookSection`은 `BookCreateForm`을 사용하도록 리팩토링

### 2.6 데이터 레이어 확인 및 수정

**확인 필요 파일**:

- `lib/data/lectures.ts` 또는 강의 데이터 생성/수정 함수
- `createLectureData`, `updateLectureData` 함수에서 `linked_book_id` 파라미터 지원 확인

**예상 수정**:

```typescript
// lib/data/lectures.ts 또는 해당 파일
export async function createLectureData(data: {
  // ... 기존 필드들
  linked_book_id?: string | null; // 추가
}) {
  // Supabase insert 시 linked_book_id 포함
}

export async function updateLectureData(id: string, studentId: string, data: {
  // ... 기존 필드들
  linked_book_id?: string | null; // 추가
}) {
  // Supabase update 시 linked_book_id 포함
}
```

## 3. 구현 순서

1. **데이터 레이어 확인 및 수정**

   - `createLectureData`, `updateLectureData` 함수 확인
   - `linked_book_id` 파라미터 추가

2. **공통 컴포넌트 생성**

   - `BookSelector` 컴포넌트 생성
   - `BookCreateForm` 컴포넌트 생성 (선택사항)

3. **강의 수정 페이지 수정** (기존 데이터가 있어서 테스트 용이)

   - 서버 컴포넌트에서 교재 목록 조회
   - `BookSelector` 통합
   - 액션 함수 수정

4. **강의 등록 페이지 수정**

   - 교재 목록 조회 추가
   - `BookSelector` 통합
   - 액션 함수 수정

5. **중복 코드 최적화**

   - 교재 목록 조회 함수 통합
   - `LectureLinkedBookSection` 리팩토링

6. **테스트 및 검증**

   - 강의 등록 시 교재 연결 테스트
   - 강의 수정 시 교재 변경 테스트
   - 교재 해제 테스트

## 4. 주의사항

1. **기존 기능 유지**: 강의 상세 페이지의 `LectureLinkedBookSection` 기능은 그대로 유지
2. **타입 안전성**: TypeScript 타입 정의 완료
3. **에러 처리**: 교재 연결 실패 시 적절한 에러 메시지 표시
4. **성능**: 교재 목록이 많을 경우 검색 기능 필수
5. **접근성**: 드롭다운 및 버튼에 적절한 ARIA 속성 추가

## 5. 파일 변경 목록

### 신규 생성

- `app/(student)/contents/_components/BookSelector.tsx`
- `app/(student)/contents/_components/BookCreateForm.tsx` (선택사항)

### 수정

- `app/(student)/contents/lectures/new/page.tsx`
- `app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`
- `app/(student)/contents/lectures/[id]/edit/page.tsx`
- `app/(student)/actions/contentActions.ts`
- `app/(student)/contents/lectures/[id]/_components/LectureLinkedBookSection.tsx` (리팩토링)
- `lib/data/lectures.ts` 또는 강의 데이터 함수 파일 (확인 후 수정)

### 최적화 대상

- `lib/data/studentContents.ts` (교재 목록 조회 통합)
- `lib/data/planContents.ts` (교재 목록 조회 통합)

### To-dos

- [ ] 데이터 레이어 확인: createLectureData, updateLectureData 함수에서 linked_book_id 파라미터 지원 여부 확인 및 수정
- [ ] BookSelector 공통 컴포넌트 생성: 교재 선택 드롭다운, 검색, 새 교재 등록 기능 포함
- [ ] BookCreateForm 컴포넌트 생성: 교재 등록 폼 로직을 재사용 가능한 컴포넌트로 분리
- [ ] 강의 수정 페이지 수정: 서버에서 교재 목록 조회, BookSelector 통합, linked_book_id 처리
- [ ] 강의 등록 페이지 수정: 교재 목록 조회 추가, BookSelector 통합, linked_book_id 처리
- [ ] 액션 함수 수정: addLecture와 updateLecture에서 linked_book_id 처리 활성화
- [ ] 중복 코드 최적화: 교재 목록 조회 함수 통합, LectureLinkedBookSection 리팩토링
- [ ] 테스트 및 검증: 강의 등록/수정 시 교재 연결 기능 테스트