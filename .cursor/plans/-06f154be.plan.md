<!-- 06f154be-0278-4057-aa2f-7b479732d8c1 efb980f4-77db-44df-9296-6ef9086e7043 -->
# 강의 수정 폼 교재 등록 기능 추가 및 최적화 계획

## 목표

강의 콘텐츠 수정 폼에서 교재를 등록할 수 있도록 하고, 강의 등록 폼과 동일한 사용자 경험을 제공합니다. 또한 중복 코드를 최적화합니다.

## 현재 상황 분석

### 문제점

1. **강의 수정 폼** (`app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`):

   - `BookSelector`를 사용하고 있지만, `studentBooks`가 서버에서 가져온 prop으로 전달됨
   - 교재 등록 후 `router.refresh()`만 호출하여 클라이언트 상태가 업데이트되지 않음
   - 새로 등록된 교재가 목록에 즉시 반영되지 않음

2. **강의 등록 폼** (`app/(student)/contents/lectures/new/page.tsx`):

   - `studentBooks`를 state로 관리하여 클라이언트에서 업데이트 가능
   - `onCreateBook` 콜백에서 `router.refresh()` 호출

3. **중복 코드**:

   - 두 폼 모두 `BookSelector`를 사용하지만 상태 관리 방식이 다름
   - 교재 목록 새로고침 로직이 중복될 수 있음

## 해결 방안

### 1. LectureEditForm 개선

**파일**: `app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`

**변경 사항**:

- `studentBooks`를 prop에서 받아 state로 초기화하여 클라이언트에서 업데이트 가능하도록 변경
- `onCreateBook` 콜백에서 `getStudentBooksAction`을 호출하여 목록을 새로고침
- 새로 등록된 교재를 자동으로 선택하도록 개선

**구현 세부사항**:

```typescript
// studentBooks를 state로 관리
const [studentBooks, setStudentBooks] = useState<Array<{ id: string; title: string }>>(initialStudentBooks);

// 교재 목록 새로고침 함수
async function refreshStudentBooks() {
  try {
    const books = await getStudentBooksAction();
    setStudentBooks(books);
    return books;
  } catch (error) {
    console.error("교재 목록 새로고침 실패:", error);
    return studentBooks;
  }
}

// onCreateBook 콜백 개선
onCreateBook={async (bookId) => {
  const updatedBooks = await refreshStudentBooks();
  const newBook = updatedBooks.find((b) => b.id === bookId);
  if (newBook) {
    setSelectedBookId(bookId);
  } else {
    // 목록에 없으면 router.refresh()로 서버에서 다시 가져오기
    router.refresh();
    setSelectedBookId(bookId);
  }
}}
```

### 2. 공통 로직 추출 (선택사항)

**파일**: `lib/hooks/useStudentBooks.ts` (신규 생성)

**목적**: 교재 목록 관리 로직을 공통 훅으로 추출하여 재사용성 향상

**구현 내용**:

- `useState`로 교재 목록 상태 관리
- `useEffect`로 초기 로드
- `refreshStudentBooks` 함수 제공
- `onCreateBook` 핸들러 제공

**고려사항**:

- 현재는 두 곳에서만 사용되므로 추상화가 과도할 수 있음
- 향후 다른 곳에서도 사용될 가능성이 있으면 추출 고려

### 3. 데이터베이스 스키마 확인

**확인 완료**: `books` 테이블 구조

- `id` (uuid, PK)
- `title` (text, NOT NULL)
- `student_id` (uuid, nullable)
- `tenant_id` (uuid, NOT NULL)
- `created_at` (timestamptz, nullable)

**영향**: 교재 등록 시 `student_id`와 `tenant_id`가 올바르게 설정되는지 확인 필요 (이미 `createBookWithoutRedirect`에서 처리됨)

## 구현 단계

### Step 1: LectureEditForm 수정

1. `getStudentBooksAction` import 추가
2. `studentBooks`를 state로 변경
3. `refreshStudentBooks` 함수 추가
4. `onCreateBook` 콜백 개선

### Step 2: 타입 안전성 확인

1. `getStudentBooksAction` 반환 타입 확인
2. 에러 처리 로직 추가

### Step 3: 테스트 및 검증

1. 교재 등록 후 목록이 즉시 업데이트되는지 확인
2. 새로 등록된 교재가 자동으로 선택되는지 확인
3. 에러 발생 시 적절한 처리 확인

## 최적화 고려사항

### 2025년 React 모범 사례 (웹 검색 결과 기반)

1. **서버 상태와 클라이언트 상태 분리**: 

   - 서버 상태(교재 목록)는 `getStudentBooksAction`으로 관리
   - 클라이언트 상태(선택된 교재)는 `useState`로 관리

2. **Optimistic Updates 고려**:

   - 교재 등록 후 즉시 목록에 추가하는 방식 고려
   - 현재는 서버에서 다시 가져오는 방식 사용 (데이터 일관성 보장)

3. **React Query 활용 가능성**:

   - 프로젝트에 이미 `@tanstack/react-query` 설치됨
   - 향후 교재 목록을 React Query로 관리하면 캐싱 및 자동 새로고침 가능
   - 현재는 Server Actions를 사용하므로 즉시 적용은 선택사항

## 파일 변경 목록

### 수정 파일

1. `app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`

   - `studentBooks`를 state로 관리
   - `getStudentBooksAction` import 및 사용
   - `refreshStudentBooks` 함수 추가
   - `onCreateBook` 콜백 개선

### 검토 파일 (변경 없음)

1. `app/(student)/contents/_components/BookSelector.tsx` - 이미 교재 등록 기능 포함
2. `app/(student)/actions/contentMetadataActions.ts` - `getStudentBooksAction` 이미 존재
3. `app/(student)/contents/lectures/new/page.tsx` - 참고용

## 예상 효과

1. **사용자 경험 개선**: 교재 등록 후 즉시 목록에 반영되어 선택 가능
2. **코드 일관성**: 강의 등록 폼과 수정 폼의 동작 방식 통일
3. **유지보수성**: 명확한 상태 관리로 코드 이해도 향상

## 주의사항

1. **에러 처리**: `getStudentBooksAction` 호출 실패 시 기존 목록 유지
2. **로딩 상태**: 교재 목록 새로고침 중 로딩 상태 표시 고려 (선택사항)
3. **타입 안전성**: `getStudentBooksAction` 반환 타입과 state 타입 일치 확인

### To-dos

- [ ] LectureEditForm에서 studentBooks를 state로 변경하고 getStudentBooksAction import 추가
- [ ] refreshStudentBooks 함수 구현 (getStudentBooksAction 호출 및 state 업데이트)
- [ ] onCreateBook 콜백 개선 (refreshStudentBooks 호출 및 새 교재 자동 선택)
- [ ] 에러 처리 로직 추가 및 타입 안전성 확인
- [ ] 테스트: 교재 등록 후 목록 업데이트 및 자동 선택 확인