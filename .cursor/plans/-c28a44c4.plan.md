<!-- c28a44c4-5815-48ca-b2b8-a2e6102f60c5 31602c1e-853d-481f-a707-c02a9404dab7 -->
# 교재 등록 폼 배열 필드 검증 에러 수정 계획

## 문제 분석

### 현재 상황

- **에러 메시지**: "Expected array, received string"
- **발생 위치**: `lib/validation/schemas.ts`의 `validateFormData` 함수
- **원인**: `formDataToObject` 함수가 배열 필드(`target_exam_type`, `tags`)를 처리하지 않아 문자열로 변환됨
- **데이터베이스 스키마**: `master_books.target_exam_type`과 `master_books.tags`는 PostgreSQL `ARRAY` 타입 (`_text`)
- **Zod 스키마**: `masterBookSchema`에서 `z.array(z.string()).optional().nullable()`로 정의됨

### 중복 코드 발견

- `lib/utils/formDataHelpers.ts`에 이미 `getFormArray`와 `getFormTags` 함수가 존재
- `formDataToObject`에서 이 함수들을 재사용하지 않음

## 수정 계획

### 1. `formDataToObject` 함수 개선

**파일**: `lib/validation/schemas.ts`

#### 변경 사항

1. **배열 필드 처리 로직 추가**

   - `target_exam_type`: 체크박스 그룹 → `formData.getAll()` 사용
   - `tags`: 쉼표 구분 문자열 → `split(",")` 처리

2. **기존 헬퍼 함수 재사용**

   - `getFormArray` 함수 import 및 사용
   - `getFormTags` 함수 import 및 사용

3. **확장 가능한 구조 설계**

   - 배열 필드 목록을 상수로 정의
   - 향후 다른 스키마에서도 재사용 가능하도록 구조화

#### 구현 세부사항

```typescript
// 배열 필드 타입 정의
const ARRAY_FIELDS = ['target_exam_type'] as const;
const TAG_FIELDS = ['tags'] as const;

// formDataToObject 함수 수정
export function formDataToObject(formData: FormData): Record<string, unknown> {
  const obj: Record<string, unknown> = {};
  
  // 모든 키 수집 (중복 키 처리용)
  const keys = new Set<string>();
  for (const key of formData.keys()) {
    keys.add(key);
  }
  
  for (const key of keys) {
    // 배열 필드 처리 (체크박스 그룹)
    if (ARRAY_FIELDS.includes(key as typeof ARRAY_FIELDS[number])) {
      const values = getFormArray(formData, key);
      obj[key] = values.length > 0 ? values : null;
      continue;
    }
    
    // 태그 필드 처리 (쉼표 구분 문자열)
    if (TAG_FIELDS.includes(key as typeof TAG_FIELDS[number])) {
      obj[key] = getFormTags(formData, key);
      continue;
    }
    
    // 기존 로직 (숫자, 불리언, 문자열 처리)
    // ...
  }
  
  return obj;
}
```

### 2. Import 추가

**파일**: `lib/validation/schemas.ts`

```typescript
import { getFormArray, getFormTags } from "@/lib/utils/formDataHelpers";
```

### 3. 코드 최적화

#### 중복 제거

- `formDataToObject`에서 배열 처리 로직을 직접 구현하지 않고 기존 헬퍼 함수 재사용
- 일관된 배열 처리 로직 유지

#### 타입 안전성 강화

- `as const`를 사용하여 배열 필드 목록 타입 안전성 확보
- TypeScript의 타입 체크 활용

### 4. 테스트 시나리오

#### 교재 등록 폼 테스트

1. **target_exam_type 테스트**

   - 여러 체크박스 선택 시 배열로 변환되는지 확인
   - 선택하지 않았을 때 `null`로 처리되는지 확인

2. **tags 테스트**

   - 쉼표로 구분된 태그 입력 시 배열로 변환되는지 확인
   - 빈 문자열일 때 `null`로 처리되는지 확인
   - 공백 포함 태그가 올바르게 trim되는지 확인

#### 검증 통과 확인

- `validateFormData(formData, masterBookSchema)` 호출 시 에러 없이 통과
- 서버 액션에서도 정상적으로 배열 데이터 저장

### 5. 향후 확장성 고려

#### 강의 스키마 대비

- `masterLectureSchema`에도 향후 `target_exam_type`과 `tags` 필드가 추가될 수 있음
- 현재 수정으로 자동으로 처리됨

#### 다른 배열 필드 추가 시

- `ARRAY_FIELDS` 또는 `TAG_FIELDS` 배열에 필드명만 추가하면 됨
- 코드 변경 최소화

## 수정 파일 목록

1. **`lib/validation/schemas.ts`**

   - `formDataToObject` 함수 수정
   - `getFormArray`, `getFormTags` import 추가
   - 배열 필드 처리 로직 추가

## 검증 방법

1. 교재 등록 페이지에서 폼 제출
2. 여러 시험 유형 체크박스 선택
3. 태그 필드에 쉼표로 구분된 값 입력
4. "Expected array, received string" 에러가 발생하지 않는지 확인
5. 데이터베이스에 배열로 저장되는지 확인

## 참고 사항

- 데이터베이스 스키마: `master_books.target_exam_type`과 `master_books.tags`는 `ARRAY` 타입
- 기존 파싱 로직: `parseMasterBookFormData`에서는 이미 올바르게 처리되고 있음
- 문제는 클라이언트 사이드 검증 단계에서만 발생