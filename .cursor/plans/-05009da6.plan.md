<!-- 05009da6-1973-415a-ad1a-0746125b7a9d 4718e215-7519-4dfd-8551-6ef64a07d27f -->
# 강의 수정 폼 교재 등록/연결 기능 개선 계획

## 문제 분석

### 현재 상황

1. **강의 등록 폼** (`MasterLectureForm.tsx`): 간단한 처리

   - `onCreateBook`에서 `refreshMasterBooks()` 후 `setSelectedBookId` 호출

2. **강의 수정 폼** (`MasterLectureEditForm.tsx`): 복잡한 처리

   - `onCreateBook`에서 `find` 체크, `router.refresh()` 등 불필요한 로직

3. **BaseBookSelector**: `onChange`와 `onCreateBook` 호출 순서 문제

   - `onChange`를 먼저 호출하여 목록에 없을 때 UI 표시 문제 발생

### 중복 코드

- `refreshMasterBooks` 함수가 두 폼에 동일하게 중복됨

## 해결 방안

### 1. BaseBookSelector 개선

**파일**: `components/forms/BaseBookSelector.tsx`

**변경사항**:

- `onChange`를 먼저 호출하지 않고, `onCreateBook`을 `await`로 먼저 실행
- `onCreateBook`이 없을 때만 `onChange` 호출
- 목록 새로고침 후 선택하도록 보장

**코드 위치**: `handleCreateAndSelect` 함수 (133-153줄)

### 2. 강의 수정 폼 단순화

**파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`

**변경사항**:

- `onCreateBook` 콜백을 강의 등록 폼과 동일하게 단순화
- 불필요한 `find` 체크 및 `router.refresh()` 제거
- `refreshMasterBooks()` 후 바로 `setSelectedBookId` 호출

**코드 위치**: `onCreateBook` 콜백 (250-262줄)

### 3. 중복 코드 제거 (선택사항)

**옵션 A**: 커스텀 훅 생성

- `lib/hooks/useMasterBooksRefresh.ts` 생성
- `refreshMasterBooks` 로직을 훅으로 추출

**옵션 B**: 유틸리티 함수 생성

- `lib/utils/masterBooksUtils.ts` 생성
- 공통 로직을 유틸리티로 추출

**권장**: 옵션 A (커스텀 훅) - 상태 관리가 포함되므로 훅이 적합

## 구현 상세

### Phase 1: BaseBookSelector 수정

```typescript
// components/forms/BaseBookSelector.tsx
const handleCreateAndSelect = useCallback(async () => {
  setIsCreating(true);
  
  try {
    // ... validation and formData creation ...
    
    const result = await createBookAction(formData);
    
    if (result.success && result.bookId) {
      showSuccess(`${bookTypeLabel}가 성공적으로 등록되었습니다.`);
      
      // 상태 초기화
      setBookDetails([]);
      setSelectedRevisionId("");
      setSelectedSubjectGroupId("");
      setSelectedSubjectId("");
      setSelectedPublisherId("");
      
      // onCreateBook을 먼저 await하여 목록 새로고침 후 선택
      if (onCreateBook) {
        await onCreateBook(result.bookId);
      } else {
        // onCreateBook이 없으면 직접 onChange 호출
        onChange(result.bookId);
      }
      
      setIsCreating(false);
    }
  } catch (error) {
    // ... error handling ...
  }
}, [/* dependencies */]);
```

### Phase 2: 강의 수정 폼 단순화

```typescript
// app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx
<MasterBookSelector
  value={selectedBookId}
  onChange={setSelectedBookId}
  masterBooks={masterBooks}
  onCreateBook={async (bookId) => {
    // 새 교재 생성 후 목록 새로고침
    const updatedBooks = await refreshMasterBooks();
    setSelectedBookId(bookId);
  }}
/>
```

### Phase 3: 중복 코드 제거 (선택사항)

```typescript
// lib/hooks/useMasterBooksRefresh.ts
export function useMasterBooksRefresh(
  initialBooks: Array<{ id: string; title: string }>
) {
  const [masterBooks, setMasterBooks] = useState(initialBooks);
  
  const refreshMasterBooks = useCallback(async () => {
    try {
      const books = await getMasterBooksListAction();
      setMasterBooks(books);
      return books;
    } catch (error) {
      console.error("교재 목록 새로고침 실패:", error);
      return masterBooks;
    }
  }, [masterBooks]);
  
  return { masterBooks, refreshMasterBooks };
}
```

## 데이터 흐름

```
사용자: "새 교재 등록" 클릭
  ↓
BaseBookSelector: handleCreateAndSelect 실행
  ↓
createBookAction: 교재 생성 (DB 저장)
  ↓
onCreateBook 콜백 호출 (await)
  ↓
refreshMasterBooks: 목록 새로고침
  ↓
setSelectedBookId: 선택 상태 업데이트
  ↓
UI: 새 교재 표시 및 선택됨
  ↓
사용자: "변경사항 저장" 클릭
  ↓
handleSubmit: selectedBookId를 FormData에 추가
  ↓
updateMasterLectureAction: DB에 연결 저장
```

## 테스트 시나리오

1. 새 교재 등록 후 자동 선택 확인
2. 교재 등록 중 버튼 비활성화 확인
3. 교재 등록 후 목록에 표시 확인
4. "변경사항 저장" 후 연결 저장 확인
5. 강의 등록 폼과 동일한 동작 확인

## 파일 목록

### 수정 파일

- `components/forms/BaseBookSelector.tsx`
- `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`

### 생성 파일 (선택사항)

- `lib/hooks/useMasterBooksRefresh.ts`

### 참고 파일

- `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx` (참고용)
- `app/(student)/actions/masterContentActions.ts` (Server Action)
- `lib/utils/masterContentFormHelpers.ts` (FormData 파싱)