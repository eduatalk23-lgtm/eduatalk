<!-- 6d47921e-ea55-4f3d-8016-e8cee3f4ce37 08692456-0270-4ca4-9d0c-207b92627f7a -->
# 마스터 콘텐츠 CRUD 최적화 계획

## 작업 개요

마스터 콘텐츠 관련 등록/수정 폼의 중복 코드를 제거하고, 일관성을 개선하며, 2025년 최신 모범 사례를 적용하여 전면적으로 최적화합니다.

## 발견된 문제점

### 1. 중복 코드 문제

#### 1.1 FormData 파싱 유틸리티 중복

- `lib/utils/formData.ts`: `parseFormString`, `parseFormNumber` 등 제공
- `lib/utils/formDataHelpers.ts`: `getFormString`, `getFormInt`, `getFormUuid` 등 제공
- **문제**: 두 파일이 유사한 기능을 제공하지만 다른 네이밍과 인터페이스 사용
- **해결**: 통합하여 단일 파일로 정리

#### 1.2 마스터 교재/강의 FormData 파싱 중복

- `app/(student)/actions/masterContentActions.ts`에서 직접 FormData 파싱
- 약 200줄 이상의 중복 파싱 로직
- **문제**: 마스터 커스텀 콘텐츠는 헬퍼 함수 사용, 교재/강의는 직접 파싱
- **해결**: 교재/강의용 헬퍼 함수 생성 (`parseMasterBookFormData`, `parseMasterLectureFormData`)

### 2. 일관성 문제

#### 2.1 MasterLectureEditForm 개선 필요

- **위치**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`
- **문제점**:
- `alert` 사용 (다른 폼은 `useToast` 사용)
- 클라이언트 사이드 Zod 검증 없음
- `FormField`/`FormSelect` 미사용 (직접 `input`/`select` 사용)
- `useTransition` 사용 (Next.js 15 권장: `useActionState`)

#### 2.2 에러 처리 불일치

- 마스터 커스텀 콘텐츠: `withErrorHandling` + `AppError` 사용
- 마스터 교재/강의: 직접 `throw new Error` 사용
- **해결**: 모든 마스터 콘텐츠 액션에 `withErrorHandling` 적용

### 3. 데이터베이스 스키마 확인

Supabase MCP로 확인한 결과:

- `master_books`: 40개 컬럼 (공통 필드 + 교재 전용 필드)
- `master_lectures`: 28개 컬럼 (공통 필드 + 강의 전용 필드)
- `master_custom_contents`: 15개 컬럼 (최소 필드만)
- **공통 필드**: `title`, `curriculum_revision_id`, `subject_id`, `subject_group_id`, `subject_category`, `subject`, `difficulty_level`, `notes`, `content_category`, `revision`, `tenant_id`, `created_at`, `updated_at`

## 구현 계획

### Phase 1: FormData 파싱 유틸리티 통합

#### 1.1 formDataHelpers.ts 확장 및 통합

- **파일**: `lib/utils/formDataHelpers.ts`
- **작업**:
- `formData.ts`의 기능을 `formDataHelpers.ts`로 통합
- 네이밍 통일: `getFormString`, `getFormInt`, `getFormUuid`, `getFormArray`, `getFormTags` 유지
- 추가 함수: `getFormBoolean`, `getFormDate` 등 필요 함수 추가
- `formData.ts`는 deprecated 표시 후 제거 예정

#### 1.2 마스터 교재 FormData 파싱 헬퍼 생성

- **파일**: `lib/utils/masterContentFormHelpers.ts` (기존 파일 확장)
- **함수 추가**:
- `parseMasterBookFormData(formData: FormData, tenantId: string | null)`: 생성용
- `parseMasterBookUpdateFormData(formData: FormData)`: 수정용
- **기능**:
- 모든 교재 필드 파싱 (40개 필드)
- `target_exam_type` 배열 처리
- `tags` 배열 처리
- `formDataHelpers.ts` 함수 활용

#### 1.3 마스터 강의 FormData 파싱 헬퍼 생성

- **파일**: `lib/utils/masterContentFormHelpers.ts` (기존 파일 확장)
- **함수 추가**:
- `parseMasterLectureFormData(formData: FormData, tenantId: string | null)`: 생성용
- `parseMasterLectureUpdateFormData(formData: FormData)`: 수정용
- **기능**:
- 모든 강의 필드 파싱 (28개 필드)
- `total_duration` 분→초 변환 처리
- `formDataHelpers.ts` 함수 활용

### Phase 2: 마스터 교재/강의 액션 개선

#### 2.1 addMasterBook 리팩토링

- **파일**: `app/(student)/actions/masterContentActions.ts`
- **변경 사항**:
- `parseMasterBookFormData` 사용
- `withErrorHandling` 적용
- `requireAdminOrConsultant` 사용
- `getTenantContext` 사용
- `AppError` 사용

#### 2.2 updateMasterBookAction 리팩토링

- **파일**: `app/(student)/actions/masterContentActions.ts`
- **변경 사항**:
- `parseMasterBookUpdateFormData` 사용
- `withErrorHandling` 적용
- `requireAdminOrConsultant` 사용
- `AppError` 사용

#### 2.3 addMasterLecture 리팩토링

- **파일**: `app/(student)/actions/masterContentActions.ts`
- **변경 사항**:
- `parseMasterLectureFormData` 사용
- `withErrorHandling` 적용
- `requireAdminOrConsultant` 사용
- `getTenantContext` 사용
- `AppError` 사용

#### 2.4 updateMasterLectureAction 리팩토링

- **파일**: `app/(student)/actions/masterContentActions.ts`
- **변경 사항**:
- `parseMasterLectureUpdateFormData` 사용
- `withErrorHandling` 적용
- `requireAdminOrConsultant` 사용
- `AppError` 사용

### Phase 3: MasterLectureEditForm 개선

#### 3.1 에러 처리 개선

- **파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`
- **변경 사항**:
- `alert` → `useToast`로 변경
- `showSuccess`, `showError` 사용

#### 3.2 클라이언트 사이드 검증 추가

- **파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`
- **변경 사항**:
- `masterLectureSchema`로 FormData 검증
- `validateFormData` 함수 사용
- 검증 실패 시 Toast로 에러 표시

#### 3.3 FormField/FormSelect 컴포넌트 사용

- **파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`
- **변경 사항**:
- 직접 `input`/`select` → `FormField`/`FormSelect`로 교체
- 일관된 스타일링 적용

#### 3.4 useActionState 패턴 적용 (선택사항)

- **참고**: 다른 폼에서 `useActionState` 사용 예시 확인됨
- **고려사항**: 현재 `useTransition` 패턴도 유효하나, Next.js 15 권장사항에 따라 `useActionState` 검토
- **우선순위**: 낮음 (기능 동작 중이므로 선택적 개선)

### Phase 4: 코드 정리 및 문서화

#### 4.1 formData.ts 제거

- **파일**: `lib/utils/formData.ts`
- **작업**: 
- 모든 import 경로를 `formDataHelpers.ts`로 변경
- 파일 삭제

#### 4.2 중복 코드 제거 확인

- `app/(student)/actions/masterContentActions.ts`에서 직접 파싱 코드 제거
- 헬퍼 함수 사용으로 대체

#### 4.3 문서 업데이트

- **파일**: `docs/2025-02-15-master-content-crud-optimization.md` 업데이트
- **내용**: 
- 새로운 헬퍼 함수 추가 사항
- 일관성 개선 사항
- 코드 중복 제거 결과

## 예상 효과

### 코드 중복 제거

- 약 300줄 이상의 중복 코드 제거
- FormData 파싱 로직 통합

### 일관성 향상

- 모든 마스터 콘텐츠 폼에서 동일한 패턴 사용
- 에러 처리 통일
- UI 컴포넌트 통일

### 유지보수성 향상

- 헬퍼 함수로 로직 중앙화
- 스키마 변경 시 한 곳만 수정
- 타입 안전성 향상

## 구현 순서

1. **Phase 1**: FormData 파싱 유틸리티 통합 및 확장
2. **Phase 2**: 마스터 교재/강의 액션 리팩토링
3. **Phase 3**: MasterLectureEditForm 개선
4. **Phase 4**: 코드 정리 및 문서화

## 참고 파일

### 수정 대상 파일

- `lib/utils/formDataHelpers.ts` (확장)
- `lib/utils/masterContentFormHelpers.ts` (확장)
- `app/(student)/actions/masterContentActions.ts` (리팩토링)
- `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx` (개선)

### 제거 예정 파일

- `lib/utils/formData.ts` (기능 통합 후 제거)

### 참고 파일

- `app/(admin)/actions/masterCustomContentActions.ts` (모범 사례 참고)
- `app/(admin)/admin/master-custom-contents/new/MasterCustomContentForm.tsx` (모범 사례 참고)
- `app/(admin)/admin/master-custom-contents/[id]/edit/MasterCustomContentEditForm.tsx` (모범 사례 참고)
- `lib/validation/schemas.ts` (Zod 스키마)
- `lib/errors/index.ts` (에러 처리 유틸리티)
- `lib/auth/requireAdminOrConsultant.ts` (권한 체크)

## 주의사항

1. **기존 동작 유지**: 리팩토링 시 기존 기능이 정상 동작하는지 확인
2. **타입 안전성**: 모든 FormData 파싱에 타입 정의 유지
3. **에러 처리**: `withErrorHandling` 적용 시 기존 에러 메시지 유지
4. **테스트**: 각 Phase 완료 후 수동 테스트 수행