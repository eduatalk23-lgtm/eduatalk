<!-- 97539b8d-ad44-4afa-957a-dddecab5ed23 281c8b99-f641-4cdc-9b06-48ccf21a68a9 -->
# 관리자 강의 폼 교재 선택 기능 최적화 계획

## 목표

1. BookSelector와 MasterBookSelector의 중복 코드 제거
2. form 중첩 문제 해결 (BookSelector도 div 기반으로 변경)
3. 공통 컴포넌트 추출로 유지보수성 향상
4. 타입 안전성 및 성능 최적화

## 현재 상황 분석

### 중복 코드 문제

- `BookSelector`와 `MasterBookSelector`는 약 90% 이상 동일한 코드 구조
- 차이점:
  - 데이터 소스: `studentBooks` vs `masterBooks`
  - Server Action: `createBookWithoutRedirect` vs `createMasterBookWithoutRedirect`
  - Form 처리: `BookSelector`는 `<form>` 사용, `MasterBookSelector`는 `<div>` + `useRef` 사용

### Form 중첩 문제

- `BookSelector`는 `<form>` 태그를 사용하여 부모 form과 중첩될 수 있음
- `MasterBookSelector`는 이미 해결됨 (div + useRef 패턴)

### 사용 위치

- `BookSelector`: 학생 강의 수정 폼 (`app/(student)/contents/lectures/[id]/edit/LectureEditForm.tsx`)
- `MasterBookSelector`: 관리자 강의 수정 폼 (`app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`)
- 관리자 강의 등록 폼 (`app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx`)에는 아직 교재 선택 기능이 없음

## 구현 계획

### 1단계: 공통 컴포넌트 추출

#### 1.1 BaseBookSelector 컴포넌트 생성

- 위치: `components/forms/BaseBookSelector.tsx`
- 역할: BookSelector와 MasterBookSelector의 공통 로직 추출
- Props:
  ```typescript
  type BaseBookSelectorProps = {
    value?: string | null;
    onChange: (bookId: string | null) => void;
    books: Array<{ id: string; title: string }>;
    onCreateBook?: (bookId: string) => void;
    createBookAction: (formData: FormData) => Promise<{ success: boolean; bookId?: string; error?: string }>;
    disabled?: boolean;
    className?: string;
    bookTypeLabel?: string; // "교재" 또는 "마스터 교재"
  };
  ```


#### 1.2 Form 처리 통일

- 두 컴포넌트 모두 div + useRef 패턴 사용
- `BookSelector`의 form 태그를 div로 변경
- FormData 수집 로직 통합

### 2단계: BookSelector 리팩토링

#### 2.1 BaseBookSelector 사용

- `app/(student)/contents/_components/BookSelector.tsx` 수정
- BaseBookSelector를 래핑하여 studentBooks 전용 인터페이스 제공
- `createBookWithoutRedirect` 액션 전달

#### 2.2 Form 중첩 문제 해결

- `<form>` 태그를 `<div>`로 변경
- `useRef`를 사용하여 FormData 수집
- 제출 버튼을 `type="button"`으로 변경하고 `onClick` 핸들러 추가

### 3단계: MasterBookSelector 리팩토링

#### 3.1 BaseBookSelector 사용

- `app/(admin)/admin/master-lectures/_components/MasterBookSelector.tsx` 수정
- BaseBookSelector를 래핑하여 masterBooks 전용 인터페이스 제공
- `createMasterBookWithoutRedirect` 액션 전달

### 4단계: 관리자 강의 등록 폼에 교재 선택 추가

#### 4.1 MasterLectureForm 수정

- `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx` 수정
- 현재는 체크박스만 있음 (`linkBook` 상태)
- MasterBookSelector 컴포넌트 추가
- `getMasterBooksListAction`으로 초기 목록 로드
- 교재 선택 시 `linked_book_id`를 FormData에 추가

### 5단계: 성능 최적화

#### 5.1 React.memo 적용

- BaseBookSelector를 React.memo로 감싸기
- 불필요한 리렌더링 방지

#### 5.2 useCallback 적용

- 핸들러 함수들을 useCallback으로 메모이제이션
- `handleSelectBook`, `handleUnselectBook`, `handleCreateAndSelect` 등

#### 5.3 useMemo 적용

- `filteredBooks` 계산 결과 메모이제이션
- 검색 쿼리가 변경될 때만 재계산

### 6단계: 타입 안전성 개선

#### 6.1 공통 타입 정의

- `lib/types/bookSelector.ts` 생성
- BookSelector 관련 타입 통합

#### 6.2 Server Action 타입 통일

- `createBookWithoutRedirect`와 `createMasterBookWithoutRedirect`의 반환 타입 통일
- 공통 타입 정의: `BookCreateResult`

### 7단계: 테스트 및 문서화

#### 7.1 테스트

- 학생 강의 수정 폼에서 교재 선택/등록 테스트
- 관리자 강의 수정 폼에서 교재 선택/등록 테스트
- 관리자 강의 등록 폼에서 교재 선택/등록 테스트
- Form 중첩 문제 해결 확인

#### 7.2 문서화

- `docs/2025-12-16-book-selector-refactoring.md` 작성
- 변경 사항 및 최적화 내용 기록

## 파일 변경 목록

### 신규 파일

- `components/forms/BaseBookSelector.tsx` - 공통 컴포넌트
- `lib/types/bookSelector.ts` - 공통 타입 정의
- `docs/2025-12-16-book-selector-refactoring.md` - 문서

### 수정 파일

- `app/(student)/contents/_components/BookSelector.tsx` - BaseBookSelector 사용, form → div 변경
- `app/(admin)/admin/master-lectures/_components/MasterBookSelector.tsx` - BaseBookSelector 사용
- `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx` - 교재 선택 기능 추가
- `app/(admin)/admin/master-lectures/new/page.tsx` - masterBooks 목록 전달 추가 (필요시)

## 참고 사항

### React Hook Form 모범 사례

- React Hook Form은 nested forms를 지원하지 않음
- FormProvider를 사용하거나 독립적인 form으로 분리해야 함
- 현재 구현은 div + useRef 패턴으로 해결 (권장 방식)

### 데이터베이스 스키마

- `master_lectures.linked_book_id` (uuid, nullable) - FK to master_books.id
- `lectures.linked_book_id` (uuid, nullable) - FK to books.id

### 성능 고려사항

- 교재 목록은 서버에서 초기 로드 후 클라이언트 상태로 관리
- 새 교재 생성 시 목록 새로고침 필요
- 검색은 클라이언트 사이드 필터링 사용 (현재 구현 유지)

### To-dos

- [ ] BaseBookSelector 공통 컴포넌트 생성 (div + useRef 패턴, 공통 로직 추출)
- [ ] BookSelector를 BaseBookSelector 기반으로 리팩토링 (form → div 변경)
- [ ] MasterBookSelector를 BaseBookSelector 기반으로 리팩토링
- [ ] 관리자 강의 등록 폼에 MasterBookSelector 추가
- [ ] 성능 최적화 (React.memo, useCallback, useMemo 적용)
- [ ] 공통 타입 정의 및 타입 안전성 개선
- [ ] 테스트 및 문서화