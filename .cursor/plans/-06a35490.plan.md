<!-- 06a35490-95a5-4b7e-827a-3f77484cb049 da46cba4-c506-4181-a74d-109ae0a69982 -->
# 마스터 콘텐츠 교재 폼 수정 계획

## 문제점 분석

### 1. 교과 그룹, 과목 필드 활성화 문제

- **원인**: `useSubjectSelection` 훅의 `handleCurriculumRevisionChange`에서 비동기 `loadSubjectGroups` 호출 후 상태 업데이트 타이밍 문제
- **현상**: 개정교육과정 선택 후에도 교과 그룹/과목 필드가 비활성화 상태 유지

### 2. 교재 목차, 대단원 필드 텍스트 수정 오류

- **원인**: `BookDetailsManager`에서 대단원명 input이 button 내부에 있어 이벤트 전파 문제
- **현상**: 대단원명 수정 시 토글 동작이 함께 발생

### 3. 검증 로직 가이드 부족

- **원인**: `masterBookSchema`에서 대부분 필드가 optional이지만 UI에 필수 필드 안내 없음
- **현상**: 사용자가 어떤 필드를 입력해야 하는지 파악 어려움

### 4. 중복 코드

- 출판사 관련 로직이 `MasterBookForm`과 `MasterBookEditForm`에 중복
- 폼 구조가 유사하지만 공통 컴포넌트로 추출되지 않음

## 수정 계획

### Phase 1: 교과/과목 필드 활성화 문제 해결

#### 1.1 `useSubjectSelection` 훅 개선

**파일**: `lib/hooks/useSubjectSelection.ts`

- `handleCurriculumRevisionChange`에서 상태 업데이트 순서 개선
- `selectedRevisionId`를 먼저 설정한 후 `loadSubjectGroups` 호출
- 에러 처리 및 로딩 상태 관리 개선
```typescript
// 수정 전: 비동기 처리 후 상태 업데이트
const handleCurriculumRevisionChange = useCallback(async (e) => {
  const revisionName = e.target.value;
  const selectedRevision = curriculumRevisions.find(r => r.name === revisionName);
  
  if (selectedRevision) {
    setSelectedRevisionId(selectedRevision.id);
    await loadSubjectGroups(selectedRevision.id); // 비동기 완료 전에 상태가 반영되지 않을 수 있음
  }
}, []);

// 수정 후: 상태를 먼저 업데이트하고 비동기 처리
const handleCurriculumRevisionChange = useCallback(async (e) => {
  const revisionName = e.target.value;
  const selectedRevision = curriculumRevisions.find(r => r.name === revisionName);
  
  // 초기화 먼저 수행
  setSelectedGroupId("");
  setSelectedSubjectId("");
  setSelectedSubjects([]);
  
  if (selectedRevision) {
    // 상태를 먼저 업데이트하여 필드 활성화
    setSelectedRevisionId(selectedRevision.id);
    setLoadingGroups(true);
    
    try {
      await loadSubjectGroups(selectedRevision.id);
    } catch (error) {
      console.error("교과 그룹 로드 실패:", error);
      setSubjectGroups([]);
    } finally {
      setLoadingGroups(false);
    }
  } else {
    setSelectedRevisionId("");
    setSubjectGroups([]);
    setLoadingGroups(false);
  }
}, [curriculumRevisions, loadSubjectGroups]);
```


#### 1.2 `SubjectSelectionFields` 컴포넌트 개선

**파일**: `components/forms/SubjectSelectionFields.tsx`

- `disabled` 조건 명확화
- 로딩 상태 표시 개선
- 디버깅을 위한 로그 추가 (개발 환경에서만)

### Phase 2: 교재 목차 대단원 필드 수정 오류 해결

#### 2.1 `BookDetailsManager` 컴포넌트 구조 개선

**파일**: `app/(student)/contents/_components/BookDetailsManager.tsx`

- 대단원명 input을 button 외부로 분리
- 이벤트 전파 방지 로직 개선 (`onFocus`, `onMouseDown` 추가)
- 구조 재설계로 접근성 향상
```tsx
// 수정 전: input이 button 내부
<button onClick={() => toggleGroup(group.majorUnit)}>
  <input
    type="text"
    value={...}
    onChange={...}
    onClick={(e) => e.stopPropagation()} // 부족함
  />
</button>

// 수정 후: input을 button과 분리
<div className="flex items-center gap-2">
  <button onClick={() => toggleGroup(group.majorUnit)}>
    <span>{isExpanded ? "▼" : "▶"}</span>
  </button>
  <input
    type="text"
    value={...}
    onChange={...}
    onFocus={(e) => e.stopPropagation()}
    onMouseDown={(e) => e.stopPropagation()}
    onClick={(e) => e.stopPropagation()}
  />
</div>
```


### Phase 3: 검증 로직 가이드 개선

#### 3.1 필수 필드 안내 컴포넌트 추가

**파일**: `app/(admin)/admin/master-books/new/MasterBookForm.tsx`

**파일**: `app/(admin)/admin/master-books/[id]/edit/MasterBookEditForm.tsx`

- 폼 상단에 필수 필드 안내 섹션 추가
- 시각적 구분을 위한 스타일 적용
```tsx
{/* 필수 입력 항목 안내 */}
<div className="rounded-md bg-blue-50 border border-blue-200 p-3 md:col-span-2">
  <p className="text-sm text-blue-800 font-medium mb-2">필수 입력 항목</p>
  <ul className="text-xs text-blue-700 space-y-1 list-disc list-inside">
    <li>교재명</li>
  </ul>
  <p className="text-sm text-blue-800 font-medium mt-3 mb-2">권장 입력 항목</p>
  <ul className="text-xs text-blue-700 space-y-1 list-disc list-inside">
    <li>개정교육과정, 교과 그룹, 과목</li>
    <li>출판사</li>
  </ul>
</div>
```


#### 3.2 검증 에러 메시지 개선

**파일**: `lib/validation/schemas.ts`

- 필수 필드에 대한 명확한 에러 메시지
- 필드별 검증 규칙 명시
```typescript
export const masterBookSchema = z.object({
  title: z.string().min(1, "교재명을 입력해주세요.").max(200, "교재명은 200자 이하여야 합니다."),
  // ... 나머지 필드
});
```


### Phase 4: 중복 코드 최적화

#### 4.1 출판사 선택 로직 공통화

**파일**: `components/forms/PublisherSelectField.tsx` (신규 생성)

- 출판사 선택 및 `publisher_name` 자동 설정 로직을 공통 컴포넌트로 추출
- `MasterBookForm`과 `MasterBookEditForm`에서 재사용
```tsx
type PublisherSelectFieldProps = {
  publishers: Publisher[];
  defaultValue?: string;
  defaultPublisherName?: string;
};

export function PublisherSelectField({
  publishers,
  defaultValue = "",
  defaultPublisherName = "",
}: PublisherSelectFieldProps) {
  return (
    <>
      <FormSelect
        label="출판사"
        name="publisher_id"
        defaultValue={defaultValue}
        options={[
          { value: "", label: "선택하세요" },
          ...publishers.map((publisher) => ({
            value: publisher.id,
            label: publisher.name,
          })),
        ]}
        onChange={(e) => {
          const selectedPublisher = publishers.find(p => p.id === e.target.value);
          const publisherNameInput = document.querySelector('input[name="publisher_name"]') as HTMLInputElement;
          if (publisherNameInput && selectedPublisher) {
            publisherNameInput.value = selectedPublisher.name;
          }
        }}
      />
      <input
        type="hidden"
        name="publisher_name"
        defaultValue={defaultPublisherName}
      />
    </>
  );
}
```


#### 4.2 폼 필드 그룹 컴포넌트 추출 (선택사항)

- 반복되는 필드 그룹을 컴포넌트로 추출하여 유지보수성 향상

## 구현 순서

1. **Phase 1**: 교과/과목 필드 활성화 문제 해결 (최우선)
2. **Phase 2**: 대단원 필드 수정 오류 해결
3. **Phase 3**: 검증 가이드 개선
4. **Phase 4**: 중복 코드 최적화

## 테스트 체크리스트

- [ ] 개정교육과정 선택 시 교과 그룹 필드가 즉시 활성화되는지 확인
- [ ] 교과 그룹 선택 시 과목 필드가 즉시 활성화되는지 확인
- [ ] 대단원명 수정 시 토글 동작이 발생하지 않는지 확인
- [ ] 필수 필드 안내가 명확하게 표시되는지 확인
- [ ] 검증 에러 메시지가 명확한지 확인
- [ ] 출판사 선택 시 `publisher_name`이 자동 설정되는지 확인