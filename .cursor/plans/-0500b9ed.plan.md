<!-- 0500b9ed-04eb-4e6c-ad35-0f637d49a366 95cad0a4-e5a0-46b9-9613-535292a35336 -->
# 플랜 생성 콘텐츠 배치 및 학습 분량 검토 개선 계획

## 목표

1. 중복 코드 제거 및 통합
2. 강의 소요시간 계산 정확도 향상 (episode별 duration 사용)
3. 소요시간 계산 로직 통합
4. Bin Packing 알고리즘 최적화
5. 학습 분량 검증 강화

## 1. 중복 코드 통합

### 1.1 시간 변환 함수 통합

**현재 상태**: `timeToMinutes`, `minutesToTime` 함수가 39개 파일에 중복

**대상 파일**:

- `lib/plan/assignPlanTimes.ts` (65-75줄)
- `lib/scheduler/SchedulerEngine.ts` (66-78줄)
- `lib/plan/scheduler.ts` (540-552줄)
- `app/(student)/plan/new-group/_components/_features/scheduling/components/scheduleUtils.ts` (26-35줄)
- 기타 35개 파일

**작업**:

- `lib/utils/time.ts` 파일 생성하여 공통 함수 제공
- 모든 파일에서 공통 함수 import하여 사용
- 기존 함수는 deprecated 표시 후 제거

### 1.2 소요시간 계산 함수 통합

**현재 상태**: 3개의 유사한 함수가 서로 다른 로직 사용

**대상 함수**:

1. `lib/plan/scheduler.ts::calculateContentDuration` (560-597줄)
2. `lib/scheduler/SchedulerEngine.ts::calculateContentDuration` (83-124줄)
3. `lib/plan/assignPlanTimes.ts::calculatePlanEstimatedTime` (85-134줄)
4. `app/(student)/plan/new-group/_components/_features/scheduling/components/scheduleUtils.ts::calculateEstimatedTime` (76-129줄)
5. `app/(student)/plan/new-group/_components/utils/scheduleTransform.ts::calculateEstimatedTime` (192-253줄)

**작업**:

- `lib/plan/contentDuration.ts` 파일 생성하여 통합 함수 제공
- 강의 episode별 duration 조회 로직 추가
- 모든 파일에서 통합 함수 사용

## 2. 강의 소요시간 계산 개선

### 2.1 Episode별 Duration 조회

**현재 문제**:

- `lectures.duration` 또는 `master_lectures.total_duration`을 전체 회차로 나눠서 계산
- 실제 회차별 소요시간이 다를 수 있음

**개선 방안**:

- `loadContentDurations` 함수에서 episode 정보 조회 추가
- `ContentDurationInfo` 타입에 `episodes` 필드 추가
- 소요시간 계산 시 episode별 duration 합산

**대상 파일**:

- `lib/plan/contentResolver.ts::loadContentDurations` (381-618줄)
- `lib/plan/generators/planDataPreparer.ts::prepareContentDuration` (319-479줄)

**데이터베이스 쿼리**:

```sql
-- 학생 강의 episode 조회
SELECT id, episode_number, duration 
FROM student_lecture_episodes 
WHERE lecture_id = $1 
  AND episode_number BETWEEN $2 AND $3
ORDER BY episode_number;

-- 마스터 강의 episode 조회 (fallback)
SELECT id, episode_number, duration 
FROM lecture_episodes 
WHERE lecture_id = $1 
  AND episode_number BETWEEN $2 AND $3
ORDER BY episode_number;
```

### 2.2 ContentDurationInfo 타입 확장

**현재 타입** (`lib/plan/assignPlanTimes.ts`):

```typescript
export type ContentDurationInfo = {
  content_type: ContentType;
  content_id: string;
  total_pages?: number | null;
  duration?: number | null;
  total_page_or_time?: number | null;
};
```

**개선된 타입**:

```typescript
export type ContentDurationInfo = {
  content_type: ContentType;
  content_id: string;
  total_pages?: number | null;
  duration?: number | null; // 전체 강의 시간 (fallback용)
  total_page_or_time?: number | null;
  episodes?: Array<{
    episode_number: number;
    duration: number | null; // 회차별 소요시간 (분)
  }> | null; // 강의 episode별 duration 정보
};
```

## 3. 소요시간 계산 로직 통합

### 3.1 통합 함수 생성

**파일**: `lib/plan/contentDuration.ts` (신규)

**함수 시그니처**:

```typescript
export function calculateContentDuration(
  content: {
    content_type: "book" | "lecture" | "custom";
    content_id: string;
    start_range: number;
    end_range: number;
  },
  durationInfo: ContentDurationInfo,
  dayType?: "학습일" | "복습일"
): number
```

**계산 로직**:

- **강의**: episode별 duration 합산 (있으면), 없으면 전체 duration / 전체 회차 * 배정 회차
- **책**: 페이지 수 * (60 / pagesPerHour)
- **커스텀**: total_page_or_time >= 100이면 페이지로 간주, 아니면 시간으로 간주
- **복습일**: 학습일 대비 50% 단축

### 3.2 기존 함수 교체

**대상 파일 및 함수**:

1. `lib/plan/scheduler.ts::calculateContentDuration` → 통합 함수 사용
2. `lib/scheduler/SchedulerEngine.ts::calculateContentDuration` → 통합 함수 사용
3. `lib/plan/assignPlanTimes.ts::calculatePlanEstimatedTime` → 통합 함수 사용
4. `app/(student)/plan/new-group/_components/_features/scheduling/components/scheduleUtils.ts::calculateEstimatedTime` → 통합 함수 사용
5. `app/(student)/plan/new-group/_components/utils/scheduleTransform.ts::calculateEstimatedTime` → 통합 함수 사용

## 4. Bin Packing 알고리즘 최적화

### 4.1 현재 구현 분석

**현재 방식**: First Fit 알고리즘 (순차적으로 첫 번째 슬롯에 배치)

**위치**:

- `lib/plan/assignPlanTimes.ts::assignPlanTimes` (177-254줄)
- `lib/scheduler/SchedulerEngine.ts::generateStudyDayPlans` (514-664줄)

### 4.2 개선 방안

**Best Fit 알고리즘 적용**:

- 각 플랜을 가장 적합한 슬롯에 배치 (남은 시간이 가장 적은 슬롯)
- 시간 효율성 향상

**최적화 전략**:

1. 플랜을 소요시간 내림차순 정렬 (큰 것부터 배치)
2. 각 플랜을 가장 적합한 슬롯에 배치
3. 슬롯이 부족하면 실패 원인 기록

## 5. 학습 분량 검증 강화

### 5.1 Step 6 검증 개선

**파일**: `lib/validation/wizardValidator.ts::validateStep6` (413-455줄)

**추가 검증 항목**:

- 예상 소요 일수가 총 학습일 수를 초과하는지 확인
- 학습 분량이 과도하게 많거나 적은 경우 경고
- 추천 범위와 현재 범위의 차이가 큰 경우 경고

### 5.2 학습 분량 계산 정확도 향상

**파일**: `app/(student)/plan/new-group/_components/_features/content-selection/Step6FinalReview.tsx` (169-285줄)

**개선 사항**:

- 강의의 경우 episode별 duration을 고려한 정확한 계산
- 복습일 소요시간 단축 비율 검증

## 6. 데이터베이스 쿼리 최적화

### 6.1 Episode 조회 쿼리 추가

**파일**: `lib/plan/contentResolver.ts::loadContentDurations`

**추가 쿼리**:

- 강의 콘텐츠의 경우 episode 정보 조회
- 학생 강의 episode 우선, 없으면 마스터 강의 episode 사용
- 배정된 회차 범위에 해당하는 episode만 조회

## 7. 테스트 및 검증

### 7.1 단위 테스트

**대상 함수**:

- `calculateContentDuration` (통합 함수)
- `timeToMinutes`, `minutesToTime` (통합 함수)
- Bin Packing 알고리즘

### 7.2 통합 테스트

**시나리오**:

- 강의 episode별 duration이 다른 경우
- 복습일 소요시간 계산
- 시간 부족 시 처리

## 구현 순서

1. **Phase 1**: 시간 변환 함수 통합 (`lib/utils/time.ts`)
2. **Phase 2**: ContentDurationInfo 타입 확장 및 episode 조회 로직 추가
3. **Phase 3**: 소요시간 계산 함수 통합 (`lib/plan/contentDuration.ts`)
4. **Phase 4**: 기존 함수 교체
5. **Phase 5**: Bin Packing 알고리즘 최적화
6. **Phase 6**: 학습 분량 검증 강화
7. **Phase 7**: 테스트 및 검증

### To-dos

- [x] 시간 변환 함수 통합: lib/utils/time.ts 파일 생성 및 모든 파일에서 공통 함수 사용
- [x] ContentDurationInfo 타입 확장: episodes 필드 추가 및 타입 정의 업데이트
- [x] Episode별 duration 조회 로직 추가: loadContentDurations와 prepareContentDuration 함수에 episode 조회 쿼리 추가
- [ ] 소요시간 계산 함수 통합: lib/plan/contentDuration.ts 파일 생성 및 통합 함수 구현
- [ ] 기존 소요시간 계산 함수 교체: 5개 파일의 calculateContentDuration/calculatePlanEstimatedTime/calculateEstimatedTime 함수를 통합 함수로 교체
- [ ] Bin Packing 알고리즘 최적화: Best Fit 알고리즘 적용 및 플랜 정렬 로직 개선
- [ ] 학습 분량 검증 강화: Step 6 검증에 예상 소요 일수 및 학습 분량 적정성 검증 추가
- [ ] 테스트 및 검증: 단위 테스트 작성 및 통합 테스트 시나리오 검증