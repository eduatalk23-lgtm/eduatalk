<!-- 21ab6e81-d54e-4ded-a9a4-3bfebc38d00c e6f15827-bbf3-4dc4-ad47-166a4ccc0b11 -->
# 콘텐츠 테이블 연결 상태 개선 및 코드 최적화 계획

## 1. 데이터베이스 스키마 일관성 확인

### 1.1 현재 상태 확인

- ✅ `master_lectures`에 `subject_group_id` 컬럼이 이미 존재함 (이전 검토에서 놓친 부분)
- ✅ 모든 마스터 콘텐츠 테이블에 `curriculum_revision_id`, `subject_id`, `subject_group_id` 외래키 존재
- ✅ 외래키 제약조건 확인 완료

### 1.2 외래키 제약조건 강화

- 모든 외래키에 `ON DELETE` 정책 명시 확인
- 데이터 무결성 보장을 위한 제약조건 검증

**파일**: `supabase/migrations/YYYYMMDDHHMMSS_ensure_content_table_fk_constraints.sql`

## 2. 중복 코드 제거 및 공통 쿼리 빌더 생성

### 2.1 문제점 분석

현재 `lib/data/contentMasters.ts`에서 다음 함수들이 거의 동일한 로직을 반복:

- `searchMasterBooks()` (105-215줄)
- `searchMasterLectures()` (420-532줄)  
- `searchMasterCustomContents()` (910-988줄)

**중복되는 패턴**:

- 필터링 로직 (curriculum_revision_id, subject_group_id, subject_id, search, difficulty, tenantId)
- 정렬 로직 (title, difficulty_level, created_at, updated_at)
- 페이지네이션 로직
- 에러 처리 및 로깅

### 2.2 공통 쿼리 빌더 생성

**새 파일**: `lib/data/contentQueryBuilder.ts`

공통 필터 타입 정의:

```typescript
type BaseContentFilters = {
  curriculum_revision_id?: string;
  subject_group_id?: string;
  subject_id?: string;
  search?: string;
  difficulty?: string;
  tenantId?: string | null;
  sort?: string;
  limit?: number;
  offset?: number;
};

type ContentTypeSpecificFilters = {
  publisher_id?: string; // books only
  platform_id?: string;  // lectures only
  content_type?: string; // custom contents only
};
```

공통 쿼리 빌더 함수:

```typescript
function buildContentQuery<T>(
  supabase: SupabaseClient,
  tableName: 'master_books' | 'master_lectures' | 'master_custom_contents',
  filters: BaseContentFilters & ContentTypeSpecificFilters
): PostgrestFilterBuilder<T>
```

**리팩토링 대상 파일**:

- `lib/data/contentMasters.ts` - 세 개의 search 함수를 공통 빌더 사용하도록 변경

### 2.3 정렬 로직 통합

**새 파일**: `lib/utils/contentSort.ts`

공통 정렬 함수:

```typescript
export function applyContentSort<T>(
  query: PostgrestFilterBuilder<T>,
  sortBy: string,
  defaultSort: string = 'updated_at_desc'
): PostgrestFilterBuilder<T>
```

지원하는 정렬 옵션:

- `title_asc`, `title_desc`
- `difficulty_level_asc`, `difficulty_level_desc`
- `created_at_asc`, `created_at_desc`
- `updated_at_asc`, `updated_at_desc` (기본값)

### 2.4 필터링 로직 통합

**새 파일**: `lib/utils/contentFilters.ts`

공통 필터 적용 함수:

```typescript
export function applyContentFilters<T>(
  query: PostgrestFilterBuilder<T>,
  filters: BaseContentFilters & ContentTypeSpecificFilters,
  tableName: string
): PostgrestFilterBuilder<T>
```

필터 적용 순서 최적화:

1. 인덱스가 있는 컬럼 우선 (curriculum_revision_id, subject_id, subject_group_id)
2. 텍스트 검색 (search)
3. 난이도 필터
4. 테넌트 필터 (tenantId)

## 3. 타입 안전성 개선

### 3.1 통합 필터 타입 정의

**파일**: `lib/types/contentFilters.ts` (신규)

```typescript
export type BaseContentFilters = {
  curriculum_revision_id?: string;
  subject_group_id?: string;
  subject_id?: string;
  search?: string;
  difficulty?: string;
  tenantId?: string | null;
  sort?: ContentSortOption;
  limit?: number;
  offset?: number;
};

export type MasterBookFilters = BaseContentFilters & {
  publisher_id?: string;
};

export type MasterLectureFilters = BaseContentFilters & {
  platform_id?: string;
};

export type MasterCustomContentFilters = BaseContentFilters & {
  content_type?: string;
};

export type ContentSortOption = 
  | 'title_asc' | 'title_desc'
  | 'difficulty_level_asc' | 'difficulty_level_desc'
  | 'created_at_asc' | 'created_at_desc'
  | 'updated_at_asc' | 'updated_at_desc';
```

### 3.2 기존 타입 정의 업데이트

**파일**: `lib/data/contentMasters.ts`

- 기존 `MasterBookFilters`, `MasterLectureFilters`, `MasterCustomContentFilters` 타입을 새 타입으로 교체

## 4. 성능 최적화

### 4.1 인덱스 확인 및 추가

**파일**: `supabase/migrations/YYYYMMDDHHMMSS_add_content_table_indexes.sql`

확인/추가할 인덱스:

- `master_books`: (curriculum_revision_id, subject_group_id, subject_id) 복합 인덱스
- `master_lectures`: (curriculum_revision_id, subject_group_id, subject_id) 복합 인덱스
- `master_custom_contents`: (curriculum_revision_id, subject_group_id, subject_id) 복합 인덱스
- 모든 테이블: (tenant_id, is_active) 복합 인덱스 (필터링 성능 향상)

### 4.2 쿼리 최적화

- 불필요한 `*` select 대신 필요한 컬럼만 선택
- JOIN 최적화 (getMasterBookById에서 이미 적용됨)

## 5. 코드 구조 개선

### 5.1 파일 구조 재구성

```
lib/data/
├── contentMasters.ts          # 메인 함수 (리팩토링)
├── contentQueryBuilder.ts     # 공통 쿼리 빌더 (신규)
└── contentFilters.ts          # 필터 유틸리티 (신규)

lib/utils/
├── contentSort.ts             # 정렬 유틸리티 (신규)
└── contentFilters.ts          # 필터 유틸리티 (신규)

lib/types/
└── contentFilters.ts          # 필터 타입 정의 (신규)
```

### 5.2 에러 처리 통합

**파일**: `lib/utils/contentQueryError.ts` (신규)

공통 에러 처리 함수:

```typescript
export function handleContentQueryError(
  error: PostgrestError,
  context: string,
  filters: Record<string, unknown>
): never
```

## 6. 테스트 및 검증

### 6.1 기존 기능 검증

- 학생 영역 콘텐츠 검색 기능 테스트
- 관리자 영역 콘텐츠 검색 기능 테스트
- 필터링 동작 확인
- 정렬 동작 확인

### 6.2 성능 테스트

- 쿼리 실행 시간 측정
- 인덱스 사용 여부 확인 (EXPLAIN ANALYZE)

## 7. 문서화

### 7.1 코드 문서 업데이트

- `docs/2025-02-XX-content-table-consistency-review.md` - 검토 결과 문서
- `docs/2025-02-XX-content-query-optimization.md` - 최적화 작업 문서

### 7.2 API 문서 업데이트

- 공통 쿼리 빌더 사용법
- 필터 타입 정의
- 정렬 옵션 설명

## 구현 순서

1. **Phase 1**: 타입 정의 및 공통 유틸리티 생성

   - `lib/types/contentFilters.ts` 생성
   - `lib/utils/contentSort.ts` 생성
   - `lib/utils/contentFilters.ts` 생성

2. **Phase 2**: 공통 쿼리 빌더 생성

   - `lib/data/contentQueryBuilder.ts` 생성
   - 필터링/정렬/페이지네이션 로직 통합

3. **Phase 3**: 기존 함수 리팩토링

   - `searchMasterBooks()` 리팩토링
   - `searchMasterLectures()` 리팩토링
   - `searchMasterCustomContents()` 리팩토링

4. **Phase 4**: 데이터베이스 최적화

   - 인덱스 추가 마이그레이션
   - 외래키 제약조건 확인

5. **Phase 5**: 테스트 및 검증

   - 기능 테스트
   - 성능 테스트
   - 문서화

### To-dos

- [ ] lib/types/contentFilters.ts 파일 생성 - BaseContentFilters, MasterBookFilters, MasterLectureFilters, MasterCustomContentFilters, ContentSortOption 타입 정의
- [ ] lib/utils/contentSort.ts 파일 생성 - applyContentSort 함수로 정렬 로직 통합
- [ ] lib/utils/contentFilters.ts 파일 생성 - applyContentFilters 함수로 필터링 로직 통합
- [ ] lib/data/contentQueryBuilder.ts 파일 생성 - buildContentQuery 함수로 공통 쿼리 빌더 패턴 구현
- [ ] lib/data/contentMasters.ts의 searchMasterBooks 함수를 공통 쿼리 빌더 사용하도록 리팩토링
- [ ] lib/data/contentMasters.ts의 searchMasterLectures 함수를 공통 쿼리 빌더 사용하도록 리팩토링
- [ ] lib/data/contentMasters.ts의 searchMasterCustomContents 함수를 공통 쿼리 빌더 사용하도록 리팩토링
- [ ] supabase/migrations에 인덱스 추가 마이그레이션 파일 생성 - curriculum_revision_id, subject_group_id, subject_id 복합 인덱스 및 tenant_id, is_active 복합 인덱스
- [ ] 모든 마스터 콘텐츠 테이블의 외래키 제약조건 확인 및 필요시 ON DELETE 정책 추가 마이그레이션 생성
- [ ] docs 폴더에 검토 결과 및 최적화 작업 문서 작성