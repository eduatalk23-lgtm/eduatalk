<!-- 28b24223-6706-480c-a82d-42f60d2c6d2b 60e8cc9e-1792-4477-a6d2-35b492962156 -->
# 성적 분석 페이지 타입 안전성 및 코드 최적화 계획

## 문제점 요약

### 1. 긴급 (P0): 데이터 조인 키 불일치

- **현재**: Supabase 쿼리는 `subject:subjects(name)` 형태로 조인하지만, 컴포넌트에서 `s.subjects?.name` (복수형)로 접근
- **결과**: 모든 과목명이 "알 수 없음"으로 표시됨
- **영향 파일**: 
                                - `app/(student)/scores/analysis/_components/InternalDetailAnalysis.tsx`
                                - `app/(student)/scores/analysis/_components/MockDetailAnalysis.tsx`

### 2. 높음 (P1): 타입 안전성 부족

- 모든 컴포넌트에서 `any[]` 타입 사용
- IDE 자동완성 및 타입 체크 불가
- 런타임 에러 가능성 증가

### 3. 중간 (P2): 중복 코드

- 동일한 데이터 변환 로직이 3곳에서 반복 (`scoresWithNames` 변환)
- 유지보수 어려움

## 수정 계획

### Phase 1: 타입 정의 및 유틸리티 함수 생성

#### 1.1 타입 정의 파일 생성

**파일**: `lib/types/scoreAnalysis.ts` (신규)

```typescript
import type { Tables } from "@/lib/supabase/database.types";

// Supabase 조인 결과 타입 정의
export type InternalScoreWithRelations = Tables<"student_internal_scores"> & {
  subject_group?: { name: string } | null;
  subject?: { name: string } | null;
  subject_type?: { name: string } | null;
};

export type MockScoreWithRelations = Tables<"student_mock_scores"> & {
  subject_group?: { name: string } | null;
  subject?: { name: string } | null;
};

// 분석용 확장 타입
export type EnrichedInternalScore = InternalScoreWithRelations & {
  subject_name: string;
  subject_group_name: string;
};

export type EnrichedMockScore = MockScoreWithRelations & {
  subject_name: string;
  subject_group_name?: string;
};
```

#### 1.2 공통 데이터 변환 유틸리티 함수 생성

**파일**: `lib/utils/scoreTransform.ts` (신규)

```typescript
import type { 
  InternalScoreWithRelations, 
  MockScoreWithRelations,
  EnrichedInternalScore,
  EnrichedMockScore 
} from "@/lib/types/scoreAnalysis";

/**
 * 내신 성적에 과목명 및 교과군명 추가
 * Supabase 조인 결과의 단수형 키(subject, subject_group)를 올바르게 처리
 */
export function enrichInternalScore(
  score: InternalScoreWithRelations
): EnrichedInternalScore {
  return {
    ...score,
    subject_name: score.subject?.name ?? "알 수 없음",
    subject_group_name: score.subject_group?.name ?? "기타",
  };
}

/**
 * 모의고사 성적에 과목명 및 교과군명 추가
 */
export function enrichMockScore(
  score: MockScoreWithRelations
): EnrichedMockScore {
  return {
    ...score,
    subject_name: score.subject?.name ?? "알 수 없음",
    subject_group_name: score.subject_group?.name,
  };
}

/**
 * 내신 성적 배열 일괄 변환
 */
export function enrichInternalScores(
  scores: InternalScoreWithRelations[]
): EnrichedInternalScore[] {
  return scores.map(enrichInternalScore);
}

/**
 * 모의고사 성적 배열 일괄 변환
 */
export function enrichMockScores(
  scores: MockScoreWithRelations[]
): EnrichedMockScore[] {
  return scores.map(enrichMockScore);
}
```

### Phase 2: 데이터 페칭 함수 타입 개선

#### 2.1 `lib/data/scoreDetails.ts` 수정

- 반환 타입을 `any[]`에서 명시적 타입으로 변경
- `InternalScoreWithRelations[]`, `MockScoreWithRelations[]` 사용

**변경 사항**:

```typescript
// 기존
return (data as any[]) || [];

// 변경 후
import type { InternalScoreWithRelations, MockScoreWithRelations } from "@/lib/types/scoreAnalysis";

export async function getInternalScoresByTerm(...): Promise<InternalScoreWithRelations[]> {
  // ...
  return (data as InternalScoreWithRelations[]) || [];
}

export async function getMockScoresByPeriod(...): Promise<MockScoreWithRelations[]> {
  // ...
  return (data as MockScoreWithRelations[]) || [];
}
```

### Phase 3: 컴포넌트 수정

#### 3.1 `InternalDetailAnalysis.tsx` 수정

- `any[]` → `InternalScoreWithRelations[]` 타입 변경
- 중복된 `scoresWithNames` 변환 로직 제거
- `enrichInternalScores` 유틸리티 함수 사용
- `s.subjects?.name` → `s.subject?.name` 수정

**주요 변경**:

```typescript
import { enrichInternalScores } from "@/lib/utils/scoreTransform";
import type { InternalScoreWithRelations } from "@/lib/types/scoreAnalysis";

export default function InternalDetailAnalysis({
  scores, // InternalScoreWithRelations[]
}: {
  scores: InternalScoreWithRelations[];
}) {
  // 중복 제거: 한 번만 변환
  const enrichedScores = useMemo(
    () => enrichInternalScores(scores),
    [scores]
  );

  const subjectRanking = useMemo(() => {
    return calculateSubjectRanking(enrichedScores);
  }, [enrichedScores]);

  const weakSubjects = useMemo(() => {
    return analyzeWeakPoints(enrichedScores);
  }, [enrichedScores]);
}
```

#### 3.2 `MockDetailAnalysis.tsx` 수정

- 동일한 패턴 적용
- `s.subjects?.name` → `s.subject?.name` 수정

#### 3.3 `AnalysisLayout.tsx` 수정

- Props 타입을 `any[]`에서 명시적 타입으로 변경
```typescript
import type { 
  InternalScoreWithRelations, 
  MockScoreWithRelations 
} from "@/lib/types/scoreAnalysis";

type AnalysisLayoutProps = {
  studentId: string;
  tenantId: string;
  internalScores: InternalScoreWithRelations[];
  mockScores: MockScoreWithRelations[];
};
```


### Phase 4: 분석 함수 타입 개선

#### 4.1 `lib/analysis/scoreAnalyzer.ts` 수정

- `InternalScoreData`, `MockScoreData` 타입을 확장된 타입으로 교체
- `EnrichedInternalScore`, `EnrichedMockScore` 사용

**변경 사항**:

```typescript
// 기존
type InternalScoreData = {
  subject_group_id: string;
  // ...
};

// 변경 후
import type { EnrichedInternalScore, EnrichedMockScore } from "@/lib/types/scoreAnalysis";

export function calculateSubjectRanking(
  scores: EnrichedInternalScore[]
): Array<{
  subject_id: string;
  subject_name: string;
  subject_group_name: string;
  average_grade: number;
  count: number;
}> {
  // subject_name, subject_group_name이 이미 포함되어 있음
  // 별도 변환 불필요
}
```

### Phase 5: 테스트 및 검증

#### 5.1 타입 체크

- `npm run build` 실행하여 TypeScript 에러 확인
- 모든 `any` 타입 제거 확인

#### 5.2 기능 테스트

- `/scores/analysis` 페이지 접속
- 내신/모의고사 탭 전환
- 과목명이 올바르게 표시되는지 확인

## 파일 변경 목록

### 신규 파일

1. `lib/types/scoreAnalysis.ts` - 타입 정의
2. `lib/utils/scoreTransform.ts` - 데이터 변환 유틸리티

### 수정 파일

1. `lib/data/scoreDetails.ts` - 반환 타입 개선
2. `app/(student)/scores/analysis/_components/InternalDetailAnalysis.tsx` - 키 수정 및 중복 제거
3. `app/(student)/scores/analysis/_components/MockDetailAnalysis.tsx` - 키 수정 및 중복 제거
4. `app/(student)/scores/analysis/_components/AnalysisLayout.tsx` - 타입 정의
5. `lib/analysis/scoreAnalyzer.ts` - 타입 개선

## 참고 자료

- Supabase 조인 구문: `subject:subjects(name)` → 결과는 `subject` (단수) 키로 반환
- Context7 Supabase 모범 사례: 타입 안전성을 위한 명시적 타입 정의
- Next.js 15 모범 사례: Server Component에서 타입 안전한 데이터 페칭

## 예상 효과

1. **타입 안전성 향상**: 모든 `any` 타입 제거, 컴파일 타임 에러 감지
2. **버그 수정**: 과목명이 올바르게 표시됨
3. **코드 중복 제거**: 데이터 변환 로직 단일화
4. **유지보수성 향상**: 타입 정의로 인한 명확한 인터페이스
5. **개발 경험 개선**: IDE 자동완성 및 타입 체크 지원

### To-dos

- [ ] lib/types/scoreAnalysis.ts 파일 생성 - InternalScoreWithRelations, MockScoreWithRelations, EnrichedInternalScore, EnrichedMockScore 타입 정의
- [ ] lib/utils/scoreTransform.ts 파일 생성 - enrichInternalScore, enrichMockScore, enrichInternalScores, enrichMockScores 유틸리티 함수 구현
- [ ] lib/data/scoreDetails.ts 수정 - 반환 타입을 any[]에서 명시적 타입으로 변경 (InternalScoreWithRelations[], MockScoreWithRelations[])
- [ ] InternalDetailAnalysis.tsx 수정 - subjects → subject 키 수정, 중복 변환 로직 제거, enrichInternalScores 사용, 타입 개선
- [ ] MockDetailAnalysis.tsx 수정 - subjects → subject 키 수정, 중복 변환 로직 제거, enrichMockScores 사용, 타입 개선
- [ ] AnalysisLayout.tsx 수정 - Props 타입을 any[]에서 명시적 타입으로 변경
- [ ] lib/analysis/scoreAnalyzer.ts 수정 - InternalScoreData, MockScoreData를 EnrichedInternalScore, EnrichedMockScore로 교체
- [ ] TypeScript 빌드 검증 - npm run build 실행하여 타입 에러 확인