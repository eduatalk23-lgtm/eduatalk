<!-- 452c2393-06c2-47a4-a8cc-5ab049a359c5 b0b6ba54-df95-444d-bbb7-c3445eab4dbb -->
# 플랜 그룹 생성 시 콘텐츠 유형별 처리 개선 계획

## 개요

플랜 그룹 생성 시 교재와 강의 콘텐츠의 학습 내역, 학습 분량, 소요시간 처리 로직을 개선하여 정확성과 성능을 향상시킵니다.

## 현재 문제점

### 1. N+1 쿼리 문제

- **위치**: `lib/plan/contentResolver.ts` 494-567줄
- **문제**: 각 강의마다 episode를 순차 조회하여 성능 저하
- **영향**: 강의 10개 선택 시 10번의 추가 쿼리 발생

### 2. 중복 코드

- **calculateContentDuration**: `lib/scheduler/SchedulerEngine.ts`, `lib/plan/scheduler.ts`에 중복
- **calculateEstimatedTime**: `scheduleTransform.ts`, `scheduleUtils.ts`에 중복
- **기본값 계산**: 회차당 30분, 페이지당 2분 로직이 여러 곳에 중복

### 3. 데이터 활용 부족

- `master_lectures.total_episodes` 필드가 있으나 소요시간 계산에 미활용
- `difficulty_level` 필드가 있으나 교재 소요시간 계산에 미활용
- 복습일 비율이 하드코딩됨 (50% 고정)

## 개선 계획

### Phase 1: N+1 쿼리 문제 해결 (High Priority)

#### 1.1 Episode 배치 조회 적용

**파일**: `lib/plan/contentResolver.ts`

**현재 코드 (494-567줄)**:

```typescript
// 각 강의마다 순차 조회 (N+1 문제)
for (const { content, studentLecture } of lectureResults) {
  const episodeResult = await queryClient
    .from("student_lecture_episodes")
    .select("episode_number, duration")
    .eq("lecture_id", finalContentId);
}
```

**개선 방안**:

- 기존 `getStudentLectureEpisodesBatch` 함수 활용
- 모든 강의 ID를 수집하여 한 번에 배치 조회
- 마스터 강의 episode도 배치 조회로 변경

**수정 내용**:

1. 학생 강의 episode 배치 조회 (494-515줄)
2. 마스터 강의 episode 배치 조회 (598-620줄)
3. 결과를 Map으로 그룹화하여 O(1) 조회

**예상 성능 개선**: 10개 강의 기준 10회 쿼리 → 2회 쿼리 (80% 감소)

### Phase 2: 중복 코드 제거 (High Priority)

#### 2.1 calculateContentDuration 함수 통합

**중복 위치**:

- `lib/scheduler/SchedulerEngine.ts` 70-97줄
- `lib/plan/scheduler.ts` 548-575줄

**해결 방안**:

- 두 파일 모두 `lib/plan/contentDuration.ts`의 `calculateContentDuration` 함수 사용
- 중복 함수 제거하고 import로 대체

**수정 파일**:

- `lib/scheduler/SchedulerEngine.ts`: 중복 함수 제거, import 추가
- `lib/plan/scheduler.ts`: 중복 함수 제거, import 추가

#### 2.2 calculateEstimatedTime 함수 통합

**중복 위치**:

- `app/(student)/plan/new-group/_components/utils/scheduleTransform.ts` 195-239줄
- `app/(student)/plan/new-group/_components/_features/scheduling/components/scheduleUtils.ts` 72-119줄

**해결 방안**:

- `lib/plan/assignPlanTimes.ts`의 `calculatePlanEstimatedTime` 함수를 공통으로 사용
- 클라이언트 컴포넌트에서도 동일한 로직 사용

**수정 파일**:

- `scheduleTransform.ts`: 중복 함수 제거, `calculatePlanEstimatedTime` import
- `scheduleUtils.ts`: 중복 함수 제거, `calculatePlanEstimatedTime` import

### Phase 3: 강의 소요시간 계산 정확성 향상 (Medium Priority)

#### 3.1 total_episodes 필드 활용

**파일**: `lib/plan/contentDuration.ts`

**현재 문제 (71-82줄)**:

```typescript
// 전체 회차 수를 모르므로 부정확한 계산
baseTime = Math.round((durationInfo.duration / amount) * amount);
// TODO: 전체 회차 수를 조회하여 정확한 계산 필요
```

**개선 방안**:

1. `ContentDurationInfo` 타입에 `total_episodes` 필드 추가
2. `loadContentDurations` 함수에서 `total_episodes` 조회 및 저장
3. `calculateContentDuration` 함수에서 `total_episodes` 활용

**수정 내용**:

- `lib/types/plan-generation.ts`: `ContentDurationInfo` 타입 확장
- `lib/plan/contentResolver.ts`: `total_episodes` 조회 로직 추가
- `lib/plan/contentDuration.ts`: `total_episodes` 기반 계산 로직 개선

**계산 로직**:

```typescript
if (durationInfo.total_episodes && durationInfo.duration) {
  const avgDurationPerEpisode = durationInfo.duration / durationInfo.total_episodes;
  baseTime = Math.round(avgDurationPerEpisode * amount);
}
```

### Phase 4: 교재 난이도별 소요시간 설정 (Medium Priority)

#### 4.1 difficulty_level 기반 소요시간 계산

**파일**: `lib/plan/contentDuration.ts`

**현재 문제 (87-91줄)**:

```typescript
// 모든 교재가 동일한 난이도로 가정
const pagesPerHour = 10; // 고정값
```

**개선 방안**:

1. 난이도별 페이지당 소요시간 매핑 테이블 생성
2. `ContentDurationInfo`에 `difficulty_level` 필드 추가
3. 난이도에 따라 동적 계산

**수정 내용**:

- `lib/plan/contentDuration.ts`: 난이도별 매핑 상수 추가
- `lib/plan/contentResolver.ts`: `difficulty_level` 조회 및 저장
- `lib/plan/contentDuration.ts`: 난이도 기반 계산 로직 추가

**난이도별 매핑**:

```typescript
const PAGE_DURATION_BY_DIFFICULTY: Record<string, number> = {
  '기초': 4,   // 페이지당 4분
  '기본': 6,   // 페이지당 6분 (현재 기본값)
  '심화': 8,   // 페이지당 8분
  '최상': 10,  // 페이지당 10분
};
```

### Phase 5: 복습일 비율 설정화 (Low Priority)

#### 5.1 scheduler_settings 테이블 확장

**파일**: `lib/data/schedulerSettings.ts`

**개선 방안**:

1. `tenant_scheduler_settings` 테이블에 `review_time_ratio` 필드 추가 (마이그레이션)
2. 기본값 0.5 (50%) 설정
3. `calculateContentDuration` 함수에서 설정값 사용

**수정 내용**:

- 마이그레이션 파일 생성: `review_time_ratio` 컬럼 추가
- `lib/data/schedulerSettings.ts`: 설정 조회 로직 추가
- `lib/plan/contentDuration.ts`: 설정값 기반 계산

### Phase 6: 타입 정의 개선

#### 6.1 ContentDurationInfo 타입 확장

**파일**: `lib/types/plan-generation.ts`

**추가 필드**:

- `total_episodes?: number | null` - 강의 총 회차 수
- `difficulty_level?: string | null` - 난이도 (교재/강의)

## 구현 순서

1. **Phase 1**: N+1 쿼리 문제 해결 (즉시 적용 가능, 성능 개선)
2. **Phase 2**: 중복 코드 제거 (코드 품질 개선)
3. **Phase 3**: 강의 소요시간 정확성 향상 (데이터 정확성)
4. **Phase 4**: 교재 난이도별 소요시간 (사용자 경험 개선)
5. **Phase 5**: 복습일 비율 설정화 (유연성 향상)
6. **Phase 6**: 타입 정의 개선 (타입 안전성)

## 예상 효과

### 성능 개선

- N+1 쿼리 해결: 강의 10개 기준 쿼리 수 10회 → 2회 (80% 감소)
- 응답 시간: 900ms → 150ms (약 83% 개선)

### 코드 품질

- 중복 코드 제거: 약 200줄 감소
- 유지보수성 향상: 단일 소스로 로직 관리

### 정확성 향상

- 강의 소요시간: 전체 회차 수 기반 정확한 계산
- 교재 소요시간: 난이도별 차등 적용

## 참고 사항

- 기존 배치 조회 함수 (`getStudentLectureEpisodesBatch`) 활용
- 데이터베이스 스키마는 이미 필요한 필드 존재 (`total_episodes`, `difficulty_level`)
- 하위 호환성 유지 (기본값 fallback 로직 유지)

### To-dos

- [ ] Phase 1: Episode 배치 조회로 N+1 쿼리 문제 해결 - lib/plan/contentResolver.ts의 loadContentDurations 함수에서 getStudentLectureEpisodesBatch 활용
- [ ] Phase 2: calculateContentDuration 중복 함수 제거 - lib/scheduler/SchedulerEngine.ts와 lib/plan/scheduler.ts에서 중복 제거하고 lib/plan/contentDuration.ts import
- [ ] Phase 2: calculateEstimatedTime 중복 함수 제거 - scheduleTransform.ts와 scheduleUtils.ts에서 제거하고 calculatePlanEstimatedTime import
- [ ] Phase 3: ContentDurationInfo 타입에 total_episodes 필드 추가 및 조회 로직 구현
- [ ] Phase 3: 강의 소요시간 계산 로직 개선 - total_episodes 기반 정확한 계산
- [ ] Phase 4: ContentDurationInfo 타입에 difficulty_level 필드 추가 및 조회 로직 구현
- [ ] Phase 4: 교재 난이도별 소요시간 계산 로직 구현 - 난이도별 매핑 테이블 생성 및 적용
- [ ] Phase 5: tenant_scheduler_settings 테이블에 review_time_ratio 컬럼 추가 마이그레이션 생성
- [ ] Phase 5: 복습일 비율 설정 조회 및 적용 로직 구현