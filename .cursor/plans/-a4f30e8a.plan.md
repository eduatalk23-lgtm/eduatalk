<!-- a4f30e8a-5e51-4ca8-a7b5-842cd0ab60ac bbb81b96-88ef-435e-b359-a1f709bb0f2d -->
# 일별 스케줄 학습 내역 상세 정보 표시 개선 계획

## 문제 분석

### 현재 상황

1. **강의 콘텐츠**: `contentEpisode`가 `sequence`만 표시 (예: "1회차")
2. **교재 콘텐츠**: `contentEpisode`가 `sequence`만 표시 (예: "1회차")
3. **중복 코드**: `app/(student)/plan/calendar/page.tsx`와 `app/(student)/camp/calendar/page.tsx`에 동일한 로직 존재
4. **데이터 조회 누락**: episode/book_details 정보를 조회하지 않음

### 데이터베이스 구조 확인 결과

- `student_book_details`: `major_unit`, `minor_unit`, `page_number` 필드 존재
- `student_lecture_episodes`: `episode_title`, `episode_number`, `duration` 필드 존재
- `master_book_details`, `master_lecture_episodes`도 유사한 구조

## 개선 목표

1. **강의 콘텐츠**: `episode_title` 표시 (예: "8강: 함수의 개념")
2. **교재 콘텐츠**: `major_unit`/`minor_unit` 표시 (예: "1단원: 함수")
3. **중복 코드 제거**: 공통 로직을 유틸리티 함수로 추출
4. **성능 최적화**: 배치 조회 함수 활용 및 병렬 처리

## 구현 계획

### Phase 1: 유틸리티 함수 생성

**파일**: `lib/utils/planContentEnrichment.ts` (신규 생성)

**기능**:

- 플랜에 콘텐츠 상세 정보를 추가하는 공통 로직 추출
- 강의 episode_title 조회 및 매핑
- 교재 major_unit/minor_unit 조회 및 매핑
- 배치 조회 함수 활용 (`getStudentBookDetailsBatch`, `getStudentLectureEpisodesBatch`)

**주요 함수**:

```typescript
export async function enrichPlansWithContentDetails(
  plans: Plan[],
  studentId: string
): Promise<PlanWithContent[]>
```

**로직**:

1. 플랜에서 book/lecture content_id 수집
2. 배치 조회로 episode/book_details 정보 가져오기
3. 각 플랜의 `planned_start_page_or_time` ~ `planned_end_page_or_time` 범위에 해당하는 정보 찾기
4. `contentEpisode` 생성:

   - 강의: episode_title 조합 (단일/범위)
   - 교재: major_unit/minor_unit 조합 (단일/범위)
   - Fallback: sequence 사용

### Phase 2: 중복 코드 제거

**파일들**:

- `app/(student)/plan/calendar/page.tsx`
- `app/(student)/camp/calendar/page.tsx`

**수정 사항**:

- `plansWithContent` 생성 로직을 `enrichPlansWithContentDetails` 함수 호출로 대체
- 교과 정보 조회 로직은 유지 (기존 로직과 통합)

### Phase 3: 성능 최적화

**최적화 포인트**:

1. **병렬 처리**: `Promise.all`을 사용하여 book_details와 lecture_episodes를 동시에 조회
2. **조건부 조회**: content_id가 있는 플랜만 조회 대상에 포함
3. **Map 기반 조회**: O(1) 조회 성능을 위한 Map 구조 활용
4. **React cache 활용**: Next.js 15 모범 사례에 따라 `cache` 함수 사용 고려

### Phase 4: 타입 정의 개선

**파일**: `app/(student)/plan/calendar/_types/plan.ts`

**수정 사항**:

- `PlanWithContent` 타입에 `contentEpisode` 필드 명시
- Episode/BookDetail 정보 타입 정의

## 상세 구현 내용

### 1. `lib/utils/planContentEnrichment.ts` 생성

**주요 로직**:

```typescript
// 1. 콘텐츠 ID 수집
const bookIds = new Set<string>();
const lectureIds = new Set<string>();

// 2. 배치 조회 (병렬 처리)
const [bookDetailsMap, lectureEpisodesMap] = await Promise.all([
  bookIds.size > 0 ? getStudentBookDetailsBatch(Array.from(bookIds), studentId) : Promise.resolve(new Map()),
  lectureIds.size > 0 ? getStudentLectureEpisodesBatch(Array.from(lectureIds), studentId) : Promise.resolve(new Map()),
]);

// 3. contentEpisode 생성
// 강의: episode_title 조합
// 교재: major_unit/minor_unit 조합
// Fallback: sequence
```

**강의 콘텐츠 처리**:

- `planned_start_page_or_time`에 해당하는 episode 찾기
- `planned_end_page_or_time`에 해당하는 episode 찾기
- 단일: `episode_title` (예: "8강: 함수의 개념")
- 범위: `startEpisode ~ endEpisode` (예: "8강: 함수의 개념 ~ 9강: 함수의 활용")
- Fallback: `episode_title`이 없으면 `episode_number` 사용

**교재 콘텐츠 처리**:

- `planned_start_page_or_time`에 해당하는 book_detail 찾기 (page_number <= start)
- `planned_end_page_or_time`에 해당하는 book_detail 찾기 (page_number <= end)
- 단일: `major_unit || minor_unit` (예: "1단원: 함수")
- 범위: `startUnit ~ endUnit` (예: "1단원: 함수 ~ 2단원: 방정식")
- Fallback: 단원 정보가 없으면 페이지 범위 표시

### 2. `app/(student)/plan/calendar/page.tsx` 수정

**수정 전**:

```typescript
const plansWithContent = filteredPlans.map((plan) => {
  let contentEpisode: string | null = null;
  if (plan.sequence !== null && plan.sequence !== undefined) {
    contentEpisode = `${plan.sequence}회차`;
  }
  // ...
});
```

**수정 후**:

```typescript
const plansWithContent = await enrichPlansWithContentDetails(
  filteredPlans,
  user.id
);
```

### 3. `app/(student)/camp/calendar/page.tsx` 수정

동일한 패턴으로 수정하여 중복 코드 제거

## 예상 결과

1. **강의 콘텐츠**: "8강: 함수의 개념" 형태로 표시
2. **교재 콘텐츠**: "1단원: 함수" 형태로 표시
3. **중복 코드 제거**: 공통 로직이 한 곳에서 관리됨
4. **성능 향상**: 배치 조회 및 병렬 처리로 쿼리 횟수 감소

## 참고 사항

- Next.js 15 Server Component 모범 사례 준수
- 기존 코드 스타일 및 컨벤션 유지
- 하위 호환성 보장 (fallback 로직 포함)
- 타입 안전성 보장 (TypeScript strict mode)

### To-dos

- [ ] Episode 정보 전달 경로 검증: loadContentDurations → assignPlanTimes → calculateContentDuration 경로에서 episode 정보가 제대로 전달되는지 확인하는 로깅 추가
- [ ] calculateContentDuration 함수 최적화: Episode Map 생성 최적화, null 체크 강화, 타입 안전성 개선
- [ ] assignPlanTimes 함수 개선: Episode 정보 활용 검증, calculatePlanEstimatedTime 호출 시 episode 정보 전달 확인
- [ ] 중복 코드 제거: 소요시간 계산 로직을 calculateContentDuration으로 통합, 기본값 상수 추출
- [ ] Map 데이터 구조 최적화: Episode Map 생성 최적화, Map 조회 성능 개선, TypeScript 2025 모범 사례 적용
- [ ] 타입 안전성 개선: Episode 정보 타입 정의 명확화, 타입 가드 함수 추가, null 체크 강화
- [ ] 테스트 및 검증: 강의 콘텐츠 episode 정보가 일별 스케줄 시간 구성에 정확히 반영되는지 확인