<!-- 14bcea93-082b-40d4-bef2-8054ba545faa e2bc5b6f-122f-4d2a-9ac8-4459a2242ca9 -->
# 총 회차 자동 계산 기능 추가 및 코드 최적화

## 문제 분석

### 현재 상황

- 총 강의시간은 회차별 시간 합계를 자동 계산하는 기능이 있음
- 총 회차는 수동 입력만 가능하며, 회차 정보와 연동되지 않음
- `MasterLectureForm.tsx`와 `MasterLectureEditForm.tsx`에 중복된 로직 존재:
  - 회차 정보 상태 관리
  - 회차별 시간 합계 계산
  - 합계 적용 버튼 핸들러
  - ref 관리

### 데이터베이스 스키마 확인

- `master_lectures.total_episodes`: `integer NOT NULL` (필수 필드)
- `master_lectures.total_duration`: `integer NULLABLE` (선택 필드)

### 개선 필요 사항

1. 총 회차 자동 계산 기능 추가 (회차 정보 배열 길이 기반)
2. 중복 코드 제거 및 공통 훅으로 추출
3. 일관된 UX 패턴 적용

## 해결 방안

### Phase 1: 공통 훅 생성 (코드 중복 제거)

**파일**: `lib/hooks/useLectureEpisodesCalculation.ts` (신규 생성)

**목적**: 회차 정보 기반 계산 로직을 공통 훅으로 추출

**기능**:

- 회차 정보 상태 관리
- 총 회차 수 계산 (배열 길이)
- 총 강의시간 계산 (시간 합계)
- 합계 적용 핸들러 (ref 기반)

**구현 내용**:

```typescript
export function useLectureEpisodesCalculation(initialEpisodes?: LectureEpisode[]) {
  const [episodes, setEpisodes] = useState<EpisodeState[]>(...);
  const totalEpisodesRef = useRef<HTMLInputElement>(null);
  const totalDurationRef = useRef<HTMLInputElement>(null);
  
  const totalEpisodes = useMemo(() => episodes.length, [episodes]);
  const totalDuration = useMemo(() => {
    return episodes.reduce((sum, e) => sum + (e.duration || 0), 0);
  }, [episodes]);
  
  const handleEpisodesChange = (newEpisodes: ...) => { ... };
  const handleApplyTotalEpisodes = () => { ... };
  const handleApplyTotalDuration = () => { ... };
  
  return {
    episodes,
    totalEpisodes,
    totalDuration,
    handleEpisodesChange,
    handleApplyTotalEpisodes,
    handleApplyTotalDuration,
    totalEpisodesRef,
    totalDurationRef,
  };
}
```

### Phase 2: MasterLectureForm.tsx 리팩토링

**파일**: `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx`

**변경 사항**:

1. 공통 훅 사용으로 중복 코드 제거
2. 총 회차 자동 계산 기능 추가
3. 총 회차 필드에 "회차 합계 적용" 버튼 및 힌트 추가

**구현 내용**:

- `useLectureEpisodesCalculation` 훅 사용
- 총 회차 필드에 동일한 패턴 적용 (총 강의시간과 동일)

### Phase 3: MasterLectureEditForm.tsx 리팩토링

**파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`

**변경 사항**:

1. 공통 훅 사용으로 중복 코드 제거
2. 총 회차 자동 계산 기능 추가
3. 초기 회차 정보를 훅에 전달

**구현 내용**:

- `useLectureEpisodesCalculation` 훅 사용 (initialEpisodes 전달)
- 총 회차 필드에 동일한 패턴 적용

### Phase 4: 검증 로직 개선

**파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`

**변경 사항**:

- `handleSubmit`의 수동 FormData 파싱 로직을 `formDataToObject` 사용으로 통일
- 검증 일관성 향상

## 구현 세부사항

### 1. 공통 훅 구조

```typescript
type EpisodeState = {
  episode_number: number;
  episode_title: string;
  duration: number;
};

type UseLectureEpisodesCalculationReturn = {
  episodes: EpisodeState[];
  totalEpisodes: number;
  totalDuration: number;
  handleEpisodesChange: (episodes: Omit<LectureEpisode, "id" | "created_at">[]) => void;
  handleApplyTotalEpisodes: () => void;
  handleApplyTotalDuration: () => void;
  totalEpisodesRef: React.RefObject<HTMLInputElement>;
  totalDurationRef: React.RefObject<HTMLInputElement>;
};
```

### 2. 총 회차 계산 로직

**방법 1: 배열 길이 기반 (권장)**

- 회차 정보 배열의 길이를 총 회차로 사용
- 가장 직관적이고 정확함

**방법 2: 최대 episode_number 기반**

- `Math.max(...episodes.map(e => e.episode_number))` 사용
- 회차 번호가 연속적이지 않을 수 있어 덜 정확할 수 있음

**결정**: 배열 길이 기반 사용 (회차 정보에 실제로 입력된 회차 개수 반영)

### 3. UI 패턴 통일

총 회차와 총 강의시간 필드에 동일한 패턴 적용:

- 레이블 옆에 "회차 합계 적용" 버튼 (회차 정보가 있을 때만 표시)
- 힌트 텍스트로 현재 계산된 값 표시
- ref를 통한 값 적용

### 4. 중복 코드 제거 효과

**제거되는 중복 코드**:

- 회차 정보 상태 관리 로직 (~15줄)
- 회차별 시간 합계 계산 로직 (~5줄)
- 합계 적용 핸들러 로직 (~10줄)
- ref 선언 및 관리 (~2줄)

**총 제거 예상**: 약 32줄 × 2 파일 = 64줄

**추가되는 공통 코드**: 약 50줄 (재사용 가능)

## 테스트 계획

### 1. 총 회차 자동 계산 테스트

- [ ] 회차 추가 시 총 회차 수 증가 확인
- [ ] 회차 삭제 시 총 회차 수 감소 확인
- [ ] "회차 합계 적용" 버튼 클릭 시 필드에 값 입력 확인
- [ ] 힌트 텍스트로 현재 회차 개수 표시 확인

### 2. 통합 테스트

- [ ] 회차 정보 입력 후 총 회차 적용하여 저장 → DB에 올바른 값 저장 확인
- [ ] 총 회차와 총 강의시간 모두 자동 계산 기능 정상 동작 확인
- [ ] 기존 강의 수정 시 회차 정보와 총 회차 일치 확인

### 3. 코드 품질 테스트

- [ ] 공통 훅이 두 폼에서 정상 동작 확인
- [ ] 중복 코드 제거 확인
- [ ] 타입 안전성 확인

## 파일 변경 목록

### 신규 생성 파일

1. `lib/hooks/useLectureEpisodesCalculation.ts` - 공통 훅

### 수정 파일

1. `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx` - 공통 훅 사용 및 총 회차 기능 추가
2. `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx` - 공통 훅 사용 및 총 회차 기능 추가, 검증 로직 개선

### 참고 파일

1. `app/(student)/contents/_components/LectureEpisodesManager.tsx` - 회차 정보 관리 컴포넌트
2. `lib/validation/schemas.ts` - formDataToObject 함수

## 최적화 포인트

### 1. 계산 최적화

- `useMemo`를 사용하여 회차 정보 변경 시에만 재계산
- 불필요한 리렌더링 방지

### 2. 코드 재사용성

- 공통 훅으로 로직 중앙화
- 향후 다른 폼에서도 재사용 가능

### 3. 타입 안전성

- TypeScript 타입 정의로 안전성 보장
- LectureEpisode 타입 활용

## 참고 자료

- React Hook Form: `setValue` 패턴을 통한 값 업데이트
- React: `useMemo`를 통한 계산 최적화
- Supabase: `master_lectures.total_episodes`는 `integer NOT NULL`