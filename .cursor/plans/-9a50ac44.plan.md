<!-- 9a50ac44-2d04-4c79-a5fe-49b0c09b289a d1cefc34-470f-4ca0-8e0a-c11f47d01ba6 -->
# 교재 및 강의 등록/수정 폼 일관성 개선 및 난이도 마스터 데이터 관리 최적화 계획

## 문제점 분석

### 1. 중복 코드

- **SubjectSelectionFields 미사용**: `MasterLectureForm`이 `SubjectSelectionFields` 컴포넌트를 사용하지 않고 직접 구현
- **난이도 필드 하드코딩**: 모든 폼에서 난이도 옵션이 하드코딩되어 있음
  - `MasterBookForm`: "개념", "기본", "심화"
  - `MasterLectureForm`: "개념", "기본", "심화"
  - `MasterCustomContentForm`: "상", "중", "하"
- **과목 선택 로직 중복**: `MasterLectureForm`에 직접 구현된 과목 선택 로직

### 2. 데이터 불일치

- 데이터베이스 실제 값: `master_books`에는 "개념", "하"만 존재
- 폼의 하드코딩 값과 실제 데이터 불일치

### 3. 일관성 부족

- 각 폼마다 다른 난이도 옵션 사용
- 과목 선택 방식이 폼마다 다름

### 4. 난이도 관리 문제

- 난이도가 텍스트로 직접 저장되어 데이터 무결성 보장 어려움
- 난이도 옵션 변경 시 모든 콘텐츠를 수동으로 업데이트해야 함
- 마스터 데이터로 관리되지 않아 관리자 페이지에서 관리 불가

## 해결 방안

### Phase 0: 난이도 마스터 테이블 생성 및 마이그레이션

#### 0.1 difficulty_levels 마스터 테이블 생성

- **마이그레이션 파일**: `supabase/migrations/YYYYMMDDHHMMSS_create_difficulty_levels.sql`
- **테이블 구조**:
  ```sql
  CREATE TABLE difficulty_levels (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    name varchar(50) NOT NULL,
    content_type varchar(20) NOT NULL CHECK (content_type IN ('book', 'lecture', 'custom', 'common')),
    display_order integer NOT NULL DEFAULT 0,
    is_active boolean NOT NULL DEFAULT true,
    description text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    UNIQUE(name, content_type)
  );
  ```

- **설명**:
  - `content_type`: 콘텐츠 타입별 난이도 관리 ('common'은 모든 타입 공통)
  - `name`: 난이도 이름 (예: "개념", "기본", "심화", "상", "중", "하")
  - `display_order`: 표시 순서
  - `is_active`: 활성화 여부
  - `UNIQUE(name, content_type)`: 같은 타입 내에서 이름 중복 방지

#### 0.2 기존 데이터 마이그레이션

- **마이그레이션 파일**: `supabase/migrations/YYYYMMDDHHMMSS_migrate_existing_difficulties.sql`
- **작업 내용**:

  1. 기존 콘텐츠 테이블에서 고유한 난이도 값 추출
  2. `difficulty_levels` 테이블에 자동 삽입
  3. 콘텐츠 테이블의 `difficulty_level` 컬럼을 `difficulty_level_id` (FK)로 변경
  4. 기존 텍스트 값을 FK로 변환

#### 0.3 외래키 제약조건 추가

- **마이그레이션 파일**: `supabase/migrations/YYYYMMDDHHMMSS_add_difficulty_fk_constraints.sql`
- **적용 대상**:
  - `master_books.difficulty_level_id` → `difficulty_levels.id`
  - `master_lectures.difficulty_level_id` → `difficulty_levels.id`
  - `master_custom_contents.difficulty_level_id` → `difficulty_levels.id`
  - `books.difficulty_level_id` → `difficulty_levels.id` (선택사항)
  - `lectures.difficulty_level_id` → `difficulty_levels.id` (선택사항)
- **ON DELETE 정책**: `SET NULL` (난이도 삭제 시 NULL로 설정)

### Phase 1: 난이도 마스터 데이터 CRUD 구현

#### 1.1 데이터 레이어 구현

- **파일**: `lib/data/difficultyLevels.ts`
- **함수**:
  - `getDifficultyLevels(contentType?: string)`: 난이도 목록 조회
  - `getDifficultyLevelById(id: string)`: ID로 난이도 조회
  - `createDifficultyLevel(data)`: 난이도 생성
  - `updateDifficultyLevel(id, data)`: 난이도 수정
  - `deleteDifficultyLevel(id)`: 난이도 삭제 (사용 중인 경우 체크)
- **패턴**: `lib/data/contentMetadata.ts`의 publishers/platforms 패턴 참고

#### 1.2 Server Actions 구현

- **파일**: `app/(admin)/actions/difficultyLevelActions.ts`
- **액션**:
  - `getDifficultyLevelsAction(contentType?: string)`
  - `createDifficultyLevelAction(name, contentType, displayOrder)`
  - `updateDifficultyLevelAction(id, data)`
  - `deleteDifficultyLevelAction(id)`
- **패턴**: `app/(admin)/actions/contentMetadataActions.ts` 참고

#### 1.3 API 엔드포인트 구현

- **파일**: `app/api/difficulty-levels/route.ts`
- **기능**: 난이도 목록 조회 API (콘텐츠 타입별 필터링 지원)
- **사용처**: DifficultySelectField 컴포넌트에서 사용

### Phase 2: 난이도 관리자 페이지 생성

#### 2.1 DifficultyLevelsManager 컴포넌트 생성

- **파일**: `app/(admin)/admin/content-metadata/_components/DifficultyLevelsManager.tsx`
- **기능**:
  - 난이도 목록 표시 (콘텐츠 타입별 탭 또는 필터)
  - 난이도 생성/수정/삭제
  - 표시 순서 조정
  - 활성화/비활성화 토글
- **패턴**: `PublishersManager.tsx`, `PlatformsManager.tsx` 참고

#### 2.2 관리자 페이지 통합

- **파일**: `app/(admin)/admin/content-metadata/page.tsx`
- **변경사항**: DifficultyLevelsManager를 탭 또는 섹션으로 추가

### Phase 3: 공통 컴포넌트 생성

#### 3.1 DifficultySelectField 컴포넌트 생성

- **파일**: `components/forms/DifficultySelectField.tsx`
- **기능**:
  - 콘텐츠 타입에 따라 적절한 난이도 옵션 로드
  - `difficulty_levels` 테이블에서 동적 조회
  - FormSelect 래퍼로 일관된 UI 제공
- **Props**:
  ```typescript
  type DifficultySelectFieldProps = {
    contentType: 'book' | 'lecture' | 'custom';
    defaultValue?: string; // difficulty_level_id
    name?: string;
    label?: string;
    required?: boolean;
  };
  ```


#### 3.2 useDifficultyOptions 훅 생성

- **파일**: `lib/hooks/useDifficultyOptions.ts`
- **기능**:
  - 콘텐츠 타입별 난이도 옵션 조회
  - 캐싱 및 로딩 상태 관리
  - 에러 처리
- **API 엔드포인트**: `/api/difficulty-levels?contentType=book`

### Phase 4: MasterLectureForm 통일

#### 4.1 SubjectSelectionFields 적용

- **파일**: `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx`
- **변경사항**:
  - 직접 구현된 과목 선택 로직 제거
  - `useSubjectSelection` 훅 사용
  - `SubjectSelectionFields` 컴포넌트로 교체
- **기대 효과**: 코드 중복 제거, 일관성 향상

#### 4.2 EditForm도 동일하게 적용

- **파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`
- **변경사항**: NewForm과 동일한 패턴 적용

### Phase 5: 난이도 필드 마이그레이션 및 적용

#### 5.1 콘텐츠 테이블 스키마 변경

- **작업**: `difficulty_level` (text) → `difficulty_level_id` (uuid FK)
- **마이그레이션**: Phase 0에서 이미 완료

#### 5.2 MasterBookForm 수정

- **파일**: `app/(admin)/admin/master-books/new/MasterBookForm.tsx`
- **변경사항**:
  - 하드코딩된 난이도 옵션 제거
  - `DifficultySelectField` 컴포넌트 사용
  - `difficulty_level_id` 필드로 변경

#### 5.3 MasterBookEditForm 수정

- **파일**: `app/(admin)/admin/master-books/[id]/edit/MasterBookEditForm.tsx`
- **변경사항**: NewForm과 동일하게 적용

#### 5.4 MasterLectureForm 수정

- **파일**: `app/(admin)/admin/master-lectures/new/MasterLectureForm.tsx`
- **변경사항**:
  - 하드코딩된 난이도 옵션 제거
  - `DifficultySelectField` 컴포넌트 사용
  - `difficulty_level_id` 필드로 변경

#### 5.5 MasterLectureEditForm 수정

- **파일**: `app/(admin)/admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx`
- **변경사항**: NewForm과 동일하게 적용

#### 5.6 MasterCustomContentForm 수정

- **파일**: `app/(admin)/admin/master-custom-contents/new/MasterCustomContentForm.tsx`
- **변경사항**:
  - 하드코딩된 난이도 옵션 제거
  - `DifficultySelectField` 컴포넌트 사용 (contentType='custom')
  - `difficulty_level_id` 필드로 변경

### Phase 6: 데이터 레이어 업데이트

#### 6.1 contentMasters.ts 업데이트

- **변경사항**:
  - `getDifficultiesForMasterBooks` → `getDifficultyLevels('book')` 사용
  - `getDifficultiesForMasterLectures` → `getDifficultyLevels('lecture')` 사용
  - 생성/수정 함수에서 `difficulty_level_id` 처리

#### 6.2 타입 정의 업데이트

- **파일**: `lib/types/plan/domain.ts`, `lib/types/lecture.ts`
- **변경사항**: `difficulty_level: string` → `difficulty_level_id: string | null`

### Phase 7: 코드 최적화 및 리팩토링

#### 7.1 중복 코드 제거

- 과목 선택 로직 통일
- 난이도 필드 통일
- 공통 유효성 검사 로직 추출

#### 7.2 타입 안전성 개선

- 난이도 옵션 타입 정의
- 콘텐츠 타입별 타입 가드 추가

#### 7.3 에러 처리 개선

- 난이도 로드 실패 시 기본값 제공
- 사용자 친화적 에러 메시지

### Phase 8: 테스트 및 검증

#### 8.1 기능 테스트

- 각 폼에서 난이도 옵션이 올바르게 로드되는지 확인
- SubjectSelectionFields가 모든 폼에서 일관되게 작동하는지 확인
- 난이도 CRUD 기능 테스트

#### 8.2 데이터 일관성 검증

- 마이그레이션 후 데이터 무결성 확인
- 외래키 제약조건 동작 확인

## 구현 순서

1. **Phase 0**: 난이도 마스터 테이블 생성 및 데이터 마이그레이션 (기반 작업)
2. **Phase 1**: 난이도 마스터 데이터 CRUD 구현
3. **Phase 2**: 난이도 관리자 페이지 생성
4. **Phase 3**: 공통 컴포넌트 생성
5. **Phase 4**: MasterLectureForm 통일
6. **Phase 5**: 난이도 필드 마이그레이션 및 적용
7. **Phase 6**: 데이터 레이어 업데이트
8. **Phase 7**: 코드 최적화
9. **Phase 8**: 테스트 및 검증

## 예상 효과

- **데이터 무결성**: 외래키 제약조건으로 데이터 일관성 보장
- **관리 편의성**: 관리자 페이지에서 난이도 중앙 관리
- **코드 중복 감소**: 약 200-300줄 감소 예상
- **일관성 향상**: 모든 폼에서 동일한 컴포넌트 사용
- **유지보수성 개선**: 난이도 옵션 변경 시 한 곳만 수정
- **확장성**: 새로운 난이도 추가가 용이

## 참고 파일

- `app/(admin)/admin/content-metadata/_components/PublishersManager.tsx`: CRUD 컴포넌트 패턴
- `app/(admin)/admin/content-metadata/_components/PlatformsManager.tsx`: CRUD 컴포넌트 패턴
- `app/(admin)/actions/contentMetadataActions.ts`: Server Actions 패턴
- `lib/data/contentMetadata.ts`: 데이터 레이어 패턴
- `components/forms/SubjectSelectionFields.tsx`: 공통 컴포넌트 패턴
- `lib/hooks/useSubjectSelection.ts`: 커스텀 훅 패턴

### To-dos

- [ ] DifficultySelectField 공통 컴포넌트 생성 (components/forms/DifficultySelectField.tsx)
- [ ] useDifficultyOptions 훅 생성 (lib/hooks/useDifficultyOptions.ts)
- [ ] MasterLectureForm에 SubjectSelectionFields 적용 (new 및 edit)
- [ ] MasterBookForm에 DifficultySelectField 적용 (new)
- [ ] MasterBookEditForm에 DifficultySelectField 적용 (edit)
- [ ] MasterLectureForm에 DifficultySelectField 적용 (new)
- [ ] MasterLectureEditForm에 DifficultySelectField 적용 (edit)
- [ ] MasterCustomContentForm에 DifficultySelectField 적용
- [ ] 커스텀 콘텐츠 난이도 API 추가 (필요시)
- [ ] 모든 폼에서 기능 테스트 및 데이터 일관성 검증