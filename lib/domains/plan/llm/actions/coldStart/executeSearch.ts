/**
 * Task 3: ì›¹ ê²€ìƒ‰ ì‹¤í–‰
 *
 * ì´ íŒŒì¼ì€ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ë°›ì•„ì„œ Gemini APIë¡œ ì›¹ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * ê¸°ì¡´ searchExternalContentActionì„ ë˜í•‘í•˜ì—¬ ì½œë“œ ìŠ¤íƒ€íŠ¸ íŒŒì´í”„ë¼ì¸ì— ë§ëŠ”
 * ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 *
 * ğŸ“¥ INPUT:  ê²€ìƒ‰ ì¿¼ë¦¬ (Task 2ì˜ ê²°ê³¼)
 * ğŸ“¤ OUTPUT: AI ì‘ë‹µ (raw í…ìŠ¤íŠ¸) ë˜ëŠ” ì—ëŸ¬
 *
 * ë‚´ë¶€ ë™ì‘:
 * 1. Gemini APIì— ê²€ìƒ‰ ìš”ì²­ (Grounding í™œì„±í™”)
 * 2. ì‘ë‹µ í…ìŠ¤íŠ¸ ë°˜í™˜ (íŒŒì‹±ì€ Task 4ì—ì„œ)
 *
 * ì£¼ì˜ì‚¬í•­:
 * - API í‚¤ê°€ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨ (GOOGLE_AI_API_KEY)
 * - ë¬´ë£Œ í‹°ì–´ëŠ” ë¶„ë‹¹ í˜¸ì¶œ ì œí•œì´ ìˆìŒ
 */

import type { SearchQuery, ExecuteSearchResult } from "./types";
import { getGeminiProvider } from "../../providers";
import { logError } from "@/lib/errors/handler";

/**
 * ì›¹ ê²€ìƒ‰ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
 *
 * AIì—ê²Œ ë‹¤ìŒì„ ìš”ì²­í•©ë‹ˆë‹¤:
 * 1. ì›¹ì—ì„œ êµì¬/ê°•ì˜ ì •ë³´ ê²€ìƒ‰
 * 2. ëª©ì°¨, ì´ í˜ì´ì§€ìˆ˜ ë“± êµ¬ì¡° ì •ë³´ ì¶”ì¶œ
 * 3. JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
 */
const COLD_START_SEARCH_PROMPT = `
ë‹¹ì‹ ì€ í•™ìŠµ ì½˜í…ì¸  êµ¬ì¡° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ê²€ìƒ‰ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµì¬ ë˜ëŠ” ì¸í„°ë„· ê°•ì˜ì˜ êµ¬ì¡° ì •ë³´ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.

**ì°¾ì•„ì•¼ í•  ì •ë³´**:
- ëª©ì°¨ (Table of Contents)
- ì´ í˜ì´ì§€ ìˆ˜ (êµì¬) ë˜ëŠ” ì´ ê°•ì˜ ìˆ˜ (ì¸ê°•)
- ì±•í„°ë³„ í˜ì´ì§€/ê°•ì˜ ë²”ìœ„

**ì¶œë ¥ í˜•ì‹**:
ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.

{
  "results": [
    {
      "title": "ì •í™•í•œ êµì¬/ê°•ì˜ ì œëª©",
      "author": "ì €ì ë˜ëŠ” ê°•ì‚¬ëª… (ì•Œ ìˆ˜ ìˆìœ¼ë©´)",
      "publisher": "ì¶œíŒì‚¬ ë˜ëŠ” í”Œë«í¼ (ì•Œ ìˆ˜ ìˆìœ¼ë©´)",
      "contentType": "book" ë˜ëŠ” "lecture",
      "totalRange": ìˆ«ì (ì´ í˜ì´ì§€ ë˜ëŠ” ê°•ì˜ ìˆ˜),
      "chapters": [
        {
          "title": "ì±•í„° ì œëª©",
          "startRange": ì‹œì‘ í˜ì´ì§€/ê°•ì˜ ë²ˆí˜¸,
          "endRange": ì¢…ë£Œ í˜ì´ì§€/ê°•ì˜ ë²ˆí˜¸
        }
      ],
      "description": "ì½˜í…ì¸  íŠ¹ì§• ì„¤ëª…"
    }
  ]
}

**ê·œì¹™**:
1. ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” êµì¬/ê°•ì˜ë§Œ í¬í•¨í•˜ì„¸ìš”
2. ì´ ë²”ìœ„ë¥¼ ëª¨ë¥´ë©´ í•©ë¦¬ì ìœ¼ë¡œ ì¶”ì • (êµì¬: 200-400í˜ì´ì§€, ì¸ê°•: 20-50ê°•)
3. chapters ë°°ì—´ì€ ì „ì²´ ë²”ìœ„ë¥¼ ì»¤ë²„í•´ì•¼ í•©ë‹ˆë‹¤
4. ìµœì‹ íŒì„ ìš°ì„ í•˜ë˜, ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” ë²„ì „ì„ ì„ íƒí•˜ì„¸ìš”
5. 3-5ê°œ ì •ë„ì˜ ì¶”ì²œ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ì„¸ìš”
`;

/**
 * ì›¹ ê²€ìƒ‰ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
 *
 * Gemini APIì˜ Grounding ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì›¹ì—ì„œ êµì¬/ê°•ì˜ ì •ë³´ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
 * ê²€ìƒ‰ ê²°ê³¼ëŠ” JSON í…ìŠ¤íŠ¸ë¡œ ë°˜í™˜ë˜ë©°, íŒŒì‹±ì€ Task 4(parseResults)ì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 *
 * @param searchQuery - ê²€ìƒ‰ ì¿¼ë¦¬ (Task 2ì˜ ê²°ê³¼)
 * @returns ê²€ìƒ‰ ê²°ê³¼ (ì„±ê³µ ì‹œ rawContent, ì‹¤íŒ¨ ì‹œ error)
 *
 * @example
 * const result = await executeWebSearch({
 *   query: "ê³ ë“±í•™êµ ìˆ˜í•™ ë¯¸ì ë¶„ ê°œë… êµì¬ ì¶”ì²œ ëª©ì°¨",
 *   context: "ë¯¸ì ë¶„ ê°œë…ì„œ"
 * });
 *
 * if (result.success) {
 *   console.log("ì‘ë‹µ:", result.rawContent);
 *   // ë‹¤ìŒ ë‹¨ê³„: parseResults(result.rawContent)
 * } else {
 *   console.error("ì‹¤íŒ¨:", result.error);
 * }
 */
export async function executeWebSearch(
  searchQuery: SearchQuery
): Promise<ExecuteSearchResult> {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1ë‹¨ê³„: ì…ë ¥ ê²€ì¦
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if (!searchQuery.query || searchQuery.query.trim() === "") {
    return {
      success: false,
      error: "ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤",
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2ë‹¨ê³„: Gemini Provider ê°€ì ¸ì˜¤ê¸°
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let provider;
  try {
    provider = getGeminiProvider();
  } catch (error) {
    logError(error, { source: "executeWebSearch", phase: "provider-init" });
    return {
      success: false,
      error: "AI ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
    };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 3ë‹¨ê³„: ê²€ìƒ‰ ìš”ì²­ ìƒì„±
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const userPrompt = `
ê²€ìƒ‰ì–´: "${searchQuery.query}"
ì°¾ê³ ì í•˜ëŠ” ì½˜í…ì¸ : ${searchQuery.context}

ìœ„ ì¡°ê±´ì— ë§ëŠ” í•™ìŠµ ì½˜í…ì¸ ì˜ êµ¬ì¡° ì •ë³´(ëª©ì°¨, ì´ í˜ì´ì§€/ê°•ì˜ ìˆ˜)ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”.
JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”.
`;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 4ë‹¨ê³„: API í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  try {
    const response = await provider.createMessage({
      system: COLD_START_SEARCH_PROMPT,
      messages: [{ role: "user", content: userPrompt }],
      temperature: 0.2, // ì‚¬ì‹¤ì ì¸ ì •ë³´ ì¶”ì¶œì„ ìœ„í•´ ë‚®ì€ temperature
      maxTokens: 4096, // JSON ì‘ë‹µì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ ì¶©ë¶„í•œ í† í° í™•ë³´
      grounding: { enabled: true, mode: "always" }, // ì›¹ ê²€ìƒ‰ í™œì„±í™”
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5ë‹¨ê³„: ì‘ë‹µ ë°˜í™˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    if (!response.content || response.content.trim() === "") {
      return {
        success: false,
        error: "AIê°€ ë¹ˆ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤",
      };
    }

    return {
      success: true,
      rawContent: response.content,
    };
  } catch (error) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì—ëŸ¬ ì²˜ë¦¬
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const errorMessage =
      error instanceof Error ? error.message : String(error);

    logError(error, { source: "executeWebSearch", phase: "api-call" });

    // ì—ëŸ¬ ìœ í˜•ë³„ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
    if (errorMessage.includes("429") || errorMessage.includes("quota")) {
      return {
        success: false,
        error: "API í˜¸ì¶œ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
      };
    }

    if (errorMessage.includes("401") || errorMessage.includes("403")) {
      return {
        success: false,
        error: "API ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
      };
    }

    if (
      errorMessage.includes("network") ||
      errorMessage.includes("ECONNREFUSED")
    ) {
      return {
        success: false,
        error: "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
      };
    }

    return {
      success: false,
      error: `ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorMessage}`,
    };
  }
}

// ============================================================================
// í…ŒìŠ¤íŠ¸ìš© Mock í•¨ìˆ˜
// ============================================================================

/**
 * Mock ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 *
 * API í˜¸ì¶œ ì—†ì´ í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 * ì‹¤ì œ ê²€ìƒ‰ ê²°ê³¼ì™€ ìœ ì‚¬í•œ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 *
 * @param searchQuery - ê²€ìƒ‰ ì¿¼ë¦¬
 * @returns Mock ê²€ìƒ‰ ê²°ê³¼
 */
export function getMockSearchResult(searchQuery: SearchQuery): ExecuteSearchResult {
  const mockResponse = {
    results: [
      {
        title: `${searchQuery.context} - ê¸°ë³¸ì„œ`,
        author: "í™ê¸¸ë™",
        publisher: "êµìœ¡ì¶œíŒì‚¬",
        contentType: "book",
        totalRange: 320,
        chapters: [
          { title: "1ì¥. ê¸°ì´ˆ ê°œë…", startRange: 1, endRange: 60 },
          { title: "2ì¥. í•µì‹¬ ì´ë¡ ", startRange: 61, endRange: 150 },
          { title: "3ì¥. ì‘ìš© ë¬¸ì œ", startRange: 151, endRange: 250 },
          { title: "4ì¥. ì‹¤ì „ ì—°ìŠµ", startRange: 251, endRange: 320 },
        ],
        description: "ê¸°ì´ˆë¶€í„° ì‹¬í™”ê¹Œì§€ ì²´ê³„ì ìœ¼ë¡œ í•™ìŠµí•  ìˆ˜ ìˆëŠ” êµì¬",
      },
      {
        title: `${searchQuery.context} - ì™„ì„±`,
        author: "ê¹€ì˜í¬",
        publisher: "í•™ìŠµë¯¸ë””ì–´",
        contentType: "lecture",
        totalRange: 45,
        chapters: [
          { title: "ê°œë… ì •ë¦¬", startRange: 1, endRange: 15 },
          { title: "ìœ í˜•ë³„ í’€ì´", startRange: 16, endRange: 30 },
          { title: "ì‹¤ì „ ëª¨ì˜ê³ ì‚¬", startRange: 31, endRange: 45 },
        ],
        description: "ë‹¨ê¸°ê°„ì— í•µì‹¬ì„ ì •ë¦¬í•  ìˆ˜ ìˆëŠ” ì¸ê°•",
      },
    ],
  };

  return {
    success: true,
    rawContent: JSON.stringify(mockResponse, null, 2),
  };
}
