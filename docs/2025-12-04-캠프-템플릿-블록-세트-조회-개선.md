# 캠프 템플릿 블록 세트 조회 로직 개선

## 작업 일자
2025-12-04

## 목표
캠프 템플릿의 시간 블록이 학생 영역과 관리자 영역 모두에서 정상적으로 표시되도록 조회 로직을 개선

## 문제점
1. 학생 영역 제출 상세 페이지에서 시간 블록이 표시되지 않음
2. 관리자 영역 제출 내용 확인 페이지에서도 동일한 문제 발생 가능성
3. `scheduler_options` 파싱에 의존하는 복잡한 로직

## 해결 방법

### 1. 블록 세트 ID 조회 우선순위 변경

**기존 순서**:
1. `scheduler_options` 파싱
2. `camp_template_block_sets` 직접 조회
3. `template_data` 조회

**개선 후 순서**:
1. `camp_template_block_sets` 직접 조회 (1순위) - 가장 직접적이고 명확
2. `scheduler_options` 파싱 (2순위 - Fallback)
3. `template_data` 조회 (3순위 - 하위 호환성)

### 2. 학생 영역 수정

#### `app/(student)/camp/[invitationId]/submitted/page.tsx`

**변경 사항**:
- `templateBlockSetId` 변수 추가
- 블록 세트 조회 시 `templateBlockSetId` 저장
- `PlanGroupDetailView`에 `templateBlockSetId`와 `campTemplateId` 전달

```typescript
let templateBlockSetId: string | null = null;

// ... 블록 세트 조회 로직 ...

if (blockSetData) {
  templateBlockSet = blockSetData;
  templateBlockSetId = blockSetData.id;
}

// ... 

<PlanGroupDetailView
  // ... 기타 props ...
  templateBlockSetId={templateBlockSetId}
  campTemplateId={group.camp_template_id}
/>
```

**블록 세트 ID 조회 로직**:
```typescript
// 1. 연결 테이블에서 직접 조회 (가장 직접적인 방법)
if (group.camp_template_id) {
  const { data: templateBlockSetLink } = await supabase
    .from("camp_template_block_sets")
    .select("tenant_block_set_id")
    .eq("camp_template_id", group.camp_template_id)
    .maybeSingle();

  if (templateBlockSetLink) {
    blockSetId = templateBlockSetLink.tenant_block_set_id;
  }
}

// 2. scheduler_options에서 template_block_set_id 확인 (Fallback)
if (!blockSetId && group.scheduler_options) {
  // ... scheduler_options 파싱 ...
}

// 3. template_data에서 block_set_id 확인 (하위 호환성)
if (!blockSetId && templateData?.block_set_id) {
  blockSetId = templateData.block_set_id;
}
```

### 3. 관리자 영역 수정

#### `app/(admin)/actions/campTemplateActions.ts`

**변경 사항**:
- `getCampPlanGroupForReview` 함수에서 `templateBlockSetId` 반환 추가
- 블록 세트 조회 우선순위를 학생 영역과 동일하게 변경

```typescript
let templateBlockSetId: string | null = null;

// ... 블록 세트 조회 로직 ...

if (templateBlockSet) {
  templateBlockSetName = templateBlockSet.name;
  templateBlockSetId = templateBlockSet.id;
}

// ...

return {
  // ... 기타 반환값 ...
  templateBlockSetId,
};
```

#### `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/review/page.tsx`

**변경 사항**:
- `templateBlockSetId`를 `CampPlanGroupReviewForm`에 전달

```typescript
<CampPlanGroupReviewForm
  // ... 기타 props ...
  templateBlockSetId={result.templateBlockSetId || null}
/>
```

#### `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/review/CampPlanGroupReviewForm.tsx`

**변경 사항**:
- `templateBlockSetId` prop 추가
- 블록 세트 정보 표시 UI 추가 (학생 영역과 동일한 형식)

```typescript
type CampPlanGroupReviewFormProps = {
  // ... 기타 props ...
  templateBlockSetId?: string | null;
};

// 블록 세트 정보 표시 UI
{templateBlockSetName && (
  <div className="mt-6 border-t border-gray-100 pt-4">
    <label className="text-xs font-medium text-gray-500">블록 세트</label>
    <div className="mt-2 space-y-3">
      <div>
        <p className="text-sm font-semibold text-gray-900">{templateBlockSetName}</p>
      </div>
      {templateBlocks.length > 0 ? (
        <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {templateBlocks.map((block) => (
            <div key={block.id} className="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2">
              <div className="text-sm font-medium text-gray-900">
                {["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"][block.day_of_week]}
              </div>
              <div className="text-xs text-gray-600">
                {block.start_time} ~ {block.end_time}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <p className="text-sm text-gray-500">등록된 시간 블록이 없습니다.</p>
      )}
    </div>
  </div>
)}
```

## 개선 효과

1. **로직 단순화**: `camp_template_id`만 있으면 바로 조회 가능
2. **명확성 향상**: 테이블 관계를 직접 활용
3. **성능 개선**: JSON 파싱 없이 직접 조회
4. **유지보수성 향상**: 더 직관적인 코드
5. **일관성**: 학생 영역과 관리자 영역 모두 동일한 로직 적용

## 테이블 구조

### `camp_template_block_sets`
- `camp_template_id`: 캠프 템플릿 ID
- `tenant_block_set_id`: 테넌트 블록 세트 ID

### `tenant_block_sets`
- `id`: 블록 세트 ID
- `name`: 블록 세트 이름
- `tenant_id`: 테넌트 ID

### `tenant_blocks`
- `id`: 블록 ID
- `tenant_block_set_id`: 블록 세트 ID
- `day_of_week`: 요일 (0-6)
- `start_time`: 시작 시간
- `end_time`: 종료 시간

## 관련 파일

### 학생 영역
- `app/(student)/camp/[invitationId]/submitted/page.tsx`

### 관리자 영역
- `app/(admin)/actions/campTemplateActions.ts`
- `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/review/page.tsx`
- `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/review/CampPlanGroupReviewForm.tsx`

## 참고 사항

- 하위 호환성을 위해 `scheduler_options`와 `template_data` 조회도 유지
- 마이그레이션 전 데이터도 정상적으로 처리 가능
- 두 영역 모두 동일한 우선순위 로직을 사용하여 일관성 유지

