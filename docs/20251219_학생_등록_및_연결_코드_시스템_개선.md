# 학생 등록 및 연결 코드 시스템 개선

## 작업 일자
2025-12-19

## 작업 개요
학생 등록 및 연결 코드 시스템의 남은 작업 4개를 완료하고, 코드 중복을 제거하며, 2025년 모범 사례를 적용하여 시스템을 개선했습니다.

## 완료된 작업

### 1. linkStudentWithConnectionCode 트랜잭션 처리 개선 ✅

**문제점**:
- `app/actions/auth.ts`의 `linkStudentWithConnectionCode` 함수가 여러 테이블에 순차적으로 INSERT/UPDATE 수행
- 중간에 실패 시 데이터 불일치 가능성
- 트랜잭션 보장이 없음

**해결 방법**:
- PostgreSQL 함수 `link_student_with_connection_code()` 생성
- PostgREST RPC 호출을 사용하여 자동 트랜잭션 보장
- `SECURITY DEFINER`로 RLS 정책 우회 (Admin 클라이언트 대신)

**구현 파일**:
- `supabase/migrations/20251219114051_create_link_student_with_connection_code_function.sql` (신규)
- `app/actions/auth.ts` 수정

**주요 변경사항**:
- 기존의 순차적 INSERT/UPDATE/DELETE 작업을 하나의 PostgreSQL 함수로 통합
- 트랜잭션 보장으로 데이터 무결성 확보
- 에러 발생 시 자동 롤백

### 2. 학생 관련 에러 처리 통합 모듈 생성 ✅

**문제점**:
- `app/(admin)/actions/studentManagementActions.ts`에서 에러 처리가 일관되지 않음
- 문자열 기반 에러 메시지로 타입 안전성 부족
- 에러 코드가 표준화되지 않음

**해결 방법**:
- `PlanGroupError` 패턴을 참고하여 `StudentError` 클래스 생성
- 에러 코드 상수 정의
- 에러 생성 헬퍼 함수

**구현 파일**:
- `lib/errors/studentErrors.ts` (신규)

**주요 기능**:
- `StudentError` 클래스: 학생 관련 에러를 표준화
- `StudentErrorCodes`: 에러 코드 상수 정의
- `toStudentError`: 에러를 StudentError로 변환하는 헬퍼 함수
- `getStudentErrorMessage`: 에러 코드와 컨텍스트를 기반으로 사용자 친화적 메시지 생성

### 3. 사용자 친화적 에러 메시지 매핑 추가 ✅

**문제점**:
- 데이터베이스 에러 코드가 사용자에게 직접 노출됨
- 에러 메시지가 일관되지 않음

**해결 방법**:
- 에러 코드 → 사용자 친화적 메시지 매핑
- RLS 정책 위반, 제약조건 위반 등 구체적인 메시지 제공

**구현 파일**:
- `lib/errors/studentErrors.ts`에 `STUDENT_ERROR_MESSAGES` 추가

**주요 에러 메시지**:
- `STUDENT_NOT_FOUND`: "학생 정보를 찾을 수 없습니다."
- `CONNECTION_CODE_INVALID`: "유효하지 않은 연결 코드입니다."
- `CONNECTION_CODE_EXPIRED`: "만료된 연결 코드입니다."
- `CONNECTION_CODE_ALREADY_USED`: "이미 사용된 연결 코드입니다."
- `RLS_POLICY_VIOLATION`: "데이터 접근 권한이 없습니다. 관리자에게 문의하세요."

### 4. 기능 문서화 및 사용 가이드 작성 ✅

**구현 파일**:
- `docs/student-connection-code-guide.md` (신규)

**내용**:
- 관리자용 사용 가이드
- 학생용 사용 가이드
- 연결 코드 생성 및 사용 절차
- FAQ 및 트러블슈팅
- 기술적 세부사항
- 보안 고려사항

## 코드 최적화

### 중복 코드 제거

1. **에러 처리 패턴 통일**
   - `StudentError` 클래스 사용으로 전환 준비 완료
   - 향후 `studentManagementActions.ts`에서 점진적으로 적용 가능

2. **연결 코드 검증 로직 통합**
   - `validateConnectionCode`는 이미 `lib/utils/connectionCodeUtils.ts`로 이동됨 ✅

3. **에러 응답 형식 표준화**
   - 모든 Server Action이 `{ success: boolean; error?: string }` 형식 사용
   - `StudentError` 사용 시 일관된 형식 유지

## 데이터베이스 변경사항

### 신규 함수

**함수명**: `link_student_with_connection_code`

**파라미터**:
- `p_user_id` (uuid): 새 사용자 ID
- `p_connection_code` (text): 연결 코드

**반환값**: `jsonb`
```json
{
  "success": true,
  "student_id": "uuid",
  "old_student_id": "uuid"
}
```

**특징**:
- 트랜잭션 보장: 모든 작업이 하나의 트랜잭션으로 처리됨
- SECURITY DEFINER: RLS 정책 우회
- 자동 롤백: 중간에 실패 시 모든 변경사항 롤백

## 변경된 파일

### 신규 파일
1. `supabase/migrations/20251219114051_create_link_student_with_connection_code_function.sql`
2. `lib/errors/studentErrors.ts`
3. `docs/student-connection-code-guide.md`
4. `docs/20251219_학생_등록_및_연결_코드_시스템_개선.md`

### 수정된 파일
1. `app/actions/auth.ts`
   - `linkStudentWithConnectionCode` 함수를 PostgreSQL 함수 호출로 변경
   - 트랜잭션 보장으로 데이터 무결성 확보

## 테스트 권장사항

1. **연결 코드 생성 및 사용 테스트**
   - 관리자가 학생 등록 시 연결 코드 생성 확인
   - 학생이 회원가입 시 연결 코드 사용 확인

2. **에러 처리 테스트**
   - 만료된 연결 코드 사용 시 에러 메시지 확인
   - 이미 사용된 연결 코드 사용 시 에러 메시지 확인
   - 유효하지 않은 연결 코드 사용 시 에러 메시지 확인

3. **트랜잭션 테스트**
   - 연결 과정 중 에러 발생 시 롤백 확인
   - 데이터 무결성 확인

## 향후 개선 사항

1. **studentManagementActions.ts에서 StudentError 사용**
   - 현재는 기존 에러 처리 방식 유지
   - 필요 시 점진적으로 `StudentError` 사용으로 전환

2. **에러 로깅 개선**
   - 에러 트래킹 서비스 통합 (Sentry 등)
   - 에러 발생 시 알림 시스템

3. **연결 코드 보안 강화**
   - 연결 코드 암호화 고려
   - 연결 코드 사용 이력 추적

## 참고 문서

- [학생 등록 및 연결 코드 시스템 개선 계획](.cursor/plans/-6f9e6333.plan.md)
- [학생 연결 코드 시스템 사용 가이드](docs/student-connection-code-guide.md)
- [PlanGroupError 패턴 참고](lib/errors/planGroupErrors.ts)

---

**작업 완료 시간**: 약 3-4시간
**예상 작업 시간 대비**: 계획대로 완료
