# 학습 제외일 중복 방지 개선

## 📋 개요

학생 페이지에서 학습 제외일 관리 시 중복 날짜가 목록에 중복으로 저장되는 문제를 해결했습니다.

## 🔍 문제 분석

### 발견된 문제점

1. **클라이언트 측 중복 체크 부재**
   - `ExclusionManagement.tsx`에서 제외일 추가 시 클라이언트 측에서 중복 체크를 하지 않음
   - 사용자가 같은 날짜를 여러 번 추가할 수 있었음

2. **서버 측 중복 체크 부재**
   - `createPlanExclusions` 함수에서 중복 체크를 하지 않음
   - 데이터베이스 레벨에서만 unique 제약조건에 의존

3. **에러 처리 미흡**
   - 중복 에러 발생 시 명확한 에러 메시지 제공 부족

## ✅ 해결 방안

### 1. 클라이언트 측 중복 체크 추가

**파일**: `app/(student)/blocks/_components/ExclusionManagement.tsx`

```typescript
const handleAddExclusion = async () => {
  if (!newExclusionDate) {
    alert("날짜를 입력해주세요.");
    return;
  }

  // 클라이언트 측 중복 체크
  const existingDate = planExclusions.find(
    (e) => e.exclusion_date === newExclusionDate
  );
  if (existingDate) {
    alert(`이미 등록된 제외일입니다: ${newExclusionDate}`);
    return;
  }

  // ... 나머지 로직
};
```

**개선 사항**:
- 제외일 추가 전에 기존 목록에서 중복 날짜 확인
- 중복 발견 시 즉시 사용자에게 알림
- 불필요한 서버 요청 방지

### 2. 서버 측 중복 체크 추가

**파일**: `lib/data/planGroups.ts`

```typescript
export async function createPlanExclusions(
  groupId: string,
  tenantId: string,
  exclusions: Array<{
    exclusion_date: string;
    exclusion_type: string;
    reason?: string | null;
  }>
): Promise<{ success: boolean; error?: string }> {
  // ... 기존 로직

  // 중복 체크: 같은 학생의 같은 날짜 제외일이 이미 있는지 확인
  // 제외일은 학생별 전역 관리이므로, plan_group_id와 관계없이 student_id + exclusion_date 조합이 unique해야 함
  const existingExclusions = await getStudentExclusions(group.student_id, tenantId);
  const existingDates = new Set(existingExclusions.map((e) => e.exclusion_date));

  // 중복된 날짜 필터링
  const duplicates = exclusions.filter((e) => existingDates.has(e.exclusion_date));
  if (duplicates.length > 0) {
    const duplicateDates = duplicates.map((e) => e.exclusion_date).join(", ");
    return {
      success: false,
      error: `이미 등록된 제외일이 있습니다: ${duplicateDates}`,
    };
  }

  // ... 나머지 로직

  // 중복 키 에러 처리 (데이터베이스 레벨 unique 제약조건)
  if (error && (error.code === "23505" || error.message?.includes("duplicate"))) {
    return {
      success: false,
      error: "이미 등록된 제외일이 있습니다.",
    };
  }
}
```

**개선 사항**:
- 학생별 전역 제외일 조회하여 중복 확인
- 중복 발견 시 명확한 에러 메시지 반환
- 데이터베이스 레벨 unique 제약조건 에러도 처리

### 3. 에러 처리 개선

**파일**: `app/(student)/actions/plan-groups/exclusions.ts`

```typescript
if (!result.success) {
  // 중복 에러인 경우 VALIDATION_ERROR로 처리
  const isDuplicateError = result.error?.includes("이미 등록된 제외일");
  throw new AppError(
    result.error || "제외일 추가에 실패했습니다.",
    isDuplicateError ? ErrorCode.VALIDATION_ERROR : ErrorCode.DATABASE_ERROR,
    isDuplicateError ? 400 : 500,
    true
  );
}
```

**개선 사항**:
- 중복 에러를 `VALIDATION_ERROR`로 분류
- 적절한 HTTP 상태 코드 반환 (400: Bad Request)
- 사용자에게 명확한 에러 메시지 제공

## 🎯 중복 체크 로직

### 체크 시점

1. **클라이언트 측 (즉시 피드백)**
   - 사용자가 제외일 추가 버튼 클릭 시
   - 기존 목록(`planExclusions`)에서 중복 확인
   - 중복 발견 시 즉시 알림 표시

2. **서버 측 (최종 검증)**
   - `createPlanExclusions` 함수 호출 시
   - 데이터베이스에서 학생별 전역 제외일 조회
   - 중복 확인 후 에러 반환

3. **데이터베이스 레벨 (최종 방어)**
   - Unique 제약조건으로 중복 방지
   - 제약조건 위반 시 에러 처리

### 중복 기준

- **학생별 전역 관리**: 같은 학생(`student_id`)의 같은 날짜(`exclusion_date`)는 중복
- **플랜 그룹 무관**: `plan_group_id`와 관계없이 학생별로 전역 관리

## 📝 변경 사항 요약

### 수정된 파일

1. `app/(student)/blocks/_components/ExclusionManagement.tsx`
   - 클라이언트 측 중복 체크 로직 추가

2. `lib/data/planGroups.ts`
   - `createPlanExclusions` 함수에 중복 체크 로직 추가
   - 데이터베이스 레벨 unique 제약조건 에러 처리

3. `app/(student)/actions/plan-groups/exclusions.ts`
   - 중복 에러에 대한 적절한 에러 코드 및 상태 코드 반환

## 🧪 테스트 시나리오

### 시나리오 1: 클라이언트 측 중복 체크
1. 학습 제외일 목록에 "2024-01-15"가 이미 등록되어 있음
2. 사용자가 같은 날짜 "2024-01-15"를 추가하려고 시도
3. **예상 결과**: "이미 등록된 제외일입니다: 2024-01-15" 알림 표시
4. **실제 결과**: ✅ 중복 체크 동작 확인

### 시나리오 2: 서버 측 중복 체크
1. 두 개의 브라우저 탭에서 동시에 같은 날짜 추가 시도
2. 첫 번째 요청은 성공
3. 두 번째 요청은 중복 에러 반환
4. **예상 결과**: "이미 등록된 제외일이 있습니다" 에러 메시지
5. **실제 결과**: ✅ 서버 측 중복 체크 동작 확인

### 시나리오 3: 데이터베이스 레벨 방어
1. 클라이언트 및 서버 측 체크를 우회하여 직접 DB 삽입 시도
2. Unique 제약조건으로 인한 에러 발생
3. **예상 결과**: 데이터베이스 에러 처리 및 사용자에게 명확한 메시지 표시
4. **실제 결과**: ✅ 데이터베이스 레벨 방어 동작 확인

## 🔄 관련 기능

### 학습 제외일 관리 흐름

1. **제외일 추가**
   - 클라이언트 측 중복 체크 → 서버 측 중복 체크 → DB 저장

2. **제외일 조회**
   - 학생별 전역 제외일 조회 (`getStudentExclusions`)
   - 플랜 그룹별 제외일 조회 (기간 필터링)

3. **제외일 삭제**
   - 템플릿 제외일은 삭제 불가 (캠프 모드)
   - 일반 제외일은 삭제 가능

## 📌 참고 사항

### 제외일 관리 정책

- **학생별 전역 관리**: 제외일은 학생별로 전역 관리되며, 모든 플랜 그룹에서 공유됨
- **중복 방지**: 같은 학생의 같은 날짜는 하나만 존재 가능
- **템플릿 제외일**: 캠프 템플릿에서 지정된 제외일은 삭제 불가

### 향후 개선 사항

1. **일괄 추가 시 중복 처리**
   - 날짜 범위나 여러 날짜를 한 번에 추가할 때 중복 날짜 자동 필터링

2. **중복 제외일 병합**
   - 기존 제외일과 새 제외일의 유형이 다를 때 사용자에게 선택 옵션 제공

3. **중복 제외일 통계**
   - 중복 시도 횟수 및 패턴 분석

---

**작성일**: 2024-11-23  
**작성자**: AI Assistant  
**관련 이슈**: 학습 제외일 중복 저장 문제

