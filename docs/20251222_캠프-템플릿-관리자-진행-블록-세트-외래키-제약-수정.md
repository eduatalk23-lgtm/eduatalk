# ìº í”„ í…œí”Œë¦¿ ê´€ë¦¬ì ì§„í–‰ ì‹œ ë¸”ë¡ ì„¸íŠ¸ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìˆ˜ì •

**ì‘ì—… ì¼ì‹œ**: 2024ë…„ 12ì›” 22ì¼  
**ì‘ì—…ì**: AI Assistant

## ğŸ“‹ ë¬¸ì œ ìƒí™©

ê´€ë¦¬ìê°€ ìº í”„ í…œí”Œë¦¿ ì°¸ì—¬ìì˜ ë‚¨ì€ ë‹¨ê³„ë¥¼ ì§„í–‰í•  ë•Œ(`continueCampStepsForAdmin`) ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

### ì—ëŸ¬ ë©”ì‹œì§€

```
Error [AppError]: í”Œëœ ê·¸ë£¹ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: insert or update on table "plan_groups" violates foreign key constraint "plan_groups_block_set_id_fkey"
```

### ì›ì¸ ë¶„ì„

1. **ì˜ëª»ëœ `block_set_id` ì„¤ì •**
   - `continueCampStepsForAdmin` í•¨ìˆ˜ì—ì„œ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ID(`tenantBlockSetId`)ë¥¼ `creationData.block_set_id`ì— ì§ì ‘ ì„¤ì •
   - `plan_groups.block_set_id`ëŠ” `student_block_sets` í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ëŠ” ì™¸ë˜ í‚¤
   - í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ëŠ” `tenant_block_sets` í…Œì´ë¸”ì— ìˆìœ¼ë¯€ë¡œ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°œìƒ

2. **ìº í”„ ëª¨ë“œ ì²˜ë¦¬ ëˆ„ë½**
   - `campActions.ts`ì˜ `submitCampParticipation`ì—ì„œëŠ” ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•˜ê³  ìˆìŒ
   - `block_set_id = null`ë¡œ ì„¤ì •í•˜ê³  `scheduler_options.template_block_set_id`ì— ì €ì¥
   - `continueCampStepsForAdmin`ì—ì„œëŠ” ì´ ë¡œì§ì´ ëˆ„ë½ë¨

## ğŸ›  í•´ê²° ë°©ë²•

### ìˆ˜ì • ë‚´ìš©

**íŒŒì¼**: `app/(admin)/actions/camp-templates/progress.ts`

**ë³€ê²½ ì „**:
```typescript
creationData.plan_type = "camp";
if (result.group.camp_template_id) {
  creationData.camp_template_id = result.group.camp_template_id;
  
  // ìº í”„ ëª¨ë“œì—ì„œ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
  const { getTemplateBlockSetId } = await import("@/lib/plan/blocks");
  const schedulerOptions: SchedulerOptions = (result.group.scheduler_options as SchedulerOptions | null) ?? {};
  const tenantBlockSetId = await getTemplateBlockSetId(
    result.group.camp_template_id,
    schedulerOptions
  );

  // ì¡°íšŒëœ block_set_id ì„¤ì •
  if (tenantBlockSetId) {
    creationData.block_set_id = tenantBlockSetId; // âŒ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜
  } else {
    console.warn(
      "[continueCampStepsForAdmin] í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:",
      result.group.camp_template_id
    );
  }
}
```

**ë³€ê²½ í›„**:
```typescript
creationData.plan_type = "camp";

// ìº í”„ ëª¨ë“œì—ì„œëŠ” block_set_idë¥¼ nullë¡œ ì„¤ì •
// í…œí”Œë¦¿ì˜ block_set_idëŠ” tenant_block_sets í…Œì´ë¸”ì˜ IDì´ë¯€ë¡œ
// plan_groups.block_set_id (student_block_sets ì°¸ì¡°)ì— ì €ì¥í•  ìˆ˜ ì—†ìŒ
creationData.block_set_id = null; // âœ… nullë¡œ ì„¤ì •

if (result.group.camp_template_id) {
  creationData.camp_template_id = result.group.camp_template_id;
  
  // ìº í”„ ëª¨ë“œì—ì„œ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
  const { getTemplateBlockSetId } = await import("@/lib/plan/blocks");
  const schedulerOptions: SchedulerOptions = (result.group.scheduler_options as SchedulerOptions | null) ?? {};
  const tenantBlockSetId = await getTemplateBlockSetId(
    result.group.camp_template_id,
    schedulerOptions,
    tenantId // âœ… tenantId ì „ë‹¬
  );

  // í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ scheduler_optionsì— ì €ì¥
  if (tenantBlockSetId) {
    if (!creationData.scheduler_options) {
      creationData.scheduler_options = {};
    }
    type SchedulerOptionsWithTemplateBlockSet = SchedulerOptions & {
      template_block_set_id?: string;
    };
    (creationData.scheduler_options as SchedulerOptionsWithTemplateBlockSet).template_block_set_id =
      tenantBlockSetId; // âœ… scheduler_optionsì— ì €ì¥
    console.log(
      "[continueCampStepsForAdmin] scheduler_optionsì— template_block_set_id ì¶”ê°€:",
      {
        template_block_set_id: tenantBlockSetId,
        scheduler_options: creationData.scheduler_options,
      }
    );
  } else {
    console.warn(
      "[continueCampStepsForAdmin] í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:",
      result.group.camp_template_id
    );
  }
}
```

## âœ… ìˆ˜ì • ê²°ê³¼

### ìˆ˜ì • ì „

- âŒ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì—ëŸ¬ ë°œìƒ
- âŒ í”Œëœ ê·¸ë£¹ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨
- âŒ ê´€ë¦¬ìê°€ ë‚¨ì€ ë‹¨ê³„ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŒ

### ìˆ˜ì • í›„

- âœ… ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ í•´ê²°
- âœ… í”Œëœ ê·¸ë£¹ ì—…ë°ì´íŠ¸ ì„±ê³µ
- âœ… í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDê°€ `scheduler_options.template_block_set_id`ì— ì €ì¥ë¨
- âœ… ê´€ë¦¬ìê°€ ë‚¨ì€ ë‹¨ê³„ë¥¼ ì •ìƒì ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŒ

## ğŸ” ë°ì´í„° íë¦„

### ìˆ˜ì • ì „

```
continueCampStepsForAdmin
  â†“
tenantBlockSetId ì¡°íšŒ âœ…
  â†“
creationData.block_set_id = tenantBlockSetId âŒ
  â†“
plan_groups ì—…ë°ì´íŠ¸ ì‹œë„
  â†“
ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ âŒ
```

### ìˆ˜ì • í›„

```
continueCampStepsForAdmin
  â†“
creationData.block_set_id = null âœ…
  â†“
tenantBlockSetId ì¡°íšŒ âœ…
  â†“
scheduler_options.template_block_set_id = tenantBlockSetId âœ…
  â†“
plan_groups ì—…ë°ì´íŠ¸ ì„±ê³µ âœ…
```

## ğŸ“ ì£¼ìš” ë³€ê²½ ì‚¬í•­

1. **`block_set_id`ë¥¼ `null`ë¡œ ì„¤ì •**
   - ìº í”„ ëª¨ë“œì—ì„œëŠ” í•­ìƒ `null`ë¡œ ì„¤ì •
   - ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°©ì§€

2. **í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ `scheduler_options`ì— ì €ì¥**
   - `scheduler_options.template_block_set_id`ì— ì €ì¥
   - `campActions.ts`ì˜ `submitCampParticipation`ê³¼ ë™ì¼í•œ íŒ¨í„´

3. **`tenantId` íŒŒë¼ë¯¸í„° ì¶”ê°€**
   - `getTemplateBlockSetId` í˜¸ì¶œ ì‹œ `tenantId` ì „ë‹¬
   - ì¡°íšŒ ì •í™•ë„ í–¥ìƒ

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [ìº í”„ í…œí”Œë¦¿ ì œì¶œ ì‹œ ë¸”ë¡ ì„¸íŠ¸ê°’ ì „ë‹¬ ê²€í† ](./20251222_ìº í”„-í…œí”Œë¦¿-ë¸”ë¡-ì„¸íŠ¸-ì „ë‹¬-ê²€í† .md)
- [ê´€ë¦¬ì í˜ì´ì§€ 'ë‚¨ì€ ë‹¨ê³„ ì§„í–‰í•˜ê¸°' ë¸”ë¡ì„¸íŠ¸ ë¡œì§ ì—…ë°ì´íŠ¸](./admin-camp-continue-block-set-logic-update.md)
- [í”Œëœ ê·¸ë£¹ ì‹œê°„ ë¸”ë¡ ê¸°ëŠ¥ ê°œì„  Phase 1 ì™„ë£Œ ë³´ê³ ](./plan-group-time-block-improvement-phase1-completion-2025-02-01.md)

