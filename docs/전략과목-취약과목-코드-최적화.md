# 전략과목/취약과목 코드 최적화 및 정확도 향상 작업

## 작업 개요

전략과목/취약과목 관련 코드의 중복 제거, 로직 통합, 타입 안전성 강화, 데이터 흐름 검증을 수행했습니다.

## 작업 일시

2024년 12월

## 주요 변경 사항

### 1. 공통 유틸리티 함수 생성

**파일**: `lib/utils/subjectAllocation.ts` (신규)

- `getEffectiveAllocation`: 콘텐츠의 전략/취약 설정을 가져오는 통합 함수
  - UI와 서버 로직에서 동일한 로직 사용
  - 매칭 로직 개선 (대소문자 무시, 공백 정규화)
  - 구조화된 로깅 지원
- `validateAllocations`: 할당 데이터 유효성 검증 함수
  - `weekly_days` 값 검증 (2, 3, 4만 허용)
  - `subject_type` 값 검증
  - 상세한 에러 메시지 제공

### 2. 중복 코드 제거

**변경된 파일**:
- `app/(student)/plan/new-group/_components/Step6Simplified.tsx`
  - `getEffectiveAllocation` 함수 제거 (329-365줄)
  - 공통 유틸리티 함수 import 및 사용
- `app/(student)/plan/new-group/_components/Step6FinalReview/ContentAllocationUI.tsx`
  - `getEffectiveAllocation` 함수 제거 (61-97줄)
  - 공통 유틸리티 함수 import 및 사용
- `lib/plan/1730TimetableLogic.ts`
  - `getContentAllocation` 함수를 공통 유틸리티 함수로 대체
  - 기존 함수는 deprecated로 표시하고 새 함수로 리다이렉트

**효과**: 약 50줄 이상의 중복 코드 제거

### 3. 타입 안전성 강화

- `lib/utils/subjectAllocation.ts`에 타입 정의 추가
  - `ContentAllocation`, `SubjectAllocation`, `ContentInfo`, `AllocationResult` 타입
- 런타임 검증 함수 추가
  - `validateAllocations`: 입력 데이터 유효성 검증
  - `validateWeeklyDays`: weekly_days 값 검증

### 4. 데이터 흐름 검증

**변경된 파일**:
- `lib/plan/scheduler.ts`
  - `generate1730TimetablePlans` 함수 시작 부분에 데이터 검증 로직 추가
  - 전달된 설정이 올바른 형식인지 확인
- `lib/plan/planDataLoader.ts`
  - `createScheduleCalculationOptions` 함수에서 `subject_allocations`, `content_allocations` 추출 시 검증
  - 데이터 구조 불일치 시 경고 로그 및 기본값 적용
- `app/(student)/actions/plan-groups/create.ts`
  - `subject_allocations`, `content_allocations` 저장 전 검증 로직 추가
- `app/(student)/actions/plan-groups/update.ts`
  - `subject_allocations`, `content_allocations` 업데이트 전 검증 로직 추가

### 5. 로깅 및 에러 처리 개선

**변경된 파일**:
- `lib/utils/subjectAllocation.ts`
  - 개발 환경에서만 상세 로그 출력
  - 매칭 과정 단계별 로그 (어떤 단계에서 매칭되었는지)
  - 매칭 실패 시 원인 분석 로그
- `lib/plan/scheduler.ts`
  - 전략과목/취약과목 설정 관련 에러를 명확하게 구분
  - 에러 발생 시 상세한 컨텍스트 정보 제공

### 6. 테스트 작성

**신규 파일**:
- `__tests__/utils/subjectAllocation.test.ts`
  - `getEffectiveAllocation` 함수 단위 테스트
  - `validateAllocations` 함수 단위 테스트
  - 콘텐츠별 설정 우선순위 테스트
  - 교과별 설정 폴백 테스트
  - 기본값 적용 테스트
  - 매칭 로직 정확도 테스트
- `__tests__/integration/strategyWeaknessAllocation.test.ts`
  - UI → DB → 스케줄러 전체 흐름 테스트
  - 전략과목 주당 배정 일수 정확도 테스트
  - 취약과목 전체 학습일 배정 테스트

## 개선 효과

- **코드 중복 제거**: 약 50줄 이상의 중복 코드 제거
- **유지보수성 향상**: 단일 소스에서 로직 관리
- **타입 안전성 향상**: 런타임 에러 감소
- **디버깅 용이**: 구조화된 로그로 문제 추적 용이
- **정확도 향상**: 데이터 검증으로 잘못된 설정 방지

## 호환성

- 기존 동작과의 호환성 유지
- 점진적 마이그레이션 (기존 함수를 deprecated로 표시 후 단계적 제거)
- 프로덕션 환경에서의 로그 레벨 관리 (개발 환경에서만 상세 로그)

## 참고 파일

- `lib/utils/subjectAllocation.ts`: 공통 유틸리티 함수
- `lib/plan/1730TimetableLogic.ts`: 기존 함수 (deprecated)
- `lib/plan/scheduler.ts`: 스케줄러 로직
- `lib/plan/planDataLoader.ts`: 데이터 로드 로직
- `app/(student)/actions/plan-groups/create.ts`: 플랜 그룹 생성
- `app/(student)/actions/plan-groups/update.ts`: 플랜 그룹 업데이트

