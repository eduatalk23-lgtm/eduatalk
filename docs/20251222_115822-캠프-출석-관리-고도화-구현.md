# 캠프 출석 관리 고도화 구현

## 작업 일시
2025-12-22

## 작업 개요

캠프 출석 관리 기능을 고도화하여 다음 기능을 추가했습니다:
1. 캠프 기간에 해당하는 달력 표시 (출석 상태 색상 코딩)
2. 날짜 클릭 시 해당 날짜의 학생별 출결(입실/퇴실) 상세 조회

## 구현 내용

### 1. 데이터 레이어 확장 (`lib/data/campAttendance.ts`)

#### 추가된 타입
- `AttendanceRecordWithStudent`: 출석 기록 + 학생 정보 타입

#### 추가된 함수
- `getCampAttendanceRecordsByDate(templateId, date)`: 특정 날짜의 출석 기록 조회 (학생 정보 포함)
- `getCampAttendanceRecordsWithStudents(templateId, startDate, endDate)`: 캠프 기간 전체 출석 기록 조회 (학생 정보 포함, 달력용)

**최적화 사항:**
- JOIN을 사용하여 학생 정보를 함께 조회하여 N+1 문제 해결
- 날짜별 그룹화는 클라이언트에서 처리 (서버 부하 감소)

### 2. API 라우트 추가 (`app/api/camp-attendance-records/route.ts`)

**엔드포인트:**
- `GET /api/camp-attendance-records?templateId=xxx&date=2024-01-15` (날짜별 조회)
- `GET /api/camp-attendance-records?templateId=xxx&startDate=2024-01-01&endDate=2024-01-31` (기간별 조회)

**권한:**
- admin, consultant만 접근 가능

### 3. React Query 훅 추가

#### Query Options (`lib/query-options/campStats.ts`)
- `campDateAttendanceQueryOptions(templateId, date)`: 날짜별 출석 기록 조회
- `campAttendanceRecordsQueryOptions(templateId, startDate, endDate)`: 캠프 기간 전체 출석 기록 조회 (달력용)

**캐싱 전략:**
- 날짜별 조회: staleTime 1분 (자주 변경 가능)
- 전체 기록: staleTime 5분 (달력 표시용)

#### 훅 (`lib/hooks/useCampStats.ts`)
- `useCampDateAttendance(templateId, date)`: 날짜별 출석 기록 조회
- `useCampAttendanceRecords(templateId, startDate, endDate)`: 캠프 기간 출석 기록 조회

### 4. 캠프 출석 달력 컴포넌트 (`CampAttendanceCalendar.tsx`)

**기능:**
- 캠프 시작일~종료일만 표시 (기간 외 날짜 비활성화)
- 날짜별 출석 상태 색상 코딩:
  - 출석: 초록색 (`bg-green-500`)
  - 지각: 노란색 (`bg-yellow-500`)
  - 결석: 빨간색 (`bg-red-500`)
  - 조퇴: 주황색 (`bg-orange-500`)
  - 공결: 파란색 (`bg-blue-500`)
  - 혼합 상태: 보라색 (`bg-purple-500`) - 여러 학생이 다른 상태
- 날짜 클릭 시 상세 다이얼로그 열기
- 캠프 시작일로 이동 버튼
- 범례 표시

**참고:**
- `MultiSelectCalendar` 컴포넌트 구조 참고
- `date-fns` 활용

### 5. 날짜별 출석 상세 다이얼로그 (`DateAttendanceDetailDialog.tsx`)

**기능:**
- 선택한 날짜의 모든 참여자 출석 정보 표시
- 학생별 정보:
  - 학생 이름 (student_id로 조회)
  - 출석 상태 배지
  - 입실 시간 및 방법
  - 퇴실 시간 및 방법
  - 메모 (있는 경우)
- 로딩 상태 처리
- 빈 데이터 처리

**Dialog 컴포넌트 사용:**
- `open`, `onOpenChange` props 사용
- `size="3xl"` 사용
- `showCloseButton={true}` 설정

### 6. CampAttendanceDashboard 업데이트

**변경 사항:**
- 달력 컴포넌트 추가 (캠프 기간 정보 아래)
- 날짜 선택 상태 관리 (`useState`)
- 출석 기록 조회 훅 추가 (달력용)
- 다이얼로그 컴포넌트 통합

**레이아웃 순서:**
1. 헤더
2. 캠프 기간 정보
3. **출석 달력 (신규)**
4. 출석 통계 카드
5. 참여자별 출석 현황 테이블

## 최적화 및 개선 사항

### 1. 중복 코드 제거
- `getCampAttendanceRecordsByDate`는 `getCampAttendanceRecords`를 재사용하지 않고 JOIN을 사용하여 학생 정보를 함께 조회
- 날짜별 그룹화는 클라이언트에서 `useMemo`로 처리

### 2. 성능 최적화
- 달력용 전체 기록은 한 번만 조회하고 클라이언트에서 필터링
- 날짜별 상세 조회는 필요할 때만 (lazy loading)
- React Query 캐싱 활용

### 3. 타입 안전성
- 모든 함수에 명시적 타입 정의
- `null` 체크 및 Optional Chaining 활용
- `any` 타입 사용 금지

### 4. 접근성
- 키보드 네비게이션 지원
- ARIA 레이블 추가
- 스크린 리더 지원

## 파일 구조

```
app/(admin)/admin/camp-templates/[id]/attendance/
├── _components/
│   ├── CampAttendanceDashboard.tsx (수정)
│   ├── CampAttendanceStatsCards.tsx (기존)
│   ├── CampParticipantAttendanceTable.tsx (기존)
│   ├── CampAttendanceCalendar.tsx (신규)
│   └── DateAttendanceDetailDialog.tsx (신규)
├── page.tsx (기존)

app/api/
└── camp-attendance-records/
    └── route.ts (신규)

lib/
├── data/
│   └── campAttendance.ts (수정 - 함수 추가)
├── query-options/
│   └── campStats.ts (수정 - Query Options 추가)
└── hooks/
    └── useCampStats.ts (수정 - 훅 추가)
```

## 데이터 흐름

```
CampAttendanceDashboard
  ├─ useCampAttendanceRecords (전체 기록, 달력용)
  │   └─ getCampAttendanceRecordsWithStudents (startDate, endDate)
  │
  ├─ CampAttendanceCalendar
  │   ├─ attendanceRecords prop 받음
  │   ├─ 날짜별 상태 계산 (useMemo)
  │   └─ onDateClick → setSelectedDate
  │
  └─ DateAttendanceDetailDialog
      ├─ selectedDate prop 받음
      ├─ useCampDateAttendance (선택한 날짜만)
      │   └─ getCampAttendanceRecordsByDate (date)
      └─ 학생 정보 표시
```

## 검증 사항

- [x] 캠프 기간 외 날짜는 클릭 불가
- [x] 출석 상태별 색상이 올바르게 표시됨
- [x] 날짜 클릭 시 다이얼로그가 정상적으로 열림
- [x] 학생 이름이 올바르게 표시됨
- [x] 입실/퇴실 시간이 올바른 형식으로 표시됨
- [x] 빈 데이터 처리 (출석 기록 없음)
- [x] 로딩 상태 처리
- [x] 에러 처리
- [x] 반응형 디자인 (모바일 대응)
- [x] 다크모드 지원

## 기술 스택

- **date-fns**: 날짜 처리 및 달력 렌더링
- **lucide-react**: 아이콘 (ChevronLeft, ChevronRight, Calendar)
- **React Query**: 서버 상태 관리 및 캐싱
- **Tailwind CSS**: 스타일링

## 참고 자료

- 기존 `MultiSelectCalendar` 컴포넌트: `app/(student)/blocks/_components/MultiSelectCalendar.tsx`
- Dialog 컴포넌트: `components/ui/Dialog.tsx`
- Supabase 스키마: `attendance_records` 테이블 구조 확인 완료


