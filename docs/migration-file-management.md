# 마이그레이션 파일 관리 가이드

## 📋 기본 원칙

### ❌ 삭제하면 안 되는 경우

1. **이미 실행된 마이그레이션**
   - Supabase는 마이그레이션 파일의 타임스탬프를 기반으로 실행 여부를 추적합니다
   - 삭제하면 새로운 환경(로컬, 스테이징, 프로덕션)에 적용할 때 문제가 발생할 수 있습니다
   - 마이그레이션 히스토리를 추적하기 위해 필요합니다

2. **스키마 변경 마이그레이션**
   - 테이블 생성, 컬럼 추가/수정 등
   - 데이터베이스 구조의 변경 이력을 보존해야 합니다

### ✅ 삭제 가능한 경우 (권장하지 않음)

1. **아직 실행하지 않은 마이그레이션**
   - 기능적으로는 삭제 가능하지만, 히스토리 유지를 위해 보관 권장

2. **일회성 데이터 정리 작업**
   - 중복 제거, 데이터 마이그레이션 등
   - 이미 실행되었다면 삭제해도 기능적으로는 문제 없음
   - 하지만 히스토리 유지를 위해 보관 권장

## 🔧 중복 제거 마이그레이션 처리 방법

### 방법 1: 마이그레이션 파일 유지 (권장)

```sql
-- Migration: Remove duplicate schools
-- Description: 학교 데이터 중복 제거 (일회성 작업)
-- Date: 2025-01-27
-- Note: 이미 실행된 경우 재실행해도 안전 (idempotent)

DO $$
BEGIN
  -- 중복 제거 로직
  -- ...
END $$;
```

**장점**:
- 마이그레이션 히스토리 보존
- 새로운 환경에 적용 시 자동으로 중복 제거
- 언제 어떤 작업이 수행되었는지 추적 가능

### 방법 2: 기존 마이그레이션에 통합

중복 제거 로직을 `20250127000001_create_schools_table.sql` 파일 끝에 추가:

```sql
-- ============================================
-- 중복 제거 (일회성 작업)
-- ============================================
DO $$
-- 중복 제거 로직
END $$;
```

**장점**:
- 별도 파일 없이 관리
- 테이블 생성과 함께 중복 제거

### 방법 3: 스크립트로 분리 (개발 환경용)

`scripts/remove-duplicate-schools.sql` 같은 별도 스크립트로 관리

**장점**:
- 마이그레이션 히스토리와 분리
- 필요할 때만 수동 실행

## 📝 현재 상황

### 삭제된 파일
- `20250127000002_remove_duplicate_schools.sql` (사용자가 삭제함)

### 권장 조치

1. **이미 실행했다면**: 
   - 삭제해도 기능적으로는 문제 없음
   - 하지만 마이그레이션 히스토리 유지를 위해 복구 권장

2. **아직 실행하지 않았다면**:
   - 중복 제거 로직을 기존 마이그레이션 파일에 추가
   - 또는 새로운 마이그레이션 파일 생성

## 🚀 실행 방법

### Supabase CLI 사용

```bash
# 마이그레이션 상태 확인
npx supabase migration list

# 마이그레이션 적용
npx supabase db push

# 특정 마이그레이션만 실행 (권장하지 않음)
npx supabase migration up --version 20250127000002
```

### 수동 실행

Supabase Dashboard의 SQL Editor에서 직접 실행 가능

## ⚠️ 주의사항

1. **마이그레이션 파일 순서**
   - 타임스탬프 순서대로 실행되므로 순서 변경 금지

2. **Idempotent (멱등성)**
   - 마이그레이션은 여러 번 실행해도 같은 결과가 나와야 함
   - `IF NOT EXISTS`, `ON CONFLICT DO NOTHING` 등 사용

3. **롤백 고려**
   - 복잡한 마이그레이션은 롤백 스크립트도 준비

4. **백업**
   - 중요한 데이터 변경 전 백업 필수

## 📚 참고

- [Supabase Migrations Guide](https://supabase.com/docs/guides/cli/local-development#database-migrations)
- [PostgreSQL Migration Best Practices](https://www.postgresql.org/docs/current/ddl-alter.html)

