# 플랜 미리보기 및 저장 요구사항 정리

## 사용자 의도 정리

### 1. 쪼개진 플랜 식별 번호 추가

**요구사항:**

- 주차 앞에 "플랜 번호" 필드를 추가
- 같은 논리적 플랜이 여러 블록에 걸쳐 쪼개진 경우, 같은 번호를 부여하여 식별 가능하게 함

**구현 방법:**

- 플랜 그룹 내에서 플랜을 순차적으로 번호 부여 (1, 2, 3, ...)
- 같은 논리적 플랜 식별 키: `plan_group_id + plan_date + content_id + planned_start_page_or_time + planned_end_page_or_time`
- 쪼개진 플랜의 모든 레코드는 동일한 플랜 번호 사용

**예시:**

```
플랜 번호 | 주차 | 일차 | 날짜 | 시간 | ...
---------|------|------|------|------|----
1        | 1    | 1    | ...  | 10:00~11:18 | (첫 번째 부분)
1        | 1    | 1    | ...  | 11:18~12:00 | (일부) (두 번째 부분)
2        | 1    | 1    | ...  | 13:00~13:36 | [이어서] (같은 플랜의 세 번째 부분)
2        | 1    | 1    | ...  | 13:36~15:00 | (네 번째 부분)
3        | 1    | 2    | ...  | 10:00~11:24 | (새로운 플랜)
```

### 2. 일별 스케줄과 미리보기 불일치 해결

**문제점:**

1. **상태뱃지 불일치**: Step7 일별 스케줄에는 `[이어서]`, `(일부)` 뱃지가 표시되지만, 미리보기에는 없거나 다름
2. **시간 불일치**: Step7에서 표시되는 정확한 시간(예: "10:00 ~ 11:18")과 미리보기/저장된 시간이 다름

**해결 방안:**

- Step7의 `TimeSlotsWithPlans` 로직을 서버 액션에 통합
- `assignPlanTimes` 함수를 구현하여 Step7과 동일한 시간 계산 및 상태뱃지 계산
- 미리보기와 실제 저장 시 동일한 로직 사용

### 3. 학습과 관계 없는 항목도 플랜으로 저장

**요구사항:**

- 학원일정, 이동시간, 지정휴일, 점심시간 등도 `student_plan` 테이블에 저장
- 이들은 학습 플랜과 동일한 구조로 저장되지만, `content_type`이나 특별한 플래그로 구분

**저장 구조:**

```typescript
{
  plan_date: string;
  block_index: number;
  content_type: "book" | "lecture" | "custom" | "academy" | "travel" | "lunch" | "self_study";
  content_id?: string | null; // 학원일정의 경우 학원 ID, 이동/점심/자율학습은 null
  content_title: string | null; // "학원일정", "이동시간", "점심시간", "자율학습" 등
  start_time: string;
  end_time: string;
  // ... 기타 필드
}
```

### 4. 지정휴일 처리

**요구사항:**

- 지정휴일의 경우, 배정된 학습시간을 시작시간, 종료시간으로 저장
- 이름은 "자율학습"으로 저장
- 소요시간은 배정된 학습시간과 동일

**예시:**

```
날짜: 2025-11-25
날짜 유형: 지정휴일
배정된 학습시간: 10:00 ~ 12:00, 13:00 ~ 19:00

저장될 플랜:
1. plan_date: "2025-11-25"
   content_type: "self_study"
   content_title: "자율학습"
   start_time: "10:00"
   end_time: "12:00"
   소요시간: 2시간

2. plan_date: "2025-11-25"
   content_type: "self_study"
   content_title: "자율학습"
   start_time: "13:00"
   end_time: "19:00"
   소요시간: 6시간
```

## 구현 계획

### 1단계: 플랜 번호 추가

- `student_plan` 테이블에 `plan_number` 컬럼 추가 (integer)
- 플랜 생성 시 논리적 플랜 그룹별로 번호 부여
- 미리보기 테이블에 "플랜 번호" 컬럼 추가 (주차 앞)

### 2단계: assignPlanTimes 함수 구현

- Step7의 `TimeSlotsWithPlans` 로직 이식
- 쪼개진 플랜 처리 및 상태뱃지(`is_partial`, `is_continued`) 계산
- 정확한 시간 계산 (소요시간 기반)

### 3단계: 비학습 항목 저장

- `dateTimeSlots`에서 "학습시간"이 아닌 슬롯도 플랜으로 저장
- 학원일정, 이동시간, 점심시간, 자율학습 등 처리
- 지정휴일의 경우 자율학습으로 저장

### 4단계: 미리보기와 실제 저장 일치

- 미리보기와 실제 저장 시 동일한 로직 사용
- 상태뱃지 표시 일치
- 시간 정보 일치

## 데이터베이스 스키마 변경

### student_plan 테이블

```sql
-- 플랜 번호 추가
ALTER TABLE student_plan
ADD COLUMN plan_number integer;

COMMENT ON COLUMN student_plan.plan_number IS '플랜 그룹 내에서의 논리적 플랜 번호. 같은 플랜이 여러 블록에 걸쳐 쪼개진 경우 동일한 번호 사용';

-- content_type 확장 (기존: book, lecture, custom)
-- 추가: academy, travel, lunch, self_study
-- CHECK 제약조건 업데이트 필요
```

## 예상 결과

### 미리보기 테이블 구조

```
플랜번호 | 주차 | 일차 | 날짜 | 날짜유형 | 상태뱃지 | 시작시간 | 종료시간 | 교과 | 과목 | 유형 | 이름 | 학습내역 | 회차 | 학습분량 | 소요시간
---------|------|------|------|----------|----------|----------|----------|------|------|------|------|----------|------|----------|----------
1        | 1    | 1    | ...  | 학습일   |          | 10:00    | 11:18    | 국어 | 국어 | 교재| ... | ...     | 1    | 1-14p    | 1시간18분
1        | 1    | 1    | ...  | 학습일   | (일부)   | 11:18    | 12:00    | 국어 | 국어 | 교재| ... | ...     | 1    | 1-14p    | 42분
-        | 1    | 1    | ...  | 학습일   |          | 12:00    | 13:00    | -    | -    | 점심| 점심시간 | -      | -    | -        | 1시간
1        | 1    | 1    | ...  | 학습일   | [이어서] | 13:00    | 13:36    | 국어 | 국어 | 교재| ... | ...     | 1    | 1-14p    | 36분
2        | 1    | 1    | ...  | 학습일   |          | 13:36    | 15:00    | 수학 | 미적분|교재| ... | ...     | 1    | 1-15p    | 1시간24분
-        | 1    | 1    | ...  | 학습일   |          | 15:00    | 15:30    | -    | -    | 이동| 이동시간 | -      | -    | -        | 30분
-        | 1    | 1    | ...  | 학습일   |          | 15:30    | 17:00    | -    | -    | 학원| 학원일정 | -      | -    | -        | 1시간30분
-        | 2    | 1    | ...  | 지정휴일 |          | 10:00    | 12:00    | -    | -    | 자율| 자율학습 | -      | -    | -        | 2시간
-        | 2    | 1    | ...  | 지정휴일 |          | 13:00    | 19:00    | -    | -    | 자율| 자율학습 | -      | -    | -        | 6시간
```
