# 학생 정보 관리 필드 일관성 점검 결과

**작업일**: 2025-01-15  
**작업자**: AI Assistant  
**점검 범위**: 학생 정보 관리 페이지 필드 일관성 및 메모 필드 관리자 전용 확인

---

## 📋 점검 항목

### 1. 필드 일관성 확인

#### ✅ 연락처 필드
- **위치**: `student_profiles` 테이블
- **필드명**:
  - `phone` (본인 연락처) - 필수
  - `mother_phone` (어머니 연락처)
  - `father_phone` (아버지 연락처)
  - `emergency_contact_phone` (비상연락처 전화번호)
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `ProfileInfoSection`에서 표시 및 편집 가능

#### ✅ 성별 필드
- **위치**: `student_profiles` 테이블
- **필드명**: `gender`
- **타입**: `"남" | "여" | null`
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `ProfileInfoSection`에서 표시 및 편집 가능

#### ✅ 주소 필드
- **위치**: `student_profiles` 테이블
- **필드명**:
  - `address` (주소)
  - `address_detail` (상세주소)
  - `postal_code` (우편번호)
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `ProfileInfoSection`에서 표시 및 편집 가능

#### ✅ 수능 연도 필드
- **위치**: `student_career_goals` 테이블
- **필드명**: `exam_year`
- **타입**: `number | null`
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `CareerInfoSection`에서 표시 및 편집 가능

#### ✅ 교육과정 필드
- **위치**: `student_career_goals` 테이블
- **필드명**: `curriculum_revision`
- **타입**: `"2009 개정" | "2015 개정" | "2022 개정" | null`
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `CareerInfoSection`에서 표시 및 편집 가능

#### ✅ 희망 대학교 필드
- **위치**: `student_career_goals` 테이블
- **필드명**: `desired_university_ids`
- **타입**: `string[] | null` (최대 3개, 통합 ID 형식: `UNIV_*`, `SCHOOL_*`)
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `CareerInfoSection`에서 표시 및 편집 가능

#### ✅ 진로 계열 필드
- **위치**: `student_career_goals` 테이블
- **필드명**: `desired_career_field`
- **타입**: `string | null` (인문계열, 사회계열, 자연계열 등)
- **상태**: ✅ 일관성 유지
- **관리자 페이지**: `CareerInfoSection`에서 표시 및 편집 가능

---

## 🔒 메모 필드 관리자 전용 확인

### 데이터베이스 스키마
- **테이블**: `students`
- **필드명**: `memo`
- **타입**: `text | null`
- **설명**: 관리자 전용 메모 필드

### RLS 정책 확인
```sql
-- students 테이블의 RLS 정책
- 학생은 자신의 데이터만 조회/수정 가능 (auth.uid() = id)
- 관리자는 tenant_id가 일치하는 학생 데이터 조회/수정 가능
```

**⚠️ 주의사항**: RLS 정책은 테이블 레벨이므로, 필드 레벨 제한은 불가능합니다. 애플리케이션 레벨에서 메모 필드를 제외해야 합니다.

### 애플리케이션 레벨 확인

#### ✅ 학생 페이지 (`app/(student)`)
- `getStudentById()` 함수는 `STUDENT_BASE_FIELDS`를 사용하며, `memo` 필드가 **포함되지 않음**
- `getCurrentStudent()` 함수도 `getStudentById()`를 사용하므로 `memo` 필드 접근 불가
- **결과**: ✅ 학생은 메모 필드에 접근할 수 없음

#### ✅ 학부모 페이지 (`app/(parent)`)
- 학생 정보 조회 시 `select("id, name, grade, class")`만 사용
- `memo` 필드가 명시적으로 제외됨
- **결과**: ✅ 학부모는 메모 필드에 접근할 수 없음

#### ✅ 관리자 페이지 (`app/(admin)/admin/students/[id]`)
- `getStudentById()` 함수를 사용하지만, 관리자 페이지에서는 `(student as any).memo`로 명시적으로 접근
- `BasicInfoSection`에서 메모 필드를 표시 및 편집 가능
- **결과**: ✅ 관리자만 메모 필드에 접근 가능

### 확인된 코드 위치

#### 학생 정보 조회 함수
```typescript
// lib/data/students.ts
const STUDENT_BASE_FIELDS = "id,tenant_id,name,grade,class,birth_date,school_id,student_number,enrolled_at,status,created_at,updated_at";
// memo 필드가 포함되지 않음 ✅
```

#### 관리자 페이지에서 메모 필드 접근
```typescript
// app/(admin)/admin/students/[id]/page.tsx
memo: (student as any).memo,  // 관리자 전용 접근
```

#### 관리자 페이지에서 메모 필드 표시
```typescript
// app/(admin)/admin/students/[id]/_components/sections/BasicInfoSection.tsx
<FormField
  {...memoField.field}
  label="메모"
  type="text"
  placeholder="메모를 입력하세요"
/>
```

---

## 📊 Supabase MCP 점검 결과

### 테이블 구조 확인
- ✅ `students` 테이블: 기본 학적 정보
- ✅ `student_profiles` 테이블: 프로필 정보 (연락처, 성별, 주소 등)
- ✅ `student_career_goals` 테이블: 진로 목표 정보 (수능 연도, 교육과정, 희망 대학교, 진로 계열)

### RLS 정책 확인
- ✅ `students` 테이블: 학생은 자신의 데이터만 조회/수정 가능
- ✅ `student_profiles` 테이블: 학생은 자신의 프로필만 조회/수정 가능
- ✅ `student_career_goals` 테이블: 학생은 자신의 진로 목표만 조회/수정 가능

### 보안 권고사항
- ⚠️ `all_schools_view`, `today_plan_view`에 SECURITY DEFINER 속성이 설정되어 있음 (별도 검토 필요)
- ⚠️ 여러 함수에 `search_path` 설정이 없음 (보안 개선 권장)

---

## ✅ 최종 결론

### 필드 일관성
- ✅ 모든 필드가 올바른 테이블에 위치
- ✅ 관리자 페이지에서 모든 필드를 올바르게 표시 및 편집 가능
- ✅ 필드 타입 및 제약조건이 일관성 있게 유지됨

### 메모 필드 관리자 전용
- ✅ 학생은 메모 필드에 접근할 수 없음 (애플리케이션 레벨에서 제외)
- ✅ 학부모는 메모 필드에 접근할 수 없음 (애플리케이션 레벨에서 제외)
- ✅ 관리자만 메모 필드에 접근 가능 (명시적으로 표시 및 편집)

### 권장사항
1. ✅ 현재 구현이 올바르게 작동하고 있음
2. ⚠️ 향후 `getStudentById()` 함수에서 관리자 여부를 확인하여 `memo` 필드를 조건부로 포함하는 방식으로 개선 가능
3. ⚠️ RLS 정책에서 필드 레벨 제한은 불가능하므로, 애플리케이션 레벨에서 계속 제어해야 함

---

## 📝 관련 파일

### 관리자 페이지
- `app/(admin)/admin/students/[id]/page.tsx` - 학생 상세 페이지
- `app/(admin)/admin/students/[id]/_components/StudentInfoEditForm.tsx` - 학생 정보 편집 폼
- `app/(admin)/admin/students/[id]/_components/sections/BasicInfoSection.tsx` - 기본 정보 섹션
- `app/(admin)/admin/students/[id]/_components/sections/ProfileInfoSection.tsx` - 프로필 정보 섹션
- `app/(admin)/admin/students/[id]/_components/sections/CareerInfoSection.tsx` - 진로 정보 섹션

### 데이터 조회 함수
- `lib/data/students.ts` - 학생 기본 정보 조회
- `lib/data/studentProfiles.ts` - 학생 프로필 정보 조회
- `lib/data/studentCareerGoals.ts` - 학생 진로 목표 정보 조회

### 타입 정의
- `app/(admin)/admin/students/[id]/_types/studentFormTypes.ts` - 학생 정보 폼 타입

---

**점검 완료일**: 2025-01-15

