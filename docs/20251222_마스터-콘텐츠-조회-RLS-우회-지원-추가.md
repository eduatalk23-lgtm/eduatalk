# λ§μ¤ν„° μ½ν…μΈ  μ΅°ν RLS μ°ν μ§€μ› μ¶”κ°€

## π“‹ μ‘μ—… κ°μ”

λ§μ¤ν„° μ½ν…μΈ  ν…μ΄λΈ”(`master_books`, `master_lectures`) μ΅°ν ν•¨μμ— RLS μ°ν μ§€μ›μ„ μ¶”κ°€ν•μ—¬, κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν•™μƒμ μ½ν…μΈ λ¥Ό μ΅°νν•  λ• λ°μƒν•  μ μλ” RLS μ •μ±… μ„λ° λ¬Έμ λ¥Ό ν•΄κ²°ν–μµλ‹λ‹¤.

## π› λ¬Έμ  μƒν™©

### λ°κ²¬λ λ¬Έμ 

1. **`getMasterBookById` ν•¨μ**: ν•­μƒ μΌλ° μ„λ²„ ν΄λΌμ΄μ–ΈνΈ(`createSupabaseServerClient`) μ‚¬μ©
2. **`getMasterLectureById` ν•¨μ**: ν•­μƒ μΌλ° μ„λ²„ ν΄λΌμ΄μ–ΈνΈ(`createSupabaseServerClient`) μ‚¬μ©
3. **RLS μ •μ±… μ„λ°**: κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν…λ„νΈμ λ§μ¤ν„° μ½ν…μΈ λ¥Ό μ΅°νν•  λ• RLS μ •μ±…μ— λ§‰ν

### μν–¥λ°›λ” μ‹λ‚λ¦¬μ¤

- κ΄€λ¦¬μκ°€ λ‹¤λ¥Έ ν•™μƒμ ν”λμ„ μ΅°νν•  λ• λ§μ¤ν„° μ½ν…μΈ  μ •λ³΄κ°€ λ„λ½
- μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν•™μƒμ μ½ν…μΈ  μƒμ„Έ μ •λ³΄λ¥Ό μ΅°νν•  λ• μ‹¤ν¨
- μΊ ν”„ λ¨λ“μ—μ„ κ΄€λ¦¬μκ°€ ν•™μƒμ μ½ν…μΈ λ¥Ό μ΅°νν•  λ• λ§μ¤ν„° μ½ν…μΈ  μ •λ³΄ μ΅°ν μ‹¤ν¨

## β… ν•΄κ²° λ°©λ²•

### 1. getMasterBookById ν•¨μ μμ •

**λ³€κ²½ μ „**:
```typescript
export async function getMasterBookById(bookId: string): Promise<{...}> {
  const supabase = await createSupabaseServerClient();
  // ...
}
```

**λ³€κ²½ ν›„**:
```typescript
/**
 * κµμ¬ μƒμ„Έ μ΅°ν (μ„Έλ¶€ μ •λ³΄ ν¬ν•¨)
 * 
 * @param bookId - μ΅°νν•  κµμ¬ ID
 * @param supabase - μ„ νƒμ  Supabase ν΄λΌμ΄μ–ΈνΈ (κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν…λ„νΈμ μ½ν…μΈ λ¥Ό μ΅°νν•  λ• Admin ν΄λΌμ΄μ–ΈνΈ μ „λ‹¬)
 */
export async function getMasterBookById(
  bookId: string,
  supabase?: Awaited<ReturnType<typeof createSupabaseServerClient>> | ReturnType<typeof createSupabaseAdminClient>
): Promise<{...}> {
  const queryClient = supabase || (await createSupabaseServerClient());
  // queryClient μ‚¬μ©
}
```

**κ°μ„  μ‚¬ν•­**:
- μ„ νƒμ  `supabase` νλΌλ―Έν„° μ¶”κ°€
- νΈμ¶ν•λ” μ½μ—μ„ μ μ ν• ν΄λΌμ΄μ–ΈνΈ(Admin λλ” μΌλ°) μ „λ‹¬ κ°€λ¥
- κΈ°λ³Έκ°’μ€ μΌλ° μ„λ²„ ν΄λΌμ΄μ–ΈνΈ (ν•μ„ νΈν™μ„± μ μ§€)

### 2. getMasterLectureById ν•¨μ μμ •

**λ³€κ²½ μ „**:
```typescript
export async function getMasterLectureById(lectureId: string): Promise<{...}> {
  const supabase = await createSupabaseServerClient();
  // ...
}
```

**λ³€κ²½ ν›„**:
```typescript
/**
 * κ°•μ μƒμ„Έ μ΅°ν
 * 
 * @param lectureId - μ΅°νν•  κ°•μ ID
 * @param supabase - μ„ νƒμ  Supabase ν΄λΌμ΄μ–ΈνΈ (κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν…λ„νΈμ μ½ν…μΈ λ¥Ό μ΅°νν•  λ• Admin ν΄λΌμ΄μ–ΈνΈ μ „λ‹¬)
 */
export async function getMasterLectureById(
  lectureId: string,
  supabase?: Awaited<ReturnType<typeof createSupabaseServerClient>> | ReturnType<typeof createSupabaseAdminClient>
): Promise<{...}> {
  const queryClient = supabase || (await createSupabaseServerClient());
  // queryClient μ‚¬μ©
}
```

### 3. API λΌμ°νΈμ—μ„ Admin ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©

**μμ • μ„μΉ**: `app/api/student-content-details/route.ts`

```typescript
// master_content_idκ°€ μμΌλ©΄ λ§μ¤ν„°μ—μ„λ„ μ΅°ν (fallback)
// κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν•™μƒμ μ½ν…μΈ λ¥Ό μ΅°νν•  λ•λ” Admin ν΄λΌμ΄μ–ΈνΈ μ‚¬μ© (RLS μ°ν)
if (!totalPages && studentBookData?.master_content_id) {
  const masterQueryClient = (role === "admin" || role === "consultant") 
    ? createSupabaseAdminClient() || supabase
    : supabase;
  const masterBookResult = await getMasterBookById(studentBookData.master_content_id, masterQueryClient);
  totalPages = masterBookResult.book?.total_pages || null;
}
```

**κ°μ„  μ‚¬ν•­**:
- κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈμΈ κ²½μ° Admin ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©
- ν•™μƒμΈ κ²½μ° μΌλ° μ„λ²„ ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©
- Admin ν΄λΌμ΄μ–ΈνΈ μƒμ„± μ‹¤ν¨ μ‹ μΌλ° ν΄λΌμ΄μ–ΈνΈλ΅ fallback

### 4. μΊ ν”„ ν…ν”λ¦Ώ μ§„ν–‰ μ•΅μ…μ—μ„ Admin ν΄λΌμ΄μ–ΈνΈ μ „λ‹¬

**μμ • μ„μΉ**: `app/(admin)/actions/camp-templates/progress.ts`

```typescript
// λ§μ¤ν„° μ½ν…μΈ  μ •λ³΄ μ΅°ν (Admin ν΄λΌμ΄μ–ΈνΈ μ‚¬μ© - RLS μ°ν)
if (book.master_content_id) {
  try {
    const { book: masterBook } = await getMasterBookById(book.master_content_id, adminSupabase);
    // ...
  }
}
```

**κ°μ„  μ‚¬ν•­**:
- μ΄λ―Έ μƒμ„±λ `adminSupabase`λ¥Ό ν•¨μμ— μ „λ‹¬
- RLS μ°νλ¥Ό ν†µν• μ•μ •μ μΈ λ§μ¤ν„° μ½ν…μΈ  μ΅°ν

## π“ μμ •λ νμΌ

- `lib/data/contentMasters.ts` - `getMasterBookById`, `getMasterLectureById` ν•¨μμ— μ„ νƒμ  `supabase` νλΌλ―Έν„° μ¶”κ°€
- `app/api/student-content-details/route.ts` - κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈ μ ‘κ·Ό μ‹ Admin ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©
- `app/(admin)/actions/camp-templates/progress.ts` - Admin ν΄λΌμ΄μ–ΈνΈλ¥Ό ν•¨μμ— μ „λ‹¬

## π― κΈ°λ€ ν¨κ³Ό

1. **RLS μ •μ±… μ„λ° ν•΄κ²°**: κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν…λ„νΈμ λ§μ¤ν„° μ½ν…μΈ λ¥Ό μ΅°νν•  μ μμ
2. **ν•μ„ νΈν™μ„± μ μ§€**: κΈ°μ΅΄ μ½”λ“λ” μμ • μ—†μ΄ λ™μ‘ (κΈ°λ³Έκ°’μΌλ΅ μΌλ° ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©)
3. **μ μ—°ν• μ‚¬μ©**: νΈμ¶ν•λ” μ½μ—μ„ ν•„μ”μ— λ”°λΌ μ μ ν• ν΄λΌμ΄μ–ΈνΈ μ„ νƒ κ°€λ¥

## π” μ‚¬μ© ν¨ν„΄

### μΌλ° μ‚¬μ© (ν•™μƒμ΄ μμ‹ μ μ½ν…μΈ  μ΅°ν)

```typescript
// supabase νλΌλ―Έν„° μ—†μ΄ νΈμ¶ β†’ μλ™μΌλ΅ μΌλ° μ„λ²„ ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©
const { book } = await getMasterBookById(bookId);
```

### κ΄€λ¦¬μ/μ»¨μ„¤ν„΄νΈκ°€ λ‹¤λ¥Έ ν•™μƒμ μ½ν…μΈ  μ΅°ν

```typescript
// Admin ν΄λΌμ΄μ–ΈνΈλ¥Ό λ…μ‹μ μΌλ΅ μ „λ‹¬
const adminClient = createSupabaseAdminClient();
const { book } = await getMasterBookById(bookId, adminClient);
```

### μ΅°κ±΄λ¶€ Admin ν΄λΌμ΄μ–ΈνΈ μ‚¬μ©

```typescript
const { role } = await getCurrentUserRole();
const queryClient = (role === "admin" || role === "consultant") 
  ? createSupabaseAdminClient() || await createSupabaseServerClient()
  : await createSupabaseServerClient();
  
const { book } = await getMasterBookById(bookId, queryClient);
```

## π“ μ°Έκ³  μ‚¬ν•­

- **ν•μ„ νΈν™μ„±**: κΈ°μ΅΄ μ½”λ“λ” μμ • μ—†μ΄ λ™μ‘ (κΈ°λ³Έκ°’ μ‚¬μ©)
- **νƒ€μ… μ•μ „μ„±**: μ„ νƒμ  νλΌλ―Έν„°λ΅ νƒ€μ… μ•μ „μ„± μ μ§€
- **μ„±λ¥**: Admin ν΄λΌμ΄μ–ΈνΈλ” Service Role Keyλ¥Ό μ‚¬μ©ν•λ―€λ΅ RLS μ •μ±…μ„ μ°νν•μ—¬ λΉ λ¥Έ μ΅°ν κ°€λ¥
- **λ³΄μ•**: Admin ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„ μ‚¬μ΄λ“μ—μ„λ§ μ‚¬μ©λμ–΄μ•Ό ν•¨

## π”— κ΄€λ ¨ λ¬Έμ„

- [RLS μ°ν ν¨ν„΄ κ°€μ΄λ“](./rls-bypass-patterns.md)
- [ν”λ λ―Έλ¦¬λ³΄κΈ° λ§μ¤ν„° μ½ν…μΈ  μ΅°ν RLS μ •μ±… μ„λ° λ¬Έμ  ν•΄κ²°](./plan-preview-master-content-rls-fix.md)

---

**μ‘μ—… μΌμ‹**: 2025-12-22  
**μ‘μ—…μ**: AI Assistant


