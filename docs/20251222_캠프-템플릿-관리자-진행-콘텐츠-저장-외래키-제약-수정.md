# 캠프 템플릿 관리자 진행 시 콘텐츠 저장 외래 키 제약 조건 수정

**작업 일시**: 2024년 12월 22일  
**작업자**: AI Assistant

## 📋 문제 상황

관리자가 캠프 템플릿 참여자의 남은 단계를 진행할 때(`continueCampStepsForAdmin`) 콘텐츠 저장 중 외래 키 제약 조건 위반 에러가 발생했습니다.

### 에러 메시지

```
Error [AppError]: 플랜 저장에 실패했습니다. Referenced lecture (048f5e20-be95-4868-adcb-5a486685845a) does not exist
```

### 원인 분석

1. **마스터 강의 복사 실패 시 마스터 강의 ID 사용**
   - `continueCampStepsForAdmin` 함수에서 마스터 강의를 학생 강의로 복사 실패 시
   - `isValidContent = true`로 설정하고 `actualContentId = content.content_id` (마스터 강의 ID) 사용
   - `plan_contents.content_id`는 `lectures` 테이블을 참조하는 외래 키
   - 마스터 강의 ID는 `master_lectures` 테이블에 있으므로 외래 키 제약 조건 위반 발생

2. **중복된 콘텐츠 검증 로직**
   - `continueCampStepsForAdmin`에서 직접 콘텐츠 검증 로직 구현
   - `contentService.ts`의 `savePlanContents` 함수와 중복
   - 일관성 없는 처리로 인한 버그 발생 가능

3. **`validateAndResolveContent` 함수의 동일한 문제**
   - 마스터 콘텐츠 복사 실패 시에도 마스터 콘텐츠 ID를 그대로 사용
   - 교재(book)와 강의(lecture) 모두 동일한 문제 존재

## 🛠 해결 방법

### 수정 내용

#### 1. `continueCampStepsForAdmin` - `savePlanContents` 함수 사용

**파일**: `app/(admin)/actions/camp-templates/progress.ts`

**변경 전**:
```typescript
// 직접 콘텐츠 검증 로직 구현 (200+ 줄)
for (const content of contentsToSave) {
  let isValidContent = false;
  let actualContentId = content.content_id;
  
  if (content.content_type === "lecture") {
    // ... 복잡한 검증 로직 ...
    try {
      const { lectureId } = await copyMasterLectureToStudent(...);
      isValidContent = true;
      actualContentId = lectureId;
    } catch (copyError) {
      // ❌ 복사 실패 시에도 마스터 강의 ID 사용
      isValidContent = true;
      actualContentId = content.content_id;
    }
  }
  // ... 기타 콘텐츠 타입 처리 ...
}

if (validContents.length > 0) {
  const contentsResult = await createPlanContents(...);
}
```

**변경 후**:
```typescript
// savePlanContents 함수 사용 (이미 잘 구현되어 있음)
if (contentsToSave.length > 0) {
  const studentId = result.group.student_id;
  await savePlanContents(
    supabase,
    groupId,
    tenantId,
    studentId,
    contentsToSave
  );
}
```

#### 2. `validateAndResolveContent` - 복사 실패 시 콘텐츠 제외

**파일**: `lib/domains/camp/services/contentService.ts`

**변경 전** (강의):
```typescript
} catch (copyError) {
  logError(copyError, {
    function: "validateAndResolveContent",
    message: `마스터 강의 복사 실패: ${content.content_id}`,
  });
  // ❌ 복사 실패 시에도 마스터 콘텐츠 ID를 사용
  isValidContent = true;
  actualContentId = content.content_id;
}
```

**변경 후** (강의):
```typescript
} catch (copyError) {
  logError(copyError, {
    function: "validateAndResolveContent",
    message: `마스터 강의 복사 실패: ${content.content_id}`,
  });
  // ✅ 복사 실패 시 해당 콘텐츠를 제외 (외래 키 제약 조건 위반 방지)
  isValidContent = false;
  console.warn(
    `[contentService] 마스터 강의(${content.content_id}) 복사 실패로 콘텐츠에서 제외합니다.`
  );
}
```

**변경 후** (교재):
```typescript
} catch (copyError) {
  logError(copyError, {
    function: "validateAndResolveContent",
    contentId: content.content_id,
    contentType: "book",
  });
  // ✅ 복사 실패 시 해당 콘텐츠를 제외 (외래 키 제약 조건 위반 방지)
  isValidContent = false;
  console.warn(
    `[contentService] 마스터 교재(${content.content_id}) 복사 실패로 콘텐츠에서 제외합니다.`
  );
}
```

## ✅ 수정 결과

### 수정 전

- ❌ 외래 키 제약 조건 위반 에러 발생
- ❌ 마스터 강의 복사 실패 시에도 마스터 강의 ID 사용
- ❌ 중복된 콘텐츠 검증 로직
- ❌ 일관성 없는 처리

### 수정 후

- ✅ 외래 키 제약 조건 위반 해결
- ✅ 마스터 콘텐츠 복사 실패 시 해당 콘텐츠 제외
- ✅ `savePlanContents` 함수 사용으로 중복 코드 제거
- ✅ 일관된 콘텐츠 검증 로직

## 🔍 데이터 흐름

### 수정 전

```
continueCampStepsForAdmin
  ↓
직접 콘텐츠 검증 로직 (200+ 줄)
  ↓
마스터 강의 복사 시도
  ↓
복사 실패 ❌
  ↓
마스터 강의 ID를 그대로 사용 ❌
  ↓
plan_contents 저장 시도
  ↓
외래 키 제약 조건 위반 ❌
```

### 수정 후

```
continueCampStepsForAdmin
  ↓
savePlanContents 함수 호출
  ↓
validateAndResolveContent로 각 콘텐츠 검증
  ↓
마스터 강의 복사 시도
  ↓
복사 실패 ✅
  ↓
isValid = false로 설정하여 콘텐츠 제외 ✅
  ↓
유효한 콘텐츠만 저장 ✅
  ↓
외래 키 제약 조건 위반 없음 ✅
```

## 📝 주요 변경 사항

1. **중복 코드 제거**
   - `continueCampStepsForAdmin`에서 직접 구현한 콘텐츠 검증 로직 제거
   - `savePlanContents` 함수 사용으로 통일

2. **외래 키 제약 조건 위반 방지**
   - 마스터 콘텐츠 복사 실패 시 `isValid = false`로 설정
   - 해당 콘텐츠를 저장 목록에서 제외

3. **일관된 에러 처리**
   - 교재와 강의 모두 동일한 방식으로 처리
   - 복사 실패 시 경고 로그 출력

## 🔗 관련 문서

- [캠프 템플릿 관리자 진행 시 블록 세트 외래 키 제약 조건 수정](./20251222_캠프-템플릿-관리자-진행-블록-세트-외래키-제약-수정.md)
- [캠프 템플릿 제출 시 블록 세트값 전달 검토](./20251222_캠프-템플릿-블록-세트-전달-검토.md)

