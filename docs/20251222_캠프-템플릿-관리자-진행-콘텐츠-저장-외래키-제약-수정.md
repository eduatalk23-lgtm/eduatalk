# ìº í”„ í…œí”Œë¦¿ ê´€ë¦¬ì ì§„í–‰ ì‹œ ì½˜í…ì¸  ì €ì¥ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìˆ˜ì •

**ì‘ì—… ì¼ì‹œ**: 2024ë…„ 12ì›” 22ì¼  
**ì‘ì—…ì**: AI Assistant

## ğŸ“‹ ë¬¸ì œ ìƒí™©

ê´€ë¦¬ìê°€ ìº í”„ í…œí”Œë¦¿ ì°¸ì—¬ìì˜ ë‚¨ì€ ë‹¨ê³„ë¥¼ ì§„í–‰í•  ë•Œ(`continueCampStepsForAdmin`) ì½˜í…ì¸  ì €ì¥ ì¤‘ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

### ì—ëŸ¬ ë©”ì‹œì§€

```
Error [AppError]: í”Œëœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Referenced lecture (048f5e20-be95-4868-adcb-5a486685845a) does not exist
```

### ì›ì¸ ë¶„ì„

1. **ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ë§ˆìŠ¤í„° ê°•ì˜ ID ì‚¬ìš©**
   - `continueCampStepsForAdmin` í•¨ìˆ˜ì—ì„œ ë§ˆìŠ¤í„° ê°•ì˜ë¥¼ í•™ìƒ ê°•ì˜ë¡œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ
   - `isValidContent = true`ë¡œ ì„¤ì •í•˜ê³  `actualContentId = content.content_id` (ë§ˆìŠ¤í„° ê°•ì˜ ID) ì‚¬ìš©
   - `plan_contents.content_id`ëŠ” `lectures` í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ëŠ” ì™¸ë˜ í‚¤
   - ë§ˆìŠ¤í„° ê°•ì˜ IDëŠ” `master_lectures` í…Œì´ë¸”ì— ìˆìœ¼ë¯€ë¡œ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°œìƒ

2. **ì¤‘ë³µëœ ì½˜í…ì¸  ê²€ì¦ ë¡œì§**
   - `continueCampStepsForAdmin`ì—ì„œ ì§ì ‘ ì½˜í…ì¸  ê²€ì¦ ë¡œì§ êµ¬í˜„
   - `contentService.ts`ì˜ `savePlanContents` í•¨ìˆ˜ì™€ ì¤‘ë³µ
   - ì¼ê´€ì„± ì—†ëŠ” ì²˜ë¦¬ë¡œ ì¸í•œ ë²„ê·¸ ë°œìƒ ê°€ëŠ¥

3. **`validateAndResolveContent` í•¨ìˆ˜ì˜ ë™ì¼í•œ ë¬¸ì œ**
   - ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œì—ë„ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
   - êµì¬(book)ì™€ ê°•ì˜(lecture) ëª¨ë‘ ë™ì¼í•œ ë¬¸ì œ ì¡´ì¬

## ğŸ›  í•´ê²° ë°©ë²•

### ìˆ˜ì • ë‚´ìš©

#### 1. `continueCampStepsForAdmin` - `savePlanContents` í•¨ìˆ˜ ì‚¬ìš© (Step 4-6)

**íŒŒì¼**: `app/(admin)/actions/camp-templates/progress.ts` (line 725-735)

**ë³€ê²½ ì „**:
```typescript
// ì§ì ‘ ì½˜í…ì¸  ê²€ì¦ ë¡œì§ êµ¬í˜„ (200+ ì¤„)
for (const content of contentsToSave) {
  let isValidContent = false;
  let actualContentId = content.content_id;
  
  if (content.content_type === "lecture") {
    // ... ë³µì¡í•œ ê²€ì¦ ë¡œì§ ...
    try {
      const { lectureId } = await copyMasterLectureToStudent(...);
      isValidContent = true;
      actualContentId = lectureId;
    } catch (copyError) {
      // âŒ ë³µì‚¬ ì‹¤íŒ¨ ì‹œì—ë„ ë§ˆìŠ¤í„° ê°•ì˜ ID ì‚¬ìš©
      isValidContent = true;
      actualContentId = content.content_id;
    }
  }
  // ... ê¸°íƒ€ ì½˜í…ì¸  íƒ€ì… ì²˜ë¦¬ ...
}

if (validContents.length > 0) {
  const contentsResult = await createPlanContents(...);
}
```

**ë³€ê²½ í›„**:
```typescript
// savePlanContents í•¨ìˆ˜ ì‚¬ìš© (ì´ë¯¸ ì˜ êµ¬í˜„ë˜ì–´ ìˆìŒ)
if (contentsToSave.length > 0) {
  const studentId = result.group.student_id;
  await savePlanContents(
    supabase,
    groupId,
    tenantId,
    studentId,
    contentsToSave
  );
}
```

#### 2. `continueCampStepsForAdmin` - `savePlanContents` í•¨ìˆ˜ ì‚¬ìš© (Step 7)

**íŒŒì¼**: `app/(admin)/actions/camp-templates/progress.ts` (line 968-1020)

Step 7ì—ì„œ í”Œëœ ìƒì„± ì „ ì½˜í…ì¸  ì €ì¥ ë¡œì§ë„ ë™ì¼í•˜ê²Œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

**ë³€ê²½ ì „**:
```typescript
// ì§ì ‘ ì½˜í…ì¸  ê²€ì¦ ë¡œì§ êµ¬í˜„ (200+ ì¤„)
for (const content of creationDataForContents.contents) {
  // ... ë³µì¡í•œ ê²€ì¦ ë¡œì§ ...
  try {
    const { lectureId } = await copyMasterLectureToStudent(...);
    isValidContent = true;
    actualContentId = lectureId;
  } catch (copyError) {
    // âŒ ë³µì‚¬ ì‹¤íŒ¨ ì‹œì—ë„ ë§ˆìŠ¤í„° ê°•ì˜ ID ì‚¬ìš©
    isValidContent = true;
    actualContentId = content.content_id;
  }
}

const contentsResult = await createPlanContents(...);
```

**ë³€ê²½ í›„**:
```typescript
// PlanContentInsert í˜•ì‹ìœ¼ë¡œ ë³€í™˜
const contentsToSave: PlanContentInsert[] = creationDataForContents.contents.map((content, idx) => {
  // ... ì¶”ì²œ ì •ë³´ í¬í•¨ ...
  return {
    tenant_id: tenantId,
    plan_group_id: groupId,
    content_type: content.content_type,
    content_id: content.content_id,
    // ... ê¸°íƒ€ í•„ë“œ ...
  };
});

// savePlanContents í•¨ìˆ˜ ì‚¬ìš©
await savePlanContents(
  supabase,
  groupId,
  tenantId,
  studentId,
  contentsToSave
);
```

#### 3. `validateAndResolveContent` - ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì½˜í…ì¸  ì œì™¸

**íŒŒì¼**: `lib/domains/camp/services/contentService.ts`

**ë³€ê²½ ì „** (ê°•ì˜):
```typescript
} catch (copyError) {
  logError(copyError, {
    function: "validateAndResolveContent",
    message: `ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹¤íŒ¨: ${content.content_id}`,
  });
  // âŒ ë³µì‚¬ ì‹¤íŒ¨ ì‹œì—ë„ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ ì‚¬ìš©
  isValidContent = true;
  actualContentId = content.content_id;
}
```

**ë³€ê²½ í›„** (ê°•ì˜):
```typescript
} catch (copyError) {
  logError(copyError, {
    function: "validateAndResolveContent",
    message: `ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹¤íŒ¨: ${content.content_id}`,
  });
  // âœ… ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ì½˜í…ì¸ ë¥¼ ì œì™¸ (ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°©ì§€)
  isValidContent = false;
  console.warn(
    `[contentService] ë§ˆìŠ¤í„° ê°•ì˜(${content.content_id}) ë³µì‚¬ ì‹¤íŒ¨ë¡œ ì½˜í…ì¸ ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.`
  );
}
```

**ë³€ê²½ í›„** (êµì¬):
```typescript
} catch (copyError) {
  logError(copyError, {
    function: "validateAndResolveContent",
    contentId: content.content_id,
    contentType: "book",
  });
  // âœ… ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ì½˜í…ì¸ ë¥¼ ì œì™¸ (ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°©ì§€)
  isValidContent = false;
  console.warn(
    `[contentService] ë§ˆìŠ¤í„° êµì¬(${content.content_id}) ë³µì‚¬ ì‹¤íŒ¨ë¡œ ì½˜í…ì¸ ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.`
  );
}
```

## âœ… ìˆ˜ì • ê²°ê³¼

### ìˆ˜ì • ì „

- âŒ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì—ëŸ¬ ë°œìƒ
- âŒ ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹¤íŒ¨ ì‹œì—ë„ ë§ˆìŠ¤í„° ê°•ì˜ ID ì‚¬ìš©
- âŒ ì¤‘ë³µëœ ì½˜í…ì¸  ê²€ì¦ ë¡œì§
- âŒ ì¼ê´€ì„± ì—†ëŠ” ì²˜ë¦¬

### ìˆ˜ì • í›„

- âœ… ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ í•´ê²°
- âœ… ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ì½˜í…ì¸  ì œì™¸
- âœ… `savePlanContents` í•¨ìˆ˜ ì‚¬ìš©ìœ¼ë¡œ ì¤‘ë³µ ì½”ë“œ ì œê±°
- âœ… ì¼ê´€ëœ ì½˜í…ì¸  ê²€ì¦ ë¡œì§

## ğŸ” ë°ì´í„° íë¦„

### ìˆ˜ì • ì „

```
continueCampStepsForAdmin
  â†“
ì§ì ‘ ì½˜í…ì¸  ê²€ì¦ ë¡œì§ (200+ ì¤„)
  â†“
ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹œë„
  â†“
ë³µì‚¬ ì‹¤íŒ¨ âŒ
  â†“
ë§ˆìŠ¤í„° ê°•ì˜ IDë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© âŒ
  â†“
plan_contents ì €ì¥ ì‹œë„
  â†“
ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ âŒ
```

### ìˆ˜ì • í›„

```
continueCampStepsForAdmin
  â†“
savePlanContents í•¨ìˆ˜ í˜¸ì¶œ
  â†“
validateAndResolveContentë¡œ ê° ì½˜í…ì¸  ê²€ì¦
  â†“
ë§ˆìŠ¤í„° ê°•ì˜ ë³µì‚¬ ì‹œë„
  â†“
ë³µì‚¬ ì‹¤íŒ¨ âœ…
  â†“
isValid = falseë¡œ ì„¤ì •í•˜ì—¬ ì½˜í…ì¸  ì œì™¸ âœ…
  â†“
ìœ íš¨í•œ ì½˜í…ì¸ ë§Œ ì €ì¥ âœ…
  â†“
ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì—†ìŒ âœ…
```

## ğŸ“ ì£¼ìš” ë³€ê²½ ì‚¬í•­

1. **ì¤‘ë³µ ì½”ë“œ ì œê±°**
   - `continueCampStepsForAdmin`ì—ì„œ ì§ì ‘ êµ¬í˜„í•œ ì½˜í…ì¸  ê²€ì¦ ë¡œì§ ì œê±°
   - `savePlanContents` í•¨ìˆ˜ ì‚¬ìš©ìœ¼ë¡œ í†µì¼

2. **ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°©ì§€**
   - ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ `isValid = false`ë¡œ ì„¤ì •
   - í•´ë‹¹ ì½˜í…ì¸ ë¥¼ ì €ì¥ ëª©ë¡ì—ì„œ ì œì™¸

3. **ì¼ê´€ëœ ì—ëŸ¬ ì²˜ë¦¬**
   - êµì¬ì™€ ê°•ì˜ ëª¨ë‘ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
   - ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ê²½ê³  ë¡œê·¸ ì¶œë ¥

#### 4. `generatePlansRefactored` - ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ `contentIdMap`ì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ

**íŒŒì¼**: `app/(student)/actions/plan-groups/generatePlansRefactored.ts` (line 317-342)

**ë³€ê²½ ì „**:
```typescript
// ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ (ë³µì‚¬ëŠ” ìˆœì°¨ ì²˜ë¦¬ í•„ìš” - DB íŠ¸ëœì­ì…˜)
for (const contentId of missingBookIds) {
  if (masterBookIds.has(contentId)) {
    const copiedBook = await copyMasterBookToStudent(...);
    // âŒ ë³µì‚¬ ì‹¤íŒ¨ ì‹œì—ë„ ì›ë³¸ ID ì‚¬ìš©
    contentIdMap.set(contentId, copiedBook?.bookId || contentId);
  } else {
    // âŒ ë§ˆìŠ¤í„° ì½˜í…ì¸ ê°€ ì•„ë‹Œ ê²½ìš°ì—ë„ ì›ë³¸ ID ì‚¬ìš©
    contentIdMap.set(contentId, contentId);
  }
}
```

**ë³€ê²½ í›„**:
```typescript
// ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ (ë³µì‚¬ëŠ” ìˆœì°¨ ì²˜ë¦¬ í•„ìš” - DB íŠ¸ëœì­ì…˜)
// ë³µì‚¬ ì‹¤íŒ¨ ì‹œ contentIdMapì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ (ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°©ì§€)
for (const contentId of missingBookIds) {
  if (masterBookIds.has(contentId)) {
    try {
      const copiedBook = await copyMasterBookToStudent(...);
      // âœ… ë³µì‚¬ ì„±ê³µ ì‹œì—ë§Œ contentIdMapì— ë§¤í•‘
      if (copiedBook?.bookId) {
        contentIdMap.set(contentId, copiedBook.bookId);
      } else {
        // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ contentIdMapì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ
      }
    } catch (error) {
      // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ contentIdMapì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ
    }
  } else {
    // ë§ˆìŠ¤í„° ì½˜í…ì¸ ê°€ ì•„ë‹Œ ê²½ìš° ì›ë³¸ IDë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    // plan_contentsì— ì´ë¯¸ ì €ì¥ëœ ì½˜í…ì¸  IDì´ë¯€ë¡œ contentIdMapì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ
  }
}
```

#### 5. í”Œëœ ìƒì„± ì‹œ `contentIdMap`ì— ì—†ëŠ” ì½˜í…ì¸  ì œì™¸

**íŒŒì¼**: 
- `app/(student)/actions/plan-groups/generatePlansRefactored.ts` (line 628-646)
- `app/(student)/actions/plan-groups/previewPlansRefactored.ts` (line 303-317)

í”Œëœ ìƒì„± ì‹œ `contentIdMap`ì— ì—†ëŠ” ì½˜í…ì¸ ë¥¼ ì œì™¸í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

**ë³€ê²½ ì „**:
```typescript
const plansForAssign = datePlans.map((plan, originalIndex) => {
  const finalContentId =
    contentIdMap.get(plan.content_id) || plan.content_id; // âŒ contentIdMapì— ì—†ìœ¼ë©´ ì›ë³¸ ID ì‚¬ìš©
  return {
    content_id: finalContentId,
    // ...
  };
});
```

**ë³€ê²½ í›„**:
```typescript
// contentIdMapì— ì—†ëŠ” ì½˜í…ì¸ ëŠ” ì œì™¸ (ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ë°©ì§€)
const plansForAssign = datePlans
  .map((plan, originalIndex) => {
    const finalContentId = contentIdMap.get(plan.content_id);
    // âœ… contentIdMapì— ì—†ëŠ” ê²½ìš° null ë°˜í™˜í•˜ì—¬ í•„í„°ë§
    if (!finalContentId) {
      console.warn(
        `[generatePlansRefactored] ì½˜í…ì¸  ID(${plan.content_id})ê°€ contentIdMapì— ì—†ì–´ í”Œëœì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.`
      );
      return null;
    }
    return {
      content_id: finalContentId,
      // ...
    };
  })
  .filter((plan): plan is NonNullable<typeof plan> => plan !== null);
```

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [ìº í”„ í…œí”Œë¦¿ ê´€ë¦¬ì ì§„í–‰ ì‹œ ë¸”ë¡ ì„¸íŠ¸ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìˆ˜ì •](./20251222_ìº í”„-í…œí”Œë¦¿-ê´€ë¦¬ì-ì§„í–‰-ë¸”ë¡-ì„¸íŠ¸-ì™¸ë˜í‚¤-ì œì•½-ìˆ˜ì •.md)
- [ìº í”„ í…œí”Œë¦¿ ì œì¶œ ì‹œ ë¸”ë¡ ì„¸íŠ¸ê°’ ì „ë‹¬ ê²€í† ](./20251222_ìº í”„-í…œí”Œë¦¿-ë¸”ë¡-ì„¸íŠ¸-ì „ë‹¬-ê²€í† .md)

