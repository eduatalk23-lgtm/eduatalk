# 2단계 콘텐츠 선택 시스템 설계 문서

**작성일**: 2025-12-23
**버전**: v2.0
**목적**: 콘텐츠 선택 과정 개선을 위한 2단계 슬롯 기반 시스템 설계

---

## Executive Summary

### 핵심 철학

현재 v2.0 설계는 **"계획의 의도(Intent)"를 먼저 수립**하게 하는 것이 핵심입니다.

| 구분            | Before                                | After                                             |
| --------------- | ------------------------------------- | ------------------------------------------------- |
| **접근 방식**   | 무엇을 공부할까? (콘텐츠 중심 → 계획) | 어떤 구성으로 공부할까? (구조 중심 → 콘텐츠 매칭) |
| **사용자 경험** | 선택의 고민이 먼저                    | 목표에 집중, 선택은 나중                          |
| **효과**        | 결정 피로도 높음                      | 결정 피로도 감소                                  |

### 주요 변경 사항

1. **UI 구조**: One-Screen, Two-Panels (좌: 슬롯 빌더 / 우: 스마트 컨텍스트)
2. **데이터**: `ContentSlot` 도입 (학습뿐만 아니라 **자습(Self-study)**, 테스트 등 시간 점유 타입 추가)
3. **기술 전략**:
   - **상태 관리**: Zustand + Immer (복잡한 객체 제어)
   - **호환성**: Dual Write (신규 슬롯 데이터와 구형 콘텐츠 데이터를 동시 저장)

---

## 목차

1. [현재 시스템 분석](#1-현재-시스템-분석)
2. [제안된 아이디어](#2-제안된-아이디어)
3. [모드별 사용자 흐름](#3-모드별-사용자-흐름)
4. [데이터 구조 설계](#4-데이터-구조-설계)
5. [UI 플로우 상세 설계](#5-ui-플로우-상세-설계)
6. [기술적 구현 계획](#6-기술적-구현-계획)
7. [고려사항 및 제약조건](#7-고려사항-및-제약조건)
8. [추가 브레인스토밍 아이디어](#8-추가-브레인스토밍-아이디어)
9. [Action Plan](#9-action-plan)
10. [구현 현황](#10-구현-현황)

---

## 1. 현재 시스템 분석

### 1.1 현재 콘텐츠 선택 프로세스

#### 현재 구조

```
Step 3: 콘텐츠 선택
├── 학생 콘텐츠 탭
│   ├── 교재 목록에서 선택
│   ├── 강의 목록에서 선택
│   ├── 커스텀 콘텐츠 선택
│   └── 범위 설정 (페이지/에피소드)
│
├── 추천 콘텐츠 탭 (일반 모드만)
│   ├── 추천 요청
│   ├── 추천 콘텐츠 목록
│   └── 선택/추가
│
└── 마스터 콘텐츠 탭
    └── 마스터 콘텐츠에서 선택
```

#### 현재 제약사항

- **최대 9개 콘텐츠 선택 가능**
- 콘텐츠 선택 후에야 교과-과목 정보 확인 가능
- 타임라인 배치는 실제 플랜 생성 후에만 확인 가능
- 교과-과목별 분배 계획이 없음

#### 현재 데이터 구조

```typescript
// WizardData.student_contents
type SelectedContent = {
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  start_range: number;
  end_range: number;
  start_detail_id?: string | null;
  end_detail_id?: string | null;
  title?: string;
  subject_category?: string; // 선택 후 메타데이터에서 가져옴
  subject_id?: string | null;
  master_content_id?: string | null;
};
```

### 1.2 현재 위저드 단계 구조

#### 전체 단계

1. **Step 1**: 기본 정보 (이름, 목적, 기간, 블록세트)
2. **Step 2**: 시간 설정 (블록, 제외일, 학원일정)
3. **Step 3**: 스케줄 미리보기 (시간 슬롯만)
4. **Step 3 (콘텐츠 선택)**: 콘텐츠 선택
5. **Step 6**: 최종 확인
6. **Step 7**: 스케줄 결과 (플랜 생성)

#### 모드별 단계 차이

- **템플릿 모드**: Step 1-3만 (필수 교과 설정 포함)
- **캠프 모드 (학생)**: Step 1-4만 (제출 후 대기)
- **캠프 모드 (관리자)**: Step 4-7 (이어하기)
- **일반 모드**: Step 1-7 전체

---

## 2. 제안된 아이디어

### 2.1 핵심 아이디어

#### 문제점

1. 콘텐츠를 선택한 후에야 교과-과목 정보를 확인
2. 타임라인 배치는 실제 플랜 생성 후에만 확인 가능
3. 교과-과목별 분배 계획이 없음
4. 콘텐츠 선택 시 필터링이 어려움

#### 해결 방안: 2단계 콘텐츠 선택 시스템

```
1단계: 슬롯 구성 (교재/강의 타입 + 교과-과목)
  ↓
  타임라인 기반 가상 배치 미리보기
  ↓
2단계: 각 슬롯에 실제 콘텐츠 연결
```

### 2.2 주요 장점

#### 사용자 경험 개선

1. **계획 단계 명확화**
   - 먼저 교과-과목별 분배 계획 수립
   - 타임라인 기반 가상 배치 미리보기
2. **선택 단계 단순화**
   - 슬롯별로 필터링된 콘텐츠만 표시
   - 교과-과목 불일치 방지
3. **타임라인 연동**
   - 슬롯 구성 시점에 가상 배치 미리보기
   - 교과별 시간 분배 확인

#### 기술적 장점

1. **데이터 구조 개선**
   - 슬롯 템플릿 재사용 가능
   - 템플릿 모드에서 기본값 제공
2. **검증 강화**
   - 슬롯 단계에서 교과-과목 검증
   - 콘텐츠 연결 단계에서 범위 검증

---

## 3. 모드별 사용자 흐름

### 3.1 템플릿 모드 (관리자)

#### 현재 흐름

```
Step 1: 기본 정보
  ↓
Step 2: 시간 설정
  ↓
Step 3: 필수 교과 설정
  ↓
템플릿 저장 완료
```

#### 제안된 흐름

```
Step 1: 기본 정보
  ↓
Step 2: 시간 설정
  ↓
Step 3: 필수 교과 설정 (기존 유지)
  ↓
[새로 추가] Step 3.5: 슬롯 템플릿 구성 (선택사항)
  ├── 교재/강의 타입 + 교과-과목 조합으로 슬롯 구성
  ├── 최대 9개 슬롯
  └── 템플릿에 저장
  ↓
템플릿 저장 완료
```

#### 특징

- **선택사항**: 기존 필수 교과 설정만으로도 가능
- **템플릿 저장**: 슬롯 템플릿이 템플릿에 저장됨
- **기본값 제공**: 캠프 참여 시 기본 슬롯 제공

### 3.2 캠프 모드 - 학생 제출

#### 현재 흐름

```
Step 1: 기본 정보 (템플릿 기반)
  ↓
Step 2: 시간 설정 (템플릿 기반)
  ↓
Step 3: 스케줄 미리보기
  ↓
Step 3 (콘텐츠 선택): 학생 콘텐츠 선택
  ↓
Step 4: 제출 (플랜 생성 안 함)
```

#### 제안된 흐름

```
Step 1: 기본 정보 (템플릿 기반)
  ↓
Step 2: 시간 설정 (템플릿 기반)
  ↓
Step 3: 스케줄 미리보기
  ↓
Step 3.1: 슬롯 구성
  ├── 템플릿 슬롯이 있으면 기본값 제공
  ├── 슬롯 추가/수정 가능
  ├── 교재/강의 타입 + 교과-과목 선택
  └── 타임라인 기반 가상 배치 미리보기
  ↓
Step 3.2: 콘텐츠 연결
  ├── 각 슬롯에 실제 교재/강의 선택
  ├── 슬롯별로 필터링된 콘텐츠만 표시
  └── 범위 설정
  ↓
Step 4: 제출 (플랜 생성 안 함)
```

#### 특징

- **템플릿 연동**: 템플릿 슬롯이 있으면 기본값 제공, 수정 가능
- **가상 미리보기**: 슬롯 구성 후 가상 타임라인 미리보기
- **필터링**: 슬롯별로 필터링된 콘텐츠만 표시

### 3.3 캠프 모드 - 관리자 이어하기

#### 현재 흐름

```
Step 4: 콘텐츠 확인/추가
  ├── 학생이 선택한 콘텐츠 확인
  └── 추천 콘텐츠 선택/추가
  ↓
Step 6: 최종 확인
  ↓
Step 7: 플랜 생성 완료
```

#### 제안된 흐름

```
Step 4: 콘텐츠 확인/추가
  ├── 학생이 구성한 슬롯 확인
  ├── 슬롯 추가/수정 가능
  ├── 각 슬롯에 추천 콘텐츠 연결
  └── 슬롯별로 필터링된 추천 콘텐츠 표시
  ↓
Step 6: 최종 확인
  ↓
Step 7: 플랜 생성 완료
```

#### 특징

- **슬롯 확인**: 학생이 구성한 슬롯 확인/수정 가능
- **슬롯 추가**: 관리자가 슬롯 추가 가능
- **추천 연결**: 추천 콘텐츠를 슬롯에 연결

### 3.4 일반 모드 (학생)

#### 현재 흐름

```
Step 1: 기본 정보
  ↓
Step 2: 시간 설정
  ↓
Step 3: 스케줄 미리보기
  ↓
Step 3 (콘텐츠 선택): 학생 콘텐츠 + 추천 콘텐츠
  ↓
Step 6: 최종 확인
  ↓
Step 7: 플랜 생성 완료
```

#### 제안된 흐름

```
Step 1: 기본 정보
  ↓
Step 2: 시간 설정
  ↓
Step 3: 스케줄 미리보기
  ↓
Step 3.1: 슬롯 구성 (선택사항)
  ├── [슬롯 방식 사용] / [기존 방식 사용]
  ├── 교재/강의 타입 + 교과-과목 선택
  ├── 타임라인 기반 가상 배치 미리보기
  └── [건너뛰기] 버튼으로 기존 방식 사용 가능
  ↓
Step 3.2: 콘텐츠 연결
  ├── 슬롯 방식: 각 슬롯에 콘텐츠 선택
  └── 기존 방식: 직접 콘텐츠 선택 (슬롯 건너뛴 경우)
  ↓
Step 6: 최종 확인
  ↓
Step 7: 플랜 생성 완료
```

#### 특징

- **선택권 제공**: 슬롯 방식 선택 가능
- **하위 호환성**: 기존 방식과 병행 지원
- **유연성**: 사용자 선택에 따른 분기 처리

---

## 4. 데이터 구조 설계

### 4.1 슬롯 템플릿 타입

```typescript
// 템플릿에 저장되는 슬롯 템플릿 (camp_templates 테이블)
type SlotTemplate = {
  slot_index: number; // 0-8 (최대 9개)
  content_type: "book" | "lecture" | null; // 아직 선택 안 함
  subject_category: string; // 교과 그룹명 (예: "국어", "수학")
  subject_id?: string | null; // 과목 ID (선택적, 예: "수학Ⅰ")
  curriculum_revision_id?: string | null; // 개정교육과정 ID
  is_required?: boolean; // 필수 슬롯 여부
};
```

### 4.2 콘텐츠 슬롯 타입

```typescript
// 플랜 그룹에 저장되는 실제 슬롯 (plan_groups.content_slots JSONB)
type ContentSlot = SlotTemplate & {
  // 콘텐츠 연결 필드
  content_id?: string | null; // 실제 콘텐츠 ID
  start_range?: number;
  end_range?: number;
  start_detail_id?: string | null;
  end_detail_id?: string | null;
  title?: string;
  master_content_id?: string | null;
  is_auto_recommended?: boolean; // 추천 콘텐츠 여부
  recommendation_source?: "auto" | "admin" | "template" | null;
};
```

### 4.3 WizardData 스키마 확장

```typescript
// lib/schemas/planWizardSchema.ts에 추가

export const contentSlotSchema = z
  .object({
    slot_index: z.number().int().min(0).max(8),
    content_type: z.enum(["book", "lecture"]).nullable(),
    subject_category: z.string().min(1),
    subject_id: z.string().uuid().nullable().optional(),
    curriculum_revision_id: z.string().uuid().nullable().optional(),
    is_required: z.boolean().optional(),
    // 콘텐츠 연결 필드
    content_id: z.string().nullable().optional(),
    start_range: z.number().int().min(0).optional(),
    end_range: z.number().int().min(0).optional(),
    start_detail_id: z.string().uuid().nullable().optional(),
    end_detail_id: z.string().uuid().nullable().optional(),
    title: z.string().optional(),
    master_content_id: z.string().uuid().nullable().optional(),
    is_auto_recommended: z.boolean().optional(),
    recommendation_source: z
      .enum(["auto", "admin", "template"])
      .nullable()
      .optional(),
  })
  .refine(
    (data) => {
      // content_id가 있으면 start_range, end_range 필수
      if (data.content_id) {
        return data.start_range !== undefined && data.end_range !== undefined;
      }
      return true;
    },
    {
      message: "콘텐츠를 연결한 경우 범위 설정이 필요합니다.",
      path: ["start_range"],
    }
  );

// WizardData에 추가
export const wizardDataSchema = z.object({
  // ... 기존 필드들
  content_slots: z.array(contentSlotSchema).max(9).optional(),
  use_slot_mode: z.boolean().optional(), // 슬롯 방식 사용 여부
  // 기존 필드 유지 (하위 호환성)
  student_contents: z.array(studentContentSchema).optional(),
  recommended_contents: z.array(recommendedContentSchema).optional(),
});
```

### 4.4 데이터베이스 스키마 확장

#### camp_templates 테이블

```sql
-- 슬롯 템플릿 저장 (JSONB)
ALTER TABLE camp_templates
ADD COLUMN slot_templates JSONB DEFAULT '[]'::jsonb;

-- 인덱스 추가
CREATE INDEX idx_camp_templates_slot_templates
ON camp_templates USING GIN (slot_templates);
```

#### plan_groups 테이블

```sql
-- 콘텐츠 슬롯 저장 (JSONB)
ALTER TABLE plan_groups
ADD COLUMN content_slots JSONB DEFAULT NULL;

-- 슬롯 방식 사용 여부
ALTER TABLE plan_groups
ADD COLUMN use_slot_mode BOOLEAN DEFAULT FALSE;

-- 인덱스 추가
CREATE INDEX idx_plan_groups_content_slots
ON plan_groups USING GIN (content_slots);
```

---

## 5. UI 플로우 상세 설계

### 5.1 Step 3.1: 슬롯 구성 단계

#### 템플릿 모드 UI

```
┌─────────────────────────────────────────────┐
│  슬롯 템플릿 구성 (선택사항)                │
├─────────────────────────────────────────────┤
│  이 템플릿을 사용하는 학생들에게             │
│  기본 슬롯 구성을 제공합니다.                │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ 슬롯 1                               │  │
│  │ [교재 ▼] [국어 ▼] [수학Ⅰ ▼]        │  │
│  │ [삭제]                               │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ 슬롯 2                               │  │
│  │ [강의 ▼] [수학 ▼] [수학Ⅱ ▼]        │  │
│  │ [삭제]                               │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  [+ 슬롯 추가] (최대 9개)                  │
│                                             │
│  [건너뛰기] [저장]                         │
└─────────────────────────────────────────────┘
```

#### 캠프 모드 - 학생 UI

```
┌─────────────────────────────────────────────┐
│  콘텐츠 슬롯 구성                            │
├─────────────────────────────────────────────┤
│  템플릿에서 제공된 기본 슬롯:                 │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ 슬롯 1 (템플릿에서 제공)            │  │
│  │ [교재 ▼] [국어 ▼] [수학Ⅰ ▼]        │  │
│  │ [수정] [삭제]                       │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ 슬롯 2 (템플릿에서 제공)            │  │
│  │ [강의 ▼] [수학 ▼] [수학Ⅱ ▼]        │  │
│  │ [수정] [삭제]                       │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  [+ 슬롯 추가] (최대 9개)                  │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ 타임라인 미리보기 (가상 배치)        │  │
│  │ ┌───────────────────────────────┐  │  │
│  │ │ 주차별 교과 시간 분배          │  │  │
│  │ │ 국어: ████████░░ 40%          │  │  │
│  │ │ 수학: ██████████ 50%          │  │  │
│  │ │ 영어: ██░░░░░░░░ 10%          │  │  │
│  │ └───────────────────────────────┘  │  │
│  │                                     │  │
│  │ [일별 보기] [주별 보기]            │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  [이전] [다음 단계]                         │
└─────────────────────────────────────────────┘
```

#### 일반 모드 UI

```
┌─────────────────────────────────────────────┐
│  콘텐츠 슬롯 구성 (선택사항)                │
├─────────────────────────────────────────────┤
│  슬롯 방식으로 콘텐츠를 구성하시겠습니까?    │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ [슬롯 방식 사용]                     │  │
│  │ 교과-과목별로 계획적으로 구성        │  │
│  │ 타임라인 미리보기 제공               │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │ [기존 방식 사용]                     │  │
│  │ 직접 콘텐츠 선택                     │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  ┌─ 슬롯 방식 선택 시 ──────────────────┐  │
│  │ 슬롯 1: [교재 ▼] [국어 ▼]           │  │
│  │ ...                                  │  │
│  │ [+ 슬롯 추가]                        │  │
│  │                                      │  │
│  │ 타임라인 미리보기                    │  │
│  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### 5.2 Step 3.2: 콘텐츠 연결 단계

#### 모든 모드 공통 UI

```
┌─────────────────────────────────────────────┐
│  슬롯별 콘텐츠 선택                          │
├─────────────────────────────────────────────┤
│  슬롯 1: 교재 - 국어 - 수학Ⅰ                │
│  ┌─────────────────────────────────────┐  │
│  │ [검색: "수학Ⅰ 교재"]                 │  │
│  │                                     │  │
│  │ ┌───────────────────────────────┐  │  │
│  │ │ ✓ 개념원리 수학Ⅰ              │  │  │
│  │ │   출판사: 개념원리              │  │  │
│  │ │   총 페이지: 500p              │  │  │
│  │ └───────────────────────────────┘  │  │
│  │                                     │  │
│  │ ┌───────────────────────────────┐  │  │
│  │ │   쎈 수학Ⅰ                    │  │  │
│  │ │   출판사: 좋은책신사고         │  │  │
│  │ │   총 페이지: 600p              │  │  │
│  │ └───────────────────────────────┘  │  │
│  │                                     │  │
│  │ ...                                 │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  [범위 설정] 1p ~ 100p                     │
│  [상세 범위 설정] (단원/챕터 선택)          │
│                                             │
│  ───────────────────────────────────────  │
│                                             │
│  슬롯 2: 강의 - 수학 - 수학Ⅱ                │
│  ┌─────────────────────────────────────┐  │
│  │ [검색: "수학Ⅱ 강의"]                 │  │
│  │ ...                                 │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  [이전] [다음 단계]                         │
└─────────────────────────────────────────────┘
```

### 5.3 가상 타임라인 미리보기

#### 기능

1. **교과별 시간 분배 시각화**
   - 슬롯 구성 기반 교과별 시간 계산
   - 주차별/일별 분배 표시
2. **가상 플랜 배치**
   - 실제 플랜 생성 전 미리보기
   - 타임라인에 가상 배치 표시

#### UI 예시

```
┌─────────────────────────────────────────────┐
│  타임라인 미리보기                           │
├─────────────────────────────────────────────┤
│  [일별 보기] [주별 보기] [월별 보기]        │
│                                             │
│  ┌─ 주차별 교과 시간 분배 ────────────────┐ │
│  │ 주차 1                                │ │
│  │ 국어: ████████░░ 40% (16시간)        │ │
│  │ 수학: ██████████ 50% (20시간)        │ │
│  │ 영어: ██░░░░░░░░ 10% (4시간)         │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  ┌─ 일별 가상 배치 ───────────────────────┐ │
│  │ 2025-01-01 (월)                      │ │
│  │ 09:00-10:30 [슬롯 1] 국어 교재      │ │
│  │ 10:30-12:00 [슬롯 2] 수학 강의      │ │
│  │ 13:00-14:30 [슬롯 3] 영어 교재      │ │
│  │ ...                                  │ │
│  └───────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

---

## 6. 기술적 구현 계획

### 6.1 Phase 1: 기본 구조 (우선순위: 높음)

#### 1.1 타입 정의 및 스키마 확장

- **파일**: `lib/types/content-selection.ts`
- **작업**:
  - `SlotTemplate` 타입 정의
  - `ContentSlot` 타입 정의
  - `WizardData` 스키마 확장

#### 1.2 슬롯 구성 UI 컴포넌트

- **파일**: `app/(student)/plan/new-group/_components/_features/content-selection/Step3_1SlotConfiguration.tsx`
- **하위 컴포넌트**:
  - `SlotConfigurationPanel.tsx`: 슬롯 편집 UI
  - `SlotItem.tsx`: 개별 슬롯 편집 컴포넌트
  - `SubjectSelector.tsx`: 교과-과목 선택 컴포넌트

#### 1.3 가상 타임라인 미리보기 로직

- **파일**: `lib/plan/virtualSchedulePreview.ts`
- **함수**:
  - `calculateVirtualTimeline()`: 가상 타임라인 계산
  - `calculateSubjectTimeDistribution()`: 교과별 시간 분배 계산

### 6.2 Phase 2: 모드별 적용 (우선순위: 중간)

#### 2.1 템플릿 모드

- **작업**:
  - 슬롯 템플릿 저장 로직
  - `camp_templates.slot_templates` JSONB 저장
  - 템플릿 편집 시 슬롯 템플릿 수정

#### 2.2 캠프 모드 - 학생

- **작업**:
  - 템플릿 슬롯 로드 로직
  - 기본 슬롯 제공 및 수정 가능
  - 슬롯 구성 후 콘텐츠 연결

#### 2.3 캠프 모드 - 관리자

- **작업**:
  - 학생 슬롯 확인/수정
  - 슬롯 추가 기능
  - 추천 콘텐츠를 슬롯에 연결

#### 2.4 일반 모드

- **작업**:
  - 슬롯 방식 선택 UI
  - 기존 방식과 병행 지원
  - 사용자 선택에 따른 분기 처리

### 6.3 Phase 3: 고급 기능 (우선순위: 낮음)

#### 3.1 슬롯별 콘텐츠 필터링

- **작업**:
  - 슬롯의 교과-과목 기반 콘텐츠 필터링
  - 검색 기능 개선
  - 필터링된 콘텐츠만 표시

#### 3.2 가상 타임라인 시각화

- **작업**:
  - 타임라인 컴포넌트 구현
  - 일별/주별/월별 뷰 전환
  - 가상 플랜 배치 시각화

#### 3.3 기존 방식과의 호환성

- **작업**:
  - 슬롯 → 기존 형식 변환 함수
  - 기존 형식 → 슬롯 변환 함수
  - 데이터 마이그레이션 스크립트

---

## 7. 고려사항 및 제약조건

### 7.1 하위 호환성

#### 기존 데이터 유지

- 기존 `student_contents`, `recommended_contents` 필드 유지
- 슬롯 방식 사용 시 `content_slots` 사용
- 기존 방식 사용 시 기존 필드 사용

#### 데이터 변환

```typescript
// 슬롯 → 기존 형식 변환
function convertSlotsToContents(slots: ContentSlot[]): SelectedContent[] {
  return slots
    .filter((slot) => slot.content_id)
    .map((slot) => ({
      content_type: slot.content_type!,
      content_id: slot.content_id!,
      start_range: slot.start_range!,
      end_range: slot.end_range!,
      // ... 기타 필드
    }));
}

// 기존 형식 → 슬롯 변환
function convertContentsToSlots(contents: SelectedContent[]): ContentSlot[] {
  return contents.map((content, index) => ({
    slot_index: index,
    content_type: content.content_type,
    subject_category: content.subject_category || "",
    // ... 기타 필드
  }));
}
```

### 7.2 검증 로직

#### 슬롯 구성 검증

```typescript
function validateSlotConfiguration(slots: ContentSlot[]): ValidationResult {
  const errors: string[] = [];

  // 최대 9개 제한
  if (slots.length > 9) {
    errors.push("슬롯은 최대 9개까지 가능합니다.");
  }

  // 교과-과목 필수
  slots.forEach((slot, index) => {
    if (!slot.subject_category) {
      errors.push(`슬롯 ${index + 1}: 교과를 선택해주세요.`);
    }
  });

  // 중복 슬롯 검증 (같은 교과-과목 조합)
  const slotKeys = slots.map(
    (s) => `${s.content_type}-${s.subject_category}-${s.subject_id || ""}`
  );
  const duplicates = slotKeys.filter(
    (key, index) => slotKeys.indexOf(key) !== index
  );
  if (duplicates.length > 0) {
    errors.push("동일한 교과-과목 조합의 슬롯이 중복됩니다.");
  }

  return { valid: errors.length === 0, errors };
}
```

#### 콘텐츠 연결 검증

```typescript
function validateContentLinking(slots: ContentSlot[]): ValidationResult {
  const errors: string[] = [];

  slots.forEach((slot, index) => {
    // 콘텐츠 연결 필수
    if (!slot.content_id) {
      errors.push(`슬롯 ${index + 1}: 콘텐츠를 선택해주세요.`);
    }

    // 범위 설정 필수
    if (slot.content_id && (!slot.start_range || !slot.end_range)) {
      errors.push(`슬롯 ${index + 1}: 학습 범위를 설정해주세요.`);
    }

    // 범위 유효성 검증
    if (
      slot.start_range &&
      slot.end_range &&
      slot.start_range >= slot.end_range
    ) {
      errors.push(
        `슬롯 ${index + 1}: 시작 범위는 종료 범위보다 작아야 합니다.`
      );
    }
  });

  return { valid: errors.length === 0, errors };
}
```

### 7.3 성능 고려사항

#### 가상 타임라인 계산 최적화

- 메모이제이션 적용
- 슬롯 변경 시에만 재계산
- 대량 데이터 처리 시 배치 처리

#### 콘텐츠 필터링 최적화

- 인덱스 활용 (교과-과목 기반)
- 클라이언트 사이드 캐싱
- 검색 결과 페이지네이션

### 7.4 사용자 경험 고려사항

#### 점진적 적용

- 슬롯 방식은 선택사항으로 제공
- 기존 방식과 병행 지원
- 사용자 피드백 수집 후 개선

#### 에러 처리

- 명확한 에러 메시지
- 슬롯별 에러 표시
- 수정 가이드 제공

---

## 8. 다음 단계

### 8.1 즉시 시작 가능한 작업

1. 타입 정의 및 스키마 확장
2. 슬롯 구성 UI 컴포넌트 프로토타입
3. 가상 타임라인 계산 로직

### 8.2 검토 필요 사항

1. UI/UX 디자인 상세화
2. 데이터베이스 마이그레이션 계획
3. 기존 데이터 마이그레이션 전략

### 8.3 추가 개선 아이디어

1. 슬롯 템플릿 공유 기능
2. AI 기반 슬롯 추천
3. 슬롯별 학습 목표 설정

---

## 8. 추가 브레인스토밍 아이디어

설계의 완성도를 높이고 사용자 경험(UX)을 극대화하기 위한 추가 아이디어입니다.

### 8.1 슬롯 간의 '관계(Relation)' 정의 (스마트 스케줄링)

단순히 슬롯을 나열하는 것을 넘어, 슬롯 간의 **논리적 연결**을 지원하면 스케줄링 정확도가 높아집니다.

#### 연계 슬롯 (Chained Slots)

- _"수학 강의"_ 슬롯 바로 뒤에 _"수학 복습(자습)"_ 슬롯을 자석처럼 붙이는 기능
- **효과**: 강의를 들은 직후 복습하는 학습 패턴을 강제하거나 유도할 수 있음

```typescript
type ContentSlot = {
  // ... 기존 필드
  linked_slot_id?: string | null; // 연계될 슬롯 ID
  link_type?: "after" | "before" | null; // 연계 방향
};
```

#### 배타적 슬롯 (Exclusive Slots)

- *"영어 단어 암기"*와 *"영어 독해"*는 같은 날 배치를 피하고 싶다면 '분산 배치' 옵션 제공

```typescript
type SlotConstraint = {
  slot_id: string;
  exclusive_with?: string[]; // 같은 날 배치 피할 슬롯 ID 목록
  preferred_time?: "morning" | "afternoon" | "evening" | null;
};
```

### 8.2 '가상 슬롯(Ghost Slot)'과 템플릿 고도화

관리자(템플릿) 모드에서 학생의 자율성을 보장하면서도 가이드를 줄 수 있는 방법입니다.

#### 잠금 슬롯 (Locked Slot)

- 관리자가 "수학 교재 1개"를 필수 슬롯으로 만들고 삭제 불가능하게 설정
- 내용은 학생이 선택

```typescript
type SlotTemplate = {
  // ... 기존 필드
  is_locked?: boolean; // true면 학생이 삭제 불가
  is_required?: boolean; // 필수 슬롯 여부 (기존)
};
```

#### 추천 슬롯 (Ghost Slot)

- 필수는 아니지만, 템플릿 로드 시 희미하게 보이는 슬롯
- 예: "이 시기엔 탐구 과목을 추천해요"
- 학생이 클릭하면 활성화, 무시하면 사라짐

```typescript
type SlotTemplate = {
  // ... 기존 필드
  is_ghost?: boolean; // true면 추천 슬롯 (투명하게 표시)
  ghost_message?: string; // 추천 이유 메시지
};
```

#### 동적 기본값

- 학생의 학년 정보를 읽어와서 기본 검색어 자동 세팅
- 예: 고3이면 '수능특강'이 슬롯의 기본 검색어로 설정

### 8.3 시각적 피드백 강화 (밸런스 게임)

슬롯을 채우는 과정 자체가 게임처럼 느껴지도록 시각적 피드백을 강화합니다.

#### 실시간 도넛 차트

- 좌측 패널 상단에 **[국어 / 수학 / 영어]** 시간 비중 그래프 표시
- 슬롯을 추가할 때마다 그래프가 실시간으로 변화
- 과목 불균형 경고: "수학 비중이 70%입니다. 국어를 추가해보세요."

```
┌─────────────────────────────────────┐
│  과목 밸런스        [자동 균형 추천] │
│  ┌─────────────────────────────┐   │
│  │     국어 (20%)              │   │
│  │  ████░░░░░░░░░░░░░░░░░░    │   │
│  │                             │   │
│  │     수학 (60%) ⚠️ 높음       │   │
│  │  ████████████████░░░░░░    │   │
│  │                             │   │
│  │     영어 (20%)              │   │
│  │  ████░░░░░░░░░░░░░░░░░░    │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

#### 슬롯 완성도 표시기

| 상태          | 시각적 표현                          |
| ------------- | ------------------------------------ |
| 빈 슬롯       | 회색 점선 테두리                     |
| 타입 선택됨   | 색상 테두리 (교재: 파랑, 강의: 초록) |
| 콘텐츠 매칭됨 | **꽉 찬 색상 카드 + 체크 아이콘 ✓**  |

- 모든 슬롯이 '꽉 찬 색상'이 되었을 때 "다음 단계" 버튼이 활성화
- 시각적 만족감 제공

### 8.4 '자습(Self-study)' 타입의 구체화

새로 추가된 '자습' 타입을 스케줄링 엔진이 정확하게 처리할 수 있도록 구체화합니다.

#### 자습의 목적 태깅

단순히 '자습'이 아니라 하위 태그를 선택하게 함:

- `homework`: 숙제
- `review`: 복습/오답노트
- `preview`: 예습
- `memorization`: 암기
- `practice`: 문제풀이

```typescript
type ContentSlot = {
  // ... 기존 필드
  slot_type: "book" | "lecture" | "custom" | "self_study" | "test";
  self_study_purpose?:
    | "homework"
    | "review"
    | "preview"
    | "memorization"
    | "practice"
    | null;
};
```

#### 고정/유동 속성 부여

- **고정**: "반드시 밤 10시 이후"(취침 전 암기)
- **유동**: "자투리 시간"에 배치해도 됨

```typescript
type SlotTimeConstraint = {
  type: "fixed" | "flexible";
  preferred_time_range?: {
    start_hour: number; // 0-23
    end_hour: number;
  } | null;
  can_split?: boolean; // 분할 배치 가능 여부
};
```

### 8.5 기술적 검토 사항 (Edge Case)

#### 모바일 대응

좌우 2패널(Split View) 방식은 모바일에서 공간이 부족합니다.

**제안**: 모바일에서는 **탭(Tab) 방식**이나 **바텀 시트(Bottom Sheet)** 방식으로 전환

```
데스크톱: Split View (좌: 슬롯 리스트 / 우: 콘텐츠 선택)
         ┌──────────────┬──────────────┐
         │  슬롯 빌더    │  콘텐츠 매칭  │
         └──────────────┴──────────────┘

모바일:   Stack View (탭 또는 바텀 시트)
         ┌──────────────────────────────┐
         │  [슬롯 빌더] [콘텐츠 매칭]    │ ← 탭 전환
         ├──────────────────────────────┤
         │  현재 선택된 뷰 콘텐츠        │
         └──────────────────────────────┘

         또는

         ┌──────────────────────────────┐
         │  슬롯 빌더                    │
         │  - 슬롯 터치 →               │
         └──────────────────────────────┘
                    ↓
         ┌──────────────────────────────┐
         │  ▔▔▔▔▔▔                      │ ← 바텀 시트
         │  콘텐츠 선택                  │
         │  검색...                      │
         │  콘텐츠 목록                  │
         └──────────────────────────────┘
```

#### Dual Write 동기화 이슈

슬롯 모드에서 편집 후 → 레거시 모드로 전환 → 다시 슬롯 모드로 돌아올 때 데이터 손실 가능성

**제안**:

1. `use_slot_mode`가 true인 경우, 레거시 UI 진입을 막음
2. 또는 경고 표시: "고급 모드에서 작성된 데이터가 초기화될 수 있습니다"

```typescript
// 모드 전환 시 검증
function validateModeSwitch(
  currentMode: "slot" | "legacy",
  targetMode: "slot" | "legacy",
  hasSlotData: boolean
): { allowed: boolean; warning?: string } {
  if (currentMode === "slot" && targetMode === "legacy" && hasSlotData) {
    return {
      allowed: true,
      warning:
        "슬롯 모드에서 작성한 데이터가 레거시 형식으로 변환됩니다. 일부 정보가 손실될 수 있습니다.",
    };
  }
  return { allowed: true };
}
```

---

## 9. Action Plan

### 9.1 Phase 1: 기본 구현 (MVP)

제안된 v2.0 설계대로 **슬롯 빌더(좌) + 콘텐츠 매칭(우)** 구조 구현

| 우선순위 | 작업                        | 파일/위치                            |
| -------- | --------------------------- | ------------------------------------ |
| P0       | 타입 정의 및 스키마 확장    | `lib/types/content-selection.ts`     |
| P0       | 슬롯 구성 UI 컴포넌트       | `Step3_1SlotConfiguration.tsx`       |
| P0       | 콘텐츠 연결 UI 컴포넌트     | `Step3_2ContentLinking.tsx`          |
| P1       | 가상 타임라인 미리보기 로직 | `lib/plan/virtualSchedulePreview.ts` |
| P1       | Dual Write 어댑터           | `lib/plan/slotContentAdapter.ts`     |

### 9.2 Phase 2: UI 강화

모바일 뷰 설계를 위한 반응형 전략 수립

| 작업               | 설명                                      |
| ------------------ | ----------------------------------------- |
| 반응형 레이아웃    | Split View → Stack View 전환 (768px 기준) |
| 바텀 시트 컴포넌트 | 모바일 콘텐츠 선택 UI                     |
| 터치 최적화        | 슬롯 드래그앤드롭, 스와이프 제스처        |

### 9.3 Phase 3: 데이터 고도화

`ContentSlot` 타입에 추가 필드 검토

```typescript
// 확장된 ContentSlot 스키마
type ContentSlotExtended = ContentSlot & {
  // 관계 정의
  linked_slot_id?: string | null;
  link_type?: "after" | "before" | null;

  // 시간 제약
  time_constraint?: SlotTimeConstraint | null;

  // 자습 상세
  self_study_purpose?: SelfStudyPurpose | null;

  // 템플릿 고도화
  is_locked?: boolean;
  is_ghost?: boolean;
  ghost_message?: string;
};
```

### 9.4 Phase 4: 시각적 피드백

슬롯 구성 시 과목 밸런스를 보여주는 **미니 차트 컴포넌트** 추가

| 컴포넌트                | 기능                |
| ----------------------- | ------------------- |
| `SubjectBalanceChart`   | 실시간 도넛/바 차트 |
| `SlotProgressIndicator` | 슬롯 완성도 시각화  |
| `BalanceWarning`        | 불균형 경고 토스트  |

### 9.5 우선순위 매트릭스

```
Impact ↑
       │
  High │  Phase 1 (MVP)      Phase 3 (데이터)
       │       ●                   ○
       │
  Med  │  Phase 2 (UI)       Phase 4 (피드백)
       │       ○                   ○
       │
  Low  │
       └────────────────────────────────→ Effort
              Low    Medium    High
```

---

## 10. 구현 현황

### 10.1 완료된 기능 (v2.1)

#### 관리자 슬롯 템플릿 에디터

**파일**: `app/(admin)/admin/camp-templates/[id]/edit/SlotTemplateEditor.tsx`

- 슬롯 추가/수정/삭제 UI
- 드래그앤드롭 슬롯 재정렬
- 슬롯 복제/이동 기능
- 프리셋 관리 페이지 링크

#### 관리자 프리셋 관리 시스템

**파일**:
- `app/(admin)/admin/camp-templates/presets/page.tsx` - 프리셋 관리 페이지
- `app/(admin)/admin/camp-templates/presets/_components/PresetList.tsx` - 프리셋 목록
- `app/(admin)/admin/camp-templates/presets/_components/PresetEditor.tsx` - 프리셋 편집 모달

**서버 액션** (`lib/domains/camp/actions/slotPresets.ts`):
- `getSlotTemplatePresets` - 프리셋 목록 조회
- `createSlotTemplatePreset` - 프리셋 생성
- `updateSlotTemplatePreset` - 프리셋 수정
- `deleteSlotTemplatePreset` - 프리셋 삭제
- `setDefaultPreset` - 기본 프리셋 설정

#### 학생 슬롯 구성 개선

**파일**: `app/(student)/plan/new-group/_components/_features/content-selection/slot-mode/SlotConfigurationPanel.tsx`

**구현 기능**:
- 드래그앤드롭 슬롯 재정렬 (HTML5 native API)
- 슬롯 복제/이동 액션 메뉴
- 프리셋 불러오기 드롭다운
- 잠금 슬롯(is_locked) 제약 조건 적용
- 고스트 슬롯(is_ghost) 활성화/무시

**파일**: `app/(student)/plan/new-group/_components/_features/content-selection/slot-mode/SlotItem.tsx`

**구현 기능**:
- 드래그앤드롭 props 수신
- 액션 메뉴 (MoreVertical 드롭다운)
- 위로/아래로 이동, 복제, 삭제 옵션

#### 학생용 프리셋 불러오기

**서버 액션**: `getSlotTemplatePresetsForStudent`
- 로그인한 학생의 테넌트에 속한 프리셋 조회
- 관리자가 만든 공개 프리셋 사용 가능

**UI**: SlotConfigurationPanel 하단 "프리셋 불러오기" 버튼
- 프리셋 목록 드롭다운
- 기본 프리셋 별표(★) 표시
- 선택 시 슬롯 자동 적용

### 10.2 테스트 커버리지

**파일**:
- `lib/domains/camp/actions/slotPresets.test.ts` - 서버 액션 테스트
- `__tests__/content-selection/slotConfiguration.test.ts` - 유틸리티 테스트

**테스트 항목** (39개 테스트):
- 슬롯 생성/검증
- 슬롯 인덱스 계산
- 슬롯 구성 검증 (에러/경고)
- 콘텐츠 연결 검증
- 슬롯-콘텐츠 변환

### 10.3 데이터베이스

**테이블**: `slot_template_presets`

```sql
CREATE TABLE slot_template_presets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  slot_templates JSONB NOT NULL DEFAULT '[]',
  is_default BOOLEAN DEFAULT FALSE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(tenant_id, name)
);
```

### 10.4 가상 타임라인 미리보기 (구현 완료)

**파일**: `lib/plan/virtualSchedulePreview.ts`

**구현된 함수**:
- `calculateVirtualTimeline(slots, dailySchedules, options)` - 가상 타임라인 계산
- `calculateSubjectTimeDistribution(slots, plans)` - 교과별 시간 분배
- `calculateWeekSummaries(plans, dailySchedules)` - 주차별 요약
- `groupPlansByDate(result)` - 일별 뷰 변환
- `groupPlansByWeek(result)` - 주차별 뷰 변환
- `groupPlansBySubject(result)` - 교과별 뷰 변환

**주요 타입**:
```typescript
type VirtualTimelineResult = {
  plans: VirtualPlanItem[];
  subjectDistribution: SubjectTimeDistribution[];
  weekSummaries: WeekSummary[];
  totalStudyMinutes: number;
  totalContents: number;
  warnings: string[];
};
```

**기능**:
- 슬롯 타입별 기본 소요 시간 적용 (book: 90분, lecture: 60분 등)
- 콘텐츠 연결 시 범위 기반 시간 계산 (페이지/에피소드)
- 점심시간(12:00-13:00) 자동 건너뛰기
- 가용 시간 초과 시 경고 메시지

### 10.5 가상 타임라인 UI 컴포넌트 (구현 완료)

**파일**: `app/(student)/plan/new-group/_components/_features/content-selection/slot-mode/VirtualTimelinePreview.tsx`

**뷰 모드**:
- 일별 뷰 (Daily) - 날짜별 플랜 목록
- 주별 뷰 (Weekly) - 주차별 요약 (학습일, 복습일, 교과 수)
- 리스트 뷰 (List) - 전체 플랜 목록

**UI 요소**:
- 요약 카드 (총 학습시간, 콘텐츠 수, 학습 일수, 총 주차)
- 교과별 분배 바 차트
- 경고 메시지 표시
- 접기/펼치기 토글

**통합**: `Step3SlotModeSelection`에 통합 완료
- `dailySchedules` prop으로 일별 스케줄 전달
- `showTimelinePreview` prop으로 표시 여부 제어

### 10.6 슬롯 간 관계 정의 (구현 완료)

**파일**:
- `lib/plan/virtualSchedulePreview.ts` - 스케줄링 로직
- `lib/types/content-selection.ts` - 검증 함수

#### 연계 슬롯 (Linked Slots)

슬롯 간 순서를 강제하는 기능입니다.

**타입**:
```typescript
type ContentSlot = {
  // ... 기존 필드
  linked_slot_id?: string | null;  // 연계될 슬롯 ID
  link_type?: "after" | "before" | null;  // 연계 방향
};
```

**동작**:
- `link_type: "after"` - 연결된 슬롯 다음에 배치 (예: 강의 → 복습)
- `link_type: "before"` - 연결된 슬롯 이전에 배치

**스케줄링 로직** (`virtualSchedulePreview.ts`):
- `groupLinkedSlots()` - 연계된 슬롯들을 그룹으로 묶음
- `orderLinkedGroup()` - 위상 정렬로 그룹 내 순서 결정
- 연계 그룹은 같은 날 연속 배치 시도

#### 배타적 슬롯 (Exclusive Slots)

같은 날 배치를 피하는 기능입니다.

**타입**:
```typescript
type ContentSlot = {
  // ... 기존 필드
  exclusive_with?: string[];  // 같은 날 배치 피할 슬롯 ID 목록
};
```

**동작**:
- 해당 날짜에 exclusive_with 슬롯이 있으면 다음 날로 이동
- 경고 메시지: "배타적 슬롯 관계로 인해 다른 날로 조정되었습니다"

**스케줄링 로직** (`virtualSchedulePreview.ts`):
- `checkExclusiveConstraints()` - 배타적 제약 조건 체크
- 양방향 체크 (A→B, B→A 모두)

#### 관계 검증 함수

**함수**: `validateSlotRelationships(slots)` (`content-selection.ts`)

**검증 항목**:
1. 자기 자신 참조 (A → A)
2. 존재하지 않는 슬롯 참조
3. 순환 참조 (A → B → A)
4. 배타적 슬롯 자기 참조

**순환 참조 탐지**:
- DFS 기반 순환 탐지 알고리즘
- 순환 경로 표시: "슬롯 1 → 슬롯 2 → 슬롯 1"

**통합**: `validateSlotConfiguration()`에 관계 검증 자동 포함

### 10.7 모바일 반응형 UI (구현 완료)

**대상 컴포넌트**:
- `SlotItem.tsx`
- `SlotConfigurationPanel.tsx`
- `VirtualTimelinePreview.tsx`

**구현 내용**:

| 항목 | 모바일 | 데스크톱 |
|------|--------|----------|
| 액션 메뉴 버튼 | 항상 표시 | 호버 시 표시 |
| 드래그 핸들 | 숨김 (이동 버튼 사용) | 표시 |
| 터치 타겟 | 44px 이상 (py-3, py-4) | 기본 (py-2) |
| 뷰 모드 토글 | 풀 너비 버튼 | 컴팩트 버튼 |
| 드롭다운 메뉴 | 큰 패딩 + active 상태 | 기본 + hover 상태 |

**반응형 브레이크포인트**:
- `md:` (768px) 기준으로 모바일/데스크톱 구분
- 모바일 우선 접근 (Mobile-first)

**터치 피드백**:
- `active:bg-*` 클래스로 터치 시 시각적 피드백
- 호버 효과는 `md:hover:*`로 데스크톱에서만 적용

### 10.8 남은 작업

| 우선순위 | 작업 | 상태 |
|---------|------|------|
| P0 | 슬롯 구성 UI (드래그앤드롭) | ✅ 완료 |
| P0 | 프리셋 관리 (CRUD) | ✅ 완료 |
| P0 | 학생용 프리셋 불러오기 | ✅ 완료 |
| P1 | 가상 타임라인 미리보기 로직 | ✅ 완료 |
| P1 | 가상 타임라인 UI 컴포넌트 | ✅ 완료 |
| P1 | 슬롯 간 관계 정의 | ✅ 완료 |
| P1 | 모바일 반응형 UI | ✅ 완료 |
| P2 | AI 기반 슬롯 추천 | 🔲 대기 |

---

**이 문서는 지속적으로 업데이트되며, 구현 과정에서 발견된 사항을 반영합니다.**

---

## 변경 이력

| 버전 | 날짜       | 변경 내용                                                            |
| ---- | ---------- | -------------------------------------------------------------------- |
| v1.0 | 2025-12-23 | 초기 설계 문서 작성                                                  |
| v2.0 | 2025-12-23 | Executive Summary 추가, 브레인스토밍 아이디어 통합, Action Plan 추가 |
| v2.1 | 2025-12-23 | 구현 현황 섹션 추가 (드래그앤드롭, 프리셋 관리, 학생용 프리셋 불러오기) |
| v2.2 | 2025-12-23 | 가상 타임라인 미리보기 구현 완료 반영 |
| v2.3 | 2025-12-23 | VirtualTimelinePreview UI 컴포넌트 통합 |
| v2.4 | 2025-12-23 | 슬롯 간 관계 정의 구현 (연계/배타 슬롯, 순환 참조 검증) |
| v2.5 | 2025-12-23 | 모바일 반응형 UI 구현 (터치 타겟, 액션 메뉴, 뷰 모드 토글) |
