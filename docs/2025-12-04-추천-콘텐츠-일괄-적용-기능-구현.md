# 추천 콘텐츠 일괄 적용 기능 구현

## 작업 일자
2025-12-04

## 작업 내용

### 1. 관리자 일괄 추천 플래그 강제 설정

**파일**: `app/(admin)/actions/campTemplateActions.ts`

관리자가 콘텐츠를 추가할 때 `recommendation_source`와 `is_auto_recommended`를 강제로 설정하여 학생 개별 추천과 구분:

- **1960-1971번 라인**: `recommendedContentsForCreation` 생성 시
  - `is_auto_recommended: false` (관리자 추가는 항상 false)
  - `recommendation_source: "admin"` (관리자 추가는 항상 "admin"으로 강제)

- **2590-2591번 라인**: Step 6 콘텐츠 저장 시
  - 동일하게 강제 설정 적용

**변경 전**:
```typescript
is_auto_recommended: (c as any).is_auto_recommended ?? false,
recommendation_source: (c as any).recommendation_source || null,
```

**변경 후**:
```typescript
is_auto_recommended: false, // 관리자 추가는 항상 false
recommendation_source: "admin", // 관리자 추가는 항상 "admin"으로 강제 설정
```

### 2. 서버 액션: 다수 학생에게 추천 콘텐츠 일괄 적용

**파일**: `app/(admin)/actions/campTemplateActions.ts`

새 함수 추가: `bulkApplyRecommendedContents`

**기능**:
- 각 플랜 그룹에 대해 `getRecommendedMasterContents` 호출 (학생별 교과/수량 적용)
- 추천된 콘텐츠를 `plan_contents`에 추가
- `is_auto_recommended: false`, `recommendation_source: "admin"` 설정
- 학생당 최대 9개 제한 검증
- 기존 추천 콘텐츠는 유지하거나 교체할지 옵션 제공

**파라미터**:
- `templateId`: 캠프 템플릿 ID
- `groupIds`: 플랜 그룹 ID 배열
- `subjectCountsMap`: groupId -> (subject -> count) 맵
- `options.replaceExisting`: 기존 추천 콘텐츠 교체 여부 (기본값: false)

### 3. 모달 컴포넌트: 추천 콘텐츠 일괄 적용 설정

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/_components/BulkRecommendContentsModal.tsx`

**컴포넌트 구조**:
- 테이블 형태: 학생 행 × 교과 열
- 각 행에 체크박스 (개별 선택용)
- 각 셀에 수량 입력 필드 (0-9)
- 학생당 총합 표시 및 최대 9개 제한 검증
- **전체 조율 컨트롤**:
  - "전체 일괄 적용": 모든 학생에게 동일한 교과/수량 설정
  - "전체 증가/감소": 모든 학생의 특정 교과 수량 일괄 조정
- **개별 조율 컨트롤**:
  - 각 행의 "조율" 버튼: 선택된 학생(들)에 대한 조율 옵션
  - "선택한 학생에게 일괄 적용": 선택한 학생들에게만 동일한 교과/수량 설정 적용
  - "선택한 학생 증가/감소": 선택한 학생들의 특정 교과 수량 일괄 조정
  - "선택한 학생 초기화": 선택한 학생들의 모든 수량을 0으로 초기화
- 적용 옵션:
  - 기존 추천 콘텐츠 유지/교체 선택

**주요 기능**:
- 실시간 검증: 각 셀 입력 시 학생당 총합 확인
- 제출 전 검증: 모든 학생의 총합이 9개 이하인지 확인
- 오류 표시: 초과 시 해당 행/셀 하이라이트 및 오류 메시지

### 4. UI 통합: CampParticipantsList에 버튼 추가

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx`

**변경 사항**:
- 선택된 참여자가 있을 때 "추천 콘텐츠 일괄 적용" 버튼 추가
- 버튼 클릭 시 `BulkRecommendContentsModal` 열기
- 모달에서 설정 완료 후 `bulkApplyRecommendedContents` 호출
- 성공 시 참여자 목록 새로고침

## 사용 가능한 교과

- 국어
- 수학
- 영어
- 과학
- 사회

## 최대 수량 제한

- 학생당 최대 9개까지 추천 콘텐츠 설정 가능
- 초과 시 오류 메시지 표시 및 제출 불가

## 테스트 시나리오

1. 관리자가 여러 학생 선택 → "추천 콘텐츠 일괄 적용" 버튼 클릭
2. 모달에서 학생별 교과/수량 설정
3. 전체 조율 기능으로 일괄 적용/조정
4. 개별 조율 기능으로 선택한 학생들만 조정
5. 최대 수량 초과 시 검증 오류 표시
6. 적용 완료 후 각 학생의 플랜 그룹에 추천 콘텐츠 추가 확인
7. 플래그 확인: `is_auto_recommended: false`, `recommendation_source: "admin"`

## 예상 효과

- ✅ 학생 개별 추천과 관리자 일괄 추천이 플래그로 명확히 구분됨
- ✅ 관리자가 효율적으로 다수 학생에게 추천 콘텐츠를 일괄 적용 가능
- ✅ 학생별 맞춤 설정과 전체 일괄 설정 모두 지원
- ✅ 개별 조율 기능으로 선택한 학생들만 세밀하게 조정 가능
- ✅ 최대 수량 제한으로 데이터 무결성 보장

## 추가 작업 (2025-12-04 후속)

### 1. 버튼 표시 조건 개선

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx`

- 추천 콘텐츠 일괄 적용 버튼이 한 명이어도 표시되도록 개선
- 플랜 그룹이 없는 학생도 선택 가능하도록 체크박스 로직 수정
- 선택 키를 `plan_group_id` 또는 `invitation_id`로 통합

### 2. 플랜 그룹 일괄 생성 기능 추가

**파일**: 
- `app/(admin)/actions/campTemplateActions.ts`
- `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx`

**기능**:
- 플랜 그룹이 없는 학생들을 선택하여 일괄 생성
- 템플릿 데이터를 기반으로 플랜 그룹 생성
- 제외일 및 학원 일정 자동 생성
- "플랜 그룹 일괄 생성" 버튼 추가

**서버 액션**: `bulkCreatePlanGroupsForCamp`
- 다수 학생의 초대 ID를 받아 플랜 그룹 일괄 생성
- 템플릿 데이터를 기반으로 각 학생의 플랜 그룹 생성
- 이미 플랜 그룹이 있는 경우 스킵

## 수정된 파일 목록

1. `app/(admin)/actions/campTemplateActions.ts`
   - 관리자 일괄 추천 플래그 강제 설정
   - `bulkApplyRecommendedContents` 서버 액션 추가
   - `bulkCreatePlanGroupsForCamp` 서버 액션 추가

2. `app/(admin)/admin/camp-templates/[id]/participants/_components/BulkRecommendContentsModal.tsx` (신규)
   - 추천 콘텐츠 일괄 적용 모달 컴포넌트

3. `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx`
   - "추천 콘텐츠 일괄 적용" 버튼 추가 (한 명이어도 표시)
   - "플랜 그룹 일괄 생성" 버튼 추가
   - 플랜 그룹이 없는 학생도 선택 가능하도록 개선
   - 모달 연동

