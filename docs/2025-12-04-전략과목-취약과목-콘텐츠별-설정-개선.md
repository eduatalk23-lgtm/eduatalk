# 전략과목/취약과목 콘텐츠별 설정 개선

## 작업 일자
2025-12-04

## 작업 내용

### 목표
- 교과별 분류는 유지하되, 각 콘텐츠마다 개별적으로 전략/취약 설정 가능
- Step6Simplified의 SubjectAllocationEditor를 Step6FinalReview의 ContentAllocationUI처럼 개선

### 1. Step6Simplified의 SubjectAllocationEditor 개선

**파일**: `app/(student)/plan/new-group/_components/Step6Simplified.tsx`

**변경 사항**:
- 기존: 교과별로만 설정 가능 (subject_allocations 사용)
- 개선: 교과별로 그룹화하되, 각 교과 아래에 해당 교과의 콘텐츠 목록 표시
- 각 콘텐츠마다 전략/취약 설정 가능 (content_allocations 사용)
- 폴백 메커니즘: 콘텐츠별 설정이 없으면 교과별 설정 표시

**UI 구조**:
```
[교과명] (N개 콘텐츠)
  └─ 콘텐츠 1
      └─ [취약과목] [전략과목] [주당 배정 일수]
      └─ "교과별 설정 적용 중" 또는 "기본값 (취약과목)" 표시
  └─ 콘텐츠 2
      └─ [취약과목] [전략과목] [주당 배정 일수]
```

**주요 기능**:
- `getEffectiveAllocation` 함수로 폴백 메커니즘 구현
  - 1순위: 콘텐츠별 설정 (content_allocations)
  - 2순위: 교과별 설정 (subject_allocations)
  - 3순위: 기본값 (취약과목)
- 콘텐츠별 설정이 없을 때 교과별 설정 또는 기본값 표시
- 설정 요약 섹션 추가 (콘텐츠별 설정 개수, 교과별 설정 개수)

### 2. planGroupDataSync.ts 수정

**파일**: `lib/utils/planGroupDataSync.ts`

#### 2.1 syncWizardDataToCreationData 수정
- `content_allocations`를 `scheduler_options`에 저장
- `subject_allocations`와 `student_level`도 함께 `scheduler_options`에 저장
- `PlanGroupCreationData`에도 `content_allocations` 필드 추가

#### 2.2 syncCreationDataToWizardData 수정
- `scheduler_options`에서 `content_allocations` 추출하여 WizardData에 복원
- `subject_allocations`와 함께 추출

### 3. 데이터 타입 수정

**파일**: `lib/types/plan.ts`

**변경 사항**:
- `SchedulerOptions` 타입에 다음 필드 추가:
  - `student_level?: "high" | "medium" | "low"`
  - `subject_allocations?: Array<{...}>`
  - `content_allocations?: Array<{...}>`

## 수정된 파일 목록

1. `app/(student)/plan/new-group/_components/Step6Simplified.tsx`
   - SubjectAllocationEditor 컴포넌트를 교과별 그룹화 + 콘텐츠별 설정 UI로 변경

2. `lib/utils/planGroupDataSync.ts`
   - syncWizardDataToCreationData: content_allocations를 scheduler_options에 저장
   - syncCreationDataToWizardData: scheduler_options에서 content_allocations 복원

3. `lib/types/plan.ts`
   - SchedulerOptions 타입에 content_allocations, subject_allocations, student_level 필드 추가

## 폴백 메커니즘

콘텐츠의 전략/취약 설정은 다음 우선순위로 결정됩니다:

1. **콘텐츠별 설정** (content_allocations)
   - 각 콘텐츠마다 개별적으로 설정한 값
   - 가장 높은 우선순위

2. **교과별 설정** (subject_allocations)
   - 해당 교과의 모든 콘텐츠에 적용되는 기본값
   - 콘텐츠별 설정이 없을 때 사용

3. **기본값** (취약과목)
   - 콘텐츠별 설정과 교과별 설정이 모두 없을 때 사용
   - 취약과목으로 처리 (전체 학습일에 플랜 배정)

## 테스트 시나리오

1. 관리자가 "남은 단계 진행하기" 클릭
2. Step 5 (최종 확인)에서 "전략과목/취약과목" 섹션 확인
3. 교과별로 그룹화된 콘텐츠 목록 확인
4. 각 콘텐츠마다 전략/취약 설정 가능 확인
5. 콘텐츠별 설정이 없을 때 교과별 설정 또는 기본값 표시 확인
6. 설정 저장 후 플랜 생성 시 올바르게 적용되는지 확인

## 예상 효과

- ✅ 교과별 분류는 유지하면서 각 콘텐츠마다 개별 설정 가능
- ✅ 콘텐츠별 설정이 우선 적용되며, 설정되지 않은 콘텐츠는 교과별 설정을 따름
- ✅ UI가 더 직관적이고 세밀한 조율 가능
- ✅ 기존 subject_allocations는 유지하여 하위 호환성 보장

