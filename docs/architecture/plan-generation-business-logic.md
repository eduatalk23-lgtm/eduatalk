# 플랜 생성 비즈니스 로직 분석

> **작성일**: 2026-01-20
> **최종 업데이트**: 2026-01-20
> **관련 문서**: [플랜 시스템 통합 아키텍처](./plan-system-unification.md)

---

## 목차

1. [개요](#1-개요)
2. [진입점 (Entry Points)](#2-진입점-entry-points)
3. [핵심 스케줄링 로직](#3-핵심-스케줄링-로직)
4. [비즈니스 규칙](#4-비즈니스-규칙)
5. [데이터 흐름](#5-데이터-흐름)
6. [주요 함수 레퍼런스](#6-주요-함수-레퍼런스)
7. [실행 예시](#7-실행-예시)

---

## 1. 개요

### 1.1 플랜 생성 시스템 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         플랜 생성 시스템 아키텍처                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                       │
│  │   학생      │   │   관리자     │   │    캠프     │                       │
│  │   위자드    │   │ 배치 생성   │   │   참여      │                       │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘                       │
│         │                 │                 │                               │
│         └─────────────────┼─────────────────┘                               │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    createPlanGroupAction                             │   │
│  │                    (plan_groups 테이블에 저장)                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                 generatePlansWithServicesAction                      │   │
│  │                 (14단계 플랜 생성 파이프라인)                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│         ┌─────────────────┼─────────────────┐                               │
│         ▼                 ▼                 ▼                               │
│  ┌───────────┐     ┌───────────┐     ┌───────────┐                         │
│  │Scheduler  │     │1730Logic  │     │Payload    │                         │
│  │Engine     │     │(주기계산) │     │Builder    │                         │
│  └───────────┘     └───────────┘     └───────────┘                         │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      student_plan 테이블                             │   │
│  │                      (실제 학습 일정 저장)                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 진입점 (Entry Points)

### 2.1 학생 위자드 플로우

```
사용자 → 7단계 위자드 완료 → createPlanGroupAction → generatePlansWithServicesAction

┌─────────────────────────────────────────────────────────────────────────────┐
│ 학생 위자드 플로우                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 1-6: 위자드 데이터 수집                                               │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 콘텐츠  │→│  기간   │→│ 제외일  │→│ 학원    │→│스케줄러 │→│  확인   │   │
│  │  선택   │ │  설정   │ │  설정   │ │ 일정    │ │ 옵션    │ │  제출   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
│                                                                             │
│  Step 7: 결과 확인                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 생성된 플랜 미리보기 → 완료 버튼 → /plan/group/[id]                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

파일: lib/domains/plan/actions/plan-groups/create.ts
함수: createPlanGroupAction (line 685)
     _createPlanGroup (line 224)
```

### 2.2 관리자 배치 생성

```
관리자 → 학생 선택 → 플랜 템플릿 → createBatchPlanGroups

파일: app/(admin)/admin/plan-creation/_actions/batchActions.ts
함수: createBatchPlanGroups (line 210)
     createBatchUnifiedPlans (line ~380)
```

### 2.3 캠프 참여

```
학생 → 캠프 초대 수락 → 위자드 완료 → submitCampParticipation

파일: lib/domains/camp/actions/student.ts
함수: submitCampParticipation (line 138)
```

---

## 3. 핵심 스케줄링 로직

### 3.1 14단계 플랜 생성 파이프라인

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    generatePlansWithServices 14단계 파이프라인               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 1: 인증 및 컨텍스트                                            │   │
│  │  • 플랜 그룹 접근 권한 확인                                          │   │
│  │  • 테넌트 컨텍스트 획득                                              │   │
│  │  파일: generatePlansWithServices.ts:165-167                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 2: 동시성 제어                                                 │   │
│  │  • 플랜 그룹 락 획득 (동시 생성 방지)                                │   │
│  │  파일: generatePlansWithServices.ts:173                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 3: 플랜 그룹 데이터 로드                                       │   │
│  │  • plan_groups, plan_contents, exclusions, academy_schedules        │   │
│  │  • Phase 3: 단일 콘텐츠 모드 처리 (synthetic content)               │   │
│  │  파일: generatePlansWithServices.ts:184-200                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 4: 블록 세트 및 스케줄러 설정                                  │   │
│  │  • block_set에서 시간 슬롯 획득                                      │   │
│  │  • planner + group settings 병합                                    │   │
│  │  파일: generatePlansWithServices.ts:282-312                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 5: 일정 계산                                                   │   │
│  │  • calculateAvailableDates() 호출                                   │   │
│  │  • 제외일(휴가, 개인일정) 필터링                                     │   │
│  │  • 날짜별 가용 시간 범위 추출                                        │   │
│  │  파일: generatePlansWithServices.ts:316-379                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 6: 서비스 컨텍스트 설정                                        │   │
│  │  • Supabase 클라이언트 생성                                          │   │
│  │  • PlanServiceContext 빌드                                          │   │
│  │  파일: generatePlansWithServices.ts:384-422                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 7: 콘텐츠 해상도                                               │   │
│  │  • ContentResolutionService.resolveContents()                       │   │
│  │  • 학생 콘텐츠 → 마스터 콘텐츠 매핑 검증                             │   │
│  │  파일: generatePlansWithServices.ts:427-446                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 8: 기존 플랜 조회 (Phase 2)                                    │   │
│  │  • 동일 기간 내 다른 plan_group의 플랜 조회                          │   │
│  │  • 시간 슬롯 충돌 방지용                                             │   │
│  │  파일: generatePlansWithServices.ts:452-472                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 9: 스케줄러 호출 (핵심)                                        │   │
│  │  • generatePlansFromGroup() with all parameters                     │   │
│  │  • 날짜, 시간, 범위가 포함된 ScheduledPlan[] 반환                   │   │
│  │  파일: generatePlansWithServices.ts:500-540                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 10: 폴백 배치                                                  │   │
│  │  • 기존 플랜과 충돌 시:                                              │   │
│  │    - validateNoTimeOverlaps() 확인                                  │   │
│  │    - adjustOverlappingTimes() 재조정                                │   │
│  │    - AvailabilityAwarePlacementService로 자율학습 시간 배치         │   │
│  │  파일: generatePlansWithServices.ts:556-678                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 11: 페이로드 빌드                                              │   │
│  │  • PlanPayloadBuilder로 DB insert 페이로드 생성                     │   │
│  │  • 완전한 student_plan 레코드 빌드                                  │   │
│  │  파일: generatePlansWithServices.ts:683-694                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 12: 가상 플랜 생성 (슬롯 모드)                                 │   │
│  │  • 슬롯 모드 활성화 시: generateVirtualPlanItems()                  │   │
│  │  • GUI 표시용 가상 플랜 (is_virtual=true)                           │   │
│  │  파일: generatePlansWithServices.ts:698-765                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 13: 검증                                                       │   │
│  │  • PlanValidationService.validatePayloads()                         │   │
│  │  • validateContentExistence() (도서/강의 존재 확인)                 │   │
│  │  파일: generatePlansWithServices.ts:768-797                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                 │
│                           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 14: 저장                                                       │   │
│  │  • PlanPersistenceService.deleteExistingPlans()                     │   │
│  │  • PlanPersistenceService.insertPlans()                             │   │
│  │  • plan_group.status = "saved"                                      │   │
│  │  파일: generatePlansWithServices.ts:802-824                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 SchedulerEngine 핵심 메서드

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SchedulerEngine 핵심 로직                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  파일: lib/scheduler/SchedulerEngine.ts                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. calculateCycle() - Line 166                                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 입력: periodStart, periodEnd, exclusions, study_days, review_days   │   │
│  │ 출력: CycleDayInfo[] (day_type: "study" | "review" | "exclusion")   │   │
│  │                                                                       │   │
│  │ 예시 (6학습 + 1복습 주기):                                            │   │
│  │   Day 1-6: study                                                      │   │
│  │   Day 7: review                                                       │   │
│  │   Day 8-13: study                                                     │   │
│  │   Day 14: review                                                      │   │
│  │   ...                                                                 │   │
│  │                                                                       │   │
│  │ 규칙: 제외일은 주기에서 완전히 제외 (카운트하지 않음)                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2. allocateContentDates() - Line 216                                 │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 입력: Contents + subject_allocations + content_allocations          │   │
│  │ 출력: Map<contentId, string[]> (콘텐츠별 배정 날짜)                  │   │
│  │                                                                       │   │
│  │ 로직:                                                                 │   │
│  │   • 취약과목(weakness): 모든 학습일 배정                              │   │
│  │   • 전략과목(strategy): weekly_days만큼 배정 (주당)                   │   │
│  │                                                                       │   │
│  │ 예시:                                                                 │   │
│  │   수학(취약): 18개 학습일 전체                                        │   │
│  │   영어(전략, weekly_days=3): 주당 3일 선택 → 약 9일                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3. distributeContentWithCapacity() - Line 322                        │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 입력: Content + allocated dates + duration info                     │   │
│  │ 출력: Map<date, {start: number, end: number}>                       │   │
│  │                                                                       │   │
│  │ 로직:                                                                 │   │
│  │   • 도서: 배정일 수에 따라 페이지 균등 분배                           │   │
│  │   • 강의: 에피소드 균등 분배                                          │   │
│  │   • 마지막 날에 나머지 할당                                           │   │
│  │                                                                       │   │
│  │ 예시 (300페이지, 20일):                                               │   │
│  │   일당 범위 = 300 / 20 = 15페이지                                     │   │
│  │   Day 1: 1-15, Day 2: 16-30, ..., Day 20: 286-300                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4. coordinateGlobalDistribution() - Line 526 (Phase 3)               │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ 입력: All contents + allocated dates                                 │   │
│  │ 출력: Coordinated placement across all days                          │   │
│  │                                                                       │   │
│  │ 로직:                                                                 │   │
│  │   • 위험 지수(Risk Index) 기준 콘텐츠 정렬                            │   │
│  │   • 라운드 로빈 방식으로 날짜 배치                                    │   │
│  │   • 일일 용량 제약 준수                                               │   │
│  │   • 전체 기간에 걸쳐 콘텐츠 균등 분배                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 1730 타임테이블 로직

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         1730 타임테이블 로직                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  파일: lib/plan/1730TimetableLogic.ts                                       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ calculateStudyReviewCycle()                                          │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │    1730 주기 = 17일 학습 + 3일 복습 + 0일 휴식 (기본값)              │   │
│  │    또는 사용자 정의: study_days + review_days                         │   │
│  │                                                                       │   │
│  │    ┌─────────────────────────────────────────────────────────┐       │   │
│  │    │ Week 1                                                  │       │   │
│  │    │ Mon Tue Wed Thu Fri Sat Sun                             │       │   │
│  │    │  S   S   S   S   S   S   R                              │       │   │
│  │    │  1   2   3   4   5   6   7                              │       │   │
│  │    └─────────────────────────────────────────────────────────┘       │   │
│  │    │ Week 2                                                  │       │   │
│  │    │ Mon Tue Wed Thu Fri Sat Sun                             │       │   │
│  │    │  S   S   S   S   S   S   R                              │       │   │
│  │    │  8   9  10  11  12  13  14                              │       │   │
│  │    └─────────────────────────────────────────────────────────┘       │   │
│  │                                                                       │   │
│  │    S = Study (학습일)                                                 │   │
│  │    R = Review (복습일)                                                │   │
│  │    제외일은 주기 카운트에서 제외                                      │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ calculateSubjectAllocationDates()                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │    취약과목(Weakness) vs 전략과목(Strategy) 배정 규칙                 │   │
│  │                                                                       │   │
│  │    ┌───────────────────────────────────────────────────────────┐     │   │
│  │    │ 과목 유형       │ 배정 규칙                                │     │   │
│  │    ├───────────────────────────────────────────────────────────┤     │   │
│  │    │ 취약(weakness) │ 모든 학습일 (100%)                       │     │   │
│  │    │ 전략(strategy) │ weekly_days/주 (예: 3일/주)              │     │   │
│  │    └───────────────────────────────────────────────────────────┘     │   │
│  │                                                                       │   │
│  │    예시 (20일 기간, 18 학습일):                                       │   │
│  │      수학(취약): 18일 전체                                            │   │
│  │      영어(전략, 3일/주): ~9일 (3주 × 3일)                            │   │
│  │      국어(전략, 2일/주): ~6일 (3주 × 2일)                            │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ divideContentRange()                                                 │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │    콘텐츠 범위를 배정 날짜에 균등 분배                                │   │
│  │                                                                       │   │
│  │    입력: totalRange=300, allocatedDates=20                           │   │
│  │    출력: dailyRange = 15                                             │   │
│  │                                                                       │   │
│  │    ┌──────────────────────────────────────────┐                      │   │
│  │    │ Day 1:  pages 1-15   (15pp)              │                      │   │
│  │    │ Day 2:  pages 16-30  (15pp)              │                      │   │
│  │    │ Day 3:  pages 31-45  (15pp)              │                      │   │
│  │    │ ...                                      │                      │   │
│  │    │ Day 19: pages 271-285 (15pp)             │                      │   │
│  │    │ Day 20: pages 286-300 (나머지 15pp)       │                      │   │
│  │    └──────────────────────────────────────────┘                      │   │
│  │                                                                       │   │
│  │    중요: end 값은 EXCLUSIVE (슬라이싱용)                              │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 비즈니스 규칙

### 4.1 학습일 vs 복습일 계산

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      학습일/복습일 계산 규칙                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  파일: 1730TimetableLogic.ts:65-134                                         │
│                                                                             │
│  기본 설정:                                                                  │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │ study_days = 6 (학습일)                                            │    │
│  │ review_days = 1 (복습일)                                           │    │
│  │ 총 주기 = 7일                                                      │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  예시: 1월 1일 ~ 1월 31일, 제외일 2개 (1/2 휴가, 1/15 개인일정)            │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                                                                    │    │
│  │  1월 1일 (Day 1): 학습                                             │    │
│  │  1월 2일 : ❌ 제외 (휴가) - 주기에서 카운트 안 함                   │    │
│  │  1월 3일 (Day 2): 학습                                             │    │
│  │  1월 4일 (Day 3): 학습                                             │    │
│  │  1월 5일 (Day 4): 학습                                             │    │
│  │  1월 6일 (Day 5): 학습                                             │    │
│  │  1월 7일 (Day 6): 학습                                             │    │
│  │  1월 8일 (Day 7): 복습 ← 새 주기 시작                              │    │
│  │  1월 9일 (Day 1): 학습                                             │    │
│  │  ...                                                               │    │
│  │  1월 15일: ❌ 제외 (개인일정)                                       │    │
│  │  1월 16일 (Day N): 학습 ← 주기 위치 유지                           │    │
│  │                                                                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  핵심 규칙: 제외일은 완전히 건너뜀 - 주기 위치를 소비하지 않음             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 전략과목 vs 취약과목

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      전략과목 vs 취약과목 배정                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  파일: SchedulerEngine.ts:216-316                                           │
│        1730TimetableLogic.ts:147-191                                        │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                                                                    │    │
│  │  subject_allocations: [                                            │    │
│  │    { subject: "수학", type: "weakness" },      // 취약             │    │
│  │    { subject: "영어", type: "strategy", weekly_days: 3 },  // 전략 │    │
│  │    { subject: "국어", type: "strategy", weekly_days: 2 },  // 전략 │    │
│  │    { subject: "과학", type: "strategy", weekly_days: 4 },  // 전략 │    │
│  │  ]                                                                 │    │
│  │                                                                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  배정 결과 (20 학습일 기준):                                                │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                                                                    │    │
│  │  취약과목 (수학): 20일 전체 ████████████████████ (100%)           │    │
│  │                                                                    │    │
│  │  전략과목 (영어): ~9일    █████████░░░░░░░░░░░ (3일/주 × 3주)      │    │
│  │                                                                    │    │
│  │  전략과목 (국어): ~6일    ██████░░░░░░░░░░░░░░ (2일/주 × 3주)      │    │
│  │                                                                    │    │
│  │  전략과목 (과학): ~12일   ████████████░░░░░░░░ (4일/주 × 3주)      │    │
│  │                                                                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  핵심 규칙:                                                                 │
│  • 취약과목 = 모든 학습일 (100%)                                           │
│  • 전략과목 = weekly_days/주, 균등 분포                                    │
│  • getEffectiveAllocation()으로 과목 유형 결정                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 블록/시간 슬롯 활용

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         블록/시간 슬롯 활용                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  파일: SchedulerEngine.ts:322-514                                           │
│                                                                             │
│  일일 가용 시간 계산:                                                       │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │ 1. dateTimeSlots (Step 2.5 스케줄 결과)                            │    │
│  │    - "학습시간" 타입 슬롯만 사용                                   │    │
│  │    - 모든 학습 시간 슬롯 합산                                      │    │
│  │                                                                    │    │
│  │ 2. dateAvailableTimeRanges (폴백)                                  │    │
│  │    - 범위 기반 가용 시간                                           │    │
│  │    - 모든 가용 범위 합산                                           │    │
│  │                                                                    │    │
│  │ 3. 기본 용량                                                       │    │
│  │    - 슬롯/범위 없는 경우: 120분 (2시간)                            │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  예시: 09:00-21:00 블록 (12시간 = 720분)                                    │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                                                                    │    │
│  │  09:00 ┌───────────────────────┐                                   │    │
│  │        │     수학 (90분)       │                                   │    │
│  │  10:30 ├───────────────────────┤                                   │    │
│  │        │     영어 (60분)       │                                   │    │
│  │  11:30 ├───────────────────────┤                                   │    │
│  │        │     점심 (60분)       │                                   │    │
│  │  12:30 ├───────────────────────┤                                   │    │
│  │        │     국어 (90분)       │                                   │    │
│  │  14:00 ├───────────────────────┤                                   │    │
│  │        │     과학 (60분)       │                                   │    │
│  │  15:00 ├───────────────────────┤                                   │    │
│  │        │    자율학습 (360분)   │                                   │    │
│  │  21:00 └───────────────────────┘                                   │    │
│  │                                                                    │    │
│  │  총 사용: 360분 (6시간) / 총 가용: 720분 (12시간)                 │    │
│  │                                                                    │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  용량 인식 분배:                                                            │
│  • 도서: 일일 용량 기준 페이지 분배                                        │
│  • 강의: 에피소드 균등 분배 (용량 미적용)                                  │
│  • 커스텀: 순수 용량 인식 (일일 용량까지 채움)                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 흐름

### 5.1 전체 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 1: Plan Group 생성                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  입력: WizardData (Step 1-6)                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - name, plan_purpose, period_start, period_end                      │   │
│  │ - contents: [{content_type, content_id, start_range, end_range}]    │   │
│  │ - exclusions: [{exclusion_date, exclusion_type, reason}]            │   │
│  │ - academy_schedules: [{day_of_week, start_time, end_time}]          │   │
│  │ - scheduler_options: {study_days, review_days, ...}                 │   │
│  │ - block_set_id                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  처리:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. time_settings + scheduler_options 병합                           │   │
│  │ 2. subject_allocations, content_allocations 검증                    │   │
│  │ 3. 슬롯 모드: content_slots → subject_allocations 생성              │   │
│  │ 4. 제외일 중복 제거 및 포맷                                         │   │
│  │ 5. RPC create_plan_group_atomic() 호출                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  출력: plan_groups 레코드                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - id, name, period_start, period_end                                │   │
│  │ - scheduler_options, scheduler_type                                 │   │
│  │ - status = "draft" (아직 생성 안 됨)                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 2: Plan 생성 (핵심 스케줄링)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  입력: plan_group.id                                                        │
│                              │                                              │
│                              ▼                                              │
│  Step 1: 데이터 조회                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - plan_groups, plan_contents, plan_exclusions                       │   │
│  │ - block_set 또는 daily_schedule의 blocks                            │   │
│  │ - academy_schedules                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  Step 2: 가용 날짜 계산                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ calculateAvailableDates():                                          │   │
│  │ - 입력: period_start, period_end, exclusions, blocks                │   │
│  │ - 휴가/제외일 필터링                                                │   │
│  │ - 출력: daily_schedule with available_time_ranges                   │   │
│  │   예시: [                                                           │   │
│  │     {date: "2025-01-01", day_type: "study", available: 10h},       │   │
│  │     {date: "2025-01-02", day_type: "exclusion", available: 0}      │   │
│  │   ]                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  Step 3: SchedulerEngine 핵심 로직                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ A. calculateCycle() → CycleDayInfo[]                                │   │
│  │    - 비제외일에 학습/복습 할당                                      │   │
│  │    - study_days:review_days 비율 준수                               │   │
│  │                                                                     │   │
│  │ B. allocateContentDates() → Map<contentId, dates[]>                │   │
│  │    - 전략과목: weekly_days 배정                                     │   │
│  │    - 취약과목: 모든 학습일                                          │   │
│  │                                                                     │   │
│  │ C. distributeContentWithCapacity() → Map<date, ranges>             │   │
│  │    - 콘텐츠 범위를 배정일에 분배                                    │   │
│  │    - 예: 300페이지 / 20일 = 15pp/일                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  Step 4: 스케줄된 플랜 생성                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ generateScheduledPlans():                                           │   │
│  │ - 입력: contentInfos, 배정 날짜, 시간 슬롯                          │   │
│  │ - 출력: ScheduledPlan[]                                             │   │
│  │   {plan_date, content_id, planned_start_page, planned_end_page,     │   │
│  │    start_time, end_time, subject_type, is_reschedulable}            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  출력: scheduledPlans[]                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 3: 페이로드 빌드 및 저장                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  입력: scheduledPlans[], plan_group, schedule result                        │
│                              │                                              │
│                              ▼                                              │
│  Step 1: PlanPayloadBuilder.buildPayloads()                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - ScheduledPlan → GeneratePlanPayload 변환                          │   │
│  │ - chapter, content_title, subject 등 보강                           │   │
│  │ - block_index, week, day 계산 추가                                  │   │
│  │ - 출력: DB insert 준비된 plan_payload[]                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  Step 2: 검증                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - PlanValidationService.validatePayloads()                          │   │
│  │ - validateContentExistence() (도서/강의 존재 확인)                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  Step 3: 저장                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - PlanPersistenceService.deleteExistingPlans(groupId) (재생성 시)   │   │
│  │ - PlanPersistenceService.insertPlans(payloads) 배치 삽입            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  Step 4: 상태 업데이트                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - UPDATE plan_groups SET status = "saved"                           │   │
│  │ - UPDATE plan_groups SET schedule_generated_at = NOW()              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│                              ▼                                              │
│  출력: student_plan 레코드들                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ - student_id, plan_group_id, plan_date                              │   │
│  │ - content_type, content_id, planned_start/end_page                  │   │
│  │ - start_time, end_time, block_index                                 │   │
│  │ - day_type, week, day, subject_type                                 │   │
│  │ - is_virtual, is_reschedulable                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 주요 함수 레퍼런스

### 6.1 플랜 생성 진입점

| 함수 | 파일 | 라인 | 용도 |
|------|------|------|------|
| `createPlanGroupAction` | `create.ts` | 685 | 학생 위자드 → plan_group 생성 |
| `generatePlansWithServicesAction` | `generatePlansWithServices.ts` | 884 | 플랜 생성 트리거 |
| `createBatchUnifiedPlans` | `batchActions.ts` | ~380 | 관리자 배치 플랜 생성 |
| `submitCampParticipation` | `camp/actions/student.ts` | 138 | 캠프 참여 플로우 |

### 6.2 핵심 스케줄링

| 함수 | 파일 | 라인 | 용도 |
|------|------|------|------|
| `generatePlansFromGroup` | `scheduler.ts` | 103 | 메인 스케줄러 코디네이터 |
| `calculateAvailableDates` | `scheduleCalculator.ts` | - | 가용 날짜 계산 |
| `generateScheduledPlans` | `scheduler/index.ts` | - | 스케줄러 호출 팩토리 |
| `calculateStudyReviewCycle` | `1730TimetableLogic.ts` | 65 | 학습/복습일 분류 |
| `calculateSubjectAllocationDates` | `1730TimetableLogic.ts` | 147 | 전략/취약과목 배정 |
| `divideContentRange` | `1730TimetableLogic.ts` | 196 | 콘텐츠 범위 분배 |
| `SchedulerEngine.calculateCycle` | `SchedulerEngine.ts` | 166 | 주기일 계산 |
| `SchedulerEngine.allocateContentDates` | `SchedulerEngine.ts` | 216 | 콘텐츠 날짜 배정 |
| `SchedulerEngine.distributeContentWithCapacity` | `SchedulerEngine.ts` | 322 | 용량 인식 분배 |
| `SchedulerEngine.coordinateGlobalDistribution` | `SchedulerEngine.ts` | 526 | 전역 조율 (Phase 3) |

### 6.3 시간 충돌 관리

| 함수 | 파일 | 용도 |
|------|------|------|
| `validateNoTimeOverlaps` | `timeOverlapValidator.ts` | 시간 충돌 감지 |
| `adjustOverlappingTimes` | `timeOverlapValidator.ts` | 겹치는 플랜 자동 조정 |
| `AvailabilityAwarePlacementService.placeWithFallback` | `AvailabilityAwarePlacementService.ts` | Dock으로 폴백 배치 |

### 6.4 페이로드 및 저장

| 함수 | 파일 | 용도 |
|------|------|------|
| `PlanPayloadBuilder.buildPayloads` | `planPayloadBuilder.ts` | 삽입 페이로드 생성 |
| `PlanValidationService.validatePayloads` | `planValidationService.ts` | 플랜 페이로드 검증 |
| `PlanPersistenceService.insertPlans` | `PlanPersistenceService.ts` | DB 배치 삽입 |
| `PlanPersistenceService.deleteExistingPlans` | `PlanPersistenceService.ts` | 재생성 전 정리 |

---

## 7. 실행 예시

### 7.1 시나리오

**입력**: 2개 과목, 20일 기간, 6학습 + 1복습 주기

```typescript
PlanGroupCreationData {
  name: "수학/영어 집중 계획",
  period_start: "2025-01-01",
  period_end: "2025-01-20",
  contents: [
    {content_type: "book", content_id: "math_book_1", start_range: 1, end_range: 300},
    {content_type: "lecture", content_id: "eng_lectures_1", start_range: 1, end_range: 40}
  ],
  scheduler_options: {
    study_days: 6,
    review_days: 1,
    subject_allocations: [
      {subject_name: "수학", subject_type: "weakness"},
      {subject_name: "영어", subject_type: "strategy", weekly_days: 4}
    ]
  },
  block_set_id: "block_set_standard"  // 09:00-21:00
}
```

### 7.2 실행 흐름

```
STEP 1: Plan Group 생성
  → RPC: create_plan_group_atomic()
  → plan_groups.id = "pg_123" (status="draft")

STEP 2: Block Set 조회
  → blocks = [{day_of_week: 0-6, start_time: "09:00", end_time: "21:00"}]
  → 일일 용량 = 12시간 × 60 = 720분

STEP 3: 가용 날짜 계산
  → 기간: 2025-01-01 ~ 2025-01-20 (20일, 제외일 없음)
  → daily_schedule = [{date: "2025-01-01", day_type: "study", ...}, ...x20]

STEP 4: 주기 계산 (SchedulerEngine.calculateCycle)
  → 6학습 + 1복습 = 7일 주기, ~3회 반복

  ┌─────────────────────────────────────────────────────────────────┐
  │  날짜 1-6: 학습                                                 │
  │  날짜 7: 복습                                                   │
  │  날짜 8-13: 학습                                                │
  │  날짜 14: 복습                                                  │
  │  날짜 15-20: 학습 (마지막 불완전 주기)                          │
  │                                                                 │
  │  studyDates = [1/1~1/6, 1/8~1/13, 1/15~1/20] (총 18일)         │
  │  reviewDates = [1/7, 1/14] (총 2일)                            │
  └─────────────────────────────────────────────────────────────────┘

STEP 5: 콘텐츠 날짜 배정 (allocateContentDates)
  → 수학 (취약): 18개 학습일 전체
  → 영어 (전략, weekly_days=4): 주당 4일 선택

  ┌─────────────────────────────────────────────────────────────────┐
  │  Week 1 (6 학습일): 4일 균등 선택 → 1, 3, 4, 6                 │
  │  Week 2 (6 학습일): 4일 균등 선택 → 8, 10, 11, 13              │
  │  Week 3 (6 학습일): 4일 균등 선택 → 15, 17, 18, 20             │
  │                                                                 │
  │  contentAllocationMap = {                                       │
  │    "math_book_1": [18개 학습일 전체],                           │
  │    "eng_lectures_1": [12개 선택일]                              │
  │  }                                                              │
  └─────────────────────────────────────────────────────────────────┘

STEP 6: 콘텐츠 용량 분배 (distributeContentWithCapacity)
  수학 (300페이지, 18 학습일):
    dailyRange = 300 / 18 = 16.67pp/일

  ┌─────────────────────────────────────────────────────────────────┐
  │  → Day 1: pages 1-17                                           │
  │  → Day 2: pages 18-33                                          │
  │  ... (14일 × 17pp)                                             │
  │  → Day 18: pages 273-300 (나머지)                              │
  └─────────────────────────────────────────────────────────────────┘

  영어 (40 에피소드, 12 배정일):
    dailyRange = 40 / 12 = 3.33 에피소드/일

  ┌─────────────────────────────────────────────────────────────────┐
  │  → Day 1 (2025-01-01): episodes 1-4                            │
  │  → Day 3 (2025-01-03): episodes 5-7                            │
  │  → Day 4 (2025-01-04): episodes 8-10                           │
  │  ... 등                                                         │
  │  → Day 20 (2025-01-20): episodes 37-40                         │
  └─────────────────────────────────────────────────────────────────┘

STEP 7: 스케줄된 플랜 생성 (generateScheduledPlans)
  → 각 플랜에 해당 날짜의 가용 시간 슬롯 할당
  → 충돌 없다고 가정, 720분/일 용량 내에 플랜 배치

  ┌─────────────────────────────────────────────────────────────────┐
  │  scheduledPlans = [                                             │
  │    {plan_date: "2025-01-01", content_id: "math_book_1",         │
  │     planned_start_page: 1, planned_end_page: 17,                │
  │     start_time: "09:00", end_time: "10:30", day_type: "study"}, │
  │    {plan_date: "2025-01-01", content_id: "eng_lectures_1",      │
  │     planned_start_episode: 1, planned_end_episode: 4,           │
  │     start_time: "10:30", end_time: "11:30", day_type: "study"}, │
  │    ... (나머지 ~48개 플랜)                                      │
  │  ]                                                              │
  └─────────────────────────────────────────────────────────────────┘

STEP 8: 페이로드 빌드 (PlanPayloadBuilder.buildPayloads)
  → DB insert용 GeneratePlanPayload로 변환
  → chapter, content_title, subject 등 보강
  → week, day, block_index 계산 필드 추가

STEP 9: 플랜 저장 (PlanPersistenceService.insertPlans)
  → ~50개 레코드 student_plan 테이블에 배치 삽입
  → 각 레코드: student_id, plan_group_id, plan_date,
              content_type, content_id, start_time, end_time,
              planned_start_page, planned_end_page,
              day_type, week, day, subject_type

STEP 10: 상태 업데이트
  → UPDATE plan_groups SET status = "saved" WHERE id = "pg_123"

출력: ~50개 student_plan 레코드 (캘린더 표시 준비)
```

---

## 참조

- [플랜 시스템 통합 아키텍처](./plan-system-unification.md)
- [Phase 3.1 위자드 개선](./phase-3-1-wizard-multi-content.md)
- [다음 작업 로드맵](./next-work-roadmap.md)
