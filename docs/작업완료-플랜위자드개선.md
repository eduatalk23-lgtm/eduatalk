# 플랜 위자드 개선 작업 완료

## 작업 날짜
2024년 11월 30일

## 작업 개요
학습 제외일과 학원 일정 관리 기능을 개선하고, 플랜 생성 위자드의 Step 2와 Step 3을 분리하여 사용자 경험을 향상시켰습니다.

---

## 1. 시간 관리 불러오기 개편

### 문제점
- 기존: 시간 관리에서 데이터를 불러오면 자동으로 모든 항목이 추가됨
- 사용자가 선택할 수 없어 불필요한 항목도 함께 추가됨
- 중복 제거만 가능하고 선택적 추가가 불가능

### 해결 방법

#### 1.1 학습 제외일 선택 등록
- **모달 방식 도입**: 불러오기 버튼 클릭 시 선택 모달 표시
- **플랜 기간 필터링**: 플랜 기간에 해당하는 제외일만 표시
- **선택 등록**: 체크박스로 원하는 항목만 선택 후 등록
- **중복 방지**: 이미 등록된 제외일은 비활성화 표시
- **같은 날짜 중복 불가**: 같은 날짜의 제외일은 하나만 등록 가능

**새 파일**: `ExclusionImportModal.tsx`

#### 1.2 학원 일정 선택 등록
- **모달 방식 도입**: 불러오기 버튼 클릭 시 선택 모달 표시
- **요일별 그룹화**: 학원 일정을 요일별로 구분하여 표시
- **선택 등록**: 체크박스로 원하는 일정만 선택 후 등록
- **시간대 겹침 검증**: 선택한 일정들 간의 시간 겹침 자동 확인
- **겹침 경고**: 겹치는 일정 선택 시 경고 표시 및 등록 차단

**새 파일**: 
- `AcademyScheduleImportModal.tsx`
- `scheduleValidator.ts`

---

## 2. 학원 일정 시간대 겹침 검증

### 문제점
- 기존: 요일+시작시간+종료시간 조합으로만 중복 검사
- 이동시간을 고려하지 않아 실제로는 겹치는데 등록되는 경우 발생
- 부분적으로 겹치는 일정도 등록 가능

### 해결 방법

#### 검증 로직 개선
1. **이동시간 포함 계산**
   ```
   실제 제외 시작 시간 = 학원 시작 시간 - 이동시간
   실제 제외 종료 시간 = 학원 종료 시간 + 이동시간
   ```

2. **시간대 겹침 확인**
   - 같은 요일의 모든 일정과 비교
   - 이동시간을 포함한 실제 시간대로 겹침 판단
   - 1분이라도 겹치면 경고

3. **겹침 정보 제공**
   - 어떤 일정과 겹치는지 상세 표시
   - 실제 제외 시간 범위 표시

**새 파일**: `lib/validation/scheduleValidator.ts`

**주요 함수**:
```typescript
validateAcademyScheduleOverlap(
  newSchedule: AcademySchedule,
  existingSchedules: AcademySchedule[]
): { 
  isValid: boolean; 
  conflictSchedules: AcademySchedule[] 
}
```

---

## 3. Step 2와 Step 3 분리

### 문제점
- 기존: Step 2에 설정과 미리보기가 함께 표시 (좌우 분할)
- 화면이 복잡하고 각 영역이 좁아 불편함
- 모바일에서는 세로 배치로 스크롤이 길어짐

### 해결 방법

#### Step 구조 변경

**변경 전**:
```
Step 1: 기본 정보
Step 2: 블록 및 제외일 + 스케줄 미리보기 (통합)
Step 3: 콘텐츠 선택 (실제 Step 4)
Step 4: 최종 확인 (실제 Step 6)
Step 5: 스케줄 결과 (실제 Step 7)
```

**변경 후**:
```
Step 1: 기본 정보
Step 2: 블록 및 제외일 설정
Step 3: 스케줄 미리보기
Step 4: 콘텐츠 선택
Step 5: 최종 확인
Step 6: 스케줄 결과
```

#### 컴포넌트 변경

**Step 2 (설정 전용)**:
- 파일명 변경: `Step2TimeSettingsWithPreview.tsx` → `Step2TimeSettings.tsx`
- 좌우 분할 레이아웃 제거
- 시간 설정 패널만 표시
- 제외일, 학원 일정, 시간 설정, 학습 시간 제외 항목 포함

**Step 3 (미리보기 전용)** - 신규 생성:
- 새 파일: `Step3SchedulePreview.tsx`
- 전체 화면으로 스케줄 미리보기 표시
- "설정 수정" 버튼으로 Step 2로 쉽게 이동
- 일간/주간/월간 뷰 전환 가능

#### 진행률 계산 업데이트

```typescript
const stepWeights: Record<WizardStep, number> = {
  1: 16.67,  // 기본 정보 (1/6)
  2: 16.67,  // 블록 및 제외일 (2/6)
  3: 16.67,  // 스케줄 확인 (3/6)
  4: 16.67,  // 콘텐츠 선택 (4/6)
  5: 16.67,  // 추천 콘텐츠 (5/6)
  6: 16.65,  // 최종 확인 (6/6)
  7: 0,      // 스케줄 결과 (완료 후)
};
```

---

## 수정/생성된 파일 목록

### 새로 생성된 파일 (4개)
1. `app/(student)/plan/new-group/_components/_panels/_modals/ExclusionImportModal.tsx`
   - 제외일 선택 불러오기 모달

2. `app/(student)/plan/new-group/_components/_panels/_modals/AcademyScheduleImportModal.tsx`
   - 학원 일정 선택 불러오기 모달

3. `app/(student)/plan/new-group/_components/Step3SchedulePreview.tsx`
   - 스케줄 미리보기 전용 Step

4. `lib/validation/scheduleValidator.ts`
   - 학원 일정 시간대 겹침 검증 유틸리티

### 수정된 파일 (4개)
1. `app/(student)/plan/new-group/_components/_panels/ExclusionsPanel.tsx`
   - 모달 통합
   - 선택 등록 방식 적용

2. `app/(student)/plan/new-group/_components/_panels/AcademySchedulePanel.tsx`
   - 모달 통합
   - 수동 추가 시 겹침 검증 적용

3. `app/(student)/plan/new-group/_components/Step2TimeSettings.tsx`
   - 이전: `Step2TimeSettingsWithPreview.tsx`
   - 미리보기 제거
   - 설정 전용으로 변경

4. `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`
   - Step 타입 업데이트 (1~7)
   - Step 가중치 업데이트
   - 진행률 계산 로직 수정
   - 새 Step 컴포넌트 통합

---

## 주요 개선사항 요약

| 항목 | 변경 전 | 변경 후 | 개선 효과 |
|------|---------|---------|----------|
| 제외일 불러오기 | 자동 전체 추가 | 선택 등록 | 불필요한 항목 제외 가능 |
| 학원 일정 불러오기 | 자동 전체 추가 | 선택 등록 | 필요한 일정만 선택 가능 |
| 중복 검증 | 요일+시간 키 비교 | 시간대 겹침 검증 | 이동시간 포함 정확한 검증 |
| Step 레이아웃 | 좌우 분할 | 별도 단계 분리 | 각 단계에 집중 가능 |
| 화면 구성 | 복잡함 | 단순 명확 | 사용성 향상 |

---

## 사용자 경험 개선 효과

### 1. 명확한 선택 과정
- **이전**: 불러오기 하면 모든 항목이 자동 추가
- **개선**: 모달에서 원하는 항목만 체크하여 등록
- **효과**: 사용자가 직접 제어 가능

### 2. 중복 및 충돌 방지
- **이전**: 이미 있는 항목도 다시 추가 시도 가능
- **개선**: 이미 등록된 항목은 비활성화 표시
- **효과**: 혼란 방지

### 3. 시간 겹침 경고
- **이전**: 겹치는 시간대 등록 가능했음
- **개선**: 겹치는 일정 즉시 감지 및 경고
- **효과**: 스케줄 충돌 사전 방지

### 4. 단계별 집중
- **이전**: 한 화면에 설정과 미리보기 함께
- **개선**: 설정 단계와 확인 단계 분리
- **효과**: 각 단계에 집중 가능, 화면 깔끔

### 5. 유연한 편집
- **이전**: 미리보기 보려면 Step 진행 필요
- **개선**: Step 3에서 "설정 수정" 버튼으로 바로 이동
- **효과**: 빠른 수정 가능

---

## 호환성 확인

### 기존 데이터
✅ 모든 기존 플랜 그룹 데이터와 완벽 호환
✅ 기존 제외일 및 학원 일정 유지

### 모드별 동작
✅ **일반 모드**: 정상 동작
✅ **템플릿 모드**: 정상 동작 (Step 1, 2, 3만 사용)
✅ **캠프 모드**: 정상 동작 (Step 1, 2, 3, 4만 사용)
✅ **관리자 모드**: 정상 동작

---

## 테스트 체크리스트

### 제외일 기능
- [x] 플랜 기간 내 제외일만 모달에 표시됨
- [x] 이미 등록된 제외일은 비활성화됨
- [x] 같은 날짜 중복 등록이 방지됨
- [x] 선택한 항목만 등록됨

### 학원 일정 기능
- [x] 시간대가 겹치는 일정 선택 시 경고 표시
- [x] 이동시간이 포함된 실제 시간대로 계산
- [x] 요일별로 그룹화되어 표시
- [x] 겹치는 일정은 등록 불가

### Step 구조
- [x] Step 2에서 설정만 가능
- [x] Step 3에서 미리보기만 표시
- [x] Step 3에서 "설정 수정" 버튼으로 Step 2 이동 가능
- [x] 진행률이 올바르게 계산됨 (16.67% 단위)
- [x] Step 표시가 명확함 (1~6단계)

### 린트 검사
- [x] ESLint 에러 없음
- [x] TypeScript 타입 에러 없음

---

## 향후 개선 제안

1. **학원 일정 수정 기능**
   - 현재: 삭제 후 재등록 필요
   - 개선안: 수정 시에도 겹침 검증 적용

2. **제외일 범위 선택 개선**
   - 현재: 범위 선택 시 겹침 경고 없음
   - 개선안: 범위 내 기존 제외일 표시

3. **드래그 앤 드롭**
   - 개선안: 학원 일정 시간을 드래그로 조정

4. **시각화 개선**
   - 개선안: 주간 뷰에서 학원 일정을 타임라인으로 표시

---

## 결론

이번 개선 작업을 통해:
1. ✅ 사용자가 직접 선택하여 등록 가능
2. ✅ 시간 겹침을 사전에 방지
3. ✅ 화면 구성이 단순 명확해짐
4. ✅ 각 단계에 집중 가능
5. ✅ 모든 기존 기능 호환성 유지

사용자 경험이 크게 향상되었으며, 스케줄 관리의 정확성도 개선되었습니다.

---

**작업 완료일**: 2024년 11월 30일  
**커밋**: feature/stage2 브랜치에 커밋 완료

