# 플랜 생성 시 master_content_id 우선 사용 수정

**작업 일시**: 2025-12-22  
**목적**: 학생의 플랜 그룹 생성과 관리자의 남은 단계 진행 간 차이로 인한 오류 해결

---

## 문제 상황

### 근본 원인

학생의 플랜 그룹 생성과 관리자의 남은 단계 진행에서 콘텐츠 저장 방식이 달라 오류가 발생했습니다:

1. **학생의 플랜 그룹 생성**:
   - `createPlanContents`를 직접 호출
   - `plan_contents.content_id`에 마스터 콘텐츠 ID를 그대로 저장
   - `plan_contents.master_content_id`에도 같은 값 저장

2. **관리자의 남은 단계 진행**:
   - `savePlanContents`를 호출하여 `validateAndResolveContent`로 검증
   - 마스터 콘텐츠를 학생 콘텐츠로 복사하여 저장
   - `plan_contents.content_id`에 학생 콘텐츠 ID 저장

3. **플랜 생성 시**:
   - `generatePlansRefactored.ts`가 `plan_contents.content_id`를 읽음
   - 학생이 저장한 마스터 콘텐츠 ID를 처리하지 못해 오류 발생

---

## 해결 방법

### 핵심 아이디어

`plan_contents`의 `master_content_id` 필드를 우선 사용하도록 수정:

- `master_content_id`가 있으면: 마스터 콘텐츠 ID (학생이 저장한 경우)
- 없으면: `content_id` 사용 (이미 학생 콘텐츠 ID이거나 관리자가 변환한 경우)

### 수정 내용

#### 1. `generatePlansRefactored.ts`

```typescript
// plan_contents의 content_id 해석: master_content_id가 있으면 우선 사용
const getResolvedContentId = (content: typeof contents[0]): string => {
  return content.master_content_id || content.content_id;
};

// 콘텐츠를 타입별로 분류할 때 resolvedContentId 사용
const bookContents = contents
  .filter((c) => c.content_type === "book" && !isDummyContent(c.content_id))
  .map((c) => ({
    ...c,
    resolvedContentId: getResolvedContentId(c),
  }));
```

**변경 사항**:
- `getResolvedContentId` 함수 추가: `master_content_id` 우선 사용
- `bookContents`, `lectureContents`에 `resolvedContentId` 추가
- 모든 콘텐츠 조회 시 `resolvedContentId` 사용
- 마스터 콘텐츠 복사 후 원본 `content_id`를 키로 매핑

#### 2. `resolveContentIds` (contentResolver.ts)

```typescript
// plan_contents의 content_id 해석: master_content_id가 있으면 우선 사용
const getResolvedContentId = (content: PlanContent): string => {
  return content.master_content_id || content.content_id;
};

// 콘텐츠를 타입별로 분류할 때 resolvedContentId 사용
const bookContents = contents
  .filter((c) => c.content_type === "book")
  .map((c) => ({
    ...c,
    resolvedContentId: getResolvedContentId(c),
  }));
```

**변경 사항**:
- `getResolvedContentId` 함수 추가
- 마스터 콘텐츠 확인 시 `resolvedContentId` 사용
- 학생 콘텐츠 조회 시 `resolvedContentId` 사용

---

## 효과

### 해결된 문제

1. ✅ 학생이 마스터 콘텐츠 ID를 저장해도 플랜 생성 시 정상 동작
2. ✅ 관리자와 학생의 플랜 생성 로직 차이로 인한 오류 해결
3. ✅ `plan_contents.master_content_id` 필드 활용으로 일관성 확보

### 장점

1. **최소한의 변경**: 기존 로직을 크게 변경하지 않고 해결
2. **일관성**: `master_content_id` 필드를 활용하여 데이터 일관성 확보
3. **호환성**: 기존 데이터와도 호환 (master_content_id가 없으면 content_id 사용)

---

## 테스트 시나리오

### 시나리오 1: 학생이 먼저 플랜 그룹 생성

1. 학생이 Step 3에서 제출
   - `plan_contents.content_id`에 마스터 콘텐츠 ID 저장
   - `plan_contents.master_content_id`에도 같은 값 저장
2. 관리자가 Step 4-6 진행
   - `savePlanContents`가 학생 콘텐츠 ID로 변환
3. 관리자가 Step 7에서 플랜 생성
   - ✅ `master_content_id` 우선 사용으로 정상 동작

### 시나리오 2: 관리자가 먼저 진행

1. 학생이 Step 3에서 제출
   - `plan_contents.content_id`에 마스터 콘텐츠 ID 저장
2. 관리자가 Step 4-6 진행
   - 일부 콘텐츠만 변환 (여전히 마스터 콘텐츠 ID 존재)
3. 관리자가 Step 7에서 플랜 생성
   - ✅ `master_content_id` 우선 사용으로 정상 동작

---

## 관련 파일

- `app/(student)/actions/plan-groups/generatePlansRefactored.ts`
- `lib/plan/contentResolver.ts` (resolveContentIds 함수)
- `app/(student)/actions/plan-groups/previewPlansRefactored.ts` (resolveContentIds 사용)

---

## 참고

- `plan_contents` 테이블의 `master_content_id` 필드는 이미 존재하며 조회 시 포함됨
- 학생이 플랜 그룹 생성 시 `master_content_id`도 함께 저장됨
- 이 수정으로 학생과 관리자의 플랜 생성 로직 차이 문제 해결


