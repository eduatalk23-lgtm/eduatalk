# Chapter 정보 처리 완료

**작성일**: 2025-01-22  
**목적**: 캠프 모드 및 일반 모드에서 플랜 생성 시 `chapter` 정보가 올바르게 설정되도록 모든 경로에서 `loadContentChapters` 함수를 활용하도록 개선

---

## 작업 개요

플랜 생성 시 `PlanContent`의 `start_detail_id`와 `end_detail_id`를 활용하여 chapter 정보를 조회하고, 모든 플랜 생성 경로에서 chapter 정보가 포함되도록 수정했습니다.

---

## 수정 내용

### 1. previewPlansRefactored.ts에 loadContentChapters 추가

**파일**: `app/(student)/actions/plan-groups/previewPlansRefactored.ts`

**변경 사항**:
- `loadContentChapters` import 추가 (line 22)
- `loadContentChapters` 호출 추가 (line 222-228)
- `generatePlansFromGroup` 호출 시 `contentChapterMap` 전달 (line 262)

**수정 전**:
```typescript
import {
  resolveContentIds,
  loadContentDurations,
  loadContentMetadata,
} from "@/lib/plan/contentResolver";

// loadContentChapters 호출 없음

const scheduledPlans = await generatePlansFromGroup(
  group,
  contents,
  safeExclusions,
  safeAcademySchedules,
  [],
  undefined,
  undefined,
  dateAvailableTimeRanges,
  dateTimeSlots,
  contentDurationMap
  // contentChapterMap 전달 없음
);
```

**수정 후**:
```typescript
import {
  resolveContentIds,
  loadContentDurations,
  loadContentMetadata,
  loadContentChapters, // 추가
} from "@/lib/plan/contentResolver";

// 7.5. 콘텐츠 chapter 정보 조회 (start_detail_id/end_detail_id 사용)
const contentChapterMap = await loadContentChapters(
  contents,
  contentIdMap,
  studentId,
  queryClient
);

const scheduledPlans = await generatePlansFromGroup(
  group,
  contents,
  safeExclusions,
  safeAcademySchedules,
  [],
  undefined,
  undefined,
  dateAvailableTimeRanges,
  dateTimeSlots,
  contentDurationMap,
  contentChapterMap // chapter 정보 전달
);
```

### 2. SchedulerEngine 클래스에서 chapter 정보 전달 수정

**파일**: `lib/scheduler/SchedulerEngine.ts`

**변경 사항**:
- 학습일 플랜 생성 (available_time_ranges 사용)에 chapter 정보 추가 (line 1226)
- 복습일 플랜 생성에 chapter 정보 추가 (line 1379)

**수정 전**:
```typescript
// 학습일 플랜 생성 (available_time_ranges 사용)
plans.push({
  plan_date: date,
  block_index: blockIndex,
  content_type: planInfo.content.content_type,
  content_id: planInfo.content.content_id,
  planned_start_page_or_time: planInfo.start,
  planned_end_page_or_time: planInfo.end - 1,
  // chapter 정보 누락
  is_reschedulable: true,
  start_time: planStartTime,
  end_time: planEndTime,
});

// 복습일 플랜 생성
plans.push({
  plan_date: reviewDay,
  block_index: blockIndex,
  content_type: content.content_type,
  content_id: content.content_id,
  planned_start_page_or_time: range.startAmount,
  planned_end_page_or_time: range.endAmount - 1,
  // chapter 정보 누락
  is_reschedulable: true,
  start_time: timeRange.start,
  end_time: timeRange.end,
});
```

**수정 후**:
```typescript
// 학습일 플랜 생성 (available_time_ranges 사용)
plans.push({
  plan_date: date,
  block_index: blockIndex,
  content_type: planInfo.content.content_type,
  content_id: planInfo.content.content_id,
  planned_start_page_or_time: planInfo.start,
  planned_end_page_or_time: planInfo.end - 1,
  chapter: planInfo.content.chapter || null, // ContentInfo의 chapter 정보 사용
  is_reschedulable: true,
  start_time: planStartTime,
  end_time: planEndTime,
});

// 복습일 플랜 생성
plans.push({
  plan_date: reviewDay,
  block_index: blockIndex,
  content_type: content.content_type,
  content_id: content.content_id,
  planned_start_page_or_time: range.startAmount,
  planned_end_page_or_time: range.endAmount - 1,
  chapter: content.chapter || null, // ContentInfo의 chapter 정보 사용
  is_reschedulable: true,
  start_time: timeRange.start,
  end_time: timeRange.end,
});
```

---

## 확인된 사항

### 이미 구현되어 있던 부분

1. **loadContentChapters 함수**: `lib/plan/contentResolver.ts`에 이미 구현되어 있음 (line 766-886)
2. **ContentInfo 타입**: `lib/plan/scheduler.ts`에 `chapter` 필드 존재 (line 40)
3. **generatePlansFromGroup**: `contentChapterMap` 파라미터를 받도록 이미 구현됨 (line 96)
4. **generatePlansRefactored.ts**: `loadContentChapters` 호출 및 전달 완료 (line 542-547, 615)
5. **학습일 플랜 생성 (time_slots 사용)**: chapter 정보 포함됨 (SchedulerEngine.ts line 1138)
6. **추가 기간 재배치 플랜**: chapter 정보 포함됨 (scheduler.ts line 482, 535)

### 수정한 부분

1. **previewPlansRefactored.ts**: `loadContentChapters` 호출 및 전달 추가
2. **SchedulerEngine 학습일 플랜 (available_time_ranges)**: chapter 정보 추가
3. **SchedulerEngine 복습일 플랜**: chapter 정보 추가

---

## Chapter 정보 조회 로직

### loadContentChapters 함수 동작 방식

1. **Book 콘텐츠**:
   - `student_book_details` 테이블에서 `start_detail_id`와 `end_detail_id`로 조회
   - `major_unit` 또는 `minor_unit` 사용
   - 단일 범위: `major_unit` 또는 `minor_unit` 반환
   - 범위: `${startChapter} ~ ${endChapter}` 형식 반환

2. **Lecture 콘텐츠**:
   - `student_lecture_episodes` 테이블에서 `start_detail_id`와 `end_detail_id`로 조회
   - `episode_title` 사용 (없으면 `episode_number` 사용)
   - 단일 범위: `episode_title` 또는 `${episode_number}강` 반환
   - 범위: `${startChapter} ~ ${endChapter}` 형식 반환

3. **배치 조회 최적화**:
   - 모든 `detail_id`를 한 번에 수집하여 배치 조회
   - N+1 쿼리 문제 방지

---

## 데이터 흐름

```
PlanContent (start_detail_id, end_detail_id)
  ↓
loadContentChapters 함수 호출
  ↓
student_book_details / student_lecture_episodes 조회
  ↓
ContentChapterMap 생성 (content_id -> chapter 문자열)
  ↓
generatePlansFromGroup 호출 시 contentChapterMap 전달
  ↓
ContentInfo 생성 시 chapter 정보 설정
  ↓
ScheduledPlan 생성 시 chapter 정보 포함
  ↓
student_plan 테이블에 chapter 정보 저장
```

---

## 수정된 파일

1. **app/(student)/actions/plan-groups/previewPlansRefactored.ts**
   - `loadContentChapters` import 추가
   - `loadContentChapters` 호출 추가
   - `generatePlansFromGroup` 호출 시 `contentChapterMap` 전달

2. **lib/scheduler/SchedulerEngine.ts**
   - 학습일 플랜 생성 (available_time_ranges 사용)에 chapter 정보 추가
   - 복습일 플랜 생성에 chapter 정보 추가

---

## 검증 방법

### 1. 단위 테스트

- `loadContentChapters` 함수가 올바른 chapter 정보를 반환하는지 확인
- Book의 `major_unit`/`minor_unit` 조회 확인
- Lecture의 `episode_title`/`episode_number` 조회 확인
- 범위인 경우 `${startChapter} ~ ${endChapter}` 형식 확인

### 2. 통합 테스트

- 플랜 생성 시 `chapter` 정보가 `student_plan` 테이블에 저장되는지 확인
- 플랜 미리보기에서 `chapter` 정보가 표시되는지 확인
- 캠프 모드와 일반 모드 모두에서 동작 확인

### 3. 데이터베이스 확인

- `plan_contents` 테이블의 `start_detail_id`와 `end_detail_id` 확인
- `student_book_details` 테이블의 `major_unit`/`minor_unit` 확인
- `student_lecture_episodes` 테이블의 `episode_title`/`episode_number` 확인

---

## 영향 범위

### 수정 파일

1. `app/(student)/actions/plan-groups/previewPlansRefactored.ts` - loadContentChapters 추가
2. `lib/scheduler/SchedulerEngine.ts` - chapter 정보 전달 수정

### 영향받는 기능

1. **플랜 미리보기**: chapter 정보 표시
2. **플랜 생성**: chapter 정보 저장
3. **캠프 모드 플랜 생성**: chapter 정보 포함
4. **일반 모드 플랜 생성**: chapter 정보 포함
5. **복습일 플랜**: chapter 정보 포함
6. **추가 기간 재배치 플랜**: chapter 정보 포함

---

## 주의사항

1. **하위 호환성**: `chapter` 필드는 nullable이므로 기존 데이터와 호환됨
2. **성능**: `loadContentChapters`는 이미 배치 조회로 최적화되어 있음
3. **에러 처리**: `start_detail_id`/`end_detail_id`가 없는 경우 `chapter`는 `null`로 설정됨
4. **데이터 일관성**: `plan_contents` 테이블에 `start_detail_id`와 `end_detail_id`가 있어야 chapter 정보가 조회됨

---

## 참고 문서

- `docs/20250122_캠프-플랜-생성-콘텐츠-유형-상세정보-활용-개선.md` - 개선 계획 문서
- `lib/plan/contentResolver.ts` - loadContentChapters 구현
- `lib/plan/scheduler.ts` - generatePlansFromGroup 구현

---

**작성자**: AI Assistant  
**검토 필요**: 사용자 확인 필요

