# 학생 정보 편집 폼 통합 및 최적화

## 작업 일자
2025-01-15

## 작업 개요
관리자용 학생 정보 편집 폼을 통합하고 최적화하여, 3개 테이블(students, student_profiles, student_career_goals)의 정보를 한 번에 편집할 수 있도록 개선했습니다.

## 구현 내용

### 1. 타입 정의
- **파일**: `app/(admin)/admin/students/[id]/_types/studentFormTypes.ts`
- `AdminStudentFormData`: 관리자용 확장 폼 데이터 타입
- `StudentInfoData`: 학생 정보 조회용 통합 데이터 타입

### 2. 데이터 변환 유틸리티
- **파일**: `app/(admin)/admin/students/[id]/_utils/studentFormTransform.ts`
- `transformStudentToFormData`: StudentInfoData → AdminStudentFormData 변환
- `transformFormDataToUpdatePayload`: 변경된 필드만 포함하는 업데이트 페이로드 생성

### 3. React Hook Form 통합 훅
- **파일**: `app/(admin)/admin/students/[id]/_hooks/useStudentInfoForm.ts`
- React Hook Form을 사용한 폼 상태 관리
- 변경사항 추적 (`isDirty`, `dirtyFields`)
- 실시간 유효성 검증

### 4. 통합 서버 액션
- **파일**: `app/(admin)/actions/studentManagementActions.ts`
- `updateStudentInfo`: 3개 테이블을 한 번에 업데이트하는 통합 액션
- 관리자 권한 검증
- 이름 업데이트 시 `user_metadata.display_name` 동기화
- 전화번호 검증 및 정규화

### 5. UI 컴포넌트

#### 메인 컴포넌트
- **파일**: `app/(admin)/admin/students/[id]/_components/StudentInfoEditForm.tsx`
- 2단 그리드 레이아웃 (데스크톱: 60% / 40%, 모바일: 1단)
- Sticky 저장 버튼
- 변경사항 추적 및 저장

#### 섹션별 컴포넌트
- **BasicInfoSection**: 기본 정보 (이름, 학교, 학년, 생년월일, 반, 구분, 메모, 계정 상태)
- **ProfileInfoSection**: 프로필 정보 (성별, 연락처, 주소, 비상연락처, 의료정보)
- **CareerInfoSection**: 진로 정보 (수능연도, 교육과정, 희망대학, 진로계열)

### 6. 학생 상세보기 페이지 통합
- **파일**: `app/(admin)/admin/students/[id]/page.tsx`
- 3개 테이블 데이터 통합 조회
- `StudentInfoEditForm` 컴포넌트 적용

## 주요 기능

### 필수 필드
- 이름 (required)
- 본인 연락처 (required)

### 관리자 전용 필드
- 구분 (division)
- 메모 (memo)
- 계정 상태 (status, is_active)
- 반 (class)

### 프로필 확장 필드
- 주소 (address)
- 비상연락처 (emergency_contact, emergency_contact_phone)
- 의료정보 (medical_info)

## 최적화 사항

### 1. React Hook Form 활용
- `formState.isDirty`로 변경사항 추적
- `dirtyFields`로 변경된 필드만 업데이트
- `mode: 'onChange'`로 실시간 유효성 검증
- `shouldUnregister: false`로 필드 상태 유지

### 2. 성능 최적화
- `useMemo`로 초기 데이터 변환 캐싱
- `useCallback`으로 핸들러 함수 메모이제이션
- 조건부 렌더링으로 불필요한 리렌더링 방지

### 3. 웹 환경 최적화
- 2단 그리드 레이아웃 (데스크톱 우선)
- 반응형 디자인 (모바일: 1단, 태블릿: 1단, 데스크톱: 2단)
- Sticky 저장 버튼으로 스크롤 시에도 접근 가능
- 필드 그룹화로 관련 정보 시각적 구분

## 파일 구조

```
app/(admin)/admin/students/[id]/
├── _components/
│   ├── StudentInfoEditForm.tsx (신규)
│   ├── sections/
│   │   ├── BasicInfoSection.tsx (신규)
│   │   ├── ProfileInfoSection.tsx (신규)
│   │   └── CareerInfoSection.tsx (신규)
│   └── BasicInfoSection.tsx (기존 유지 - 추후 제거 예정)
├── _hooks/
│   └── useStudentInfoForm.ts (신규)
├── _types/
│   └── studentFormTypes.ts (신규)
├── _utils/
│   └── studentFormTransform.ts (신규)
└── page.tsx (수정: 통합 폼 적용)

app/(admin)/actions/
└── studentManagementActions.ts (수정: 통합 업데이트 액션 추가)
```

## 향후 개선 사항

### 1. 중복 코드 제거
- [ ] 기존 `BasicInfoSection` 인라인 편집 로직 제거
- [ ] 학생 설정 페이지와 코드 공유 고려

### 2. 데이터 일관성 검증
- [ ] `student_divisions` 테이블과 `students.division` 일관성 검증
- [ ] 학교 정보 검증 (school_id, school_type)

### 3. 성능 최적화
- [ ] 추가적인 `useMemo`, `useCallback` 적용
- [ ] 조건부 렌더링 최적화

## 참고 사항

- React Hook Form의 `FormState` 타입 활용
- 기존 `useSettingsForm` 패턴 재사용
- 학생 설정 페이지와 코드 공유 고려
- 필수 필드: 이름, 본인 연락처만
- 웹 환경 최적화 (데스크톱 우선, 반응형)




