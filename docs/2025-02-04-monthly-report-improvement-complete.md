# lib/reports/monthly.ts ê°œì„  ì™„ë£Œ

**ì‘ì„±ì¼**: 2025-02-04  
**ì‘ì—… ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ ì‘ì—… ê°œìš”

`getMonthlyWeakSubjectTrend` í•¨ìˆ˜ë¥¼ ê°œì„ í•˜ì—¬ ë ˆê±°ì‹œ `student_scores` í…Œì´ë¸” ì°¸ì¡°ë¥¼ ì œê±°í•˜ê³ , ìƒˆ êµ¬ì¡°(`student_internal_scores`, `student_mock_scores`)ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. tenantId ì¡°íšŒ ë¡œì§ ì¶”ê°€
- í•™ìƒ ì •ë³´ì—ì„œ `tenant_id` ì¡°íšŒ
- `getInternalScores`ì™€ `getMockScores` í˜¸ì¶œ ì‹œ í•„ìˆ˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬

### 2. student_internal_scoresì™€ student_mock_scores ì¡°í•©
- ë‚´ì‹  ì„±ì : `rank_grade` ì‚¬ìš© (1-9 ë“±ê¸‰)
- ëª¨ì˜ê³ ì‚¬ ì„±ì : `grade_score` ì‚¬ìš© (1-9 ë“±ê¸‰)
- `subject_group_id` ê¸°ì¤€ìœ¼ë¡œ ê³¼ëª©ë³„ ë“±ê¸‰ ì§‘ê³„

### 3. ì›”ê°„ ì„±ì  ë³€í™” ê³„ì‚° ë¡œì§ êµ¬í˜„
- ì´ë²ˆ ë‹¬ê³¼ ì§€ë‚œ ë‹¬ì˜ ë“±ê¸‰ ë¹„êµ
- í‰ê·  ë“±ê¸‰ ê³„ì‚° (ì—¬ëŸ¬ ì„±ì ì´ ìˆëŠ” ê²½ìš°)
- ë“±ê¸‰ ë³€í™” ê³„ì‚° (ìŒìˆ˜: ê°œì„ , ì–‘ìˆ˜: ì•…í™”)

### 4. ê³¼ëª©ëª… ì¡°íšŒ ë¡œì§ ì¶”ê°€
- `subject_group_id`ë¥¼ í†µí•´ ê³¼ëª©ëª… ì¡°íšŒ
- ì„±ëŠ¥ ìµœì í™”: í•œ ë²ˆì— ì¡°íšŒ (N+1 ì¿¼ë¦¬ ë¬¸ì œ í•´ê²°)

### 5. ì„±ëŠ¥ ìµœì í™”
- ì¤‘ë³µ ì„±ì  ì¡°íšŒ ì œê±° (í•œ ë²ˆë§Œ ì¡°íšŒ í›„ í•„í„°ë§)
- `subject_groups` í•œ ë²ˆì— ì¡°íšŒ

---

## ğŸ”„ ë³€ê²½ ì‚¬í•­

### ì´ì „ êµ¬ì¡° (ë ˆê±°ì‹œ)

```typescript
// âš ï¸ DEPRECATED: student_scores í…Œì´ë¸” ì°¸ì¡°
// TODO: student_internal_scoresì™€ student_mock_scores ì¡°í•© í•„ìš”
const subjectGrades = new Map<string, { thisMonth: number | null; lastMonth: number | null }>();
```

### ìƒˆ êµ¬ì¡°

```typescript
// tenantId ì¡°íšŒ
const { data: student } = await supabase
  .from("students")
  .select("tenant_id")
  .eq("id", studentId)
  .maybeSingle();

// ìƒˆ êµ¬ì¡°ë¡œ ì„±ì  ì¡°íšŒ
const [allInternal, allMock] = await Promise.all([
  getInternalScores(studentId, tenantId),
  getMockScores(studentId, tenantId),
]);

// ë‚ ì§œ í•„í„°ë§ ë° ë“±ê¸‰ ê³„ì‚°
// ê³¼ëª©ë³„ í‰ê·  ë“±ê¸‰ ê³„ì‚°
// ì›”ê°„ ì„±ì  ë³€í™” ê³„ì‚°
```

---

## ğŸ“Š ì£¼ìš” ê°œì„ ì‚¬í•­

### 1. ë°ì´í„° ì •í™•ì„± í–¥ìƒ
- ì‹¤ì œ ì„±ì  ë°ì´í„° ê¸°ë°˜ ê³„ì‚°
- ë‚´ì‹ ê³¼ ëª¨ì˜ê³ ì‚¬ ì„±ì  ëª¨ë‘ ê³ ë ¤

### 2. ì„±ëŠ¥ ê°œì„ 
- ì¤‘ë³µ ì¡°íšŒ ì œê±°
- N+1 ì¿¼ë¦¬ ë¬¸ì œ í•´ê²°
- íš¨ìœ¨ì ì¸ ë°ì´í„° í•„í„°ë§

### 3. ì½”ë“œ í’ˆì§ˆ
- ë ˆê±°ì‹œ ì½”ë“œ ì œê±°
- ëª…í™•í•œ ë¡œì§ êµ¬ì¡°
- íƒ€ì… ì•ˆì „ì„± ë³´ì¥

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

- `lib/reports/monthly.ts` - `getMonthlyWeakSubjectTrend` í•¨ìˆ˜ ê°œì„ 

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### ì™„ë£Œëœ ì‘ì—…
- âœ… tenantId ì¡°íšŒ ë¡œì§ ì¶”ê°€
- âœ… student_internal_scoresì™€ student_mock_scores ì¡°í•©
- âœ… ì›”ê°„ ì„±ì  ë³€í™” ê³„ì‚° ë¡œì§ êµ¬í˜„
- âœ… ê³¼ëª©ëª… ì¡°íšŒ ë¡œì§ ì¶”ê°€
- âœ… ì„±ëŠ¥ ìµœì í™”

### ë‚¨ì€ ì‘ì—…
- [ ] í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (ì‹¤ì œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ í•„ìš”)

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [Phase 4 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ](./2025-02-04-phase4-migration-complete.md)
- [ë‹¤ìŒ ì‘ì—… ìš”ì•½](./2025-02-04-next-work-summary.md)

---

**ì‘ì„±ì**: AI Assistant  
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-02-04

