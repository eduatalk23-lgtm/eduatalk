# 학생 연락처 조회 통합 개선

**작성 일자**: 2025-02-01  
**목적**: 학생 목록의 연락처 조회 기능 개선 및 중복 코드 제거

---

## 개요

학생 목록에서 학생, 부, 모 연락처를 조회하는 기능을 통합하고 개선했습니다. 기존에는 여러 곳에서 중복된 코드로 연락처를 조회했으나, 이제는 통합된 함수를 사용하여 일관성 있게 처리합니다.

---

## 주요 변경 사항

### 1. `getStudentPhonesBatch` 함수 개선

**파일**: `lib/utils/studentPhoneUtils.ts`

#### 변경 내용

1. **학부모 계정 연락처 조회 추가**
   - `parent_student_links` 테이블을 통해 연결된 학부모 계정의 연락처를 조회
   - `auth.users` 테이블의 `phone` 필드를 Admin 클라이언트를 통해 조회

2. **우선순위 로직 구현**
   - **모 연락처**: `parent_student_links (relation='mother') → auth.users.phone` (null이 아닐 때만) > `student_profiles.mother_phone`
   - **부 연락처**: `parent_student_links (relation='father') → auth.users.phone` (null이 아닐 때만) > `student_profiles.father_phone`
   - **학생 연락처**: `student_profiles.phone` (변경 없음)

3. **에러 처리 개선**
   - try-catch로 에러를 무시하던 패턴 제거
   - 명시적 에러 로깅 추가 (`console.error`)
   - 부분 실패 시에도 나머지 데이터는 반환

4. **타입 정의 확장**
   - `mother_phone_source`: 'linked_account' | 'student_profile' | null
   - `father_phone_source`: 'linked_account' | 'student_profile' | null
   - 디버깅 및 로깅을 위한 메타데이터 추가

#### 코드 구조

```typescript
// 1. students 기본 정보 조회
// 2. student_profiles 조회 (fallback 데이터)
// 3. parent_student_links 조회
// 4. auth.users에서 phone 조회 (Admin 클라이언트 사용)
// 5. 결과 병합 (우선순위 로직 적용)
```

---

### 2. 중복 코드 제거

#### 2.1 SMS 페이지 리팩토링

**파일**: `app/(admin)/admin/sms/page.tsx`

**변경 내용**:
- 198-232줄의 중복된 연락처 조회 로직 제거
- `getStudentPhonesBatch` 함수 사용으로 통일

**Before**:
```typescript
// student_profiles 테이블에서 phone 정보 조회
const { data: profilesData } = await supabase
  .from("student_profiles")
  .select("id, phone, mother_phone, father_phone")
  .in("id", studentIdList);

// 프로필 정보를 학생 정보와 병합
const studentsWithPhones = students.map((s) => {
  const profile = profiles.find((p) => p.id === s.id);
  return {
    ...s,
    phone: profile?.phone ?? null,
    mother_phone: profile?.mother_phone ?? s.mother_phone ?? null,
    father_phone: profile?.father_phone ?? s.father_phone ?? null,
  };
});
```

**After**:
```typescript
// 배치 쿼리로 연락처 정보 일괄 조회
const phoneDataList = await getStudentPhonesBatch(studentIdList);
const phoneDataMap = new Map(phoneDataList.map((p) => [p.id, p]));

// 프로필 정보를 학생 정보와 병합
const studentsWithPhones = students.map((s) => {
  const phoneData = phoneDataMap.get(s.id);
  return {
    ...s,
    phone: phoneData?.phone ?? null,
    mother_phone: phoneData?.mother_phone ?? null,
    father_phone: phoneData?.father_phone ?? null,
  };
});
```

#### 2.2 출석 액션 리팩토링

**파일**: `app/(admin)/actions/attendanceActions.ts`

**변경 내용**:
- 66-79줄의 중복된 프로필 조회 로직 제거
- `getStudentPhones` 함수 활용

**Before**:
```typescript
// student_profiles 테이블에서 phone 정보 조회
let profile: { phone?: string | null; mother_phone?: string | null; father_phone?: string | null } | null = null;
try {
  const { data: profileData } = await supabase
    .from("student_profiles")
    .select("phone, mother_phone, father_phone")
    .eq("id", input.student_id)
    .maybeSingle();
  if (profileData) {
    profile = profileData;
  }
} catch (e) {
  // student_profiles 테이블이 없으면 무시
}

// 학부모 연락처 확인
const hasParentContact = 
  profile?.mother_phone || 
  profile?.father_phone || 
  student?.mother_phone || 
  student?.father_phone;
```

**After**:
```typescript
// getStudentPhones 함수를 사용하여 연락처 정보 조회
const phoneData = await getStudentPhones(input.student_id);

// 학부모 연락처 확인
const hasParentContact = 
  phoneData?.mother_phone || 
  phoneData?.father_phone;
```

#### 2.3 SMS API 라우트 리팩토링

**파일**: `app/api/purio/send/route.ts`

**변경 내용**:
- 136-168줄의 중복된 연락처 조회 로직 제거
- `getStudentPhonesBatch` 사용으로 통일

---

### 3. 데이터베이스 인덱스 최적화

**마이그레이션**: `add_parent_student_links_relation_index`

**변경 내용**:
- `parent_student_links` 테이블에 `(student_id, relation)` 복합 인덱스 추가
- 학생 ID로 필터링하고 관계(relation)로 그룹핑하는 쿼리 성능 향상

**인덱스 확인 결과**:
- ✅ `parent_student_links.student_id` 인덱스 존재 (`idx_parent_student_links_student_id`)
- ✅ `parent_student_links.parent_id` 인덱스 존재 (`idx_parent_student_links_parent_id`)
- ✅ `student_profiles.id` 인덱스 존재 (PK)
- ✅ `(student_id, relation)` 복합 인덱스 추가 완료

---

## 데이터 흐름

### 연락처 조회 우선순위

1. **학생 연락처** (`phone`)
   - `student_profiles.phone` (단일 소스)

2. **모 연락처** (`mother_phone`)
   - 1순위: `parent_student_links (relation='mother') → auth.users.phone` (null이 아닐 때만)
   - 2순위: `student_profiles.mother_phone`

3. **부 연락처** (`father_phone`)
   - 1순위: `parent_student_links (relation='father') → auth.users.phone` (null이 아닐 때만)
   - 2순위: `student_profiles.father_phone`

### 처리 로직

```
학생 목록 조회
  ↓
getStudentPhonesBatch 호출
  ↓
1. students 기본 정보 조회
2. student_profiles 조회 (fallback)
3. parent_student_links 조회
4. auth.users에서 phone 조회 (Admin 클라이언트)
5. 결과 병합 (우선순위 로직)
  ↓
통합된 연락처 정보 반환
```

---

## 성능 고려사항

1. **배치 쿼리 최적화**: 여러 학생의 연락처를 한 번에 조회
2. **인덱스 활용**: `parent_student_links` 테이블의 인덱스 활용
3. **Admin 클라이언트 사용**: `auth.users` 조회 시 Service Role Key 필요 (선택사항)
4. **Fallback 처리**: Admin 클라이언트가 없어도 `student_profiles` 정보로 보완 가능

---

## 호환성

### 기존 데이터와의 호환성

- ✅ 기존 `student_profiles` 데이터는 그대로 사용 가능
- ✅ 학부모 계정이 연결되지 않은 경우 `student_profiles` 데이터 사용
- ✅ 학부모 계정의 `phone`이 null인 경우 `student_profiles` 데이터 사용

### 마이그레이션 고려사항

- 기존 코드와의 호환성 유지
- 점진적 롤아웃 가능
- 에러 발생 시에도 부분 데이터 반환

---

## 테스트 시나리오

### 1. 학부모 계정이 연결된 경우
- 학부모 계정의 `phone`이 있으면 우선 사용
- 학부모 계정의 `phone`이 null이면 `student_profiles` 사용

### 2. 학부모 계정이 연결되지 않은 경우
- `student_profiles` 데이터 사용

### 3. student_profiles만 있는 경우
- `student_profiles` 데이터 사용

### 4. Admin 클라이언트가 없는 경우
- `student_profiles` 데이터만 사용 (기능은 정상 동작)

---

## 관련 파일

### 수정된 파일

1. `lib/utils/studentPhoneUtils.ts` - 핵심 함수 개선
2. `app/(admin)/admin/sms/page.tsx` - 중복 코드 제거
3. `app/(admin)/actions/attendanceActions.ts` - 중복 코드 제거
4. `app/api/purio/send/route.ts` - 중복 코드 제거

### 마이그레이션 파일

1. `supabase/migrations/YYYYMMDDHHMMSS_add_parent_student_links_relation_index.sql` - 인덱스 추가

---

## 향후 개선 사항

1. **단일 학생 조회 함수 개선**: `getStudentPhones` 함수도 동일한 로직 적용
2. **캐싱 추가**: 자주 조회되는 연락처 정보 캐싱 고려
3. **모니터링**: 연락처 조회 성능 모니터링 추가

---

## 참고 자료

- [Supabase PostgREST Nested Select](https://supabase.com/docs/guides/api/joins-and-nesting)
- [Supabase Auth Admin API](https://supabase.com/docs/reference/javascript/auth-admin-listusers)

