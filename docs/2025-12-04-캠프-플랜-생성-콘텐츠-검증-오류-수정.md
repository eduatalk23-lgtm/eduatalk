# 캠프 플랜 생성 콘텐츠 검증 오류 수정

## 작업 일시
2025-12-04

## 문제 상황

관리자가 캠프 플랜 그룹의 남은 단계를 진행할 때, 학생이 추가 등록한 콘텐츠가 있는 상황임에도 다음과 같은 에러가 발생했습니다:

```
플랜 생성 전 검증 실패:
플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요.
```

## 원인 분석

### 검증 로직의 문제

`continueCampStepsForAdmin` 함수의 Step 6 검증 로직에서 다음과 같은 문제가 있었습니다:

1. **wizardData의 콘텐츠를 확인하지 않음**: 검증 로직이 `plan_contents` 테이블에만 의존하고 있었습니다.
2. **콘텐츠 저장 타이밍 문제**: `wizardData`에 콘텐츠가 있지만 아직 `plan_contents` 테이블에 저장되지 않은 경우, 검증이 실패했습니다.
3. **콘텐츠 필터링 문제**: 콘텐츠 저장 과정에서 모든 콘텐츠가 필터링되어 `validContents.length === 0`이 되었을 수 있습니다.

### 기존 검증 로직

```typescript
// 최종적으로 plan_contents 테이블에 콘텐츠가 있는지 확인
const { data: finalPlanContents } = await supabase
  .from("plan_contents")
  .select("id")
  .eq("plan_group_id", groupId)
  .limit(1);

if (!finalPlanContents || finalPlanContents.length === 0) {
  // DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우
  validationErrors.push(
    "플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요."
  );
}
```

문제점:
- 주석에는 "DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우"라고 되어 있지만, 실제로는 `wizardData`의 콘텐츠를 확인하지 않았습니다.
- `wizardData`에 콘텐츠가 있어도 `plan_contents` 테이블에 저장되지 않았으면 에러가 발생했습니다.

## 해결 방법

### 1. 검증 로직 개선

`wizardData`의 콘텐츠도 함께 확인하도록 수정했습니다:

```typescript
// 검증: DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우에만 에러
const hasPlanContents = finalPlanContents && finalPlanContents.length > 0;
const hasWizardContents = finalTotalContents > 0;

if (!hasPlanContents && !hasWizardContents) {
  // DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우
  validationErrors.push(
    "플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요."
  );
} else if (!hasPlanContents && hasWizardContents) {
  // wizardData에 콘텐츠가 있지만 DB에 저장되지 않은 경우
  // (콘텐츠 저장 과정에서 모든 콘텐츠가 필터링되었을 수 있음)
  console.warn(
    "[campTemplateActions] Step 6 검증: wizardData에 콘텐츠가 있지만 DB에 저장되지 않음. 콘텐츠 저장 과정을 확인하세요.",
    {
      wizardDataStudentContents: finalStudentContents.length,
      wizardDataRecommendedContents: finalRecommendedContents.length,
      wizardDataTotalContents: finalTotalContents,
    }
  );
  // 이 경우에도 플랜 생성은 가능하도록 허용 (플랜 생성 시 콘텐츠가 자동으로 처리될 수 있음)
  // 단, 경고 로그만 남기고 검증 에러는 발생시키지 않음
} else {
  console.log("[campTemplateActions] Step 6 최종 검증: 콘텐츠가 있어 플랜 생성 가능:", {
    hasPlanContents,
    hasWizardContents,
    finalPlanContentsCount: finalPlanContents?.length || 0,
    wizardDataTotalContents: finalTotalContents,
  });
}
```

### 2. 콘텐츠 저장 실패 시 로깅 개선

콘텐츠 저장 과정에서 모든 콘텐츠가 필터링된 경우를 더 명확하게 로깅하도록 개선했습니다:

```typescript
} else {
  // 콘텐츠 저장 실패: 모든 콘텐츠가 필터링됨
  console.error(
    `[campTemplateActions] 학생(${result.group.student_id})이 가지고 있는 유효한 콘텐츠가 없습니다.`,
    {
      creationDataContentsCount: creationDataForContents.contents.length,
      validContentsCount: validContents.length,
      wizardDataStudentContents: studentContents.length,
      wizardDataRecommendedContents: recommendedContents.length,
      reason: "콘텐츠 저장 과정에서 모든 콘텐츠가 필터링되었습니다. 학생이 해당 콘텐츠를 가지고 있지 않거나, 콘텐츠 ID가 유효하지 않을 수 있습니다.",
    }
  );
  // 이 경우에도 플랜 생성은 가능하도록 허용 (플랜 생성 시 콘텐츠가 자동으로 처리될 수 있음)
  // 단, 경고 로그만 남기고 검증 에러는 발생시키지 않음
}
```

## 결과

- `wizardData`에 콘텐츠가 있으면 플랜 생성이 가능하도록 수정
- 콘텐츠 저장 실패 시에도 플랜 생성이 가능하도록 허용 (플랜 생성 시 콘텐츠가 자동으로 처리될 수 있음)
- 더 명확한 로깅으로 디버깅 용이성 향상

## 참고 사항

- 플랜 생성 시 콘텐츠가 자동으로 처리될 수 있으므로, `wizardData`에 콘텐츠가 있으면 검증을 통과하도록 했습니다.
- 콘텐츠 저장 과정에서 모든 콘텐츠가 필터링된 경우, 플랜 생성 시 콘텐츠가 자동으로 복사되거나 처리될 수 있습니다.
- 향후 콘텐츠 저장 과정을 더 개선하여 모든 콘텐츠가 저장되도록 할 수 있습니다.

