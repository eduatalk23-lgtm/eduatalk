# 범위 설정 모달 API 에러 로깅 개선

## 📋 작업 개요

`RangeSettingModal` 컴포넌트에서 API 호출 실패 시 빈 객체 `{}`가 출력되는 문제를 해결하고, 에러 로깅을 개선했습니다.

## 🐛 문제 상황

### 에러 메시지

1. **첫 번째 에러**: `[RangeSettingModal] API 호출 실패: /api/student-content-details {}`
   - 위치: `RangeSettingModal.tsx:159`
   - 문제: `responseData`가 빈 객체로 출력됨

2. **두 번째 에러**: `[RangeSettingModal] 상세 정보 조회 실패: {}`
   - 위치: `RangeSettingModal.tsx:269`
   - 문제: `errorDetails`가 빈 객체로 출력됨

### 원인 분석

1. **응답 파싱 실패**: API가 에러를 반환할 때 응답 본문이 비어있거나 JSON이 아닐 수 있음
2. **에러 객체 직렬화 실패**: 에러 로깅 시 객체가 제대로 직렬화되지 않음
3. **에러 정보 손실**: 빈 객체로 출력되어 실제 에러 원인을 파악하기 어려움

## ✅ 해결 방법

### 1. 응답 처리 개선

**변경 전**:
```typescript
let responseData: any;
try {
  responseData = await response.json();
} catch (e) {
  // 에러 처리
}
```

**변경 후**:
```typescript
let responseData: any = null;
let responseText: string | null = null;

try {
  // 응답 본문을 텍스트로 먼저 읽기 (디버깅용)
  responseText = await response.text();
  
  // 빈 응답 체크
  if (!responseText || responseText.trim() === "") {
    throw new Error("응답 본문이 비어있습니다.");
  }
  
  // JSON 파싱 시도
  try {
    responseData = JSON.parse(responseText);
  } catch (parseError) {
    // 파싱 실패 시 상세 로깅
    console.error("[RangeSettingModal] JSON 파싱 실패:", {
      status: response.status,
      statusText: response.statusText,
      url,
      responseText: responseText.substring(0, 200),
      parseError,
    });
    throw new Error("응답을 파싱할 수 없습니다.");
  }
} catch (e) {
  // 에러 처리
}
```

**개선 사항**:
- 응답 본문을 텍스트로 먼저 읽어 디버깅 정보 확보
- 빈 응답 체크 추가
- JSON 파싱 실패 시 상세 로깅 (응답 텍스트 일부 포함)
- 에러 타입별 세분화된 처리

### 2. 에러 로깅 개선

**변경 전**:
```typescript
if (process.env.NODE_ENV === "development") {
  console.error(
    "[RangeSettingModal] 상세 정보 조회 실패:",
    errorDetails
  );
}
```

**변경 후**:
```typescript
if (process.env.NODE_ENV === "development") {
  try {
    // JSON.stringify로 직렬화 가능한지 확인
    const serialized = JSON.stringify(errorDetails, null, 2);
    console.error(
      "[RangeSettingModal] 상세 정보 조회 실패:",
      JSON.parse(serialized)
    );
  } catch (serializeError) {
    // 직렬화 실패 시 개별 속성 출력
    console.error("[RangeSettingModal] 상세 정보 조회 실패:");
    console.error("  type:", errorDetails.type);
    console.error("  contentType:", errorDetails.contentType);
    console.error("  contentId:", errorDetails.contentId);
    console.error("  title:", errorDetails.title);
    console.error("  isRecommendedContent:", errorDetails.isRecommendedContent);
    console.error("  apiPath:", errorDetails.apiPath);
    console.error("  errorMessage:", errorDetails.errorMessage);
    console.error("  errorName:", errorDetails.errorName);
    if (errorDetails.errorStack) {
      console.error("  errorStack:", errorDetails.errorStack);
    }
  }
}
```

**개선 사항**:
- JSON 직렬화 가능 여부 확인
- 직렬화 실패 시 개별 속성으로 출력하여 정보 손실 방지
- 에러 스택 정보 포함

### 3. HTTP 상태 코드 체크 개선

**변경 전**:
```typescript
if (!response.ok) {
  const errorMessage = 
    responseData?.error?.message || 
    responseData?.message ||
    (response.status >= 500
      ? "서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
      : `서버 오류가 발생했습니다. (${response.status})`);
  
  console.error(`[RangeSettingModal] API 호출 실패: ${apiPath}`, {
    status: response.status,
    statusText: response.statusText,
    contentType: content.type,
    contentId: content.id,
    isRecommendedContent,
    url,
    responseData,
  });
  throw new Error(errorMessage);
}
```

**변경 후**:
```typescript
if (!response.ok) {
  const errorMessage = 
    (responseData && typeof responseData === 'object' && responseData.error?.message) ||
    (responseData && typeof responseData === 'object' && responseData.message) ||
    (response.status >= 500
      ? "서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
      : `서버 오류가 발생했습니다. (${response.status})`);
  
  if (process.env.NODE_ENV === "development") {
    console.error(`[RangeSettingModal] API 호출 실패: ${apiPath}`, {
      status: response.status,
      statusText: response.statusText,
      contentType: content.type,
      contentId: content.id,
      isRecommendedContent,
      url,
      responseData: responseData || null,
      responseText: responseText?.substring(0, 500),
    });
  }
  throw new Error(errorMessage);
}
```

**개선 사항**:
- `responseData` 타입 체크 강화
- `responseText`도 로깅에 포함하여 원본 응답 확인 가능
- `responseData`가 null일 경우 명시적으로 처리

## 📁 수정된 파일

- `app/(student)/plan/new-group/_components/_features/content-selection/components/RangeSettingModal.tsx`

## 🎯 기대 효과

1. **디버깅 용이성 향상**: 에러 발생 시 상세한 정보 제공
2. **에러 원인 파악 개선**: 빈 객체 대신 실제 에러 정보 출력
3. **응답 처리 안정성 향상**: 빈 응답, JSON 파싱 실패 등 다양한 상황 처리

## 🔍 테스트 시나리오

### 1. 정상 응답
- API가 정상적으로 JSON 응답을 반환하는 경우
- 기존과 동일하게 동작

### 2. 빈 응답
- API가 빈 응답을 반환하는 경우
- "응답 본문이 비어있습니다." 에러 메시지 출력

### 3. JSON 파싱 실패
- API가 JSON이 아닌 응답을 반환하는 경우
- 응답 텍스트 일부와 함께 상세 로깅

### 4. HTTP 에러 응답
- API가 4xx/5xx 에러를 반환하는 경우
- 에러 메시지와 함께 상세 로깅 (응답 본문 포함)

### 5. 네트워크 에러
- 네트워크 연결 실패 등
- 에러 스택과 함께 상세 로깅

## 📝 참고 사항

- 개발 환경에서만 상세 로깅 출력 (`process.env.NODE_ENV === "development"`)
- 프로덕션 환경에서는 사용자 친화적인 에러 메시지만 표시
- 에러가 발생해도 직접 입력 모드는 계속 사용 가능하도록 처리

---

**작업 일시**: 2025-12-22  
**작업자**: AI Assistant

