# 콘텐츠별 설정 토글 선택 기능 오류 수정

## 작업 일자

2025-12-04

## 문제점

콘텐츠별 설정 토글 선택 시 다음 문제가 발생했습니다:

1. **모드 전환 실패**: 콘텐츠별 설정 모드로 전환할 때 `subject_allocations`에서만 제거하고 `content_allocations`를 업데이트하지 않아, `getSubjectAllocationMode` 함수가 여전히 "subject" 모드를 반환했습니다.

2. **UI 업데이트 실패**: 콘텐츠별 설정 모드로 전환했지만 UI가 여전히 교과 단위 설정 모드로 표시되었습니다.

3. **설정 값 손실**: 교과 단위 설정에서 콘텐츠별 설정으로 전환할 때 기존 설정 값이 복사되지 않아 사용자가 다시 설정해야 했습니다.

## 해결 방법

### 1. 콘텐츠별 설정 모드로 전환 시 `content_allocations` 업데이트

**파일**: `app/(student)/plan/new-group/_components/Step6Simplified.tsx`

`handleModeChange` 함수의 콘텐츠별 설정 모드 전환 로직을 개선:

1. **기존 교과 단위 설정 값 가져오기**: `subject_allocations`에서 해당 교과의 설정 값을 가져옵니다.

2. **해당 교과의 콘텐츠 목록 가져오기**: `contentsBySubject`에서 해당 교과의 모든 콘텐츠를 가져옵니다.

3. **기존 `content_allocations` 필터링**: 해당 교과의 기존 `content_allocations`를 제거하여 중복을 방지합니다.

4. **각 콘텐츠에 설정 값 복사**:

   - 기존 교과 단위 설정 값이 있으면 그 값을 각 콘텐츠에 복사합니다.
   - 기존 교과 단위 설정 값이 없으면 기본값(취약과목)으로 각 콘텐츠에 설정합니다.
   - 이미 `content_allocations`에 있는 콘텐츠는 건너뜁니다.

5. **업데이트**: `subject_allocations`에서 해당 교과를 제거하고, 업데이트된 `content_allocations`를 저장합니다.

## 수정된 코드

```typescript
} else {
  // 콘텐츠별 설정 모드로 전환
  // subject_allocations에서 해당 교과 제거
  const updatedAllocations = (data.subject_allocations || []).filter(
    (a) => a.subject_name !== subject
  );

  // 기존 교과 단위 설정 값 가져오기
  const existingSubjectAllocation = (data.subject_allocations || []).find(
    (a) => a.subject_name === subject
  );

  // 해당 교과의 콘텐츠 목록 가져오기
  const subjectContents = contentsBySubject.get(subject) || [];

  // 기존 content_allocations 가져오기
  const currentContentAllocations = data.content_allocations || [];

  // 해당 교과의 기존 content_allocations 제거 (중복 방지)
  const filteredContentAllocations = currentContentAllocations.filter(
    (a) =>
      !subjectContents.some(
        (c) =>
          c.content_type === a.content_type &&
          c.content_id === a.content_id
      )
  );

  // 기존 교과 단위 설정 값이 있으면 각 콘텐츠에 복사
  // 없으면 기본값(취약과목)으로 각 콘텐츠에 설정
  const allocationToApply = existingSubjectAllocation || {
    subject_type: "weakness" as const,
    weekly_days: undefined,
  };

  subjectContents.forEach((content) => {
    // 이미 content_allocations에 있는지 확인
    const existingContentAlloc = currentContentAllocations.find(
      (a) =>
        a.content_type === content.content_type &&
        a.content_id === content.content_id
    );

    // 없으면 기존 교과 단위 설정 값(또는 기본값)으로 추가
    if (!existingContentAlloc) {
      filteredContentAllocations.push({
        content_type: content.content_type as "book" | "lecture",
        content_id: content.content_id,
        subject_type: allocationToApply.subject_type,
        weekly_days: allocationToApply.weekly_days,
      });
    }
  });

  onUpdate({
    subject_allocations: updatedAllocations,
    content_allocations: filteredContentAllocations,
  });
}
```

## 개선 효과

1. ✅ **모드 전환 성공**: 콘텐츠별 설정 모드로 전환 시 `content_allocations`가 업데이트되어 `getSubjectAllocationMode`가 올바르게 "content" 모드를 반환합니다.

2. ✅ **UI 업데이트 성공**: 콘텐츠별 설정 모드로 전환 후 UI가 올바르게 콘텐츠별 설정 모드로 표시됩니다.

3. ✅ **설정 값 보존**: 교과 단위 설정에서 콘텐츠별 설정으로 전환할 때 기존 설정 값이 각 콘텐츠에 복사되어 사용자가 다시 설정할 필요가 없습니다.

4. ✅ **기본값 제공**: 기존 교과 단위 설정 값이 없어도 기본값(취약과목)으로 각 콘텐츠에 설정되어 콘텐츠별 설정 모드가 올바르게 동작합니다.

## 테스트 시나리오

1. **교과 단위 설정 → 콘텐츠별 설정 전환**

   - 교과 단위 설정 모드에서 전략과목, 주당 3일로 설정
   - 콘텐츠별 설정 모드로 전환
   - 각 콘텐츠에 전략과목, 주당 3일이 자동으로 설정됨
   - UI가 콘텐츠별 설정 모드로 올바르게 표시됨

2. **설정 없음 → 콘텐츠별 설정 전환**

   - 교과 단위 설정이 없는 상태에서 콘텐츠별 설정 모드로 전환
   - 각 콘텐츠에 기본값(취약과목)이 자동으로 설정됨
   - UI가 콘텐츠별 설정 모드로 올바르게 표시됨

3. **콘텐츠별 설정 → 교과 단위 설정 전환**
   - 콘텐츠별 설정 모드에서 각 콘텐츠를 개별적으로 설정
   - 교과 단위 설정 모드로 전환
   - 콘텐츠별 설정이 제거되고 교과 단위 설정이 적용됨

## 수정된 파일

1. `app/(student)/plan/new-group/_components/Step6Simplified.tsx`
   - `handleModeChange` 함수의 콘텐츠별 설정 모드 전환 로직 개선
   - 기존 교과 단위 설정 값을 콘텐츠별 설정으로 복사하는 로직 추가
   - 기본값 설정 로직 추가
