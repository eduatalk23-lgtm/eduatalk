# í”Œëœ ìƒì„± ê´€ë ¨ ì‚¬ì´ë“œ ì´í™íŠ¸ í˜„í™© ë¶„ì„

**ì‘ì„±ì¼**: 2026-01-15  
**ì‘ì„±ì**: AI Assistant  
**ìƒíƒœ**: âœ… ë¶„ì„ ì™„ë£Œ

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì‚¬ì´ë“œ ì´í™íŠ¸ ë¶„ë¥˜](#ì‚¬ì´ë“œ-ì´í™íŠ¸-ë¶„ë¥˜)
3. [ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½](#ë°ì´í„°ë² ì´ìŠ¤-ë³€ê²½)
4. [ìºì‹œ ë¬´íš¨í™”](#ìºì‹œ-ë¬´íš¨í™”)
5. [ì´ë²¤íŠ¸ ë¡œê¹…](#ì´ë²¤íŠ¸-ë¡œê¹…)
6. [ì•Œë¦¼ ë°œì†¡](#ì•Œë¦¼-ë°œì†¡)
7. [React Query ìºì‹œ ë¬´íš¨í™”](#react-query-ìºì‹œ-ë¬´íš¨í™”)
8. [ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸](#ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜-ì—…ë°ì´íŠ¸)
9. [ë¦¬ì–¼íƒ€ì„ ì—…ë°ì´íŠ¸](#ë¦¬ì–¼íƒ€ì„-ì—…ë°ì´íŠ¸)
10. [í”Œëœ ìƒì„± ê²½ë¡œë³„ ì‚¬ì´ë“œ ì´í™íŠ¸](#í”Œëœ-ìƒì„±-ê²½ë¡œë³„-ì‚¬ì´ë“œ-ì´í™íŠ¸)
11. [ë¬¸ì œì  ë° ê°œì„  ì œì•ˆ](#ë¬¸ì œì -ë°-ê°œì„ -ì œì•ˆ)

---

## ê°œìš”

### ëª©ì 

í”Œëœ ìƒì„± ì‹œ ë°œìƒí•˜ëŠ” ëª¨ë“  ì‚¬ì´ë“œ ì´í™íŠ¸ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  ë¬¸ì„œí™”í•˜ì—¬, ì‹œìŠ¤í…œì˜ ë™ì‘ì„ ëª…í™•íˆ ì´í•´í•˜ê³  ì ì¬ì ì¸ ë¬¸ì œì ì„ íŒŒì•…í•©ë‹ˆë‹¤.

### ë¶„ì„ ë²”ìœ„

- **í”Œëœ ìƒì„± ê²½ë¡œ**: í†µí•© í”Œëœ ìƒì„±, ìœ„ì €ë“œ ê¸°ë°˜ ìƒì„±, ë¹ ë¥¸ ìƒì„±, AI ìƒì„± ë“±
- **ì‚¬ì´ë“œ ì´í™íŠ¸ ìœ í˜•**: ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½, ìºì‹œ ë¬´íš¨í™”, ì´ë²¤íŠ¸ ë¡œê¹…, ì•Œë¦¼ ë°œì†¡ ë“±
- **ì˜í–¥ ë²”ìœ„**: í•™ìƒ, ê´€ë¦¬ì, í•™ë¶€ëª¨ ë“± ë‹¤ì–‘í•œ ì‚¬ìš©ì ê·¸ë£¹

### í•µì‹¬ ë°œê²¬ ì‚¬í•­

1. **ë‹¤ì–‘í•œ í”Œëœ ìƒì„± ê²½ë¡œ**: 10ê°œ ì´ìƒì˜ ì„œë¡œ ë‹¤ë¥¸ í”Œëœ ìƒì„± í•¨ìˆ˜ê°€ ì¡´ì¬
2. **ì¼ê´€ì„± ì—†ëŠ” ìºì‹œ ë¬´íš¨í™”**: ê²½ë¡œë³„ë¡œ ë‹¤ë¥¸ ìºì‹œ ë¬´íš¨í™” íŒ¨í„´
3. **ì´ë²¤íŠ¸ ë¡œê¹… ëˆ„ë½**: ì¼ë¶€ í”Œëœ ìƒì„± ê²½ë¡œì—ì„œ ì´ë²¤íŠ¸ ë¡œê¹…ì´ ëˆ„ë½ë¨
4. **ì•Œë¦¼ ë°œì†¡ ì œí•œ**: ìº í”„ ëª¨ë“œì—ì„œë§Œ ì•Œë¦¼ ë°œì†¡ì´ êµ¬í˜„ë¨

---

## ì‚¬ì´ë“œ ì´í™íŠ¸ ë¶„ë¥˜

### 1. ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½

í”Œëœ ìƒì„± ì‹œ ë‹¤ìŒ í…Œì´ë¸”ë“¤ì´ ë³€ê²½ë©ë‹ˆë‹¤:

| í…Œì´ë¸” | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|--------|----------|------|
| `student_plan` | INSERT | í”Œëœ ë ˆì½”ë“œ ìƒì„± |
| `plan_groups` | INSERT/UPDATE | í”Œëœ ê·¸ë£¹ ìƒì„± ë˜ëŠ” ìƒíƒœ ì—…ë°ì´íŠ¸ |
| `plan_contents` | INSERT | í”Œëœ ê·¸ë£¹ì— ì—°ê²°ëœ ì½˜í…ì¸  ì •ë³´ |
| `plan_exclusions` | INSERT | ì œì™¸ì¼ ì •ë³´ |
| `academy_schedules` | INSERT | í•™ì› ì¼ì • ì •ë³´ |
| `flexible_contents` | INSERT | ììœ  í•™ìŠµ ì½˜í…ì¸  (ì¡°ê±´ë¶€) |
| `plan_events` | INSERT | í”Œëœ ìƒì„± ì´ë²¤íŠ¸ ë¡œê¹… |

### 2. ìºì‹œ ë¬´íš¨í™”

Next.jsì˜ `revalidatePath`ë¥¼ í†µí•´ ë‹¤ìŒ ê²½ë¡œë“¤ì´ ë¬´íš¨í™”ë©ë‹ˆë‹¤:

| ê²½ë¡œ | ì„¤ëª… | ì‚¬ìš© ë¹ˆë„ |
|------|------|----------|
| `/plan` | í”Œëœ ëª©ë¡ í˜ì´ì§€ | ë†’ìŒ |
| `/today` | ì˜¤ëŠ˜ì˜ í•™ìŠµ í˜ì´ì§€ | ë†’ìŒ |
| `/plan/calendar` | í”Œëœ ìº˜ë¦°ë” í˜ì´ì§€ | ì¤‘ê°„ |
| `/admin/students/{studentId}/plans` | ê´€ë¦¬ì í”Œëœ ê´€ë¦¬ í˜ì´ì§€ | ë†’ìŒ |
| `/plan/group/{groupId}` | í”Œëœ ê·¸ë£¹ ìƒì„¸ í˜ì´ì§€ | ì¤‘ê°„ |

### 3. ì´ë²¤íŠ¸ ë¡œê¹…

`plan_events` í…Œì´ë¸”ì— ë‹¤ìŒ ì´ë²¤íŠ¸ íƒ€ì…ë“¤ì´ ê¸°ë¡ë©ë‹ˆë‹¤:

| ì´ë²¤íŠ¸ íƒ€ì… | ì„¤ëª… | ë°œìƒ ì¡°ê±´ |
|------------|------|----------|
| `unified_plan_created` | í†µí•© í”Œëœ ìƒì„± | `createUnifiedPlan` |
| `unified_adhoc_created` | í†µí•© ë‹¨ë°œì„± í”Œëœ ìƒì„± | `createUnifiedPlan` (isAdhoc=true) |
| `plan_created` | ì¼ë°˜ í”Œëœ ìƒì„± | `logPlanCreated` |
| `plan_completed` | í”Œëœ ì™„ë£Œ | `logPlanCompleted` |
| `plan_deleted` | í”Œëœ ì‚­ì œ | `logPlanDeleted` |
| `container_moved` | ì»¨í…Œì´ë„ˆ ì´ë™ | `logContainerMoved` |
| `volume_adjusted` | ë³¼ë¥¨ ì¡°ì • | `logVolumeAdjusted` |
| `volume_redistributed` | ë³¼ë¥¨ ì¬ë¶„ë°° | `logVolumeRedistributed` |
| `plan_carryover` | í”Œëœ ì´ì›” | `logPlanCarryover` |

### 4. ì•Œë¦¼ ë°œì†¡

ìº í”„ ëª¨ë“œì—ì„œë§Œ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤:

| ì•Œë¦¼ íƒ€ì… | ìˆ˜ì‹ ì | ë°œìƒ ì¡°ê±´ |
|----------|--------|----------|
| í”Œëœ ìƒì„± ì•Œë¦¼ | í•™ìƒ | ìº í”„ í”Œëœ ìƒì„± ì™„ë£Œ ì‹œ |
| í”Œëœ ìƒì„± ì•Œë¦¼ | í•™ë¶€ëª¨ | ìº í”„ í”Œëœ ìƒì„± ì™„ë£Œ ì‹œ (ë¹„ë™ê¸°) |

---

## ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½

### 1. í”Œëœ ìƒì„± (`student_plan` í…Œì´ë¸”)

**ìœ„ì¹˜**: `lib/domains/admin-plan/actions/unifiedPlanCreate.ts`

```typescript
const { data: createdPlan, error: insertError } = await supabase
  .from("student_plan")
  .insert(planData)
  .select("id, plan_date")
  .single();
```

**ì£¼ìš” í•„ë“œ**:
- `student_id`, `tenant_id`, `plan_group_id`
- `content_type`, `content_id`, `flexible_content_id`
- `plan_date`, `block_index`, `order_index`
- `status`, `is_active`, `is_adhoc`
- `created_by`, `created_at`, `updated_at`

### 2. í”Œëœ ê·¸ë£¹ ìƒì„±/ì—…ë°ì´íŠ¸ (`plan_groups` í…Œì´ë¸”)

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/create.ts`

```typescript
const atomicResult = await createPlanGroupAtomic(
  tenantContext.tenantId,
  studentId,
  planGroupData,
  processedContents,
  exclusionsData,
  schedulesData
);
```

**RPC í•¨ìˆ˜**: `create_plan_group_atomic`
- ì›ìì  íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë‹¤ìŒì„ í•œ ë²ˆì— ì²˜ë¦¬:
  - `plan_groups` INSERT
  - `plan_contents` INSERT
  - `plan_exclusions` INSERT
  - `academy_schedules` INSERT

### 3. í”Œëœ ê·¸ë£¹ ìƒíƒœ ì—…ë°ì´íŠ¸

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/generatePlansWithServices.ts`

```typescript
if ((group.status as PlanStatus) === "draft") {
  await persistence.updatePlanGroupStatus("saved", insertResult.insertedIds);
}
```

**ìƒíƒœ ì „ì´**:
- `draft` â†’ `saved` (í”Œëœ ìƒì„± ì‹œ)
- `saved` â†’ `active` (í”Œëœ ìƒì„± ì™„ë£Œ ì‹œ)

### 4. ê¸°ì¡´ í”Œëœ ì‚­ì œ (ì¬ìƒì„± ì‹œ)

**ìœ„ì¹˜**: `lib/plan/shared/PlanPersistenceService.ts`

```typescript
if (options?.deleteExisting) {
  const deleteResult = await this.deleteExistingPlans(planGroupId, context);
}
```

**ì¡°ê±´**: `deleteExisting` ì˜µì…˜ì´ `true`ì¸ ê²½ìš°

---

## ìºì‹œ ë¬´íš¨í™”

### 1. í†µí•© í”Œëœ ìƒì„± (`createUnifiedPlan`)

**ìœ„ì¹˜**: `lib/domains/admin-plan/actions/unifiedPlanCreate.ts`

```typescript
revalidatePath(`/admin/students/${input.studentId}/plans`);
revalidatePath("/today");
revalidatePath("/plan");
```

**ë¬´íš¨í™” ê²½ë¡œ**: 3ê°œ

### 2. í”Œëœ ê·¸ë£¹ ìƒì„± (`createPlanGroup`)

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/create.ts`

```typescript
revalidatePath("/plan");
```

**ë¬´íš¨í™” ê²½ë¡œ**: 1ê°œ

### 3. ë¹ ë¥¸ í”Œëœ ìƒì„± (`createQuickPlan`)

**ìœ„ì¹˜**: `lib/domains/plan/actions/contentPlanGroup/quickCreate.ts`

```typescript
revalidatePath("/today");
revalidatePath("/plan");
revalidatePath("/plan/calendar");
```

**ë¬´íš¨í™” ê²½ë¡œ**: 3ê°œ

### 4. AI í”Œëœ ìƒì„± (`generatePlanWithAI`)

**ìœ„ì¹˜**: `lib/domains/plan/llm/actions/generatePlan.ts`

```typescript
revalidatePath("/plan");
revalidatePath("/plan/calendar");
revalidatePath("/today");
```

**ë¬´íš¨í™” ê²½ë¡œ**: 3ê°œ

### 5. ìŠ¤ì¼€ì¤„ëŸ¬ ê¸°ë°˜ í”Œëœ ìƒì„± (`createPlanFromContentWithScheduler`)

**ìœ„ì¹˜**: `lib/domains/admin-plan/actions/createPlanFromContent.ts`

```typescript
revalidatePath(`/admin/students/${input.studentId}/plans`);
revalidatePath('/today');
revalidatePath('/plan');
```

**ë¬´íš¨í™” ê²½ë¡œ**: 3ê°œ

### ìºì‹œ ë¬´íš¨í™” íŒ¨í„´ ë¶„ì„

| í•¨ìˆ˜ | ë¬´íš¨í™” ê²½ë¡œ ìˆ˜ | ê²½ë¡œ ëª©ë¡ |
|------|---------------|----------|
| `createUnifiedPlan` | 3 | `/admin/students/{id}/plans`, `/today`, `/plan` |
| `createPlanGroup` | 1 | `/plan` |
| `createQuickPlan` | 3 | `/today`, `/plan`, `/plan/calendar` |
| `generatePlanWithAI` | 3 | `/plan`, `/plan/calendar`, `/today` |
| `createPlanFromContentWithScheduler` | 3 | `/admin/students/{id}/plans`, `/today`, `/plan` |
| `generatePlansWithServices` | 0 | ì—†ìŒ (ì„œë²„ ì•¡ì…˜ ë‚´ë¶€ í•¨ìˆ˜) |

**ë¬¸ì œì **:
- `createPlanGroup`ì€ 1ê°œ ê²½ë¡œë§Œ ë¬´íš¨í™” (ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ê³¼ ë¶ˆì¼ì¹˜)
- `generatePlansWithServices`ëŠ” ìºì‹œ ë¬´íš¨í™” ì—†ìŒ (í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•¨)

---

## ì´ë²¤íŠ¸ ë¡œê¹…

### 1. í†µí•© í”Œëœ ìƒì„± ì´ë²¤íŠ¸

**ìœ„ì¹˜**: `lib/domains/admin-plan/actions/unifiedPlanCreate.ts`

```typescript
await createPlanEvent({
  tenant_id: input.tenantId,
  student_id: input.studentId,
  student_plan_id: createdPlan.id,
  plan_group_id: planGroupResult.planGroupId,
  event_type: input.isAdhoc ? "unified_adhoc_created" : "unified_plan_created",
  event_category: "plan_item",
  payload: {
    title: input.title,
    planDate: input.planDate,
    isAdhoc: input.isAdhoc,
    isFreeLearning: input.isFreeLearning,
    contentType: effectiveContentType,
  },
  new_state: planData as unknown as Record<string, unknown>,
  actor_id: userId,
  actor_type: "admin",
});
```

**ì´ë²¤íŠ¸ íƒ€ì…**:
- `unified_plan_created`: ì¼ë°˜ í”Œëœ
- `unified_adhoc_created`: ë‹¨ë°œì„± í”Œëœ

### 2. í”Œëœ ê·¸ë£¹ ìƒì„± ì´ë²¤íŠ¸

**í˜„ì¬ ìƒíƒœ**: âŒ ì´ë²¤íŠ¸ ë¡œê¹… ì—†ìŒ

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/create.ts`

**ë¬¸ì œì **: í”Œëœ ê·¸ë£¹ ìƒì„± ì‹œ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë˜ì§€ ì•ŠìŒ

### 3. í”Œëœ ìƒì„± (ìœ„ì €ë“œ) ì´ë²¤íŠ¸

**í˜„ì¬ ìƒíƒœ**: âŒ ì´ë²¤íŠ¸ ë¡œê¹… ì—†ìŒ

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/generatePlansWithServices.ts`

**ë¬¸ì œì **: ìœ„ì €ë“œ ê¸°ë°˜ í”Œëœ ìƒì„± ì‹œ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë˜ì§€ ì•ŠìŒ

### 4. ë¹ ë¥¸ í”Œëœ ìƒì„± ì´ë²¤íŠ¸

**í˜„ì¬ ìƒíƒœ**: âŒ ì´ë²¤íŠ¸ ë¡œê¹… ì—†ìŒ

**ìœ„ì¹˜**: `lib/domains/plan/actions/contentPlanGroup/quickCreate.ts`

**ë¬¸ì œì **: ë¹ ë¥¸ í”Œëœ ìƒì„± ì‹œ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë˜ì§€ ì•ŠìŒ

### ì´ë²¤íŠ¸ ë¡œê¹… í˜„í™© ìš”ì•½

| í”Œëœ ìƒì„± ê²½ë¡œ | ì´ë²¤íŠ¸ ë¡œê¹… | ì´ë²¤íŠ¸ íƒ€ì… |
|---------------|------------|------------|
| `createUnifiedPlan` | âœ… ìˆìŒ | `unified_plan_created`, `unified_adhoc_created` |
| `createPlanGroup` | âŒ ì—†ìŒ | - |
| `generatePlansWithServices` | âŒ ì—†ìŒ | - |
| `createQuickPlan` | âŒ ì—†ìŒ | - |
| `generatePlanWithAI` | âŒ ì—†ìŒ | - |
| `createPlanFromContentWithScheduler` | âŒ ì—†ìŒ | - |

**ë¬¸ì œì **: ëŒ€ë¶€ë¶„ì˜ í”Œëœ ìƒì„± ê²½ë¡œì—ì„œ ì´ë²¤íŠ¸ ë¡œê¹…ì´ ëˆ„ë½ë¨

---

## ì•Œë¦¼ ë°œì†¡

### 1. ìº í”„ í”Œëœ ìƒì„± ì•Œë¦¼

**ìœ„ì¹˜**: `lib/domains/camp/actions/progress/wizard.ts`

```typescript
// í”Œëœ ìƒì„± ì„±ê³µ ì‹œ í•™ìƒì—ê²Œ ì•Œë¦¼ ë°œì†¡
if (result.group.camp_template_id && result.group.student_id) {
  await sendPlanCreatedNotificationToStudent({
    studentId: result.group.student_id,
    studentName: studentData.data.name || "í•™ìƒ",
    templateId: result.group.camp_template_id,
    templateName: templateData.data.name,
    groupId,
    tenantId,
  });

  // í•™ë¶€ëª¨ì—ê²Œë„ í”Œëœ ìƒì„± ì•Œë¦¼ ë°œì†¡ (ë¹„ë™ê¸°)
  sendPlanCreatedNotificationToParents({
    studentId: result.group.student_id,
    studentName: studentData.data.name || "í•™ìƒ",
    templateId: result.group.camp_template_id,
    templateName: templateData.data.name,
    groupId,
    tenantId,
  }).catch((err) => {
    logActionError(/* ... */);
  });
}
```

**ì•Œë¦¼ íƒ€ì…**:
- í•™ìƒ ì•Œë¦¼: ë™ê¸° ì²˜ë¦¬
- í•™ë¶€ëª¨ ì•Œë¦¼: ë¹„ë™ê¸° ì²˜ë¦¬ (ì‹¤íŒ¨í•´ë„ í”Œëœ ìƒì„±ì— ì˜í–¥ ì—†ìŒ)

### 2. ì¼ë°˜ í”Œëœ ìƒì„± ì•Œë¦¼

**í˜„ì¬ ìƒíƒœ**: âŒ ì•Œë¦¼ ë°œì†¡ ì—†ìŒ

**ë¬¸ì œì **: ì¼ë°˜ í”Œëœ ìƒì„± ì‹œ ì•Œë¦¼ì´ ë°œì†¡ë˜ì§€ ì•ŠìŒ

---

## React Query ìºì‹œ ë¬´íš¨í™”

### 1. ìœ„ì €ë“œ ê¸°ë°˜ í”Œëœ ìƒì„±

**ìœ„ì¹˜**: `app/(student)/plan/new-group/_components/_features/scheduling/Step7ScheduleResult.tsx`

```typescript
onSuccess: async () => {
  // í”Œëœ ìƒì„± í›„ DB ë™ê¸°í™”ë¥¼ ìœ„í•œ ì§§ì€ ì§€ì—°
  await new Promise((resolve) => setTimeout(resolve, 500));
  
  // í”Œëœ ìƒì„± í›„ ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™” ë° ì¦‰ì‹œ refetch
  await queryClient.invalidateQueries({ queryKey: ["plansExist", groupId] });
  await queryClient.invalidateQueries({ queryKey: ["planSchedule", groupId] });
  await queryClient.invalidateQueries({ queryKey: ["contentScheduleOverview", groupId] });
  
  // ì¦‰ì‹œ refetchí•˜ì—¬ ìµœì‹  ë°ì´í„° í‘œì‹œ
  await queryClient.refetchQueries({
    queryKey: ["plansExist", groupId],
    exact: true
  });
  await queryClient.refetchQueries({ queryKey: ["planSchedule", groupId] });
}
```

**ë¬´íš¨í™” ì¿¼ë¦¬**:
- `["plansExist", groupId]`
- `["planSchedule", groupId]`
- `["contentScheduleOverview", groupId]`

**íŠ¹ì§•**: DB ë™ê¸°í™”ë¥¼ ìœ„í•œ 500ms ì§€ì—° í›„ ë¬´íš¨í™”

### 2. ë‹¤ë¥¸ í”Œëœ ìƒì„± ê²½ë¡œ

**í˜„ì¬ ìƒíƒœ**: âŒ React Query ìºì‹œ ë¬´íš¨í™” ì—†ìŒ

**ë¬¸ì œì **: ëŒ€ë¶€ë¶„ì˜ í”Œëœ ìƒì„± ê²½ë¡œì—ì„œ React Query ìºì‹œ ë¬´íš¨í™”ê°€ ëˆ„ë½ë¨

---

## ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸

### í”Œëœ ì™„ë£Œ ì‹œ ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸

**ìœ„ì¹˜**: `lib/domains/today/actions/timer.ts`

```typescript
// ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬, ì‹¤íŒ¨í•´ë„ í”Œëœ ì™„ë£Œì— ì˜í–¥ ì—†ìŒ)
const studyDurationMinutes = Math.floor(finalDuration / 60);
try {
  const gamificationResult = await updateGamificationOnPlanComplete({
    studentId: user.userId,
    tenantId: tenantId || "",
    eventType: "plan_completed",
    studyDurationMinutes,
    completedAt: new Date(),
    planId,
  });
} catch (gamificationError) {
  // ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì˜¤ë¥˜ëŠ” í”Œëœ ì™„ë£Œì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ
  timerLogger.warn("ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", { /* ... */ });
}
```

**íŠ¹ì§•**:
- ë¹„ë™ê¸° ì²˜ë¦¬
- ì‹¤íŒ¨í•´ë„ í”Œëœ ì™„ë£Œì— ì˜í–¥ ì—†ìŒ
- í”Œëœ ìƒì„± ì‹œì—ëŠ” ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸ ì—†ìŒ

---

## ë¦¬ì–¼íƒ€ì„ ì—…ë°ì´íŠ¸

### 1. í”Œëœ ë¦¬ì–¼íƒ€ì„ ì—…ë°ì´íŠ¸

**ìœ„ì¹˜**: `lib/realtime/usePlanRealtimeUpdates.ts`

```typescript
export function usePlanRealtimeUpdates({
  planDate,
  userId,
  enabled = true,
}: UsePlanRealtimeUpdatesOptions) {
  // Supabase Realtime êµ¬ë…
  // student_plan í…Œì´ë¸” ë³€ê²½ ê°ì§€
}
```

**êµ¬ë… ëŒ€ìƒ**: `student_plan` í…Œì´ë¸”

### 2. í”Œëœ ê·¸ë£¹ ë¦¬ì–¼íƒ€ì„ ì—…ë°ì´íŠ¸

**ìœ„ì¹˜**: `lib/realtime/usePlanGroupRealtime.ts`

```typescript
export function usePlanGroupRealtime({
  studentId,
  enabled = true,
}: UsePlanGroupRealtimeOptions) {
  // Supabase Realtime êµ¬ë…
  // plan_groups í…Œì´ë¸” ë³€ê²½ ê°ì§€
}
```

**êµ¬ë… ëŒ€ìƒ**: `plan_groups` í…Œì´ë¸”

**íŠ¹ì§•**: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ìë™ìœ¼ë¡œ ë¦¬ì–¼íƒ€ì„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬

---

## í”Œëœ ìƒì„± ê²½ë¡œë³„ ì‚¬ì´ë“œ ì´í™íŠ¸

### 1. í†µí•© í”Œëœ ìƒì„± (`createUnifiedPlan`)

**ìœ„ì¹˜**: `lib/domains/admin-plan/actions/unifiedPlanCreate.ts`

| ì‚¬ì´ë“œ ì´í™íŠ¸ | ìƒíƒœ | ë¹„ê³  |
|--------------|------|------|
| DB: `student_plan` INSERT | âœ… | ë‹¨ì¼ í”Œëœ ìƒì„± |
| DB: `plan_groups` INSERT/UPDATE | âœ… | í”Œëœ ê·¸ë£¹ í™•ë³´ |
| DB: `flexible_contents` INSERT | âœ… | ììœ  í•™ìŠµì¸ ê²½ìš° |
| DB: `plan_events` INSERT | âœ… | ì´ë²¤íŠ¸ ë¡œê¹… |
| ìºì‹œ ë¬´íš¨í™” | âœ… | 3ê°œ ê²½ë¡œ |
| React Query ë¬´íš¨í™” | âŒ | ì—†ìŒ |
| ì•Œë¦¼ ë°œì†¡ | âŒ | ì—†ìŒ |

### 2. í”Œëœ ê·¸ë£¹ ìƒì„± (`createPlanGroup`)

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/create.ts`

| ì‚¬ì´ë“œ ì´í™íŠ¸ | ìƒíƒœ | ë¹„ê³  |
|--------------|------|------|
| DB: `plan_groups` INSERT | âœ… | RPC í•¨ìˆ˜ ì‚¬ìš© |
| DB: `plan_contents` INSERT | âœ… | RPC í•¨ìˆ˜ ì‚¬ìš© |
| DB: `plan_exclusions` INSERT | âœ… | RPC í•¨ìˆ˜ ì‚¬ìš© |
| DB: `academy_schedules` INSERT | âœ… | RPC í•¨ìˆ˜ ì‚¬ìš© |
| DB: `plan_events` INSERT | âŒ | ì—†ìŒ |
| ìºì‹œ ë¬´íš¨í™” | âœ… | 1ê°œ ê²½ë¡œë§Œ |
| React Query ë¬´íš¨í™” | âŒ | ì—†ìŒ |
| ì•Œë¦¼ ë°œì†¡ | âŒ | ì—†ìŒ |

### 3. í”Œëœ ìƒì„± (ìœ„ì €ë“œ) (`generatePlansWithServices`)

**ìœ„ì¹˜**: `lib/domains/plan/actions/plan-groups/generatePlansWithServices.ts`

| ì‚¬ì´ë“œ ì´í™íŠ¸ | ìƒíƒœ | ë¹„ê³  |
|--------------|------|------|
| DB: `student_plan` INSERT | âœ… | ì—¬ëŸ¬ í”Œëœ ì¼ê´„ ìƒì„± |
| DB: `student_plan` DELETE | âœ… | ê¸°ì¡´ í”Œëœ ì‚­ì œ (ì˜µì…˜) |
| DB: `plan_groups` UPDATE | âœ… | ìƒíƒœ ì—…ë°ì´íŠ¸ (draft â†’ saved) |
| DB: `plan_events` INSERT | âŒ | ì—†ìŒ |
| ìºì‹œ ë¬´íš¨í™” | âŒ | ì—†ìŒ (í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬) |
| React Query ë¬´íš¨í™” | âŒ | ì—†ìŒ |
| ì•Œë¦¼ ë°œì†¡ | âŒ | ì—†ìŒ |

### 4. ë¹ ë¥¸ í”Œëœ ìƒì„± (`createQuickPlan`)

**ìœ„ì¹˜**: `lib/domains/plan/actions/contentPlanGroup/quickCreate.ts`

| ì‚¬ì´ë“œ ì´í™íŠ¸ | ìƒíƒœ | ë¹„ê³  |
|--------------|------|------|
| DB: `student_plan` INSERT | âœ… | ë‹¨ì¼ í”Œëœ ìƒì„± |
| DB: `plan_groups` INSERT | âœ… | í”Œëœ ê·¸ë£¹ ìƒì„± (í•„ìš” ì‹œ) |
| DB: `flexible_contents` INSERT | âœ… | ììœ  í•™ìŠµì¸ ê²½ìš° |
| DB: `plan_events` INSERT | âŒ | ì—†ìŒ |
| ìºì‹œ ë¬´íš¨í™” | âœ… | 3ê°œ ê²½ë¡œ |
| React Query ë¬´íš¨í™” | âŒ | ì—†ìŒ |
| ì•Œë¦¼ ë°œì†¡ | âŒ | ì—†ìŒ |

### 5. AI í”Œëœ ìƒì„± (`generatePlanWithAI`)

**ìœ„ì¹˜**: `lib/domains/plan/llm/actions/generatePlan.ts`

| ì‚¬ì´ë“œ ì´í™íŠ¸ | ìƒíƒœ | ë¹„ê³  |
|--------------|------|------|
| DB: `student_plan` INSERT | âœ… | ì—¬ëŸ¬ í”Œëœ ì¼ê´„ ìƒì„± |
| DB: `plan_groups` INSERT | âœ… | í”Œëœ ê·¸ë£¹ ìƒì„± (í•„ìš” ì‹œ) |
| DB: `plan_events` INSERT | âŒ | ì—†ìŒ |
| ìºì‹œ ë¬´íš¨í™” | âœ… | 3ê°œ ê²½ë¡œ |
| React Query ë¬´íš¨í™” | âŒ | ì—†ìŒ |
| ì•Œë¦¼ ë°œì†¡ | âŒ | ì—†ìŒ |

### 6. ìº í”„ í”Œëœ ìƒì„± (`continueCampStepsForAdmin`)

**ìœ„ì¹˜**: `lib/domains/camp/actions/progress/wizard.ts`

| ì‚¬ì´ë“œ ì´í™íŠ¸ | ìƒíƒœ | ë¹„ê³  |
|--------------|------|------|
| DB: `student_plan` INSERT | âœ… | ì—¬ëŸ¬ í”Œëœ ì¼ê´„ ìƒì„± |
| DB: `plan_groups` INSERT/UPDATE | âœ… | í”Œëœ ê·¸ë£¹ ìƒì„±/ì—…ë°ì´íŠ¸ |
| DB: `plan_events` INSERT | âŒ | ì—†ìŒ |
| ìºì‹œ ë¬´íš¨í™” | âœ… | ì—¬ëŸ¬ ê²½ë¡œ |
| React Query ë¬´íš¨í™” | âŒ | ì—†ìŒ |
| ì•Œë¦¼ ë°œì†¡ | âœ… | í•™ìƒ ë° í•™ë¶€ëª¨ |

---

## ë¬¸ì œì  ë° ê°œì„  ì œì•ˆ

### 1. ì´ë²¤íŠ¸ ë¡œê¹… ëˆ„ë½

**ë¬¸ì œì **:
- ëŒ€ë¶€ë¶„ì˜ í”Œëœ ìƒì„± ê²½ë¡œì—ì„œ ì´ë²¤íŠ¸ ë¡œê¹…ì´ ëˆ„ë½ë¨
- ê°ì‚¬ ì¶”ì  ë° ë¶„ì„ì´ ì–´ë ¤ì›€

**ê°œì„  ì œì•ˆ**:
1. ëª¨ë“  í”Œëœ ìƒì„± í•¨ìˆ˜ì— ì´ë²¤íŠ¸ ë¡œê¹… ì¶”ê°€
2. ê³µí†µ í—¬í¼ í•¨ìˆ˜ ìƒì„±í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€
3. ì´ë²¤íŠ¸ íƒ€ì… í‘œì¤€í™”

**ì˜ˆì‹œ**:
```typescript
// ê³µí†µ í—¬í¼ í•¨ìˆ˜
async function logPlanCreationEvent(
  planId: string,
  planGroupId: string,
  studentId: string,
  tenantId: string,
  eventType: string,
  metadata: Record<string, unknown>
) {
  await createPlanEvent({
    tenant_id: tenantId,
    student_id: studentId,
    student_plan_id: planId,
    plan_group_id: planGroupId,
    event_type: eventType,
    event_category: "plan_item",
    payload: metadata,
    actor_id: userId,
    actor_type: "admin",
  });
}
```

### 2. ìºì‹œ ë¬´íš¨í™” ë¶ˆì¼ì¹˜

**ë¬¸ì œì **:
- í”Œëœ ìƒì„± ê²½ë¡œë³„ë¡œ ìºì‹œ ë¬´íš¨í™” íŒ¨í„´ì´ ë‹¤ë¦„
- `createPlanGroup`ì€ 1ê°œ ê²½ë¡œë§Œ ë¬´íš¨í™”
- `generatePlansWithServices`ëŠ” ìºì‹œ ë¬´íš¨í™” ì—†ìŒ

**ê°œì„  ì œì•ˆ**:
1. í‘œì¤€ ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜ ìƒì„±
2. ëª¨ë“  í”Œëœ ìƒì„± í•¨ìˆ˜ì—ì„œ ë™ì¼í•œ íŒ¨í„´ ì ìš©

**ì˜ˆì‹œ**:
```typescript
// í‘œì¤€ ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜
async function revalidatePlanPaths(studentId?: string) {
  revalidatePath("/plan");
  revalidatePath("/today");
  revalidatePath("/plan/calendar");
  
  if (studentId) {
    revalidatePath(`/admin/students/${studentId}/plans`);
  }
}
```

### 3. React Query ìºì‹œ ë¬´íš¨í™” ëˆ„ë½

**ë¬¸ì œì **:
- ëŒ€ë¶€ë¶„ì˜ í”Œëœ ìƒì„± ê²½ë¡œì—ì„œ React Query ìºì‹œ ë¬´íš¨í™”ê°€ ëˆ„ë½ë¨
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë³´ê¸° ì–´ë ¤ì›€

**ê°œì„  ì œì•ˆ**:
1. ì„œë²„ ì•¡ì…˜ì—ì„œ React Query ë¬´íš¨í™” íŒíŠ¸ ë°˜í™˜
2. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ë¬´íš¨í™” ì²˜ë¦¬

**ì˜ˆì‹œ**:
```typescript
// ì„œë²„ ì•¡ì…˜ ë°˜í™˜ê°’ì— ë¬´íš¨í™” íŒíŠ¸ í¬í•¨
return {
  success: true,
  planId: createdPlan.id,
  invalidateQueries: [
    ["plansExist", groupId],
    ["planSchedule", groupId],
  ],
};
```

### 4. ì•Œë¦¼ ë°œì†¡ ì œí•œ

**ë¬¸ì œì **:
- ìº í”„ ëª¨ë“œì—ì„œë§Œ ì•Œë¦¼ ë°œì†¡
- ì¼ë°˜ í”Œëœ ìƒì„± ì‹œ ì•Œë¦¼ ì—†ìŒ

**ê°œì„  ì œì•ˆ**:
1. ì•Œë¦¼ ì„¤ì • ê¸°ë°˜ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡ ì—¬ë¶€ ê²°ì •
2. ëª¨ë“  í”Œëœ ìƒì„± ê²½ë¡œì—ì„œ ì•Œë¦¼ ë°œì†¡ ì§€ì›

### 5. ì‚¬ì´ë“œ ì´í™íŠ¸ ì¤‘ì•™í™”

**ë¬¸ì œì **:
- ê° í”Œëœ ìƒì„± í•¨ìˆ˜ì—ì„œ ì‚¬ì´ë“œ ì´í™íŠ¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬
- ì¼ê´€ì„± ìœ ì§€ ì–´ë ¤ì›€

**ê°œì„  ì œì•ˆ**:
1. ì‚¬ì´ë“œ ì´í™íŠ¸ ì²˜ë¦¬ ì„œë¹„ìŠ¤ ìƒì„±
2. ëª¨ë“  í”Œëœ ìƒì„± í•¨ìˆ˜ì—ì„œ ê³µí†µ ì„œë¹„ìŠ¤ ì‚¬ìš©

**ì˜ˆì‹œ**:
```typescript
// ì‚¬ì´ë“œ ì´í™íŠ¸ ì²˜ë¦¬ ì„œë¹„ìŠ¤
class PlanCreationSideEffects {
  async handlePlanCreated(params: {
    planId: string;
    planGroupId: string;
    studentId: string;
    tenantId: string;
    eventType: string;
    metadata: Record<string, unknown>;
  }) {
    // 1. ì´ë²¤íŠ¸ ë¡œê¹…
    await this.logEvent(params);
    
    // 2. ìºì‹œ ë¬´íš¨í™”
    await this.revalidateCache(params.studentId);
    
    // 3. ì•Œë¦¼ ë°œì†¡ (ì„¤ì • ê¸°ë°˜)
    await this.sendNotification(params);
    
    // 4. React Query ë¬´íš¨í™” íŒíŠ¸ ë°˜í™˜
    return this.getInvalidationHints(params);
  }
}
```

---

## ì°¸ê³  ë¬¸ì„œ

- [ê´€ë¦¬ì ì˜ì—­ í•™ìƒ ëŒ€ìƒ í”Œë˜ë„ˆ ìƒì„± ë° í”Œëœ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¡° ë¶„ì„](./2026-01-15-admin-planner-plan-creation-system-analysis.md)
- [ê´€ë¦¬ì í”Œë˜ë„ˆ-í”Œëœ ê´€ë¦¬ í”Œë¡œìš° ë¶„ì„](./2026-01-15-admin-planner-plan-management-flow-analysis.md)
- [í”Œëœ ìƒì„± ì‹œ RLS ì •ì±… ìœ„ë°˜ ë¬¸ì œ í•´ê²°](./plan-insert-rls-fix.md)

---

**ì‘ì„± ì™„ë£Œ**: 2026-01-15  
**ë²„ì „**: 1.0

