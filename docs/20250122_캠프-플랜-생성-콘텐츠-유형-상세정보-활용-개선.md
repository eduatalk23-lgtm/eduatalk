# 캠프 플랜 생성 시 콘텐츠 유형과 상세정보 활용 개선

**작성일**: 2025-01-22  
**목적**: 캠프 플랜 생성 시 콘텐츠 유형과 상세정보(페이지, 회차, 소요시간)을 활용하지 않던 문제를 일반 모드 로직을 참고하여 개선

---

## 문제 분석

### 발견된 문제

1. **캠프 플랜 생성 시 `chapter` 정보가 `null`로 설정됨**
   - `ScheduledPlan` 생성 시 `chapter` 필드가 항상 `null`로 설정
   - `PlanContent`의 `start_detail_id`와 `end_detail_id`를 활용하지 않음
   - 일반 모드와 캠프 모드 모두 동일한 문제 발생

2. **콘텐츠 유형과 상세정보 미활용**
   - `contentDurationMap`은 episode 정보를 포함하고 있으나 `chapter` 정보는 조회하지 않음
   - `planned_start_page_or_time`과 `planned_end_page_or_time`은 제대로 설정되지만 `chapter` 정보는 누락

### 원인 분석

1. **`ContentInfo` 타입에 `chapter` 필드 없음**
   - `generatePlansFromGroup` 함수에서 `ContentInfo`를 생성할 때 `chapter` 정보를 포함하지 않음

2. **`ScheduledPlan` 생성 시 `chapter` 정보 미전달**
   - `generateDefaultPlans`와 `SchedulerEngine`에서 `ScheduledPlan`을 생성할 때 `chapter: null`로 설정
   - `PlanContent`의 `start_detail_id`와 `end_detail_id`를 사용하여 `chapter` 정보를 조회하는 로직 없음

---

## 해결 방안

### 1. `ContentInfo` 타입에 `chapter` 필드 추가

**파일**: `lib/plan/scheduler.ts`

```typescript
export type ContentInfo = {
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  start_range: number;
  end_range: number;
  total_amount: number;
  subject?: string | null;
  subject_category?: string | null;
  chapter?: string | null; // 단원/회차 정보 추가
};
```

### 2. `PlanContent`에서 `chapter` 정보 조회 함수 추가

**파일**: `lib/plan/contentResolver.ts`

- `loadContentChapters` 함수 추가
- `PlanContent`의 `start_detail_id`와 `end_detail_id`를 사용하여 `book_details`나 `lecture_episodes` 테이블에서 `chapter` 정보 조회
- Book: `major_unit` 또는 `minor_unit` 사용
- Lecture: `episode_title` 사용 (없으면 `episode_number` 사용)

### 3. `generatePlansFromGroup` 함수에 `contentChapterMap` 파라미터 추가

**파일**: `lib/plan/scheduler.ts`

- `generatePlansFromGroup` 함수에 `contentChapterMap` 파라미터 추가
- `ContentInfo` 생성 시 `contentChapterMap`에서 `chapter` 정보 조회하여 설정

### 4. `ScheduledPlan` 생성 시 `chapter` 정보 전달

**파일**: `lib/plan/scheduler.ts`, `lib/scheduler/SchedulerEngine.ts`

- `generateDefaultPlans`에서 `ScheduledPlan` 생성 시 `ContentInfo`의 `chapter` 정보 사용
- `SchedulerEngine`에서 `ScheduledPlan` 생성 시 `ContentInfo`의 `chapter` 정보 사용
- `generateAdditionalPeriodReallocationPlans`에서도 원본 플랜의 `chapter` 정보 사용

### 5. `generatePlansRefactored.ts`에서 `chapter` 정보 조회 및 전달

**파일**: `app/(student)/actions/plan-groups/generatePlansRefactored.ts`

- `loadContentChapters` 함수 호출하여 `contentChapterMap` 생성
- `generatePlansFromGroup` 호출 시 `contentChapterMap` 전달

---

## 변경된 파일

1. **lib/plan/scheduler.ts**
   - `ContentInfo` 타입에 `chapter` 필드 추가
   - `generatePlansFromGroup` 함수에 `contentChapterMap` 파라미터 추가
   - `ContentInfo` 생성 시 `chapter` 정보 설정
   - `ScheduledPlan` 생성 시 `chapter` 정보 전달

2. **lib/plan/contentResolver.ts**
   - `ContentChapterMap` 타입 추가
   - `loadContentChapters` 함수 추가 (PlanContent의 start_detail_id/end_detail_id 사용)

3. **lib/scheduler/SchedulerEngine.ts**
   - `ScheduledPlan` 생성 시 `ContentInfo`의 `chapter` 정보 사용

4. **app/(student)/actions/plan-groups/generatePlansRefactored.ts**
   - `loadContentChapters` 함수 호출 추가
   - `generatePlansFromGroup` 호출 시 `contentChapterMap` 전달

---

## 구현 세부사항

### `loadContentChapters` 함수

```typescript
export async function loadContentChapters(
  contents: PlanContent[],
  contentIdMap: ContentIdMap,
  studentId: string,
  queryClient: SupabaseAnyClient
): Promise<ContentChapterMap>;
```

**동작 방식**:

1. `start_detail_id`와 `end_detail_id`가 있는 `PlanContent`만 필터링
2. Book과 Lecture를 분리하여 처리
3. Book: `student_book_details` 테이블에서 `major_unit` 또는 `minor_unit` 조회
4. Lecture: `student_lecture_episodes` 테이블에서 `episode_title` 조회 (없으면 `episode_number` 사용)
5. 단일 범위인 경우 해당 `chapter` 정보 반환
6. 범위인 경우 `${startChapter} ~ ${endChapter}` 형식으로 반환

### `ContentInfo` 생성 시 `chapter` 정보 설정

```typescript
const contentInfos: ContentInfo[] = contents.map((c) => {
  const subjectInfo = contentSubjects?.get(c.content_id);
  const chapter = contentChapterMap?.get(c.content_id) || null;
  return {
    // ...
    chapter: chapter, // contentChapterMap에서 조회한 chapter 정보 사용
  };
});
```

### `ScheduledPlan` 생성 시 `chapter` 정보 전달

```typescript
plans.push({
  // ...
  chapter: content.chapter || null, // ContentInfo의 chapter 정보 사용
  // ...
});
```

---

## 테스트 방법

1. **캠프 플랜 생성 테스트**
   - 캠프 템플릿을 사용하여 플랜 그룹 생성
   - 생성된 플랜의 `chapter` 필드 확인
   - `PlanContent`에 `start_detail_id`와 `end_detail_id`가 있는 경우 `chapter` 정보가 제대로 설정되는지 확인

2. **일반 모드 플랜 생성 테스트**
   - 일반 모드에서 플랜 그룹 생성
   - 생성된 플랜의 `chapter` 필드 확인
   - 기존 동작과 동일하게 작동하는지 확인

3. **PlanListView 확인**
   - 생성된 플랜 목록에서 `chapter` 정보가 제대로 표시되는지 확인
   - "학습내역" 컬럼에 회차 정보가 표시되는지 확인

---

## 참고사항

- `PlanContent`에 `start_detail_id`와 `end_detail_id`가 없는 경우 `chapter`는 `null`로 설정됨
- `book_details`나 `lecture_episodes` 테이블에 해당 정보가 없는 경우에도 `chapter`는 `null`로 설정됨
- 일반 모드와 캠프 모드 모두 동일한 로직을 사용하므로 일관성 유지

---

## 향후 개선 사항

1. **`chapter` 정보 조회 성능 최적화**
   - 배치 조회로 최적화 (현재는 개별 조회)
   - 캐싱 추가 고려

2. **`chapter` 정보 표시 개선**
   - PlanListView에서 `chapter` 정보를 더 명확하게 표시
   - 범위인 경우와 단일 범위인 경우 구분하여 표시

---

**작성자**: AI Assistant  
**검토 필요**: 사용자 확인 필요
