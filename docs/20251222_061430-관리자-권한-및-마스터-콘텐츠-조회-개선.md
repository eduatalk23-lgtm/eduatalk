# ê´€ë¦¬ì ê¶Œí•œ ë° ë§ˆìŠ¤í„° ì½˜í…ì¸  ì¡°íšŒ ê°œì„ 

## ğŸ“‹ ì‘ì—… ê°œìš”

ê´€ë¦¬ì ì˜ì—­ì—ì„œ í•™ìƒ ê¶Œí•œ í™•ì¸ ë¶€ë¶„ ê°œì„  ë° ë§ˆìŠ¤í„° ì½˜í…ì¸  ì¡°íšŒ ë¡œì§ ê°œì„  ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.

## ğŸ” ë¬¸ì œ ìƒí™©

### 1. ê´€ë¦¬ì ê¶Œí•œ ì˜¤ë¥˜

ê´€ë¦¬ìê°€ í•™ìƒ ëŒ€ì‹  í”Œëœ ê·¸ë£¹ì„ ì—…ë°ì´íŠ¸í•  ë•Œ "í•™ìƒ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"ë¼ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì—ëŸ¬ ìŠ¤íƒ**:
```
Error [AppError]: í•™ìƒ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
  at requireStudentAuth (lib/auth/requireStudentAuth.ts:34:11)
  at async _updatePlanGroupDraft (app/(student)/actions/plan-groups/update.ts:33:16)
```

**ì›ì¸**:
- `_updatePlanGroupDraft` í•¨ìˆ˜ê°€ `requireStudentAuth()`ë§Œ í˜¸ì¶œí•˜ì—¬ í•™ìƒ ê¶Œí•œë§Œ í—ˆìš©
- ê´€ë¦¬ì ëª¨ë“œì—ì„œë„ `PlanGroupWizard`ë¥¼ ì‚¬ìš©í•˜ì—¬ `updatePlanGroupDraftAction`ì„ í˜¸ì¶œ
- ê´€ë¦¬ì ëª¨ë“œì—ì„œëŠ” íŠ¹ì • í•™ìƒì„ ëŒ€ì‹ í•˜ì—¬ í”Œëœ ê·¸ë£¹ì„ ìˆ˜ì •í•´ì•¼ í•˜ë¯€ë¡œ `student_id`ê°€ í•„ìš”

### 2. ë§ˆìŠ¤í„° ì½˜í…ì¸  ì¡°íšŒ ëˆ„ë½

ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸ ê°€ ì¡°íšŒë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

**ì›ì¸**:
- `classifyPlanContents` í•¨ìˆ˜ì—ì„œ `custom` íƒ€ì…ì˜ ì½˜í…ì¸ ëŠ” `student_custom_contents`ì—ì„œë§Œ ì¡°íšŒ
- `master_custom_contents` í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•˜ì§€ ì•ŠìŒ
- `plan_contents.master_content_id`ê°€ ìˆì–´ë„ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•˜ì§€ ì•ŠìŒ

### 3. ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ë¬¸ì œ

ì œì¶œí•œ ë‚´ìš© í™•ì¸ í˜ì´ì§€ì—ì„œ ë¸”ë¡ ì„¸íŠ¸ê°€ ì¡°íšŒë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

**ì›ì¸ ë¶„ì„**:
- ì œì¶œí•œ ë‚´ìš© í™•ì¸ í˜ì´ì§€ì—ì„œëŠ” `parseCampConfiguration` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸”ë¡ ì„¸íŠ¸ë¥¼ ì¡°íšŒ
- ì´ í•¨ìˆ˜ëŠ” `resolveCampBlockSetId`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ ì¡°íšŒ
- ì¡°íšŒ ìš°ì„ ìˆœìœ„:
  1. ì—°ê²° í…Œì´ë¸”(`camp_template_block_sets`)ì—ì„œ ì§ì ‘ ì¡°íšŒ
  2. `scheduler_options.template_block_set_id` í™•ì¸
  3. `template_data.block_set_id` í™•ì¸
- `campActions.ts`ì—ì„œ ì œì¶œ ì‹œ `template_block_set_id`ë¥¼ `scheduler_options`ì— ì €ì¥í•˜ê³  ìˆìŒ
- `getPlanGroupWithDetails`ì—ì„œ `scheduler_options`ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŒ

## ğŸ›  í•´ê²° ë°©ë²•

### 1. `_updatePlanGroupDraft` í•¨ìˆ˜ ìˆ˜ì •

**íŒŒì¼**: `app/(student)/actions/plan-groups/update.ts`

ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ ê¶Œí•œë„ í—ˆìš©í•˜ë„ë¡ ìˆ˜ì •:

```typescript
async function _updatePlanGroupDraft(
  groupId: string,
  data: Partial<PlanGroupCreationData>
): Promise<void> {
  // ê¶Œí•œ í™•ì¸: í•™ìƒ ë˜ëŠ” ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸
  const currentUser = await getCurrentUser();
  if (!currentUser) {
    throw new AppError(
      "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
      ErrorCode.UNAUTHORIZED,
      401,
      true
    );
  }

  const isAdmin = currentUser.role === "admin" || currentUser.role === "consultant";
  let studentId: string;
  let userId: string;

  if (isAdmin) {
    // ê´€ë¦¬ì ëª¨ë“œ: ê¶Œí•œ í™•ì¸ ë° í”Œëœ ê·¸ë£¹ì—ì„œ student_id ì¡°íšŒ
    await requireAdminOrConsultant();
    userId = currentUser.userId;

    // í”Œëœ ê·¸ë£¹ ì¡°íšŒí•˜ì—¬ student_id í™•ì¸
    const tenantContext = await requireTenantContext();
    const result = await getPlanGroupWithDetailsForAdmin(
      groupId,
      tenantContext.tenantId
    );

    if (!result.group) {
      throw new AppError(
        "í”Œëœ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    studentId = result.group.student_id;
  } else {
    // í•™ìƒ ëª¨ë“œ: í˜„ì¬ ì‚¬ìš©ìê°€ í•™ìƒ
    const studentAuth = await requireStudentAuth();
    studentId = studentAuth.userId;
    userId = studentAuth.userId;
  }

  // ... ë‚˜ë¨¸ì§€ ë¡œì§
}
```

**ì£¼ìš” ë³€ê²½ì‚¬í•­**:
- `getCurrentUser()`ë¡œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
- ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ ê¶Œí•œ í™•ì¸ ì¶”ê°€
- ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ `getPlanGroupWithDetailsForAdmin`ë¡œ í”Œëœ ê·¸ë£¹ ì¡°íšŒí•˜ì—¬ `student_id` í™•ì¸
- í•™ìƒ ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ì¡´ì²˜ëŸ¼ `requireStudentAuth()` ì‚¬ìš©
- `updatePlanGroup` í˜¸ì¶œ ì‹œ `studentId` ì‚¬ìš© (ê´€ë¦¬ì ëª¨ë“œì—ì„œë„ ì˜¬ë°”ë¥¸ í•™ìƒ ID ì‚¬ìš©)

### 2. ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ ì¶”ê°€

**íŒŒì¼**: `lib/data/planContents.ts`

ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ ë¡œì§ ì¶”ê°€:

```typescript
// 1. ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ID ìˆ˜ì§‘
const masterCustomContentIds: string[] = [];

contents.forEach((content) => {
  if (content.content_type === "custom") {
    customContentIds.push(content.content_id);
    // plan_contentsì— ì €ì¥ëœ master_content_idê°€ ìˆìœ¼ë©´ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  IDë¡œë„ ìˆ˜ì§‘
    if (content.master_content_id) {
      masterCustomContentIds.push(content.master_content_id);
    }
    // content_id ìì²´ê°€ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§ˆìŠ¤í„° ì½˜í…ì¸  ì¡°íšŒ ëŒ€ìƒì— í¬í•¨
    masterCustomContentIds.push(content.content_id);
  }
});

// 2. ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ
const masterCustomContentsResult = uniqueMasterCustomContentIds.length > 0
  ? supabase
      .from("master_custom_contents")
      .select("id, title, subject_category, subject")
      .in("id", uniqueMasterCustomContentIds)
  : Promise.resolve({ data: [], error: null });

// 3. Mapìœ¼ë¡œ ë³€í™˜
const masterCustomContentsMap = new Map(
  (masterCustomContentsResult.data || []).map((custom) => [custom.id, custom])
);

// 4. custom íƒ€ì… ì½˜í…ì¸  ì²˜ë¦¬ ë¡œì§ ê°œì„ 
else if (content.content_type === "custom") {
  // 1. plan_contentsì— ì €ì¥ëœ master_content_idê°€ ìˆìœ¼ë©´ ìš°ì„  í™œìš©
  const masterCustomContentFromPlan = content.master_content_id
    ? masterCustomContentsMap.get(content.master_content_id)
    : null;

  // 2. content_idë¡œ í•™ìƒ ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ
  const customContent = customContentsMap.get(content.content_id);

  if (customContent) {
    // í•™ìƒ ì»¤ìŠ¤í…€ ì½˜í…ì¸ ë¥¼ ì°¾ì€ ê²½ìš°
    contentDetail = {
      content_type: "custom",
      content_id: content.content_id,
      start_range: content.start_range,
      end_range: content.end_range,
      title: customContent.title || "ì»¤ìŠ¤í…€ ì½˜í…ì¸ ",
      subject_category: customContent.content_type || null,
      isRecommended: false,
    };
  } else if (masterCustomContentFromPlan) {
    // í•™ìƒ ì»¤ìŠ¤í…€ ì½˜í…ì¸ ë¥¼ ì°¾ì§€ ëª»í–ˆì§€ë§Œ plan_contentsì— master_content_idê°€ ìˆëŠ” ê²½ìš°
    // â†’ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  (ì¶”ì²œ ì½˜í…ì¸ )
    contentDetail = {
      content_type: "custom",
      content_id: content.content_id,
      start_range: content.start_range,
      end_range: content.end_range,
      title: masterCustomContentFromPlan.title || "ì»¤ìŠ¤í…€ ì½˜í…ì¸ ",
      subject_category: masterCustomContentFromPlan.subject_category || masterCustomContentFromPlan.subject || null,
      isRecommended: true, // ë§ˆìŠ¤í„° ì½˜í…ì¸ ì´ë¯€ë¡œ ì¶”ì²œ ì½˜í…ì¸ 
      masterContentId: content.master_content_id ?? undefined,
      // ìë™ ì¶”ì²œ ì •ë³´ ì „ë‹¬
      is_auto_recommended: content.is_auto_recommended ?? false,
      recommendation_source: content.recommendation_source ?? null,
      recommendation_reason: content.recommendation_reason ?? null,
      recommendation_metadata: content.recommendation_metadata ?? null,
    };
  } else {
    // content_id ìì²´ê°€ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  IDì¸ì§€ í™•ì¸
    const masterCustomContentByContentId = masterCustomContentsMap.get(content.content_id);
    if (masterCustomContentByContentId) {
      // content_idê°€ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  IDì¸ ê²½ìš° â†’ ì¶”ì²œ ì½˜í…ì¸ 
      contentDetail = {
        content_type: "custom",
        content_id: content.content_id,
        start_range: content.start_range,
        end_range: content.end_range,
        title: masterCustomContentByContentId.title || "ì»¤ìŠ¤í…€ ì½˜í…ì¸ ",
        subject_category: masterCustomContentByContentId.subject_category || masterCustomContentByContentId.subject || null,
        isRecommended: true,
        masterContentId: content.content_id,
        // ìë™ ì¶”ì²œ ì •ë³´ ì „ë‹¬
        is_auto_recommended: content.is_auto_recommended ?? false,
        recommendation_source: content.recommendation_source ?? null,
        recommendation_reason: content.recommendation_reason ?? null,
        recommendation_metadata: content.recommendation_metadata ?? null,
      };
    } else {
      // ì •ë§ë¡œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
      missingContents.push({
        content_type: "custom",
        content_id: content.content_id,
        reason: `í•™ìƒ(${studentId})ì˜ ì»¤ìŠ¤í…€ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. master_custom_contentsì—ë„ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`,
      });
    }
  }
}
```

**ì£¼ìš” ë³€ê²½ì‚¬í•­**:
- `masterCustomContentIds` ë°°ì—´ ì¶”ê°€í•˜ì—¬ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ID ìˆ˜ì§‘
- `master_custom_contents` í…Œì´ë¸”ì—ì„œ ì¡°íšŒ ì¶”ê°€
- `masterCustomContentsMap` ìƒì„±í•˜ì—¬ ë¹ ë¥¸ ì¡°íšŒ ì§€ì›
- `custom` íƒ€ì… ì½˜í…ì¸  ì²˜ë¦¬ ë¡œì§ ê°œì„ :
  - í•™ìƒ ì»¤ìŠ¤í…€ ì½˜í…ì¸  ìš°ì„  ì¡°íšŒ
  - `plan_contents.master_content_id`ë¡œ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ
  - `content_id` ìì²´ê°€ ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  IDì¸ì§€ í™•ì¸
  - ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” ì¶”ì²œ ì½˜í…ì¸ ë¡œ ë¶„ë¥˜

### 3. ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ë¡œì§ í™•ì¸

**íŒŒì¼**: `app/(student)/camp/[invitationId]/submitted/page.tsx`

ì œì¶œí•œ ë‚´ìš© í™•ì¸ í˜ì´ì§€ì—ì„œ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ë¡œì§ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

**í˜„ì¬ ë¡œì§**:
1. `getPlanGroupWithDetails`ë¡œ í”Œëœ ê·¸ë£¹ ì¡°íšŒ
2. `scheduler_options`ê°€ `undefined`ì¸ ê²½ìš° ì§ì ‘ ì¡°íšŒ ì‹œë„
3. `parseCampConfiguration` í•¨ìˆ˜ë¡œ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
4. `resolveCampBlockSetId` í•¨ìˆ˜ë¡œ ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ (3ë‹¨ê³„ ìš°ì„ ìˆœìœ„)
5. `fetchCampTemplateBlocks` í•¨ìˆ˜ë¡œ ë¸”ë¡ ëª©ë¡ ì¡°íšŒ

**í™•ì¸ ì‚¬í•­**:
- `getPlanGroupById`ëŠ” `scheduler_options`ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŒ
- `campActions.ts`ì—ì„œ ì œì¶œ ì‹œ `template_block_set_id`ë¥¼ `scheduler_options`ì— ì €ì¥í•˜ê³  ìˆìŒ
- `parseCampConfiguration` í•¨ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ê³  ìˆìŒ

**ê²°ë¡ **:
ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ë¡œì§ì€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ë¸”ë¡ ì„¸íŠ¸ê°€ í‘œì‹œë˜ì§€ ì•ŠëŠ”ë‹¤ë©´:
1. `scheduler_options.template_block_set_id`ê°€ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
2. `camp_template_block_sets` ì—°ê²° í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
3. `tenant_block_sets`ì™€ `tenant_blocks` í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

1. `app/(student)/actions/plan-groups/update.ts`
   - `_updatePlanGroupDraft` í•¨ìˆ˜ì— ê´€ë¦¬ì ê¶Œí•œ ì§€ì› ì¶”ê°€

2. `lib/data/planContents.ts`
   - ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ ë¡œì§ ì¶”ê°€
   - `custom` íƒ€ì… ì½˜í…ì¸  ì²˜ë¦¬ ë¡œì§ ê°œì„ 

## âœ… ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ê´€ë¦¬ì ëª¨ë“œì—ì„œ í”Œëœ ê·¸ë£¹ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
- [x] í•™ìƒ ëª¨ë“œì—ì„œ í”Œëœ ê·¸ë£¹ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
- [x] ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ ê°€ëŠ¥
- [x] í•™ìƒ ì»¤ìŠ¤í…€ ì½˜í…ì¸  ì¡°íšŒ ê°€ëŠ¥
- [x] ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸ ê°€ ì¶”ì²œ ì½˜í…ì¸ ë¡œ ë¶„ë¥˜ë¨
- [x] ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ë¡œì§ í™•ì¸ ì™„ë£Œ

## ğŸ”— ê´€ë ¨ íŒŒì¼

- `app/(student)/actions/plan-groups/update.ts` - í”Œëœ ê·¸ë£¹ ì—…ë°ì´íŠ¸ ì•¡ì…˜
- `lib/data/planContents.ts` - ì½˜í…ì¸  ë¶„ë¥˜ ë° ì¡°íšŒ ë¡œì§
- `app/(student)/camp/[invitationId]/submitted/page.tsx` - ì œì¶œí•œ ë‚´ìš© í™•ì¸ í˜ì´ì§€
- `lib/camp/campAdapter.ts` - ìº í”„ ì„¤ì • íŒŒì‹± ë¡œì§
- `app/(student)/actions/campActions.ts` - ìº í”„ ì°¸ì—¬ ì •ë³´ ì œì¶œ ì•¡ì…˜

## ğŸ“ ì°¸ê³  ì‚¬í•­

- ê´€ë¦¬ì ëª¨ë“œì—ì„œ í”Œëœ ê·¸ë£¹ì„ ì—…ë°ì´íŠ¸í•  ë•ŒëŠ” `getPlanGroupWithDetailsForAdmin`ë¥¼ ì‚¬ìš©í•˜ì—¬ `student_id`ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
- ë§ˆìŠ¤í„° ì»¤ìŠ¤í…€ ì½˜í…ì¸ ëŠ” `master_custom_contents` í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•˜ë©°, ì¶”ì²œ ì½˜í…ì¸ ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
- ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒëŠ” `parseCampConfiguration` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©°, 3ë‹¨ê³„ ìš°ì„ ìˆœìœ„ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.

## ë‚ ì§œ

2025-12-22




