# 강의 상세보기 스키마 반영 작업 내용

## 작업 개요
Supabase 최신 스키마를 반영하여 강의 상세보기 페이지에 최근 추가된 필드들을 표시하도록 업데이트했습니다.

## 작업 일시
2025년 11월 30일

## 주요 작업 내용

### 1. 마이그레이션 파일 생성
- **파일**: `supabase/migrations/20251130230715_add_student_content_fields.sql`
- **내용**: 
  - `books` 테이블에 마스터 교재 필드 추가 (30개 이상 필드)
  - `lectures` 테이블에 마스터 강의 필드 추가 (20개 이상 필드)
  - 타임스탬프 타입 변경 (timestamp without time zone → timestamp with time zone)
  - 외래키 제약조건 추가
  - 인덱스 추가
  - 마스터 데이터에서 학생 데이터로 값 복사

### 2. 타입 정의 업데이트
- **파일**: `app/types/content.ts`
- **변경사항**:
  - `Book` 타입에 마스터 교재 필드 추가
  - `Lecture` 타입에 마스터 강의 필드 추가
  - 새로운 필드들: `lecture_source_url`, `instructor_name`, `grade_level`, `lecture_type`, `content_category` 등

### 3. 학생 강의 상세보기 페이지 업데이트
- **파일**: `app/(student)/contents/lectures/[id]/page.tsx`
- **변경사항**:
  - `master_lecture_id`가 있으면 마스터 강의 정보도 함께 조회
  - 마스터 강의 정보를 학생 강의 정보와 병합
  - 새로운 필드들을 select 쿼리에 추가
  - `masterLecture` prop을 `LectureDetailTabs`에 전달

### 4. 학생 강의 정보 섹션 UI 업데이트
- **파일**: `app/(student)/contents/lectures/[id]/_components/LectureInfoSection.tsx`
- **변경사항**:
  - 새로운 필드들 표시 추가:
    - 출처 URL (`lecture_source_url`)
    - 강사명 (`instructor_name`)
    - 대상 학년 (`grade_level`)
    - 강의 유형 (`lecture_type`)
    - 콘텐츠 카테고리 (`content_category`)
    - 부제목 (`subtitle`)
    - 시리즈명 (`series_name`)
    - 설명 (`description`)
    - 총 강의시간 (`total_duration`)

### 5. 관리자 마스터 강의 상세보기 페이지 업데이트
- **파일**: `app/(admin)/admin/master-lectures/[id]/page.tsx`
- **변경사항**:
  - `ContentDetailTable`에 최신 필드들 추가
  - 출처 URL, 강사명, 대상 학년, 강의 유형 등 표시

### 6. 컴포넌트 Props 업데이트
- **파일**: `app/(student)/contents/lectures/[id]/_components/LectureDetailTabs.tsx`
- **변경사항**:
  - `masterLecture` prop 추가
  - `MasterLecture` 타입 import 추가

## 추가된 필드 목록

### lectures 테이블에 추가된 필드
- `content_category` - 콘텐츠 카테고리
- `lecture_type` - 강의 유형
- `subtitle` - 부제목
- `series_name` - 시리즈명
- `instructor_name` - 강사명
- `description` - 설명
- `toc` - 목차
- `curriculum_revision_id` - 교육과정 개정 ID
- `subject_id` - 과목 ID
- `subject_group_id` - 교과 그룹 ID
- `grade_level` - 대상 학년
- `platform_id` - 플랫폼 ID
- `lecture_source_url` - 출처 URL
- `source` - 출처
- `source_product_code` - 출처 상품 코드
- `cover_image_url` - 표지 이미지 URL
- `total_duration` - 총 강의 시간 (초)
- `video_url` - 비디오 URL
- `transcript` - 전사본
- `episode_analysis` - 회차 분석 데이터
- `overall_difficulty` - 전체 난이도
- `target_exam_type` - 대상 시험 유형 배열
- `tags` - 태그 배열
- `is_active` - 활성화 여부

### books 테이블에 추가된 필드
- `content_category` - 콘텐츠 카테고리
- `subtitle` - 부제목
- `series_name` - 시리즈명
- `author` - 저자
- `description` - 설명
- `toc` - 목차
- `publisher_review` - 출판사 리뷰
- `publisher_id` - 출판사 ID
- `publisher_name` - 출판사명
- `isbn_10` - ISBN-10
- `isbn_13` - ISBN-13
- `edition` - 판본
- `published_date` - 출판일
- `curriculum_revision_id` - 교육과정 개정 ID
- `subject_id` - 과목 ID
- `subject_group_id` - 교과 그룹 ID
- `grade_min` - 최소 학년
- `grade_max` - 최대 학년
- `school_type` - 학교 유형
- `source` - 출처
- `source_product_code` - 출처 상품 코드
- `source_url` - 출처 URL
- `cover_image_url` - 표지 이미지 URL
- `target_exam_type` - 대상 시험 유형 배열
- `tags` - 태그 배열
- `pdf_url` - PDF URL
- `ocr_data` - OCR 데이터
- `page_analysis` - 페이지 분석 데이터
- `overall_difficulty` - 전체 난이도
- `is_active` - 활성화 여부

## 주의사항

### 마이그레이션 적용
마이그레이션 파일이 생성되었지만, 아직 적용되지 않았습니다. 다음 명령어로 적용하세요:

```bash
# Supabase CLI 사용 시
supabase db push

# 또는 직접 SQL 실행
psql -h [host] -U [user] -d [database] -f supabase/migrations/20251130230715_add_student_content_fields.sql
```

### 스키마 불일치
사용자가 제공한 `master_lectures` 스키마와 실제 DB 스키마가 일부 다릅니다:
- 실제 DB에는 `instructor` 필드가 있지만, 스키마에는 `instructor_name`으로 표시됨
- 실제 DB에는 `source_url` 필드가 있지만, 스키마에는 `lecture_source_url`로 표시됨
- `lecture_type`, `grade_level` 필드는 실제 DB에 없을 수 있음

마이그레이션 파일에서는 실제 DB 필드명을 사용하도록 수정했습니다:
- `instructor_name = ml.instructor`
- `lecture_source_url = ml.source_url`

### 타임스탬프 타입 변경
`created_at`, `updated_at` 필드의 타입이 `timestamp without time zone`에서 `timestamp with time zone`으로 변경됩니다.
기존 데이터는 자동으로 변환되지만, 애플리케이션 코드에서 타임존 처리를 확인해야 합니다.

## 다음 단계

1. 마이그레이션 적용 확인
2. 애플리케이션 테스트
3. 타임스탬프 타입 변경 후 동작 확인
4. 외래키 제약조건 정상 작동 확인

