# 전략/취약 설정 초기 체크 제거

## 작업 일자
2025-12-04

## 문제 상황

Step 6에서 전략/취약 설정의 초기 체크 상태가 문제였습니다:

1. **UI에서 체크되어 보임**: `getEffectiveAllocation` 함수가 기본값으로 "weakness"를 반환하여 UI에서 라디오 버튼이 체크되어 보였습니다.

2. **검증 로직 실패**: 하지만 실제로 `data.content_allocations`나 `data.subject_allocations`에는 값이 없어서 검증 로직에서 "전략과목/취약과목 정보를 설정해주세요." 에러가 발생했습니다.

3. **사용자 혼란**: 사용자가 체크되어 있다고 생각하고 다음 단계로 진행했지만, 검증 에러가 발생하여 혼란이 생겼습니다.

## 해결 방법

초기 로드 시 자동으로 기본값(취약과목)을 `content_allocations`에 저장하도록 변경했습니다:

1. **초기화 로직 추가**: `SubjectAllocationEditor` 컴포넌트에 `useEffect`를 추가하여 마운트 시 초기화를 수행합니다.

2. **조건 확인**: `content_allocations`와 `subject_allocations`가 모두 비어있는 경우에만 자동 저장을 수행합니다.

3. **무한 루프 방지**: `useRef`를 사용하여 초기화 여부를 추적하고, 한 번만 실행되도록 보장합니다.

## 수정된 코드

### `app/(student)/plan/new-group/_components/Step6Simplified.tsx`

```typescript
// 초기화 여부 추적을 위한 ref
const hasInitialized = useRef(false);

// 초기 로드 시 기본값 자동 저장
useEffect(() => {
  // 이미 초기화되었거나 콘텐츠가 없으면 스킵
  if (hasInitialized.current || contentInfos.length === 0) {
    return;
  }

  // 초기화 조건 확인: content_allocations와 subject_allocations가 모두 비어있는 경우
  const hasContentAllocations = (data.content_allocations || []).length > 0;
  const hasSubjectAllocations = (data.subject_allocations || []).length > 0;
  
  if (!hasContentAllocations && !hasSubjectAllocations) {
    // 모든 콘텐츠에 대해 기본값(취약과목)을 content_allocations에 자동으로 추가
    const defaultContentAllocations = contentInfos.map((content) => ({
      content_type: content.content_type as "book" | "lecture",
      content_id: content.content_id,
      subject_type: "weakness" as const,
      weekly_days: undefined,
    }));
    
    onUpdate({ content_allocations: defaultContentAllocations });
    hasInitialized.current = true;
  } else {
    // 이미 데이터가 있으면 초기화 완료로 표시
    hasInitialized.current = true;
  }
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [contentInfos, data.content_allocations, data.subject_allocations]);
```

## 구현 세부사항

### 초기화 조건

- `content_allocations`가 비어있고
- `subject_allocations`가 비어있고
- `contentInfos`에 콘텐츠가 있는 경우

### 자동 추가되는 기본값

- `subject_type: "weakness"`
- `weekly_days: undefined`

### 무한 루프 방지

- `useRef`를 사용하여 `hasInitialized.current`로 초기화 여부를 추적
- 이미 초기화되었으면 스킵
- 의존성 배열에서 `onUpdate`를 제거하고 eslint-disable 주석 추가

## 개선 효과

1. ✅ **검증 통과**: 초기 로드 시 자동으로 `content_allocations`에 기본값이 저장되어 검증 로직을 통과합니다.

2. ✅ **사용자 혼란 제거**: UI에서 체크되어 보이는 상태와 실제 데이터 상태가 일치합니다.

3. ✅ **편집 모드 지원**: 이미 데이터가 있는 경우(편집 모드 등)에는 자동 추가하지 않아 기존 설정을 유지합니다.

4. ✅ **성능 최적화**: `useRef`를 사용하여 한 번만 실행되도록 보장합니다.

## 테스트 시나리오

1. **초기 로드 시**
   - Step 6에 처음 진입
   - `content_allocations`와 `subject_allocations`가 모두 비어있음
   - 모든 콘텐츠에 대해 기본값(취약과목)이 자동으로 `content_allocations`에 추가됨
   - UI에서 취약과목이 체크되어 보임
   - 검증 로직 통과

2. **편집 모드**
   - 이미 설정이 있는 경우
   - 자동 추가하지 않음
   - 기존 설정 유지

3. **사용자 선택**
   - 사용자가 전략과목으로 변경
   - `content_allocations`가 업데이트됨
   - 검증 로직 통과

## 수정된 파일

1. `app/(student)/plan/new-group/_components/Step6Simplified.tsx`
   - `useRef` import 추가
   - `SubjectAllocationEditor`에 초기화 로직 추가
   - `useEffect`를 사용하여 초기 로드 시 기본값 자동 저장

