# 일괄 설정 및 플랜 생성 위저드 구현

## 작업 일자

2025-12-04

## 작업 내용

관리자가 다수 학생에게 콘텐츠 추천, 범위 조절, 플랜 미리보기 및 생성을 단계별로 처리할 수 있는 위저드 형태의 통합 워크플로우를 구현했습니다.

## 주요 변경 사항

### 1. 범위 추천 로직 분리

**파일**: `lib/plan/rangeRecommendation.ts` (신규)

- `Step6FinalReview`의 범위 추천 로직을 별도 함수로 분리
- `calculateRecommendedRanges`: 스케줄 정보 기반으로 자동 범위 계산
- `getUnavailableReason`: 범위 추천이 불가능한 이유 반환

### 2. 위저드 컴포넌트 생성

#### 2.1 메인 위저드 컴포넌트

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/_components/BatchPlanWizard.tsx` (신규)

- 위저드 형태의 통합 워크플로우 컴포넌트
- 4단계 진행: 콘텐츠 추천 설정 → 범위 조절 → 플랜 미리보기 → 결과
- 단계별 진행 상태 표시
- 각 단계에서 이전 단계로 돌아가기 가능

#### 2.2 Step 1: 콘텐츠 추천 설정

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/_components/Step1ContentRecommendation.tsx` (신규)

- 기존 `BulkRecommendContentsModal`의 로직 활용
- 학생별 교과/수량 설정 테이블
- 전체 조율 및 개별 조율 기능
- 최대 9개 제한 검증
- "다음 단계" 클릭 시 콘텐츠 추천 적용 후 Step 2로 진행

#### 2.3 Step 2: 범위 조절

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/_components/Step2RangeAdjustment.tsx` (신규)

- Step 1에서 설정한 콘텐츠 목록 표시
- 각 콘텐츠에 대해 자동 계산된 범위 표시 (스케줄 정보 기반)
- 범위 수정 가능 (start_range, end_range)
- "추천 적용" 버튼으로 자동 추천 범위 적용
- 범위 유효성 검증 (start_range < end_range, 콘텐츠 최대 범위 내)

#### 2.4 Step 3: 플랜 미리보기

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/_components/Step3PlanPreview.tsx` (신규)

- 범위 조절 저장 (플랜 미리보기 전에 자동 실행)
- 각 학생의 플랜 그룹에 대해 플랜 미리보기 실행
- 생성될 플랜의 요약 정보 표시 (플랜 수)
- 학생별로 플랜 생성 여부 체크박스
- 미리보기 실패 시 오류 메시지 표시

#### 2.5 Step 4: 결과 화면

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/_components/Step4Results.tsx` (신규)

- 각 학생별 처리 결과 테이블
- 단계별 결과 표시:
  - 콘텐츠 추천: 성공/실패
  - 범위 조절: 성공/실패
  - 플랜 생성: 성공/실패
- 전체 통계 (성공 수, 실패 수)
- 실패한 학생의 오류 메시지 표시

### 3. 서버 액션 추가

**파일**: `app/(admin)/actions/campTemplateActions.ts`

#### 3.1 범위 일괄 조절 액션

```typescript
export const bulkAdjustPlanRanges = withErrorHandling(
  async (
    groupIds: string[],
    rangeAdjustments: Record<string, Array<{
      contentId: string;
      contentType: "book" | "lecture";
      startRange?: number;
      endRange?: number;
    }>>
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ groupId: string; error: string }>;
  }>
)
```

- 각 플랜 그룹의 콘텐츠 범위를 일괄 업데이트
- `plan_contents` 테이블의 `start_range`, `end_range` 업데이트
- 범위 유효성 검증 (start_range < end_range)

#### 3.2 플랜 일괄 미리보기 액션

```typescript
export const bulkPreviewPlans = withErrorHandling(
  async (
    groupIds: string[]
  ): Promise<{
    success: boolean;
    previews: Array<{
      groupId: string;
      studentName: string;
      planCount: number;
      previewData?: Array<any>;
      error?: string;
    }>;
  }>
)
```

- 다수 플랜 그룹에 대해 플랜 미리보기 실행
- 기존 `previewPlansFromGroupAction` 로직 활용
- 각 학생별 미리보기 결과 반환

#### 3.3 플랜 일괄 생성 액션

```typescript
export const bulkGeneratePlans = withErrorHandling(
  async (
    groupIds: string[]
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ groupId: string; error: string }>;
  }>
)
```

- 다수 플랜 그룹에 대해 플랜 생성 실행
- 기존 `generatePlansFromGroupAction` 로직 활용
- 각 학생별 생성 결과 반환

### 4. 참여자 목록 페이지 재구성

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx`

#### 변경 사항:

- "일괄 설정 및 플랜 생성" 버튼 추가 (위저드 열기)
- 기존 "추천 콘텐츠 일괄 적용" 버튼은 "추천 콘텐츠만 적용"으로 변경 (기존 기능 유지)
- 버튼 클릭 시 `BatchPlanWizard` 모달 열기
- 위저드 완료 후 참여자 목록 새로고침

## 데이터 흐름

1. **Step 1 완료** → 콘텐츠 추천 설정 저장 (`bulkApplyRecommendedContents`)
2. **Step 2 완료** → 범위 조절 데이터 수집 (아직 저장 안 함)
3. **Step 3 완료** → 범위 조절 저장 (`bulkAdjustPlanRanges`) → 플랜 미리보기 실행 (`bulkPreviewPlans`)
4. **Step 4 완료** → 플랜 생성 실행 (`bulkGeneratePlans`)

## 파일 목록

### 신규 파일

- `lib/plan/rangeRecommendation.ts` - 범위 추천 로직 분리
- `app/(admin)/admin/camp-templates/[id]/participants/_components/BatchPlanWizard.tsx` - 메인 위저드
- `app/(admin)/admin/camp-templates/[id]/participants/_components/Step1ContentRecommendation.tsx` - Step 1
- `app/(admin)/admin/camp-templates/[id]/participants/_components/Step2RangeAdjustment.tsx` - Step 2
- `app/(admin)/admin/camp-templates/[id]/participants/_components/Step3PlanPreview.tsx` - Step 3
- `app/(admin)/admin/camp-templates/[id]/participants/_components/Step4Results.tsx` - Step 4

### 수정 파일

- `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx` - 위저드 버튼 추가
- `app/(admin)/actions/campTemplateActions.ts` - 서버 액션 추가

## 참고사항

- 기존 `BulkRecommendContentsModal`은 유지 (단독 사용 가능)
- 위저드는 선택적 사용 (기존 기능과 병행)
- 각 단계에서 이전 단계로 돌아가기 가능
- 단계별 검증 및 오류 처리
- 진행 상태 표시 (로딩, 성공, 실패)

