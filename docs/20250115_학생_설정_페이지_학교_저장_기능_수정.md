# 학생 설정 페이지 학교 저장 기능 수정

## 📅 작업 일시
2025-01-15

## 🐛 문제점

학생 설정 페이지(`/settings`)에서 학교 검색 후 저장하는 기능이 제대로 동작하지 않았습니다. 특히 다른 복합 필드(희망 대학교 등)와 함께 저장할 때 문제가 발생했습니다.

### 원인 분석

1. **`BasicInfoSection.tsx`의 문제**:
   - `SchoolSelect` 컴포넌트의 `onChange` prop이 빈 함수로 전달되어 `formData.school_id`가 업데이트되지 않았습니다.
   - `onSchoolSelect` 콜백만으로는 `SchoolSelect` 내부의 `onChange` 호출과 동기화가 보장되지 않았습니다.

2. **데이터 흐름 문제**:
   - `SchoolSelect` 컴포넌트 내부의 `handleSelect` 함수는 `onChange(school.id || school.name)`을 호출합니다.
   - 하지만 `onChange`가 빈 함수였기 때문에 폼 상태가 업데이트되지 않았습니다.

## ✅ 수정 내용

### 1. `handleSchoolChange` 함수 추가

`SchoolSelect`의 `onChange`에서 호출되는 핸들러를 구현했습니다:

```typescript
const handleSchoolChange = useCallback(
  (value: string) => {
    // SchoolSelect는 school.id 또는 school.name을 전달
    // ID 형식인지 확인 (SCHOOL_123 또는 UNIV_456)
    const isUnifiedId = /^(SCHOOL_|UNIV_)\d+$/.test(value);
    const schoolId = isUnifiedId ? value : "";
    
    updateFormData({ school_id: schoolId });
    
    // 에러가 있으면 제거
    if (errors.school_id) {
      setErrors((prev) => ({ ...prev, school_id: undefined }));
    }
  },
  [updateFormData, errors, setErrors]
);
```

### 2. `handleSchoolSelect` 함수 개선

`onSchoolSelect` 콜백에서도 `school_id`를 확실히 업데이트하도록 개선했습니다:

```typescript
const handleSchoolSelect = useCallback(
  async (school: { id: string; name: string; type?: "중학교" | "고등학교" | "대학교" | null }) => {
    // school_id 업데이트 (이미 handleSchoolChange에서 처리되지만, 확실히 하기 위해)
    updateFormData({ school_id: school.id || "" });
    
    // 학교 타입 조회 및 설정
    if (school.type === "중학교" || school.type === "고등학교") {
      setSchoolType(school.type);
    } else {
      setSchoolType(undefined);
    }
  },
  [updateFormData, setSchoolType]
);
```

### 3. `SchoolSelect` 컴포넌트 연결

`onChange` prop에 `handleSchoolChange`를 연결했습니다:

```tsx
<SchoolSelect
  value={formData.school_id}
  onChange={handleSchoolChange}
  onSchoolSelect={handleSchoolSelect}
  placeholder="학교를 검색하세요"
/>
```

## 🔍 수정된 파일

- `app/(student)/settings/_components/sections/BasicInfoSection.tsx`

## ✨ 개선 효과

1. **학교 선택 시 폼 상태 동기화**: `SchoolSelect`에서 학교를 선택하면 `formData.school_id`가 즉시 업데이트됩니다.
2. **복합 필드 저장 안정성**: 다른 필드(희망 대학교 등)와 함께 저장할 때도 학교 정보가 정확히 저장됩니다.
3. **ID 형식 검증**: 통합 ID 형식(`SCHOOL_123`, `UNIV_456`)을 확인하여 올바른 ID만 저장합니다.

## 🧪 테스트 시나리오

1. ✅ 학교 검색 후 선택 → `formData.school_id` 업데이트 확인
2. ✅ 학교 선택 후 다른 필드 수정 → 함께 저장 시 정상 동작 확인
3. ✅ 희망 대학교와 함께 저장 → 모든 필드 정상 저장 확인
4. ✅ 학교 선택 후 저장 → DB에 정확히 저장되는지 확인

## 📝 참고사항

- `SchoolSelect` 컴포넌트는 `onChange`와 `onSchoolSelect` 두 가지 콜백을 제공합니다.
- `onChange`: 학교 선택 시 ID 또는 이름을 전달 (컴포넌트 내부 `handleSelect`에서 호출)
- `onSchoolSelect`: 학교 객체 전체를 전달 (추가 처리용)
- 두 콜백 모두에서 `school_id`를 업데이트하여 동기화를 보장합니다.





