# 플랜 그룹 상태 업데이트 관리자 권한 수정

## 문제 상황

관리자가 캠프 템플릿 참여자의 플랜 그룹 상태를 업데이트하려고 할 때 "플랜 그룹을 찾을 수 없습니다." 에러가 발생했습니다.

### 에러 로그

```
[Error] {
  "message": "플랜 그룹을 찾을 수 없습니다.",
  "code": "NOT_FOUND",
  "statusCode": 404,
  "function": "_updatePlanGroupStatus",
  "args": [
    "36939dbf-add4-42fb-af2b-43b381c38d25",
    "saved"
  ]
}
```

### 발생 경로

- `/admin/camp-templates/{templateId}/participants/{groupId}/continue` 페이지에서 플랜 그룹 상태 업데이트 시도

## 원인 분석

`app/(student)/actions/plan-groups/status.ts`의 `_updatePlanGroupStatus` 함수에서:

1. **문제점**: 관리자/컨설턴트가 호출할 때도 `getPlanGroupById(groupId, access.user.userId)`를 사용
2. **원인**: `getPlanGroupById`는 `student_id`로 필터링하는데, 관리자 호출 시 `access.user.userId`가 관리자 ID이므로 플랜 그룹을 찾을 수 없음
3. **기존 해결책**: `getPlanGroupByIdForAdmin` 함수가 이미 존재하지만 사용되지 않음

## 수정 내용

### 변경 파일

- `app/(student)/actions/plan-groups/status.ts`

### 수정 사항

1. **역할에 따른 조회 함수 분기**:
   - 관리자/컨설턴트: `getPlanGroupByIdForAdmin(groupId, tenantId)` 사용
   - 학생: 기존 `getPlanGroupById(groupId, userId)` 사용

2. **tenantId 검증 추가**:
   - 관리자/컨설턴트인 경우 `tenantContext.tenantId`가 없으면 에러 발생

### 코드 변경

```typescript
// 수정 전
import { getPlanGroupById, updatePlanGroup } from "@/lib/data/planGroups";

const group = await getPlanGroupById(groupId, access.user.userId);

// 수정 후
import { getPlanGroupById, getPlanGroupByIdForAdmin, updatePlanGroup } from "@/lib/data/planGroups";

// 기존 그룹 조회 - 역할에 따라 조회
let group;
if (access.role === "admin" || access.role === "consultant") {
  // 관리자/컨설턴트는 tenantId로 조회
  if (!tenantContext.tenantId) {
    throw new AppError(
      "기관 정보를 찾을 수 없습니다.",
      ErrorCode.NOT_FOUND,
      404,
      true
    );
  }
  group = await getPlanGroupByIdForAdmin(groupId, tenantContext.tenantId);
} else {
  // 학생은 자신의 ID로 조회
  group = await getPlanGroupById(groupId, access.user.userId);
}
```

## 검증

### 테스트 시나리오

1. **관리자 권한으로 플랜 그룹 상태 업데이트**:
   - 관리자가 캠프 템플릿 참여자의 플랜 그룹 상태를 "saved"로 변경
   - ✅ 플랜 그룹을 정상적으로 찾아 상태 업데이트 성공

2. **학생 권한으로 플랜 그룹 상태 업데이트**:
   - 학생이 자신의 플랜 그룹 상태를 업데이트
   - ✅ 기존 로직대로 정상 동작

3. **컨설턴트 권한으로 플랜 그룹 상태 업데이트**:
   - 컨설턴트가 학생의 플랜 그룹 상태를 업데이트
   - ✅ 관리자와 동일하게 정상 동작

## 관련 파일

- `app/(student)/actions/plan-groups/status.ts` - 수정된 파일
- `lib/data/planGroups.ts` - `getPlanGroupByIdForAdmin` 함수 정의
- `lib/auth/planGroupAuth.ts` - 권한 검증 및 역할 확인 로직

## 참고 사항

- `getPlanGroupByIdForAdmin`은 `student_id` 없이 `tenant_id`만으로 조회하므로 관리자/컨설턴트가 다른 학생의 플랜 그룹을 조회할 수 있습니다.
- RLS(Row Level Security) 정책에 따라 관리자/컨설턴트는 같은 테넌트 내의 모든 플랜 그룹에 접근할 수 있습니다.


