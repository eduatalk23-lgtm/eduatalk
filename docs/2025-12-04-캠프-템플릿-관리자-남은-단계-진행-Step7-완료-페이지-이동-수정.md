# 캠프 템플릿 관리자 남은 단계 진행 Step 7 완료 페이지 이동 수정

## 작업 일자
2025-12-04

## 문제 상황
관리자 모드에서 캠프 템플릿 참가자의 남은 단계 진행 중 마지막 단계(Step 7) 완료 시 페이지 이동이 정상적으로 작동하지 않는 문제가 발생했습니다.

### 증상
- Step 7 완료 버튼 클릭 시 페이지 이동이 되지 않음
- 플랜 생성 후 참여자 목록 페이지로 이동해야 하지만 이동하지 않음

## 원인 분석

### 1. Step 7 렌더링 조건 문제
- `PlanGroupWizard.tsx`에서 Step 7 컴포넌트(`Step7ScheduleResult`)가 `currentStep === 6`일 때 렌더링되고 있었음
- 실제로는 `currentStep === 7`일 때 렌더링되어야 함

### 2. Step 7 완료 콜백 처리 문제
- 관리자 continue 모드에서 Step 7 완료 시 `onComplete` 콜백이 일반 모드(학생 모드) 로직만 처리
- `handleSubmit(true)`를 호출하더라도 `startTransition` 내부에서 비동기로 실행되어 페이지 이동이 완료되기 전에 함수가 종료됨
- `onComplete`에서 직접 `continueCampStepsForAdmin`을 호출하고 참여자 목록 페이지로 이동해야 함

### 3. 플랜 생성 중복 처리 문제
- `continueCampStepsForAdmin` 함수에서 Step 7일 때 플랜이 이미 생성되어 있으면 에러 발생
- 플랜이 이미 생성되어 있으면 플랜 생성 로직을 스킵해야 함

## 수정 내용

### 1. Step 7 렌더링 조건 수정
**파일**: `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`

```typescript
// 수정 전
{currentStep === 6 && draftGroupId && (!isCampMode || isAdminContinueMode) && (
  <Step7ScheduleResult ... />
)}

// 수정 후
{currentStep === 7 && draftGroupId && (!isCampMode || isAdminContinueMode) && (
  <Step7ScheduleResult ... />
)}
```

### 2. 관리자 continue 모드 Step 7 완료 처리 추가
**파일**: `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`

`handleSubmit`을 거치지 않고 `onComplete`에서 직접 플랜 생성 및 페이지 이동을 처리하도록 수정:

```typescript
onComplete={async () => {
  // 관리자 continue 모드에서는 직접 플랜 생성 및 페이지 이동 처리
  if (isAdminContinueMode) {
    startTransition(async () => {
      try {
        const { continueCampStepsForAdmin } = await import("@/app/(admin)/actions/campTemplateActions");
        const result = await continueCampStepsForAdmin(
          draftGroupId || (initialData?.groupId as string),
          wizardData,
          currentStep
        );

        if (result.success) {
          toast.showSuccess("저장되었습니다.");
          // templateId를 initialData에서 가져오기
          const templateId = initialData?.templateId;
          if (templateId) {
            router.push(`/admin/camp-templates/${templateId}/participants`, { scroll: true });
          } else {
            router.push(`/admin/camp-templates`, { scroll: true });
          }
        } else {
          const errorMessage = result.error || "저장에 실패했습니다.";
          setValidationErrors([errorMessage]);
          toast.showError(errorMessage);
        }
      } catch (error) {
        console.error("[PlanGroupWizard] 관리자 캠프 남은 단계 진행 실패:", error);
        const errorMessage = error instanceof Error ? error.message : "저장에 실패했습니다.";
        setValidationErrors([errorMessage]);
        toast.showError(errorMessage);
      }
    });
    return;
  }

  // 일반 모드(학생 모드)에서는 기존 로직 유지
  // ...
}}
```

이렇게 수정하면:
- `onComplete`에서 직접 `continueCampStepsForAdmin`을 호출하여 플랜 생성 완료를 기다림
- 플랜 생성 성공 후 즉시 참여자 목록 페이지로 이동
- `handleSubmit`의 복잡한 로직을 거치지 않아 더 명확하고 안정적

### 3. 플랜 생성 중복 처리 방지
**파일**: `app/(admin)/actions/campTemplateActions.ts`

#### 3-1. Step 7이 아닌 경우에만 플랜 생성 여부 확인

```typescript
// 수정 전
if (plans && plans.length > 0) {
  throw new AppError(
    "이미 플랜이 생성된 그룹은 수정할 수 없습니다.",
    ErrorCode.VALIDATION_ERROR,
    400,
    true
  );
}

// 수정 후
const hasPlans = plans && plans.length > 0;

// Step 7이 아닌 경우에만 플랜 생성 여부 확인 (Step 7에서는 플랜 생성이 목적이므로 허용)
if (hasPlans && step !== 7) {
  throw new AppError(
    "이미 플랜이 생성된 그룹은 수정할 수 없습니다.",
    ErrorCode.VALIDATION_ERROR,
    400,
    true
  );
}
```

#### 3-2. 플랜 생성 전 이미 생성된 플랜 확인 후 스킵

```typescript
// 플랜이 이미 생성되어 있는지 확인
const { data: existingPlans } = await supabase
  .from("student_plan")
  .select("id")
  .eq("plan_group_id", groupId)
  .limit(1);

const plansAlreadyExist = existingPlans && existingPlans.length > 0;

// 플랜이 이미 생성되어 있으면 플랜 생성 스킵
if (!plansAlreadyExist) {
  // 플랜 생성 로직
  await generatePlansFromGroupAction(groupId);
  // ...
} else {
  console.log("[campTemplateActions] 플랜이 이미 생성되어 있어 플랜 생성 스킵:", {
    groupId,
    existingPlansCount: existingPlans?.length || 0,
  });
}
```

## 동작 흐름

### 수정 전
1. Step 7 완료 버튼 클릭
2. `onComplete` 콜백 호출 (일반 모드 로직만 처리)
3. 플랜 생성 확인 및 활성화 처리 (관리자 모드에서 불필요)
4. 페이지 이동 실패

### 수정 후
1. Step 7 완료 버튼 클릭
2. `onComplete` 콜백 호출
3. 관리자 continue 모드 확인
4. `startTransition` 내부에서 `continueCampStepsForAdmin` 함수 호출
5. Step 7일 때 플랜 생성 여부 확인
6. 플랜이 없으면 플랜 생성 수행
7. 플랜이 이미 있으면 플랜 생성 스킵
8. 성공 시 참여자 목록 페이지(`/admin/camp-templates/{templateId}/participants`)로 즉시 이동

## 테스트 시나리오

### 시나리오 1: Step 7 완료 시 플랜 생성 및 페이지 이동
1. 관리자 모드에서 캠프 템플릿 참가자 남은 단계 진행 페이지 접근
2. Step 7까지 진행
3. 완료 버튼 클릭
4. 플랜이 생성되고 참여자 목록 페이지로 이동하는지 확인

### 시나리오 2: Step 7 완료 시 이미 플랜이 생성된 경우
1. 관리자 모드에서 캠프 템플릿 참가자 남은 단계 진행 페이지 접근
2. Step 7까지 진행 (플랜이 이미 생성되어 있는 상태)
3. 완료 버튼 클릭
4. 플랜 생성 스킵 후 참여자 목록 페이지로 이동하는지 확인

### 시나리오 3: 일반 모드(학생 모드) 동작 확인
1. 학생 모드에서 캠프 참여 완료 페이지 접근
2. Step 7까지 진행
3. 완료 버튼 클릭
4. 기존 로직대로 동작하는지 확인 (플랜 활성화 및 상세 페이지 이동)

## 관련 파일
- `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`
- `app/(admin)/actions/campTemplateActions.ts`

## 참고 사항
- Step 6과 Step 7의 렌더링 조건을 명확히 구분하여 버그 방지
- 관리자 continue 모드와 일반 모드의 완료 처리 로직을 분리하여 유지보수성 향상
- 플랜 생성 중복 방지를 통해 불필요한 에러 발생 방지

