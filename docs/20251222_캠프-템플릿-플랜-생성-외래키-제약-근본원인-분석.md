# 캠프 템플릿 플랜 생성 외래 키 제약 조건 위반 근본 원인 분석

**작업 일시**: 2024년 12월 22일  
**작업자**: AI Assistant

## 📋 문제 상황

관리자가 캠프 템플릿 참여자의 남은 단계를 진행할 때(`continueCampStepsForAdmin`) 플랜 생성 중 외래 키 제약 조건 위반 에러가 발생했습니다.

### 에러 메시지

```
Error [AppError]: 플랜 저장에 실패했습니다. Referenced lecture (048f5e20-be95-4868-adcb-5a486685845a) does not exist
```

## 🔍 근본 원인 분석

### 데이터 흐름

1. **콘텐츠 저장 단계** (`savePlanContents`)
   - `validateAndResolveContent`를 통해 마스터 콘텐츠를 학생 콘텐츠로 복사
   - `actualContentId` (학생 콘텐츠 ID)를 `plan_contents.content_id`에 저장 ✅
   - 예: 마스터 강의 ID `048f5e20-be95-4868-adcb-5a486685845a` → 학생 강의 ID `abc123...`

2. **플랜 생성 단계** (`generatePlansRefactored`)
   - `getPlanGroupWithDetailsByRole`을 통해 `plan_contents`에서 콘텐츠 조회
   - 조회된 `content_id`는 이미 학생 콘텐츠 ID ✅
   - `contentIdMap` 생성 시 이 ID를 `lectures` 테이블에서 직접 조회

### 근본 원인

**문제 1: `contentIdMap` 생성 로직의 불완전성**

`generatePlansRefactored.ts`에서 `contentIdMap`을 생성할 때:

```typescript
// 1. content_id를 학생 콘텐츠 ID로 직접 조회
const [directBooksResult, directLecturesResult, ...] = await Promise.all([
  queryClient.from("books")
    .in("id", bookContents.map((c) => c.content_id)) // ✅ 올바름
    .eq("student_id", studentId),
  queryClient.from("lectures")
    .in("id", lectureContents.map((c) => c.content_id)) // ✅ 올바름
    .eq("student_id", studentId),
  // ...
]);

// 2. 직접 조회한 결과를 contentIdMap에 매핑
(directLecturesResult.data || []).forEach((l) => {
  contentIdMap.set(l.id, l.id); // ✅ 올바름
});
```

**하지만 문제는:**
- `plan_contents`에 저장된 `content_id`가 실제로 `lectures` 테이블에 존재하는지 확인하지 않음
- RLS(Row Level Security) 정책으로 인해 조회가 실패할 수 있음
- 또는 해당 학생의 강의가 실제로 존재하지 않을 수 있음

**문제 2: 마스터 콘텐츠 복사 실패 시 처리**

마스터 콘텐츠 복사가 실패한 경우:
- `savePlanContents`에서 `isValid = false`로 설정하여 콘텐츠 제외 ✅
- 하지만 이미 `plan_contents`에 저장된 경우가 있을 수 있음
- 또는 복사는 성공했지만 나중에 삭제된 경우

**문제 3: `contentIdMap`에 없는 콘텐츠 처리**

플랜 생성 시 `contentIdMap`에 없는 콘텐츠는 제외하도록 수정했지만:
- 제외된 콘텐츠가 많으면 플랜이 생성되지 않음
- 또는 일부 콘텐츠만 제외되어 불완전한 플랜이 생성됨

## 🛠 해결 방법

### 1. `contentIdMap` 생성 로직 개선

**현재 로직:**
```typescript
// 직접 조회한 결과를 contentIdMap에 매핑
(directLecturesResult.data || []).forEach((l) => {
  contentIdMap.set(l.id, l.id);
});
```

**개선 방안:**
- 조회 결과가 없으면 해당 콘텐츠를 로그로 기록
- `contentIdMap`에 매핑하지 않아 플랜 생성 시 자동으로 제외됨

### 2. 콘텐츠 검증 강화

**플랜 생성 전 검증:**
```typescript
// plan_contents의 모든 content_id가 실제로 존재하는지 확인
const invalidContents = contents.filter((c) => {
  const exists = await checkContentExists(c.content_id, c.content_type, studentId);
  return !exists;
});

if (invalidContents.length > 0) {
  console.warn("존재하지 않는 콘텐츠:", invalidContents);
  // 해당 콘텐츠를 plan_contents에서 삭제하거나 경고만 출력
}
```

### 3. 에러 처리 개선

**현재:**
- 외래 키 제약 조건 위반 시 에러 발생
- 플랜 생성 실패

**개선:**
- 플랜 생성 전에 모든 콘텐츠 검증
- 존재하지 않는 콘텐츠는 자동으로 제외
- 경고 로그 출력 후 플랜 생성 계속 진행

## 📊 데이터 흐름 다이어그램

### 정상 흐름

```
1. savePlanContents
   ↓
2. validateAndResolveContent
   - 마스터 강의 ID: 048f5e20-be95-4868-adcb-5a486685845a
   - 학생 강의로 복사 성공
   - actualContentId: abc123... (학생 강의 ID)
   ↓
3. plan_contents 저장
   - content_id: abc123... (학생 강의 ID) ✅
   - master_content_id: 048f5e20-be95-4868-adcb-5a486685845a
   ↓
4. 플랜 생성 (generatePlansRefactored)
   - plan_contents에서 content_id 조회: abc123...
   - lectures 테이블에서 직접 조회: abc123... ✅
   - contentIdMap.set("abc123...", "abc123...")
   ↓
5. 플랜 생성 성공 ✅
```

### 문제 발생 흐름

```
1. savePlanContents
   ↓
2. validateAndResolveContent
   - 마스터 강의 ID: 048f5e20-be95-4868-adcb-5a486685845a
   - 학생 강의로 복사 성공
   - actualContentId: abc123... (학생 강의 ID)
   ↓
3. plan_contents 저장
   - content_id: abc123... (학생 강의 ID) ✅
   ↓
4. 플랜 생성 (generatePlansRefactored)
   - plan_contents에서 content_id 조회: abc123...
   - lectures 테이블에서 직접 조회: ❌ 조회 실패 (RLS 또는 삭제됨)
   - contentIdMap에 매핑되지 않음
   ↓
5. 플랜 생성 시 contentIdMap.get("abc123...") → undefined
   - 콘텐츠 제외됨 ✅
   - 하지만 다른 콘텐츠는 정상 처리됨
   ↓
6. 만약 contentIdMap 필터링이 제대로 작동하지 않으면:
   - 원본 content_id (abc123...)가 그대로 사용됨
   - student_plan에 삽입 시도
   - 외래 키 제약 조건 위반 ❌
```

## 🔑 핵심 문제점

1. **타이밍 이슈**: 콘텐츠 저장과 플랜 생성 사이에 콘텐츠가 삭제될 수 있음
2. **RLS 정책**: 관리자/컨설턴트가 다른 학생의 콘텐츠를 조회할 때 RLS 정책으로 인해 조회 실패 가능
3. **검증 부족**: 플랜 생성 전에 모든 콘텐츠가 실제로 존재하는지 확인하지 않음

## ✅ 해결 방안

### 즉시 해결 (이미 적용됨)

1. ✅ `contentIdMap`에 없는 콘텐츠 제외
2. ✅ 마스터 콘텐츠 복사 실패 시 `contentIdMap`에 매핑하지 않음
3. ✅ `plan_contents`의 `content_id` 직접 조회 추가

### 추가 개선 사항

1. **플랜 생성 전 콘텐츠 검증 강화**
   - 모든 `content_id`가 실제로 존재하는지 확인
   - 존재하지 않는 콘텐츠는 `plan_contents`에서 삭제하거나 경고만 출력

2. **에러 처리 개선**
   - 외래 키 제약 조건 위반 시 더 명확한 에러 메시지
   - 어떤 콘텐츠가 문제인지 로그로 출력

3. **RLS 정책 확인**
   - 관리자/컨설턴트가 다른 학생의 콘텐츠를 조회할 때 올바른 클라이언트 사용
   - `getSupabaseClientForStudent` 또는 `ensureAdminClient` 사용 확인

## 📝 결론

근본적인 원인은 **플랜 생성 시 `contentIdMap`에 매핑되지 않은 콘텐츠가 플랜에 포함되어 외래 키 제약 조건 위반이 발생**하는 것입니다.

현재 적용된 수정 사항으로 대부분의 경우 해결되지만, 추가로 플랜 생성 전 콘텐츠 검증을 강화하면 더 안정적입니다.

