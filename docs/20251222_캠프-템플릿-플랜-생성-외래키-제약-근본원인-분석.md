# ìº í”„ í…œí”Œë¦¿ í”Œëœ ìƒì„± ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ê·¼ë³¸ ì›ì¸ ë¶„ì„

**ì‘ì—… ì¼ì‹œ**: 2024ë…„ 12ì›” 22ì¼  
**ì‘ì—…ì**: AI Assistant

## ğŸ“‹ ë¬¸ì œ ìƒí™©

ê´€ë¦¬ìê°€ ìº í”„ í…œí”Œë¦¿ ì°¸ì—¬ìì˜ ë‚¨ì€ ë‹¨ê³„ë¥¼ ì§„í–‰í•  ë•Œ(`continueCampStepsForAdmin`) í”Œëœ ìƒì„± ì¤‘ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

### ì—ëŸ¬ ë©”ì‹œì§€

```
Error [AppError]: í”Œëœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Referenced lecture (048f5e20-be95-4868-adcb-5a486685845a) does not exist
```

## ğŸ” ê·¼ë³¸ ì›ì¸ ë¶„ì„

### ë°ì´í„° íë¦„

1. **ì½˜í…ì¸  ì €ì¥ ë‹¨ê³„** (`savePlanContents`)
   - `validateAndResolveContent`ë¥¼ í†µí•´ ë§ˆìŠ¤í„° ì½˜í…ì¸ ë¥¼ í•™ìƒ ì½˜í…ì¸ ë¡œ ë³µì‚¬
   - `actualContentId` (í•™ìƒ ì½˜í…ì¸  ID)ë¥¼ `plan_contents.content_id`ì— ì €ì¥ âœ…
   - ì˜ˆ: ë§ˆìŠ¤í„° ê°•ì˜ ID `048f5e20-be95-4868-adcb-5a486685845a` â†’ í•™ìƒ ê°•ì˜ ID `abc123...`

2. **í”Œëœ ìƒì„± ë‹¨ê³„** (`generatePlansRefactored`)
   - `getPlanGroupWithDetailsByRole`ì„ í†µí•´ `plan_contents`ì—ì„œ ì½˜í…ì¸  ì¡°íšŒ
   - ì¡°íšŒëœ `content_id`ëŠ” ì´ë¯¸ í•™ìƒ ì½˜í…ì¸  ID âœ…
   - `contentIdMap` ìƒì„± ì‹œ ì´ IDë¥¼ `lectures` í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ

### ê·¼ë³¸ ì›ì¸

**ë¬¸ì œ 1: `contentIdMap` ìƒì„± ë¡œì§ì˜ ë¶ˆì™„ì „ì„±**

`generatePlansRefactored.ts`ì—ì„œ `contentIdMap`ì„ ìƒì„±í•  ë•Œ:

```typescript
// 1. content_idë¥¼ í•™ìƒ ì½˜í…ì¸  IDë¡œ ì§ì ‘ ì¡°íšŒ
const [directBooksResult, directLecturesResult, ...] = await Promise.all([
  queryClient.from("books")
    .in("id", bookContents.map((c) => c.content_id)) // âœ… ì˜¬ë°”ë¦„
    .eq("student_id", studentId),
  queryClient.from("lectures")
    .in("id", lectureContents.map((c) => c.content_id)) // âœ… ì˜¬ë°”ë¦„
    .eq("student_id", studentId),
  // ...
]);

// 2. ì§ì ‘ ì¡°íšŒí•œ ê²°ê³¼ë¥¼ contentIdMapì— ë§¤í•‘
(directLecturesResult.data || []).forEach((l) => {
  contentIdMap.set(l.id, l.id); // âœ… ì˜¬ë°”ë¦„
});
```

**í•˜ì§€ë§Œ ë¬¸ì œëŠ”:**
- `plan_contents`ì— ì €ì¥ëœ `content_id`ê°€ ì‹¤ì œë¡œ `lectures` í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì§€ ì•ŠìŒ
- RLS(Row Level Security) ì •ì±…ìœ¼ë¡œ ì¸í•´ ì¡°íšŒê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
- ë˜ëŠ” í•´ë‹¹ í•™ìƒì˜ ê°•ì˜ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

**ë¬¸ì œ 2: ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬**

ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ê°€ ì‹¤íŒ¨í•œ ê²½ìš°:
- `savePlanContents`ì—ì„œ `isValid = false`ë¡œ ì„¤ì •í•˜ì—¬ ì½˜í…ì¸  ì œì™¸ âœ…
- í•˜ì§€ë§Œ ì´ë¯¸ `plan_contents`ì— ì €ì¥ëœ ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆìŒ
- ë˜ëŠ” ë³µì‚¬ëŠ” ì„±ê³µí–ˆì§€ë§Œ ë‚˜ì¤‘ì— ì‚­ì œëœ ê²½ìš°

**ë¬¸ì œ 3: `contentIdMap`ì— ì—†ëŠ” ì½˜í…ì¸  ì²˜ë¦¬**

í”Œëœ ìƒì„± ì‹œ `contentIdMap`ì— ì—†ëŠ” ì½˜í…ì¸ ëŠ” ì œì™¸í•˜ë„ë¡ ìˆ˜ì •í–ˆì§€ë§Œ:
- ì œì™¸ëœ ì½˜í…ì¸ ê°€ ë§ìœ¼ë©´ í”Œëœì´ ìƒì„±ë˜ì§€ ì•ŠìŒ
- ë˜ëŠ” ì¼ë¶€ ì½˜í…ì¸ ë§Œ ì œì™¸ë˜ì–´ ë¶ˆì™„ì „í•œ í”Œëœì´ ìƒì„±ë¨

## ğŸ›  í•´ê²° ë°©ë²•

### 1. `contentIdMap` ìƒì„± ë¡œì§ ê°œì„ 

**í˜„ì¬ ë¡œì§:**
```typescript
// ì§ì ‘ ì¡°íšŒí•œ ê²°ê³¼ë¥¼ contentIdMapì— ë§¤í•‘
(directLecturesResult.data || []).forEach((l) => {
  contentIdMap.set(l.id, l.id);
});
```

**ê°œì„  ë°©ì•ˆ:**
- ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ í•´ë‹¹ ì½˜í…ì¸ ë¥¼ ë¡œê·¸ë¡œ ê¸°ë¡
- `contentIdMap`ì— ë§¤í•‘í•˜ì§€ ì•Šì•„ í”Œëœ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ì œì™¸ë¨

### 2. ì½˜í…ì¸  ê²€ì¦ ê°•í™”

**í”Œëœ ìƒì„± ì „ ê²€ì¦:**
```typescript
// plan_contentsì˜ ëª¨ë“  content_idê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
const invalidContents = contents.filter((c) => {
  const exists = await checkContentExists(c.content_id, c.content_type, studentId);
  return !exists;
});

if (invalidContents.length > 0) {
  console.warn("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸ :", invalidContents);
  // í•´ë‹¹ ì½˜í…ì¸ ë¥¼ plan_contentsì—ì„œ ì‚­ì œí•˜ê±°ë‚˜ ê²½ê³ ë§Œ ì¶œë ¥
}
```

### 3. ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 

**í˜„ì¬:**
- ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì‹œ ì—ëŸ¬ ë°œìƒ
- í”Œëœ ìƒì„± ì‹¤íŒ¨

**ê°œì„ :**
- í”Œëœ ìƒì„± ì „ì— ëª¨ë“  ì½˜í…ì¸  ê²€ì¦
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸ ëŠ” ìë™ìœ¼ë¡œ ì œì™¸
- ê²½ê³  ë¡œê·¸ ì¶œë ¥ í›„ í”Œëœ ìƒì„± ê³„ì† ì§„í–‰

## ğŸ“Š ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨

### ì •ìƒ íë¦„

```
1. savePlanContents
   â†“
2. validateAndResolveContent
   - ë§ˆìŠ¤í„° ê°•ì˜ ID: 048f5e20-be95-4868-adcb-5a486685845a
   - í•™ìƒ ê°•ì˜ë¡œ ë³µì‚¬ ì„±ê³µ
   - actualContentId: abc123... (í•™ìƒ ê°•ì˜ ID)
   â†“
3. plan_contents ì €ì¥
   - content_id: abc123... (í•™ìƒ ê°•ì˜ ID) âœ…
   - master_content_id: 048f5e20-be95-4868-adcb-5a486685845a
   â†“
4. í”Œëœ ìƒì„± (generatePlansRefactored)
   - plan_contentsì—ì„œ content_id ì¡°íšŒ: abc123...
   - lectures í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ: abc123... âœ…
   - contentIdMap.set("abc123...", "abc123...")
   â†“
5. í”Œëœ ìƒì„± ì„±ê³µ âœ…
```

### ë¬¸ì œ ë°œìƒ íë¦„

```
1. savePlanContents
   â†“
2. validateAndResolveContent
   - ë§ˆìŠ¤í„° ê°•ì˜ ID: 048f5e20-be95-4868-adcb-5a486685845a
   - í•™ìƒ ê°•ì˜ë¡œ ë³µì‚¬ ì„±ê³µ
   - actualContentId: abc123... (í•™ìƒ ê°•ì˜ ID)
   â†“
3. plan_contents ì €ì¥
   - content_id: abc123... (í•™ìƒ ê°•ì˜ ID) âœ…
   â†“
4. í”Œëœ ìƒì„± (generatePlansRefactored)
   - plan_contentsì—ì„œ content_id ì¡°íšŒ: abc123...
   - lectures í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ: âŒ ì¡°íšŒ ì‹¤íŒ¨ (RLS ë˜ëŠ” ì‚­ì œë¨)
   - contentIdMapì— ë§¤í•‘ë˜ì§€ ì•ŠìŒ
   â†“
5. í”Œëœ ìƒì„± ì‹œ contentIdMap.get("abc123...") â†’ undefined
   - ì½˜í…ì¸  ì œì™¸ë¨ âœ…
   - í•˜ì§€ë§Œ ë‹¤ë¥¸ ì½˜í…ì¸ ëŠ” ì •ìƒ ì²˜ë¦¬ë¨
   â†“
6. ë§Œì•½ contentIdMap í•„í„°ë§ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´:
   - ì›ë³¸ content_id (abc123...)ê°€ ê·¸ëŒ€ë¡œ ì‚¬ìš©ë¨
   - student_planì— ì‚½ì… ì‹œë„
   - ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ âŒ
```

## ğŸ”‘ í•µì‹¬ ë¬¸ì œì 

1. **íƒ€ì´ë° ì´ìŠˆ**: ì½˜í…ì¸  ì €ì¥ê³¼ í”Œëœ ìƒì„± ì‚¬ì´ì— ì½˜í…ì¸ ê°€ ì‚­ì œë  ìˆ˜ ìˆìŒ
2. **RLS ì •ì±…**: ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ê°€ ë‹¤ë¥¸ í•™ìƒì˜ ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•  ë•Œ RLS ì •ì±…ìœ¼ë¡œ ì¸í•´ ì¡°íšŒ ì‹¤íŒ¨ ê°€ëŠ¥
3. **ê²€ì¦ ë¶€ì¡±**: í”Œëœ ìƒì„± ì „ì— ëª¨ë“  ì½˜í…ì¸ ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì§€ ì•ŠìŒ

## âœ… í•´ê²° ë°©ì•ˆ

### ì¦‰ì‹œ í•´ê²° (ì´ë¯¸ ì ìš©ë¨)

1. âœ… `contentIdMap`ì— ì—†ëŠ” ì½˜í…ì¸  ì œì™¸
2. âœ… ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ `contentIdMap`ì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ
3. âœ… `plan_contents`ì˜ `content_id` ì§ì ‘ ì¡°íšŒ ì¶”ê°€

### ì¶”ê°€ ê°œì„  ì‚¬í•­ (ì ìš© ì™„ë£Œ âœ…)

#### 1. í”Œëœ ìƒì„± ì „ ì½˜í…ì¸  ê²€ì¦ ê°•í™” âœ…

**íŒŒì¼**: `app/(student)/actions/plan-groups/generatePlansRefactored.ts`

**ì ìš© ë‚´ìš©**:
- `contentIdMap`ì— ë§¤í•‘ë˜ì§€ ì•Šì€ ì½˜í…ì¸  ë¡œê·¸ ê¸°ë¡
- í”Œëœ ì €ì¥ ì „ ëª¨ë“  ì½˜í…ì¸  ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸ ë¥¼ í¬í•¨í•œ í”Œëœ ìë™ ì œì™¸

**ì£¼ìš” ì½”ë“œ**:
```typescript
// contentIdMapì— ë§¤í•‘ë˜ì§€ ì•Šì€ ì½˜í…ì¸  ë¡œê·¸ ê¸°ë¡
if (missingBookIds.length > 0 || missingLectureIds.length > 0) {
  console.warn(`[generatePlansRefactored] contentIdMapì— ë§¤í•‘ë˜ì§€ ì•Šì€ ì½˜í…ì¸  ë°œê²¬:`, {
    missingBookIds,
    missingLectureIds,
    totalMissing: missingBookIds.length + missingLectureIds.length,
  });
}

// í”Œëœ ì €ì¥ ì „ ì½˜í…ì¸  ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
const [booksCheck, lecturesCheck] = await Promise.all([
  queryClient.from("books").select("id").in("id", contentIdsByType.book).eq("student_id", studentId),
  queryClient.from("lectures").select("id").in("id", contentIdsByType.lecture).eq("student_id", studentId),
]);

// ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½˜í…ì¸ ë¥¼ í¬í•¨í•œ í”Œëœ ì œì™¸
const validPlanPayloads = planPayloads.filter((p) => {
  if (p.content_type === "book") return existingBookIds.has(p.content_id);
  if (p.content_type === "lecture") return existingLectureIds.has(p.content_id);
  return true;
});
```

#### 2. ì—ëŸ¬ ì²˜ë¦¬ ê°œì„  âœ…

**ì ìš© ë‚´ìš©**:
- ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì‹œ ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
- ë¬¸ì œê°€ ë˜ëŠ” ì½˜í…ì¸  IDì™€ íƒ€ì… ì •ë³´ í¬í•¨
- ìƒì„¸í•œ ë””ë²„ê¹… ì •ë³´ ë¡œê·¸ ì¶œë ¥

**ì£¼ìš” ì½”ë“œ**:
```typescript
if (isForeignKeyError) {
  const contentIdMatch = insertError.message?.match(/Referenced (book|lecture) \(([^)]+)\)/);
  const problematicContentId = contentIdMatch?.[2];
  const contentType = contentIdMatch?.[1] || "unknown";

  throw new AppError(
    `í”Œëœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ${contentType === "lecture" ? "ê°•ì˜" : "êµì¬"}(${problematicContentId?.substring(0, 8)}...)ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`,
    ErrorCode.DATABASE_ERROR,
    500,
    true
  );
}
```

#### 3. RLS ì •ì±… í™•ì¸ âœ…

**ì ìš© ë‚´ìš©**:
- `getSupabaseClientForStudent`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¬ë°”ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì„ íƒ
- ê°œë°œ í™˜ê²½ì—ì„œ í´ë¼ì´ì–¸íŠ¸ íƒ€ì… ë¡œê·¸ ì¶œë ¥

**ì£¼ìš” ì½”ë“œ**:
```typescript
const queryClient = await getSupabaseClientForStudent(
  studentId,
  access.user.userId,
  access.role
);

// ê°œë°œ í™˜ê²½ì—ì„œ í´ë¼ì´ì–¸íŠ¸ íƒ€ì… í™•ì¸
if (process.env.NODE_ENV === "development") {
  console.log("[generatePlansRefactored] Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •:", {
    isAdminOrConsultant,
    isOtherStudent: isAdminOrConsultant && studentId !== access.user.userId,
    queryClientType: isAdminOrConsultant && studentId !== access.user.userId ? "Admin" : "Server",
  });
}
```

## ğŸ“ ê²°ë¡ 

ê·¼ë³¸ì ì¸ ì›ì¸ì€ **í”Œëœ ìƒì„± ì‹œ `contentIdMap`ì— ë§¤í•‘ë˜ì§€ ì•Šì€ ì½˜í…ì¸ ê°€ í”Œëœì— í¬í•¨ë˜ì–´ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ì´ ë°œìƒ**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**ì ìš©ëœ í•´ê²°ì±…**:
1. âœ… `contentIdMap`ì— ì—†ëŠ” ì½˜í…ì¸  ì œì™¸
2. âœ… ë§ˆìŠ¤í„° ì½˜í…ì¸  ë³µì‚¬ ì‹¤íŒ¨ ì‹œ `contentIdMap`ì— ë§¤í•‘í•˜ì§€ ì•ŠìŒ
3. âœ… `plan_contents`ì˜ `content_id` ì§ì ‘ ì¡°íšŒ ì¶”ê°€
4. âœ… í”Œëœ ìƒì„± ì „ ì½˜í…ì¸  ê²€ì¦ ê°•í™”
5. âœ… ì—ëŸ¬ ì²˜ë¦¬ ê°œì„  (ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€)
6. âœ… RLS ì •ì±… í™•ì¸ (ì˜¬ë°”ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)

ì´ì œ í”Œëœ ìƒì„± ì‹œ ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ì´ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©°, ë¬¸ì œê°€ ë°œìƒí•˜ë”ë¼ë„ ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ì™€ ë¡œê·¸ë¥¼ í†µí•´ ë¹ ë¥´ê²Œ ë””ë²„ê¹…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

