# 플랜 생성 무한 로딩 문제 수정

## 문제 상황

플랜 생성 중 "플랜 생성 중..." 메시지가 무한히 표시되는 문제가 발생했습니다.

### 증상
- `Step7ScheduleResult` 컴포넌트에서 플랜 생성이 완료되었지만 로딩 화면이 계속 표시됨
- 사용자가 플랜 생성 결과를 확인할 수 없음

## 원인 분석

### 근본 원인

1. **플랜 생성 성공 후 plansCheck 업데이트 지연**
   - `generatePlansMutation.isSuccess`가 `true`가 되었지만
   - `checkPlansExistAction`의 refetch가 완료되기 전에 컴포넌트가 렌더링되어
   - `plansCheck.hasPlans`가 아직 `false`인 상태

2. **조건부 렌더링 로직 문제**
   - 185줄: `if (!plansCheck?.hasPlans && !generatePlansMutation.isSuccess) return null;`
   - 플랜 생성이 성공했지만 `plansCheck.hasPlans`가 아직 `false`인 경우 `null`을 반환
   - 이로 인해 무한 로딩처럼 보이는 현상 발생

3. **로딩 상태 조건 부족**
   - `isLoadingData || isGenerating` 조건만으로는
   - 플랜 생성 성공 후 `plansCheck` 업데이트 대기 상태를 처리하지 못함

## 해결 방법

### 1. 플랜 생성 성공 후 plansCheck 업데이트 대기 로직 추가

플랜 생성이 성공했지만 `plansCheck`가 아직 업데이트되지 않은 경우를 감지하여 로딩 상태를 유지하도록 수정했습니다.

```typescript
// 플랜 생성 성공 후 plansCheck가 업데이트될 때까지 로딩 상태 유지
const isWaitingForPlansCheck = 
  generatePlansMutation.isSuccess && 
  (!plansCheck || !plansCheck.hasPlans);

if (isLoadingData || isGenerating || isWaitingForPlansCheck) {
  // 로딩 화면 표시
}
```

### 2. onSuccess 콜백에서 refetch 완료 대기

`onSuccess` 콜백에서 `refetchQueries`가 완료될 때까지 기다리도록 수정했습니다.

```typescript
onSuccess: async () => {
  // 플랜 생성 후 DB 동기화를 위한 짧은 지연
  await new Promise((resolve) => setTimeout(resolve, 500));
  // 플랜 생성 후 관련 쿼리 무효화 및 즉시 refetch
  await queryClient.invalidateQueries({ queryKey: ["plansExist", groupId] });
  await queryClient.invalidateQueries({ queryKey: ["planSchedule", groupId] });
  // 즉시 refetch하여 최신 데이터 표시
  // refetch가 완료될 때까지 기다려서 plansCheck가 업데이트되도록 보장
  await queryClient.refetchQueries({ 
    queryKey: ["plansExist", groupId],
    exact: true 
  });
  await queryClient.refetchQueries({ queryKey: ["planSchedule", groupId] });
},
```

### 3. 조건부 렌더링 로직 개선

플랜이 없을 때의 조건을 단순화하여 `generatePlansMutation.isSuccess`일 때는 로딩 상태로 처리되도록 수정했습니다.

```typescript
// 수정 전
if (!plansCheck?.hasPlans && !generatePlansMutation.isSuccess) {
  return null;
}

// 수정 후
// generatePlansMutation.isSuccess일 때는 plansCheck가 업데이트될 때까지 로딩 상태로 처리되므로
// 여기서는 plansCheck.hasPlans만 확인
if (!plansCheck?.hasPlans) {
  return null;
}
```

### 4. 로딩 메시지 개선

플랜 확인 중 상태를 명확히 표시하도록 로딩 메시지를 개선했습니다.

```typescript
<p className="text-sm text-gray-500">
  {isGenerating ? "플랜 생성 중..." : isWaitingForPlansCheck ? "플랜 확인 중..." : "데이터를 불러오는 중..."}
</p>
```

## 수정 내용

### Step7ScheduleResult.tsx

1. **isWaitingForPlansCheck 상태 추가** (109-112줄)
   - 플랜 생성 성공 후 `plansCheck` 업데이트 대기 상태 감지

2. **로딩 조건 개선** (114줄)
   - `isWaitingForPlansCheck` 조건 추가

3. **onSuccess 콜백 개선** (45-58줄)
   - `refetchQueries`에 `exact: true` 옵션 추가
   - refetch 완료 대기 보장

4. **조건부 렌더링 단순화** (196줄)
   - `generatePlansMutation.isSuccess` 조건 제거
   - `plansCheck.hasPlans`만 확인

5. **로딩 메시지 개선** (126줄)
   - "플랜 확인 중..." 메시지 추가

## 테스트 시나리오

### 정상 케이스
1. 플랜이 없는 상태에서 Step 7 진입
2. 자동으로 플랜 생성 시작
3. "플랜 생성 중..." 메시지 표시
4. 플랜 생성 완료 후 "플랜 확인 중..." 메시지 표시
5. `plansCheck` 업데이트 완료 후 스케줄 결과 표시

### 에러 케이스
1. 플랜 생성 실패 시 에러 메시지 표시
2. 재생성 버튼 제공

## 예상 효과

1. **무한 로딩 문제 해결**
   - 플랜 생성 성공 후 `plansCheck` 업데이트까지 로딩 상태 유지
   - 사용자가 명확한 진행 상태를 확인할 수 있음

2. **사용자 경험 개선**
   - "플랜 확인 중..." 메시지로 진행 상태 명확화
   - 플랜 생성 완료 후 결과를 정확히 표시

3. **안정성 향상**
   - refetch 완료 대기로 데이터 동기화 보장
   - 조건부 렌더링 로직 단순화로 버그 가능성 감소

## 관련 파일

- `app/(student)/plan/new-group/_components/_features/scheduling/Step7ScheduleResult.tsx`
- `app/(student)/actions/plan-groups/queries.ts` (checkPlansExistAction)
- `app/(student)/actions/plan-groups/generatePlansRefactored.ts` (generatePlansFromGroupAction)

## 참고 문서

- `docs/2025-12-04-일반-모드-플랜-중복-생성-문제-수정.md`
- `docs/2025-12-04-일반-모드-스케줄-결과-표시-문제-수정.md`
- `docs/2025-02-02-fix-plan-query-after-generation.md`


