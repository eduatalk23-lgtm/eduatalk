# 일반모드/캠프모드 단순화 및 권한 문제 해결

**작업 일시**: 2025-11-28  
**목적**: 일반모드와 캠프모드의 복잡성을 단순화하고 권한 문제를 해결

## 작업 개요

일반모드와 캠프모드의 플랜 생성 단계에서 발생하는 복잡성과 권한 문제를 해결하기 위해 점진적으로 개선했습니다.

## 완료된 작업

### Phase 1: 권한 관리 통합

#### 1.1 권한 검증 헬퍼 통합

**파일**: `lib/auth/planGroupAuth.ts`

**추가된 함수**:
- `getClientForPlanOperation`: 플랜 생성/조회 시 적절한 클라이언트 반환
- `canBypassStatusCheck`: 상태 체크 우회 여부 확인 (캠프 모드 + 관리자 권한 통합)
- `isOtherStudent`: 다른 학생의 데이터를 조회하는지 여부 확인

**효과**:
- 권한 검증 로직 통합으로 중복 제거
- 일관된 권한 처리 패턴 확립

#### 1.2 클라이언트 선택 로직 표준화

**파일**: `lib/supabase/clientSelector.ts`

**추가된 함수**:
- `selectClientForPlanGeneration`: 플랜 생성 시 클라이언트 선택
- `selectClientForContentQuery`: 콘텐츠 조회 시 클라이언트 선택
- `selectClientForBlockSetQuery`: 블록 세트 조회 시 클라이언트 선택

**효과**:
- Admin 클라이언트 선택 로직 일관성 확보
- RLS 정책 위반 문제 근본 해결

#### 1.3 RLS 우회 패턴 문서화

**파일**: `docs/rls-bypass-patterns.md` (신규)

**내용**:
- RLS 우회가 필요한 시나리오 정리
- Admin 클라이언트 사용 가이드라인
- 권한 검증 체크리스트
- 안티패턴 가이드

### Phase 2: 블록 세트 조회 로직 통합

#### 2.1 블록 세트 조회 헬퍼 생성

**파일**: `lib/plan/blocks.ts` (신규)

**주요 함수**:
- `getBlockSetForPlanGroup`: 플랜 그룹에 맞는 블록 세트 조회
  - 캠프 모드: 템플릿 블록 세트 조회 (연결 테이블 → 하위 호환성 → template_data)
  - 일반 모드: 학생 블록 세트 조회 (block_set_id → active_block_set_id)
- `getBlockSetErrorMessage`: 블록 세트 조회 실패 시 에러 메시지 생성

**효과**:
- 템플릿/일반 모드 구분 없이 단일 인터페이스 제공
- 중복 코드 제거 (약 200줄 감소)
- 권한 문제 해결 (관리자/컨설턴트가 다른 학생 데이터 조회 시 Admin 클라이언트 사용)

#### 2.2 블록 세트 조회 중복 제거

**수정된 파일**:
- `app/(student)/actions/plan-groups/plans.ts`: 블록 세트 조회 로직을 `getBlockSetForPlanGroup` 호출로 대체
- `lib/plan/generators/planDataPreparer.ts`: `prepareBaseBlocks` 함수를 새로운 헬퍼 함수 사용하도록 수정 (하위 호환성 유지)
- `app/(student)/actions/plan-groups/queries.ts`: 블록 세트 조회 로직을 `getBlockSetForPlanGroup` 호출로 대체

**효과**:
- 중복 코드 제거
- 일관된 에러 처리
- 하위 호환성 로직을 헬퍼 함수 내부로 이동

### Phase 3: 데이터 병합 로직 통합

#### 3.1 템플릿 데이터 병합 헬퍼 생성

**파일**: `lib/utils/planDataMerger.ts` (신규)

**주요 함수**:
- `mergeTemplateDataWithStudentInput`: 템플릿 데이터 + 학생 입력 병합
- `applyTemplateLockedFields`: 잠금 필드 처리
- `validateMergedData`: 병합된 데이터 검증

**효과**:
- 템플릿 데이터 병합 로직 통합
- 재사용 가능한 헬퍼 함수 제공

#### 3.2 잠금 필드 처리 통합

**파일**: `lib/types/plan.ts`

**추가된 타입**:
- `TemplateLockedFields`: 템플릿 잠금 필드 설정 타입 정의

**효과**:
- 타입 정의 중앙화
- 타입 안전성 향상

## 개선 효과

### 코드 중복 제거
- 블록 세트 조회 로직 중복 제거 (약 200줄 감소)
- 권한 검증 로직 통합으로 중복 제거

### 권한 문제 해결
- RLS 정책 위반 문제 근본 해결
- 관리자/컨설턴트가 다른 학생 데이터 조회 시 Admin 클라이언트 자동 사용

### 유지보수성 향상
- 권한 검증 로직 통합으로 일관성 확보
- 헬퍼 함수 단위 테스트 가능
- 명확한 에러 메시지 제공

### 문서화
- RLS 우회 패턴 가이드 작성
- 권한 검증 체크리스트 제공

## 향후 개선 사항

### Phase 4: Wizard 단계 통합 (선택적)
- 공통 Wizard 기반 구조 설계
- 모드별 설정 객체 정의
- 단계 활성화/비활성화 로직을 설정 기반으로 변경

## 관련 파일

### 신규 파일
- `lib/plan/blocks.ts`: 블록 세트 조회 헬퍼
- `lib/utils/planDataMerger.ts`: 템플릿 데이터 병합 헬퍼
- `docs/rls-bypass-patterns.md`: RLS 우회 패턴 가이드
- `docs/일반모드-캠프모드-단순화-개선.md`: 이 문서

### 수정된 파일
- `lib/auth/planGroupAuth.ts`: 권한 검증 헬퍼 추가
- `lib/supabase/clientSelector.ts`: 클라이언트 선택 헬퍼 추가
- `lib/types/plan.ts`: TemplateLockedFields 타입 추가
- `app/(student)/actions/plan-groups/plans.ts`: 블록 세트 조회 로직 대체
- `lib/plan/generators/planDataPreparer.ts`: 블록 세트 조회 로직 대체
- `app/(student)/actions/plan-groups/queries.ts`: 블록 세트 조회 로직 대체

## 테스트 권장 사항

1. **권한 검증 테스트**
   - 학생이 자신의 플랜 생성
   - 관리자가 다른 학생의 플랜 생성
   - 컨설턴트가 다른 학생의 플랜 생성

2. **블록 세트 조회 테스트**
   - 일반 모드: 학생 블록 세트 조회
   - 캠프 모드: 템플릿 블록 세트 조회
   - 하위 호환성: 마이그레이션 전 데이터 처리

3. **데이터 병합 테스트**
   - 템플릿 데이터 + 학생 입력 병합
   - 잠금 필드 처리
   - 병합된 데이터 검증

## 참고 문서

- [RLS 우회 패턴 가이드](./rls-bypass-patterns.md)
- [캠프 모드 프로세스 정리 및 점검](./camp-mode-process-review-2025-11-27.md)
- [캠프 모드 프로세스 절차 개선](./camp-process-improvement.md)









