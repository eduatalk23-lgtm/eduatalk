# 불러오기 버튼 항목 개수 표시 구현

**작성일**: 2024-11-30  
**작업 범위**: 학습 제외일, 학원 일정 패널의 불러오기 버튼에 항목 개수 배지 추가

---

## 📋 개요

학습 제외일과 학원 일정의 "시간 관리에서 불러오기" 버튼 옆에 불러올 수 있는 항목 개수를 배지로 표시하여, 사용자가 버튼을 클릭하기 전에 미리 확인할 수 있도록 개선했습니다.

---

## ✨ 주요 기능

### 1. ExclusionsPanel (학습 제외일)

**파일**: `app/(student)/plan/new-group/_components/_panels/ExclusionsPanel.tsx`

#### 구현 내용
- 불러올 수 있는 제외일 개수를 실시간으로 조회
- 기존 제외일과 중복되지 않는 항목만 카운트
- 버튼 옆에 파란색 배지로 개수 표시
- 제외일 등록 후 자동으로 개수 갱신

#### 기술적 특징
- `useEffect`를 사용하여 기간 변경 및 제외일 변경 시 자동 조회
- `syncTimeManagementExclusionsAction`을 재사용하여 개수 조회
- 로딩 중 아이콘 회전 애니메이션 표시
- 불러올 항목이 0개일 때는 배지 숨김

### 2. AcademySchedulePanel (학원 일정)

**파일**: `app/(student)/plan/new-group/_components/_panels/AcademySchedulePanel.tsx`

#### 구현 내용
- 불러올 수 있는 학원 일정 개수를 실시간으로 조회
- 기존 학원 일정과 중복되지 않는 항목만 카운트
- 버튼 옆에 파란색 배지로 개수 표시
- 학원 일정 등록 후 자동으로 개수 갱신

#### 기술적 특징
- 학원 일정 고유 키 생성 함수 (`getScheduleKey`) 구현
- `day_of_week`, `start_time`, `end_time`, `academy_name`, `subject` 조합으로 중복 체크
- `syncTimeManagementAcademySchedulesAction`을 재사용하여 개수 조회
- 관리자/컨설턴트 모드에서도 정상 작동

---

## 🎨 UI/UX 개선

### 배지 디자인
- **색상**: 파란색 (`bg-blue-100`, `text-blue-800`)
- **크기**: 작은 텍스트 (`text-xs`)
- **모양**: 둥근 모서리 (`rounded-full`)
- **위치**: 불러오기 버튼 오른쪽

### 표시 조건
- 불러올 항목이 **1개 이상**일 때만 배지 표시
- 불러올 항목이 **0개**일 때는 배지 숨김 (버튼은 활성화 유지)
- 조회 중에는 아이콘 회전 애니메이션 표시

### 사용자 경험
1. 페이지 로드 시 자동으로 개수 조회
2. 기간 변경 시 자동으로 개수 갱신
3. 항목 등록 후 자동으로 개수 갱신
4. 불러오기 버튼 클릭 시 모달에서 상세 확인 가능

---

## 🔧 구현 세부사항

### 상태 관리

```typescript
// 불러올 수 있는 항목 개수 상태
const [availableCount, setAvailableCount] = useState<number | null>(null);
const [isLoadingCount, setIsLoadingCount] = useState(false);
```

### 개수 조회 로직 (ExclusionsPanel 예시)

```typescript
const loadAvailableCount = async () => {
  try {
    setIsLoadingCount(true);
    const result = await syncTimeManagementExclusionsAction(
      groupId || null,
      periodStart,
      periodEnd
    );
    
    if (result.exclusions && result.exclusions.length > 0) {
      // 기존 제외일과 중복되지 않는 항목만 카운트
      const existingDates = new Set(data.exclusions.map((e) => e.exclusion_date));
      const newCount = result.exclusions.filter(
        (e) => !existingDates.has(e.exclusion_date)
      ).length;
      setAvailableCount(newCount);
    } else {
      setAvailableCount(0);
    }
  } catch (error) {
    console.error("제외일 개수 조회 실패:", error);
    setAvailableCount(null);
  } finally {
    setIsLoadingCount(false);
  }
};
```

### 자동 갱신 트리거

```typescript
// 컴포넌트 마운트 시 및 기간/기존 제외일 변경 시 개수 조회
useEffect(() => {
  if (editable && periodStart && periodEnd) {
    loadAvailableCount();
  }
}, [periodStart, periodEnd, data.exclusions.length]);
```

### UI 렌더링

```typescript
<div className="flex items-center gap-2">
  <button
    type="button"
    onClick={syncFromTimeManagement}
    disabled={!editable}
    className="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
  >
    <RefreshCw className={`h-3 w-3 ${isLoadingCount ? "animate-spin" : ""}`} />
    시간 관리에서 불러오기
  </button>
  {availableCount !== null && availableCount > 0 && (
    <span className="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
      {availableCount}개
    </span>
  )}
</div>
```

---

## ⚙️ 기술 스택

- **React Hooks**: `useState`, `useEffect`, `useMemo`
- **Server Actions**: 기존 액션 재사용
- **Tailwind CSS**: 배지 스타일링
- **TypeScript**: 타입 안전성

---

## 🧪 테스트 시나리오

### 제외일 패널
1. ✅ 플랜 그룹 생성 페이지 진입 시 개수 자동 조회
2. ✅ 기간 변경 시 개수 자동 갱신
3. ✅ 제외일 등록 후 개수 자동 갱신
4. ✅ 불러올 항목이 없을 때 배지 숨김
5. ✅ 불러올 항목이 있을 때 배지 표시

### 학원 일정 패널
1. ✅ 플랜 그룹 생성 페이지 진입 시 개수 자동 조회
2. ✅ 학원 일정 등록 후 개수 자동 갱신
3. ✅ 불러올 항목이 없을 때 배지 숨김
4. ✅ 불러올 항목이 있을 때 배지 표시
5. ✅ 관리자/컨설턴트 모드에서 정상 작동

---

## 📈 사용자 가치

### Before (이전)
- 불러오기 버튼을 클릭해야만 항목 확인 가능
- 불러올 항목이 있는지 미리 알 수 없음

### After (개선)
- 버튼 옆 배지로 항목 개수 즉시 확인 가능
- 불필요한 클릭 감소
- 사용자 경험 개선

---

## 🔄 연관 파일

- `app/(student)/plan/new-group/_components/_panels/ExclusionsPanel.tsx`
- `app/(student)/plan/new-group/_components/_panels/AcademySchedulePanel.tsx`
- `app/(student)/actions/plan-groups/exclusions.ts`
- `app/(student)/actions/plan-groups/academy.ts`

---

## 📝 후속 작업 제안

1. 불러오기 개수 캐싱으로 성능 최적화
2. 로딩 상태 시각적 피드백 개선
3. 에러 발생 시 사용자 친화적 메시지 표시
4. 다른 패널에도 유사한 기능 적용 검토

---

**구현 완료일**: 2024-11-30


