# 캠프 모드 관리자 영역 문제점 수정

**작업일**: 2025-01-15  
**작업 범위**: Phase 1 (P0) + Phase 2 (P1) 완료

## 개요

캠프 모드 관리자 영역에서 발견된 문제점들을 우선순위별로 수정했습니다. Next.js 15와 Supabase 모범 사례를 적용하여 서버 사이드 필터링, 페이지네이션 상태 관리, 에러 처리 등을 개선했습니다.

## Phase 1: 즉시 수정 필요 (P0) - 완료

### 1.1 템플릿 목록 페이지네이션과 필터링 불일치 수정 ✅

**문제**: 서버에서 페이지네이션된 데이터를 가져온 후 클라이언트에서 필터링하여 페이지네이션이 부정확함

**해결**:
- `lib/data/campTemplates.ts`의 `getCampTemplatesForTenantWithPagination` 함수에 필터 파라미터 추가
- Supabase 쿼리 레벨에서 필터링 적용 (`.ilike()`, `.or()`, `.eq()` 사용)
- `app/(admin)/admin/camp-templates/page.tsx`에서 클라이언트 필터링 제거, 서버 사이드 필터링 적용

**변경 파일**:
- `lib/data/campTemplates.ts`: 필터 파라미터 추가 및 서버 사이드 필터링 구현
- `app/(admin)/admin/camp-templates/page.tsx`: 클라이언트 필터링 제거

### 1.2 초대 목록 페이지네이션 상태 관리 문제 수정 ✅

**문제**: 초대 삭제/추가 후에도 현재 페이지를 유지하여 빈 페이지 표시 가능

**해결**:
- 초대 추가 후 페이지를 1로 리셋
- 초대 삭제 후 현재 페이지에 데이터가 없으면 이전 페이지로 이동하는 로직 추가

**변경 파일**:
- `app/(admin)/admin/camp-templates/[id]/CampTemplateDetail.tsx`: `handleInvitationSent`, `handleDeleteInvitations` 함수 추가
- `app/(admin)/admin/camp-templates/[id]/CampInvitationList.tsx`: `onDeleteInvitations` prop 추가 및 삭제 핸들러 수정

### 1.3 템플릿 복사 시 블록 세트 연결 실패 처리 개선 ✅

**문제**: 블록 세트 연결 실패 시 경고만 하고 성공으로 처리하여 데이터 일관성 문제 발생

**해결**:
- 블록 세트 연결 실패 시 템플릿 삭제 (롤백) 및 명시적 에러 반환
- 조회 실패 시에도 롤백 처리

**변경 파일**:
- `lib/data/campTemplates.ts`: `copyCampTemplate` 함수의 에러 처리 개선

## Phase 2: 단기 수정 권장 (P1) - 완료

### 2.1 초대 상태 변경 시 확인 다이얼로그 추가 ✅

**문제**: 드롭다운에서 상태 변경 시 확인 없이 즉시 변경되어 실수 가능

**해결**:
- `accepted` ↔ `declined` 변경 시 확인 다이얼로그 표시
- 확인 취소 시 select 값을 원래대로 복원

**변경 파일**:
- `app/(admin)/admin/camp-templates/[id]/CampInvitationList.tsx`: 상태 변경 핸들러에 확인 로직 추가

### 2.2 캠프 통계 에러 처리 개선 ✅

**문제**: 에러 발생 시 빈 통계를 반환하여 실제 에러를 숨김

**해결**:
- `getCampStatisticsForTenant`, `getCampTemplateStatistics` 함수가 `{ success, data?, error? }` 형태로 반환하도록 변경
- 에러 발생 시 명시적으로 에러 반환
- `app/(admin)/admin/dashboard/page.tsx`에서 에러 처리 추가

**변경 파일**:
- `lib/data/campTemplates.ts`: 통계 조회 함수의 반환 타입 변경 및 에러 처리 개선
- `app/(admin)/admin/dashboard/page.tsx`: 에러 처리 로직 추가

### 2.3 필터링 로직 중복 제거 ✅

**문제**: `filterCampInvitations`에서 `studentName`과 `search` 필터가 중복됨

**해결**:
- `studentName` 필터 제거 (search로 통합)
- 타입 정의에서 `studentName` 제거

**변경 파일**:
- `lib/utils/campFilters.ts`: `CampInvitationFilters` 타입 및 `filterCampInvitations` 함수 수정

### 2.4 타입 안전성 문제 수정 ✅

**문제**: `CampTemplateFilters`의 `status`와 `programType`이 빈 문자열(`""`)을 허용하지만 필터링 로직에서 체크하지 않음

**해결**:
- 타입 정의에서 빈 문자열 제거
- 필터링 로직에서 빈 문자열 명시적 체크 추가

**변경 파일**:
- `lib/utils/campFilters.ts`: 타입 정의 및 필터링 로직 수정

## 기술적 개선 사항

1. **서버 사이드 필터링**: Next.js 15 모범 사례 적용, 데이터베이스 레벨에서 필터링하여 성능 향상
2. **에러 처리**: 명시적 에러 반환으로 디버깅 용이성 향상
3. **타입 안전성**: 빈 문자열 처리 명확화로 런타임 에러 방지
4. **사용자 경험**: 페이지네이션 상태 관리 개선으로 빈 페이지 표시 방지

## 테스트 권장 사항

1. 템플릿 목록에서 검색/필터링 후 페이지네이션이 정확한지 확인
2. 초대 추가/삭제 후 페이지네이션이 올바르게 동작하는지 확인
3. 템플릿 복사 시 블록 세트 연결 실패 시 롤백이 정상 동작하는지 확인
4. 초대 상태 변경 시 확인 다이얼로그가 표시되는지 확인
5. 캠프 통계 조회 실패 시 에러가 올바르게 표시되는지 확인

## 다음 단계 (Phase 3)

Phase 3 작업은 향후 진행 예정:
- 초대 상태 변경 시 Optimistic Update 구현
- 템플릿 복사 시 경로 재검증 확인
- 초대 목록 로드 의존성 배열 최적화
- 공통 에러 처리 유틸리티 생성
- Supabase 쿼리 빌더 헬퍼 생성

