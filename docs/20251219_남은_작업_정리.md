# í•™ìƒ ë“±ë¡ ë° ì—°ê²° ì½”ë“œ ì‹œìŠ¤í…œ - ë‚¨ì€ ì‘ì—… ì •ë¦¬

**ì‘ì„± ì¼ì**: 2025-12-19  
**ì°¸ê³ **: `.cursor/plans/-0e0a835e.plan.md`

## ğŸ“‹ ë‚¨ì€ ì‘ì—… ëª©ë¡

### ğŸ”´ ìš°ì„ ìˆœìœ„: ë†’ìŒ

#### 1. í•™ìƒ ìƒì„¸ í˜ì´ì§€ì— ì—°ê²° ì½”ë“œ ì„¹ì…˜ ì¶”ê°€
- **ìƒíƒœ**: âœ… ì™„ë£Œ
- **íŒŒì¼**: 
  - `app/(admin)/admin/students/[id]/_components/ConnectionCodeSection.tsx` (ì´ë¯¸ êµ¬í˜„ë¨)
  - `app/(admin)/admin/students/[id]/page.tsx` (ì´ë¯¸ ì¶”ê°€ë¨)
- **êµ¬í˜„ ë‚´ìš©**:
  - âœ… í˜„ì¬ í™œì„± ì—°ê²° ì½”ë“œ ì¡°íšŒ ë° í‘œì‹œ
  - âœ… ì—°ê²° ì½”ë“œ ì¬ë°œê¸‰ ë²„íŠ¼
  - âœ… ì—°ê²° ì½”ë“œ ë³µì‚¬ ê¸°ëŠ¥
  - âœ… ë§Œë£Œì¼ ë° ì‚¬ìš© ì—¬ë¶€ í‘œì‹œ
  - âœ… ë§Œë£Œ/ì‚¬ìš©ëœ ì½”ë“œ ìƒíƒœ í‘œì‹œ

#### 2. linkStudentWithConnectionCode íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê°œì„ 
- **ìƒíƒœ**: â³ Pending
- **íŒŒì¼**: `app/actions/auth.ts` (line 249-423)
- **í˜„ì¬ ë¬¸ì œì **:
  - ì—¬ëŸ¬ í…Œì´ë¸”ì— ìˆœì°¨ì ìœ¼ë¡œ INSERT/UPDATE ìˆ˜í–‰
  - ì¤‘ê°„ì— ì‹¤íŒ¨ ì‹œ ë°ì´í„° ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±
  - íŠ¸ëœì­ì…˜ ë³´ì¥ì´ ì—†ìŒ
- **ê°œì„  ë°©ì•ˆ**:
  - PostgreSQL í•¨ìˆ˜ë¡œ íŠ¸ëœì­ì…˜ ë³´ì¥
  - ë˜ëŠ” Supabase RPC í•¨ìˆ˜ ì‚¬ìš©
  - ì›ìì„± ë³´ì¥ (ëª¨ë‘ ì„±ê³µ ë˜ëŠ” ëª¨ë‘ ì‹¤íŒ¨)
- **ì‘ì—… ë‚´ìš©**:
  - PostgreSQL í•¨ìˆ˜ ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„±
  - `link_student_with_connection_code()` í•¨ìˆ˜ êµ¬í˜„
  - ê¸°ì¡´ ì½”ë“œë¥¼ RPC í˜¸ì¶œë¡œ ë³€ê²½
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3-4ì‹œê°„

### ğŸŸ¡ ìš°ì„ ìˆœìœ„: ì¤‘ê°„

#### 3. í•™ìƒ ê´€ë ¨ ì—ëŸ¬ ì²˜ë¦¬ í†µí•© ëª¨ë“ˆ ìƒì„±
- **ìƒíƒœ**: â³ Pending
- **íŒŒì¼**: `lib/errors/studentErrors.ts` (ì‹ ê·œ ìƒì„±)
- **ì‘ì—… ë‚´ìš©**:
  - í•™ìƒ ê´€ë ¨ ì—ëŸ¬ íƒ€ì… ì •ì˜
  - ì—ëŸ¬ ì½”ë“œ ìƒìˆ˜ ì •ì˜
  - ì—ëŸ¬ ìƒì„± í—¬í¼ í•¨ìˆ˜
  - ì—ëŸ¬ ë¡œê¹… í†µí•©
- **ì°¸ê³ **: ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´ (`lib/errors/`)
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

#### 4. ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘ ì¶”ê°€
- **ìƒíƒœ**: â³ Pending
- **íŒŒì¼**: `lib/errors/studentErrorMessages.ts` (ì‹ ê·œ ìƒì„±)
- **ì‘ì—… ë‚´ìš©**:
  - ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ ì½”ë“œ â†’ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ ë§¤í•‘
  - RLS ì •ì±… ìœ„ë°˜ ë©”ì‹œì§€
  - ì œì•½ì¡°ê±´ ìœ„ë°˜ ë©”ì‹œì§€
  - ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë©”ì‹œì§€
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1-2ì‹œê°„

### ğŸŸ¢ ìš°ì„ ìˆœìœ„: ë‚®ìŒ

#### 5. ê¸°ëŠ¥ ë¬¸ì„œí™” ë° ì‚¬ìš© ê°€ì´ë“œ ì‘ì„±
- **ìƒíƒœ**: â³ Pending
- **íŒŒì¼**: `docs/student-connection-code-guide.md` (ì‹ ê·œ ìƒì„±)
- **ì‘ì—… ë‚´ìš©**:
  - ê´€ë¦¬ììš© ì‚¬ìš© ê°€ì´ë“œ
  - í•™ìƒìš© ì‚¬ìš© ê°€ì´ë“œ
  - ì—°ê²° ì½”ë“œ ìƒì„± ë° ì‚¬ìš© ì ˆì°¨
  - FAQ ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
- **ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

## ğŸ“Š ì‘ì—… ìš°ì„ ìˆœìœ„ ë§¤íŠ¸ë¦­ìŠ¤

| ì‘ì—… | ìš°ì„ ìˆœìœ„ | ë‚œì´ë„ | ì˜ˆìƒ ì‹œê°„ | ì˜ì¡´ì„± | ìƒíƒœ |
|------|---------|--------|-----------|--------|------|
| ~~í•™ìƒ ìƒì„¸ í˜ì´ì§€ ì—°ê²° ì½”ë“œ ì„¹ì…˜~~ | ~~ë†’ìŒ~~ | ~~ë‚®ìŒ~~ | ~~2-3h~~ | ~~ì—†ìŒ~~ | âœ… ì™„ë£Œ |
| íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê°œì„  | ë†’ìŒ | ë†’ìŒ | 3-4h | ì—†ìŒ | â³ Pending |
| ì—ëŸ¬ ì²˜ë¦¬ í†µí•© ëª¨ë“ˆ | ì¤‘ê°„ | ì¤‘ê°„ | 2-3h | ì—†ìŒ | â³ Pending |
| ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘ | ì¤‘ê°„ | ë‚®ìŒ | 1-2h | #3 | â³ Pending |
| ê¸°ëŠ¥ ë¬¸ì„œí™” | ë‚®ìŒ | ë‚®ìŒ | 2-3h | ì—†ìŒ | â³ Pending |

## ğŸ” ìƒì„¸ ì‘ì—… ë‚´ìš©

### 1. í•™ìƒ ìƒì„¸ í˜ì´ì§€ ì—°ê²° ì½”ë“œ ì„¹ì…˜

#### êµ¬í˜„ ìœ„ì¹˜
- `app/(admin)/admin/students/[id]/_components/ConnectionCodeSection.tsx` (ì‹ ê·œ)

#### ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­
```typescript
// ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°
<ConnectionCodeSection studentId={studentId}>
  - í˜„ì¬ í™œì„± ì—°ê²° ì½”ë“œ í‘œì‹œ
  - ë§Œë£Œì¼ í‘œì‹œ
  - ì‚¬ìš© ì—¬ë¶€ í‘œì‹œ
  - ì¬ë°œê¸‰ ë²„íŠ¼
  - ë³µì‚¬ ë²„íŠ¼
  - ì—°ê²° ì½”ë“œ ìƒì„± ì´ë ¥ (ì„ íƒì‚¬í•­)
</ConnectionCodeSection>
```

#### í•„ìš”í•œ Server Actions
- `getStudentConnectionCode()` - ì´ë¯¸ êµ¬í˜„ë¨ âœ…
- `regenerateConnectionCode()` - ì´ë¯¸ êµ¬í˜„ë¨ âœ…

### 2. íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê°œì„ 

#### í˜„ì¬ ì½”ë“œ êµ¬ì¡°
```typescript
// app/actions/auth.ts::linkStudentWithConnectionCode
1. ì—°ê²° ì½”ë“œ ê²€ì¦
2. ê¸°ì¡´ í•™ìƒ ë ˆì½”ë“œ ì¡°íšŒ
3. ìƒˆ IDë¡œ students ë ˆì½”ë“œ ìƒì„±
4. í”„ë¡œí•„ ì •ë³´ ì¬ìƒì„±
5. ì§„ë¡œ ì •ë³´ ì¬ìƒì„±
6. ì—°ê²° ì½”ë“œ used_at ì—…ë°ì´íŠ¸
```

#### ê°œì„  ë°©ì•ˆ
```sql
-- PostgreSQL í•¨ìˆ˜ë¡œ íŠ¸ëœì­ì…˜ ë³´ì¥
CREATE OR REPLACE FUNCTION link_student_with_connection_code(
  p_user_id uuid,
  p_connection_code text
) RETURNS jsonb AS $$
DECLARE
  v_student_id uuid;
  v_existing_student jsonb;
BEGIN
  -- íŠ¸ëœì­ì…˜ ì‹œì‘ (ìë™)
  
  -- 1. ì—°ê²° ì½”ë“œ ê²€ì¦ ë° ì¡°íšŒ
  SELECT student_id INTO v_student_id
  FROM student_connection_codes
  WHERE connection_code = p_connection_code
    AND expires_at > now()
    AND used_at IS NULL;
  
  IF v_student_id IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'ìœ íš¨í•˜ì§€ ì•Šì€ ì—°ê²° ì½”ë“œì…ë‹ˆë‹¤.');
  END IF;
  
  -- 2. ê¸°ì¡´ í•™ìƒ ë°ì´í„° ì¡°íšŒ
  SELECT row_to_json(s.*) INTO v_existing_student
  FROM students s
  WHERE s.id = v_student_id;
  
  -- 3. ìƒˆ IDë¡œ í•™ìƒ ë ˆì½”ë“œ ìƒì„±
  INSERT INTO students (id, tenant_id, name, ...)
  SELECT p_user_id, tenant_id, name, ...
  FROM students
  WHERE id = v_student_id;
  
  -- 4. í”„ë¡œí•„ ì •ë³´ ì¬ìƒì„±
  INSERT INTO student_profiles (id, tenant_id, ...)
  SELECT p_user_id, tenant_id, ...
  FROM student_profiles
  WHERE id = v_student_id;
  
  -- 5. ì§„ë¡œ ì •ë³´ ì¬ìƒì„±
  INSERT INTO student_career_goals (student_id, tenant_id, ...)
  SELECT p_user_id, tenant_id, ...
  FROM student_career_goals
  WHERE student_id = v_student_id;
  
  -- 6. ì—°ê²° ì½”ë“œ ì‚¬ìš© ì²˜ë¦¬
  UPDATE student_connection_codes
  SET used_at = now()
  WHERE connection_code = p_connection_code;
  
  -- 7. ê¸°ì¡´ ë ˆì½”ë“œ ì‚­ì œ (CASCADEë¡œ ìë™ ì²˜ë¦¬ ê°€ëŠ¥)
  DELETE FROM students WHERE id = v_student_id;
  
  RETURN jsonb_build_object('success', true);
  
EXCEPTION
  WHEN OTHERS THEN
    RETURN jsonb_build_object('success', false, 'error', SQLERRM);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 3. ì—ëŸ¬ ì²˜ë¦¬ í†µí•© ëª¨ë“ˆ

#### êµ¬ì¡°
```typescript
// lib/errors/studentErrors.ts
export enum StudentErrorCode {
  STUDENT_NOT_FOUND = 'STUDENT_NOT_FOUND',
  CONNECTION_CODE_INVALID = 'CONNECTION_CODE_INVALID',
  CONNECTION_CODE_EXPIRED = 'CONNECTION_CODE_EXPIRED',
  CONNECTION_CODE_ALREADY_USED = 'CONNECTION_CODE_ALREADY_USED',
  RLS_POLICY_VIOLATION = 'RLS_POLICY_VIOLATION',
  // ...
}

export class StudentError extends Error {
  constructor(
    public code: StudentErrorCode,
    message: string,
    public context?: Record<string, unknown>
  ) {
    super(message);
  }
}

export function createStudentError(
  code: StudentErrorCode,
  context?: Record<string, unknown>
): StudentError {
  // ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘ ë¡œì§
}
```

### 4. ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘

#### êµ¬ì¡°
```typescript
// lib/errors/studentErrorMessages.ts
export const STUDENT_ERROR_MESSAGES: Record<StudentErrorCode, string> = {
  STUDENT_NOT_FOUND: 'í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
  CONNECTION_CODE_INVALID: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì—°ê²° ì½”ë“œì…ë‹ˆë‹¤.',
  CONNECTION_CODE_EXPIRED: 'ë§Œë£Œëœ ì—°ê²° ì½”ë“œì…ë‹ˆë‹¤.',
  // ...
};

export function getStudentErrorMessage(
  code: StudentErrorCode,
  context?: Record<string, unknown>
): string {
  // ë™ì  ë©”ì‹œì§€ ìƒì„± ë¡œì§
}
```

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥í•œ ì‘ì—…
1. **í•™ìƒ ìƒì„¸ í˜ì´ì§€ ì—°ê²° ì½”ë“œ ì„¹ì…˜** - ê°€ì¥ ê°„ë‹¨í•˜ê³  ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥
2. **ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘** - ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 

### ì‹ ì¤‘í•œ ê³„íšì´ í•„ìš”í•œ ì‘ì—…
1. **íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê°œì„ ** - ë°ì´í„° ë¬´ê²°ì„±ì— ì¤‘ìš”í•œ ì‘ì—…
2. **ì—ëŸ¬ ì²˜ë¦¬ í†µí•© ëª¨ë“ˆ** - ì „ì²´ ì‹œìŠ¤í…œì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŒ

## ğŸ“ ì°¸ê³  ì‚¬í•­

### ì´ë¯¸ ì™„ë£Œëœ ì‘ì—…
- âœ… student_connection_codes í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜
- âœ… í•™ìƒ ì •ë³´ Zod ìŠ¤í‚¤ë§ˆ ì •ì˜
- âœ… ì „í™”ë²ˆí˜¸ Zod ì»¤ìŠ¤í…€ íƒ€ì…
- âœ… FormData ê²€ì¦ ìœ í‹¸ë¦¬í‹°
- âœ… createStudent Server Action
- âœ… ì—°ê²° ì½”ë“œ ìƒì„±/ê²€ì¦ Server Action
- âœ… useCreateStudentForm í›…
- âœ… CreateStudentModal ì»´í¬ë„ŒíŠ¸
- âœ… í•™ìƒ ëª©ë¡ í˜ì´ì§€ ì‹ ê·œ ë“±ë¡ ë²„íŠ¼
- âœ… íšŒì›ê°€ì… í˜ì´ì§€ ì—°ê²° ì½”ë“œ ì…ë ¥ í•„ë“œ
- âœ… íšŒì›ê°€ì… ì‹œ ê³„ì • ì—°ê²° ë¡œì§
- âœ… ê´€ë¦¬ììš© students INSERT RLS ì •ì±…
- âœ… student_connection_codes INSERT ì •ì±… ê°œì„ 
- âœ… FormData í•„ë“œ ë¶„ë¦¬ í—¬í¼ í•¨ìˆ˜
- âœ… createStudent í•¨ìˆ˜ ìŠ¤í‚¤ë§ˆ ê²€ì¦ êµ¬ì¡° ìˆ˜ì •
- âœ… ì—°ê²° ì½”ë“œ ìƒì„± í•¨ìˆ˜ ë³´ì•ˆ ê°•í™”
- âœ… ê³ ìœ  ì—°ê²° ì½”ë“œ ìƒì„± í•¨ìˆ˜
- âœ… validateConnectionCode ê³µí†µ ëª¨ë“ˆí™”
- âœ… FormData ë³€í™˜ ìœ í‹¸ë¦¬í‹° ë¶„ë¦¬
- âœ… useCreateStudentForm zodResolver í†µí•©

### ê´€ë ¨ íŒŒì¼
- `app/(admin)/admin/students/[id]/page.tsx` - í•™ìƒ ìƒì„¸ í˜ì´ì§€
- `app/actions/auth.ts` - íšŒì›ê°€ì… ë° ì—°ê²° ì½”ë“œ ì²˜ë¦¬
- `app/(admin)/actions/studentManagementActions.ts` - í•™ìƒ ê´€ë¦¬ ì•¡ì…˜
- `lib/utils/connectionCodeUtils.ts` - ì—°ê²° ì½”ë“œ ìœ í‹¸ë¦¬í‹°
- `supabase/migrations/20251219025931_create_student_connection_codes.sql` - ì—°ê²° ì½”ë“œ í…Œì´ë¸”

