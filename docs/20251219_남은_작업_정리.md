# 학생 등록 및 연결 코드 시스템 - 남은 작업 정리

**작성 일자**: 2025-12-19  
**참고**: `.cursor/plans/-0e0a835e.plan.md`

## 📋 남은 작업 목록

### 🔴 우선순위: 높음

#### 1. 학생 상세 페이지에 연결 코드 섹션 추가
- **상태**: ⏳ Pending
- **파일**: `app/(admin)/admin/students/[id]/page.tsx`
- **작업 내용**:
  - 학생 상세 페이지에 연결 코드 표시 섹션 추가
  - 현재 활성 연결 코드 조회 및 표시
  - 연결 코드 재발급 버튼 추가
  - 연결 코드 복사 기능
  - 만료일 및 사용 여부 표시
- **참고 컴포넌트**: `ParentLinksSection.tsx` (유사한 패턴 참고)
- **필요 함수**: `getStudentConnectionCode()` (이미 구현됨)
- **예상 작업 시간**: 2-3시간

#### 2. linkStudentWithConnectionCode 트랜잭션 처리 개선
- **상태**: ⏳ Pending
- **파일**: `app/actions/auth.ts` (line 249-423)
- **현재 문제점**:
  - 여러 테이블에 순차적으로 INSERT/UPDATE 수행
  - 중간에 실패 시 데이터 불일치 가능성
  - 트랜잭션 보장이 없음
- **개선 방안**:
  - PostgreSQL 함수로 트랜잭션 보장
  - 또는 Supabase RPC 함수 사용
  - 원자성 보장 (모두 성공 또는 모두 실패)
- **작업 내용**:
  - PostgreSQL 함수 생성 마이그레이션 작성
  - `link_student_with_connection_code()` 함수 구현
  - 기존 코드를 RPC 호출로 변경
- **예상 작업 시간**: 3-4시간

### 🟡 우선순위: 중간

#### 3. 학생 관련 에러 처리 통합 모듈 생성
- **상태**: ⏳ Pending
- **파일**: `lib/errors/studentErrors.ts` (신규 생성)
- **작업 내용**:
  - 학생 관련 에러 타입 정의
  - 에러 코드 상수 정의
  - 에러 생성 헬퍼 함수
  - 에러 로깅 통합
- **참고**: 기존 에러 처리 패턴 (`lib/errors/`)
- **예상 작업 시간**: 2-3시간

#### 4. 사용자 친화적 에러 메시지 매핑 추가
- **상태**: ⏳ Pending
- **파일**: `lib/errors/studentErrorMessages.ts` (신규 생성)
- **작업 내용**:
  - 데이터베이스 에러 코드 → 사용자 친화적 메시지 매핑
  - RLS 정책 위반 메시지
  - 제약조건 위반 메시지
  - 네트워크 에러 메시지
- **예상 작업 시간**: 1-2시간

### 🟢 우선순위: 낮음

#### 5. 기능 문서화 및 사용 가이드 작성
- **상태**: ⏳ Pending
- **파일**: `docs/student-connection-code-guide.md` (신규 생성)
- **작업 내용**:
  - 관리자용 사용 가이드
  - 학생용 사용 가이드
  - 연결 코드 생성 및 사용 절차
  - FAQ 및 트러블슈팅
- **예상 작업 시간**: 2-3시간

## 📊 작업 우선순위 매트릭스

| 작업 | 우선순위 | 난이도 | 예상 시간 | 의존성 |
|------|---------|--------|-----------|--------|
| 학생 상세 페이지 연결 코드 섹션 | 높음 | 낮음 | 2-3h | 없음 |
| 트랜잭션 처리 개선 | 높음 | 높음 | 3-4h | 없음 |
| 에러 처리 통합 모듈 | 중간 | 중간 | 2-3h | 없음 |
| 에러 메시지 매핑 | 중간 | 낮음 | 1-2h | #3 |
| 기능 문서화 | 낮음 | 낮음 | 2-3h | 없음 |

## 🔍 상세 작업 내용

### 1. 학생 상세 페이지 연결 코드 섹션

#### 구현 위치
- `app/(admin)/admin/students/[id]/_components/ConnectionCodeSection.tsx` (신규)

#### 기능 요구사항
```typescript
// 컴포넌트 구조
<ConnectionCodeSection studentId={studentId}>
  - 현재 활성 연결 코드 표시
  - 만료일 표시
  - 사용 여부 표시
  - 재발급 버튼
  - 복사 버튼
  - 연결 코드 생성 이력 (선택사항)
</ConnectionCodeSection>
```

#### 필요한 Server Actions
- `getStudentConnectionCode()` - 이미 구현됨 ✅
- `regenerateConnectionCode()` - 이미 구현됨 ✅

### 2. 트랜잭션 처리 개선

#### 현재 코드 구조
```typescript
// app/actions/auth.ts::linkStudentWithConnectionCode
1. 연결 코드 검증
2. 기존 학생 레코드 조회
3. 새 ID로 students 레코드 생성
4. 프로필 정보 재생성
5. 진로 정보 재생성
6. 연결 코드 used_at 업데이트
```

#### 개선 방안
```sql
-- PostgreSQL 함수로 트랜잭션 보장
CREATE OR REPLACE FUNCTION link_student_with_connection_code(
  p_user_id uuid,
  p_connection_code text
) RETURNS jsonb AS $$
DECLARE
  v_student_id uuid;
  v_existing_student jsonb;
BEGIN
  -- 트랜잭션 시작 (자동)
  
  -- 1. 연결 코드 검증 및 조회
  SELECT student_id INTO v_student_id
  FROM student_connection_codes
  WHERE connection_code = p_connection_code
    AND expires_at > now()
    AND used_at IS NULL;
  
  IF v_student_id IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', '유효하지 않은 연결 코드입니다.');
  END IF;
  
  -- 2. 기존 학생 데이터 조회
  SELECT row_to_json(s.*) INTO v_existing_student
  FROM students s
  WHERE s.id = v_student_id;
  
  -- 3. 새 ID로 학생 레코드 생성
  INSERT INTO students (id, tenant_id, name, ...)
  SELECT p_user_id, tenant_id, name, ...
  FROM students
  WHERE id = v_student_id;
  
  -- 4. 프로필 정보 재생성
  INSERT INTO student_profiles (id, tenant_id, ...)
  SELECT p_user_id, tenant_id, ...
  FROM student_profiles
  WHERE id = v_student_id;
  
  -- 5. 진로 정보 재생성
  INSERT INTO student_career_goals (student_id, tenant_id, ...)
  SELECT p_user_id, tenant_id, ...
  FROM student_career_goals
  WHERE student_id = v_student_id;
  
  -- 6. 연결 코드 사용 처리
  UPDATE student_connection_codes
  SET used_at = now()
  WHERE connection_code = p_connection_code;
  
  -- 7. 기존 레코드 삭제 (CASCADE로 자동 처리 가능)
  DELETE FROM students WHERE id = v_student_id;
  
  RETURN jsonb_build_object('success', true);
  
EXCEPTION
  WHEN OTHERS THEN
    RETURN jsonb_build_object('success', false, 'error', SQLERRM);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 3. 에러 처리 통합 모듈

#### 구조
```typescript
// lib/errors/studentErrors.ts
export enum StudentErrorCode {
  STUDENT_NOT_FOUND = 'STUDENT_NOT_FOUND',
  CONNECTION_CODE_INVALID = 'CONNECTION_CODE_INVALID',
  CONNECTION_CODE_EXPIRED = 'CONNECTION_CODE_EXPIRED',
  CONNECTION_CODE_ALREADY_USED = 'CONNECTION_CODE_ALREADY_USED',
  RLS_POLICY_VIOLATION = 'RLS_POLICY_VIOLATION',
  // ...
}

export class StudentError extends Error {
  constructor(
    public code: StudentErrorCode,
    message: string,
    public context?: Record<string, unknown>
  ) {
    super(message);
  }
}

export function createStudentError(
  code: StudentErrorCode,
  context?: Record<string, unknown>
): StudentError {
  // 에러 메시지 매핑 로직
}
```

### 4. 사용자 친화적 에러 메시지 매핑

#### 구조
```typescript
// lib/errors/studentErrorMessages.ts
export const STUDENT_ERROR_MESSAGES: Record<StudentErrorCode, string> = {
  STUDENT_NOT_FOUND: '학생 정보를 찾을 수 없습니다.',
  CONNECTION_CODE_INVALID: '유효하지 않은 연결 코드입니다.',
  CONNECTION_CODE_EXPIRED: '만료된 연결 코드입니다.',
  // ...
};

export function getStudentErrorMessage(
  code: StudentErrorCode,
  context?: Record<string, unknown>
): string {
  // 동적 메시지 생성 로직
}
```

## 🚀 다음 단계

### 즉시 시작 가능한 작업
1. **학생 상세 페이지 연결 코드 섹션** - 가장 간단하고 즉시 사용 가능
2. **에러 메시지 매핑** - 기존 에러 처리 개선

### 신중한 계획이 필요한 작업
1. **트랜잭션 처리 개선** - 데이터 무결성에 중요한 작업
2. **에러 처리 통합 모듈** - 전체 시스템에 영향을 미칠 수 있음

## 📝 참고 사항

### 이미 완료된 작업
- ✅ student_connection_codes 테이블 마이그레이션
- ✅ 학생 정보 Zod 스키마 정의
- ✅ 전화번호 Zod 커스텀 타입
- ✅ FormData 검증 유틸리티
- ✅ createStudent Server Action
- ✅ 연결 코드 생성/검증 Server Action
- ✅ useCreateStudentForm 훅
- ✅ CreateStudentModal 컴포넌트
- ✅ 학생 목록 페이지 신규 등록 버튼
- ✅ 회원가입 페이지 연결 코드 입력 필드
- ✅ 회원가입 시 계정 연결 로직
- ✅ 관리자용 students INSERT RLS 정책
- ✅ student_connection_codes INSERT 정책 개선
- ✅ FormData 필드 분리 헬퍼 함수
- ✅ createStudent 함수 스키마 검증 구조 수정
- ✅ 연결 코드 생성 함수 보안 강화
- ✅ 고유 연결 코드 생성 함수
- ✅ validateConnectionCode 공통 모듈화
- ✅ FormData 변환 유틸리티 분리
- ✅ useCreateStudentForm zodResolver 통합

### 관련 파일
- `app/(admin)/admin/students/[id]/page.tsx` - 학생 상세 페이지
- `app/actions/auth.ts` - 회원가입 및 연결 코드 처리
- `app/(admin)/actions/studentManagementActions.ts` - 학생 관리 액션
- `lib/utils/connectionCodeUtils.ts` - 연결 코드 유틸리티
- `supabase/migrations/20251219025931_create_student_connection_codes.sql` - 연결 코드 테이블

