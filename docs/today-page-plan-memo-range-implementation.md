# Today 페이지 - 플랜 메모 및 범위 조정 기능 구현

## 📋 구현 개요

`/today` 페이지에서 플랜 그룹별로 메모를 작성하고, 범위를 조정할 수 있는 기능을 구현했습니다. 논리 플랜(같은 `plan_number`를 가진 플랜 그룹) 기준으로 작동하며, 메모 아이콘과 설정 아이콘을 통해 접근할 수 있습니다.

## ✅ 구현 완료 항목

### 1. PlanGroupActions 컴포넌트

**파일**: `app/(student)/today/_components/PlanGroupActions.tsx`

- 메모 아이콘 버튼 (📝)
- 범위 조정 아이콘 버튼 (⚙️)
- 상세보기 버튼 (일일 뷰에서만)
- 메모 상태 표시 (배지)
- 메모 미리보기 툴팁

**주요 기능:**
- 메모가 있으면 파란색 + 배지 표시
- 호버 시 메모 미리보기
- 일일/단일 뷰에 맞게 레이아웃 조정

### 2. PlanMemoModal 컴포넌트

**파일**: `app/(student)/today/_components/PlanMemoModal.tsx`

**주요 기능:**
- 메모 작성/수정
- 최대 500자 제한
- 추천 메모 템플릿:
  - 📌 핵심 정리
  - 📌 복습 필요
  - 📌 질문 사항
  - 📌 추가 자료
- 빠른 입력 버튼:
  - 🚀 오늘 목표: ...
  - ⚠️ 주의사항: ...
  - ✅ 완료 체크: ...

### 3. PlanRangeAdjustModal 컴포넌트

**파일**: `app/(student)/today/_components/PlanRangeAdjustModal.tsx`

**주요 기능:**
- 현재 범위 표시
- 조정 방식 선택:
  - 전체 범위 일괄 조정 (기존 비율 유지 분배)
  - 개별 블록 조정 (각 블록 범위 개별 설정)
- 새 범위 입력
- 빠른 조정 버튼:
  - 앞으로/뒤로 5/10 페이지(분)
- 미리보기 및 원래대로 되돌리기
- 범위 검증 (유효성, 겹침 방지, 총량 초과 방지)

### 4. 서버 액션

#### 메모 저장/조회

**파일**: `app/(student)/today/actions/planMemoActions.ts`

- `getPlanMemo`: 플랜 그룹의 메모 조회
- `savePlanMemo`: 플랜 그룹의 메모 저장 (같은 `plan_number`를 가진 모든 플랜 업데이트)

#### 범위 조정

**파일**: `app/(student)/today/actions/planRangeActions.ts`

- `adjustPlanRanges`: 플랜 그룹의 범위 일괄 조정
- 진행 중인 플랜 자동 일시정지
- 범위 검증 및 업데이트

### 5. 통합

**파일**: `app/(student)/today/_components/PlanGroupCard.tsx`

- PlanGroupActions 통합
- PlanMemoModal 통합
- PlanRangeAdjustModal 통합
- 메모 및 범위 조정 핸들러 구현

**파일**: `app/(student)/today/_components/TodayPlanList.tsx`

- 메모 데이터 조회
- 콘텐츠 총량 계산
- 메모 맵 및 총량 맵 생성

**파일**: `app/(student)/today/_components/DailyPlanView.tsx`, `SinglePlanView.tsx`

- 메모 및 총량 데이터 전달

## 🎯 주요 기능

### 메모 기능

1. **메모 작성**
   - 메모 아이콘 클릭 → 모달 열림
   - 텍스트 입력 (최대 500자)
   - 추천 템플릿 및 빠른 입력 버튼 활용
   - 저장 버튼 클릭

2. **메모 수정**
   - 메모 아이콘 클릭 → 기존 메모 표시
   - 텍스트 수정
   - 저장 버튼 클릭

3. **메모 조회**
   - 메모 아이콘 호버 → 툴팁에 미리보기 (최대 50자)
   - 메모 아이콘 클릭 → 전체 메모 확인

4. **메모 삭제**
   - 메모 입력란 비우기
   - 저장 버튼 클릭

### 범위 조정 기능

1. **전체 범위 일괄 조정**
   - 새로운 전체 시작/종료 입력
   - 기존 블록 비율 유지하여 자동 분배
   - 빠른 조정 버튼 활용 (앞으로/뒤로 5/10)

2. **개별 블록 조정**
   - 각 블록별로 시작/종료 페이지 개별 설정
   - 블록 간 겹침 방지
   - 범위 검증 (시작 < 종료, 총량 초과 방지)

3. **미리보기 및 되돌리기**
   - 조정 후 미리보기 확인
   - 원래대로 되돌리기 가능

4. **범위 적용**
   - 진행 중인 플랜 자동 일시정지
   - 범위 업데이트 및 페이지 재검증

## 📊 데이터 구조

### 메모 저장

- 같은 `plan_number`를 가진 모든 플랜의 `memo` 필드 업데이트
- `student_plan` 테이블의 `memo` 컬럼 사용

### 범위 조정

- 같은 `plan_number`를 가진 모든 플랜의 범위 업데이트
- `planned_start_page_or_time`, `planned_end_page_or_time` 필드 업데이트

## 🔄 사용자 인터랙션

### 메모 아이콘

- **클릭**: 메모 모달 열림
- **호버**: 메모 미리보기 툴팁 표시
- **상태 표시**:
  - 메모 없음: 회색 아이콘
  - 메모 있음: 파란색 아이콘 + 배지

### 범위 조정 아이콘

- **클릭**: 범위 조정 모달 열림
- 현재 범위 확인 → 조정 방식 선택 → 새 범위 입력 → 미리보기 → 적용

## ⚠️ 검증 및 주의사항

### 범위 조정 시 검증

1. **범위 유효성**
   - 시작 < 종료
   - 시작 >= 0
   - 종료 <= 총량

2. **블록 간 겹침 방지**
   - 블록 간 범위 겹침 없음
   - 순서 유지 (block_index 기준)

3. **진행 중인 플랜 처리**
   - 범위 조정 시 진행 중인 플랜 일시정지
   - 기존 진행률 유지

4. **총량 초과 방지**
   - 모든 블록의 범위 합이 총량 초과하지 않도록 검증

### 메모 제한

- 최대 500자
- 줄바꿈 허용
- 특수 문자 허용

## 📝 참고사항

### 데이터베이스 스키마

- `student_plan` 테이블에 `memo` 컬럼이 있어야 함
- `memo` 컬럼이 없으면 에러 메시지 표시

### 플랜 그룹화

- 같은 `plan_number`를 가진 플랜들은 하나의 그룹으로 묶임
- 메모는 그룹 단위로 공유
- 범위 조정은 그룹 내 모든 플랜에 적용

## ✅ 체크리스트

- [x] PlanGroupActions 컴포넌트 구현
- [x] PlanMemoModal 컴포넌트 구현
- [x] PlanRangeAdjustModal 컴포넌트 구현
- [x] 메모 저장/조회 서버 액션 구현
- [x] 범위 조정 서버 액션 구현
- [x] PlanGroupCard에 PlanGroupActions 통합
- [x] 메모 데이터 조회 및 전달
- [x] 콘텐츠 총량 계산 및 전달
- [x] 범위 조정 검증 로직
- [x] 진행 중인 플랜 처리 로직

## 🚀 향후 개선 사항

- [ ] 메모 템플릿 사용 빈도 추적 및 추천
- [ ] 범위 조정 히스토리 (변경 이력)
- [ ] 스마트 범위 조정 (AI 추천) 구현
- [ ] 키보드 단축키 지원 (ESC로 모달 닫기 등)
- [ ] 모바일 최적화 (바텀 시트 형태)
- [ ] 애니메이션 효과 추가
- [ ] 토스트 알림으로 성공/실패 피드백

