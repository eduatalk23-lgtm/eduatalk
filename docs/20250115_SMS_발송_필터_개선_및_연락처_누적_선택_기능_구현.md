# SMS 발송 필터 개선 및 연락처 누적 선택 기능 구현

## 작업 일자
2025-01-15

## 개요
SMS 발송 페이지(`/admin/sms/send`)의 필터 시스템을 개선하여 다중 선택 필터와 연락처 누적 선택 기능을 구현했습니다.

## 주요 변경사항

### 1. 필터 구성 변경
- **변경 전**: 단일 선택 (학년, 반, 활성 상태), 페이지 로드 시 자동 조회, 클라이언트 사이드 필터링
- **변경 후**: 다중 선택 (학년, 구분, 전송 대상자), 검색 기능, 버튼 클릭 시 서버 조회, 연락처 단위 누적 선택

### 2. 데이터 흐름 변경
```
[기존]
페이지 로드 → 서버에서 전체 학생 조회 → 클라이언트 필터링 → 선택 → 발송

[변경]
필터 설정 → [조회] 버튼 → API 호출 → 연락처 목록 표시 → 누적 선택 → 발송
```

## 구현 내용

### 1. 새 API 엔드포인트 생성
**파일**: `app/api/admin/sms/students/route.ts`

- 필터 조건에 따라 학생 조회 및 연락처 정보 반환
- Query Parameters:
  - `search`: 이름/전화번호 검색
  - `grades`: 쉼표로 구분된 학년 목록
  - `divisions`: 쉼표로 구분된 구분 목록 (null 값 포함 가능)
  - `recipientTypes`: 쉼표로 구분된 전송 대상자 목록 (필수)
- `is_active = true` 필터 자동 적용
- `getStudentPhonesBatch` 활용하여 연락처 정보 조회

### 2. 다중 선택 필터 컴포넌트
**파일**: `app/(admin)/admin/sms/_components/SMSFilterPanel.tsx`

- 검색: 텍스트 입력
- 학년: 체크박스 다중 선택 (1, 2, 3)
- 구분: 체크박스 다중 선택 (고등부, 중등부, 기타, 미설정)
- 전송 대상자: 체크박스 다중 선택 (학생, 어머니, 아버지) - 필수
- "전체" 버튼으로 일괄 선택/해제
- 선택된 필터 요약 표시
- 조회 버튼 비활성화 조건 (전송 대상자 최소 1개 선택 필수)

### 3. 조회 결과 컴포넌트
**파일**: `app/(admin)/admin/sms/_components/SMSRecipientList.tsx`

- API 조회 결과를 연락처 단위로 표시
- 각 연락처별 체크박스로 개별 선택
- 학생명, 학년, 구분, 전송 대상자 타입, 연락처 표시
- 선택된 연락처 수 표시

### 4. 선택된 연락처 목록 컴포넌트
**파일**: `app/(admin)/admin/sms/_components/SelectedRecipientsList.tsx`

- 누적 선택된 연락처 목록 표시
- 개별 제거 버튼
- 전체 해제 버튼
- 스크롤 가능한 목록

### 5. SMSSendForm 컴포넌트 수정
**파일**: `app/(admin)/admin/sms/_components/SMSSendForm.tsx`

- 기존 `SMSRecipientSelector` 제거
- 새 컴포넌트 통합 (`SMSFilterPanel`, `SMSRecipientList`, `SelectedRecipientsList`)
- 연락처 누적 선택 상태 관리 (Map 사용)
- 발송 로직 수정: `selectedRecipients` Map에서 발송 대상 추출

### 6. 페이지 컴포넌트 수정
**파일**: `app/(admin)/admin/sms/send/page.tsx`

- 초기 학생 목록 조회 제거
- `SMSSendForm`에 `students` prop 제거
- 학원명만 전달

### 7. 발송 API 수정
**파일**: `app/api/purio/send/route.ts`

- `recipients` 배열을 받아서 처리하도록 변경
- 레거시 `studentIds` 지원 유지 (하위 호환성)
- 각 recipient에 `studentId`, `phone`, `recipientType` 포함

### 8. 미리보기 모달 수정
**파일**: `app/(admin)/admin/sms/_components/SMSPreviewModal.tsx`

- `selectedStudents` 대신 `selectedRecipients` 배열 받도록 변경
- 연락처 단위로 미리보기 표시

## 타입 정의

### SMSRecipient
```typescript
type SMSRecipient = {
  studentId: string;
  studentName: string;
  grade: string | null;
  division: StudentDivision | null;
  recipientType: "student" | "mother" | "father";
  phone: string;
};
```

### SMSFilter
```typescript
type SMSFilter = {
  search: string;
  grades: string[];
  divisions: (StudentDivision | null)[];
  recipientTypes: ("student" | "mother" | "father")[];
};
```

## 사용 방법

1. **필터 설정**
   - 검색어 입력 (선택)
   - 학년 다중 선택 (선택)
   - 구분 다중 선택 (선택)
   - 전송 대상자 다중 선택 (필수)

2. **조회 실행**
   - [조회] 버튼 클릭
   - 서버에서 필터 조건에 맞는 연락처 조회

3. **연락처 선택**
   - 조회 결과에서 원하는 연락처 선택
   - 여러 번 조회하여 연락처 누적 선택 가능
   - 중복 선택 방지 (같은 학생의 같은 연락처는 1개만)

4. **발송**
   - 선택된 연락처 목록 확인
   - 메시지 작성
   - [SMS 발송] 버튼 클릭

## 성능 최적화

- `useMemo`: 선택된 연락처 목록 계산
- `useCallback`: 필터 변경 핸들러, 선택/해제 핸들러
- 서버 사이드 필터링으로 클라이언트 부하 감소
- 배치 쿼리 활용 (`getStudentPhonesBatch`)

## 타입 안전성

- `any` 타입 제거
- 명시적 타입 정의
- null 체크 강화
- TypeScript strict mode 준수

## 주의사항

1. **RLS 정책**: API Route에서 tenant_id 필터링 확인
2. **성능**: 대량 조회 시 페이지네이션 고려 (초기 구현은 제한 없음)
3. **에러 처리**: API 호출 실패 시 사용자 친화적 메시지
4. **타입 안전성**: null 값 처리 (division, phone 등)
5. **접근성**: 체크박스 라벨, 키보드 네비게이션

## 테스트 시나리오

1. **기본 조회**: 필터 없이 조회 (전송 대상자만 선택)
2. **다중 필터 조회**: 학년 1,2 + 구분 고등부,중등부 + 전송 대상자 어머니,아버지
3. **누적 선택**: 여러 번 조회하여 연락처 누적 선택
4. **중복 방지**: 같은 학생의 같은 연락처 중복 선택 방지
5. **발송**: 선택된 모든 연락처로 일괄 발송

## 관련 파일

- `app/api/admin/sms/students/route.ts` (신규)
- `app/(admin)/admin/sms/_components/SMSFilterPanel.tsx` (신규)
- `app/(admin)/admin/sms/_components/SMSRecipientList.tsx` (신규)
- `app/(admin)/admin/sms/_components/SelectedRecipientsList.tsx` (신규)
- `app/(admin)/admin/sms/_components/SMSSendForm.tsx` (수정)
- `app/(admin)/admin/sms/_components/SMSPreviewModal.tsx` (수정)
- `app/(admin)/admin/sms/send/page.tsx` (수정)
- `app/api/purio/send/route.ts` (수정)

## 참고

- 기존 필터 패턴: `StudentSearchFilter` 컴포넌트 참고
- 연락처 조회 로직: `getStudentPhonesBatch` 재사용
- 구분 목록: `getActiveStudentDivisionsAction` 활용



