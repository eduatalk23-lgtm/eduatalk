# 관리자 남은 단계 진행 Step 5 플랜 생성 버그 수정

## 작업 일자
2025-12-04

## 문제 상황

관리자 페이지에서 "남은 단계 진행하기" 기능의 최종확인(Step 5) 이후 단계가 진행되지 않는 문제가 발생했습니다.

### 증상
- Step 5 (최종 확인)에서 "플랜 생성하기" 버튼을 클릭해도 Step 6으로 이동하지 않음
- 플랜 생성이 실행되지 않음

### 원인 분석

일괄처리 기능 추가 과정에서 Step 5에서 플랜 생성 및 다음 단계로 이동하는 로직이 누락되었습니다:

1. **`continueCampStepsForAdmin` 함수**: Step 6 또는 Step 7일 때만 플랜 생성 로직이 실행되도록 되어 있었음
2. **`PlanGroupWizard`의 `handleSubmit`**: Step 5에서 저장 후 Step 6으로 이동하는 로직이 없었음

## 해결 방법

### 1. `continueCampStepsForAdmin` 함수 수정

**파일**: `app/(admin)/actions/campTemplateActions.ts`

Step 5일 때도 플랜 생성 로직이 실행되도록 수정했습니다.

**변경 전**:
```typescript
// Step 6 또는 Step 7일 때 플랜 생성 (Step 6에서 Step 7로 이동하기 전에 플랜 생성)
if (step === 6 || step === 7) {
```

**변경 후**:
```typescript
// Step 5, 6 또는 Step 7일 때 플랜 생성 (Step 5에서 플랜 생성 후 Step 6으로 이동)
if (step === 5 || step === 6 || step === 7) {
```

### 2. `PlanGroupWizard`의 `handleSubmit` 함수 수정

**파일**: `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`

Step 5에서 플랜 생성 후 Step 6으로 이동하는 로직을 추가했습니다.

**변경 전**:
```typescript
if (result.success) {
  toast.showSuccess("저장되었습니다.");
  // Step 4에서 호출된 경우 데이터만 저장하고 Step 5로 이동 (플랜 생성은 Step 5에서)
  if (currentStep === 4 && !generatePlans) {
    setDraftGroupId(draftGroupId || (initialData?.groupId as string));
    setCurrentStep(5);
    return;
  }
  // Step 6에서 호출된 경우 데이터만 저장하고 Step 7로 이동 (플랜 생성은 Step 7에서)
  if (currentStep === 6) {
    setDraftGroupId(draftGroupId || (initialData?.groupId as string));
    setCurrentStep(7);
  }
  // ...
}
```

**변경 후**:
```typescript
if (result.success) {
  toast.showSuccess("저장되었습니다.");
  // Step 4에서 호출된 경우 데이터만 저장하고 Step 5로 이동 (플랜 생성은 Step 5에서)
  if (currentStep === 4 && !generatePlans) {
    setDraftGroupId(draftGroupId || (initialData?.groupId as string));
    setCurrentStep(5);
    return;
  }
  // Step 5에서 호출된 경우 플랜 생성 후 Step 6으로 이동
  if (currentStep === 5 && generatePlans) {
    setDraftGroupId(draftGroupId || (initialData?.groupId as string));
    setCurrentStep(6);
    return;
  }
  // Step 6에서 호출된 경우 데이터만 저장하고 Step 7로 이동 (플랜 생성은 Step 7에서)
  if (currentStep === 6) {
    setDraftGroupId(draftGroupId || (initialData?.groupId as string));
    setCurrentStep(7);
    return;
  }
  // ...
}
```

## 수정된 파일 목록

1. `app/(admin)/actions/campTemplateActions.ts`
   - `continueCampStepsForAdmin` 함수에서 Step 5일 때도 플랜 생성 로직 실행

2. `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`
   - `handleSubmit` 함수에서 Step 5 저장 후 Step 6 이동 로직 추가

## 테스트 시나리오

1. 관리자가 "남은 단계 진행하기" 클릭
2. Step 4에서 콘텐츠 선택 후 "다음" 클릭 → Step 5로 이동
3. Step 5에서 "플랜 생성하기" 버튼 클릭
4. 플랜 생성 완료 후 Step 6으로 자동 이동 확인
5. Step 6에서 스케줄 결과 확인
6. Step 7에서 완료 후 참여자 목록으로 이동 확인

## 예상 효과

- ✅ Step 5에서 플랜 생성이 정상적으로 실행됨
- ✅ Step 5에서 Step 6으로 자동 이동됨
- ✅ 관리자 남은 단계 진행 기능이 정상 작동함

