# 학생 신규 등록 및 계정 연결 기능 구현

## 📋 개요

관리자가 학생 목록 페이지에서 신규 학생을 등록하고, 나중에 학생이 회원가입 시 토큰으로 계정을 연결할 수 있는 기능을 구현합니다.

## ✅ 완료된 작업

### Phase 1: 데이터베이스 및 타입 정의

#### 1. student_connection_codes 테이블 마이그레이션

**파일**: `supabase/migrations/20250115000000_create_student_connection_codes.sql`

- 학생 등록 시 생성되는 연결 코드를 저장하는 테이블
- 연결 코드 형식: `STU-XXXX-XXXX` (대문자 영문자 + 숫자)
- 만료 시간: 기본 30일
- 일회성 사용 (used_at 체크)
- RLS 정책:
  - 관리자는 자신의 테넌트 내 모든 코드 조회/생성 가능
  - 학생은 유효한 코드만 조회 가능 (회원가입 시)

#### 2. 학생 정보 Zod 스키마 정의

**파일**: `lib/validation/studentSchemas.ts`

- `studentBasicSchema`: 기본 정보 검증 (이름, 학년, 반, 생년월일 등)
- `studentProfileSchema`: 프로필 정보 검증 (성별, 전화번호, 주소 등)
- `studentCareerSchema`: 진로 정보 검증 (수능 연도, 희망 대학 등)
- `createStudentSchema`: 신규 등록 통합 스키마
- `updateStudentSchema`: 업데이트 스키마 (부분 업데이트 허용)

#### 3. 전화번호 Zod 커스텀 타입

**파일**: `lib/validation/phoneSchema.ts`

- `phone()`: 선택적 전화번호 스키마 (빈 값 허용)
- `requiredPhoneSchema`: 필수 전화번호 스키마
- 자동 정규화: `010-1234-5678` 형식으로 변환
- 검증: 010으로 시작하는 10~11자리만 허용

### Phase 2: Server Actions 구현

#### 1. createStudent Server Action

**파일**: `app/(admin)/actions/studentManagementActions.ts`

**기능**:
- 신규 학생 등록 (인증 계정 없이)
- FormData를 Zod 스키마로 검증
- students, student_profiles, student_career_goals 테이블에 레코드 생성
- 연결 코드 자동 생성 및 저장

**반환값**:
```typescript
{
  success: boolean;
  studentId?: string;
  connectionCode?: string;
  error?: string;
}
```

#### 2. 연결 코드 관련 함수

**generateConnectionCode()**: 연결 코드 생성 (내부 함수)
- 형식: `STU-XXXX-XXXX`
- 대문자 영문자 + 숫자 조합

**validateConnectionCode()**: 연결 코드 검증
- 코드 형식 검증
- 만료 여부 확인
- 사용 여부 확인
- 회원가입 시 사용

**regenerateConnectionCode()**: 연결 코드 재발급
- 기존 코드 비활성화
- 새 코드 생성 및 저장

## 🔄 처리 흐름

### 신규 학생 등록

1. 관리자가 학생 정보 입력 (기본정보, 프로필, 진로정보)
2. FormData를 Zod 스키마로 검증
3. 학생 ID 생성 (UUID)
4. students 테이블 레코드 생성
5. student_profiles 테이블 레코드 생성 (데이터 있는 경우)
6. student_career_goals 테이블 레코드 생성 (데이터 있는 경우)
7. 연결 코드 생성 및 저장 (30일 만료)
8. 학생 ID와 연결 코드 반환

### 계정 연결 (회원가입 시)

1. 학생이 회원가입 시 연결 코드 입력 (선택사항)
2. 연결 코드 검증 (`validateConnectionCode`)
3. 코드 유효성 확인 (만료, 사용 여부)
4. 기존 students 레코드와 사용자 계정 연결
5. 연결 코드 사용 처리 (`used_at` 설정)

## 📝 주요 고려사항

### 데이터베이스 제약

- `students.id`는 PK이므로 직접 업데이트 불가
- 연결 시 기존 레코드 삭제 후 재생성 필요 (CASCADE 주의)
- 또는 매핑 테이블 방식 고려

### 보안

- 연결 코드는 충분한 엔트로피 필요 (대문자 영문자 + 숫자 8자리)
- 만료 시간 설정 (기본 30일)
- 일회성 사용 (used_at 체크)

### 성능

- 연결 코드 인덱스 최적화
- 대량 등록 시 배치 처리 고려

## 🚧 다음 단계

### Phase 3: UI 컴포넌트 구현

1. `useCreateStudentForm` 훅 생성 (신규 등록용)
2. `CreateStudentModal` 컴포넌트 구현
3. `CreateStudentForm` 컴포넌트 구현 (기본정보/프로필/진로 탭)
4. 학생 목록 페이지에 신규 등록 버튼 추가
5. 학생 상세 페이지에 연결 코드 섹션 추가

### Phase 4: 계정 연결 기능

1. 회원가입 페이지에 연결 코드 입력 필드 추가
2. 회원가입 시 계정 연결 로직 구현

## 📚 참고 파일

- 마이그레이션: `supabase/migrations/20250115000000_create_student_connection_codes.sql`
- 스키마: `lib/validation/studentSchemas.ts`
- 전화번호 스키마: `lib/validation/phoneSchema.ts`
- Server Actions: `app/(admin)/actions/studentManagementActions.ts`

