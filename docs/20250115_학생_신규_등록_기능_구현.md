# 학생 신규 등록 및 계정 연결 기능 구현

## 📋 개요

관리자가 학생 목록 페이지에서 신규 학생을 등록하고, 나중에 학생이 회원가입 시 토큰으로 계정을 연결할 수 있는 기능을 구현합니다.

## ✅ 완료된 작업

### Phase 1: 데이터베이스 및 타입 정의

#### 1. student_connection_codes 테이블 마이그레이션

**파일**: `supabase/migrations/20250115000000_create_student_connection_codes.sql`

- 학생 등록 시 생성되는 연결 코드를 저장하는 테이블
- 연결 코드 형식: `STU-XXXX-XXXX` (대문자 영문자 + 숫자)
- 만료 시간: 기본 30일
- 일회성 사용 (used_at 체크)
- RLS 정책:
  - 관리자는 자신의 테넌트 내 모든 코드 조회/생성 가능
  - 학생은 유효한 코드만 조회 가능 (회원가입 시)

#### 2. 학생 정보 Zod 스키마 정의

**파일**: `lib/validation/studentSchemas.ts`

- `studentBasicSchema`: 기본 정보 검증 (이름, 학년, 반, 생년월일 등)
- `studentProfileSchema`: 프로필 정보 검증 (성별, 전화번호, 주소 등)
- `studentCareerSchema`: 진로 정보 검증 (수능 연도, 희망 대학 등)
- `createStudentSchema`: 신규 등록 통합 스키마
- `updateStudentSchema`: 업데이트 스키마 (부분 업데이트 허용)

#### 3. 전화번호 Zod 커스텀 타입

**파일**: `lib/validation/phoneSchema.ts`

- `phone()`: 선택적 전화번호 스키마 (빈 값 허용)
- `requiredPhoneSchema`: 필수 전화번호 스키마
- 자동 정규화: `010-1234-5678` 형식으로 변환
- 검증: 010으로 시작하는 10~11자리만 허용

### Phase 2: Server Actions 구현

#### 1. createStudent Server Action

**파일**: `app/(admin)/actions/studentManagementActions.ts`

**기능**:
- 신규 학생 등록 (인증 계정 없이)
- FormData를 Zod 스키마로 검증
- students, student_profiles, student_career_goals 테이블에 레코드 생성
- 연결 코드 자동 생성 및 저장

**반환값**:
```typescript
{
  success: boolean;
  studentId?: string;
  connectionCode?: string;
  error?: string;
}
```

#### 2. 연결 코드 관련 함수

**generateConnectionCode()**: 연결 코드 생성 (내부 함수)
- 형식: `STU-XXXX-XXXX`
- 대문자 영문자 + 숫자 조합

**validateConnectionCode()**: 연결 코드 검증
- 코드 형식 검증
- 만료 여부 확인
- 사용 여부 확인
- 회원가입 시 사용

**regenerateConnectionCode()**: 연결 코드 재발급
- 기존 코드 비활성화
- 새 코드 생성 및 저장

## 🔄 처리 흐름

### 신규 학생 등록

1. 관리자가 학생 정보 입력 (기본정보, 프로필, 진로정보)
2. FormData를 Zod 스키마로 검증
3. 학생 ID 생성 (UUID)
4. students 테이블 레코드 생성
5. student_profiles 테이블 레코드 생성 (데이터 있는 경우)
6. student_career_goals 테이블 레코드 생성 (데이터 있는 경우)
7. 연결 코드 생성 및 저장 (30일 만료)
8. 학생 ID와 연결 코드 반환

### 계정 연결 (회원가입 시)

1. 학생이 회원가입 시 연결 코드 입력 (선택사항)
2. 연결 코드 검증 (`validateConnectionCode`)
3. 코드 유효성 확인 (만료, 사용 여부)
4. 기존 students 레코드와 사용자 계정 연결
5. 연결 코드 사용 처리 (`used_at` 설정)

## 📝 주요 고려사항

### 데이터베이스 제약

- `students.id`는 PK이므로 직접 업데이트 불가
- 연결 시 기존 레코드 삭제 후 재생성 필요 (CASCADE 주의)
- 또는 매핑 테이블 방식 고려

### 보안

- 연결 코드는 충분한 엔트로피 필요 (대문자 영문자 + 숫자 8자리)
- 만료 시간 설정 (기본 30일)
- 일회성 사용 (used_at 체크)

### 성능

- 연결 코드 인덱스 최적화
- 대량 등록 시 배치 처리 고려

## ✅ 완료된 작업 (Phase 3-4)

### Phase 3: UI 컴포넌트 구현

#### 1. useCreateStudentForm 훅

**파일**: `app/(admin)/admin/students/_hooks/useCreateStudentForm.ts`

- React Hook Form을 사용한 폼 상태 관리
- 기본값 설정 및 리셋 기능

#### 2. CreateStudentModal 컴포넌트

**파일**: `app/(admin)/admin/students/_components/CreateStudentModal.tsx`

- Dialog 컴포넌트를 사용한 모달
- 성공/에러 처리 및 토스트 알림

#### 3. CreateStudentForm 컴포넌트

**파일**: `app/(admin)/admin/students/_components/CreateStudentForm.tsx`

- 탭 구조: 기본정보 / 프로필 / 진로정보
- FormData 변환 및 Server Action 호출
- 각 탭별 입력 필드 구성

#### 4. 학생 목록 페이지 통합

**파일**: `app/(admin)/admin/students/page.tsx`

- "신규 등록" 버튼 추가
- `CreateStudentButton` 컴포넌트 통합

#### 5. 연결 코드 섹션

**파일**: `app/(admin)/admin/students/[id]/_components/ConnectionCodeSection.tsx`

- 학생 상세 페이지에 연결 코드 표시
- 코드 복사 기능
- 재발급 기능
- 만료/사용 여부 표시

### Phase 4: 계정 연결 기능

#### 1. 회원가입 페이지 수정

**파일**: `app/signup/page.tsx`

- 학생 역할 선택 시 연결 코드 입력 필드 표시
- 선택사항으로 처리 (입력하지 않아도 회원가입 가능)

#### 2. 계정 연결 로직 구현

**파일**: `app/actions/auth.ts`

- `linkStudentWithConnectionCode()` 함수 추가
- 연결 코드 검증
- 기존 학생 레코드를 새 사용자 ID로 연결
- 관련 테이블(profiles, career_goals) 데이터 이전
- 연결 코드 사용 처리

**처리 흐름**:
1. 연결 코드 검증 (`validateConnectionCode`)
2. 기존 학생 레코드 데이터 조회
3. 새 사용자 ID로 레코드 재생성
4. 관련 테이블 데이터 이전
5. 기존 레코드 삭제 (CASCADE)
6. 연결 코드 사용 처리 (`used_at` 설정)

## 📚 참고 파일

### 데이터베이스
- 마이그레이션: `supabase/migrations/20250115000000_create_student_connection_codes.sql`

### 검증 및 타입
- 학생 스키마: `lib/validation/studentSchemas.ts`
- 전화번호 스키마: `lib/validation/phoneSchema.ts`
- 폼 타입: `app/(admin)/admin/students/_types/createStudentTypes.ts`

### Server Actions
- 학생 관리: `app/(admin)/actions/studentManagementActions.ts`
  - `createStudent()`: 신규 학생 등록
  - `validateConnectionCode()`: 연결 코드 검증
  - `regenerateConnectionCode()`: 연결 코드 재발급
- 인증: `app/actions/auth.ts`
  - `linkStudentWithConnectionCode()`: 계정 연결

### UI 컴포넌트
- 훅: `app/(admin)/admin/students/_hooks/useCreateStudentForm.ts`
- 모달: `app/(admin)/admin/students/_components/CreateStudentModal.tsx`
- 폼: `app/(admin)/admin/students/_components/CreateStudentForm.tsx`
- 버튼: `app/(admin)/admin/students/_components/CreateStudentButton.tsx`
- 연결 코드 섹션: `app/(admin)/admin/students/[id]/_components/ConnectionCodeSection.tsx`

## 🎯 사용 방법

### 관리자: 신규 학생 등록

1. 학생 목록 페이지(`/admin/students`)에서 "신규 등록" 버튼 클릭
2. 모달에서 학생 정보 입력:
   - 기본 정보 탭: 이름, 학교, 학년, 생년월일 등
   - 프로필 탭: 성별, 연락처, 주소 등 (선택사항)
   - 진로 정보 탭: 수능연도, 교육과정, 희망 대학 등 (선택사항)
3. "등록" 버튼 클릭
4. 연결 코드가 생성되어 표시됨
5. 연결 코드를 복사하여 학생에게 전달

### 관리자: 연결 코드 관리

1. 학생 상세 페이지(`/admin/students/[id]`)에서 "연결 코드" 섹션 확인
2. 코드 복사: "복사" 버튼 클릭
3. 재발급: "재발급" 버튼 클릭 (기존 코드는 자동으로 비활성화)

### 학생: 회원가입 시 계정 연결

1. 회원가입 페이지(`/signup`)에서 회원 유형을 "학생"으로 선택
2. 연결 코드 입력 필드에 관리자가 발급한 코드 입력 (선택사항)
   - 형식: `STU-XXXX-XXXX`
   - 코드를 입력하지 않아도 회원가입 가능 (새 학생으로 등록)
3. 회원가입 완료
4. 연결 코드가 유효한 경우, 기존 학생 정보와 계정이 자동으로 연결됨

## ⚠️ 주의사항

### 데이터베이스 제약

- `students.id`는 PK이므로 직접 업데이트 불가
- 연결 시 기존 레코드 삭제 후 새 ID로 재생성 (CASCADE 주의)
- 관련 테이블(`student_profiles`, `student_career_goals`)도 함께 이전

### 보안

- 연결 코드는 충분한 엔트로피 필요 (대문자 영문자 + 숫자 8자리)
- 만료 시간 설정 (기본 30일)
- 일회성 사용 (used_at 체크)
- RLS 정책으로 접근 제어

### 성능

- 연결 코드 인덱스 최적화
- 대량 등록 시 배치 처리 고려
- 트랜잭션 처리로 데이터 일관성 보장

## 🔄 향후 개선 사항

1. **QR 코드 생성**: 연결 코드를 QR 코드로 변환하여 쉽게 공유
2. **이메일/SMS 발송**: 연결 코드를 자동으로 이메일 또는 SMS로 발송
3. **일괄 등록**: 엑셀 파일 업로드로 여러 학생을 한 번에 등록
4. **연결 코드 히스토리**: 사용된 연결 코드의 히스토리 조회
5. **만료 알림**: 연결 코드 만료 전 알림 기능

