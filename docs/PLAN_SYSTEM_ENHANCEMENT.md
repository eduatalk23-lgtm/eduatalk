# 플랜 생성 시스템 고도화 기획서

> v2.0 - 콘텐츠별 플랜그룹 및 유연한 스케줄 관리

---

## 목차

1. [개요](#1-개요)
2. [콘텐츠별 플랜그룹 생성](#2-콘텐츠별-플랜그룹-생성)
3. [컨테이너/독 고도화](#3-컨테이너독-고도화)
4. [재조정 기능 통합](#4-재조정-기능-통합)
5. [단일 플랜 추가](#5-단일-플랜-추가)
6. [데이터 모델 변경](#6-데이터-모델-변경)
7. [UI/UX 설계](#7-uiux-설계)
8. [구현 로드맵](#8-구현-로드맵)

---

## 1. 개요

### 1.1 배경

현재 플랜 시스템은 7단계 위자드를 통해 여러 콘텐츠를 하나의 플랜그룹으로 묶어 관리합니다. 이 방식은 종합적인 학습 계획에 적합하지만, 단일 콘텐츠 중심의 유연한 학습 관리에는 한계가 있습니다.

### 1.2 목표

```
┌─────────────────────────────────────────────────────────────┐
│                    플랜 시스템 고도화 목표                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 콘텐츠 중심 플랜 관리                                   │
│     └─ 콘텐츠 1개 = 플랜그룹 1개 (최대 9개 동시 관리)       │
│                                                             │
│  2. 유연한 스케줄 조정                                      │
│     └─ 드래그앤드롭, 컨테이너 이동, 일괄 재배치             │
│                                                             │
│  3. 실시간 재조정                                           │
│     └─ 범위/기간 변경 시 자동 재계산                        │
│                                                             │
│  4. 다양한 플랜 추가 방식                                   │
│     └─ Ad-hoc + 플랜그룹 내 플랜 추가                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 기존 시스템과의 관계

| 구분 | 기존 7단계 위자드 | 새로운 콘텐츠별 방식 |
|------|------------------|---------------------|
| 역할 | **학습 템플릿** (설정 재사용) | **독립 인스턴스** (템플릿 상속) |
| 유지 | O (그대로 유지) | 신규 추가 |
| 사용 시나리오 | 종합 학습 설정 정의 | 콘텐츠별 빠른 플랜 생성 |
| 콘텐츠 수 | 다중 (무제한) | 단일 (플랜그룹당 1개) |
| 설정 복잡도 | 7단계 상세 설정 | 범위 + 전략/취약 옵션만 |
| 관리 단위 | 템플릿 (재사용) | 콘텐츠 단위 (독립) |

### 1.4 핵심 변경: 위저드 = 학습 템플릿

```
┌─────────────────────────────────────────────────────────────┐
│              위저드 플랜그룹 = 학습 템플릿                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [기존 인식]                                                │
│  위저드로 플랜그룹 생성 → 1회성 사용 → 완료되면 끝          │
│                                                             │
│  [새로운 인식]                                              │
│  위저드로 플랜그룹 생성 → 학습 템플릿으로 활용              │
│                       ↓                                     │
│              새 콘텐츠 추가 시 설정값 상속                  │
│                       ↓                                     │
│              지속적인 학습 관리 컨테이너                    │
│                                                             │
│  [상속되는 설정값]                                          │
│  ├─ 기간 (period_start, period_end)                        │
│  ├─ 학습 요일 (weekdays)                                   │
│  ├─ 블록세트/시간대 (block_set_id, study_hours)            │
│  ├─ 제외일 (exclusions)                                    │
│  ├─ 스케줄러 옵션 (scheduler_options)                      │
│  └─ 학습/복습 주기 (study_days, review_days)               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 콘텐츠별 플랜그룹 생성

### 2.1 핵심 개념

**"템플릿(위저드) 설정 상속 + 콘텐츠별 독립 관리"** 원칙으로,
위저드에서 정의한 설정을 기반으로 각 콘텐츠마다 독립적인 플랜그룹을 생성합니다.

```
┌─────────────────────────────────────────────────────────────┐
│                  템플릿 기반 콘텐츠별 플랜그룹                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [위저드 플랜그룹] = 학습 템플릿                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📋 수능대비 종합 플랜 (템플릿)                      │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  기간: 2025-01-06 ~ 2025-02-28                      │   │
│  │  요일: 월화수목금                                    │   │
│  │  블록세트: 기본 시간표                               │   │
│  │  제외일: 설날연휴, 개인일정...                       │   │
│  │  스케줄러: 1730 Timetable                           │   │
│  │                                                      │   │
│  │  [+ 콘텐츠 추가하기]                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓ 설정 상속                         │
│  [콘텐츠별 플랜그룹] = 독립 인스턴스 (최대 9개)            │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 수학 인강   │  │ 국어 교재   │  │ 영어 단어장 │ ...     │
│  │ ─────────── │  │ ─────────── │  │ ─────────── │         │
│  │ 범위: 1-50강│  │ 범위: 1-200p│  │ 범위: D1-30 │         │
│  │ 유형: 전략  │  │ 유형: 취약  │  │ 유형: 취약  │         │
│  │ 배정: 주3일 │  │ 배정: 매일  │  │ 배정: 매일  │         │
│  │ ●●●●○ 80%  │  │ ●●○○○ 40%  │  │ ●○○○○ 20%  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ※ 각 콘텐츠별 플랜그룹은 템플릿의 기간/요일/시간대 상속    │
│  ※ 전략/취약 옵션에 따라 배분 방식이 다름                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 전략/취약 과목 배분 방식

```
┌─────────────────────────────────────────────────────────────┐
│                  전략/취약 과목 배분 로직                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [취약 과목] - 매일 학습                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  특징:                                               │   │
│  │  - 모든 학습일에 배정                                │   │
│  │  - 일일 분량 = 총 범위 ÷ 학습일 수                   │   │
│  │                                                      │   │
│  │  예: 국어 교재 200p, 학습일 20일                     │   │
│  │      → 일일 10p (매일)                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [전략 과목] - 주당 N일 학습                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  특징:                                               │   │
│  │  - 주당 2~4일만 배정 (사용자 선택)                   │   │
│  │  - 일일 분량 = 총 범위 ÷ (주 수 × 주당 일수)         │   │
│  │                                                      │   │
│  │  예: 수학 인강 50강, 4주, 주 3일                     │   │
│  │      → 주당 12.5강, 일일 약 4강                      │   │
│  │      → 월/수/금만 배정                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [배분 알고리즘]                                            │
│  1. 취약 과목 먼저 모든 학습일에 슬롯 배정                  │
│  2. 전략 과목은 지정된 요일에만 슬롯 배정                   │
│  3. 같은 날 여러 과목 → 시간대별로 분배                     │
│  4. 충돌 시 → 취약 과목 우선                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│                  콘텐츠별 플랜그룹 구조                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  학생 A의 활성 플랜그룹들 (최대 9개)                        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ PlanGroup 1 │  │ PlanGroup 2 │  │ PlanGroup 3 │ ...     │
│  │ ─────────── │  │ ─────────── │  │ ─────────── │         │
│  │ 수학 인강   │  │ 국어 교재   │  │ 영어 단어장 │         │
│  │ (1-50강)    │  │ (1-200p)    │  │ (Day 1-30)  │         │
│  │             │  │             │  │             │         │
│  │ 기간: 4주   │  │ 기간: 3주   │  │ 기간: 1달   │         │
│  │ 요일: 월수금│  │ 요일: 화목  │  │ 요일: 매일  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  [+ 콘텐츠 추가] (9개 미만일 때 활성화)                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 생성 플로우 (간소화)

템플릿(위저드)에서 설정을 상속받기 때문에, 콘텐츠별 플랜그룹 생성은 **4단계**로 간소화됩니다.

```
┌─────────────────────────────────────────────────────────────┐
│          콘텐츠별 플랜그룹 생성 플로우 (간소화)              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ※ 템플릿에서 상속되는 설정 (자동 적용):                   │
│     기간, 학습 요일, 블록세트, 제외일, 스케줄러 옵션        │
│                                                             │
│  Step 1: 콘텐츠 선택                                        │
│  ┌─────────────────────────────────────────┐               │
│  │  📚 내 콘텐츠에서 선택                   │               │
│  │  ┌─────────────────────────────────────┐│               │
│  │  │ [검색...]                           ││               │
│  │  │                                     ││               │
│  │  │ ○ 수학 개념완성 (인강)             ││               │
│  │  │ ● 국어 독해력 교재                 ││               │
│  │  │ ○ 영어 단어장                       ││               │
│  │  │ ○ 과학 문제집                       ││               │
│  │  └─────────────────────────────────────┘│               │
│  │                                          │               │
│  │  [+ 마스터 콘텐츠에서 추가]              │               │
│  └─────────────────────────────────────────┘               │
│                         ↓                                   │
│  Step 2: 범위 설정                                          │
│  ┌─────────────────────────────────────────┐               │
│  │  📖 국어 독해력 교재                     │               │
│  │                                          │               │
│  │  범위 설정:                              │               │
│  │  시작: [ 1  ] 페이지                     │               │
│  │  종료: [200 ] 페이지                     │               │
│  │                                          │               │
│  │  또는 [대단원/중단원으로 선택]           │               │
│  │                                          │               │
│  │  ⚡ 추천: 일일 10p (템플릿 기간 기준)    │               │
│  └─────────────────────────────────────────┘               │
│                         ↓                                   │
│  Step 3: 학습 유형 선택                                     │
│  ┌─────────────────────────────────────────┐               │
│  │  이 콘텐츠의 학습 유형을 선택하세요:     │               │
│  │                                          │               │
│  │  ┌─────────────────────────────────────┐│               │
│  │  │ 🔥 취약 과목                         ││               │
│  │  │ ───────────────────────────────────││               │
│  │  │ • 매일 학습                          ││               │
│  │  │ • 모든 학습일에 플랜 배정           ││               │
│  │  │ • 꾸준한 실력 향상에 적합           ││               │
│  │  └─────────────────────────────────────┘│               │
│  │                                          │               │
│  │  ┌─────────────────────────────────────┐│               │
│  │  │ ⚡ 전략 과목                         ││               │
│  │  │ ───────────────────────────────────││               │
│  │  │ • 주 N일 학습 (선택 가능)            ││               │
│  │  │ • 집중 학습에 적합                   ││               │
│  │  │                                      ││               │
│  │  │ 주당 학습일: [2일] [3일] [4일]      ││               │
│  │  └─────────────────────────────────────┘│               │
│  └─────────────────────────────────────────┘               │
│                         ↓                                   │
│  Step 4: 미리보기 및 생성                                   │
│  ┌─────────────────────────────────────────┐               │
│  │  📋 플랜 생성 요약                       │               │
│  │  ─────────────────────────────────────── │               │
│  │                                          │               │
│  │  📚 콘텐츠: 국어 독해력 교재             │               │
│  │  📄 범위: 1p ~ 200p (200페이지)          │               │
│  │  🔥 유형: 취약 과목 (매일 학습)          │               │
│  │                                          │               │
│  │  [템플릿에서 상속된 설정]                │               │
│  │  📅 기간: 2025-01-06 ~ 2025-02-02        │               │
│  │  📆 학습일: 월화수목금 (총 20일)         │               │
│  │  ⏰ 시간대: 기본 시간표                  │               │
│  │                                          │               │
│  │  [자동 계산된 분량]                      │               │
│  │  📊 일일 분량: 10p                       │               │
│  │  📈 완료 예상일: 2025-02-02              │               │
│  │                                          │               │
│  │  [플랜 미리보기]                         │               │
│  │  ┌─────────────────────────────────────┐│               │
│  │  │ 1/6(월)  p.1-10   09:00-10:00       ││               │
│  │  │ 1/7(화)  p.11-20  09:00-10:00       ││               │
│  │  │ 1/8(수)  p.21-30  09:00-10:00       ││               │
│  │  │ ...                                  ││               │
│  │  └─────────────────────────────────────┘│               │
│  │                                          │               │
│  │  [취소]              [플랜그룹 생성]     │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 템플릿 설정 오버라이드 (선택적)

특별한 경우, 템플릿 설정을 개별 콘텐츠에서 오버라이드할 수 있습니다.

```
┌─────────────────────────────────────────────────────────────┐
│                  템플릿 설정 오버라이드                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 4 미리보기 화면에서:                                  │
│                                                             │
│  [템플릿에서 상속된 설정] [수정하기 ▼]                      │
│  ┌─────────────────────────────────────────┐               │
│  │ ☐ 기간 변경                             │               │
│  │    └─ 이 콘텐츠만 다른 기간 적용        │               │
│  │                                          │               │
│  │ ☐ 학습 요일 변경                        │               │
│  │    └─ 특정 요일에만 이 콘텐츠 학습      │               │
│  │                                          │               │
│  │ ☐ 시간대 변경                           │               │
│  │    └─ 다른 시간대에 배정                │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
│  ※ 오버라이드 시 해당 콘텐츠만 독립적으로 관리됨            │
│  ※ 대부분의 경우 템플릿 설정 그대로 사용 권장              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 타입 정의

```typescript
// lib/domains/plan/types/contentPlanGroup.ts

/**
 * 콘텐츠별 플랜그룹 생성 입력
 * - 템플릿(위저드 플랜그룹)에서 설정 상속
 * - 콘텐츠, 범위, 학습 유형만 지정
 */
interface CreateContentPlanGroupInput {
  // 템플릿 참조 (위저드로 생성된 플랜그룹)
  templatePlanGroupId: string;

  // Step 1: 콘텐츠 선택
  content: {
    id: string;
    type: 'book' | 'lecture' | 'custom';
    name: string;
  };

  // Step 2: 범위 설정
  range: {
    start: number;  // 시작 페이지/회차
    end: number;    // 종료 페이지/회차
    unit: 'page' | 'lecture' | 'day' | 'chapter';
  };

  // Step 3: 학습 유형 선택
  studyType: {
    type: 'weakness' | 'strategy';
    // 전략 과목일 때만 사용
    daysPerWeek?: 2 | 3 | 4;
    // 배정될 요일 (자동 계산 또는 직접 지정)
    preferredDays?: number[];  // 0-6 (일-토)
  };

  // Step 4: 템플릿 설정 오버라이드 (선택적)
  overrides?: {
    period?: {
      startDate: string;  // YYYY-MM-DD
      endDate: string;
    };
    weekdays?: number[];  // 0-6
    blockSetId?: string;
    timeSlots?: Array<{
      start: string;  // HH:mm
      end: string;
    }>;
  };
}

/**
 * 템플릿에서 상속받는 설정값
 */
interface InheritedTemplateSettings {
  period: {
    startDate: string;
    endDate: string;
  };
  weekdays: number[];
  blockSetId: string | null;
  studyHours: string | null;
  exclusions: Array<{
    date: string;
    reason: string;
  }>;
  schedulerOptions: {
    strategy: 'even' | 'time_slot' | 'manual' | 'hybrid';
    studyDays: number;
    reviewDays: number;
  };
}

/**
 * 콘텐츠별 플랜그룹 생성 결과
 */
interface ContentPlanGroupResult {
  planGroup: {
    id: string;
    templatePlanGroupId: string;
    contentId: string;
    studyType: 'weakness' | 'strategy';
    createdAt: string;
  };
  plans: Array<{
    id: string;
    date: string;
    rangeStart: number;
    rangeEnd: number;
    startTime: string | null;
    endTime: string | null;
  }>;
  summary: {
    totalDays: number;
    dailyAmount: number;
    expectedCompletionDate: string;
  };
}
```

### 2.6 스케줄링 알고리즘

#### 2.6.1 균등 분배

```typescript
interface EvenDistributionParams {
  totalAmount: number;      // 총 분량 (페이지/회차)
  studyDays: Date[];        // 학습 가능 일자
  reviewCycle?: {
    studyDays: number;      // 학습일 수 (기본: 6)
    reviewDays: number;     // 복습일 수 (기본: 1)
  };
}

// 결과: 각 날짜별 분량 균등 배분
// 예: 100페이지 / 10일 = 일일 10페이지
```

#### 2.6.2 시간대 기반

```typescript
interface TimeSlotDistributionParams {
  totalAmount: number;
  studyDays: Date[];
  blockSetId: string;       // 시간표 템플릿
  studentLevel: 'high' | 'medium' | 'low';
  contentDifficulty: number;
}

// 결과: 시간대별로 분량 계산
// 예: 오전 2시간 = 20페이지, 오후 3시간 = 30페이지
```

#### 2.6.3 수동 배치

```typescript
interface ManualDistributionParams {
  contentId: string;
  manualPlans: Array<{
    date: string;           // YYYY-MM-DD
    startRange: number;     // 시작 범위
    endRange: number;       // 종료 범위
    startTime?: string;     // HH:mm
    endTime?: string;       // HH:mm
  }>;
}

// 결과: 사용자가 직접 지정한 대로 배치
```

#### 2.6.4 유연한 혼합

```typescript
interface HybridDistributionParams {
  // 기본은 자동 생성
  autoGenerate: boolean;
  baseStrategy: 'even' | 'time_slot';

  // 생성 후 수동 조정 허용
  allowManualAdjustment: boolean;

  // 재계산 트리거
  recalculateOnChange: boolean;
}
```

### 2.7 플랜 실행 플로우: 독 → 시작 → 타임라인 스탬프

**핵심 개념**: 생성된 플랜은 바로 타임라인에 표시되지 않습니다.
학생이 실제로 학습을 시작해야 타임라인에 기록됩니다.

```
┌─────────────────────────────────────────────────────────────┐
│              플랜 실행 플로우 (핵심 개념)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [플랜 생성]                                                │
│      ↓                                                      │
│  [당일 학습 독(Daily Dock)]  ← 플랜이 여기에 대기           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📚 오늘의 학습 목록                                 │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  ○ 수학 인강 25강        [시작하기]                 │   │
│  │  ○ 수학 인강 26강        [시작하기]                 │   │
│  │  ○ 국어 교재 p.61-80     [시작하기]                 │   │
│  │  ● 영어 단어 Day 8       [진행 중...] ← 현재 학습   │   │
│  │  ✓ 과학 문제집 p.1-10    완료 14:30                 │   │
│  └─────────────────────────────────────────────────────┘   │
│      ↓ 학생이 "시작하기" 클릭                               │
│  [학습 시작]                                                │
│      ↓                                                      │
│  [타임라인에 스탬프 기록]  ← 실제 학습 시간 기록            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📅 오늘의 타임라인 (실제 학습 기록)                 │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  09:15 ████████  과학 문제집 (35분)                 │   │
│  │  10:00 ░░░░░░░░  (휴식)                             │   │
│  │  10:30 ████████████████  영어 단어 (진행 중)        │   │
│  │  ...                                                │   │
│  │                                                      │   │
│  │  ※ 타임라인 = 실제 학습한 시간의 기록               │   │
│  │  ※ 예정된 시간이 아닌, 실제 시작/종료 시간          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│                  플랜 상태 흐름                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [pending]  →  [in_dock]  →  [in_progress]  →  [completed] │
│     ↓            ↓              ↓                ↓          │
│   생성됨     당일 독에      학습 중         학습 완료       │
│             표시됨       (타임라인 기록)   (스탬프 확정)    │
│                                                             │
│  상태별 위치:                                               │
│  ├─ pending: 아직 해당 날짜가 아님 (캘린더에만 표시)        │
│  ├─ in_dock: 당일 학습 독에 표시 (시작 대기)               │
│  ├─ in_progress: 타이머 작동 중, 타임라인에 진행 표시       │
│  └─ completed: 타임라인에 완료 스탬프                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```typescript
// 타입 정의
interface PlanExecutionState {
  planId: string;
  status: 'pending' | 'in_dock' | 'in_progress' | 'completed' | 'skipped';

  // 독에 표시될 때
  dockInfo?: {
    displayOrder: number;
    estimatedDuration: number;  // 예상 소요 시간 (분)
  };

  // 학습 시작 시 (타임라인 스탬프)
  execution?: {
    startedAt: string;          // 실제 시작 시간
    endedAt?: string;           // 실제 종료 시간
    actualDuration?: number;    // 실제 소요 시간 (분)
    timerPausedTotal?: number;  // 일시정지 총 시간
  };

  // 타임라인 스탬프 정보
  timelineStamp?: {
    startTime: string;          // HH:mm
    endTime?: string;           // HH:mm
    color: string;              // 콘텐츠별 색상
    label: string;              // 표시 라벨
  };
}

// 플랜 시작 액션
interface StartPlanAction {
  planId: string;
  startedAt: Date;              // 실제 시작 시간
  // 타임라인 스탬프 생성
  createTimelineStamp: true;
}

// 플랜 완료 액션
interface CompletePlanAction {
  planId: string;
  endedAt: Date;                // 실제 종료 시간
  actualProgress: {
    rangeCompleted: number;     // 실제 완료 범위
    notes?: string;             // 메모
  };
  // 타임라인 스탬프 확정
  finalizeTimelineStamp: true;
}
```

### 2.8 9개 제한 관리

```typescript
interface ContentPlanGroupLimit {
  maxActivePlanGroups: 9;

  // 제한 초과 시 동작
  onLimitReached: 'block' | 'archive_oldest' | 'warn_and_allow';

  // 아카이브 정책
  archivePolicy: {
    autoArchiveCompleted: boolean;  // 완료된 플랜그룹 자동 아카이브
    archiveAfterDays: number;       // N일 후 자동 아카이브
  };
}
```

---

## 3. 컨테이너/독 고도화

### 3.1 현재 컨테이너 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    현재 컨테이너 구조                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Unfinished (미완료)                                        │
│  ├─ 어제 이전 미완료 플랜들                                 │
│  └─ 이월된 플랜 표시                                        │
│                                                             │
│  Daily (일간)                                               │
│  ├─ 오늘 해야 할 플랜들                                     │
│  └─ 타임라인 시각화                                         │
│                                                             │
│  Weekly (주간)                                              │
│  └─ 이번 주 내 해야 할 플랜들                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 고도화된 컨테이너 구조

**핵심 변경**: 타임라인은 예정된 플랜이 아닌, **실제 학습 기록(스탬프)**을 표시합니다.

```
┌─────────────────────────────────────────────────────────────┐
│              고도화된 컨테이너/독/타임라인 구조              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           CONTENT DOCK (콘텐츠 독)                   │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │ 수학    │ │ 국어    │ │ 영어    │ │ + 추가  │   │   │
│  │  │ 인강    │ │ 교재    │ │ 단어장  │ │         │   │   │
│  │  │ ●●●○○  │ │ ●●○○○  │ │ ●○○○○  │ │         │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  │  (콘텐츠별 플랜그룹 진행률 요약)                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │        DAILY DOCK (당일 학습 독) - 시작 대기         │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  ○ 수학 인강 25강         예상 45분  [▶ 시작하기]   │   │
│  │  ○ 수학 인강 26강         예상 45분  [▶ 시작하기]   │   │
│  │  ○ 국어 교재 p.61-80      예상 60분  [▶ 시작하기]   │   │
│  │  ● 영어 단어 Day 8        진행 중... [⏸ 15:32]      │   │
│  │  ✓ 과학 문제집 p.1-10     완료 (35분) 14:00-14:35   │   │
│  │                                                      │   │
│  │  ※ 플랜 클릭 → 학습 시작 → 타임라인에 기록          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │       TIMELINE (타임라인) - 실제 학습 기록           │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │                                                      │   │
│  │  14:00 ████████  과학 문제집 p.1-10 (35분) ✓        │   │
│  │  14:35 ░░░░░░░░  (휴식)                             │   │
│  │  15:00 ████████████████▓▓  영어 단어 Day 8          │   │
│  │        └─ 현재 진행 중 (32분 경과)                   │   │
│  │                                                      │   │
│  │  ※ 타임라인 = 실제 시작/종료 시간 기록              │   │
│  │  ※ 예정된 시간표가 아님!                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    CONTAINERS                        │   │
│  │                                                      │   │
│  │  [Unfinished: 2]  [Weekly: 8]                       │   │
│  │                                                      │   │
│  │  Unfinished (미완료 플랜)                           │   │
│  │  ┌────────────────────────────────────────────┐     │   │
│  │  │ ⚠ 12/26 수학 인강 23강     [오늘로 이동]   │     │   │
│  │  │ ⚠ 12/26 국어 교재 p.41-60  [오늘로 이동]   │     │   │
│  │  └────────────────────────────────────────────┘     │   │
│  │                                                      │   │
│  │  Weekly (이번 주 예정)                              │   │
│  │  ┌────────────────────────────────────────────┐     │   │
│  │  │ 12/28 (토) 수학 인강 27-28강               │     │   │
│  │  │ 12/29 (일) 영어 단어 Day 9-10              │     │   │
│  │  │ ...                                         │     │   │
│  │  └────────────────────────────────────────────┘     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 학습 시작 → 타임라인 스탬프 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                 학습 시작 → 스탬프 생성 플로우               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Daily Dock에서 플랜 선택                               │
│     ┌─────────────────────────────────────────┐            │
│     │ ○ 수학 인강 25강         [▶ 시작하기]  │            │
│     └─────────────────────────────────────────┘            │
│                         ↓                                   │
│  2. "시작하기" 클릭                                         │
│     └─ 현재 시간 기록: 15:32                               │
│     └─ 타이머 시작                                         │
│                         ↓                                   │
│  3. 타임라인에 진행 중 스탬프 생성                          │
│     ┌─────────────────────────────────────────┐            │
│     │ 15:32 ████████▓▓▓▓  수학 인강 25강      │            │
│     │       └─ 진행 중 (12분)                  │            │
│     └─────────────────────────────────────────┘            │
│                         ↓                                   │
│  4. 학습 완료 또는 중단                                     │
│     └─ 종료 시간 기록: 16:15                               │
│     └─ 실제 학습 시간 계산: 43분                           │
│                         ↓                                   │
│  5. 타임라인 스탬프 확정                                    │
│     ┌─────────────────────────────────────────┐            │
│     │ 15:32 ████████████  수학 인강 25강 ✓    │            │
│     │       └─ 완료 (43분)                     │            │
│     └─────────────────────────────────────────┘            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 드래그앤드롭 날짜 변경

#### 3.4.1 플랜 날짜 변경 (캘린더 뷰)

```
┌─────────────────────────────────────────────────────────────┐
│                타임라인 내 드래그 (시간 변경)                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  드래그 전:                                                 │
│  09:00 ████████████  수학 인강 21강                        │
│  10:00 ████████████  수학 인강 22강                        │
│                                                             │
│  드래그 중: (21강을 11:00으로 이동)                        │
│  09:00 ░░░░░░░░░░░░  (빈 슬롯)                             │
│  10:00 ████████████  수학 인강 22강                        │
│  11:00 ▓▓▓▓▓▓▓▓▓▓▓▓  수학 인강 21강 (이동 중)              │
│                                                             │
│  드래그 후:                                                 │
│  09:00 ░░░░░░░░░░░░  (빈 슬롯)                             │
│  10:00 ████████████  수학 인강 22강                        │
│  11:00 ████████████  수학 인강 21강 ✓                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 3.4.2 캘린더 드래그 (날짜 변경)

```
┌─────────────────────────────────────────────────────────────┐
│                 캘린더 드래그 (날짜 변경)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│       월        화        수        목        금            │
│  ┌─────────┬─────────┬─────────┬─────────┬─────────┐       │
│  │ 6       │ 7       │ 8       │ 9       │ 10      │       │
│  │ ●●●     │ ●●      │ ●●●●    │ ●       │ ●●      │       │
│  │         │         │         │         │         │       │
│  └─────────┴─────────┴─────────┴─────────┴─────────┘       │
│                                                             │
│  드래그: 6일의 플랜을 9일로 이동                           │
│                                                             │
│       월        화        수        목        금            │
│  ┌─────────┬─────────┬─────────┬─────────┬─────────┐       │
│  │ 6       │ 7       │ 8       │ 9       │ 10      │       │
│  │ ●●      │ ●●      │ ●●●●    │ ●● ← +1 │ ●●      │       │
│  │   ↘     │         │         │         │         │       │
│  └─────────┴─────────┴─────────┴─────────┴─────────┘       │
│                                                             │
│  [확인] 6일의 "수학 인강 21강"을 9일로 이동하시겠습니까?   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.5 컨테이너 간 이동 강화

```
┌─────────────────────────────────────────────────────────────┐
│                  컨테이너 간 이동 강화                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [현재 기능]                                                │
│  - Daily ↔ Weekly 이동                                     │
│  - Unfinished → Daily 이동                                 │
│                                                             │
│  [고도화 기능]                                              │
│                                                             │
│  1. 다중 선택 이동                                          │
│     ┌──────────────────────────────────┐                   │
│     │ [✓] 수학 인강 21강               │                   │
│     │ [✓] 수학 인강 22강               │                   │
│     │ [ ] 국어 교재 p.45-60            │                   │
│     │ [✓] 영어 단어 Day 5              │                   │
│     │                                   │                   │
│     │ 선택된 3개 플랜:                  │                   │
│     │ [Daily로 이동] [Weekly로 이동]    │                   │
│     └──────────────────────────────────┘                   │
│                                                             │
│  2. 스와이프 제스처 (모바일)                                │
│     ← 스와이프: Weekly로 이동                              │
│     → 스와이프: Daily로 이동                               │
│                                                             │
│  3. 컨텍스트 메뉴                                           │
│     ┌──────────────────┐                                   │
│     │ 📅 날짜 변경      │                                   │
│     │ 📦 Daily로 이동   │                                   │
│     │ 📦 Weekly로 이동  │                                   │
│     │ 🗑️ 삭제           │                                   │
│     │ ✏️ 수정           │                                   │
│     └──────────────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.6 일괄 재배치

```
┌─────────────────────────────────────────────────────────────┐
│                     일괄 재배치 기능                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  트리거:                                                    │
│  - 버튼 클릭: [일괄 재배치]                                 │
│  - 선택 후: [선택 항목 재배치]                              │
│                                                             │
│  ┌─────────────────────────────────────────┐               │
│  │          일괄 재배치 모달               │               │
│  ├─────────────────────────────────────────┤               │
│  │                                          │               │
│  │  대상: 미완료 플랜 5개                   │               │
│  │                                          │               │
│  │  재배치 방식:                            │               │
│  │  (x) 내일로 이동                         │               │
│  │  ( ) 특정 날짜로 이동: [____]            │               │
│  │  ( ) 기간 내 분산: [시작] ~ [종료]       │               │
│  │  ( ) 다음 가능한 빈 슬롯으로             │               │
│  │                                          │               │
│  │  시간 설정:                              │               │
│  │  [x] 기존 시간 유지                      │               │
│  │  [ ] 새 시간 지정: [09:00] ~ [12:00]     │               │
│  │                                          │               │
│  │  충돌 처리:                              │               │
│  │  ( ) 기존 플랜 뒤로 밀기                 │               │
│  │  (x) 빈 슬롯에만 배치                    │               │
│  │  ( ) 기존 플랜 덮어쓰기                  │               │
│  │                                          │               │
│  │  [미리보기]  [취소]  [재배치 실행]       │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.7 액션 타입 정의

```typescript
// lib/domains/plan/actions/container.ts

type ContainerMoveAction =
  | { type: 'MOVE_TO_DAILY'; planId: string }
  | { type: 'MOVE_TO_WEEKLY'; planId: string }
  | { type: 'MOVE_TO_DATE'; planId: string; targetDate: string }
  | { type: 'MOVE_BULK_TO_DATE'; planIds: string[]; targetDate: string }
  | { type: 'REDISTRIBUTE'; planIds: string[]; strategy: RedistributeStrategy };

type RedistributeStrategy =
  | { type: 'TOMORROW' }
  | { type: 'SPECIFIC_DATE'; date: string }
  | { type: 'SPREAD'; startDate: string; endDate: string }
  | { type: 'NEXT_AVAILABLE_SLOT' };

interface RedistributeOptions {
  keepOriginalTime: boolean;
  newTimeRange?: { start: string; end: string };
  conflictResolution: 'push_back' | 'empty_slots_only' | 'overwrite';
}
```

---

## 4. 재조정 기능 통합

### 4.1 재조정 트리거

```
┌─────────────────────────────────────────────────────────────┐
│                    재조정 트리거 상황                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 범위 수정                                               │
│     ├─ 교재: 시작/종료 페이지 변경                         │
│     ├─ 강의: 시작/종료 회차 변경                           │
│     └─ 자동으로 남은 플랜 재계산                           │
│                                                             │
│  2. 기간 변경                                               │
│     ├─ 종료일 연장 → 일일 분량 감소                        │
│     ├─ 종료일 단축 → 일일 분량 증가                        │
│     └─ 시작일 변경 → 전체 재배치                           │
│                                                             │
│  3. 콘텐츠 추가/제거                                        │
│     ├─ 플랜그룹에 콘텐츠 추가 → 시간 재배분                │
│     └─ 플랜그룹에서 콘텐츠 제거 → 빈 슬롯 처리             │
│                                                             │
│  4. 요일 변경                                               │
│     ├─ 학습 요일 추가/제거                                 │
│     └─ 플랜 재분배                                         │
│                                                             │
│  5. 진도 변경                                               │
│     ├─ 완료된 플랜의 진도 수정                             │
│     └─ 남은 플랜에 반영                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 재조정 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                    재조정 플로우                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [범위 수정 예시]                                           │
│                                                             │
│  Before:                                                    │
│  ┌─────────────────────────────────────────┐               │
│  │ 📚 수학 교재                             │               │
│  │ 범위: 1p ~ 200p                          │               │
│  │ 기간: 1/6 ~ 1/26 (15일)                  │               │
│  │ 일일 분량: 약 13.3p                      │               │
│  │                                          │               │
│  │ 완료: 1p ~ 80p (6일 완료)                │               │
│  │ 남은 범위: 81p ~ 200p (120p)             │               │
│  │ 남은 일수: 9일                           │               │
│  │ 예상 일일 분량: 13.3p                    │               │
│  └─────────────────────────────────────────┘               │
│                         ↓                                   │
│  [사용자 액션] 범위를 1p ~ 150p로 수정                      │
│                         ↓                                   │
│  After:                                                     │
│  ┌─────────────────────────────────────────┐               │
│  │ 📚 수학 교재                             │               │
│  │ 범위: 1p ~ 150p (수정됨)                 │               │
│  │ 기간: 1/6 ~ 1/26 (15일)                  │               │
│  │                                          │               │
│  │ 완료: 1p ~ 80p (6일 완료)                │               │
│  │ 남은 범위: 81p ~ 150p (70p) ← 변경       │               │
│  │ 남은 일수: 9일                           │               │
│  │ 예상 일일 분량: 7.8p ← 자동 재계산       │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 재조정 모달 UI

```
┌─────────────────────────────────────────────────────────────┐
│                    플랜그룹 재조정                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📚 수학 인강                                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 콘텐츠 범위                                          │   │
│  │ ─────────────────────────────────────────────────── │   │
│  │ 시작: [1]강  →  종료: [50]강                        │   │
│  │                                                      │   │
│  │ 완료: 20강 / 50강 (40%)                             │   │
│  │ ████████░░░░░░░░░░░░                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 학습 기간                                            │   │
│  │ ─────────────────────────────────────────────────── │   │
│  │ 시작일: [2025-01-06]  종료일: [2025-02-02]          │   │
│  │                                                      │   │
│  │ 경과: 10일 / 20일                                   │   │
│  │ ██████████░░░░░░░░░░                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 학습 요일                                            │   │
│  │ ─────────────────────────────────────────────────── │   │
│  │ [x] 월  [x] 화  [x] 수  [x] 목  [x] 금  [ ] 토  [ ] 일 │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 재조정 미리보기                                      │   │
│  │ ─────────────────────────────────────────────────── │   │
│  │ 남은 범위: 21강 ~ 50강 (30강)                       │   │
│  │ 남은 일수: 10일                                     │   │
│  │ 예상 일일 분량: 3강                                 │   │
│  │                                                      │   │
│  │ 변경 플랜:                                          │   │
│  │ - 1/17 (금): 21~23강 (기존: 21~24강)               │   │
│  │ - 1/20 (월): 24~26강 (기존: 25~28강)               │   │
│  │ - ...                                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [취소]                              [재조정 적용]          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 재조정 API

```typescript
// lib/domains/plan/actions/readjust.ts

interface ReadjustPlanGroupParams {
  planGroupId: string;
  changes: {
    // 범위 변경
    newRange?: {
      start: number;
      end: number;
    };
    // 기간 변경
    newPeriod?: {
      startDate: string;
      endDate: string;
    };
    // 요일 변경
    newWeekdays?: number[];  // 0-6
    // 콘텐츠 추가
    addContent?: {
      contentId: string;
      contentType: 'book' | 'lecture' | 'custom';
      range: { start: number; end: number };
    };
    // 콘텐츠 제거
    removeContentId?: string;
  };
  options: {
    preserveCompleted: boolean;      // 완료된 플랜 유지
    recalculateStrategy: 'even' | 'proportional' | 'manual';
    notifyStudent: boolean;
  };
}

interface ReadjustResult {
  success: boolean;
  affectedPlans: number;
  preview: {
    before: PlanSummary[];
    after: PlanSummary[];
  };
  warnings: string[];
}
```

---

## 5. 단일 플랜 추가

### 5.1 두 가지 방식

```
┌─────────────────────────────────────────────────────────────┐
│                    단일 플랜 추가 방식                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  방식 1: Ad-hoc 플랜 (독립)                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  특징:                                               │   │
│  │  - 플랜그룹에 속하지 않는 독립 플랜                  │   │
│  │  - 일회성 또는 반복 설정 가능                        │   │
│  │  - 자유로운 콘텐츠 (기존 콘텐츠 or 임시 입력)        │   │
│  │                                                      │   │
│  │  사용 예:                                            │   │
│  │  - "오늘 갑자기 추가된 숙제"                        │   │
│  │  - "특강 수강"                                      │   │
│  │  - "시험 전 마무리 복습"                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  방식 2: 플랜그룹 내 플랜 추가                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  특징:                                               │   │
│  │  - 기존 플랜그룹에 플랜 추가                         │   │
│  │  - 해당 콘텐츠의 특정 범위로 플랜 생성               │   │
│  │  - 플랜그룹의 통계에 포함                            │   │
│  │                                                      │   │
│  │  사용 예:                                            │   │
│  │  - "오늘 추가로 10페이지 더 공부"                   │   │
│  │  - "복습을 위해 이전 범위 다시 플랜 추가"           │   │
│  │  - "빈 날짜에 플랜 추가"                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Ad-hoc 플랜 UI 개선

```
┌─────────────────────────────────────────────────────────────┐
│                  Ad-hoc 플랜 추가 (개선)                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────┐               │
│  │ ⚡ 빠른 플랜 추가                        │               │
│  ├─────────────────────────────────────────┤               │
│  │                                          │               │
│  │ 제목: [수학 복습                    ]    │               │
│  │                                          │               │
│  │ 콘텐츠 연결:                             │               │
│  │ ( ) 없음 (자유 입력)                     │               │
│  │ (x) 내 콘텐츠에서 선택                   │               │
│  │     └─ [수학 인강 v]                     │               │
│  │                                          │               │
│  │ 날짜: [2025-01-15]                       │               │
│  │ 시간: [14:00] ~ [15:30]                  │               │
│  │                                          │               │
│  │ 범위 (선택):                             │               │
│  │ [21]강 ~ [23]강                          │               │
│  │                                          │               │
│  │ 반복:                                    │               │
│  │ ( ) 반복 안 함                           │               │
│  │ (x) 반복 설정                            │               │
│  │     ├─ 매주 [월, 수, 금]                 │               │
│  │     └─ 종료: [2025-02-28]                │               │
│  │                                          │               │
│  │ 컨테이너: [Daily v]                      │               │
│  │                                          │               │
│  │ [취소]              [추가하기]           │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 플랜그룹 내 플랜 추가 UI

```
┌─────────────────────────────────────────────────────────────┐
│               플랜그룹 내 플랜 추가                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────┐               │
│  │ 📚 수학 인강 플랜그룹에 플랜 추가        │               │
│  ├─────────────────────────────────────────┤               │
│  │                                          │               │
│  │ 현재 진행 상황:                          │               │
│  │ ████████████░░░░░░░░  20/50강 (40%)     │               │
│  │                                          │               │
│  │ 추가할 범위:                             │               │
│  │ ┌─────────────────────────────────────┐ │               │
│  │ │ ( ) 다음 범위 (21강~)               │ │               │
│  │ │ (x) 특정 범위 지정                  │ │               │
│  │ │     [15]강 ~ [20]강 (복습)          │ │               │
│  │ │ ( ) 완료되지 않은 범위 재시도       │ │               │
│  │ └─────────────────────────────────────┘ │               │
│  │                                          │               │
│  │ 추가할 날짜:                             │               │
│  │ (x) 오늘 [2025-01-15]                    │               │
│  │ ( ) 특정 날짜 [____]                     │               │
│  │ ( ) 다음 빈 슬롯                         │               │
│  │                                          │               │
│  │ 시간:                                    │               │
│  │ [19:00] ~ [20:30]                        │               │
│  │                                          │               │
│  │ [취소]              [플랜 추가]          │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 플랜 추가 진입점

```
┌─────────────────────────────────────────────────────────────┐
│                 플랜 추가 진입점 (Multiple)                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Today 페이지 FAB                                        │
│     ┌───────┐                                              │
│     │  +    │  → [빠른 추가] [플랜그룹에서 추가]           │
│     └───────┘                                              │
│                                                             │
│  2. 캘린더 빈 슬롯 클릭                                     │
│     ┌───────────────────────────────────┐                  │
│     │ 1/15 14:00                         │                  │
│     │ (빈 슬롯 클릭)                     │                  │
│     │                                    │                  │
│     │ [+ 플랜 추가]                      │                  │
│     └───────────────────────────────────┘                  │
│                                                             │
│  3. 플랜그룹 상세 페이지                                    │
│     ┌───────────────────────────────────┐                  │
│     │ 📚 수학 인강                       │                  │
│     │ [재조정] [플랜 추가] [삭제]        │                  │
│     └───────────────────────────────────┘                  │
│                                                             │
│  4. 컨테이너 하단                                           │
│     ┌───────────────────────────────────┐                  │
│     │ Daily 컨테이너                     │                  │
│     │ ├─ 플랜 1                          │                  │
│     │ ├─ 플랜 2                          │                  │
│     │ └─ [+ 플랜 추가]                   │                  │
│     └───────────────────────────────────┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 모델 변경

### 6.1 플랜그룹 테이블 확장

```sql
-- 기존 plan_groups 테이블에 추가할 컬럼

ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  creation_mode VARCHAR(20) DEFAULT 'wizard'
  CHECK (creation_mode IN ('wizard', 'content_based', 'template', 'camp'));

-- 템플릿 참조 (콘텐츠별 플랜그룹이 상속받을 위저드 플랜그룹)
ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  template_plan_group_id UUID REFERENCES plan_groups(id);

-- 학습 유형 (전략/취약)
ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  study_type VARCHAR(20) DEFAULT NULL
  CHECK (study_type IN ('weakness', 'strategy'));

-- 전략 과목: 주당 학습일 수
ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  strategy_days_per_week INTEGER DEFAULT NULL
  CHECK (strategy_days_per_week BETWEEN 2 AND 4);

ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  content_count INTEGER DEFAULT 1;

ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  scheduling_strategy VARCHAR(20) DEFAULT 'time_slot'
  CHECK (scheduling_strategy IN ('even', 'time_slot', 'manual', 'hybrid'));

ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  allow_manual_adjustment BOOLEAN DEFAULT true;

ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  last_readjusted_at TIMESTAMPTZ;

ALTER TABLE plan_groups ADD COLUMN IF NOT EXISTS
  readjustment_count INTEGER DEFAULT 0;

-- 인덱스 추가
CREATE INDEX idx_plan_groups_creation_mode ON plan_groups(creation_mode);
CREATE INDEX idx_plan_groups_student_active ON plan_groups(student_id, status)
  WHERE status = 'active';
CREATE INDEX idx_plan_groups_template ON plan_groups(template_plan_group_id)
  WHERE template_plan_group_id IS NOT NULL;
CREATE INDEX idx_plan_groups_study_type ON plan_groups(study_type)
  WHERE study_type IS NOT NULL;
```

### 6.2 플랜 테이블 확장

```sql
-- 기존 student_plans 테이블에 추가할 컬럼

ALTER TABLE student_plans ADD COLUMN IF NOT EXISTS
  source_type VARCHAR(20) DEFAULT 'auto'
  CHECK (source_type IN ('auto', 'manual', 'adhoc', 'readjusted'));

ALTER TABLE student_plans ADD COLUMN IF NOT EXISTS
  original_plan_id UUID REFERENCES student_plans(id);  -- 재조정 시 원본 참조

ALTER TABLE student_plans ADD COLUMN IF NOT EXISTS
  moved_from_date DATE;  -- 이동 전 원래 날짜

ALTER TABLE student_plans ADD COLUMN IF NOT EXISTS
  moved_at TIMESTAMPTZ;  -- 이동 시각

-- 인덱스 추가
CREATE INDEX idx_student_plans_source ON student_plans(source_type);
```

### 6.3 재조정 히스토리 테이블

```sql
-- 새 테이블: 재조정 히스토리

CREATE TABLE plan_readjustment_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  plan_group_id UUID NOT NULL REFERENCES plan_groups(id),

  -- 변경 내용
  change_type VARCHAR(50) NOT NULL,  -- range, period, weekdays, content_add, content_remove
  before_state JSONB NOT NULL,
  after_state JSONB NOT NULL,

  -- 영향받은 플랜
  affected_plan_ids UUID[] NOT NULL,
  affected_plan_count INTEGER NOT NULL,

  -- 메타데이터
  triggered_by UUID REFERENCES auth.users(id),
  triggered_at TIMESTAMPTZ DEFAULT NOW(),
  reason TEXT,

  -- RLS
  CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- RLS 정책
ALTER TABLE plan_readjustment_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "tenant_isolation" ON plan_readjustment_history
  FOR ALL USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

-- 인덱스
CREATE INDEX idx_readjust_history_plan_group ON plan_readjustment_history(plan_group_id);
CREATE INDEX idx_readjust_history_triggered_at ON plan_readjustment_history(triggered_at DESC);
```

### 6.4 활성 플랜그룹 제한 함수

```sql
-- 활성 플랜그룹 수 체크 함수

CREATE OR REPLACE FUNCTION check_active_plan_group_limit()
RETURNS TRIGGER AS $$
DECLARE
  active_count INTEGER;
  max_limit INTEGER := 9;
BEGIN
  -- content_based 모드일 때만 제한 적용
  IF NEW.creation_mode = 'content_based' AND NEW.status = 'active' THEN
    SELECT COUNT(*) INTO active_count
    FROM plan_groups
    WHERE student_id = NEW.student_id
      AND creation_mode = 'content_based'
      AND status = 'active'
      AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000'::uuid);

    IF active_count >= max_limit THEN
      RAISE EXCEPTION 'Maximum active content-based plan groups (%) reached', max_limit;
    END IF;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_plan_group_limit
  BEFORE INSERT OR UPDATE ON plan_groups
  FOR EACH ROW
  EXECUTE FUNCTION check_active_plan_group_limit();
```

---

## 7. UI/UX 설계

### 7.1 플랜 관리 메인 페이지 재설계

```
┌─────────────────────────────────────────────────────────────┐
│                  /plan 메인 페이지 (재설계)                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [나의 학습 콘텐츠]                    [+ 콘텐츠 추가] │   │
│  │                                                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │ 수학    │ │ 국어    │ │ 영어    │ │ 과학    │   │   │
│  │  │ 인강    │ │ 교재    │ │ 단어장  │ │ 문제집  │   │   │
│  │  │         │ │         │ │         │ │         │   │   │
│  │  │ ●●●●○  │ │ ●●○○○  │ │ ●○○○○  │ │ 시작전  │   │   │
│  │  │ 80%    │ │ 40%    │ │ 20%    │ │         │   │   │
│  │  │         │ │         │ │         │ │ [시작]  │   │   │
│  │  │ 1/26    │ │ 2/2     │ │ 1/31    │ │         │   │   │
│  │  │ 마감    │ │ 마감    │ │ 마감    │ │         │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  │                                                      │   │
│  │  ← 스크롤 (최대 9개) →                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [이번 주 일정]                        [캘린더 보기] │   │
│  │                                                      │   │
│  │  월 6     화 7     수 8     목 9     금 10           │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐          │   │
│  │  │ ●●● │ │ ●●  │ │ ●●●●│ │ ●   │ │ ●●  │          │   │
│  │  │ 3개  │ │ 2개  │ │ 4개  │ │ 1개  │ │ 2개  │          │   │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘          │   │
│  │                                                      │   │
│  │  오늘 (1/8): 4개 플랜                               │   │
│  │  ├─ 09:00 수학 인강 25강                            │   │
│  │  ├─ 10:00 수학 인강 26강                            │   │
│  │  ├─ 12:00 국어 교재 p.61-80                         │   │
│  │  └─ 14:00 영어 단어 Day 8                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [기존 플랜그룹]                       [+ 새 플랜 만들기] │   │
│  │                                                      │   │
│  │  종합 플랜그룹 (7단계 위자드로 생성된 플랜)          │   │
│  │  ├─ 수능대비 종합 플랜                              │   │
│  │  └─ ...                                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 콘텐츠 카드 상세

```
┌─────────────────────────────────────────────────────────────┐
│                    콘텐츠 카드 상세 뷰                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  카드 클릭 시 확장:                                         │
│                                                             │
│  ┌─────────────────────────────────────────┐               │
│  │ 📚 수학 인강                             │               │
│  │ ─────────────────────────────────────── │               │
│  │                                          │               │
│  │ 진행률: ████████████░░░░░░░░  25/50강   │               │
│  │                                          │               │
│  │ 기간: 2025-01-06 ~ 2025-01-26           │               │
│  │ 남은 일수: 10일                          │               │
│  │ 예상 일일 분량: 2.5강                    │               │
│  │                                          │               │
│  │ 오늘 플랜:                               │               │
│  │ □ 09:00 25강 (진행 중)                  │               │
│  │ □ 10:00 26강                            │               │
│  │                                          │               │
│  │ [재조정]  [플랜 추가]  [상세보기]        │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 모바일 최적화

```
┌───────────────────────┐
│    모바일 Today       │
├───────────────────────┤
│                       │
│  ┌─────────────────┐ │
│  │ 콘텐츠 독 (가로) │ │
│  │ ┌───┐┌───┐┌───┐ │ │
│  │ │수학││국어││영어│ │ │
│  │ └───┘└───┘└───┘ │ │
│  │     ← 스와이프 → │ │
│  └─────────────────┘ │
│                       │
│  ┌─────────────────┐ │
│  │ 오늘의 플랜      │ │
│  │ ───────────────  │ │
│  │ □ 수학 25강      │ │
│  │   09:00-10:00    │ │
│  │   → 스와이프로   │ │
│  │   이동/삭제      │ │
│  │ ───────────────  │ │
│  │ □ 수학 26강      │ │
│  │   10:00-11:00    │ │
│  │ ───────────────  │ │
│  │ ...              │ │
│  └─────────────────┘ │
│                       │
│  ┌───┐               │
│  │ + │ FAB           │
│  └───┘               │
│                       │
└───────────────────────┘
```

---

## 8. 구현 로드맵

### 8.1 Phase 1: 콘텐츠별 플랜그룹 기반 (2주)

| 작업 | 세부 내용 | 예상 기간 |
|------|----------|----------|
| DB 스키마 | 테이블 확장, 함수 생성 | 2일 |
| 콘텐츠별 플랜그룹 API | 생성, 조회, 수정, 삭제 | 3일 |
| 스케줄링 엔진 | 4가지 전략 구현 | 3일 |
| 생성 UI | 6단계 간소화 플로우 | 3일 |
| 플랜 관리 페이지 | 메인 페이지 리디자인 | 2일 |

### 8.2 Phase 2: 컨테이너/독 고도화 (2주)

| 작업 | 세부 내용 | 예상 기간 |
|------|----------|----------|
| 독 UI | 콘텐츠별 요약 카드 | 2일 |
| 드래그앤드롭 강화 | 날짜 변경, 시간 변경 | 3일 |
| 컨테이너 이동 | 다중 선택, 스와이프 | 2일 |
| 일괄 재배치 | 모달 UI, 미리보기 | 3일 |
| 모바일 최적화 | 터치 제스처, 반응형 | 2일|

### 8.3 Phase 3: 재조정 기능 (1.5주)

| 작업 | 세부 내용 | 예상 기간 |
|------|----------|----------|
| 재조정 API | 범위/기간/요일 변경 | 3일 |
| 재조정 모달 | 미리보기, 확인 | 2일 |
| 히스토리 | 재조정 기록 저장/조회 | 2일 |
| 자동 재계산 | 트리거 기반 업데이트 | 1일 |

### 8.4 Phase 4: 단일 플랜 추가 (1주)

| 작업 | 세부 내용 | 예상 기간 |
|------|----------|----------|
| Ad-hoc 개선 | UI 리디자인, 반복 기능 | 2일 |
| 플랜그룹 내 추가 | 범위 지정 추가 | 2일 |
| 진입점 통합 | FAB, 캘린더, 컨테이너 | 1일 |

### 8.5 Phase 5: 통합 및 테스트 (1주)

| 작업 | 세부 내용 | 예상 기간 |
|------|----------|----------|
| 통합 테스트 | E2E 테스트 작성 | 2일 |
| 성능 최적화 | 쿼리 최적화, 캐싱 | 2일 |
| 버그 수정 | QA 피드백 반영 | 1일 |

### 8.6 전체 일정

```
┌─────────────────────────────────────────────────────────────┐
│                      전체 일정 (약 7.5주)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Week 1-2: Phase 1 (콘텐츠별 플랜그룹)                      │
│  ████████████████████████████████████░░░░░░░░░░░░░░░░░░   │
│                                                             │
│  Week 3-4: Phase 2 (컨테이너/독 고도화)                     │
│  ░░░░░░░░░░░░░░░░░░████████████████████████████████████   │
│                                                             │
│  Week 5: Phase 3 (재조정 기능)                              │
│  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████████████████░   │
│                                                             │
│  Week 6: Phase 4 (단일 플랜 추가)                           │
│  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████████   │
│                                                             │
│  Week 7: Phase 5 (통합 및 테스트)                           │
│  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 부록

### A. 기존 코드 영향 분석

| 파일/모듈 | 변경 유형 | 설명 |
|-----------|----------|------|
| `lib/domains/plan/` | 확장 | 새로운 액션 추가 |
| `lib/domains/today/` | 수정 | 컨테이너 고도화 |
| `lib/domains/admin-plan/` | 확장 | 재조정 기능 통합 |
| `app/(student)/plan/` | 재설계 | 메인 페이지 UI |
| `app/(student)/today/` | 수정 | 독 UI 추가 |

### B. 마이그레이션 전략

1. **기존 데이터 호환성**: 기존 플랜그룹은 `creation_mode: 'wizard'`로 자동 설정
2. **점진적 롤아웃**: 기능 플래그로 새 기능 활성화 제어
3. **롤백 계획**: 각 Phase별 롤백 스크립트 준비

### C. 성능 고려사항

1. **인덱스 최적화**: 새로운 컬럼에 적절한 인덱스 추가
2. **쿼리 최적화**: 활성 플랜그룹 조회 시 partial index 활용
3. **캐싱**: React Query로 클라이언트 캐싱, 서버 캐싱 레이어 추가

---

*문서 버전: 2.1*
*최초 작성일: 2025-12-27*
*최종 수정일: 2025-12-27*
*상태: 검토 중*

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2025-12-27 | 초안 작성 |
| 2.0 | 2025-12-27 | 템플릿 상속 개념 반영, 생성 플로우 간소화 (6단계→4단계), 전략/취약 과목 배분 로직 추가 |
| 2.1 | 2025-12-27 | 플랜 실행 플로우 추가: 독(Dock) → 학습 시작 → 타임라인 스탬프 개념 반영 |
