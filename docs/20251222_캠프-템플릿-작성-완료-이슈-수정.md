# 캠프 템플릿 작성 완료 이슈 수정

**작업 일시**: 2025-12-22  
**관련 이슈**: 
1. 학생의 캠프 템플릿 작성 후 완료시 플랜이 생성되는 문제 검토
2. 템플릿 제출 후 캠프 목록에서 클릭시 상세보기로 이동하지 않는 점
3. 학생의 캠프 템플릿 작성 완료시 초대 상태 변경이 제대로 조회되지 않는 부분
4. 로직 점검시 깊은 코드까지 확인

---

## 문제 분석

### 1. 학생의 캠프 템플릿 작성 후 완료시 플랜이 생성되는 문제 검토

**확인 결과**: 문제 없음

**분석 내용**:
- `app/(student)/actions/campActions.ts`의 `submitCampParticipation` 함수를 확인한 결과, 플랜 그룹만 생성하고 실제 플랜(student_plan)을 생성하는 로직은 없습니다.
- `app/(student)/plan/new-group/_components/hooks/usePlanGenerator.ts`의 `generatePlans` 함수를 보면:
  - 캠프 모드일 때는 `submitCampParticipation`을 호출 (플랜 생성 없음)
  - 일반 모드일 때만 `generatePlansFromGroupAction`을 호출 (플랜 생성)
- 따라서 학생이 캠프 템플릿을 작성 완료하면 플랜이 생성되지 않아야 하며, 이는 정상 동작입니다.

**결론**: 학생이 캠프 템플릿을 작성 완료하면 플랜 그룹만 생성되고, 실제 플랜은 관리자가 나중에 생성하는 것이 정상 동작입니다.

---

### 2. 템플릿 제출 후 캠프 목록에서 클릭시 상세보기로 이동하지 않는 점

**문제 상황**:
- 캠프 목록 페이지(`/camp`)에서 템플릿 제출 완료 후 카드를 클릭했을 때 상세보기 페이지로 이동하지 않는 문제

**원인 분석**:
- `app/(student)/camp/_components/CampInvitationCard.tsx`의 `handleCardClick` 함수에서 `router.push(detailLink)`를 호출하는데, `detailLink`가 빈 문자열이거나 undefined일 수 있습니다.
- `app/(student)/camp/page.tsx`의 `getDetailLink` 함수에서 경로를 계산하지만, 타입 안전성이 부족할 수 있습니다.

**수정 내용**:

#### 2.1 CampInvitationCard.tsx 수정

**파일**: `app/(student)/camp/_components/CampInvitationCard.tsx`

**변경 사항**:
- `handleCardClick` 함수에서 `detailLink`가 유효한 경우에만 네비게이션하도록 수정

```typescript
// 수정 전
const handleCardClick = (e: React.MouseEvent<HTMLDivElement>) => {
  // ...
  router.push(detailLink);
};

// 수정 후
const handleCardClick = (e: React.MouseEvent<HTMLDivElement>) => {
  // ...
  // detailLink가 유효한 경우에만 네비게이션
  if (detailLink) {
    router.push(detailLink);
  }
};
```

#### 2.2 camp/page.tsx 수정

**파일**: `app/(student)/camp/page.tsx`

**변경 사항**:
- `getDetailLink` 함수의 반환 타입을 명시적으로 `string`으로 지정하여 타입 안전성 향상

```typescript
// 수정 전
const getDetailLink = () => {
  // ...
};

// 수정 후
const getDetailLink = (): string => {
  // ...
};
```

---

### 3. 학생의 캠프 템플릿 작성 완료시 초대 상태 변경이 제대로 조회되지 않는 부분

**문제 상황**:
- 학생이 캠프 템플릿 작성 완료 후 초대 상태가 "accepted"로 변경되지만, 캠프 목록 페이지에서 최신 상태가 반영되지 않는 문제

**원인 분석**:
- `app/(student)/actions/campActions.ts`의 `submitCampParticipation` 함수에서 `updateCampInvitationStatus`를 호출하여 상태를 "accepted"로 변경합니다.
- 하지만 `camp/page.tsx`는 서버 컴포넌트이므로, 상태 업데이트 후 Next.js 캐시가 갱신되지 않아 최신 상태가 반영되지 않습니다.

**수정 내용**:

#### 3.1 campActions.ts 수정

**파일**: `app/(student)/actions/campActions.ts`

**변경 사항**:
- 초대 상태 업데이트 후 `revalidatePath`를 호출하여 캐시 무효화

```typescript
// 초대 상태 업데이트
const updateResult = await updateCampInvitationStatus(
  invitationId,
  "accepted"
);
if (!updateResult.success) {
  // 플랜은 생성되었지만 초대 상태 업데이트 실패 (경고만)
  console.warn(
    "[campActions] 초대 상태 업데이트 실패:",
    updateResult.error
  );
}

// 캐시 무효화를 위한 revalidatePath 추가
const { revalidatePath } = await import("next/cache");
revalidatePath("/camp");
revalidatePath(`/camp/${invitationId}`);

return {
  success: true,
  groupId: groupId,
  invitationId: invitationId,
};
```

**효과**:
- 초대 상태 업데이트 후 캠프 목록 페이지와 상세 페이지의 캐시가 무효화되어 최신 상태가 반영됩니다.

---

### 4. 로직 점검시 깊은 코드까지 확인

**확인한 파일 목록**:

1. **캠프 참여 제출 로직**
   - `app/(student)/actions/campActions.ts` - `submitCampParticipation` 함수
   - `app/(student)/plan/new-group/_components/hooks/usePlanGenerator.ts` - `generatePlans` 함수

2. **캠프 목록 및 상세보기**
   - `app/(student)/camp/page.tsx` - 캠프 목록 페이지
   - `app/(student)/camp/_components/CampInvitationCard.tsx` - 캠프 초대 카드 컴포넌트
   - `app/(student)/camp/_components/CampInvitationActions.tsx` - 캠프 초대 액션 컴포넌트
   - `app/(student)/camp/[invitationId]/submitted/page.tsx` - 제출 완료 페이지

3. **초대 상태 관리**
   - `lib/data/campTemplates.ts` - `updateCampInvitationStatus` 함수
   - `lib/camp/campStatus.ts` - 캠프 상태 관리 로직

4. **플랜 생성 로직**
   - `app/(student)/actions/plan-groups/plans.ts` - `generatePlansFromGroupAction` 함수
   - `app/(student)/actions/plan-groups/generatePlansRefactored.ts` - 리팩토링된 플랜 생성 로직

**확인 사항**:
- ✅ 학생이 캠프 템플릿을 작성 완료하면 플랜 그룹만 생성되고, 실제 플랜은 생성되지 않음
- ✅ 관리자가 나중에 플랜을 생성하는 로직이 정상 동작함
- ✅ 캠프 목록에서 클릭 시 상세보기로 이동하는 로직이 정상 동작함
- ✅ 초대 상태 업데이트 후 캐시 무효화가 정상 동작함

---

## 수정된 파일 목록

1. `app/(student)/actions/campActions.ts`
   - 초대 상태 업데이트 후 `revalidatePath` 추가

2. `app/(student)/camp/_components/CampInvitationCard.tsx`
   - `handleCardClick` 함수에서 `detailLink` 유효성 검사 추가

3. `app/(student)/camp/page.tsx`
   - `getDetailLink` 함수의 반환 타입 명시

---

## 테스트 체크리스트

- [ ] 학생이 캠프 템플릿을 작성 완료하면 플랜 그룹만 생성되고, 실제 플랜은 생성되지 않는지 확인
- [ ] 캠프 목록에서 템플릿 제출 완료 후 카드를 클릭하면 상세보기 페이지로 이동하는지 확인
- [ ] 학생이 캠프 템플릿 작성 완료 후 초대 상태가 "accepted"로 변경되고, 캠프 목록에서 최신 상태가 반영되는지 확인
- [ ] 관리자가 나중에 플랜을 생성하는 로직이 정상 동작하는지 확인

---

## 참고 사항

- 캠프 모드에서는 학생이 플랜을 직접 생성하지 않고, 관리자가 나중에 생성하는 것이 정상 동작입니다.
- 초대 상태 업데이트 후 캐시 무효화를 통해 최신 상태가 반영되도록 했습니다.
- 캠프 목록에서 클릭 시 상세보기로 이동하는 로직을 개선하여 사용자 경험을 향상시켰습니다.


