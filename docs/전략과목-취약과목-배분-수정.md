# 전략과목/취약과목 플랜 배분 미반영 문제 수정

## 문제 분석

터미널 로그 분석 결과:
- `subjectAllocations`에 `subject_type: 'strategy'`가 설정되어 있음
- `subject_name`: '국내도서 > 중/고등참고서 > 고등학교 과목별 > 고등자습서 > 한국사/동아시아사/세계사/지리'
- 콘텐츠의 `subject_category`: '국어'
- `getContentAllocation` 함수에서 정확 일치 비교로 매칭 실패
- 결과적으로 기본값인 `weakness`로 처리됨

## 수정 내용

### 1. `getContentAllocation` 함수 타입 정의 수정

**파일**: `lib/plan/1730TimetableLogic.ts`

- `subjectAllocations` 타입에 `subject_id` 필드 추가
- 콘텐츠 파라미터에 `subject`, `subject_id` 필드 추가

### 2. 매칭 로직 개선

**파일**: `lib/plan/1730TimetableLogic.ts`

매칭 우선순위:
1. `subject_id`로 매칭 (가장 정확) - 콘텐츠에 `subject_id`가 있는 경우
2. `subject_name`과 `subject_category` 정확 일치
3. `subject_name`에 `subject_category`가 포함되는지 확인 (부분 매칭)
4. `subject` 필드도 매칭 조건에 포함
5. 기본값 (weakness)

### 3. 콘텐츠 정보 전달 개선

**파일**: `lib/plan/scheduler.ts`

- `getContentAllocation` 호출 시 콘텐츠의 `subject` 필드도 전달하도록 수정

## 수정된 파일

1. `lib/plan/1730TimetableLogic.ts`
   - `getContentAllocation` 함수의 타입 정의 수정
   - 매칭 로직 개선 (부분 매칭 지원)

2. `lib/plan/scheduler.ts`
   - `getContentAllocation` 호출 시 `subject` 필드 전달

## 테스트 확인 사항

- 전략과목으로 설정된 과목이 올바르게 `strategy`로 처리되는지
- 취약과목으로 설정된 과목이 올바르게 `weakness`로 처리되는지
- `subject_id`로 매칭되는 경우
- `subject_name`과 `subject_category` 부분 매칭되는 경우
- `subject` 필드로 매칭되는 경우

## 변경 사항 상세

### `lib/plan/1730TimetableLogic.ts`

```typescript
// 변경 전
subjectAllocations?: Array<{
  subject_name: string;
  subject_type: "strategy" | "weakness";
  weekly_days?: number;
}>

// 변경 후
subjectAllocations?: Array<{
  subject_id?: string;
  subject_name: string;
  subject_type: "strategy" | "weakness";
  weekly_days?: number;
}>
```

매칭 로직에 다음 우선순위 추가:
1. `subject_id` 매칭
2. 정확 일치 매칭
3. 부분 매칭 (`subject_name.includes(subject_category)`)
4. `subject` 필드 매칭

### `lib/plan/scheduler.ts`

```typescript
// 변경 전
const allocation = getContentAllocation(
  {
    content_type: content.content_type,
    content_id: content.content_id,
    subject_category: content.subject_category || undefined,
  },
  contentAllocations,
  subjectAllocations
);

// 변경 후
const allocation = getContentAllocation(
  {
    content_type: content.content_type,
    content_id: content.content_id,
    subject_category: content.subject_category || undefined,
    subject: content.subject || undefined,
  },
  contentAllocations,
  subjectAllocations
);
```

## 예상 효과

- 전략과목으로 설정된 과목이 올바르게 인식되어 주당 배정 일수에 따라 배정됨
- 취약과목으로 설정된 과목이 전체 학습일에 배정됨
- 부분 매칭으로 인해 다양한 형태의 과목명도 매칭 가능

