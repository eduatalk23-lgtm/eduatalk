# 캠프 참여자 목록 페이지 상태 변화 및 페이지 이동 최적화

## 작업 일시
2025-12-04

## 작업 개요
`/admin/camp-templates/[id]/participants` 페이지의 상태 관리와 페이지 이동 관련 오류를 점검하고 최적화했습니다.

## 주요 개선 사항

### 1. useEffect 의존성 배열 문제 수정
**문제점:**
- `loadParticipants` 함수가 `useEffect` 의존성 배열에 없어서 경고 발생 가능
- 함수가 매 렌더링마다 재생성되어 불필요한 재렌더링 발생

**해결:**
- `useCallback`으로 `loadParticipants` 함수 메모이제이션
- 의존성 배열에 `templateId`와 `toast` 포함
- `useEffect` 의존성 배열에 `loadParticipants` 추가

```typescript
const loadParticipants = useCallback(async () => {
  // ... 로직
}, [templateId, toast]);

useEffect(() => {
  loadParticipants();
}, [loadParticipants]);
```

### 2. 중복 로드 방지 메커니즘 추가
**문제점:**
- 빠른 연속 클릭 시 중복 API 호출 발생
- 동시에 여러 번 로드 요청이 들어올 수 있음

**해결:**
- `isLoadingRef`로 현재 로딩 중인지 추적
- `lastLoadTimeRef`로 마지막 로드 시간 추적
- 1초 이내 재요청 차단

```typescript
const lastLoadTimeRef = useRef<number>(0);
const isLoadingRef = useRef<boolean>(false);

const loadParticipants = useCallback(async () => {
  const now = Date.now();
  if (isLoadingRef.current || (now - lastLoadTimeRef.current < 1000)) {
    return;
  }
  // ... 로직
}, [templateId, toast]);
```

### 3. 페이지 포커스 시 자동 새로고침 기능 추가
**문제점:**
- 다른 페이지에서 돌아왔을 때 데이터가 자동으로 갱신되지 않음
- 사용자가 수동으로 새로고침해야 함

**해결:**
- `window.focus` 이벤트 리스너 추가
- `document.visibilitychange` 이벤트 리스너 추가
- 마지막 로드 후 일정 시간(5초/10초) 이상 지났을 때만 새로고침

```typescript
// 페이지 포커스 시
useEffect(() => {
  const handleFocus = () => {
    if (pathname?.includes('/participants') && !pathname?.includes('/participants/')) {
      const now = Date.now();
      if (now - lastLoadTimeRef.current > 5000) {
        loadParticipants();
      }
    }
  };
  window.addEventListener('focus', handleFocus);
  return () => window.removeEventListener('focus', handleFocus);
}, [pathname, loadParticipants]);

// 페이지 가시성 변경 시
useEffect(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible') {
      const now = Date.now();
      if (now - lastLoadTimeRef.current > 10000) {
        loadParticipants();
      }
    }
  };
  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
}, [loadParticipants]);
```

### 4. 필터 변경 시 선택 해제 로직 개선
**문제점:**
- 필터가 변경되지 않았는데도 선택이 해제될 수 있음

**해결:**
- `useRef`로 이전 필터 값 추적
- 실제로 필터가 변경되었을 때만 선택 해제

```typescript
const prevStatusFilterRef = useRef<string>(statusFilter);
useEffect(() => {
  if (prevStatusFilterRef.current !== statusFilter) {
    setSelectedParticipantIds(new Set());
    prevStatusFilterRef.current = statusFilter;
  }
}, [statusFilter]);
```

### 5. 성능 최적화를 위한 메모이제이션 추가
**문제점:**
- 필터링된 목록과 통계가 매 렌더링마다 재계산됨
- 불필요한 재렌더링 발생

**해결:**
- `useMemo`로 필터링된 참여자 목록 메모이제이션
- `useMemo`로 통계 계산 메모이제이션
- `useCallback`으로 이벤트 핸들러 메모이제이션

```typescript
// 필터링된 참여자 목록
const filteredParticipants = useMemo(() => {
  return participants.filter((p) => {
    // ... 필터링 로직
  });
}, [participants, statusFilter]);

// 통계
const stats = useMemo(() => {
  return {
    total: participants.length,
    accepted: participants.filter((p) => p.display_status === "accepted").length,
    // ... 기타 통계
  };
}, [participants]);

// 이벤트 핸들러
const handleSelectAll = useCallback((checked: boolean) => {
  // ... 로직
}, [filteredParticipants]);
```

### 6. 데이터 새로고침 타이밍 개선
**문제점:**
- 작업 완료 후 즉시 새로고침하면 DB 동기화가 완료되지 않을 수 있음

**해결:**
- 작업 완료 후 500ms 지연 후 새로고침
- DB 동기화 시간 확보

```typescript
onSuccess={() => {
  setSelectedParticipantIds(new Set());
  setTimeout(() => {
    loadParticipants();
  }, 500);
}}
```

### 7. 새로고침 버튼 개선
**문제점:**
- 새로고침 중에도 버튼이 활성화되어 중복 클릭 가능
- 로딩 상태 표시 없음

**해결:**
- 로딩 중 버튼 비활성화
- 로딩 상태 텍스트 표시
- 강제 새로고침 기능 추가

```typescript
<button
  onClick={() => {
    lastLoadTimeRef.current = 0; // 강제 새로고침
    loadParticipants();
  }}
  disabled={loading}
  className="... disabled:opacity-50 disabled:cursor-not-allowed"
>
  {loading ? "새로고침 중..." : "새로고침"}
</button>
```

## 변경된 파일

### `app/(admin)/admin/camp-templates/[id]/participants/CampParticipantsList.tsx`
- `useCallback`, `useMemo`, `useRef` 훅 추가
- `usePathname` 훅 추가 (페이지 경로 추적)
- `loadParticipants` 함수 메모이제이션
- 페이지 포커스/가시성 변경 이벤트 리스너 추가
- 필터링 및 통계 계산 메모이제이션
- 이벤트 핸들러 메모이제이션
- 중복 로드 방지 메커니즘 추가
- 데이터 새로고침 타이밍 개선

## 성능 개선 효과

1. **불필요한 재렌더링 감소**: 메모이제이션으로 계산 비용 절감
2. **중복 API 호출 방지**: 1초 이내 재요청 차단
3. **자동 데이터 동기화**: 페이지 포커스 시 자동 새로고침
4. **사용자 경험 개선**: 로딩 상태 표시 및 버튼 비활성화

## 테스트 권장 사항

1. 페이지 로드 후 데이터 정상 표시 확인
2. 필터 변경 시 선택 해제 확인
3. 다른 페이지 이동 후 돌아왔을 때 자동 새로고침 확인
4. 일괄 작업 완료 후 데이터 새로고침 확인
5. 빠른 연속 클릭 시 중복 로드 방지 확인

## 향후 개선 가능 사항

1. React Query 도입 검토 (서버 상태 관리)
2. 낙관적 업데이트 적용
3. 에러 바운더리 추가
4. 무한 스크롤 또는 페이지네이션 추가 (참여자 수가 많을 경우)

