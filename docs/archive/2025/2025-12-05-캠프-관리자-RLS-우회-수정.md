# 캠프 관리자 RLS 우회 수정

## 작업 일시
2025-12-05

## 문제 상황

관리자가 캠프 플랜 그룹의 남은 단계를 진행할 때, 콘텐츠가 있는데도 "교재를 찾을 수 없습니다"라는 메시지가 나타나며 콘텐츠가 제외되는 문제가 발생했습니다.

### 터미널 로그 분석

```
[classifyPlanContents] Admin 클라이언트 사용 (RLS 우회) {
  studentId: '6d1cff5e-fa9f-4811-8d7f-44f75850b62b',
  ...
}
[classifyPlanContents] 조회 결과: {
  studentBooks: {
    count: 1,
    ids: [ 'f078510a-dfe6-4c16-8ad8-fb0dfffbbc3e' ],
    ...
  }
}
...
[campTemplateActions] 교재(f078510a-dfe6-4c16-8ad8-fb0dfffbbc3e)를 찾을 수 없습니다. 콘텐츠에서 제외합니다.
```

## 원인 분석

### 문제점

1. `classifyPlanContents`는 **Admin 클라이언트 (RLS 우회)**를 사용하여 다른 학생의 데이터를 조회할 수 있었습니다.

2. 하지만 `continueCampStepsForAdmin`에서 콘텐츠를 저장할 때는 **일반 서버 클라이언트**를 사용했습니다:
   ```typescript
   const supabase = await createSupabaseServerClient();
   ```

3. 일반 서버 클라이언트는 **RLS(Row Level Security)**가 적용되어, 관리자가 다른 학생의 데이터를 조회할 수 없었습니다.

### 코드 비교

#### classifyPlanContents (정상 작동)

```typescript
// lib/data/planContents.ts
const { createSupabaseAdminClient } = await import("@/lib/supabase/admin");
const supabase = createSupabaseAdminClient(); // RLS 우회
```

#### continueCampStepsForAdmin (문제 발생)

```typescript
// app/(admin)/actions/campTemplateActions.ts
const supabase = await createSupabaseServerClient(); // RLS 적용
```

## 해결 방법

`continueCampStepsForAdmin`에서도 **Admin 클라이언트**를 사용하도록 수정했습니다:

```typescript
// 관리자용 Admin 클라이언트 사용 (RLS 우회)
// 관리자가 다른 학생의 데이터를 조회/수정해야 하므로 Admin 클라이언트 필요
const { createSupabaseAdminClient } = await import("@/lib/supabase/admin");
const supabase = createSupabaseAdminClient();

console.log("[continueCampStepsForAdmin] Admin 클라이언트 사용 (RLS 우회)");
```

## 결과

1. **콘텐츠 조회 정상화**: 관리자가 다른 학생의 교재/강의를 정상적으로 조회할 수 있습니다.
2. **콘텐츠 저장 정상화**: 콘텐츠가 제외되지 않고 정상적으로 저장됩니다.
3. **플랜 생성 정상화**: 콘텐츠가 있으므로 플랜 생성이 정상적으로 진행됩니다.

## 참고 사항

- Admin 클라이언트는 RLS를 우회하므로, 권한 검증을 반드시 먼저 수행해야 합니다.
- 이 함수에서는 이미 `getCurrentUserRole()`을 통해 관리자/컨설턴트 권한을 확인하고 있습니다.
- 관리자 전용 함수에서는 Admin 클라이언트를 사용하는 것이 적절합니다.

