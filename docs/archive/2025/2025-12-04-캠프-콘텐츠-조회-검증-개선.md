# 캠프 콘텐츠 조회 및 검증 로직 개선

## 작업 일시
2025-12-04

## 문제 상황

관리자가 캠프 플랜 그룹의 남은 단계를 진행할 때, 다음과 같은 문제가 발생했습니다:

1. **빌드 에러**: `hasPlanContents` 변수가 중복 정의되어 빌드 실패
2. **검증 실패**: 콘텐츠가 조회되었는데도 검증이 실패하는 문제

### 문제 원인

#### 1. 변수 중복 정의
- `hasPlanContents` 변수가 2471번째 줄과 2856번째 줄에서 중복 정의됨
- 같은 스코프에서 같은 이름의 변수를 두 번 선언하여 에러 발생

#### 2. 콘텐츠 조회는 되었지만 검증 실패

**흐름 분석**:
1. `continue/page.tsx`에서 콘텐츠를 조회하고 `wizardData`에 포함
2. 빈 배열인 경우 `undefined`로 변환하여 전달 (기존 콘텐츠 보존을 위해)
3. `continueCampStepsForAdmin`에서 `wizardData.student_contents || []`로 처리
4. `undefined`일 때 빈 배열이 되어 `finalTotalContents`가 0이 됨
5. 검증 로직이 `wizardData`의 콘텐츠만 확인하고 DB의 콘텐츠를 확인하지 않음

**코드 흐름**:
```typescript
// continue/page.tsx
const filteredWizardData = {
  ...wizardData,
  student_contents: wizardData.student_contents && wizardData.student_contents.length > 0
    ? wizardData.student_contents
    : undefined, // 빈 배열을 undefined로 변환
  recommended_contents: undefined,
};

// continueCampStepsForAdmin
let studentContents = wizardData.student_contents || []; // undefined → []
let recommendedContents = wizardData.recommended_contents || []; // undefined → []
const finalTotalContents = studentContents.length + recommendedContents.length; // 0

// 검증 로직
if (!hasPlanContents && !hasWizardContents) { // hasWizardContents = false
  validationErrors.push("플랜에 포함될 콘텐츠가 없습니다...");
}
```

## 해결 방법

### 1. 변수명 중복 해결

두 번째 `hasPlanContents`를 `hasFinalPlanContents`로 변경:

```typescript
// 기존
const hasPlanContents = finalPlanContents && finalPlanContents.length > 0;

// 수정
const hasFinalPlanContents = finalPlanContents && finalPlanContents.length > 0;
```

### 2. 콘텐츠 조회 및 검증 로직 개선

#### 2.1. wizardData 처리 개선

`undefined`인 경우를 명시적으로 처리하고, DB에서 콘텐츠를 로드하도록 개선:

```typescript
// wizardData에서 콘텐츠 확인
// continue/page.tsx에서 빈 배열을 undefined로 변환하여 전달하므로, undefined인 경우 DB에서 로드 필요
let studentContents = wizardData.student_contents;
let recommendedContents = wizardData.recommended_contents;

// wizardData에 콘텐츠가 없고(undefined) DB에 콘텐츠가 있으면 DB에서 로드
// 또는 wizardData에 콘텐츠가 빈 배열이고 DB에 콘텐츠가 있으면 DB에서 로드
const hasWizardDataContents = 
  (wizardData.student_contents !== undefined && wizardData.student_contents.length > 0) ||
  (wizardData.recommended_contents !== undefined && wizardData.recommended_contents.length > 0);

if (
  (!hasWizardDataContents && hasPlanContents) ||
  (wizardData.student_contents === undefined || wizardData.recommended_contents === undefined)
) {
  // DB에서 콘텐츠 로드
  // ...
}

// undefined인 경우 빈 배열로 변환 (계산을 위해)
if (studentContents === undefined) studentContents = [];
if (recommendedContents === undefined) recommendedContents = [];
```

#### 2.2. 검증 로직 개선

`wizardData`의 콘텐츠와 DB의 콘텐츠를 모두 확인:

```typescript
// 검증: DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우에만 에러
const hasFinalPlanContents = finalPlanContents && finalPlanContents.length > 0;
const hasWizardContents = finalTotalContents > 0;

if (!hasFinalPlanContents && !hasWizardContents) {
  // DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우
  validationErrors.push(
    "플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요."
  );
} else if (!hasFinalPlanContents && hasWizardContents) {
  // wizardData에 콘텐츠가 있지만 DB에 저장되지 않은 경우
  // 이 경우에도 플랜 생성은 가능하도록 허용
  console.warn(
    "[campTemplateActions] Step 6 검증: wizardData에 콘텐츠가 있지만 DB에 저장되지 않음."
  );
}
```

## 결과

1. **빌드 에러 해결**: 변수명 중복 문제 해결
2. **콘텐츠 조회 개선**: `undefined`인 경우 DB에서 콘텐츠를 로드하도록 개선
3. **검증 로직 개선**: `wizardData`의 콘텐츠와 DB의 콘텐츠를 모두 확인하여 검증 실패 문제 해결

## 참고 사항

- `continue/page.tsx`에서 빈 배열을 `undefined`로 변환하는 이유는 기존 콘텐츠를 보존하기 위함입니다.
- `wizardData`에 콘텐츠가 있으면 플랜 생성이 가능하도록 허용합니다.
- DB에 콘텐츠가 있으면 플랜 생성이 가능하도록 허용합니다.
- 둘 다 없을 때만 검증 에러를 발생시킵니다.

