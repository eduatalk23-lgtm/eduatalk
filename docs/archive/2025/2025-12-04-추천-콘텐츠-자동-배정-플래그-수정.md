# 추천 콘텐츠 자동 배정 플래그 수정

## 작업 일자
2025-12-04

## 문제 상황

사용자가 자동 배정 옵션을 선택하지 않았는데도 자동으로 추천 콘텐츠가 추가되는 버그가 발생했습니다.

### 증상
1. 국어 1개를 추천 받아서 수동으로 선택하고 범위 지정 → `is_auto_recommended = false`
2. 한국사 1개가 자동으로 추천으로 전범위로 들어가 있음 → `is_auto_recommended = true`
3. 자동 배정 옵션을 선택하지 않았는데도 자동 배정이 실행됨

## 수정 내용

### 1. 자동 배정 시 is_auto_recommended 플래그 설정

**파일**: `app/(student)/plan/new-group/_components/Step4RecommendedContents/hooks/useRecommendations.ts`

- 자동 배정 시 추가되는 콘텐츠에 `is_auto_recommended: true` 플래그 추가
- `recommendation_source: "auto"` 필드 추가
- 정상 케이스와 에러 케이스(상세 정보 조회 실패) 모두에 플래그 적용

```typescript
contentsToAutoAdd.push({
  content_type: r.contentType as "book" | "lecture",
  content_id: r.id,
  start_range: startRange,
  end_range: endRange,
  title: r.title,
  subject_category: r.subject_category || undefined,
  is_auto_recommended: true, // 자동 배정 플래그
  recommendation_source: "auto", // 자동 배정 소스
});
```

### 2. 수동 선택 시 is_auto_recommended 플래그 설정

**파일**: `app/(student)/plan/new-group/_components/_shared/RecommendedContentsPanel.tsx`

- 수동 선택 시 추가되는 콘텐츠에 `is_auto_recommended: false` 플래그 명시적 설정

```typescript
const newContent: SelectedContent = {
  content_type: type,
  content_id: id,
  start_range: Number(range.start.replace(/[^\d]/g, "")),
  end_range: Number(range.end.replace(/[^\d]/g, "")),
  start_detail_id: range.start_detail_id,
  end_detail_id: range.end_detail_id,
  title,
  subject_category: recommendedContent?.subject_category || undefined,
  master_content_id: id,
  is_auto_recommended: false, // 수동 선택 플래그
};
```

### 3. Step3ContentSelection 자동 배정 로직 점검

**파일**: `app/(student)/plan/new-group/_components/Step3ContentSelection.tsx`

- 자동 배정 로직에서도 `is_auto_recommended: true` 플래그 설정
- 정상 케이스와 에러 케이스 모두에 플래그 적용

```typescript
contentsToAutoAdd.push({
  content_type: r.contentType,
  content_id: r.id,
  start_range: startRange,
  end_range: endRange,
  title: r.title,
  subject_category: r.subject_category || undefined,
  is_auto_recommended: true, // 자동 배정 플래그
});
```

### 4. 자동 배정 조건 재확인 및 디버깅 로그 추가

**파일**: 
- `app/(student)/plan/new-group/_components/Step3ContentSelection.tsx`
- `app/(student)/plan/new-group/_components/Step4RecommendedContents/hooks/useRecommendations.ts`

- 자동 배정 조건을 명확히 하고 디버깅 로그 추가
- `shouldAutoAssign` 변수로 조건을 명확히 표현

```typescript
// 자동 배정 조건 명확화
const shouldAutoAssign =
  recommendationSettings.autoAssignContents &&
  filteredRecommendations.length > 0;

console.log("[Step3ContentSelection] 자동 배정 조건 확인:", {
  autoAssignContents: recommendationSettings.autoAssignContents,
  filteredRecommendationsCount: filteredRecommendations.length,
  shouldAutoAssign,
});
```

### 5. 타입 정의 업데이트

**파일**: `lib/types/content-selection.ts`

- `SelectedContent` 타입에 `is_auto_recommended` 및 `recommendation_source` 필드 추가

```typescript
export type SelectedContent = {
  content_type: ContentType;
  content_id: string;
  start_range: number;
  end_range: number;
  start_detail_id?: string | null;
  end_detail_id?: string | null;
  title?: string;
  subject_category?: string;
  master_content_id?: string | null;
  is_auto_recommended?: boolean; // 자동 배정 여부
  recommendation_source?: "auto" | "admin" | "template" | null; // 추천 소스
};
```

## 확인 사항

### constraint_handling auto_fix 기능 점검

**파일**: `app/(student)/actions/plan-groups/plans.ts`

- `constraint_handling: "auto_fix"` 옵션은 현재 주석으로 "구현 필요"로 표시되어 있음
- 실제로 자동 콘텐츠 추가 기능은 동작하지 않음
- 현재 문제와는 직접적인 관련 없음

## 예상 효과

- ✅ 자동 배정 옵션을 선택하지 않으면 자동 배정이 실행되지 않음
- ✅ 자동 배정된 콘텐츠와 수동 선택한 콘텐츠가 `is_auto_recommended` 플래그로 명확히 구분됨
- ✅ 저장/불러오기 시 플래그가 올바르게 유지됨
- ✅ 기능 중첩 문제 해결
- ✅ 디버깅 로그를 통해 자동 배정 조건을 명확히 추적 가능

## 테스트 시나리오

1. 자동 배정 옵션 체크하지 않고 추천 받기 → 자동 배정이 실행되지 않는지 확인
2. 자동 배정 옵션 체크하고 추천 받기 → 자동 배정이 실행되고 `is_auto_recommended: true` 설정되는지 확인
3. 수동으로 추천 콘텐츠 선택 → `is_auto_recommended: false` 설정되는지 확인
4. 자동 배정된 콘텐츠와 수동 선택한 콘텐츠가 올바르게 구분되는지 확인
5. 저장 후 불러올 때 `is_auto_recommended` 플래그가 올바르게 표시되는지 확인

## 수정된 파일 목록

1. `app/(student)/plan/new-group/_components/Step4RecommendedContents/hooks/useRecommendations.ts`
2. `app/(student)/plan/new-group/_components/_shared/RecommendedContentsPanel.tsx`
3. `app/(student)/plan/new-group/_components/Step3ContentSelection.tsx`
4. `lib/types/content-selection.ts`

