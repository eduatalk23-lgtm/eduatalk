# 클라이언트-서버 코드 분리 수정

## 문제 상황

빌드 오류 발생:
```
Ecmascript file had an error
./lib/supabase/server.ts:3:1
You're importing a component that needs "next/headers". That only works in a Server Component which is not supported in the pages/ directory.
```

**원인**: 클라이언트 컴포넌트(`Step2RangeAdjustment.tsx`)에서 `calculateRecommendedRanges` 함수를 직접 호출하고 있었는데, 이 함수가 `tenantId`가 제공될 때 `configManager.ts`를 동적으로 import합니다. 이 동적 import가 번들에 포함되면서 서버 전용 코드(`next/headers`를 사용하는 `createSupabaseServerClient`)가 클라이언트 번들에 포함되었습니다.

## 해결 방법

### 1. `rangeRecommendation.ts` 수정

클라이언트에서 서버 전용 코드를 import하지 않도록 동적 import를 제거했습니다:

```typescript
// 수정 전: tenantId가 제공되면 DB에서 설정 조회
} else if (options?.tenantId !== undefined) {
  const { getRangeRecommendationConfig } = await import(
    "@/lib/recommendations/config/configManager"
  );
  config = await getRangeRecommendationConfig(options.tenantId);
}

// 수정 후: 클라이언트에서는 항상 기본값 사용
} else {
  // 옵션이 없으면 기본값 사용
  // tenantId가 제공되어도 클라이언트에서는 DB 조회를 하지 않음
  // 서버 액션을 통해 범위 추천을 계산해야 함
  config = defaultRangeRecommendationConfig;
}
```

### 2. 서버 액션에 범위 추천 계산 추가

`getPlanGroupContentsForRangeAdjustment` 서버 액션에 범위 추천 계산 기능을 추가했습니다:

- 서버에서 `getRangeRecommendationConfig`를 호출하여 테넌트별 설정 조회
- `calculateRecommendedRanges`를 서버에서 실행
- 추천 범위 정보를 반환값에 포함

```typescript
// 범위 추천 계산 (서버에서만 실행)
let recommendedRanges: Map<string, { start: number; end: number; reason: string }> = new Map();
let unavailableReasons: Map<string, string> = new Map();

if (scheduleSummary && contentInfos.length > 0) {
  try {
    // 테넌트별 설정 조회
    const config = await getRangeRecommendationConfig(tenantContext.tenantId);
    
    const recommendationResult = await calculateRecommendedRanges(
      scheduleSummary,
      contentInfos.map((c) => ({
        content_id: c.contentId,
        content_type: c.contentType,
        total_amount: c.totalAmount,
      })),
      { config }
    );

    recommendedRanges = recommendationResult.ranges;
    unavailableReasons = recommendationResult.unavailableReasons;
  } catch (error) {
    console.error("[getPlanGroupContentsForRangeAdjustment] 범위 추천 계산 실패:", error);
  }
}

return {
  success: true,
  contents: contentInfos,
  scheduleSummary,
  recommendedRanges: Object.fromEntries(recommendedRanges),
  unavailableReasons: Object.fromEntries(unavailableReasons),
};
```

### 3. 클라이언트 컴포넌트 수정

`Step2RangeAdjustment.tsx`에서 서버 액션의 결과를 직접 사용하도록 수정:

```typescript
// 수정 전: 클라이언트에서 직접 계산
const recommendationResult = await calculateRecommendedRanges(
  scheduleSummary,
  contentInfos.map((c) => ({
    content_id: c.contentId,
    content_type: c.contentType,
    total_amount: c.totalAmount,
  }))
);

// 수정 후: 서버 액션 결과 사용
const recommendedRanges = result.recommendedRanges || {};
const unavailableReasons = result.unavailableReasons || {};
```

## 수정된 파일

1. `lib/plan/rangeRecommendation.ts` - 동적 import 제거
2. `app/(admin)/actions/campTemplateActions.ts` - 범위 추천 계산 추가
3. `app/(admin)/admin/camp-templates/[id]/participants/_components/Step2RangeAdjustment.tsx` - 서버 액션 결과 사용

## 결과

- 클라이언트 컴포넌트에서 서버 전용 코드(`next/headers`)를 사용하지 않도록 수정
- 범위 추천 계산은 서버 액션에서만 실행
- 빌드 오류 해결

## 참고

- Next.js 15에서는 클라이언트 컴포넌트에서 서버 전용 API(`next/headers`, `cookies` 등)를 사용할 수 없습니다.
- 동적 import를 사용하더라도 번들러가 분석하여 클라이언트 번들에 포함시킬 수 있습니다.
- 서버 전용 로직은 반드시 서버 액션이나 서버 컴포넌트에서만 실행해야 합니다.

