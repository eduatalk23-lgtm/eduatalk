# 다른 단계에서 새로고침 시 콘텐츠 사라짐 문제 해결

## 작업 일자
2025-12-04

## 문제 상황

남은 단계 진행하기 중 다른 단계(Step 5, 6, 7)로 넘어가서 새로고침을 하면 기존 작성/제출된 콘텐츠가 사라지는 문제가 발생했습니다.

## 원인 분석

### 1. continue 페이지 초기화 문제

- continue 페이지는 항상 `_startStep: 4`로 설정
- 새로고침 시 Step 4부터 시작하도록 초기화
- Step 5, 6, 7에서 작업 후 새로고침하면 페이지가 다시 로드되면서 Step 4의 초기 데이터로 초기화

### 2. continueCampStepsForAdmin 로직 문제

**기존 로직:**
```typescript
hasStudentContents = wizardData.student_contents !== undefined
if (hasStudentContents && wizardData.student_contents && wizardData.student_contents.length > 0) {
  // 저장
} else if (!hasStudentContents && existingStudentContents.length > 0) {
  // 보존
}
```

**문제점:**
- `student_contents`가 빈 배열이면:
  - `hasStudentContents = true`
  - `wizardData.student_contents.length > 0 = false`
  - 두 조건 모두 `false`가 되어 기존 학생 콘텐츠가 보존되지 않음

### 3. 근본 원인

1. **continue 페이지에서 `student_contents` 전달 문제**:
   - `syncCreationDataToWizardData`가 학생 콘텐츠를 제대로 분류하지 못하면 빈 배열이 될 수 있음
   - 빈 배열을 전달하면 `hasStudentContents`는 `true`이지만 `length > 0`이 `false`가 되어 보존되지 않음

2. **`continueCampStepsForAdmin` 로직 문제**:
   - 빈 배열인 경우를 처리하지 않음
   - `hasStudentContents && wizardData.student_contents.length === 0`인 경우에도 기존 콘텐츠를 보존해야 함

## 해결 방안

### 방안 1: continue 페이지에서 빈 배열 처리

**수정 위치**: `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`

**수정 내용**:
- `student_contents`가 빈 배열이면 `undefined`로 설정
- `recommended_contents`는 이미 `undefined`로 설정되어 있음

**장점**:
- `continueCampStepsForAdmin` 함수의 기존 로직 활용
- 최소 변경

### 방안 2: continueCampStepsForAdmin 로직 개선

**수정 위치**: `app/(admin)/actions/campTemplateActions.ts`

**수정 내용**:
- 빈 배열인 경우에도 기존 콘텐츠 보존
- `hasStudentContents && wizardData.student_contents.length === 0`인 경우 처리 추가

**장점**:
- 더 안전한 로직
- 빈 배열과 undefined를 구분하여 처리

## 구현 내용

### 1. continue 페이지에서 빈 배열 처리

**파일**: `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`

**수정 내용**:
```typescript
// student_contents가 빈 배열이면 undefined로 설정하여 기존 학생 콘텐츠 보존
// 빈 배열을 전달하면 hasStudentContents는 true이지만 length > 0이 false가 되어 보존되지 않음
student_contents: wizardData.student_contents && wizardData.student_contents.length > 0
  ? wizardData.student_contents
  : undefined,
```

### 2. continueCampStepsForAdmin 로직 개선

**파일**: `app/(admin)/actions/campTemplateActions.ts`

**수정 내용**:
```typescript
// 학생 콘텐츠 처리
if (hasStudentContents && wizardData.student_contents && wizardData.student_contents.length > 0) {
  // 저장
} else if (
  (!hasStudentContents || (hasStudentContents && wizardData.student_contents && wizardData.student_contents.length === 0)) &&
  existingStudentContents.length > 0
) {
  // 보존 (빈 배열인 경우도 포함)
}
```

### 3. 로깅 강화

**추가된 로깅**:
- 콘텐츠 업데이트 시작 시점의 상태
- 기존 콘텐츠 조회 결과
- 저장할 콘텐츠 목록
- 기존 콘텐츠 보존 여부
- 최종 저장 결과 검증

## 수정된 파일

### `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`

**주요 변경사항**:
1. `student_contents`가 빈 배열이면 `undefined`로 설정
2. 로깅 개선: `studentContentsWillBePreserved` 플래그 추가

### `app/(admin)/actions/campTemplateActions.ts`

**주요 변경사항**:
1. 빈 배열 케이스 처리 추가
2. 학생 콘텐츠와 추천 콘텐츠 모두 빈 배열 케이스 처리
3. 검증 로직 업데이트: 빈 배열 케이스 포함
4. 상세 로깅 추가

## 테스트 방법

1. 학생이 캠프 참여 시 콘텐츠를 추가합니다.
2. 관리자가 `/admin/camp-templates/[id]/participants/[groupId]/continue` 페이지에 접속합니다.
3. Step 4에서 콘텐츠를 확인합니다.
4. Step 5, 6, 7로 넘어가서 작업을 진행합니다.
5. 새로고침 버튼을 클릭합니다.
6. 학생이 추가한 콘텐츠가 여전히 목록에 표시되는지 확인합니다.
7. Step 5, 6, 7에서 작업한 내용이 유지되는지 확인합니다.

## 예상 결과

- ✅ 학생이 추가한 콘텐츠는 Step 5, 6, 7에서 새로고침 후에도 유지됩니다.
- ✅ 빈 배열과 undefined 케이스 모두 올바르게 처리됩니다.
- ✅ 콘솔 로그를 통해 콘텐츠 보존 과정을 추적할 수 있습니다.

## 관련 이슈

- continue 페이지에서 빈 배열을 전달하면 기존 콘텐츠가 보존되지 않던 문제
- `continueCampStepsForAdmin` 함수에서 빈 배열 케이스를 처리하지 않던 문제
- 다른 단계에서 새로고침 시 콘텐츠가 사라지던 문제

