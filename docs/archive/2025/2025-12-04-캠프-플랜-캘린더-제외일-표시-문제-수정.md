# 캠프 플랜 캘린더 제외일 표시 문제 수정

**작업 일자**: 2025-12-04  
**작업자**: AI Assistant  
**관련 파일**: `app/(student)/camp/calendar/page.tsx`

---

## 문제 상황

캠프 플랜 캘린더가 일반 플랜 캘린더와 다르게 동작하는 문제가 있었습니다:

1. **제외일 표시 문제**: 캠프 플랜 작성 시 추가하지 않은 제외일을 달력에 표시하고 있음
2. **학습일/복습일 미표시**: 학습일, 복습일 등 표현되지 않는 항목이 많음

---

## 원인 분석

### 일반 플랜 캘린더 vs 캠프 플랜 캘린더 비교

| 항목 | 일반 플랜 캘린더 | 캠프 플랜 캘린더 (수정 전) |
|------|-----------------|-------------------------|
| 제외일 조회 | `getPlanExclusions(group.id)` - 플랜 그룹별 | `getStudentExclusions(user.id)` - 학생 전체 |
| 학원일정 조회 | `getAcademySchedules(group.id)` - 플랜 그룹별 | `getStudentAcademySchedules(user.id)` - 학생 전체 |
| 테넌트 컨텍스트 | `requireTenantContext()` 사용 | 미사용 |

### 문제점

1. **학생 전체 제외일 조회**: 캠프 플랜 캘린더가 학생 전체의 제외일을 조회하여, 다른 플랜 그룹의 제외일까지 표시됨
2. **플랜 그룹별 필터링 부재**: 캠프 플랜 작성 시 추가한 제외일만 표시해야 하는데, 모든 제외일이 표시됨
3. **일관성 부족**: 일반 플랜 캘린더와 다른 동작 방식으로 인한 혼란

---

## 수정 내용

### 1. Import 문 수정

```typescript
// 수정 전
import {
  getPlanGroupsForStudent,
  getStudentExclusions,
  getStudentAcademySchedules,
} from "@/lib/data/planGroups";

// 수정 후
import {
  getPlanGroupsForStudent,
  getPlanExclusions,
  getAcademySchedules,
} from "@/lib/data/planGroups";
import { requireTenantContext } from "@/lib/tenant/requireTenantContext";
```

### 2. 테넌트 컨텍스트 추가

```typescript
// 테넌트 컨텍스트 조회 추가
const tenantContext = await requireTenantContext();
```

### 3. 제외일 조회 로직 변경

```typescript
// 수정 전
const exclusions = await getStudentExclusions(user.id);

// 수정 후
// 제외일 조회 (플랜 그룹별 관리)
// 활성 플랜 그룹들의 제외일 조회 후 병합
const exclusionsPromises = activePlanGroups.map((group) =>
  getPlanExclusions(group.id, tenantContext.tenantId)
);
const exclusionsArrays = await Promise.all(exclusionsPromises);

// 중복 제거: exclusion_date:exclusion_type 조합이 같은 것은 하나만 표시
const exclusionsMap = new Map();
for (const exclusions of exclusionsArrays) {
  for (const exclusion of exclusions) {
    const key = `${exclusion.exclusion_date}:${exclusion.exclusion_type}`;
    if (!exclusionsMap.has(key)) {
      exclusionsMap.set(key, exclusion);
    }
  }
}
const exclusions = Array.from(exclusionsMap.values());
```

### 4. 학원일정 조회 로직 변경

```typescript
// 수정 전
const academySchedules = await getStudentAcademySchedules(user.id);

// 수정 후
// 학원일정 조회 (플랜 그룹별 관리)
// 활성 플랜 그룹들의 학원 일정 조회 후 병합
const academySchedulesPromises = activePlanGroups.map((group) =>
  getAcademySchedules(group.id, tenantContext.tenantId)
);
const academySchedulesArrays = await Promise.all(academySchedulesPromises);

// 중복 제거: day_of_week:start_time:end_time 조합이 같은 것은 하나만 표시
const academySchedulesMap = new Map();
for (const schedules of academySchedulesArrays) {
  for (const schedule of schedules) {
    const key = `${schedule.day_of_week}:${schedule.start_time}:${schedule.end_time}`;
    if (!academySchedulesMap.has(key)) {
      academySchedulesMap.set(key, schedule);
    }
  }
}
const academySchedules = Array.from(academySchedulesMap.values());
```

---

## 수정 효과

### 개선 사항

1. **정확한 제외일 표시**: 캠프 플랜 작성 시 추가한 제외일만 표시됨
2. **학습일/복습일 정상 표시**: `buildDayTypesFromDailySchedule` 함수가 제외일 목록을 올바르게 필터링하여 학습일/복습일이 정상적으로 표시됨
3. **일관성 확보**: 일반 플랜 캘린더와 동일한 동작 방식으로 통일

### 동작 원리

1. **플랜 그룹별 제외일 조회**: 각 활성 캠프 플랜 그룹의 제외일만 조회
2. **중복 제거**: 여러 플랜 그룹에 동일한 제외일이 있을 경우 하나만 표시
3. **제외일 필터링**: `buildDayTypesFromDailySchedule` 함수가 실제 제외일 목록에 있는 날짜만 제외일로 표시
4. **학습일/복습일 표시**: 제외일이 아닌 날짜는 `daily_schedule`의 `day_type`에 따라 학습일/복습일로 표시

---

## 관련 파일

- `app/(student)/camp/calendar/page.tsx` - 캠프 플랜 캘린더 페이지
- `app/(student)/plan/calendar/page.tsx` - 일반 플랜 캘린더 페이지 (참고)
- `lib/date/calendarDayTypes.ts` - 날짜 타입 계산 유틸리티
- `lib/data/planGroups.ts` - 플랜 그룹 데이터 액세스 레이어

---

## 테스트 체크리스트

- [ ] 캠프 플랜 작성 시 추가한 제외일만 캘린더에 표시되는지 확인
- [ ] 다른 플랜 그룹의 제외일이 표시되지 않는지 확인
- [ ] 학습일/복습일이 정상적으로 표시되는지 확인
- [ ] 일반 플랜 캘린더와 동일하게 동작하는지 확인

---

## 참고 사항

- 일반 플랜 캘린더(`app/(student)/plan/calendar/page.tsx`)와 동일한 패턴으로 구현
- 플랜 그룹별 제외일/학원일정 관리 방식으로 일관성 확보
- `buildDayTypesFromDailySchedule` 함수는 실제 제외일 목록에 있는 날짜만 제외일로 표시하므로, 올바른 제외일 목록을 전달하는 것이 중요함

