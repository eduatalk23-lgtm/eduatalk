# 추천 콘텐츠 자동 등록 로직 개선

## 작업 일자

2025-12-04

## 문제 상황

학생이 템플릿 작성 시 추천 콘텐츠를 1개만 선택했는데, 제출 후 상세보기에서 알지 못하는 추가 추천 콘텐츠가 자동으로 등록되어 있는 문제가 발생했습니다.

### 증상

1. 학생이 특정 교과 1개를 추천 받아서 범위 지정 후 등록 → 제출
2. 제출 후 상세보기에서 알지 못하는 추가 추천 콘텐츠가 등록되어 있음 (DB에 `is_auto_recommended: true`)
3. 관리자 영역에서도 2개가 보임
4. "남은 단계 진행하기"에서는 오토 추천 항목은 안 보이지만, DB에는 플랜 그룹으로 묶여 있어 플랜 생성 시 반영됨

### 원인 분석

- `app/(student)/actions/campActions.ts`의 `submitCampParticipation` 함수에서 플랜 그룹 생성 후 자동으로 추가 추천 콘텐츠를 생성하고 있었음
- 이 로직은 학생이 선택한 콘텐츠 외에 추가로 자동 추천 콘텐츠를 더 추가하는 것으로 보임
- 자동 배정 기능의 의도는 "추천 받은 콘텐츠를 바로 등록"하는 것이지, "추가로 더 받는 것"이 아님

## 해결 방안

### 1. 자동 추천 로직 제거

**파일**: `app/(student)/actions/campActions.ts`

- 라인 616-778의 자동 추천 콘텐츠 생성 로직을 완전히 제거
- 학생이 선택한 콘텐츠만 저장되도록 보장
- Step 4의 추천 기능(`/api/recommended-master-contents`)은 정상 동작하며, 이 로직과는 독립적임

**변경 내용**:
```typescript
// 제거된 코드 (라인 616-778)
// 자동 추천 콘텐츠 생성 및 저장 로직 전체 제거

// 추가된 주석
// 자동 추천 콘텐츠 생성 로직 제거
// 학생은 Step 4에서 추천 콘텐츠를 받아서 선택해야 함
// 제출 시점에 추가로 추천 콘텐츠를 자동 생성하지 않음
// Step 4의 추천 기능(/api/recommended-master-contents)은 정상 동작하며, 이 로직과는 독립적임
```

### 2. 자동 배정 기능 의도 명확화

**파일**: `app/(student)/plan/new-group/_components/Step4RecommendedContents/hooks/useRecommendations.ts`

- `autoAssignContents` 함수의 주석을 개선하여 의도를 명확히 함
- 자동 배정은 "추천 받은 콘텐츠를 바로 등록"하는 것임을 명확히 함

**변경 내용**:
```typescript
/**
 * 자동 배정: 추천 받은 콘텐츠를 바로 등록
 * 
 * 의도:
 * - 사용자가 "자동 배정" 옵션을 체크했을 때, 추천 받은 콘텐츠를 수동 선택 없이 바로 등록
 * - 이는 "추천 받은 콘텐츠를 바로 등록"하는 것이지, "추가로 더 받는 것"이 아님
 * - 제출 시점에 추가로 추천 콘텐츠를 생성하지 않음 (submitCampParticipation에서 처리하지 않음)
 * 
 * 동작:
 * 1. 추천 받은 콘텐츠의 상세 정보 조회 (페이지/회차 범위)
 * 2. 전체 범위로 설정하여 recommended_contents에 추가
 * 3. is_auto_recommended: true, recommendation_source: "auto" 플래그 설정
 * 
 * 참고:
 * - Step 4의 추천 기능(/api/recommended-master-contents)은 정상 동작하며, 이 함수와는 독립적임
 * - 제출 시점의 자동 추천 로직(campActions.ts)과는 별개로 동작함
 */
```

### 3. 데이터 동기화 로직 검증 및 주석 개선

**파일**: `lib/utils/planGroupDataSync.ts`

- `syncWizardDataToCreationData` 함수에서 추천 콘텐츠 처리 로직 검증
- `is_auto_recommended` 플래그가 올바르게 설정되는지 확인
- 주석을 추가하여 플래그의 의미를 명확히 함

**변경 내용**:
```typescript
// 자동 추천 관련 필드 추가
// Step 4에서 자동 배정된 콘텐츠는 is_auto_recommended: true, recommendation_source: "auto"로 설정됨
// 이 플래그들은 DB에 저장되어 관리자 일괄 적용 기능과 구분됨
```

```typescript
// 콘텐츠 분류: is_auto_recommended가 true이거나 recommendation_source가 있는 경우 추천 콘텐츠
// - is_auto_recommended: true, recommendation_source: "auto" → Step 4에서 자동 배정된 콘텐츠
// - is_auto_recommended: false, recommendation_source: "admin" → 관리자가 일괄 적용한 콘텐츠
// - 둘 다 없으면 → 학생이 직접 등록한 콘텐츠 (student_contents)
```

### 4. 관리자 영역 표시 로직 검증 및 주석 개선

**파일**: 
- `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`
- `app/(admin)/actions/campTemplateActions.ts`

- `getCampPlanGroupForReview` 함수에서 추천 콘텐츠 필터링 로직 검증
- 오토 추천 항목이 올바르게 표시/숨김 처리되는지 확인
- 주석을 추가하여 필터링 로직의 의미를 명확히 함

**변경 내용**:
```typescript
// 추천 콘텐츠 필터링: is_auto_recommended가 true이거나 recommendation_source가 있는 경우 제거
// - is_auto_recommended: true, recommendation_source: "auto" → Step 4에서 자동 배정된 콘텐츠
// - is_auto_recommended: false, recommendation_source: "admin" → 관리자가 일괄 적용한 콘텐츠
// 남은 단계 진행 시에는 Step 4에서 새로운 추천 콘텐츠를 선택할 수 있도록 함
// DB에는 여전히 존재하지만, 위저드에서는 제외하여 Step 4에서 새로 선택 가능
```

```typescript
// 콘텐츠 분류:
// - is_auto_recommended: true, recommendation_source: "auto" → Step 4에서 자동 배정된 콘텐츠
// - is_auto_recommended: false, recommendation_source: "admin" → 관리자가 일괄 적용한 콘텐츠
// - 둘 다 없으면 → 학생이 직접 등록한 콘텐츠
```

## 관리자 일괄 적용 기능과의 관계

### 충돌 가능성 분석

- 관리자 일괄 적용 기능(`bulkApplyRecommendedContents`)과는 직접적인 충돌 없음
- 플래그로 구분됨:
  - 학생 자동 배정: `is_auto_recommended: true`, `recommendation_source: "auto"`
  - 관리자 일괄 적용: `is_auto_recommended: false`, `recommendation_source: "admin"`
- 관리자 일괄 적용 시 `replaceExisting: true` 옵션으로 기존 추천 콘텐츠를 삭제할 수 있지만, 이는 의도된 동작임

## 수정된 파일 목록

1. `app/(student)/actions/campActions.ts`
   - 자동 추천 콘텐츠 생성 로직 제거 (라인 616-778)
   - 주석 추가

2. `app/(student)/plan/new-group/_components/Step4RecommendedContents/hooks/useRecommendations.ts`
   - 자동 배정 함수 주석 개선

3. `lib/utils/planGroupDataSync.ts`
   - 데이터 동기화 로직 주석 개선

4. `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`
   - 관리자 영역 표시 로직 주석 개선

5. `app/(admin)/actions/campTemplateActions.ts`
   - 콘텐츠 분류 로직 주석 개선

## 예상 결과

- ✅ 학생이 선택한 콘텐츠만 저장됨
- ✅ 제출 후 추가 추천 콘텐츠가 자동으로 등록되지 않음
- ✅ 자동 배정 기능은 "추천 받은 콘텐츠를 바로 등록"하는 것으로 명확히 동작
- ✅ DB에 불필요한 오토 추천 항목이 생성되지 않음
- ✅ Step 4의 추천 기능은 정상 동작 (제출 시점 로직과 독립적)
- ✅ 관리자 일괄 적용 기능과의 충돌 없음

## 테스트 시나리오

1. 학생이 템플릿 작성 시 추천 콘텐츠 1개 선택 → 범위 지정 → 제출
2. 제출 후 상세보기에서 선택한 콘텐츠 1개만 표시되는지 확인
3. DB에 `is_auto_recommended: true`인 추가 콘텐츠가 생성되지 않는지 확인
4. 관리자 영역에서도 선택한 콘텐츠만 표시되는지 확인
5. "남은 단계 진행하기"에서 오토 추천 항목이 필터링되는지 확인
6. 자동 배정 옵션을 체크하고 추천 받기 → 자동 배정이 실행되고 `is_auto_recommended: true` 설정되는지 확인
7. Step 4에서 추천 받기 기능이 정상 동작하는지 확인

