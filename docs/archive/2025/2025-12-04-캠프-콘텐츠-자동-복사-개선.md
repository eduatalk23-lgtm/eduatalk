# 캠프 콘텐츠 자동 복사 로직 개선

## 작업 일시
2025-12-04

## 문제 상황

관리자가 캠프 플랜 그룹의 남은 단계를 진행할 때, 다음과 같은 로그가 발생했습니다:

```
[campTemplateActions] 교재(f078510a-dfe6-4c16-8ad8-fb0dfffbbc3e)를 찾을 수 없습니다. 콘텐츠에서 제외합니다.
```

이 로그는 콘텐츠를 찾을 수 없어서 제외하고 있다는 메시지입니다. 사용자가 지적한 대로, 이 부분에서 콘텐츠가 사라지는 것이 문제의 원인일 수 있습니다.

## 원인 분석

### 문제점

`continueCampStepsForAdmin` 함수에서 콘텐츠를 저장할 때 두 가지 다른 로직이 있었습니다:

1. **Step 4 콘텐츠 업데이트 시 (2100번째 줄 근처)**:
   - 마스터 교재/강의를 찾았지만 학생이 가지고 있지 않으면 **제외**
   - 콘텐츠가 사라지는 문제 발생

2. **Step 6 플랜 생성 전 콘텐츠 저장 시 (2580번째 줄 근처)**:
   - 마스터 교재/강의를 찾았지만 학생이 가지고 있지 않으면 **자동 복사**
   - 정상적으로 작동

### 코드 비교

#### 문제가 있던 코드 (Step 4)

```typescript
if (masterBook) {
  const { data: studentBookByMaster } = await supabase
    .from("books")
    .select("id")
    .eq("student_id", studentId)
    .eq("master_content_id", content.content_id)
    .maybeSingle();

  if (studentBookByMaster) {
    isValidContent = true;
    actualContentId = studentBookByMaster.id;
  } else {
    // ❌ 제외하고 있음
    console.warn(
      `[campTemplateActions] 학생(${studentId})이 마스터 교재(${content.content_id})를 가지고 있지 않습니다. 콘텐츠에서 제외합니다.`
    );
  }
}
```

#### 정상 작동하는 코드 (Step 6)

```typescript
if (masterBook) {
  const { data: studentBookByMaster } = await supabase
    .from("books")
    .select("id, master_content_id")
    .eq("student_id", studentId)
    .eq("master_content_id", content.content_id)
    .maybeSingle();

  if (studentBookByMaster) {
    isValidContent = true;
    actualContentId = studentBookByMaster.id;
  } else {
    // ✅ 자동 복사
    try {
      const { copyMasterBookToStudent } = await import(
        "@/lib/data/contentMasters"
      );
      const { bookId } = await copyMasterBookToStudent(
        content.content_id,
        studentId,
        tenantContext.tenantId
      );
      isValidContent = true;
      actualContentId = bookId;
      console.log(
        `[campTemplateActions] 마스터 교재(${content.content_id})를 학생 교재(${bookId})로 복사했습니다.`
      );
    } catch (copyError) {
      // 복사 실패 시에도 마스터 콘텐츠 ID를 사용
      isValidContent = true;
      actualContentId = content.content_id;
    }
  }
}
```

## 해결 방법

Step 4 콘텐츠 업데이트 시에도 Step 6과 동일하게 마스터 콘텐츠를 자동 복사하도록 수정했습니다.

### 수정 내용

1. **교재 자동 복사 추가**:
   - 마스터 교재를 찾았지만 학생이 가지고 있지 않으면 자동으로 복사
   - 복사 실패 시에도 마스터 콘텐츠 ID를 사용하여 플랜 생성 시 자동 복사되도록 함

2. **강의 자동 복사 추가**:
   - 마스터 강의를 찾았지만 학생이 가지고 있지 않으면 자동으로 복사
   - 복사 실패 시에도 마스터 콘텐츠 ID를 사용하여 플랜 생성 시 자동 복사되도록 함

### 수정된 코드

```typescript
if (masterBook) {
  const { data: studentBookByMaster } = await supabase
    .from("books")
    .select("id, master_content_id")
    .eq("student_id", studentId)
    .eq("master_content_id", content.content_id)
    .maybeSingle();

  if (studentBookByMaster) {
    isValidContent = true;
    actualContentId = studentBookByMaster.id;
  } else {
    // ✅ 자동 복사 추가
    try {
      const { copyMasterBookToStudent } = await import(
        "@/lib/data/contentMasters"
      );
      const { bookId } = await copyMasterBookToStudent(
        content.content_id,
        studentId,
        tenantContext.tenantId
      );
      isValidContent = true;
      actualContentId = bookId;
      console.log(
        `[campTemplateActions] 마스터 교재(${content.content_id})를 학생 교재(${bookId})로 복사했습니다.`
      );
    } catch (copyError) {
      console.error(
        `[campTemplateActions] 마스터 교재 복사 실패: ${content.content_id}`,
        copyError
      );
      // 복사 실패 시에도 마스터 콘텐츠 ID를 사용 (플랜 생성 시 자동 복사됨)
      isValidContent = true;
      actualContentId = content.content_id;
    }
  }
}
```

## 결과

1. **콘텐츠 보존**: 마스터 콘텐츠를 찾았지만 학생이 가지고 있지 않은 경우에도 자동으로 복사하여 콘텐츠가 사라지지 않음
2. **일관성**: Step 4와 Step 6에서 동일한 로직 사용
3. **안정성**: 복사 실패 시에도 마스터 콘텐츠 ID를 사용하여 플랜 생성 시 자동 복사되도록 함

## 참고 사항

- 캠프 모드에서는 마스터 콘텐츠를 학생 콘텐츠로 자동 복사하는 것이 일반적인 동작입니다.
- 복사 실패 시에도 마스터 콘텐츠 ID를 사용하여 플랜 생성 시 자동 복사되도록 보장합니다.
- 이 수정으로 콘텐츠가 사라지는 문제가 해결되었습니다.

