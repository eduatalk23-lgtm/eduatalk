# 일반 모드 플랜 생성 흐름 개선

## 개선 목표

일반 모드에서 플랜 생성 흐름을 개선하여 더 자연스러운 사용자 경험을 제공합니다.

## 변경 전 흐름 (문제점)

1. Step 6 (최종 확인) → Step 7 (스케줄 결과): 데이터만 저장하고 이동
2. Step 7 진입 시: 플랜이 없으면 "플랜 생성하기" 버튼 표시
3. 완료 버튼: 플랜이 없으면 생성 후 완료, 있으면 바로 완료

**문제점**: Step 7에서 플랜 생성 여부를 확인하고 생성해야 하는 불편함

## 변경 후 흐름 (개선)

1. Step 6 (최종 확인) → Step 7 (스케줄 결과): **자동으로 플랜 생성**
2. Step 7 진입 시: **이미 생성된 플랜의 스케줄 결과 표시**
3. 완료 버튼: **플랜 상세보기로 이동** (플랜 생성은 이미 완료)

**개선점**: Step 6에서 "다음" 버튼을 누르면 플랜이 자동 생성되고, Step 7에서는 생성된 스케줄 결과를 바로 확인할 수 있음

## 수정 내용

### 1. PlanGroupWizard.tsx - Step 6 → Step 7 전환 시 플랜 자동 생성

**변경 전**:
```typescript
// Step 6에서 호출된 경우 데이터만 저장하고 Step 7로 이동 (플랜 생성은 Step 7에서)
if (currentStep === 6) {
  setDraftGroupId(finalGroupId);
  setCurrentStep(7);
  toast.showSuccess("저장되었습니다. 다음 단계에서 플랜을 생성합니다.");
  return;
}
```

**변경 후**:
```typescript
// Step 6에서 호출된 경우 플랜 생성 후 Step 7로 이동
if (currentStep === 6) {
  setDraftGroupId(finalGroupId);
  
  // 플랜이 이미 생성되었는지 확인
  try {
    const checkResult = await checkPlansExistAction(finalGroupId);
    if (!checkResult.hasPlans) {
      // 플랜이 없으면 생성
      try {
        await generatePlansFromGroupAction(finalGroupId);
        toast.showSuccess("플랜이 생성되었습니다.");
      } catch (generateError) {
        const errorMessage = generateError instanceof Error 
          ? generateError.message 
          : "플랜 생성 중 오류가 발생했습니다.";
        toast.showError(`플랜 생성 실패: ${errorMessage}`);
        // 플랜 생성 실패 시 Step 7로 이동하지 않음
        return;
      }
    } else {
      // 플랜이 이미 있으면 그대로 진행
      toast.showSuccess("저장되었습니다.");
    }
  } catch (checkError) {
    // 플랜 확인 실패는 경고만 표시하고 계속 진행
    console.warn("[PlanGroupWizard] 플랜 확인 실패:", checkError);
    toast.showError("플랜 확인 중 오류가 발생했습니다. 다시 시도해주세요.");
    return;
  }
  
  setCurrentStep(7);
  return;
}
```

**주요 변경사항**:
- Step 6 → Step 7 전환 시 플랜이 없으면 자동으로 생성
- 플랜이 이미 있으면 중복 생성하지 않음
- 플랜 생성 실패 시 Step 7로 이동하지 않음

### 2. Step7ScheduleResult.tsx - 플랜 없을 때 UI 제거 및 완료 버튼 수정

**변경 전**:
- 플랜이 없을 때 "플랜 생성하기" 버튼 표시
- 완료 버튼에서 플랜이 없으면 생성 후 완료

**변경 후**:
- 플랜이 없을 때 에러 메시지 표시 (Step 6에서 이미 생성되어야 함)
- 완료 버튼에서 플랜 생성 로직 완전 제거 (이미 생성되어 있으므로)

```typescript
// 플랜이 없을 때 에러 표시 (Step 6에서 이미 생성되어야 함)
if (!data && !isLoadingData && !isGenerating) {
  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-xl font-semibold text-gray-900">스케줄 결과</h2>
        <p className="mt-1 text-sm text-gray-500">
          생성된 학습 플랜을 확인할 수 있습니다.
        </p>
      </div>
      <div className="rounded-lg border border-red-200 bg-red-50 p-4">
        <h3 className="mb-2 text-sm font-semibold text-red-800">오류</h3>
        <p className="text-sm text-red-700">
          플랜이 생성되지 않았습니다. 이전 단계로 돌아가서 다시 시도해주세요.
        </p>
      </div>
    </div>
  );
}

// 완료 버튼
<button
  type="button"
  onClick={() => {
    // 플랜이 생성 중이면 완료 버튼 비활성화
    if (generatePlansMutation.isPending) {
      return;
    }
    // 플랜이 있는지 확인 (Step 6에서 이미 생성되어야 함)
    if (!plansCheck?.hasPlans) {
      alert("플랜이 생성되지 않았습니다. 이전 단계로 돌아가서 다시 시도해주세요.");
      return;
    }
    // 플랜이 있으면 바로 완료 (플랜 상세보기로 이동)
    onComplete();
  }}
  disabled={generatePlansMutation.isPending || isLoadingData}
  className="inline-flex items-center justify-center rounded-lg bg-gray-900 px-6 py-3 text-sm font-semibold text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:bg-gray-400"
>
  완료
</button>
```

### 3. PlanGroupWizard.tsx - onComplete 핸들러 주석 업데이트

**변경 전**:
```typescript
// 일반 모드(학생 모드)에서는 플랜이 생성되었는지 확인만 수행
// 플랜 생성은 Step7ScheduleResult에서 처리하므로 여기서는 확인만
```

**변경 후**:
```typescript
// 일반 모드(학생 모드)에서는 플랜이 생성되었는지 확인만 수행
// 플랜 생성은 Step 6 → Step 7 전환 시 이미 완료되므로 여기서는 확인만
```

## 중복 생성 방지 로직

### 1. Step 6 → Step 7 전환 시
- 플랜이 이미 생성되어 있는지 확인 (`checkPlansExistAction`)
- 플랜이 있으면 생성하지 않고 그대로 진행
- 플랜이 없을 때만 생성

### 2. Step 7 완료 버튼
- 플랜 생성 로직 완전 제거
- 플랜이 있는지 확인만 수행
- 플랜이 없으면 경고만 표시하고 진행하지 않음

### 3. 플랜 재생성 버튼
- "플랜 재생성" 버튼은 유지 (사용자가 명시적으로 재생성할 수 있음)
- 확인 다이얼로그로 실수 방지

## 결과

이제 일반 모드에서 플랜 생성 흐름이 더 자연스럽고 직관적입니다:

1. ✅ Step 6에서 "다음" 버튼 클릭 시 플랜 자동 생성
2. ✅ Step 7에서는 생성된 스케줄 결과를 바로 확인
3. ✅ 완료 버튼은 플랜 상세보기로 이동 (플랜 생성은 이미 완료)
4. ✅ 중복 생성 방지 로직으로 안전하게 동작

## 테스트 시나리오

1. 일반 모드에서 플랜 그룹 생성
2. Step 6까지 진행
3. Step 6에서 "다음" 버튼 클릭
4. 플랜이 자동으로 생성되고 Step 7로 이동하는지 확인
5. Step 7에서 스케줄 결과가 표시되는지 확인
6. 완료 버튼 클릭 시 플랜 상세보기로 이동하는지 확인
7. Step 6에서 "다음" 버튼을 다시 클릭해도 중복 생성되지 않는지 확인

## 관련 파일

- `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`
- `app/(student)/plan/new-group/_components/Step7ScheduleResult.tsx`

