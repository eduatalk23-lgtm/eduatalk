# 플랜 캘린더 제외일 필터링 수정

## 작업 일시
2025-12-05

## 문제점
- 플랜 캘린더 페이지에서 `getStudentExclusions(user.id)`를 사용하여 학생의 모든 제외일을 가져옴
- 플랜 생성 시에는 플랜 그룹별 제외일만 사용하는데, 캘린더에서는 다른 플랜 그룹의 제외일도 표시됨
- 플랜 생성 시 포함하지 않은 제외일이 달력에 표시되는 문제 발생

## 해결 방법
플랜 캘린더에서 활성 플랜 그룹들의 제외일만 조회하여 표시하도록 수정했습니다. 학원일정과 동일한 패턴으로 처리하여 일관성을 유지했습니다.

## 수정 내용

### 1. `app/(student)/plan/calendar/page.tsx`

#### Import 문 수정
- `getStudentExclusions` 제거
- `getPlanExclusions` 추가

```typescript
// 수정 전
import {
  getPlanGroupsForStudent,
  getStudentExclusions,
  getAcademySchedules,
} from "@/lib/data/planGroups";

// 수정 후
import {
  getPlanGroupsForStudent,
  getPlanExclusions,
  getAcademySchedules,
} from "@/lib/data/planGroups";
```

#### 제외일 조회 로직 수정 (224-241번 줄)
- 기존: 학생의 모든 제외일 조회 (`getStudentExclusions(user.id)`)
- 수정: 활성 플랜 그룹들의 제외일만 조회하여 병합

```typescript
// 수정 전
const exclusions = await getStudentExclusions(user.id);

// 수정 후
// 제외일 조회 (플랜 그룹별 관리)
// 활성 플랜 그룹들의 제외일 조회 후 병합
const exclusionsPromises = activePlanGroups.map((group) =>
  getPlanExclusions(group.id, tenantContext.tenantId)
);
const exclusionsArrays = await Promise.all(exclusionsPromises);

// 중복 제거: exclusion_date:exclusion_type 조합이 같은 것은 하나만 표시
const exclusionsMap = new Map();
for (const exclusions of exclusionsArrays) {
  for (const exclusion of exclusions) {
    const key = `${exclusion.exclusion_date}:${exclusion.exclusion_type}`;
    if (!exclusionsMap.has(key)) {
      exclusionsMap.set(key, exclusion);
    }
  }
}
const exclusions = Array.from(exclusionsMap.values());
```

## 변경 사항 요약
1. **제외일 조회 방식 변경**: 학생 전체 제외일 → 활성 플랜 그룹별 제외일
2. **중복 제거 로직 추가**: 같은 날짜와 유형의 제외일이 여러 플랜 그룹에 있을 경우 하나만 표시
3. **학원일정과 일관성 유지**: 학원일정 조회 로직(228-244번 줄)과 동일한 패턴 적용

## 검증 사항
1. ✅ 플랜 캘린더에서 활성 플랜 그룹의 제외일만 표시되는지 확인
2. ✅ 다른 플랜 그룹의 제외일이 표시되지 않는지 확인
3. ✅ 여러 플랜 그룹의 제외일이 중복되지 않고 올바르게 병합되는지 확인
4. ✅ 캠프 플랜의 경우에도 동일하게 동작하는지 확인 (캠프 플랜은 필터링되어 제외됨)

## 참고 사항
- 학원일정은 이미 플랜 그룹별로 조회하여 병합하고 있음 (228-244번 줄)
- 제외일도 동일한 패턴으로 처리하여 일관성 유지
- `getPlanExclusions` 함수는 이미 `lib/data/planGroups.ts`에 구현되어 있음
- 캠프 관련 플랜은 필터링되어 제외되므로 (`camp_template_id`, `camp_invitation_id` 체크), 캠프 플랜의 제외일은 표시되지 않음

## 영향 범위
- **영향 받는 페이지**: `/plan/calendar` (플랜 캘린더 페이지)
- **영향 받는 컴포넌트**: `PlanCalendarView`, `MonthView`, `WeekView`, `DayView`
- **데이터 흐름**: 제외일 데이터가 플랜 그룹별로 필터링되어 전달됨

## 테스트 권장 사항
1. 여러 플랜 그룹이 있을 때 각 그룹의 제외일이 올바르게 표시되는지 확인
2. 다른 플랜 그룹의 제외일이 표시되지 않는지 확인
3. 같은 날짜에 여러 플랜 그룹의 제외일이 있을 때 중복 없이 표시되는지 확인
4. 플랜 생성 시 포함한 제외일만 캘린더에 표시되는지 확인

