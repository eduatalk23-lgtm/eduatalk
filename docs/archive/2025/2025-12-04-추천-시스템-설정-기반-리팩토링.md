# 추천 시스템 설정 기반 리팩토링

## 작업 일자
2025-12-04

## 작업 목표
- 하드코딩된 추천 알고리즘 파라미터를 설정 기반으로 전환
- 관리자가 설정을 조율할 수 있는 시스템 구축
- 기존 기능에 영향을 주지 않으면서 점진적 마이그레이션
- 범위 추천 기능부터 시작 (가장 단순하고 영향 범위 작음)

## 구현 완료 단계

### Phase 1: 설정 타입 및 기본값 정의 ✅

**생성된 파일:**
- `lib/recommendations/config/types.ts` - 설정 타입 정의
- `lib/recommendations/config/defaultConfig.ts` - 기본 설정 값
- `lib/recommendations/config/index.ts` - 통합 export

**주요 내용:**
- `RangeRecommendationConfig` 타입 정의
- `RecommendationConfig` 타입 정의 (향후 확장 가능)
- 기본값: `pagesPerHour: 10`, `episodesPerHour: 1` (현재 하드코딩 값과 동일)

### Phase 2: 데이터베이스 스키마 설계 ✅

**마이그레이션 파일:**
- `supabase/migrations/20251204205824_create_recommendation_settings.sql`

**테이블 구조:**
- `recommendation_settings` 테이블 생성
- 테넌트별 설정 지원 (tenant_id nullable - 전역 설정 가능)
- RLS 정책 설정 (관리자만 접근 가능)
- 인덱스 및 코멘트 추가

### Phase 3: 설정 관리자 구현 ✅

**생성된 파일:**
- `lib/recommendations/config/configManager.ts`

**주요 함수:**
- `getRangeRecommendationConfig(tenantId?)` - 설정 조회 (테넌트 → 전역 → 기본값)
- `updateRangeRecommendationConfig(config, tenantId?)` - 설정 업데이트
- `resetRangeRecommendationConfig(tenantId?)` - 기본값으로 재설정
- 기본값 폴백 로직 구현
- 에러 처리 및 유효성 검증

### Phase 4: 범위 추천 함수에 설정 적용 ✅

**수정된 파일:**
- `lib/plan/rangeRecommendation.ts`
- `app/(admin)/admin/camp-templates/[id]/participants/_components/Step2RangeAdjustment.tsx`

**주요 변경사항:**
- `calculateRecommendedRanges` 함수를 async로 변경
- 선택적 `options` 파라미터 추가
- 설정이 제공되면 사용, 없으면 기본값 사용 (하위 호환성 보장)
- 호출부에 await 추가

### Phase 5: 중복 코드 정리 ✅

**수정된 파일:**
- `app/(student)/plan/new-group/_components/Step6FinalReview.tsx`
- `app/(student)/plan/new-group/_components/Step7ScheduleResult/ScheduleTableView.tsx`
- `lib/plan/assignPlanTimes.ts`
- `app/(student)/plan/new-group/_components/utils/scheduleTransform.ts`

**주요 변경사항:**
- 하드코딩된 `pagesPerHour = 10`, `episodesPerHour = 1` 값 제거
- 기본값을 import하여 사용하도록 변경
- 중앙 관리되는 설정 값 사용

### Phase 6: 관리자 UI 추가 ✅

**생성된 파일:**
- `app/(admin)/admin/recommendation-settings/page.tsx` - 메인 페이지
- `app/(admin)/admin/recommendation-settings/_components/RangeRecommendationSettings.tsx` - 설정 UI 컴포넌트
- `app/(admin)/actions/recommendationSettings.ts` - 서버 액션

**수정된 파일:**
- `components/navigation/global/categoryConfig.ts` - 네비게이션 메뉴에 추가
- `app/(admin)/admin/settings/page.tsx` - 설정 페이지에 링크 추가

**주요 기능:**
- 현재 설정 값 표시
- 설정 값 수정 (pagesPerHour, episodesPerHour)
- 저장/취소 버튼
- 기본값으로 재설정 버튼
- 로딩 및 에러 처리

**접근 경로:**
1. 사이드바 네비게이션: "설정" > "추천 시스템 설정" (admin만 표시)
2. 설정 페이지: `/admin/settings` > "추천 시스템 설정 관리" 버튼
3. 직접 URL: `/admin/recommendation-settings`

## 하드코딩 제거 위치

### 제거된 하드코딩 값들
1. `lib/plan/rangeRecommendation.ts` (113줄, 127줄) → 설정 기반으로 변경
2. `app/(student)/plan/new-group/_components/Step6FinalReview.tsx` (595줄, 609줄, 1061-1062줄) → 기본값 import
3. `app/(student)/plan/new-group/_components/Step7ScheduleResult/ScheduleTableView.tsx` (1550줄) → 기본값 import
4. `lib/plan/assignPlanTimes.ts` (55줄) → 기본값 import
5. `app/(student)/plan/new-group/_components/utils/scheduleTransform.ts` (218줄) → 기본값 import

## 주요 설계 결정

### 하위 호환성 유지
- 기존 함수 시그니처 유지 (선택적 파라미터 추가)
- 기본값을 현재 하드코딩 값과 동일하게 설정
- 설정이 없으면 기본값 사용 (기존 동작 유지)

### 설정 조회 전략
1. 테넌트별 설정 우선
2. 전역 설정 (tenant_id가 null)
3. 코드의 기본값 (폴백)

### 클라이언트 컴포넌트 처리
- 클라이언트 컴포넌트에서는 기본값을 import하여 사용
- 향후 서버에서 설정을 전달받을 수 있도록 구조화
- 서버 컴포넌트나 서버 액션에서는 설정 매니저 사용 가능

## 사용 방법

### 관리자가 설정 변경하기
1. 네비게이션 메뉴에서 "설정" > "추천 시스템 설정" 클릭
   - 또는 `/admin/settings` 페이지에서 "추천 시스템 설정 관리" 버튼 클릭
2. `/admin/recommendation-settings` 페이지에서 범위 추천 설정 섹션 값 수정
3. 저장 버튼 클릭

### 코드에서 설정 사용하기

#### 서버 컴포넌트/액션에서
```typescript
import { getRangeRecommendationConfig } from "@/lib/recommendations/config/configManager";

const config = await getRangeRecommendationConfig(tenantId);
// config.pagesPerHour, config.episodesPerHour 사용
```

#### 클라이언트 컴포넌트에서
```typescript
import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";

// 기본값 사용 (향후 서버에서 설정을 받아올 수 있도록 구조화 가능)
const pagesPerHour = defaultRangeRecommendationConfig.pagesPerHour;
```

## 향후 확장 가능성

### 콘텐츠 추천 설정 추가
- `ContentRecommendationConfig` 타입 추가
- `getContentRecommendationConfig` 함수 추가
- UI 컴포넌트 추가

### 배치 추천 설정 추가
- `BatchRecommendationConfig` 타입 추가
- 배치 추천 로직에 설정 적용

### A/B 테스트 지원
- 여러 전략 등록
- 성과 분석 대시보드
- 자동 조정 기능

## 예상 효과

### 즉시 효과
- ✅ 하드코딩 값 변경 시 코드 수정 불필요 (DB에서 설정만 변경)
- ✅ 관리자가 실시간으로 알고리즘 조정 가능
- ✅ 테스트 환경에서 다양한 설정값으로 검증 가능

### 장기 효과
- ✅ 다른 추천 기능도 동일한 패턴으로 확장 가능
- ✅ A/B 테스트 및 성과 분석 기반 자동 조정 가능
- ✅ 테넌트별 맞춤 설정 지원

## 주의사항

### 마이그레이션 필요
- 생성한 마이그레이션 파일을 Supabase에 적용해야 함
- `supabase/migrations/20251204205824_create_recommendation_settings.sql`

### 기본값 확인
- 현재 모든 곳에서 기본값을 사용 중
- 설정을 변경하려면 관리자 페이지에서 설정 변경 필요

### 테넌트별 설정
- 테넌트 ID가 있는 경우 테넌트별 설정이 우선 사용됨
- 전역 설정은 모든 테넌트에 적용 (tenant_id가 null)

## 수정된 파일 목록

### 신규 파일
1. `lib/recommendations/config/types.ts`
2. `lib/recommendations/config/defaultConfig.ts`
3. `lib/recommendations/config/configManager.ts`
4. `lib/recommendations/config/index.ts`
5. `supabase/migrations/20251204205824_create_recommendation_settings.sql`
6. `app/(admin)/admin/recommendation-settings/page.tsx`
7. `app/(admin)/admin/recommendation-settings/_components/RangeRecommendationSettings.tsx`
8. `app/(admin)/actions/recommendationSettings.ts`

### 수정 파일
1. `lib/plan/rangeRecommendation.ts`
2. `app/(admin)/admin/camp-templates/[id]/participants/_components/Step2RangeAdjustment.tsx`
3. `app/(student)/plan/new-group/_components/Step6FinalReview.tsx`
4. `app/(student)/plan/new-group/_components/Step7ScheduleResult/ScheduleTableView.tsx`
5. `lib/plan/assignPlanTimes.ts`
6. `app/(student)/plan/new-group/_components/utils/scheduleTransform.ts`
7. `components/navigation/global/categoryConfig.ts` - 네비게이션 메뉴에 추천 시스템 설정 추가
8. `app/(admin)/admin/settings/page.tsx` - 설정 페이지에 추천 시스템 설정 링크 추가

## 테스트 시나리오

1. ✅ 기존 기능 정상 동작 확인 (기본값 사용)
2. ✅ 관리자 설정 페이지 접근 및 설정 조회
3. ✅ 설정 변경 및 저장
4. ✅ 설정 재설정 기능
5. ✅ 테넌트별 설정 동작 확인 (향후)

## 완료 상태

✅ Phase 1: 설정 타입 및 기본값 정의
✅ Phase 2: 데이터베이스 스키마 설계
✅ Phase 3: 설정 관리자 구현
✅ Phase 4: 범위 추천 함수에 설정 적용
✅ Phase 5: 중복 코드 정리
✅ Phase 6: 관리자 UI 추가

모든 단계가 완료되었습니다.

