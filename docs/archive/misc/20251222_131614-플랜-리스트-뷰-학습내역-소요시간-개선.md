# 플랜 리스트 뷰 학습 내역 및 소요시간 표시 개선

## 작업 일시
2025년 12월 22일

## 문제 상황
- 학습 내역과 소요시간이 제대로 도출되지 않음
- 강의 콘텐츠에 회차 정보(소요시간 등 회차명)이 있는 부분이 제대로 표시되지 않음
- 플랜 생성시 권한 문제 확인 필요

## 원인 분석

### 1. 학습 내역(chapter) 표시 문제
- `PlanListView`에서 `plan.contentEpisode`를 사용하고 있었지만, fallback 로직이 부족함
- `contentEpisode`가 null인 경우 `plan.chapter`를 사용하도록 되어 있었지만, 우선순위가 명확하지 않음

### 2. 소요시간 계산 문제
- `start_time`과 `end_time`이 있는 경우에만 소요시간을 계산하고 있었음
- 시간 정보가 없는 경우 콘텐츠 정보(episodes, total_pages)를 기반으로 소요시간을 계산하지 않았음
- 강의의 경우 episode별 duration 정보가 있지만 이를 활용하지 않았음

### 3. 권한 문제 확인
- `_getScheduleResultData` 함수의 권한 체크 로직을 확인한 결과, 정상적으로 작동하고 있음
- 학생/관리자/컨설턴트 권한에 따라 적절히 처리되고 있음

## 수정 내용

### 1. PlanListView 컴포넌트 수정
**파일**: `app/(student)/plan/group/[id]/_components/PlanListView.tsx`

#### 학습 내역 표시 개선
- `contentEpisode`를 우선적으로 사용하도록 명확히 함
- `contentEpisode`가 없으면 `chapter`를 사용하도록 fallback 로직 유지

#### 소요시간 계산 개선
- `start_time`과 `end_time`이 있으면 이를 기반으로 계산 (기존 로직 유지)
- 시간 정보가 없는 경우 콘텐츠 정보를 기반으로 소요시간 계산:
  - **강의**: episode별 duration 정보를 합산
    - episode별 duration이 있으면 사용
    - episode 정보가 없으면 기본값 30분 사용
  - **교재**: 페이지 수 기반 계산 (60페이지/시간 가정)

```typescript
// 소요시간 계산: start_time과 end_time이 있으면 사용, 없으면 콘텐츠 정보 기반으로 계산
let durationMinutes = 0;
if (plan.start_time && plan.end_time) {
  durationMinutes = timeToMinutes(plan.end_time) - timeToMinutes(plan.start_time);
} else if (content && plan.planned_start_page_or_time !== null && plan.planned_end_page_or_time !== null) {
  // 시간 정보가 없으면 콘텐츠 정보 기반으로 계산
  if (plan.content_type === "lecture" && content.episodes) {
    // 강의의 경우 episode별 duration 합산
    const startEpisode = plan.planned_start_page_or_time;
    const endEpisode = plan.planned_end_page_or_time;
    let totalDuration = 0;
    for (let i = startEpisode; i <= endEpisode; i++) {
      const episode = content.episodes.find((ep) => ep.episode_number === i);
      if (episode && episode.duration !== null && episode.duration > 0) {
        totalDuration += episode.duration;
      } else {
        // episode 정보가 없으면 기본값 30분 사용
        totalDuration += 30;
      }
    }
    durationMinutes = totalDuration;
  } else if (plan.content_type === "book" && content.total_pages) {
    // 교재의 경우 페이지 수 기반 계산 (60페이지/시간 가정)
    const pages = plan.planned_end_page_or_time - plan.planned_start_page_or_time + 1;
    durationMinutes = Math.round((pages / 60) * 60); // 분 단위
  }
}
```

## 확인 사항

### 1. 데이터 흐름 확인
- `_getScheduleResultData` 함수에서 episodes 정보를 조회하고 `contentsMap`에 추가하고 있음 (690-699줄)
- `PlanScheduleView`에서 `contents` 배열을 Map으로 변환할 때 episodes 정보가 포함되어 있음
- `PlanListView`에서 `contents` Map을 사용하여 episode 정보에 접근 가능

### 2. 권한 체크 확인
- `_getScheduleResultData` 함수에서 학생/관리자/컨설턴트 권한을 적절히 체크하고 있음
- Admin 클라이언트를 사용하여 다른 학생의 데이터를 조회할 수 있도록 처리되어 있음

### 3. contentEpisode 생성 확인
- `_getScheduleResultData` 함수에서 강의/교재 콘텐츠에 대해 `contentEpisode`를 생성하고 있음
- 강의의 경우 `createLectureEpisodeString` 함수를 사용하여 episode_title 기반으로 생성
- 교재의 경우 `createBookEpisodeString` 함수를 사용하여 major_unit/minor_unit 기반으로 생성

## 테스트 항목

1. **학습 내역 표시**
   - 강의 콘텐츠의 경우 episode_title이 제대로 표시되는지 확인
   - 교재 콘텐츠의 경우 major_unit/minor_unit이 제대로 표시되는지 확인
   - contentEpisode가 없는 경우 chapter가 표시되는지 확인

2. **소요시간 표시**
   - start_time과 end_time이 있는 경우 시간 차이로 계산되는지 확인
   - 시간 정보가 없는 경우 episode별 duration 합산이 제대로 되는지 확인
   - episode 정보가 없는 경우 기본값 30분이 사용되는지 확인
   - 교재의 경우 페이지 수 기반 계산이 제대로 되는지 확인

3. **권한 체크**
   - 학생이 자신의 플랜만 조회할 수 있는지 확인
   - 관리자/컨설턴트가 다른 학생의 플랜을 조회할 수 있는지 확인

## 관련 파일
- `app/(student)/plan/group/[id]/_components/PlanListView.tsx`
- `app/(student)/actions/plan-groups/queries.ts` (확인만 수행)

## 참고 사항
- `formatPlanLearningAmount` 함수는 정상적으로 작동하고 있음
- `_getScheduleResultData` 함수에서 episodes 정보를 조회하고 있지만, 권한 문제는 없음
- 콘텐츠 정보(episodes, total_pages)가 없는 경우 기본값을 사용하도록 처리




