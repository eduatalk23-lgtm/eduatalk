# 필드별 오류 표시 자동 스크롤 수정

**작업 일시**: 2025-02-01  
**작업 내용**: 첫 번째 오류 필드로 자동 스크롤 이동 시 화면 순서 기준으로 올바른 필드로 이동하도록 수정 및 학습 기간 오류 메시지 중복 제거

## 문제점

### 1. 첫 번째 오류 필드 스크롤 문제

기존 구현에서는 `Map`의 첫 번째 키를 가져와서 첫 번째 오류 필드로 스크롤했는데, 이는 검증 로직에서 오류를 추가하는 순서에 따라 결정되었습니다. 

하지만 검증 로직의 순서와 화면에 표시되는 필드 순서가 다를 수 있어서, 사용자가 3번째 필드로 이동했다가 다시 다음 버튼을 누르면 첫 번째 필드로 이동하는 문제가 발생했습니다.

예를 들어:
- 검증 순서: `plan_name` → `plan_purpose` → `scheduler_type` → `period_start`
- 화면 순서: `plan_name` → `plan_purpose` → `period_start` → `scheduler_type`

### 2. 학습 기간 오류 메시지 중복

`DateInput` 컴포넌트 내부에서 오류 메시지를 표시하고, `PeriodSection`에서도 `FieldError` 컴포넌트를 사용하여 오류 메시지를 표시하여 중복으로 표시되는 문제가 발생했습니다.

## 해결 방법

### 1. 필드 순서 정의

각 Step별로 화면에 표시되는 필드 순서를 명시적으로 정의:

```typescript
const FIELD_ORDER_BY_STEP: Record<WizardStep, string[]> = {
  1: ["plan_name", "plan_purpose", "period_start", "scheduler_type"],
  2: [],
  3: [],
  4: ["content_selection"],
  5: [],
  6: [],
  7: [],
};
```

### 2. 첫 번째 오류 필드 찾기 함수 추가

화면 순서에 따라 첫 번째 오류 필드를 찾는 함수 구현:

```typescript
export function getFirstErrorFieldId(
  fieldErrors: FieldErrors,
  step: WizardStep
): string | undefined {
  if (fieldErrors.size === 0) return undefined;

  const fieldOrder = FIELD_ORDER_BY_STEP[step];
  if (!fieldOrder || fieldOrder.length === 0) {
    // 필드 순서가 정의되지 않은 경우 Map의 첫 번째 키 반환
    return Array.from(fieldErrors.keys())[0];
  }

  // 화면 순서에 따라 첫 번째 오류 필드 찾기
  for (const fieldId of fieldOrder) {
    if (fieldErrors.has(fieldId)) {
      return fieldId;
    }
  }

  // 순서에 없는 필드인 경우 Map의 첫 번째 키 반환
  return Array.from(fieldErrors.keys())[0];
}
```

### 3. PlanGroupWizard에서 스크롤 타이밍 개선

`useEffect`를 사용하여 `fieldErrors`가 변경되고 스크롤 플래그가 설정되어 있을 때만 스크롤하도록 수정:

```typescript
// 검증 실패 시 스크롤을 위한 ref
const shouldScrollToErrorRef = useRef(false);

// fieldErrors가 변경되고 스크롤 플래그가 설정되어 있으면 스크롤 실행
useEffect(() => {
  if (shouldScrollToErrorRef.current && fieldErrors.size > 0) {
    shouldScrollToErrorRef.current = false;
    scrollToFirstError();
  }
}, [fieldErrors, scrollToFirstError]);

const handleNext = () => {
  if (currentStep !== 3) {
    if (!validateStep(currentStep)) {
      // 검증 실패 시 스크롤 플래그 설정
      // useEffect에서 fieldErrors 변경 감지 후 스크롤 실행
      shouldScrollToErrorRef.current = true;
      return;
    }
  }
  // ...
};
```

`scrollToFirstError` 함수에서 `requestAnimationFrame`을 두 번 사용하여 브라우저 렌더링 완료를 보장:

```typescript
const scrollToFirstError = useCallback(() => {
  if (fieldErrors.size === 0) return;

  const firstFieldId = getFirstErrorFieldId(fieldErrors, currentStep);
  if (!firstFieldId) return;

  // DOM 업데이트 후 스크롤 실행
  // requestAnimationFrame을 두 번 사용하여 브라우저 렌더링 완료 보장
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      scrollToField(firstFieldId);
    });
  });
}, [fieldErrors, currentStep]);
```

### 4. 학습 기간 오류 메시지 중복 제거

`DateInput` 컴포넌트에서 오류 메시지 표시를 제거하고, `PeriodSection`에서만 `FieldError` 컴포넌트를 사용하여 오류 메시지를 표시하도록 수정:

```typescript
// DateInput.tsx - 오류 메시지 표시 제거
{/* 오류 메시지는 부모 컴포넌트에서 표시하므로 여기서는 표시하지 않음 */}
```

```typescript
// PeriodSection.tsx - FieldError 컴포넌트만 사용
<DateInput
  id="dday-date-input"
  label="시험일 입력"
  value={ddayState.date}
  error={fieldErrors?.get("period_start")}
  dataFieldId="period_start"
/>
<FieldError error={fieldErrors?.get("period_start")} id="dday-date-input-error" />
```

## 변경된 파일

1. `app/(student)/plan/new-group/_components/hooks/useWizardValidation.ts`
   - `FIELD_ORDER_BY_STEP` 상수 추가
   - `getFirstErrorFieldId` 함수 추가 및 export

2. `app/(student)/plan/new-group/_components/PlanGroupWizard.tsx`
   - `getFirstErrorFieldId` import 추가
   - `shouldScrollToErrorRef` ref 추가
   - `useEffect`를 사용하여 `fieldErrors` 변경 감지 후 스크롤 실행
   - `scrollToFirstError` 함수에서 `requestAnimationFrame` 사용

3. `app/(student)/plan/new-group/_components/_shared/DateInput.tsx`
   - 오류 메시지 표시 제거 (부모 컴포넌트에서만 표시)

4. `app/(student)/plan/new-group/_components/Step1BasicInfo/PeriodSection.tsx`
   - `FieldError` 컴포넌트의 `id` prop을 각 DateInput의 `id`에 맞게 수정

## 테스트 시나리오

1. **Step 1에서 여러 필드 오류 발생 시**:
   - 플랜 이름, 플랜 목적, 학습 기간, 스케줄러 유형 모두 비어있는 상태
   - 다음 버튼 클릭 → 플랜 이름 필드로 스크롤 (화면 첫 번째 필드)

2. **Step 1에서 중간 필드 오류 발생 시**:
   - 플랜 이름은 입력, 플랜 목적은 선택, 학습 기간은 미설정, 스케줄러 유형은 미선택
   - 다음 버튼 클릭 → 학습 기간 필드로 스크롤 (화면 순서 기준)

3. **Step 4에서 콘텐츠 미선택 시**:
   - 콘텐츠 선택 영역으로 스크롤

4. **학습 기간 오류 메시지 중복 확인**:
   - 학습 기간 미설정 시 오류 메시지가 한 번만 표시되는지 확인

## 향후 개선 사항

- 다른 Step에서도 필드 순서가 필요한 경우 `FIELD_ORDER_BY_STEP`에 추가
- 필드 순서를 동적으로 관리할 수 있는 방법 고려 (예: 각 Step 컴포넌트에서 필드 순서 정의)
