# 슬롯 모드 통합 구현 계획

## 문서 정보
- **작성일**: 2025-12-24
- **기반 문서**: `20251224_슬롯모드-통합-과목선택-설계.md`
- **상태**: Phase 1-5 완료 ✅
- **최종 업데이트**: 2025-12-24

---

## 구현 개요

### 목표
1. 슬롯에 전략/취약 과목 설정 통합
2. 콘텐츠 없이 가상 스케줄 생성 지원
3. 기본 모드의 콘텐츠 연결 기능을 슬롯 모드에 통합

### 주요 변경 영역
- 타입 확장 (SlotTemplate, ContentSlot, PlanItem)
- UI 추가 (슬롯 배정 방식, 콘텐츠 연결 개선)
- 로직 추가 (배정 변환, 가상 플랜 생성)

---

## Phase 1: 슬롯 타입 확장 및 배정 방식 UI ✅ 완료

### 1.1 타입 확장
- [x] **1.1.1** `SlotTemplate`에 `subject_type`, `weekly_days` 필드 추가
  - 파일: `lib/types/content-selection.ts`
  - 복잡도: 낮음

- [x] **1.1.2** `ContentSlot`에 동일 필드 상속 확인
  - 파일: `lib/types/content-selection.ts`
  - 복잡도: 낮음

- [x] **1.1.3** Zod 스키마 업데이트 (검증 추가)
  - 파일: `lib/schemas/planWizardSchema.ts`
  - 복잡도: 낮음

### 1.2 슬롯 UI 배정 방식 추가
- [x] **1.2.1** `SlotItem.tsx`에 배정 방식 라디오 버튼 추가
  - 취약과목 (기본) / 전략과목
  - 파일: `slot-mode/SlotItem.tsx`
  - 복잡도: 중간

- [x] **1.2.2** 전략과목 선택 시 `weekly_days` 드롭다운 표시
  - 주 2일 / 주 3일 (기본) / 주 4일
  - 파일: `slot-mode/SlotItem.tsx`
  - 복잡도: 낮음

- [x] **1.2.3** 예상 배정 일수 표시
  - "전체 6일 중 6일 (취약)" / "전체 6일 중 3일 (전략)"
  - 파일: `slot-mode/SlotItem.tsx`
  - 복잡도: 중간
  - 의존성: daily_schedule 데이터 필요

### 1.3 과목 선택 UI 개선
- [x] **1.3.1** `subject_id` 선택 드롭다운 추가
  - 현재 subject_category만 있음
  - 파일: `slot-mode/SlotItem.tsx`
  - 복잡도: 중간
  - 의존성: 과목 목록 API (`getSubjectsByCategory` 추가)

---

## Phase 2: 배정 로직 통합 ✅ 완료

### 2.1 슬롯 → SubjectAllocation 변환
- [x] **2.1.1** `buildAllocationFromSlots()` 함수 구현
  - 파일: `lib/plan/virtualSchedulePreview.ts`
  - 복잡도: 중간
  ```typescript
  function buildAllocationFromSlots(slots: ContentSlot[]): SubjectAllocation[]
  ```

- [x] **2.1.2** 가상 타임라인에 배정 정보 표시
  - `calculateVirtualTimeline()` 함수로 슬롯 기반 타임라인 생성
  - 파일: `lib/plan/virtualSchedulePreview.ts`
  - 복잡도: 중간

### 2.2 Dual Write 패턴 구현
- [x] **2.2.1** 플랜 저장 시 `content_slots` → `subject_allocations` 자동 생성
  - 파일: `lib/domains/plan/actions/plan-groups/update.ts`
  - 파일: `lib/domains/plan/actions/plan-groups/create.ts`
  - 복잡도: 중간

- [x] **2.2.2** `use_slot_mode` 플래그에 따른 분기 처리
  - 파일: `lib/plan/services/preparePlanGenerationData.ts`
  - 복잡도: 중간

### 2.3 기존 로직 호환성
- [x] **2.3.1** `getEffectiveAllocation()` 슬롯 지원 추가
  - 파일: `lib/utils/subjectAllocation.ts`
  - 복잡도: 낮음

---

## Phase 3: 가상 스케줄 생성 ✅ 완료

### 3.1 PlanItem 타입 확장
- [x] **3.1.1** `is_virtual`, `slot_index` 필드 추가
  - 파일: `lib/types/plan/domain.ts`
  - 복잡도: 낮음

- [x] **3.1.2** `virtual_subject_category`, `virtual_description` 필드 추가
  - 파일: `lib/types/plan/domain.ts`
  - 복잡도: 낮음

- [x] **3.1.3** DB 마이그레이션 (student_plan 테이블)
  - 파일: `supabase/migrations/20251224100000_add_virtual_plan_fields.sql`
  - 복잡도: 낮음

### 3.2 가상 플랜 생성 로직
- [x] **3.2.1** `generateVirtualPlanItems()` 함수 구현
  - 콘텐츠 없이 일수 기반 배정
  - 파일: `lib/plan/virtualSchedulePreview.ts`
  - 복잡도: 높음

- [x] **3.2.2** `generatePlans()` 혼합 모드 지원
  - 실제 + 가상 plan_items 동시 생성
  - 파일: `lib/domains/plan/actions/plan-groups/generatePlansRefactored.ts`
  - 복잡도: 높음

### 3.3 캘린더 가상 항목 표시
- [x] **3.3.1** 가상 항목 스타일 구분
  - 점선 테두리, amber 배경, 이탤릭체
  - 파일: `app/(student)/plan/calendar/_components/CalendarPlanCard.tsx`
  - 복잡도: 중간

- [x] **3.3.2** "콘텐츠 연결하기" 버튼 표시
  - `onLinkContent` 콜백으로 연결 기능 제공
  - 파일: `app/(student)/plan/calendar/_components/CalendarPlanCard.tsx`
  - 복잡도: 중간

### 3.4 학습 시작 제한
- [x] **3.4.1** `canStartLearning()` 함수 구현
  - 파일: `lib/types/plan/utils.ts` (신규)
  - 복잡도: 낮음

- [x] **3.4.2** 가상 항목 학습 시작 버튼 비활성화
  - 서버 측: `lib/domains/today/actions/timer.ts` (startPlan 검증)
  - 클라이언트 측: `app/(student)/today/_components/timer/TimerControls.tsx`
  - 복잡도: 낮음

---

## Phase 4: 콘텐츠 연결 후 재생성 ✅ 완료

### 4.1 슬롯별 콘텐츠 연결 UI
- [x] **4.1.1** 콘텐츠 연결 서버 액션
  - 파일: `lib/domains/plan/actions/linkContent.ts`
  - 구현: `linkContentToVirtualPlan()`, `getAvailableContentsForSlot()`
  - 복잡도: 중간

- [x] **4.1.2** 콘텐츠 연결 모달 UI
  - 파일: `app/(student)/plan/calendar/_components/ContentLinkingModal.tsx`
  - 기능: 탭 기반 콘텐츠 선택, 검색, 범위 설정
  - 복잡도: 중간

### 4.2 DayView 통합
- [x] **4.2.1** TimelineItem에 onLinkContent 콜백 연결
  - 파일: `app/(student)/plan/calendar/_components/TimelineItem.tsx`
  - 복잡도: 낮음

- [x] **4.2.2** DayView 상태 관리 및 모달 통합
  - 파일: `app/(student)/plan/calendar/_components/DayView.tsx`
  - 파일: `app/(student)/plan/calendar/_components/PlanCalendarView.tsx`
  - 파일: `app/(student)/plan/calendar/page.tsx` (studentId 전달)
  - 복잡도: 중간

---

## Phase 5: 콘텐츠 연결 기능 통합 (기본 모드 → 슬롯 모드) ✅ 완료

### 5.1 마스터 콘텐츠 가져오기
- [x] **5.1.1** `ContentLinkingModal`에 소스 탭 UI 추가
  - [내 콘텐츠] | [추천] | [마스터 검색] 탭 구현
  - 파일: `app/(student)/plan/calendar/_components/ContentLinkingModal.tsx`
  - 복잡도: 중간
  - 구현: 마스터 콘텐츠 검색 및 선택 기능 포함

- [ ] **5.1.2** 마스터 콘텐츠 검색 훅 추출 (추후 리팩토링)
  - `MasterContentsPanel` 로직 공통화
  - 파일: `hooks/useMasterContentSearch.ts` (신규)
  - 복잡도: 중간
  - 상태: 현재 ContentLinkingModal에 인라인 구현됨 (기능 완료, 리팩토링 대기)

- [x] **5.1.3** 마스터 → 학생 콘텐츠 변환 로직
  - 마스터 콘텐츠 선택 시 자동으로 학생 books/lectures 테이블에 복사
  - `copyMasterBookToStudent`, `copyMasterLectureToStudent` 통합
  - detail ID 매핑 (마스터 → 학생)
  - 파일: `lib/domains/plan/actions/linkContent.ts`
  - 복잡도: 중간

### 5.2 상세 정보 선택 (목차/에피소드)
- [x] **5.2.1** `RangeSettingModal` 통합
  - 콘텐츠 선택 시 RangeSettingModal 표시
  - 마스터/학생 콘텐츠 모두 지원
  - 파일: `app/(student)/plan/calendar/_components/ContentLinkingModal.tsx`
  - 복잡도: 중간

- [x] **5.2.2** `start_detail_id`, `end_detail_id` 저장
  - ContentLinkInfo 타입 확장
  - plan_groups.content_slots JSONB에 저장
  - 파일: `lib/domains/plan/actions/linkContent.ts`
  - 복잡도: 낮음

### 5.3 추천 콘텐츠 연동
- [x] **5.3.1** 슬롯 기반 콘텐츠 추천 로직
  - 슬롯의 `subject_category` 기반 추천 콘텐츠 조회
  - `getRecommendedMasterContentsAction` 통합
  - 파일: `ContentLinkingModal.tsx`
  - 복잡도: 중간

- [x] **5.3.2** 추천 콘텐츠 탭 UI
  - [추천] 탭 추가 (amber 테마)
  - 추천 이유 표시 (성적 분석 기반)
  - 파일: `ContentLinkingModal.tsx`
  - 복잡도: 낮음

---

## 우선순위 요약

| Phase | 설명 | 복잡도 | 의존성 | 상태 |
|-------|------|--------|--------|------|
| **Phase 1** | 슬롯 타입 확장 및 배정 UI | 중간 | 없음 | ✅ 완료 |
| **Phase 2** | 배정 로직 통합 | 중간 | Phase 1 | ✅ 완료 |
| **Phase 3** | 가상 스케줄 생성 | 높음 | Phase 1, 2 | ✅ 완료 |
| **Phase 4** | 콘텐츠 연결 후 재생성 | 높음 | Phase 3 | ✅ 완료 |
| **Phase 5** | 콘텐츠 연결 기능 통합 | 중간 | Phase 1 (독립 진행 가능) | ✅ 완료 |

---

## 체크리스트 요약

### Phase 1 (슬롯 타입 확장) ✅ 완료
- [x] 1.1.1 타입 필드 추가 (`lib/types/content-selection.ts`)
- [x] 1.1.2 ContentSlot 상속 확인 (자동 상속)
- [x] 1.1.3 Zod 스키마 업데이트 (`lib/schemas/planWizardSchema.ts`)
- [x] 1.2.1 배정 방식 라디오 버튼 (`slot-mode/SlotItem.tsx`)
- [x] 1.2.2 weekly_days 드롭다운
- [x] 1.2.3 예상 배정 일수 표시 (기본 구현)
- [x] 1.3.1 subject_id 선택 드롭다운 (UI 및 액션 추가)

### Phase 2 (배정 로직) ✅ 완료
- [x] 2.1.1 buildAllocationFromSlots() 구현 (`lib/plan/virtualSchedulePreview.ts`)
- [x] 2.1.2 가상 타임라인 배정 표시 (`calculateVirtualTimeline()`)
- [x] 2.2.1 Dual Write 저장 로직 (`create.ts`, `update.ts`)
- [x] 2.2.2 use_slot_mode 분기 처리 (`preparePlanGenerationData.ts`)
- [x] 2.3.1 getEffectiveAllocation() 슬롯 지원 (`lib/utils/subjectAllocation.ts`)

### Phase 3 (가상 스케줄) ✅ 완료
- [x] 3.1.1 PlanItem is_virtual 필드 (`lib/types/plan/domain.ts`)
- [x] 3.1.2 virtual 메타데이터 필드 (`virtual_subject_category`, `virtual_description`)
- [x] 3.1.3 DB 마이그레이션 (`20251224100000_add_virtual_plan_fields.sql`)
- [x] 3.2.1 generateVirtualPlanItems() 구현 (`lib/plan/virtualSchedulePreview.ts`)
- [x] 3.2.2 generatePlans() 혼합 모드 (`generatePlansRefactored.ts`)
- [x] 3.3.1 가상 항목 스타일 (`CalendarPlanCard.tsx` - amber 점선 테두리)
- [x] 3.3.2 콘텐츠 연결 버튼 (`onLinkContent` 콜백)
- [x] 3.4.1 canStartLearning() 함수 (`lib/types/plan/utils.ts`)
- [x] 3.4.2 학습 시작 제한 UI (`TimerControls.tsx`, `timer.ts`)

### Phase 4 (콘텐츠 연결) ✅ 완료
- [x] 4.1.1 콘텐츠 연결 서버 액션 (`lib/domains/plan/actions/linkContent.ts`)
- [x] 4.1.2 ContentLinkingModal UI (`app/(student)/plan/calendar/_components/ContentLinkingModal.tsx`)
- [x] 4.2.1 TimelineItem onLinkContent 연결 (`TimelineItem.tsx`)
- [x] 4.2.2 DayView 상태 관리 및 모달 통합 (`DayView.tsx`, `PlanCalendarView.tsx`)

### Phase 5 (콘텐츠 연결 통합) ✅ 완료
- [x] 5.1.1 탭 UI 추가 (내 콘텐츠 / 추천 / 마스터 검색)
- [ ] 5.1.2 마스터 검색 훅 추출 (useMasterContentSearch) - 추후 리팩토링
- [x] 5.1.3 마스터 → 학생 변환 (copyMasterBookToStudent/copyMasterLectureToStudent 통합)
- [x] 5.2.1 RangeSettingModal 통합
- [x] 5.2.2 detail_id 저장 (content_slots JSONB에 저장)
- [x] 5.3.1 슬롯 기반 추천 로직 (getRecommendedMasterContentsAction 통합)
- [x] 5.3.2 추천 콘텐츠 탭 UI (amber 테마)

---

## 테스트 계획

### 단위 테스트
- [x] 슬롯 관계 테스트 (19/19 통과) - `__tests__/content-selection/slotRelationships.test.ts`
  - 연계 슬롯 같은 날 연속 배치
  - 배타적 슬롯 다른 날 배치
  - 순환 참조 탐지
  - 자기 참조 에러 검출
- [ ] `buildAllocationFromSlots()` 테스트
- [ ] `generateVirtualPlanItems()` 테스트
- [ ] `regeneratePlanItems()` 테스트
- [ ] `canStartLearning()` 테스트

### 통합 테스트
- [ ] 슬롯 모드 플랜 생성 전체 플로우
- [ ] 가상 → 실제 변환 플로우
- [ ] 기존 플랜 호환성 테스트

### E2E 테스트
- [ ] 슬롯 구성 → 스케줄 생성 → 콘텐츠 연결 전체 시나리오

---

## 구현 완료 커밋 로그

```
f055db9a feat: slot mode integration Phase 1-2 (subject selection & scheduling)
9794c749 feat: implement virtual plan support (Phase 3 - slot mode integration)
7786da7f fix: persist slot mode data (use_slot_mode, content_slots) to database
```
