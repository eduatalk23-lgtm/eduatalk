# 학생 구분 항목 CRUD 관리 페이지 구현

## 작업 일자
2025-01-20

## 작업 개요
학생 구분 항목(고등부, 중등부, 기타)을 하드코딩된 상수에서 데이터베이스 기반 동적 관리로 전환하여 CRUD 기능을 제공하는 관리 페이지를 구현했습니다.

## 구현 내용

### 1. 데이터베이스 마이그레이션

#### 1.1 student_divisions 테이블 생성
- **파일**: `supabase/migrations/20250120000000_create_student_divisions.sql`
- **구조**:
  - `id` (uuid, PK)
  - `name` (text, UNIQUE) - "고등부", "중등부", "기타"
  - `display_order` (integer) - 정렬 순서
  - `is_active` (boolean) - 활성화 여부
  - `created_at`, `updated_at` (timestamptz)
- **인덱스**: `display_order`, `is_active`
- **RLS 정책**: 관리자만 CRUD 가능
- **초기 데이터**: 기존 하드코딩된 값 삽입 (고등부, 중등부, 기타)

#### 1.2 students.division 필드 제약조건 변경
- **파일**: `supabase/migrations/20250120000001_update_students_division_constraint.sql`
- **변경사항**: 
  - 기존 CHECK 제약조건 제거
  - 애플리케이션 레벨에서만 검증하도록 변경 (옵션 3)

### 2. 데이터 레이어 함수

#### 2.1 새 파일 생성
- **파일**: `lib/data/studentDivisions.ts`
- **패턴**: `lib/data/contentMetadata.ts`의 `Platform`, `Publisher` CRUD 함수 참고
- **함수**:
  - `getStudentDivisions()` - 목록 조회 (display_order 정렬)
  - `getActiveStudentDivisions()` - 활성 항목만 조회
  - `getStudentDivisionById(id)` - 단일 조회
  - `createStudentDivision(name, displayOrder)` - 생성
  - `updateStudentDivision(id, updates)` - 수정
  - `deleteStudentDivision(id)` - 삭제 (사용 중인 학생이 있으면 에러)
  - `checkDivisionInUse(id)` - 사용 중인지 확인

#### 2.2 타입 정의
- **타입**: `StudentDivisionItem` (id, name, display_order, is_active, created_at, updated_at)

### 3. Server Actions

#### 3.1 새 파일 생성
- **파일**: `app/actions/studentDivisionsActions.ts`
- **패턴**: `app/(admin)/actions/contentMetadataActions.ts` 참고
- **함수**:
  - `getStudentDivisionsAction()` - 목록 조회
  - `getActiveStudentDivisionsAction()` - 활성 항목만 조회
  - `createStudentDivisionAction(name, displayOrder)` - 생성
  - `updateStudentDivisionAction(id, updates)` - 수정
  - `deleteStudentDivisionAction(id)` - 삭제
- **권한 확인**: 관리자만 접근 가능

### 4. UI 컴포넌트

#### 4.1 구분 항목 관리 페이지
- **파일**: `app/(admin)/admin/students/divisions/items/page.tsx`
- **구조**: 서버 컴포넌트로 권한 확인 후 클라이언트 컴포넌트 렌더링
- **기능**: `BaseMetadataManager` 컴포넌트 재사용

#### 4.2 구분 항목 관리 컴포넌트
- **파일**: `app/(admin)/admin/students/divisions/items/_components/StudentDivisionsManager.tsx`
- **패턴**: `app/(admin)/admin/content-metadata/_components/PlatformsManager.tsx` 참고
- **기능**: `BaseMetadataManager`를 래핑하여 구분 항목 관리

### 5. 기존 코드 수정

#### 5.1 UI 컴포넌트 수정
다음 컴포넌트들을 하드코딩된 `STUDENT_DIVISIONS` 상수 대신 `getActiveStudentDivisionsAction()`으로 동적 로드하도록 변경:

- **파일**: `app/(admin)/admin/students/divisions/_components/DivisionFilters.tsx`
  - 하드코딩된 구분 목록을 `getActiveStudentDivisionsAction()`으로 동적 로드
  - `useEffect`를 사용하여 컴포넌트 마운트 시 한 번만 로드

- **파일**: `app/(admin)/admin/students/divisions/_components/DivisionStudentList.tsx`
  - 드롭다운 옵션을 동적 로드

- **파일**: `app/(admin)/admin/students/divisions/_components/BulkDivisionUpdateModal.tsx`
  - 드롭다운 옵션을 동적 로드

- **파일**: `app/(admin)/admin/students/_components/StudentSearchFilter.tsx`
  - 드롭다운 옵션을 동적 로드

### 6. 사이드 메뉴 추가

#### 6.1 네비게이션 설정
- **파일**: `components/navigation/global/configs/adminCategories.tsx`
- **위치**: "학생 관리" 카테고리 하위, "학생 구분 관리" 다음
- **추가 항목**:
```typescript
{
  id: "admin-students-divisions-items",
  label: "구분 항목 관리",
  href: "/admin/students/divisions/items",
  icon: <Settings className="w-4 h-4" />,
}
```

#### 6.2 Breadcrumb 매핑
- **파일**: `components/navigation/global/resolveActiveCategory.ts`
- **추가**: `items: "구분 항목 관리"` (admin, consultant 역할 모두)

## 주요 특징

### 1. 재사용성
- `BaseMetadataManager` 컴포넌트를 재사용하여 일관된 UI 제공
- `contentMetadataActions.ts` 패턴을 재사용하여 일관된 에러 핸들링

### 2. 타입 안전성
- 모든 함수에 명시적 타입 정의
- `any` 타입 제거
- Null 체크 로직 통일

### 3. 에러 핸들링
- 삭제 시 사용 중인 항목 체크 (`checkDivisionInUse`)
- 중복 이름 체크 (PostgreSQL UNIQUE 제약조건 활용)
- 사용자 친화적 에러 메시지

### 4. 데이터 무결성
- 삭제 전 사용 여부 확인 필수
- 사용 중인 항목은 삭제 불가 에러 반환

## 데이터베이스 제약조건 고려사항

### students.division 필드 처리
- **선택한 옵션**: 옵션 3 - CHECK 제약조건 제거하고 애플리케이션 레벨에서만 검증
- **이유**: 
  - 외래키로 직접 참조하는 것은 복잡함 (name을 참조해야 함)
  - 트리거로 관리하는 것보다 애플리케이션 레벨 검증이 더 유연함
  - `student_divisions` 테이블의 활성 항목만 허용하도록 애플리케이션에서 검증

### 삭제 시 참조 무결성
- 구분 항목 삭제 전에 해당 구분을 사용하는 학생 수 확인
- 사용 중이면 삭제 불가 에러 반환
- 사용자에게 명확한 에러 메시지 제공 (예: "이 구분을 사용하는 학생이 5명 있습니다. 삭제할 수 없습니다.")

## 기존 데이터 호환성

- 초기 마이그레이션에서 기존 하드코딩된 값 삽입 (고등부, 중등부, 기타)
- 기존 `students.division` 필드 값은 그대로 유지
- 기존 코드와의 호환성을 위해 `StudentDivision` 타입은 유지하되, 값은 DB에서 동적으로 가져옴

## 성능 고려사항

- 구분 항목은 적은 수이므로 캐싱 고려 불필요
- 클라이언트 컴포넌트에서 `useEffect`를 사용하여 한 번만 로드
- 서버 액션은 관리자 권한 확인 후 실행

## 권한 관리

- 모든 CRUD 작업은 관리자만 접근 가능
- RLS 정책으로 데이터베이스 레벨에서도 보호
- Server Actions에서도 권한 확인

## 사용자 경험

- 삭제 시 사용 중인 항목은 경고 메시지 표시
- 로딩 상태 표시 (로딩 중...)
- 일관된 UI/UX (BaseMetadataManager 재사용)

## 참고 파일

- 마스터 데이터 관리 패턴: `app/(admin)/admin/content-metadata/_components/PlatformsManager.tsx`
- BaseMetadataManager: `app/(admin)/admin/content-metadata/_components/BaseMetadataManager.tsx`
- Server Actions 패턴: `app/(admin)/actions/contentMetadataActions.ts`
- 데이터 레이어 패턴: `lib/data/contentMetadata.ts` (Platform, Publisher CRUD)
- 네비게이션 설정: `components/navigation/global/configs/adminCategories.tsx`

## 향후 개선 사항

1. **캐싱**: 구분 항목이 자주 변경되지 않으므로, 필요시 React Query 캐싱 고려
2. **검증 강화**: 애플리케이션 레벨에서 `student_divisions` 테이블의 활성 항목만 허용하도록 검증 로직 추가
3. **배치 작업**: 여러 학생의 구분을 한 번에 변경하는 기능 개선

## 테스트 체크리스트

- [ ] 마이그레이션 검증 (테이블 생성, 초기 데이터 삽입)
- [ ] CRUD 기능 테스트 (생성, 조회, 수정, 삭제)
- [ ] 권한 확인 테스트 (관리자만 접근 가능)
- [ ] 삭제 시 사용 중인 항목 체크 테스트
- [ ] 기존 UI 컴포넌트 동적 로드 테스트
- [ ] 네비게이션 메뉴 표시 확인






