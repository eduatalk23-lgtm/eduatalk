# ìº í”„ ëª¨ë“œ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ë³€í™˜ ì¶”ê°€

## ğŸ“‹ ì‘ì—… ê°œìš”

ìº í”„ ëª¨ë“œì—ì„œ `student_plan`ì˜ `content_id`ê°€ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¸ ê²½ìš°, ì´ë¥¼ í•™ìƒ ì½˜í…ì¸  IDë¡œ ë³€í™˜í•˜ì—¬ episodesë¥¼ ì •ìƒì ìœ¼ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

## ğŸ” ë¬¸ì œ ìƒí™©

### ê·¼ë³¸ ì›ì¸

`student_plan` í…Œì´ë¸”ì˜ `content_id`ëŠ” í”Œëœ ìƒì„± ì‹œ ì €ì¥ëœ ê°’ì…ë‹ˆë‹¤. í”Œëœ ìƒì„± ì‹œ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDê°€ ê·¸ëŒ€ë¡œ ì €ì¥ë  ìˆ˜ ìˆëŠ”ë°, ìº í”„ ëª¨ë“œì—ì„œëŠ” ì´ë¥¼ ë³€í™˜í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ episodes ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

**ì¼ë°˜ ëª¨ë“œ**:
- `resolveContentIds`ë¥¼ í†µí•´ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ í•™ìƒ ì½˜í…ì¸  IDë¡œ ë³€í™˜
- ë³€í™˜ëœ í•™ìƒ ì½˜í…ì¸  IDë¥¼ ì‚¬ìš©í•˜ì—¬ episodes ì¡°íšŒ

**ìº í”„ ëª¨ë“œ (ìˆ˜ì • ì „)**:
- `student_plan`ì—ì„œ `content_id`ë¥¼ ì§ì ‘ ì½ì–´ì˜´
- ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¸ ê²½ìš° ë³€í™˜í•˜ì§€ ì•ŠìŒ
- `getStudentLectureEpisodesBatch`ì— ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¥¼ ì „ë‹¬
- `lectures` í…Œì´ë¸”ì—ì„œ í•´ë‹¹ IDë¡œ í•™ìƒ ê°•ì˜ë¥¼ ì°¾ì§€ ëª»í•¨

### ë¬¸ì œ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤

1. í”Œëœ ìƒì„± ì‹œ `student_plan.content_id`ì— ë§ˆìŠ¤í„° ì½˜í…ì¸  IDê°€ ì €ì¥ë¨
2. ìº í”„ ëª¨ë“œì—ì„œ `getCampDatePlans` í˜¸ì¶œ
3. `student_plan`ì—ì„œ `content_id`ë¥¼ ì½ì–´ì˜´ (ë§ˆìŠ¤í„° ì½˜í…ì¸  ID)
4. `getStudentLectureEpisodesBatch(studentLectureIds, studentId)` í˜¸ì¶œ
5. `lectures` í…Œì´ë¸”ì—ì„œ `id = content_id AND student_id = studentId`ë¡œ ì¡°íšŒ
6. ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì´ë¯€ë¡œ ì¡°íšŒ ì‹¤íŒ¨
7. Fallback ë¡œì§ì´ ì‘ë™í•˜ì§€ë§Œ, `lectures` í…Œì´ë¸”ì—ì„œ `master_lecture_id`ë¥¼ ì°¾ì„ ë•Œë„ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ

## âœ… í•´ê²° ë°©ë²•

### í•µì‹¬ ì•„ì´ë””ì–´

`student_plan`ì˜ `content_id`ê°€ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¸ ê²½ìš°, í•´ë‹¹ í•™ìƒì˜ í•™ìƒ ì½˜í…ì¸  IDë¡œ ë³€í™˜í•˜ì—¬ episodesë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

### ìˆ˜ì • ë‚´ìš©

#### íŒŒì¼: `lib/data/campLearning.ts`

**1. content_id ë³€í™˜ ë§µ ìƒì„±**

```typescript
// content_idê°€ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³€í™˜ ë§µ ìƒì„±
const contentIdMap = new Map<string, string>(); // originalContentId -> studentContentId
```

**2. ë§ˆìŠ¤í„° ì½˜í…ì¸  ID í™•ì¸ ë° ë³€í™˜**

```typescript
if (lectureIds.length > 0) {
  // 1ì°¨: student_planì˜ content_idë¡œ ì§ì ‘ ì¡°íšŒ (í•™ìƒ ì½˜í…ì¸  IDì¸ ê²½ìš°)
  const { data: lectures } = await supabase
    .from("lectures")
    .select("id, title, subject, master_content_id, master_lecture_id")
    .in("id", lectureIds);
  
  // ì¡°íšŒëœ í•™ìƒ ê°•ì˜ë“¤ ë§¤í•‘
  lectures?.forEach((lecture) => {
    contentIdMap.set(lecture.id, lecture.id); // ìê¸° ìì‹ ìœ¼ë¡œ ë§¤í•‘
  });
  
  // 2ì°¨: ì¡°íšŒë˜ì§€ ì•Šì€ content_idë“¤ì€ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìŒ
  const notFoundLectureIds = lectureIds.filter((id) => !foundLectureIds.has(id));
  
  if (notFoundLectureIds.length > 0) {
    // ë§ˆìŠ¤í„° ê°•ì˜ì¸ì§€ í™•ì¸
    const { data: masterLectures } = await supabase
      .from("master_lectures")
      .select("id, title, subject")
      .in("id", notFoundLectureIds);
    
    if (masterLectures && masterLectures.length > 0) {
      // ê° í•™ìƒë³„ë¡œ ë§ˆìŠ¤í„° ê°•ì˜ IDì— í•´ë‹¹í•˜ëŠ” í•™ìƒ ê°•ì˜ ì°¾ê¸°
      for (const [studentId, studentLectureIds] of studentLectureMap.entries()) {
        const masterIdsInStudent = studentLectureIds.filter((id) =>
          notFoundLectureIds.includes(id)
        );
        
        if (masterIdsInStudent.length > 0) {
          // í•´ë‹¹ í•™ìƒì˜ ê°•ì˜ ì¤‘ master_content_id ë˜ëŠ” master_lecture_idê°€ ì¼ì¹˜í•˜ëŠ” ê²ƒ ì°¾ê¸°
          const { data: studentLecturesByMaster } = await supabase
            .from("lectures")
            .select("id, master_content_id, master_lecture_id")
            .eq("student_id", studentId)
            .or(
              `master_content_id.in.(${masterIdsInStudent.join(",")}),master_lecture_id.in.(${masterIdsInStudent.join(",")})`
            );
          
          // ë§ˆìŠ¤í„° ID -> í•™ìƒ ID ë§¤í•‘ ìƒì„±
          studentLecturesByMaster?.forEach((studentLecture) => {
            const masterId =
              studentLecture.master_content_id || studentLecture.master_lecture_id;
            if (masterId && masterIdsInStudent.includes(masterId)) {
              contentIdMap.set(masterId, studentLecture.id);
            }
          });
        }
      }
    }
  }
}
```

**3. ë³€í™˜ëœ IDë¡œ episodes ì¡°íšŒ**

```typescript
for (const [studentId, studentLectureIds] of studentLectureMap.entries()) {
  if (studentLectureIds.length > 0) {
    // content_idê°€ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¸ ê²½ìš° í•™ìƒ ì½˜í…ì¸  IDë¡œ ë³€í™˜
    const resolvedLectureIds = studentLectureIds.map(
      (id) => contentIdMap.get(id) || id
    );
    const episodes = await getStudentLectureEpisodesBatch(resolvedLectureIds, studentId);
    
    // ì›ë³¸ content_idë¡œ ë§¤í•‘í•˜ì—¬ ì €ì¥ (formatLectureRangeì—ì„œ ì›ë³¸ content_id ì‚¬ìš©)
    const episodesWithOriginalId = new Map<string, Array<{...}>>();
    
    studentLectureIds.forEach((originalId, index) => {
      const resolvedId = resolvedLectureIds[index];
      const episodesForResolvedId = episodes.get(resolvedId) || [];
      episodesWithOriginalId.set(originalId, episodesForResolvedId);
    });
    
    lectureEpisodesMap.set(studentId, episodesWithOriginalId);
  }
}
```

## ğŸ”„ ë™ì‘ íë¦„

```
1. student_planì—ì„œ content_id ì½ê¸°
   â†“
2. lectures í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì¡°íšŒ (í•™ìƒ ì½˜í…ì¸  IDì¸ ê²½ìš°)
   â†“
3. ì¡°íšŒë˜ì§€ ì•Šì€ content_idëŠ” ë§ˆìŠ¤í„° ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìŒ
   â†“
4. master_lectures í…Œì´ë¸”ì—ì„œ í™•ì¸
   â†“
5. ê° í•™ìƒë³„ë¡œ master_content_id ë˜ëŠ” master_lecture_idë¡œ í•™ìƒ ê°•ì˜ ì°¾ê¸°
   â†“
6. contentIdMapì— ë§ˆìŠ¤í„° ID -> í•™ìƒ ID ë§¤í•‘ ì €ì¥
   â†“
7. ë³€í™˜ëœ í•™ìƒ ì½˜í…ì¸  IDë¡œ episodes ì¡°íšŒ
   â†“
8. ì›ë³¸ content_idë¡œ ë§¤í•‘í•˜ì—¬ ì €ì¥
```

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

1. **ì •ìƒì ì¸ Episodes ì¡°íšŒ**: ë§ˆìŠ¤í„° ì½˜í…ì¸  IDê°€ ì €ì¥ëœ ê²½ìš°ì—ë„ ì •ìƒì ìœ¼ë¡œ episodes ì¡°íšŒ ê°€ëŠ¥
2. **ì¼ë°˜ ëª¨ë“œì™€ ì¼ê´€ì„±**: ì¼ë°˜ ëª¨ë“œì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ content_id ë³€í™˜
3. **Fallback ë¡œì§ ë³´ì™„**: `getStudentLectureEpisodesBatch`ì˜ fallback ë¡œì§ê³¼ í•¨ê»˜ ì‘ë™í•˜ì—¬ ë” ì•ˆì •ì ì¸ ì¡°íšŒ

## ğŸ”— ê´€ë ¨ ì½”ë“œ

- `lib/data/campLearning.ts`: `getCampDatePlans` í•¨ìˆ˜
- `lib/plan/contentResolver.ts`: `resolveContentIds` í•¨ìˆ˜ (ì¼ë°˜ ëª¨ë“œ ì°¸ê³ )
- `lib/data/contentMasters.ts`: `getStudentLectureEpisodesBatch` í•¨ìˆ˜ (fallback ë¡œì§)

## ğŸ“… ì‘ì—… ì¼ì‹œ

2025-12-22 13:38:56




