# Supabase 이메일 인증 오류 처리 개선

## 작업 일자
2025년 1월

## 작업 목표
Supabase 이메일 인증 링크 클릭 시 발생하는 오류의 원인을 파악하고, 사용자에게 명확한 안내를 제공하며, 개발자가 디버깅할 수 있도록 상세한 로깅을 추가합니다.

## 문제 상황
이메일 인증 링크를 클릭하면 "인증에 실패했습니다."라는 일반적인 메시지만 표시되어 실제 원인을 파악하기 어려웠습니다.

### 기존 문제점
1. 에러 상세 정보가 로깅되지 않음
2. 에러 종류별 구분 없이 모두 동일한 메시지 표시
3. 코드가 없는 경우와 `exchangeCodeForSession` 실패를 동일하게 처리
4. 예외 상황에 대한 처리 부재

## 구현 내용

### 1. 인증 에러 메시지 매핑 유틸리티 생성
**파일**: `lib/auth/authErrorMessages.ts` (신규)

- `getAuthErrorMessage` 함수 구현
- Supabase 인증 에러를 사용자 친화적인 한국어 메시지로 변환
- 에러 유형별 메시지 분기:
  - 만료된 코드: "인증 링크가 만료되었습니다. 새로운 인증 링크를 요청해주세요."
  - 이미 사용된 코드: "이미 사용된 인증 링크입니다."
  - 유효하지 않은 코드: "유효하지 않은 인증 링크입니다."
  - 네트워크/연결 오류: "연결에 실패했습니다. 잠시 후 다시 시도해주세요."
  - Rate limit 오류: "요청이 너무 많습니다. 잠시 후 다시 시도해주세요."
  - 권한 오류: "인증 권한이 없습니다."
  - 서버 오류: "서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."

### 2. 인증 콜백 라우트 개선
**파일**: `app/auth/callback/route.ts`

#### 2.1 코드 검증 추가
- `code` 파라미터가 없는 경우 별도 처리
- 상세한 로깅 및 명확한 에러 메시지

#### 2.2 에러 로깅 강화
- `lib/errors/handler.ts`의 `logError` 함수 활용
- Supabase 에러의 상세 정보 포함 (message, status, code, name)
- 요청 URL, 검색 파라미터 등 컨텍스트 정보 포함
- 민감 정보는 자동 필터링

#### 2.3 에러 종류별 메시지 분기
- `getAuthErrorMessage` 함수를 사용하여 에러 유형별 메시지 제공
- 사용자에게 명확한 안내 제공

#### 2.4 예외 처리 추가
- `try-catch` 블록으로 예상치 못한 에러 처리
- 에러 발생 시에도 안전하게 로그인 페이지로 리다이렉트
- 예상치 못한 상황 (에러도 없고 세션도 없는 경우) 처리

## 수정된 파일 목록

1. `lib/auth/authErrorMessages.ts` (신규)
   - `getAuthErrorMessage` 함수: Supabase 인증 에러를 사용자 친화적 메시지로 변환
   - `isNoCodeError` 함수: 코드 없음 에러 확인 (향후 확장용)

2. `app/auth/callback/route.ts` (수정)
   - 코드 검증 로직 추가
   - 구조화된 에러 로깅 적용
   - 에러 종류별 메시지 분기
   - 예외 처리 추가

## 에러 처리 플로우

```
이메일 인증 링크 클릭
  ↓
코드 파라미터 존재 확인
  ├─ 없음 → 코드 없음 에러 로깅 → 로그인 페이지로 리다이렉트
  └─ 있음 → exchangeCodeForSession 호출
      ├─ 성공 → 적절한 페이지로 리다이렉트
      └─ 실패 → 에러 상세 정보 로깅
          → 에러 종류 분석
          → 사용자 친화적 메시지 생성
          → 로그인 페이지로 리다이렉트
```

## 개선 효과

### 1. 디버깅 효율성 향상
- 상세한 로깅으로 문제 원인 파악 용이
- 구조화된 에러 정보로 빠른 문제 해결

### 2. 사용자 경험 개선
- 명확한 에러 메시지로 재시도 방법 안내
- 에러 유형별 적절한 안내 메시지 제공

### 3. 운영 안정성 향상
- 예외 상황 처리로 서비스 중단 방지
- 모든 에러 케이스에 대한 안전한 처리

### 4. 유지보수성 향상
- 구조화된 에러 처리로 코드 가독성 향상
- 재사용 가능한 에러 메시지 매핑 유틸리티

## 테스트 시나리오

1. **정상 케이스**: 유효한 인증 코드로 인증 성공
2. **코드 없음**: URL에 `code` 파라미터가 없는 경우
3. **만료된 코드**: 시간이 지나 만료된 인증 코드
4. **중복 사용**: 이미 사용된 인증 코드 재사용
5. **유효하지 않은 코드**: 잘못된 형식의 인증 코드
6. **네트워크 오류**: Supabase 연결 실패
7. **예외 상황**: 예상치 못한 에러 발생

## 참고 사항

- 기존 에러 처리 패턴 (`app/actions/auth.ts`의 `_signIn` 함수) 참고
- `lib/errors/handler.ts`의 `logError` 함수 활용
- Supabase 인증 에러 코드 및 메시지 패턴 문서 참조
- 프로덕션 환경에서 민감 정보 로깅 주의 (자동 필터링 적용)

## 관련 문서

- [Supabase Email Auth 문서](https://supabase.com/docs/guides/auth/auth-email)
- [Supabase Auth Errors 문서](https://supabase.com/docs/reference/javascript/auth-error)
- 기존 수정 문서: `docs/supabase-email-redirect-fix.md`

