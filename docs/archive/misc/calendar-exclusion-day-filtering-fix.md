# 캘린더 제외일 타임슬롯 필터링 수정

## 작업 일시
2024년 12월 15일

## 문제점

### 발견된 문제
제외일이 있는 날짜에도 점심시간, 이동시간, 자율학습 등 학습 관련 타임슬롯이 그대로 표시되는 문제가 있었습니다.

### 원인 분석
`buildTimelineSlots` 함수에서:
- `exclusions` 파라미터를 받지만 실제로 사용하지 않음
- `daily_schedule`의 `time_slots`가 있으면 모든 타임슬롯을 그대로 생성
- 제외일 체크 로직이 없어서 제외일에도 모든 타임슬롯이 표시됨

## 수정 사항

### 1. 제외일 체크 로직 추가 ✅

```typescript
// 해당 날짜의 제외일 확인
const dayExclusions = exclusions.filter((exclusion) => exclusion.exclusion_date === dateStr);
const isExclusionDay = dayExclusions.length > 0;
```

### 2. 학습 관련 타임슬롯 필터링 ✅

제외일이 있는 날짜에는 다음 타임슬롯을 필터링:
- 점심시간
- 이동시간
- 자율학습
- 학습시간

```typescript
// 제외일인 경우 학습 관련 타임슬롯 필터링
// 학원일정은 제외일에도 표시 가능 (학원 수업은 별도)
if (isExclusionDay && slot.type !== "학원일정" && slot.type !== "학습시간") {
  // 점심시간, 이동시간, 자율학습 등은 제외일에는 표시하지 않음
  return;
}
```

### 3. 학습시간 슬롯 필터링 ✅

제외일이 있는 날짜에는 학습시간 슬롯도 표시하지 않음:

```typescript
// 학습시간인 경우 플랜 매칭
if (slot.type === "학습시간") {
  // 제외일인 경우 학습시간 슬롯은 표시하지 않음
  if (isExclusionDay) {
    return;
  }
  // ... 플랜 매칭 로직
}
```

### 4. 플랜 슬롯 생성 필터링 ✅

제외일이 아닌 경우에만 플랜 슬롯 생성:

```typescript
// 시간 정보가 있는 플랜 중 타임슬롯에 매칭되지 않은 플랜을 별도 슬롯으로 추가
// 제외일이 아닌 경우에만 추가
if (!isExclusionDay) {
  // ... 플랜 슬롯 생성 로직
}
```

### 5. time_slots가 없는 경우 필터링 ✅

`time_slots`가 없을 때도 제외일 체크:

```typescript
// time_slots가 없으면 플랜의 시간 정보로 타임라인 생성
// 제외일이 아닌 경우에만 플랜 표시
if (!isExclusionDay) {
  // ... 플랜 타임라인 생성 로직
}
```

## 필터링 규칙

### 제외일이 있는 날짜에 표시되는 항목
- ✅ 학원일정 (학원 수업은 별도 일정이므로 표시)
- ✅ 제외일 배지 및 정보

### 제외일이 있는 날짜에 표시되지 않는 항목
- ❌ 점심시간
- ❌ 이동시간
- ❌ 자율학습
- ❌ 학습시간
- ❌ 플랜 (학습 관련 플랜)

## 개선 효과

1. **명확한 제외일 표시**: 제외일에는 학습 관련 내용이 표시되지 않음
2. **일관성**: 제외일의 의미에 맞게 학습 관련 타임슬롯 필터링
3. **사용자 경험**: 제외일임을 명확히 인지 가능

## 변경된 파일

1. `app/(student)/plan/calendar/_utils/timelineUtils.ts`
   - 제외일 체크 로직 추가
   - 학습 관련 타임슬롯 필터링
   - 학습시간 슬롯 필터링
   - 플랜 슬롯 생성 필터링

## 기술적 세부사항

### 제외일 판단 로직
```typescript
const dayExclusions = exclusions.filter(
  (exclusion) => exclusion.exclusion_date === dateStr
);
const isExclusionDay = dayExclusions.length > 0;
```

### 타임슬롯 필터링 순서
1. 제외일 체크
2. 타임슬롯 타입 확인
3. 학습 관련 타임슬롯 필터링 (학원일정 제외)
4. 학습시간 슬롯 필터링
5. 플랜 슬롯 생성 필터링

## 테스트 시나리오

### 시나리오 1: 제외일이 있는 날짜
- 입력: 제외일이 있는 날짜
- 예상 결과: 점심시간, 이동시간, 자율학습, 학습시간 슬롯이 표시되지 않음
- 학원일정은 표시됨

### 시나리오 2: 제외일이 없는 날짜
- 입력: 제외일이 없는 날짜
- 예상 결과: 모든 타임슬롯이 정상적으로 표시됨

### 시나리오 3: 제외일이 있고 학원일정이 있는 날짜
- 입력: 제외일이 있고 학원일정이 있는 날짜
- 예상 결과: 학원일정만 표시되고 학습 관련 슬롯은 표시되지 않음

