# 재조정 기능 기능별 시나리오

**작성일**: 2025-12-10  
**목적**: 재조정 기능의 전체 흐름과 각 기능별 시나리오 문서화

---

## 목차

1. [재조정 기능 개요](#재조정-기능-개요)
2. [Step 1: 콘텐츠 선택 시나리오](#step-1-콘텐츠-선택-시나리오)
3. [Step 2: 상세 조정 시나리오](#step-2-상세-조정-시나리오)
4. [Step 3: 미리보기 & 확인 시나리오](#step-3-미리보기--확인-시나리오)
5. [재조정 로직 핵심 시나리오](#재조정-로직-핵심-시나리오)
6. [에지 케이스 시나리오](#에지-케이스-시나리오)

---

## 재조정 기능 개요

### 기본 개념

재조정 기능은 기존에 생성된 플랜을 수정하여 새로운 플랜을 생성하는 기능입니다. 특히 **오늘 날짜 이후의 남은 기간**에 맞춰 미진행한 학습 범위를 재분배합니다.

### 핵심 원칙

1. **오늘 날짜 기준 분리**: 오늘 이전의 미진행 플랜 범위를 오늘 이후 기간에 재분배
2. **일일 학습량 자동 조정**: 남은 학습 기간이 줄어들면 일일 학습량이 자동으로 증가
3. **완료된 플랜 보존**: 완료된 플랜은 변경하지 않고 유지
4. **범위 보존**: 전체 학습 범위는 유지하되, 일일 배정량만 조정

### 예시 시나리오 (의도 확인)

**상황**:

- 플랜 그룹 기간: 2024-12-08 ~ 2024-12-30 (23일)
- 총 학습량: 30페이지
- 원래 일일 배정: 1페이지/일 (30페이지 ÷ 23일 ≈ 1.3페이지/일)
- 현재 날짜: 2024-12-23 (15일 경과)
- 진행 상황: 한 번도 학습하지 않음 (0페이지)

**재조정 결과**:

- 남은 기간: 2024-12-24 ~ 2024-12-30 (7일)
- 남은 학습량: 30페이지 (미진행)
- 새 일일 배정: 4.3페이지/일 (30페이지 ÷ 7일)
- **일일 학습량이 자동으로 증가**

---

## Step 1: 콘텐츠 선택 시나리오

### 시나리오 1-1: 전체 재조정 (Full Reschedule)

**목적**: 플랜 그룹의 모든 재조정 가능한 콘텐츠를 재조정

**사용자 행동**:

1. 재조정 페이지 진입
2. "전체 재조정" 모드 선택 (기본값)
3. 재조정할 콘텐츠 체크박스 선택 (복수 선택 가능)
4. "다음" 버튼 클릭

**시스템 동작**:

- 재조정 가능한 콘텐츠만 표시 (완료된 플랜 제외)
- 콘텐츠별 상태 표시:
  - **available**: 모든 플랜이 재조정 가능
  - **partial**: 일부 플랜만 재조정 가능
  - **unavailable**: 재조정 불가 (완료됨 또는 플랜 없음)
- 선택된 콘텐츠 ID와 `dateRange: null`을 Step 2로 전달

**데이터 전달**:script
{
selectedContentIds: Set<string>,
dateRange: null
}---

### 시나리오 1-2: 날짜 범위 재조정 (Range Reschedule)

**목적**: 특정 날짜 범위의 플랜만 재조정

**사용자 행동**:

1. 재조정 페이지 진입
2. "날짜 범위 선택" 모드 선택
3. 시작일/종료일 선택 (또는 스마트 제안 사용)
4. 재조정할 콘텐츠 선택
5. "다음" 버튼 클릭

**시스템 동작**:

- 날짜 범위 선택 UI 표시
- 스마트 제안 기능 제공:
  - 미진행 플랜이 많은 날짜 범위 제안
  - 특정 콘텐츠의 영향받는 날짜 범위 제안
- 선택된 날짜 범위 검증
- 선택된 콘텐츠 ID와 날짜 범위를 Step 2로 전달

**데이터 전달**:ript
{
selectedContentIds: Set<string>,
dateRange: { from: "2024-12-24", to: "2024-12-30" }
}---

### 시나리오 1-3: 콘텐츠 선택 검증

**시나리오 1-3-1: 콘텐츠 미선택**

- **사용자 행동**: 콘텐츠를 선택하지 않고 "다음" 클릭
- **시스템 동작**: "최소 1개 이상의 콘텐츠를 선택해주세요." 알림 표시
- **결과**: Step 2로 진행하지 않음

**시나리오 1-3-2: 날짜 범위 미선택 (Range 모드)**

- **사용자 행동**: Range 모드인데 날짜 범위를 선택하지 않고 "다음" 클릭
- **시스템 동작**: "날짜 범위를 선택해주세요." 알림 표시
- **결과**: Step 2로 진행하지 않음

**시나리오 1-3-3: 재조정 불가 콘텐츠 선택 시도**

- **사용자 행동**: 완료된 플랜만 있는 콘텐츠 체크박스 클릭 시도
- **시스템 동작**: 체크박스가 비활성화되어 선택 불가
- **표시**: "모든 플랜이 완료되어 재조정할 수 없습니다" 안내

---

## Step 2: 상세 조정 시나리오

### 시나리오 2-1: 범위 조정 (Range Adjustment)

**목적**: 선택된 콘텐츠의 학습 범위만 수정

**사용자 행동**:

1. Step 2 진입 (Step 1에서 콘텐츠 선택 완료)
2. 콘텐츠별 "시작 범위" 또는 "끝 범위" 입력 필드 수정
3. "다음" 버튼 클릭

**시스템 동작**:

- 선택된 콘텐츠 목록 표시
- 각 콘텐츠별 현재 범위 표시 (start_range ~ end_range)
- 범위 수정 시 실시간 검증:
  - 시작 범위 ≤ 끝 범위 검증
  - 범위가 원래 범위를 벗어나는지 검증 (선택 사항)
- 조정된 범위를 `AdjustmentInput` 배열로 생성

**생성되는 AdjustmentInput**:
{
plan_content_id: string,
change_type: "range",
before: {
content_id: string,
content_type: "book",
range: { start: 1, end: 100 }
},
after: {
content_id: string,
content_type: "book",
range: { start: 1, end: 120 } // 범위 확장
}
}---

### 시나리오 2-2: 콘텐츠 교체 (Content Replacement)

**목적**: 기존 콘텐츠를 다른 콘텐츠로 교체

**사용자 행동**:

1. 콘텐츠 카드에서 "교체" 버튼 클릭
2. 교체할 콘텐츠 검색 및 선택
3. 새로운 콘텐츠의 시작/끝 범위 입력
4. "교체" 버튼 클릭

**시스템 동작**:

- 콘텐츠 검색 모달 표시
- 교체 가능한 콘텐츠 목록 표시 (같은 content_type)
- 범위 검증 및 저장
- 원본 콘텐츠는 `before`, 교체 콘텐츠는 `after`에 저장

**생성되는 AdjustmentInput**:ypescript
{
plan_content_id: string,
change_type: "replace",
before: {
content_id: "book-001",
content_type: "book",
range: { start: 1, end: 100 }
},
after: {
content_id: "book-002", // 다른 책으로 교체
content_type: "book",
range: { start: 1, end: 150 }
}
}---

### 시나리오 2-3: 전체 재생성 (Full Regeneration)

**목적**: 콘텐츠를 완전히 새로운 설정으로 재생성

**사용자 행동**:

1. 콘텐츠 카드에서 "전체 재생성" 버튼 클릭
2. 새로운 콘텐츠 선택 및 범위 설정
3. "재생성" 버튼 클릭

**시스템 동작**:

- 교체와 유사하지만 더 강력한 재생성으로 처리
- 기존 플랜과의 연결을 완전히 끊음

**생성되는 AdjustmentInput**:t
{
plan_content_id: string,
change_type: "full",
before: { /_ 원본 콘텐츠 정보 _/ },
after: { /_ 새로운 콘텐츠 정보 _/ }
}---

### 시나리오 2-4: 일괄 조정 (Batch Adjustment)

**목적**: 여러 콘텐츠를 한 번에 조정

**사용자 행동**:

1. 여러 콘텐츠 선택 (2개 이상)
2. "일괄 조정 모드" 활성화
3. 일괄 조정 패널에서 조정 옵션 선택:
   - 모든 콘텐츠에 +10페이지 추가
   - 모든 콘텐츠 범위를 10% 증가
   - 모든 콘텐츠 시작 범위를 +5페이지
4. "적용" 버튼 클릭

**시스템 동작**:

- 선택된 모든 콘텐츠에 동일한 조정 적용
- 각 콘텐츠별로 `AdjustmentInput` 생성
- 일괄 조정 후 개별 조정도 가능

---

### 시나리오 2-5: 조정 없이 진행

**목적**: 콘텐츠만 선택하고 범위는 그대로 유지 (미진행 범위 재분배만)

**사용자 행동**:

1. Step 2 진입
2. 아무 조정도 하지 않음
3. "다음" 버튼 클릭

**시스템 동작**:

- `adjustments` 배열이 비어있음 (`[]`)
- Step 3에서 미진행 범위만 재분배
- 기본 adjustments 자동 생성 (선택 사항)

---

## Step 3: 미리보기 & 확인 시나리오

### 시나리오 3-1: 미리보기 자동 로드

**목적**: Step 3 진입 시 재조정 결과를 자동으로 미리보기

**시스템 동작**:

1. Step 3 진입 (`adjustments` 또는 `dateRange` 존재)
2. `getReschedulePreview` 서버 액션 호출
3. 재조정 결과 계산:
   - 기존 플랜 조회 (재조정 대상만)
   - **미진행 범위 계산** (오늘 이전 플랜만)
   - 조정된 콘텐츠 생성
   - **남은 기간 계산** (오늘 이후만)
   - 새 플랜 생성
4. 미리보기 결과 표시

**미리보기 결과 구조**:
{
plans_before_count: number, // 기존 플랜 수
plans_after_count: number, // 새 플랜 수
affected_dates: string[], // 영향받는 날짜 목록
estimated_hours: number, // 예상 총 학습 시간
adjustments_summary: {
range_changes: number,
replacements: number,
full_regenerations: number
},
plans_before: Array<...>, // 기존 플랜 상세 정보
plans_after: Array<...> // 새 플랜 상세 정보
}---

### 시나리오 3-2: 변경 사항 확인

**사용자 행동**:

1. 미리보기 결과 확인
2. 변경 전/후 비교 뷰 확인
3. 영향받는 날짜 목록 확인
4. 조정 내역 요약 확인

**시스템 표시 내용**:

- **변경 요약 카드**: 기존 플랜 수, 새 플랜 수, 영향받는 날짜, 예상 시간
- **변경 전/후 비교**: 날짜별 플랜 비교 테이블
- **영향받는 플랜 목록**: 재조정되는 플랜들의 상세 정보
- **조정 내역**: 범위 수정, 교체, 전체 재생성 개수
- **충돌 경고**: 시간대 충돌이 있는 경우 경고 표시

---

### 시나리오 3-3: 재조정 실행

**사용자 행동**:

1. 미리보기 결과 확인 후 "재조정 실행" 버튼 클릭
2. 확인 다이얼로그에서 변경 사항 재확인
3. "실행" 버튼 클릭

**시스템 동작**:

1. `rescheduleContents` 서버 액션 호출
2. 트랜잭션 시작
3. 기존 플랜 히스토리 백업 (`plan_history` 테이블)
4. 기존 플랜 비활성화 (`is_active = false`)
5. 새 플랜 생성 및 저장
6. 재조정 로그 저장 (`reschedule_log` 테이블)
7. 트랜잭션 커밋
8. 성공 메시지 표시 및 플랜 그룹 상세 페이지로 리다이렉트

---

### 시나리오 3-4: 미리보기 실패 처리

**시나리오 3-4-1: 로딩 실패**

- **사용자 행동**: Step 3 진입 시도
- **시스템 동작**: 에러 발생
- **표시**: 에러 메시지 + "다시 시도" 버튼
- **처리**: 사용자가 "다시 시도" 클릭 시 `loadPreview` 재호출

**시나리오 3-4-2: 조건 불만족 (adjustments와 dateRange 모두 없음)**

- **사용자 행동**: Step 2에서 조정하지 않고 Step 3 진입
- **시스템 동작**: 미리보기 로드하지 않음
- **표시**: "조정 사항이 없거나 날짜 범위가 선택되지 않았습니다." 안내 메시지

---

## 재조정 로직 핵심 시나리오

### 시나리오 4-1: 미진행 범위 계산 및 재분배 (핵심)

**목적**: 오늘 이전 날짜의 미진행 플랜 범위를 오늘 이후 기간에 재분배

**시나리오 설정**:

- 플랜 그룹 기간: 2024-12-08 ~ 2024-12-30
- 총 학습량: 30페이지 (1페이지 ~ 30페이지)
- 원래 일일 배정: 1.3페이지/일
- **오늘 날짜: 2024-12-23**
- 진행 상황: 12월 8일 ~ 12월 22일 플랜 모두 미진행 (15일치)

**시스템 동작**:

1. **기존 플랜 조회** (오늘 이전만)
   SELECT id, plan_date, content_id, planned_start_page_or_time,
   planned_end_page_or_time, completed_amount, status, is_active
   FROM student_plan
   WHERE plan_group_id = ?
   AND student_id = ?
   AND plan_date < '2024-12-23' -- 오늘 이전만
   AND status IN ('pending', 'in_progress')
   AND is_active = true 2. **미진행 범위 계산**script
   // 각 플랜별 미진행 범위 계산
   uncompleted = (planned_end - planned_start) - (completed_amount || 0)

   // 예: 12월 8일 플랜
   // planned_start: 1, planned_end: 2
   // completed_amount: 0
   // uncompleted: (2 - 1) - 0 = 1페이지

   // 콘텐츠별로 합산
   // 총 미진행 범위: 15페이지 (15일 × 1페이지)

2. **재조정 기간 결정**escript
   const today = "2024-12-23";
   const adjustedPeriodStart = dateRange?.from || getNextStudyDate(today);  
    // 2024-12-24 (오늘 이후 첫 학습일)
   const adjustedPeriodEnd = dateRange?.to || group.period_end;  
    // 2024-12-30 4. **콘텐츠 범위 조정**
   // 미진행 범위를 콘텐츠 범위에 추가
   originalRange: 1 ~ 30 (30페이지)
   uncompletedRange: 15페이지
   adjustedRange: 1 ~ 45 (30 + 15 = 45페이지) 5. **스케줄 계산 (남은 기간만)**ypescript
   calculateAvailableDates(
   "2024-12-24", // 오늘 이후 시작
   "2024-12-30", // 원래 종료일
   // ... 기타 설정
   )
   // 결과: 7일의 학습일 계산 6. **새 플랜 생성**
   ipt
   // 45페이지 ÷ 7일 = 6.4페이지/일
   // 일일 학습량이 자동으로 증가
   **최종 결과**:

- 남은 기간: 2024-12-24 ~ 2024-12-30 (7일)
- 총 학습량: 45페이지 (원래 30페이지 + 미진행 15페이지)
- 새 일일 배정: 6.4페이지/일 (원래 1.3페이지/일에서 증가)
- **변화 감지**: 일일 학습량이 크게 증가했으므로 "변화 있음"으로 표시

---

### 시나리오 4-2: 부분 진행된 플랜 처리

**시나리오 설정**:

- 12월 8일 플랜: 1페이지 ~ 2페이지 (2페이지 배정)
- 진행 상황: 1.5페이지 완료 (`completed_amount = 1.5`)
- 12월 9일 플랜: 2페이지 ~ 3페이지 (1페이지 배정)
- 진행 상황: 미진행 (`completed_amount = 0`)

**시스템 동작**:

1. **미진행 범위 계산**ript
   // 12월 8일 플랜
   totalRange = 2 - 1 = 1페이지
   completed = 1.5페이지
   uncompleted = max(0, 1 - 1.5) = 0페이지 (이미 초과 완료, 음수 방지)

   // 12월 9일 플랜
   totalRange = 3 - 2 = 1페이지
   completed = 0페이지
   uncompleted = 1페이지

   // 총 미진행: 1페이지 (12월 9일만) 2. **재분배**

   - 미진행 1페이지를 남은 기간에 재분배
   - 초과 완료된 범위는 무시 (음수 처리 방지)

---

### 시나리오 4-3: 날짜 범위 지정 재조정

**시나리오 설정**:

- 플랜 그룹 기간: 2024-12-08 ~ 2024-12-30
- 오늘 날짜: 2024-12-23
- 사용자 선택: 2024-12-20 ~ 2024-12-25 범위만 재조정

**시스템 동작**:

1. **재조정 대상 플랜 필터링**ript
   // 날짜 범위와 오늘 이전 조건 모두 적용
   query = query
   .gte("plan_date", "2024-12-20")
   .lte("plan_date", "2024-12-25")
   .lt("plan_date", "2024-12-23") // 오늘 이전만
   // 결과: 2024-12-20, 2024-12-21, 2024-12-22 플랜만 조회 2. **재조정 기간 결정**

   // 사용자가 선택한 범위와 오늘 이후 조건 결합
   adjustedPeriodStart = max("2024-12-20", "2024-12-23") = "2024-12-23"
   adjustedPeriodEnd = "2024-12-25" 3. **플랜 생성 시 날짜 필터링**ript
   // 생성된 플랜 중 선택한 날짜 범위만 유지
   filteredPlans = generatedPlans.filter(
   plan => plan.plan_date >= "2024-12-20"
   && plan.plan_date <= "2024-12-25"
   )

   ***

### 시나리오 4-4: 조정(adjustments)과 미진행 범위 재분배 동시 적용

**시나리오 설정**:

- 콘텐츠 A: 원래 범위 1~100페이지
- 사용자 조정: 1~120페이지로 확장
- 미진행 범위: 15페이지 (오늘 이전)

**시스템 동작**:

1. **조정 적용**

   adjustedContents = applyAdjustments(contents, adjustments)
   // 콘텐츠 A: 1~120페이지 (사용자 조정 적용)

2. **미진행 범위 추가**ript
   // 미진행 범위는 조정된 범위에 추가
   uncompleted = 15페이지
   finalRange = 120 + 15 = 135페이지
   // 최종: 1~135페이지 3. **순서 중요**: 조정 먼저, 미진행 범위 추가는 나중

---

## 에지 케이스 시나리오

### 시나리오 5-1: 오늘 날짜에 플랜이 있는 경우

**시나리오 설정**:

- 오늘 날짜: 2024-12-23
- 12월 23일에도 플랜이 있음

**질문**: 오늘 날짜의 플랜도 재조정 대상에 포함해야 하나?

**시나리오 A: 오늘 날짜 제외 (권장)**

- 오늘 플랜은 아직 진행 가능하므로 유지
- 재조정 시작: 2024-12-24부터
- 로직: `plan_date < today` (미만)

**시나리오 B: 오늘 날짜 포함**

- 오늘 플랜도 재조정 가능
- 재조정 시작: 2024-12-23부터
- 로직: `plan_date <= today` (이하)

**권장**: 시나리오 A (오늘 날짜 제외)

- 오늘 학습할 수 있는 기회를 보장
- 사용자가 이미 오늘 플랜을 시작했을 수 있음

---

### 시나리오 5-2: 모든 플랜이 완료된 경우

**시나리오 설정**:

- 모든 플랜이 `status = 'completed'`

**시스템 동작**:

- Step 1에서 재조정 가능한 콘텐츠가 0개
- "재조정 가능한 콘텐츠가 없습니다." 메시지 표시
- 재조정 진행 불가

---

### 시나리오 5-3: 남은 기간이 없는 경우

**시나리오 설정**:

- 플랜 그룹 기간: 2024-12-08 ~ 2024-12-23
- 오늘 날짜: 2024-12-23
- 재조정 시도

**시스템 동작**:

- 남은 기간: 없음 (오늘 이후 학습일 없음)
- 에러 처리: "재조정할 기간이 남아있지 않습니다." 메시지
- 재조정 진행 불가

---

### 시나리오 5-4: 날짜 범위가 오늘 이전인 경우

**시나리오 설정**:

- 오늘 날짜: 2024-12-23
- 사용자 선택: 2024-12-20 ~ 2024-12-22

**시스템 동작**:

- 선택한 범위가 모두 오늘 이전
- 오늘 이후 재조정 기간: 없음
- 에러 처리: "선택한 날짜 범위에 오늘 이후 기간이 포함되지 않았습니다."
- 또는: 자동으로 오늘 이후 첫 학습일로 조정

---

### 시나리오 5-5: 미진행 범위가 매우 큰 경우

**시나리오 설정**:

- 총 학습량: 100페이지
- 미진행: 80페이지
- 남은 기간: 5일
- 일일 배정: 80페이지 ÷ 5일 = 16페이지/일

**시스템 동작**:

- 일일 학습량이 비현실적으로 큼
- 경고 표시: "일일 학습량이 매우 큽니다. 범위 조정을 권장합니다."
- 사용자가 범위를 줄이거나 기간을 연장하도록 안내

---

### 시나리오 5-6: 동시 재조정 방지

**시나리오 설정**:

- 사용자 A가 재조정 진행 중
- 사용자 B가 동시에 같은 플랜 그룹 재조정 시도

**시스템 동작**:

- 트랜잭션 락 사용
- 동시 재조정 방지
- 또는: 마지막 재조정만 유효 (낙관적 잠금)

---

### 시나리오 5-7: 변화 감지 문제 해결

**문제**: 같은 범위로 재조정했는데 변화가 없다고 표시되는 경우

**원인 분석**:

- 미진행 범위를 콘텐츠 범위에 추가했지만
- `generatePlansFromGroup`이 원래 콘텐츠 범위를 사용하여
- 일일 학습량이 증가하지 않음

**해결 방법**:

- 미진행 범위를 콘텐츠 범위에 반영한 후 플랜 생성
- 조정된 콘텐츠(`contentsWithUncompleted`)를 사용하여 플랜 생성
- 재조정 기간(오늘 이후)도 올바르게 적용

---

## 데이터 흐름도

### 전체 재조정 플로우

시나리오 1-2: 날짜 범위 재조정 (Range Reschedule)
목적: 특정 날짜 범위의 플랜만 재조정
사용자 행동:
재조정 페이지 진입
"날짜 범위 선택" 모드 선택
시작일/종료일 선택 (또는 스마트 제안 사용)
재조정할 콘텐츠 선택
"다음" 버튼 클릭
시스템 동작:
날짜 범위 선택 UI 표시
스마트 제안 기능 제공:
미진행 플랜이 많은 날짜 범위 제안
특정 콘텐츠의 영향받는 날짜 범위 제안
선택된 날짜 범위 검증
선택된 콘텐츠 ID와 날짜 범위를 Step 2로 전달
데이터 전달:
{ selectedContentIds: Set<string>, dateRange: { from: "2024-12-24", to: "2024-12-30" }}d_amount` 필드 조회 포함- [ ] 미진행 범위 계산 (오늘 이전 플랜만)- [ ] 미진행 범위 계산 시 음수 방지 (`max(0, ...)`)- [ ] 재조정 기간 결정 (오늘 이후만)- [ ] 콘텐츠 범위 조정 (미진행 범위 추가)- [ ] 조정된 콘텐츠를 플랜 생성에 사용- [ ] 일일 학습량 자동 증가 로직 검증- [ ] 변화 감지 로직 (일일 학습량 비교)### 개선 사항- [ ] 일일 학습량이 비현실적으로 큰 경우 경고- [ ] 초과 완료된 플랜 처리 (음수 방지)- [ ] 재조정 전/후 비교 시각화 개선- [ ] 충돌 감지 및 경고 강화- [ ] 오늘 날짜 플랜 포함 여부 설정 옵션---**문서 버전**: 1.0 **최종 수정일**: 2025-12-10
시나리오 1-3: 콘텐츠 선택 검증
시나리오 1-3-1: 콘텐츠 미선택
사용자 행동: 콘텐츠를 선택하지 않고 "다음" 클릭
시스템 동작: "최소 1개 이상의 콘텐츠를 선택해주세요." 알림 표시
결과: Step 2로 진행하지 않음
시나리오 1-3-2: 날짜 범위 미선택 (Range 모드)
사용자 행동: Range 모드인데 날짜 범위를 선택하지 않고 "다음" 클릭
시스템 동작: "날짜 범위를 선택해주세요." 알림 표시
결과: Step 2로 진행하지 않음
시나리오 1-3-3: 재조정 불가 콘텐츠 선택 시도
사용자 행동: 완료된 플랜만 있는 콘텐츠 체크박스 클릭 시도
시스템 동작: 체크박스가 비활성화되어 선택 불가
표시: "모든 플랜이 완료되어 재조정할 수 없습니다" 안내
Step 2: 상세 조정 시나리오
시나리오 2-1: 범위 조정 (Range Adjustment)
목적: 선택된 콘텐츠의 학습 범위만 수정
사용자 행동:
Step 2 진입 (Step 1에서 콘텐츠 선택 완료)
콘텐츠별 "시작 범위" 또는 "끝 범위" 입력 필드 수정
"다음" 버튼 클릭
시스템 동작:
선택된 콘텐츠 목록 표시
각 콘텐츠별 현재 범위 표시 (start_range ~ end_range)
범위 수정 시 실시간 검증:
시작 범위 ≤ 끝 범위 검증
범위가 원래 범위를 벗어나는지 검증 (선택 사항)
조정된 범위를 AdjustmentInput 배열로 생성
생성되는 AdjustmentInput:
{ plan_content_id: string, change_type: "range", before: { content_id: string, content_type: "book", range: { start: 1, end: 100 } }, after: { content_id: string, content_type: "book", range: { start: 1, end: 120 } // 범위 확장 }}
시나리오 2-2: 콘텐츠 교체 (Content Replacement)
목적: 기존 콘텐츠를 다른 콘텐츠로 교체
사용자 행동:
콘텐츠 카드에서 "교체" 버튼 클릭
교체할 콘텐츠 검색 및 선택
새로운 콘텐츠의 시작/끝 범위 입력
"교체" 버튼 클릭
시스템 동작:
콘텐츠 검색 모달 표시
교체 가능한 콘텐츠 목록 표시 (같은 content_type)
범위 검증 및 저장
원본 콘텐츠는 before, 교체 콘텐츠는 after에 저장
생성되는 AdjustmentInput:
{ plan_content_id: string, change_type: "replace", before: { content_id: "book-001", content_type: "book", range: { start: 1, end: 100 } }, after: { content_id: "book-002", // 다른 책으로 교체 content_type: "book", range: { start: 1, end: 150 } }}
시나리오 2-3: 전체 재생성 (Full Regeneration)
목적: 콘텐츠를 완전히 새로운 설정으로 재생성
사용자 행동:
콘텐츠 카드에서 "전체 재생성" 버튼 클릭
새로운 콘텐츠 선택 및 범위 설정
"재생성" 버튼 클릭
시스템 동작:
교체와 유사하지만 더 강력한 재생성으로 처리
기존 플랜과의 연결을 완전히 끊음
생성되는 AdjustmentInput:
{ plan_content_id: string, change_type: "full", before: { /_ 원본 콘텐츠 정보 _/ }, after: { /_ 새로운 콘텐츠 정보 _/ }}
시나리오 2-4: 일괄 조정 (Batch Adjustment)
목적: 여러 콘텐츠를 한 번에 조정
사용자 행동:
여러 콘텐츠 선택 (2개 이상)
"일괄 조정 모드" 활성화
일괄 조정 패널에서 조정 옵션 선택:
모든 콘텐츠에 +10페이지 추가
모든 콘텐츠 범위를 10% 증가
모든 콘텐츠 시작 범위를 +5페이지
"적용" 버튼 클릭
시스템 동작:
선택된 모든 콘텐츠에 동일한 조정 적용
각 콘텐츠별로 AdjustmentInput 생성
일괄 조정 후 개별 조정도 가능
시나리오 2-5: 조정 없이 진행
목적: 콘텐츠만 선택하고 범위는 그대로 유지 (미진행 범위 재분배만)
사용자 행동:
Step 2 진입
아무 조정도 하지 않음
"다음" 버튼 클릭
시스템 동작:
adjustments 배열이 비어있음 ([])
Step 3에서 미진행 범위만 재분배
기본 adjustments 자동 생성 (선택 사항)
Step 3: 미리보기 & 확인 시나리오
시나리오 3-1: 미리보기 자동 로드
목적: Step 3 진입 시 재조정 결과를 자동으로 미리보기
시스템 동작:
Step 3 진입 (adjustments 또는 dateRange 존재)
getReschedulePreview 서버 액션 호출
재조정 결과 계산:
기존 플랜 조회 (재조정 대상만)
미진행 범위 계산 (오늘 이전 플랜만)
조정된 콘텐츠 생성
남은 기간 계산 (오늘 이후만)
새 플랜 생성
미리보기 결과 표시
미리보기 결과 구조:
{ plans_before_count: number, // 기존 플랜 수 plans_after_count: number, // 새 플랜 수 affected_dates: string[], // 영향받는 날짜 목록 estimated_hours: number, // 예상 총 학습 시간 adjustments_summary: { range_changes: number, replacements: number, full_regenerations: number }, plans_before: Array<...>, // 기존 플랜 상세 정보 plans_after: Array<...> // 새 플랜 상세 정보}
시나리오 3-2: 변경 사항 확인
사용자 행동:
미리보기 결과 확인
변경 전/후 비교 뷰 확인
영향받는 날짜 목록 확인
조정 내역 요약 확인
시스템 표시 내용:
변경 요약 카드: 기존 플랜 수, 새 플랜 수, 영향받는 날짜, 예상 시간
변경 전/후 비교: 날짜별 플랜 비교 테이블
영향받는 플랜 목록: 재조정되는 플랜들의 상세 정보
조정 내역: 범위 수정, 교체, 전체 재생성 개수
충돌 경고: 시간대 충돌이 있는 경우 경고 표시
시나리오 3-3: 재조정 실행
사용자 행동:
미리보기 결과 확인 후 "재조정 실행" 버튼 클릭
확인 다이얼로그에서 변경 사항 재확인
"실행" 버튼 클릭
시스템 동작:
rescheduleContents 서버 액션 호출
트랜잭션 시작
기존 플랜 히스토리 백업 (plan_history 테이블)
기존 플랜 비활성화 (is_active = false)
새 플랜 생성 및 저장
재조정 로그 저장 (reschedule_log 테이블)
트랜잭션 커밋
성공 메시지 표시 및 플랜 그룹 상세 페이지로 리다이렉트
시나리오 3-4: 미리보기 실패 처리
시나리오 3-4-1: 로딩 실패
사용자 행동: Step 3 진입 시도
시스템 동작: 에러 발생
표시: 에러 메시지 + "다시 시도" 버튼
처리: 사용자가 "다시 시도" 클릭 시 loadPreview 재호출
시나리오 3-4-2: 조건 불만족 (adjustments와 dateRange 모두 없음)
사용자 행동: Step 2에서 조정하지 않고 Step 3 진입
시스템 동작: 미리보기 로드하지 않음
표시: "조정 사항이 없거나 날짜 범위가 선택되지 않았습니다." 안내 메시지
재조정 로직 핵심 시나리오
시나리오 4-1: 미진행 범위 계산 및 재분배 (핵심)
목적: 오늘 이전 날짜의 미진행 플랜 범위를 오늘 이후 기간에 재분배
시나리오 설정:
플랜 그룹 기간: 2024-12-08 ~ 2024-12-30
총 학습량: 30페이지 (1페이지 ~ 30페이지)
원래 일일 배정: 1.3페이지/일
오늘 날짜: 2024-12-23
진행 상황: 12월 8일 ~ 12월 22일 플랜 모두 미진행 (15일치)
시스템 동작:
기존 플랜 조회 (오늘 이전만)
true
SELECT id, plan_date, content_id, planned_start_page_or_time, planned_end_page_or_time, completed_amount, status, is_active FROM student_plan WHERE plan_group_id = ? AND student_id = ? AND plan_date < '2024-12-23' -- 오늘 이전만 AND status IN ('pending', 'in_progress') AND is_active = true
미진행 범위 계산
// 각 플랜별 미진행 범위 계산 uncompleted = (planned_end - planned_start) - (completed_amount || 0) // 예: 12월 8일 플랜 // planned_start: 1, planned_end: 2 // completed_amount: 0 // uncompleted: (2 - 1) - 0 = 1페이지 // 콘텐츠별로 합산 // 총 미진행 범위: 15페이지 (15일 × 1페이지)
재조정 기간 결정
const today = "2024-12-23"; const adjustedPeriodStart = dateRange?.from || getNextStudyDate(today); // 2024-12-24 (오늘 이후 첫 학습일) const adjustedPeriodEnd = dateRange?.to || group.period_end; // 2024-12-30
콘텐츠 범위 조정
)
// 미진행 범위를 콘텐츠 범위에 추가 originalRange: 1 ~ 30 (30페이지) uncompletedRange: 15페이지 adjustedRange: 1 ~ 45 (30 + 15 = 45페이지)
스케줄 계산 (남은 기간만)
계산
calculateAvailableDates( "2024-12-24", // 오늘 이후 시작 "2024-12-30", // 원래 종료일 // ... 기타 설정 ) // 결과: 7일의 학습일 계산
새 플랜 생성
// 45페이지 ÷ 7일 = 6.4페이지/일 // 일일 학습량이 자동으로 증가
최종 결과:
남은 기간: 2024-12-24 ~ 2024-12-30 (7일)
총 학습량: 45페이지 (원래 30페이지 + 미진행 15페이지)
새 일일 배정: 6.4페이지/일 (원래 1.3페이지/일에서 증가)
변화 감지: 일일 학습량이 크게 증가했으므로 "변화 있음"으로 표시
시나리오 4-2: 부분 진행된 플랜 처리
시나리오 설정:
12월 8일 플랜: 1페이지 ~ 2페이지 (2페이지 배정)
진행 상황: 1.5페이지 완료 (completed_amount = 1.5)
12월 9일 플랜: 2페이지 ~ 3페이지 (1페이지 배정)
진행 상황: 미진행 (completed_amount = 0)
시스템 동작:
미진행 범위 계산
// 12월 8일 플랜 totalRange = 2 - 1 = 1페이지 completed = 1.5페이지 uncompleted = max(0, 1 - 1.5) = 0페이지 (이미 초과 완료, 음수 방지) // 12월 9일 플랜 totalRange = 3 - 2 = 1페이지 completed = 0페이지 uncompleted = 1페이지 // 총 미진행: 1페이지 (12월 9일만)
재분배
미진행 1페이지를 남은 기간에 재분배
초과 완료된 범위는 무시 (음수 처리 방지)
시나리오 4-3: 날짜 범위 지정 재조정
시나리오 설정:
플랜 그룹 기간: 2024-12-08 ~ 2024-12-30
오늘 날짜: 2024-12-23
사용자 선택: 2024-12-20 ~ 2024-12-25 범위만 재조정
시스템 동작:
재조정 대상 플랜 필터링
// 날짜 범위와 오늘 이전 조건 모두 적용 query = query .gte("plan_date", "2024-12-20") .lte("plan_date", "2024-12-25") .lt("plan_date", "2024-12-23") // 오늘 이전만 // 결과: 2024-12-20, 2024-12-21, 2024-12-22 플랜만 조회
재조정 기간 결정
// 사용자가 선택한 범위와 오늘 이후 조건 결합 adjustedPeriodStart = max("2024-12-20", "2024-12-23") = "2024-12-23" adjustedPeriodEnd = "2024-12-25"
플랜 생성 시 날짜 필터링
// 생성된 플랜 중 선택한 날짜 범위만 유지 filteredPlans = generatedPlans.filter( plan => plan.plan_date >= "2024-12-20" && plan.plan_date <= "2024-12-25" )
시나리오 4-4: 조정(adjustments)과 미진행 범위 재분배 동시 적용
시나리오 설정:
콘텐츠 A: 원래 범위 1~100페이지
사용자 조정: 1~120페이지로 확장
미진행 범위: 15페이지 (오늘 이전)
시스템 동작:
조정 적용
adjustedContents = applyAdjustments(contents, adjustments) // 콘텐츠 A: 1~120페이지 (사용자 조정 적용)
미진행 범위 추가
// 미진행 범위는 조정된 범위에 추가 uncompleted = 15페이지 finalRange = 120 + 15 = 135페이지 // 최종: 1~135페이지
순서 중요: 조정 먼저, 미진행 범위 추가는 나중
에지 케이스 시나리오
시나리오 5-1: 오늘 날짜에 플랜이 있는 경우
시나리오 설정:
오늘 날짜: 2024-12-23
12월 23일에도 플랜이 있음
질문: 오늘 날짜의 플랜도 재조정 대상에 포함해야 하나?
시나리오 A: 오늘 날짜 제외 (권장)
오늘 플랜은 아직 진행 가능하므로 유지
재조정 시작: 2024-12-24부터
로직: plan_date < today (미만)
시나리오 B: 오늘 날짜 포함
오늘 플랜도 재조정 가능
재조정 시작: 2024-12-23부터
로직: plan_date <= today (이하)
권장: 시나리오 A (오늘 날짜 제외)
오늘 학습할 수 있는 기회를 보장
사용자가 이미 오늘 플랜을 시작했을 수 있음
시나리오 5-2: 모든 플랜이 완료된 경우
시나리오 설정:
모든 플랜이 status = 'completed'
시스템 동작:
Step 1에서 재조정 가능한 콘텐츠가 0개
"재조정 가능한 콘텐츠가 없습니다." 메시지 표시
재조정 진행 불가
시나리오 5-3: 남은 기간이 없는 경우
시나리오 설정:
플랜 그룹 기간: 2024-12-08 ~ 2024-12-23
오늘 날짜: 2024-12-23
재조정 시도
시스템 동작:
남은 기간: 없음 (오늘 이후 학습일 없음)
에러 처리: "재조정할 기간이 남아있지 않습니다." 메시지
재조정 진행 불가
시나리오 5-4: 날짜 범위가 오늘 이전인 경우
시나리오 설정:
오늘 날짜: 2024-12-23
사용자 선택: 2024-12-20 ~ 2024-12-22
시스템 동작:
선택한 범위가 모두 오늘 이전
오늘 이후 재조정 기간: 없음
에러 처리: "선택한 날짜 범위에 오늘 이후 기간이 포함되지 않았습니다."
또는: 자동으로 오늘 이후 첫 학습일로 조정
시나리오 5-5: 미진행 범위가 매우 큰 경우
시나리오 설정:
총 학습량: 100페이지
미진행: 80페이지
남은 기간: 5일
일일 배정: 80페이지 ÷ 5일 = 16페이지/일
시스템 동작:
일일 학습량이 비현실적으로 큼
경고 표시: "일일 학습량이 매우 큽니다. 범위 조정을 권장합니다."
사용자가 범위를 줄이거나 기간을 연장하도록 안내
시나리오 5-6: 동시 재조정 방지
시나리오 설정:
사용자 A가 재조정 진행 중
사용자 B가 동시에 같은 플랜 그룹 재조정 시도
시스템 동작:
트랜잭션 락 사용
동시 재조정 방지
또는: 마지막 재조정만 유효 (낙관적 잠금)
시나리오 5-7: 변화 감지 문제 해결
문제: 같은 범위로 재조정했는데 변화가 없다고 표시되는 경우
원인 분석:
미진행 범위를 콘텐츠 범위에 추가했지만
generatePlansFromGroup이 원래 콘텐츠 범위를 사용하여
일일 학습량이 증가하지 않음
해결 방법:
미진행 범위를 콘텐츠 범위에 반영한 후 플랜 생성
조정된 콘텐츠(contentsWithUncompleted)를 사용하여 플랜 생성
재조정 기간(오늘 이후)도 올바르게 적용
데이터 흐름도
전체 재조정 플로우
[Step 1: 콘텐츠 선택] ↓ [selectedContentIds, dateRange] ↓[Step 2: 상세 조정] ↓ [adjustments] ↓[Step 3: 미리보기] ↓ [getReschedulePreview 서버 액션] ↓ [1. 오늘 날짜 구하기] ↓ [2. 기존 플랜 조회] - plan_date < today (오늘 이전만) - completed_amount 포함 ↓ [3. 미진행 범위 계산] - 각 플랜: (planned_end - planned_start) - completed_amount - 콘텐츠별 합산 ↓ [4. 조정 적용 (adjustments)] - applyAdjustments(contents, adjustments) ↓ [5. 재조정 기간 결정] - adjustedPeriodStart = max(dateRange.from, today 이후 첫 학습일) - adjustedPeriodEnd = dateRange.to || group.period_end ↓ [6. 콘텐츠 범위 조정 (미진행 범위 추가)] - contentsWithUncompleted: end_range += uncompletedRange ↓ [7. 스케줄 계산 (남은 기간만)] - calculateAvailableDates(adjustedPeriodStart, adjustedPeriodEnd, ...) ↓ [8. 새 플랜 생성] - generatePlansFromGroup(..., contentsWithUncompleted, ...) - 일일 학습량 자동 증가 ↓ [미리보기 결과 반환] ↓[사용자 확인] ↓ [rescheduleContents 실행] ↓ [1. 트랜잭션 시작] ↓ [2. 기존 플랜 히스토리 백업] ↓ [3. 기존 플랜 비활성화] ↓ [4. 새 플랜 생성 및 저장] ↓ [5. 재조정 로그 저장] ↓ [6. 트랜잭션 커밋] ↓[완료]
구현 체크리스트
필수 구현 사항
[ ] 오늘 날짜 기준 플랜 필터링 (plan_date < today)
[ ] completed_amount 필드 조회 포함
[ ] 미진행 범위 계산 (오늘 이전 플랜만)
[ ] 미진행 범위 계산 시 음수 방지 (max(0, ...))
[ ] 재조정 기간 결정 (오늘 이후만)
[ ] 콘텐츠 범위 조정 (미진행 범위 추가)
[ ] 조정된 콘텐츠를 플랜 생성에 사용
[ ] 일일 학습량 자동 증가 로직 검증
[ ] 변화 감지 로직 (일일 학습량 비교)
개선 사항
[ ] 일일 학습량이 비현실적으로 큰 경우 경고
[ ] 초과 완료된 플랜 처리 (음수 방지)
[ ] 재조정 전/후 비교 시각화 개선
[ ] 충돌 감지 및 경고 강화
[ ] 오늘 날짜 플랜 포함 여부 설정 옵션
