# 캠프 모드 콘텐츠 및 교재 조회 문제 수정

## 문제 분석

1. **콘텐츠 중복 문제**: 학생이 템플릿에서 선택한 콘텐츠 외에도 관리자 영역에서 콘텐츠가 추가되어 있음
2. **교재 조회 실패**: `Referenced book (1aa96907-9e01-4c59-9205-d684c36f789d) does not exist` 에러 발생
   - 원인: `_generatePlansFromGroup` 함수에서 마스터 콘텐츠 ID를 학생 콘텐츠 ID로 변환하는 로직이 있지만, 교재 조회 시 변환된 ID를 사용하지 않거나 변환이 실패한 경우 원본 ID를 사용하여 에러 발생

## 해결 방안

### 1. 교재 조회 로직 개선 (`app/(student)/actions/planGroupActions.ts`)

**수정 내용**:
- `_generatePlansFromGroup` 함수에서 교재 조회 시 마스터 콘텐츠 ID 처리 개선
- `finalContentId`로 학생 교재를 찾지 못한 경우, 마스터 콘텐츠 ID인지 확인
- 마스터 콘텐츠 ID인 경우, 해당 학생의 교재를 `master_content_id`로 찾기
- 강의도 동일한 로직 적용
- 에러 발생 시 더 명확한 에러 메시지 제공

**주요 변경사항**:
- 교재 조회 시 마스터 콘텐츠 ID인 경우 fallback 로직 추가
- 강의 조회 시 마스터 콘텐츠 ID인 경우 fallback 로직 추가
- 에러 메시지에 학생 ID와 마스터 콘텐츠 여부 정보 포함

### 2. 콘텐츠 필터링 로직 추가 (`app/(admin)/actions/campTemplateActions.ts`)

**수정 내용**:
- `continueCampStepsForAdmin` 함수에서 콘텐츠 저장 전에 학생이 실제로 가지고 있는 콘텐츠만 필터링
- 마스터 콘텐츠 ID인 경우, 학생 콘텐츠로 변환하는 로직 추가
- 유효하지 않은 콘텐츠는 경고 로그만 출력하고 제외

**주요 변경사항**:
- 콘텐츠 저장 전에 각 콘텐츠가 학생이 실제로 가지고 있는지 검증
- 마스터 콘텐츠 ID인 경우, `master_content_id`로 학생 콘텐츠 찾기
- 유효하지 않은 콘텐츠는 자동으로 제외하고 경고 로그 출력
- 교재, 강의, 커스텀 콘텐츠 모두 동일한 로직 적용

## 구현 세부사항

### 파일 1: `app/(student)/actions/planGroupActions.ts`

**수정 위치**: `_generatePlansFromGroup` 함수 내 교재 조회 로직 (약 1936-2047줄)

**변경 내용**:
1. 교재 조회 시 `finalContentId`로 찾지 못한 경우, 마스터 콘텐츠 ID인지 확인
2. 마스터 콘텐츠 ID인 경우, 해당 학생의 교재를 `master_content_id`로 찾기
3. 강의도 동일한 로직 적용
4. 에러 메시지 개선 (학생 ID, 마스터 콘텐츠 여부 정보 포함)

### 파일 2: `app/(admin)/actions/campTemplateActions.ts`

**수정 위치**: `continueCampStepsForAdmin` 함수 내 콘텐츠 업데이트 로직 (약 1099-1121줄)

**변경 내용**:
1. 콘텐츠 저장 전에 각 콘텐츠가 학생이 실제로 가지고 있는지 검증
2. 마스터 콘텐츠 ID인 경우, `master_content_id`로 학생 콘텐츠 찾기
3. 유효하지 않은 콘텐츠는 자동으로 제외하고 경고 로그 출력
4. 교재, 강의, 커스텀 콘텐츠 모두 동일한 로직 적용

## 테스트 시나리오

1. **관리자가 캠프 템플릿에서 학생이 선택하지 않은 마스터 콘텐츠를 추가한 경우**
   - 예상 결과: 해당 콘텐츠는 자동으로 제외되고 경고 로그 출력
   - 플랜 생성 시 에러 발생하지 않음

2. **학생이 템플릿에서 선택한 콘텐츠와 관리자가 추가한 콘텐츠가 중복되는 경우**
   - 예상 결과: 중복 검증 로직에 의해 처리됨

3. **마스터 콘텐츠 ID로 저장된 콘텐츠를 플랜 생성 시 조회하는 경우**
   - 예상 결과: 해당 학생의 교재/강의를 `master_content_id`로 찾아서 사용
   - 찾지 못한 경우 명확한 에러 메시지 제공

## 관련 파일

- `app/(student)/actions/planGroupActions.ts` - 교재 조회 로직 개선
- `app/(admin)/actions/campTemplateActions.ts` - 콘텐츠 필터링 로직 추가
- `lib/utils/planGroupDataSync.ts` - 데이터 동기화 로직 (변경 없음, 현재 로직 유지)

## 참고사항

- 마스터 콘텐츠 ID와 학생 콘텐츠 ID 간 변환은 플랜 생성 시점에 수행됨
- 관리자가 콘텐츠를 추가할 때는 학생이 실제로 가지고 있는 콘텐츠만 저장됨
- 유효하지 않은 콘텐츠는 자동으로 제외되므로 플랜 생성 시 에러가 발생하지 않음

