# 새로고침 시 콘텐츠 사라짐 문제 해결

## 작업 일자
2025-12-04

## 문제 상황

`/admin/camp-templates/[id]/participants/[groupId]/continue` 페이지에서 새로고침 버튼을 누르면 학생이 추가한 콘텐츠가 목록에서 사라지는 문제가 발생했습니다.

## 원인 분석

### 1. 필터링 로직 문제

`continue/page.tsx`의 193-199줄에서 추천 콘텐츠를 필터링하는 로직이 학생이 추가한 콘텐츠까지 제거하고 있었습니다.

**기존 필터링 로직:**
```typescript
.filter((c) => {
  return !(c.is_auto_recommended || c.recommendation_source);
})
```

**문제점:**
- 학생이 추가한 콘텐츠는 `is_auto_recommended: false`, `recommendation_source: null`이어야 합니다.
- 하지만 필터 조건 `!(c.is_auto_recommended || c.recommendation_source)`는 `recommendation_source`가 `null`이 아닌 모든 값을 필터링합니다.
- 만약 학생 콘텐츠에 `recommendation_source`가 잘못 설정되어 있으면 필터링됩니다.

### 2. 새로고침 시 문제 발생 흐름

1. 새로고침 시 `router.refresh()`가 호출되어 서버 컴포넌트가 다시 렌더링됩니다.
2. `getCampPlanGroupForReview`가 다시 호출되어 최신 데이터를 가져옵니다.
3. 필터링 로직이 실행되면서 학생 콘텐츠가 제거됩니다.

## 해결 방안

### 1. 필터링 로직 수정

학생이 추가한 콘텐츠는 보존하고, 추천 콘텐츠만 필터링하도록 수정했습니다.

**수정된 필터링 로직:**
```typescript
const filteredContents = contentsForWizard.filter((c) => {
  // 학생이 추가한 콘텐츠는 항상 포함
  // is_auto_recommended가 false이고 recommendation_source가 null이거나 없는 경우
  if (c.is_auto_recommended === false && (!c.recommendation_source || c.recommendation_source === null)) {
    return true;
  }
  
  // 추천 콘텐츠는 필터링 (제거)
  // is_auto_recommended가 true이거나 recommendation_source가 "auto", "admin", "template"인 경우
  return false;
});
```

**필터링 규칙:**
- **학생 콘텐츠**: `is_auto_recommended: false` AND `recommendation_source: null` → 항상 포함
- **추천 콘텐츠**: `is_auto_recommended: true` OR `recommendation_source`가 `"auto"`, `"admin"`, `"template"` → 필터링

### 2. 데이터 검증 로깅 추가

필터링 전후 콘텐츠 개수 및 상세 정보를 로깅하여 문제를 추적할 수 있도록 했습니다.

**추가된 로깅:**
- 필터링 전 콘텐츠 개수 및 각 콘텐츠의 `is_auto_recommended`, `recommendation_source` 값
- 필터링 후 콘텐츠 개수
- 제거된 콘텐츠 상세 정보

## 수정된 파일

### `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`

**주요 변경사항:**
1. 필터링 로직을 명확하게 분리하여 학생 콘텐츠와 추천 콘텐츠를 구분
2. 필터링 전후 콘텐츠 정보를 상세하게 로깅
3. 제거된 콘텐츠 정보도 로깅하여 디버깅 용이성 향상

## 테스트 방법

1. 학생이 캠프 참여 시 콘텐츠를 추가합니다.
2. 관리자가 `/admin/camp-templates/[id]/participants/[groupId]/continue` 페이지에 접속합니다.
3. 학생이 추가한 콘텐츠가 목록에 표시되는지 확인합니다.
4. 새로고침 버튼을 클릭합니다.
5. 학생이 추가한 콘텐츠가 여전히 목록에 표시되는지 확인합니다.
6. 추천 콘텐츠는 필터링되어 목록에서 제거되는지 확인합니다.

## 예상 결과

- ✅ 학생이 추가한 콘텐츠는 새로고침 후에도 유지됩니다.
- ✅ 추천 콘텐츠는 여전히 필터링되어 Step 4에서 새로 선택할 수 있습니다.
- ✅ 콘솔 로그를 통해 필터링 과정을 추적할 수 있습니다.

## 관련 이슈

- 학생이 추가한 콘텐츠와 추천 콘텐츠를 구분하는 로직이 명확하지 않았던 문제
- 새로고침 시 데이터가 재조회되면서 필터링 로직이 다시 실행되어 학생 콘텐츠가 제거되던 문제

