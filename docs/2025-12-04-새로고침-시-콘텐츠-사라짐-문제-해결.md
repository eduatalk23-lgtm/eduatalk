# 새로고침 시 콘텐츠 사라짐 문제 해결

## 작업 일자
2025-12-04

## 문제 상황

`/admin/camp-templates/[id]/participants/[groupId]/continue` 페이지에서 새로고침 버튼을 누르면 학생이 추가한 콘텐츠가 목록에서 사라지는 문제가 발생했습니다.

## 원인 분석

### 1. 필터링 로직 문제

`continue/page.tsx`의 193-199줄에서 추천 콘텐츠를 필터링하는 로직이 학생이 추가한 콘텐츠까지 제거하고 있었습니다.

**기존 필터링 로직:**
```typescript
.filter((c) => {
  return !(c.is_auto_recommended || c.recommendation_source);
})
```

**문제점:**
- 학생이 추가한 콘텐츠는 `is_auto_recommended: false`, `recommendation_source: null`이어야 합니다.
- 하지만 필터 조건 `!(c.is_auto_recommended || c.recommendation_source)`는 `recommendation_source`가 `null`이 아닌 모든 값을 필터링합니다.
- 만약 학생 콘텐츠에 `recommendation_source`가 잘못 설정되어 있으면 필터링됩니다.

### 2. 새로고침 시 문제 발생 흐름

1. 새로고침 시 `router.refresh()`가 호출되어 서버 컴포넌트가 다시 렌더링됩니다.
2. `getCampPlanGroupForReview`가 다시 호출되어 최신 데이터를 가져옵니다.
3. 필터링 로직이 실행되면서 학생 콘텐츠가 제거됩니다.

## 해결 방안

### 1. 필터링 로직 제거 및 구조 개선

기존의 필터링 로직을 제거하고, `syncCreationDataToWizardData` 함수의 분류 로직을 활용하도록 변경했습니다.

**변경 전 (문제점):**
- 필터링 로직이 먼저 실행되어 학생 콘텐츠가 잘못 제거될 수 있음
- 필터링 로직과 `syncCreationDataToWizardData`의 분류 로직이 중복됨
- DB에서 가져온 데이터의 `is_auto_recommended`나 `recommendation_source` 값이 예상과 다를 경우 필터링 실패

**변경 후 (해결책):**
1. 모든 콘텐츠를 `syncCreationDataToWizardData`에 전달
2. `syncCreationDataToWizardData`가 학생/추천 콘텐츠로 자동 분류
3. 변환된 `wizardData`에서 `recommended_contents`만 제거
4. `student_contents`는 그대로 유지

**핵심 변경사항:**
```typescript
// 모든 콘텐츠를 syncCreationDataToWizardData에 전달
const wizardData = syncCreationDataToWizardData({
  group,
  contents: contentsForWizard.map((c) => {
    // classifyPlanContents에서 조회한 정보를 우선적으로 사용
    const classifiedContent = contentsMap.get(c.content_id);
    return {
      ...c,
      title: classifiedContent?.title || undefined,
      subject_category: classifiedContent?.subject_category || undefined,
      master_content_id: c.master_content_id || classifiedContent?.masterContentId || undefined,
    };
  }),
  exclusions,
  academySchedules,
});

// 변환 후 추천 콘텐츠만 제거
const filteredWizardData = {
  ...wizardData,
  student_contents: wizardData.student_contents, // 학생 콘텐츠는 그대로 유지
  recommended_contents: [], // 추천 콘텐츠는 Step 4에서 새로 선택할 수 있도록 제거
};
```

**장점:**
- 분류 로직이 한 곳에만 존재 (단일 책임 원칙)
- DB에서 모든 데이터를 불러온 후 분류하므로 안전
- `syncCreationDataToWizardData`의 분류 로직을 재사용
- 데이터 손실 위험 최소화

### 2. 데이터 검증 로깅 추가

데이터 흐름을 추적할 수 있도록 상세한 로깅을 추가했습니다.

**추가된 로깅:**
1. **DB에서 불러온 콘텐츠 정보**: 모든 콘텐츠의 `is_auto_recommended`, `recommendation_source` 값 및 예상 분류
2. **syncCreationDataToWizardData 분류 결과**: 학생 콘텐츠와 추천 콘텐츠로 분류된 결과
3. **필터링 후 최종 결과**: 최종적으로 위저드에 전달되는 콘텐츠 정보

**로깅 예시:**
```typescript
console.log("[CampContinuePage] DB에서 불러온 콘텐츠 정보:", {
  totalContentsCount: contentsForWizard.length,
  contents: contentsForWizard.map((c) => ({
    content_id: c.content_id,
    is_auto_recommended: c.is_auto_recommended,
    recommendation_source: c.recommendation_source,
    willBeStudentContent: !(c.is_auto_recommended || c.recommendation_source),
    willBeRecommendedContent: !!(c.is_auto_recommended || c.recommendation_source),
  })),
});

console.log("[CampContinuePage] syncCreationDataToWizardData 분류 결과:", {
  studentContentsCount: wizardData.student_contents.length,
  recommendedContentsCount: wizardData.recommended_contents.length,
});

console.log("[CampContinuePage] 필터링 후 최종 결과:", {
  finalStudentContentsCount: filteredWizardData.student_contents.length,
  removedRecommendedContentsCount: wizardData.recommended_contents.length,
});
```

## 수정된 파일

### `app/(admin)/admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx`

**주요 변경사항:**
1. 필터링 로직을 명확하게 분리하여 학생 콘텐츠와 추천 콘텐츠를 구분
2. 필터링 전후 콘텐츠 정보를 상세하게 로깅
3. 제거된 콘텐츠 정보도 로깅하여 디버깅 용이성 향상

## 테스트 방법

1. 학생이 캠프 참여 시 콘텐츠를 추가합니다.
2. 관리자가 `/admin/camp-templates/[id]/participants/[groupId]/continue` 페이지에 접속합니다.
3. 학생이 추가한 콘텐츠가 목록에 표시되는지 확인합니다.
4. 새로고침 버튼을 클릭합니다.
5. 학생이 추가한 콘텐츠가 여전히 목록에 표시되는지 확인합니다.
6. 추천 콘텐츠는 필터링되어 목록에서 제거되는지 확인합니다.

## 예상 결과

- ✅ 학생이 추가한 콘텐츠는 새로고침 후에도 유지됩니다.
- ✅ 추천 콘텐츠는 여전히 필터링되어 Step 4에서 새로 선택할 수 있습니다.
- ✅ 콘솔 로그를 통해 필터링 과정을 추적할 수 있습니다.

## 관련 이슈

- 학생이 추가한 콘텐츠와 추천 콘텐츠를 구분하는 로직이 명확하지 않았던 문제
- 새로고침 시 데이터가 재조회되면서 필터링 로직이 다시 실행되어 학생 콘텐츠가 제거되던 문제

