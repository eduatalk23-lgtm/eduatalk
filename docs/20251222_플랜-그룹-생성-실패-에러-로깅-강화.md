# 플랜 그룹 생성 실패 에러 로깅 강화

**작업 일시**: 2025-12-22  
**관련 이슈**: 학생의 캠프 템플릿 제출 과정에서 플랜 그룹 생성 실패 오류 발생

---

## 문제 분석

### 에러 로그

```
⨯ Error [AppError]: 플랜 그룹 생성 실패
   at _createPlanGroup (app/(student)/actions/plan-groups/create.ts:211:11)
```

### 원인 분석

1. **에러 메시지 부족**
   - `createPlanGroup` 함수에서 실패 시 "플랜 그룹 생성 실패"라는 일반적인 메시지만 반환
   - 실제 데이터베이스 에러 정보가 로그에 기록되지 않음
   - RLS 정책 위반, 데이터 검증 실패, 제약 조건 위반 등 구체적인 원인 파악 불가

2. **에러 처리 흐름**
   - `createTypedConditionalQuery`가 에러 발생 시 `defaultValue`(null) 반환
   - `result`가 null이면 "플랜 그룹 생성 실패"라는 일반적인 메시지만 반환
   - 실제 데이터베이스 에러 정보가 손실됨

---

## 해결 방법

### 수정 내용

**파일**: `lib/data/planGroups.ts`

**변경 사항**:
1. INSERT 쿼리 실행 전에 상세한 에러 로깅 추가
2. 에러 발생 시 에러 코드, 메시지, 상세 정보, 힌트를 모두 로깅
3. 페이로드 정보도 로깅하여 디버깅 용이성 향상
4. fallback 쿼리 실행 시에도 에러 로깅 추가
5. 최종 실패 시 상세한 에러 메시지 반환

```typescript
// 수정 전
const result = await createTypedConditionalQuery<{ id: string }>(
  async () => {
    const queryResult = await supabase
      .from("plan_groups")
      .insert(payload as PlanGroupInsert)
      .select("id")
      .single();
    return { data: queryResult.data, error: queryResult.error };
  },
  // ...
);

if (!result) {
  return { success: false, error: "플랜 그룹 생성 실패" };
}

// 수정 후
// 상세한 에러 로깅을 위한 쿼리 실행
const queryResult = await supabase
  .from("plan_groups")
  .insert(payload as PlanGroupInsert)
  .select("id")
  .single();

// 에러가 있는 경우 상세 로깅
if (queryResult.error) {
  console.error("[data/planGroups] createPlanGroup INSERT 실패:", {
    error: queryResult.error.message,
    errorCode: queryResult.error.code,
    errorDetails: queryResult.error.details,
    errorHint: queryResult.error.hint,
    payload: {
      tenant_id: payload.tenant_id,
      student_id: payload.student_id,
      // ... 기타 필드
    },
  });
}

const result = await createTypedConditionalQuery<{ id: string }>(
  // ...
);

if (!result) {
  // 상세한 에러 메시지 반환
  const errorMessage = queryResult.error 
    ? `플랜 그룹 생성 실패: ${queryResult.error.message} (코드: ${queryResult.error.code})`
    : "플랜 그룹 생성 실패: 알 수 없는 오류";
  
  console.error("[data/planGroups] createPlanGroup 최종 실패:", {
    errorMessage,
    originalError: queryResult.error,
    // ...
  });
  
  return { success: false, error: errorMessage };
}
```

---

## 효과

1. **디버깅 용이성 향상**
   - 실제 데이터베이스 에러 정보를 로그에서 확인 가능
   - 에러 코드, 메시지, 상세 정보, 힌트를 모두 확인 가능
   - 페이로드 정보도 확인하여 문제가 되는 필드 파악 가능

2. **에러 원인 파악**
   - RLS 정책 위반: `42501` 에러 코드
   - 제약 조건 위반: `23503`, `23505`, `23502`, `23514` 등
   - 컬럼 없음: `42703` 에러 코드
   - 기타 데이터베이스 에러: 각 에러 코드별로 원인 파악 가능

3. **사용자 친화적 에러 메시지**
   - 일반적인 "플랜 그룹 생성 실패" 대신 구체적인 에러 메시지 반환
   - 에러 코드도 포함하여 개발자가 빠르게 원인 파악 가능

---

## 다음 단계

1. 실제 에러 로그 확인
   - 학생이 캠프 템플릿을 제출할 때 발생하는 실제 에러 로그 확인
   - 에러 코드와 메시지를 통해 구체적인 원인 파악

2. 원인별 해결 방법
   - RLS 정책 위반: RLS 정책 확인 및 수정
   - 제약 조건 위반: 데이터 검증 로직 추가
   - 컬럼 없음: 마이그레이션 확인 및 수정

---

## 참고 사항

- `createTypedConditionalQuery`는 에러 발생 시 `defaultValue`를 반환하므로, 실제 에러 정보를 확인하려면 쿼리 실행 전에 에러를 확인해야 합니다.
- RLS 정책 위반 시 에러 코드는 `42501`입니다.
- 제약 조건 위반 시 에러 코드는 `23503`(외래 키), `23505`(중복), `23502`(NOT NULL), `23514`(CHECK) 등입니다.


