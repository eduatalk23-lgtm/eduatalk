# 데이터베이스 최적화 - 인덱스 추가 완료

**작업 일시**: 2025-01-15  
**목적**: 테넌트 사용자 관리 쿼리 성능 최적화를 위한 인덱스 추가

---

## 📋 작업 완료 내역

### Phase 3: 데이터베이스 쿼리 최적화 ✅

#### 3.1 인덱스 추가

**마이그레이션 파일**: `supabase/migrations/20250115000000_add_tenant_id_indexes.sql`

**추가된 인덱스**:

1. **`idx_students_tenant_id`**
   - 테이블: `students`
   - 필드: `tenant_id`
   - 타입: 부분 인덱스 (Partial Index)
   - 조건: `WHERE tenant_id IS NOT NULL`

2. **`idx_parent_users_tenant_id`**
   - 테이블: `parent_users`
   - 필드: `tenant_id`
   - 타입: 부분 인덱스 (Partial Index)
   - 조건: `WHERE tenant_id IS NOT NULL`

3. **`idx_admin_users_tenant_id`**
   - 테이블: `admin_users`
   - 필드: `tenant_id`
   - 타입: 부분 인덱스 (Partial Index)
   - 조건: `WHERE tenant_id IS NOT NULL`

---

## 🎯 부분 인덱스 사용 이유

### 1. 인덱스 크기 최적화

**문제점**:
- `tenant_id`가 NULL인 레코드가 많은 경우 전체 인덱스 크기가 불필요하게 커짐
- NULL 값은 실제로 필터링에 사용되지 않음

**해결책**:
- 부분 인덱스(`WHERE tenant_id IS NOT NULL`) 사용
- NULL 값은 인덱스에 포함하지 않아 인덱스 크기 감소

### 2. 쿼리 패턴 최적화

**사용 패턴**:
- `tenant_id`로 필터링하는 쿼리: `WHERE tenant_id = 'xxx'` → 인덱스 사용 ✅
- `tenant_id IS NULL` 조회: 전체 테이블 스캔 필요 → 인덱스 불필요 ✅

**부분 인덱스의 장점**:
- 실제로 사용되는 쿼리 패턴에 맞춘 인덱스
- 인덱스 크기 최소화
- 쿼리 성능 향상

### 3. NULL 값 처리

**현재 상황**:
- `students.tenant_id`: ERD에서는 NOT NULL이지만 코드에서는 nullable 처리
- `parent_users.tenant_id`: nullable
- `admin_users.tenant_id`: nullable

**부분 인덱스 적용**:
- NULL 값은 인덱스에 포함하지 않음
- NULL 값 조회는 전체 테이블 스캔 (데이터가 적으면 문제없음)
- 실제 필터링 쿼리에서만 인덱스 활용

---

## 📊 성능 개선 효과

### 쿼리 성능 향상

**이전**:
```sql
-- 전체 테이블 스캔 또는 기본 인덱스 사용
SELECT * FROM students WHERE tenant_id = 'xxx';
```

**이후**:
```sql
-- 부분 인덱스 사용으로 빠른 조회
SELECT * FROM students WHERE tenant_id = 'xxx';
-- 인덱스: idx_students_tenant_id 사용
```

### 예상 성능 개선

1. **기관별 사용자 조회**:
   - 이전: 전체 테이블 스캔 또는 기본 인덱스
   - 이후: 부분 인덱스 사용으로 50-90% 성능 향상 (데이터 양에 따라)

2. **테넌트 미할당 사용자 조회**:
   - 이전: 전체 테이블 스캔
   - 이후: 전체 테이블 스캔 (변화 없음, NULL 값은 인덱스에 없음)

3. **인덱스 크기**:
   - 이전: 모든 레코드 포함 (NULL 포함)
   - 이후: NULL이 아닌 레코드만 포함 (인덱스 크기 감소)

---

## 🔍 인덱스 사용 확인 방법

### PostgreSQL 쿼리 분석

```sql
-- 인덱스 사용 여부 확인
EXPLAIN ANALYZE
SELECT * FROM students 
WHERE tenant_id = 'xxx';

-- 인덱스 정보 확인
SELECT 
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename IN ('students', 'parent_users', 'admin_users')
  AND indexname LIKE '%tenant_id%';
```

### 예상 실행 계획

**인덱스 사용 쿼리**:
```
Index Scan using idx_students_tenant_id on students
  Index Cond: (tenant_id = 'xxx'::uuid)
```

**NULL 값 조회** (인덱스 미사용):
```
Seq Scan on students
  Filter: (tenant_id IS NULL)
```

---

## ⚠️ 주의사항

### 1. 마이그레이션 실행 순서

**중요**: 마이그레이션 파일은 타임스탬프 순서로 실행됩니다.

**현재 파일명**: `20250115000000_add_tenant_id_indexes.sql`

**확인 사항**:
- 기존 마이그레이션과 충돌하지 않는지 확인
- 테이블이 이미 존재하는지 확인

### 2. 프로덕션 환경 고려

**인덱스 생성 시간**:
- 데이터가 많은 경우 인덱스 생성에 시간이 걸릴 수 있음
- 프로덕션 환경에서는 점검 시간에 실행 권장

**인덱스 생성 중 영향**:
- 테이블에 대한 쓰기 작업은 가능하지만 성능 저하 가능
- 읽기 작업은 정상 작동

### 3. NULL 값 처리

**현재 코드**:
- `tenant_id IS NULL` 조회는 전체 테이블 스캔
- 데이터가 적으면 문제없지만, 많아지면 성능 고려 필요

**개선 방안** (필요 시):
- NULL 값 조회를 위한 별도 인덱스 고려
- 또는 NULL 값 자체를 줄이는 방향으로 개선

---

## 📝 다음 단계 (선택 사항)

### NULL 값 처리 개선

현재 코드에서는 `tenant_id`가 NULL인 경우를 처리하고 있지만, 데이터베이스 스키마와의 불일치가 있습니다.

**옵션 1**: 데이터베이스 스키마 변경
- `students.tenant_id`를 nullable로 변경
- 마이그레이션 필요
- RLS 정책 수정 필요

**옵션 2**: 코드에서 기본 테넌트 할당
- NULL 값 발견 시 기본 테넌트로 자동 할당
- `lib/utils/tenantAssignment.ts`에 로직 추가

**현재 상태**: 부분 인덱스로 성능 최적화 완료, NULL 값 처리는 기존 로직 유지

---

## ✅ 검증 완료 사항

1. ✅ 인덱스 마이그레이션 파일 생성 완료
2. ✅ 부분 인덱스 사용으로 최적화
3. ✅ 세 테이블 모두 인덱스 추가
4. ✅ 인덱스 주석 추가 (문서화)

---

## 📚 참고 문서

- [테넌트 사용자 관리 코드 리팩토링 완료](./20250115_테넌트_사용자_관리_코드_리팩토링_완료.md)
- [인덱스 최적화 분석](./index-optimization-analysis.md)
- [마이그레이션 검토 요약](./migration-review-summary.md)

---

**작업 완료**: Phase 3 (인덱스 추가) 완료  
**다음 작업**: 마이그레이션 실행 및 성능 측정 (선택 사항)




