# 교재 등록 폼 배열 필드 검증 에러 수정

## 작업 일시
2025-12-16 16:01:40

## 문제 상황
- **에러 메시지**: "Expected array, received string"
- **발생 위치**: `lib/validation/schemas.ts`의 `validateFormData` 함수
- **원인**: `formDataToObject` 함수가 배열 필드(`target_exam_type`, `tags`)를 처리하지 않아 문자열로 변환됨
- **데이터베이스 스키마**: `master_books.target_exam_type`과 `master_books.tags`는 PostgreSQL `ARRAY` 타입 (`_text`)
- **Zod 스키마**: `masterBookSchema`에서 `z.array(z.string()).optional().nullable()`로 정의됨

## 수정 내용

### 1. Import 추가
- `lib/utils/formDataHelpers.ts`에서 `getFormArray`, `getFormTags` 함수 import

### 2. 배열 필드 상수 정의
- `ARRAY_FIELDS`: 체크박스 그룹으로 처리되는 배열 필드 목록 (`target_exam_type`)
- `TAG_FIELDS`: 쉼표 구분 문자열로 처리되는 태그 필드 목록 (`tags`)

### 3. `formDataToObject` 함수 개선
- 중복 키 처리를 위해 `formData.keys()`를 사용하여 모든 키 수집
- 배열 필드 처리: `getFormArray` 함수를 사용하여 체크박스 그룹을 배열로 변환
- 태그 필드 처리: `getFormTags` 함수를 사용하여 쉼표 구분 문자열을 배열로 변환
- 빈 배열은 `null`로 변환하여 스키마 검증 통과

## 수정된 파일
- `lib/validation/schemas.ts`

## 주요 변경 사항

### Before
```typescript
export function formDataToObject(formData: FormData): Record<string, unknown> {
  const obj: Record<string, unknown> = {};
  for (const [key, value] of formData.entries()) {
    // 배열 필드 처리 없음 - 문자열로 변환됨
    const stringValue = String(value);
    // ...
  }
  return obj;
}
```

### After
```typescript
export function formDataToObject(formData: FormData): Record<string, unknown> {
  const obj: Record<string, unknown> = {};
  
  // 모든 키 수집 (중복 키 처리용)
  const keys = new Set<string>();
  for (const key of formData.keys()) {
    keys.add(key);
  }
  
  for (const key of keys) {
    // 배열 필드 처리 (체크박스 그룹)
    if (ARRAY_FIELDS.includes(key as typeof ARRAY_FIELDS[number])) {
      const values = getFormArray(formData, key);
      obj[key] = values.length > 0 ? values : null;
      continue;
    }
    
    // 태그 필드 처리 (쉼표 구분 문자열)
    if (TAG_FIELDS.includes(key as typeof TAG_FIELDS[number])) {
      obj[key] = getFormTags(formData, key);
      continue;
    }
    
    // 단일 값 처리
    // ...
  }
  return obj;
}
```

## 검증 방법
1. 교재 등록 페이지에서 폼 제출
2. 여러 시험 유형 체크박스 선택
3. 태그 필드에 쉼표로 구분된 값 입력
4. "Expected array, received string" 에러가 발생하지 않는지 확인
5. 데이터베이스에 배열로 저장되는지 확인

## 향후 확장성
- `ARRAY_FIELDS` 또는 `TAG_FIELDS` 배열에 필드명만 추가하면 다른 스키마에서도 재사용 가능
- `masterLectureSchema`에도 향후 `target_exam_type`과 `tags` 필드가 추가될 수 있음

