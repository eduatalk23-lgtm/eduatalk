# 블록 및 제외일 설정 개선 방안

## 📋 요구사항 정리

### 0. 시간 관리 데이터 불러오기

- **학습 제외일**: 학생이 플랜 그룹 생성 시 시간 관리에 저장된 학습 제외일을 불러올 수 있어야 함
- **학원 일정**: 학생이 플랜 그룹 생성 시 시간 관리에 저장된 학원 일정을 불러올 수 있어야 함

### 1. 캠프 템플릿 필드 제어

- **학원 일정**: 캠프 템플릿에서 학원 일정을 학생 입력 항목으로 지정 가능해야 함
- **학습 제외일**: 캠프 템플릿에서 학습 제외일을 학생 입력 항목으로 지정 가능해야 함
- **관리자 제외일 보호**: 캠프 템플릿에서 관리자가 추가한 학습 제외일은 삭제 불가해야 함

### 2. 학습 시간 제외 항목 개선

- **점심식사 제외**: 학습 시간 제외 항목에서 '점심식사' 유형을 제외해야 함
- **템플릿 사용/미사용**: 학습 시간 제외 항목을 캠프 템플릿에서 사용/미사용 설정 가능해야 함

---

## 🏗 아키텍처 개선 방안

### 1. 데이터 구조 확장

#### 1.1 `WizardData` 타입 확장

```typescript
export type WizardData = {
  // ... 기존 필드 ...

  // 템플릿 고정 필드 확장
  templateLockedFields?: {
    step1?: {
      /* ... */
    };
    step2?: {
      // 기존 필드
      exclusions?: boolean; // 전체 제외일 고정
      exclusion_items?: string[]; // 특정 제외일 ID 배열 (exclusion_date 기준)
      academy_schedules?: boolean; // 전체 학원 일정 고정
      academy_schedule_items?: string[]; // 특정 학원 일정 ID 배열
      time_settings?: boolean;
      time_settings_fields?: string[];

      // 신규 필드
      non_study_time_blocks?: boolean; // 학습 시간 제외 항목 사용/미사용
      allow_student_exclusions?: boolean; // 학생이 제외일 입력 가능 여부
      allow_student_academy_schedules?: boolean; // 학생이 학원 일정 입력 가능 여부
    };
    step3?: {
      /* ... */
    };
  };

  // 제외일 출처 구분 (템플릿/학생)
  exclusions?: Array<{
    exclusion_date: string;
    exclusion_type: "휴가" | "개인사정" | "휴일지정" | "기타";
    reason?: string;
    source?: "template" | "student" | "time_management"; // 출처 구분
    is_locked?: boolean; // 템플릿에서 고정된 제외일
  }>;

  // 학원 일정 출처 구분
  academy_schedules?: Array<{
    day_of_week: number;
    start_time: string;
    end_time: string;
    academy_name?: string;
    subject?: string;
    travel_time?: number;
    source?: "template" | "student" | "time_management"; // 출처 구분
    is_locked?: boolean; // 템플릿에서 고정된 학원 일정
  }>;
};
```

#### 1.2 데이터베이스 스키마 확장 (필요시)

```sql
-- camp_templates 테이블의 template_data JSON 구조 확장
-- 별도 컬럼 추가 불필요 (JSON 내부 구조로 관리)

-- student_exclusions 테이블 확인 (시간 관리용)
-- student_academy_schedules 테이블 확인 (시간 관리용)
```

### 2. 컴포넌트 개선

#### 2.1 `Step2BlocksAndExclusions` 컴포넌트

**주요 변경사항:**

1. **시간 관리 데이터 불러오기 버튼 추가**

   - 학습 제외일 불러오기 버튼 (이미 존재: `syncTimeManagementExclusionsAction`)
   - 학원 일정 불러오기 버튼 (이미 존재: `syncTimeManagementAcademySchedulesAction`)
   - 플랜 그룹 생성 시 자동 불러오기 옵션

2. **템플릿 모드 필드 제어**

   - `templateLockedFields.step2.allow_student_exclusions`에 따라 학생 입력 허용/불허
   - `templateLockedFields.step2.allow_student_academy_schedules`에 따라 학생 입력 허용/불허
   - 템플릿에서 추가된 제외일은 `is_locked: true`로 표시하고 삭제 불가

3. **학습 시간 제외 항목 개선**
   - '점심식사' 유형 제거
   - `templateLockedFields.step2.non_study_time_blocks`로 사용/미사용 제어

**구현 예시:**

```typescript
// Step2BlocksAndExclusions.tsx

// 1. 시간 관리 데이터 불러오기
const handleLoadTimeManagementData = async () => {
  // 제외일 불러오기
  const exclusionsResult = await syncTimeManagementExclusionsAction(
    groupId || "", // 새 플랜이면 빈 문자열
    periodStart,
    periodEnd
  );

  if (exclusionsResult.exclusions) {
    // 기존 제외일과 병합 (중복 제거)
    const existingDates = new Set(data.exclusions.map((e) => e.exclusion_date));
    const newExclusions = exclusionsResult.exclusions
      .filter((e) => !existingDates.has(e.exclusion_date))
      .map((e) => ({ ...e, source: "time_management" }));

    onUpdate({
      exclusions: [...data.exclusions, ...newExclusions],
    });
  }

  // 학원 일정 불러오기
  const academyResult = await syncTimeManagementAcademySchedulesAction(
    groupId || "",
    periodStart,
    periodEnd
  );

  if (academyResult.academySchedules) {
    onUpdate({
      academy_schedules: [
        ...data.academy_schedules,
        ...academyResult.academySchedules.map((s) => ({
          ...s,
          source: "time_management",
        })),
      ],
    });
  }
};

// 2. 제외일 삭제 제어
const removeExclusion = (index: number) => {
  const exclusion = data.exclusions[index];

  // 템플릿에서 고정된 제외일은 삭제 불가
  if (exclusion.is_locked || exclusion.source === "template") {
    alert("템플릿에서 지정된 제외일은 삭제할 수 없습니다.");
    return;
  }

  onUpdate({
    exclusions: data.exclusions.filter((_, i) => i !== index),
  });
};

// 3. 학습 시간 제외 항목 유형 필터링
const nonStudyTimeBlockTypes = [
  { value: "아침식사", label: "아침식사" },
  // "점심식사" 제외
  { value: "저녁식사", label: "저녁식사" },
  { value: "수면", label: "수면" },
  { value: "기타", label: "기타" },
] as const;
```

#### 2.2 `PlanGroupWizard` 컴포넌트

**주요 변경사항:**

1. **초기 데이터 로드 시 시간 관리 데이터 자동 불러오기 옵션**

   - 새 플랜 그룹 생성 시 자동으로 시간 관리 데이터 불러오기
   - 사용자 설정으로 토글 가능

2. **템플릿 모드에서 필드 제어 UI 추가**
   - Step 2에서 학원 일정/제외일 학생 입력 허용 체크박스
   - 학습 시간 제외 항목 사용/미사용 체크박스

#### 2.3 `Step1BasicInfo` 컴포넌트 (참고)

- 템플릿 모드에서 필드 고정 토글 UI 패턴 참고
- Step 2에도 동일한 패턴 적용

### 3. 서버 액션 개선

#### 3.1 시간 관리 데이터 불러오기 액션

**기존 액션 확인:**

- `syncTimeManagementExclusionsAction` - 이미 존재
- `syncTimeManagementAcademySchedulesAction` - 이미 존재

**개선 사항:**

- 새 플랜 그룹 생성 시에도 동작하도록 `groupId` 옵셔널 처리
- 반환 데이터에 `source` 필드 추가

#### 3.2 캠프 템플릿 저장/불러오기 액션

**개선 사항:**

- `templateLockedFields` 구조 확장 반영
- 제외일/학원 일정에 `source`, `is_locked` 필드 저장
- 학습 시간 제외 항목 사용/미사용 설정 저장

### 4. 데이터 흐름

#### 4.1 플랜 그룹 생성 시 (학생)

```
1. 새 플랜 그룹 생성 시작
   ↓
2. 시간 관리 데이터 불러오기 버튼 클릭 (또는 자동)
   ↓
3. syncTimeManagementExclusionsAction 호출
   → student_exclusions 테이블에서 기간 내 제외일 조회
   → source: "time_management"로 표시
   ↓
4. syncTimeManagementAcademySchedulesAction 호출
   → student_academy_schedules 테이블에서 학원 일정 조회
   → source: "time_management"로 표시
   ↓
5. 플랜 그룹 저장 시 제외일/학원 일정 함께 저장
```

#### 4.2 캠프 템플릿 사용 시 (학생)

```
1. 캠프 템플릿 기반 플랜 그룹 생성
   ↓
2. 템플릿 데이터 로드
   - template_data에서 exclusions, academy_schedules 로드
   - source: "template", is_locked: true로 표시
   ↓
3. templateLockedFields 확인
   - allow_student_exclusions: true → 학생 입력 허용
   - allow_student_academy_schedules: true → 학생 입력 허용
   ↓
4. 학생이 추가 입력 가능 (템플릿 제외일은 삭제 불가)
   ↓
5. 시간 관리 데이터 불러오기 가능 (선택사항)
```

---

## 🔧 구현 고려사항

### 1. 데이터 일관성

- **제외일 중복 방지**: 같은 날짜에 여러 출처의 제외일이 있을 때 처리 방법

  - 우선순위: template > time_management > student
  - 또는 병합 (템플릿 제외일 우선)

- **학원 일정 중복 방지**: 같은 요일/시간대에 여러 출처의 학원 일정이 있을 때
  - 병합 또는 사용자 선택

### 2. UI/UX 개선

- **출처 표시**: 각 제외일/학원 일정에 출처 아이콘/라벨 표시

  - 템플릿: 🔒 고정
  - 시간 관리: ⏰ 시간 관리
  - 학생 입력: ✏️ 직접 입력

- **삭제 불가 표시**: 템플릿에서 고정된 항목은 삭제 버튼 비활성화 또는 숨김

- **자동 불러오기 옵션**: 설정에서 자동 불러오기 토글

### 3. 성능 최적화

- **대량 데이터 처리**: 제외일/학원 일정이 많을 때 성능 고려
- **캐싱**: 시간 관리 데이터 캐싱 전략

### 4. 에러 처리

- **시간 관리 데이터 조회 실패**: 폴백 로직
- **템플릿 데이터 불일치**: 검증 및 복구 로직

---

## ✅ 개선 전 체크리스트

### 데이터 구조

- [ ] `WizardData` 타입에 `source`, `is_locked` 필드 추가
- [ ] `templateLockedFields.step2`에 신규 필드 추가
  - [ ] `allow_student_exclusions`
  - [ ] `allow_student_academy_schedules`
  - [ ] `non_study_time_blocks`
- [ ] 제외일/학원 일정 타입에 `source`, `is_locked` 필드 추가

### 컴포넌트

- [ ] `Step2BlocksAndExclusions` 컴포넌트
  - [ ] 시간 관리 데이터 불러오기 버튼 추가/개선
  - [ ] 제외일 삭제 시 `is_locked` 체크 로직 추가
  - [ ] 템플릿 모드에서 학생 입력 허용/불허 UI 추가
  - [ ] 학습 시간 제외 항목에서 '점심식사' 유형 제거
  - [ ] 학습 시간 제외 항목 사용/미사용 제어 로직 추가
  - [ ] 출처 표시 UI 추가 (템플릿/시간 관리/학생 입력)
- [ ] `PlanGroupWizard` 컴포넌트
  - [ ] 초기 데이터 로드 시 시간 관리 데이터 자동 불러오기 옵션
  - [ ] 템플릿 모드에서 필드 제어 UI 추가
- [ ] `Step1BasicInfo` 컴포넌트 (참고용)
  - [ ] 템플릿 모드 필드 고정 토글 UI 패턴 확인

### 서버 액션

- [ ] `syncTimeManagementExclusionsAction`
  - [ ] 새 플랜 그룹 생성 시에도 동작하도록 개선
  - [ ] 반환 데이터에 `source` 필드 추가
- [ ] `syncTimeManagementAcademySchedulesAction`
  - [ ] 새 플랜 그룹 생성 시에도 동작하도록 개선
  - [ ] 반환 데이터에 `source` 필드 추가
- [ ] 캠프 템플릿 저장/불러오기 액션
  - [ ] `templateLockedFields` 확장 구조 반영
  - [ ] 제외일/학원 일정에 `source`, `is_locked` 필드 저장/불러오기

### 데이터 검증

- [ ] 제외일 중복 방지 로직 (출처별 우선순위)
- [ ] 학원 일정 중복 방지 로직
- [ ] 템플릿 데이터 검증 로직

### UI/UX

- [ ] 출처 표시 아이콘/라벨 추가
- [ ] 삭제 불가 항목 시각적 표시
- [ ] 자동 불러오기 옵션 UI 추가
- [ ] 에러 메시지 개선

### 테스트

- [ ] 시간 관리 데이터 불러오기 테스트
- [ ] 템플릿 모드 필드 제어 테스트
- [ ] 제외일 삭제 제어 테스트
- [ ] 학습 시간 제외 항목 필터링 테스트
- [ ] 데이터 일관성 테스트

### 문서화

- [ ] 타입 정의 문서 업데이트
- [ ] 컴포넌트 사용 가이드 업데이트
- [ ] API 문서 업데이트

---

## 🚀 구현 우선순위

### Phase 1: 기본 기능 (필수)

1. 시간 관리 데이터 불러오기 기능 개선
2. 템플릿 모드에서 제외일 삭제 제어
3. 학습 시간 제외 항목에서 '점심식사' 제거

### Phase 2: 템플릿 제어 (중요)

4. 템플릿 모드에서 학원 일정/제외일 학생 입력 허용 설정
5. 학습 시간 제외 항목 사용/미사용 설정

### Phase 3: UX 개선 (선택)

6. 출처 표시 UI
7. 자동 불러오기 옵션
8. 에러 처리 개선

---

## 📝 추가 고려사항

### 1. 마이그레이션

- 기존 템플릿 데이터에 `source`, `is_locked` 필드가 없는 경우
- 기본값 설정: `source: "template"`, `is_locked: true`

### 2. 하위 호환성

- 기존 플랜 그룹 데이터와의 호환성 유지
- `source`, `is_locked` 필드가 없어도 동작하도록 옵셔널 처리

### 3. 성능

- 대량의 제외일/학원 일정 처리 시 성능 최적화
- 인덱스 활용 (데이터베이스)

### 4. 보안

- 템플릿 데이터 수정 권한 검증
- 학생이 템플릿 제외일 삭제 시도 시 차단

---

**작성일**: 2025-01-XX  
**작성자**: AI Assistant  
**버전**: 1.0
