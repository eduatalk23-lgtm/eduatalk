# 캠프 템플릿 작성 및 제출 로직 전체 점검

**작업 일시**: 2025-12-22  
**관련 이슈**: 
1. 학생은 캠프 템플릿을 작성 후 제출하고 플랜 생성 진행하지 않아야 함
2. 플랜 생성은 관리자 영역에서 관리자가 "남은 작업 이어하기"로 마무리해야 함
3. 학생 영역에서 바로 플랜을 생성해서 학습 시작 단계로 넘어가는 것으로 보이고 모순적으로 플랜 생성 완료와 참여하기가 공존하고 있음
4. 이 과정에서 관리자 영역에서 확인했을 때 해당 학생은 초대를 수락하지 않은 상태로 나타남

---

## 문제 분석

### 1. 학생 영역에서 플랜이 자동 생성되는 문제

**문제 상황**:
- 학생이 캠프 템플릿을 작성 완료 후 Step 7에 진입하면 플랜이 자동 생성됨
- `Step7ScheduleResult` 컴포넌트에서 `isAdminContinueMode`만 체크하고 `isCampMode`를 체크하지 않아서, 캠프 모드에서도 플랜을 자동 생성함

**원인 분석**:
- `Step7ScheduleResult` 컴포넌트의 `useEffect`에서 `isAdminContinueMode`가 아닐 때 플랜을 자동 생성
- 캠프 모드(학생)일 때는 플랜을 생성하지 않아야 하는데, 이 체크가 없음

**수정 내용**:

#### 1.1 Step7ScheduleResult.tsx 수정

**파일**: `app/(student)/plan/new-group/_components/_features/scheduling/Step7ScheduleResult.tsx`

**변경 사항**:
- `isCampMode` prop 추가
- 캠프 모드일 때는 플랜 자동 생성 스킵

```typescript
// 수정 전
type Step7ScheduleResultProps = {
  groupId: string;
  onComplete: () => void;
  isAdminContinueMode?: boolean;
};

// 수정 후
type Step7ScheduleResultProps = {
  groupId: string;
  onComplete: () => void;
  isAdminContinueMode?: boolean;
  isCampMode?: boolean;
};
```

```typescript
// 수정 전
useEffect(() => {
  if (isAdminContinueMode) {
    return;
  }
  // 일반 모드만 자동 생성
  // ...
}, [isAdminContinueMode, ...]);

// 수정 후
useEffect(() => {
  if (isAdminContinueMode) {
    return;
  }
  // 캠프 모드는 학생이 플랜을 생성하지 않으므로 자동 생성 스킵
  if (isCampMode) {
    return;
  }
  // 일반 모드만 자동 생성
  // ...
}, [isAdminContinueMode, isCampMode, ...]);
```

#### 1.2 BasePlanWizard.tsx 수정

**파일**: `app/(student)/plan/new-group/_components/BasePlanWizard.tsx`

**변경 사항**:
- `Step7ScheduleResult`에 `isCampMode` prop 전달

```typescript
// 수정 전
<Step7ScheduleResult
  groupId={draftGroupId}
  isAdminContinueMode={mode.isAdminContinueMode}
  onComplete={onComplete}
/>

// 수정 후
<Step7ScheduleResult
  groupId={draftGroupId}
  isAdminContinueMode={mode.isAdminContinueMode}
  isCampMode={mode.isCampMode}
  onComplete={onComplete}
/>
```

---

### 2. 캠프 모드에서 Step 4 제출 후 Step 7로 이동하지 않도록 수정

**문제 상황**:
- 캠프 모드에서 Step 4에서 제출하면 `generatePlans`를 호출하고 Step 7로 이동하려고 함
- 하지만 `generatePlans` 내부에서 `submitCampParticipation`을 호출하고 제출 완료 페이지로 이동하므로, Step 7로 이동하는 코드가 실행되지 않아야 함

**수정 내용**:

#### 2.1 usePlanSubmission.ts 수정

**파일**: `app/(student)/plan/new-group/_components/hooks/usePlanSubmission.ts`

**변경 사항**:
- 캠프 모드일 때는 `generatePlans` 호출 후 Step 7로 이동하지 않도록 수정

```typescript
// 수정 전
if (generatePlansFlag) {
  await generatePlans(finalGroupId);
  // 플랜 생성 후 Step 7로 이동 (리다이렉트는 Step 7 완료 버튼에서 처리)
  goToStep(7);
} else {
  goNext();
}

// 수정 후
if (generatePlansFlag) {
  await generatePlans(finalGroupId);
  // 캠프 모드(학생)일 때는 generatePlans 내부에서 제출 완료 페이지로 이동하므로
  // Step 7로 이동하지 않음
  if (!mode.isCampMode) {
    // 플랜 생성 후 Step 7로 이동 (리다이렉트는 Step 7 완료 버튼에서 처리)
    goToStep(7);
  }
  // 캠프 모드일 때는 generatePlans 내부에서 router.push로 이동하므로 여기서는 아무것도 하지 않음
} else {
  goNext();
}
```

---

### 3. 초대 상태 업데이트 문제

**문제 상황**:
- 학생이 캠프 템플릿 작성 완료 후 초대 상태가 "accepted"로 변경되지만, 관리자 영역에서 확인했을 때 수락하지 않은 상태로 나타남

**원인 분석**:
- `updateCampInvitationStatus` 함수는 `createSupabaseServerClient`를 사용하여 RLS 정책을 따름
- 학생이 자신의 초대 상태를 업데이트하는 것은 RLS 정책에 따라 가능해야 함
- 하지만 관리자 영역에서 조회할 때는 `createSupabaseAdminClient`를 사용하므로, 캐시가 갱신되지 않아 최신 상태가 반영되지 않을 수 있음

**확인 사항**:
- `updateCampInvitationStatus` 함수가 정상적으로 동작하는지 확인
- 관리자 영역에서 초대 목록을 조회할 때 캐시 무효화가 필요한지 확인

**수정 내용**:
- 이전에 `campActions.ts`에 `revalidatePath`를 추가하여 학생 영역의 캐시를 무효화했음
- 관리자 영역에서도 캐시 무효화가 필요할 수 있으나, 이는 별도로 확인 필요

---

## 수정된 파일 목록

1. `app/(student)/plan/new-group/_components/_features/scheduling/Step7ScheduleResult.tsx`
   - `isCampMode` prop 추가
   - 캠프 모드일 때 플랜 자동 생성 스킵

2. `app/(student)/plan/new-group/_components/BasePlanWizard.tsx`
   - `Step7ScheduleResult`에 `isCampMode` prop 전달

3. `app/(student)/plan/new-group/_components/hooks/usePlanSubmission.ts`
   - 캠프 모드일 때 Step 7로 이동하지 않도록 수정

---

## 동작 흐름

### 수정 전 (문제 상황)

1. 학생이 캠프 템플릿 작성 완료 (Step 4)
2. `handleSubmit` 호출 → `generatePlans` 호출
3. `generatePlans` 내부에서 `submitCampParticipation` 호출
4. `submitCampParticipation`에서 플랜 그룹 생성 및 초대 상태 업데이트
5. 제출 완료 페이지로 이동하려고 하지만, `handleSubmit`에서 Step 7로 이동하려고 함
6. Step 7에 진입하면 `Step7ScheduleResult`에서 플랜이 없어 자동 생성
7. 플랜이 생성되어 학습 시작 단계로 넘어감 (문제!)

### 수정 후 (정상 동작)

1. 학생이 캠프 템플릿 작성 완료 (Step 4)
2. `handleSubmit` 호출 → `generatePlans` 호출
3. `generatePlans` 내부에서 `submitCampParticipation` 호출
4. `submitCampParticipation`에서 플랜 그룹 생성 및 초대 상태 업데이트
5. 제출 완료 페이지(`/camp/${invitationId}/submitted`)로 이동
6. **Step 7로 이동하지 않음** (캠프 모드 체크 추가)
7. **Step 7에 진입하지 않으므로 플랜 자동 생성 안 함** (캠프 모드 체크 추가)
8. 관리자가 "남은 작업 이어하기"로 플랜 생성

---

## 테스트 체크리스트

- [ ] 학생이 캠프 템플릿을 작성 완료하면 플랜 그룹만 생성되고, 실제 플랜은 생성되지 않는지 확인
- [ ] 학생이 캠프 템플릿을 작성 완료하면 Step 7로 이동하지 않고 제출 완료 페이지로 이동하는지 확인
- [ ] 학생이 Step 7에 진입하지 않으므로 플랜이 자동 생성되지 않는지 확인
- [ ] 관리자가 "남은 작업 이어하기"로 플랜을 생성할 수 있는지 확인
- [ ] 학생이 캠프 템플릿 작성 완료 후 초대 상태가 "accepted"로 변경되고, 관리자 영역에서 최신 상태가 반영되는지 확인

---

## 참고 사항

- 캠프 모드에서는 학생이 플랜을 직접 생성하지 않고, 관리자가 나중에 생성하는 것이 정상 동작입니다.
- Step 7은 일반 모드에서만 사용되며, 캠프 모드(학생)에서는 Step 4가 마지막 단계입니다.
- 초대 상태 업데이트 후 캐시 무효화를 통해 최신 상태가 반영되도록 했습니다.

