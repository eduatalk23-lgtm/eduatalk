# 초대 상태 업데이트 RLS 정책 문제 수정

**작업 일시**: 2025-12-22  
**관련 이슈**: `updateCampInvitationStatus` 함수에서 UPDATE 후 SELECT가 RLS 정책에 의해 실패하는 문제

---

## 문제 분석

### 에러 로그

```
[data/campTemplates] updateCampInvitationStatus 실패: {
  invitationId: 'fb043067-23ab-413e-bb9f-16c9a3c7cb9c',
  status: 'accepted',
  error: 'Cannot coerce the result to a single JSON object',
  errorCode: 'PGRST116',
  errorDetails: 'The result contains 0 rows',
  errorHint: null
}
```

### 원인 분석

1. **UPDATE 후 SELECT 문제**
   - `updateCampInvitationStatus` 함수에서 UPDATE 후 `.select("id").single()`을 사용
   - UPDATE는 성공했지만, SELECT 시 RLS 정책에 의해 결과가 0개 행 반환
   - `PGRST116` 에러: "Cannot coerce the result to a single JSON object"

2. **RLS 정책 확인**
   - `camp_invitations_update_for_student` 정책은 정상적으로 작동
   - UPDATE는 성공하지만, UPDATE 후 SELECT는 RLS 정책에 의해 실패할 수 있음

---

## 해결 방법

### 수정 내용

**파일**: `lib/data/campTemplates.ts`

**변경 사항**:
- UPDATE 후 SELECT를 제거하고 `count`를 사용하여 업데이트된 행 수 확인
- `select("*", { count: "exact", head: true })` 사용

```typescript
// 수정 전
const { data, error } = await supabase
  .from("camp_invitations")
  .update(updateData)
  .eq("id", invitationId)
  .select("id")
  .single();

if (!data) {
  return {
    success: false,
    error: "초대 상태를 업데이트할 수 없습니다. 권한을 확인해주세요.",
  };
}

// 수정 후
const { error, count } = await supabase
  .from("camp_invitations")
  .update(updateData)
  .eq("id", invitationId)
  .select("*", { count: "exact", head: true });

if (count === 0) {
  return {
    success: false,
    error: "초대 상태를 업데이트할 수 없습니다. 권한을 확인해주세요.",
  };
}
```

**효과**:
- UPDATE 후 SELECT를 하지 않으므로 RLS 정책 문제 회피
- `count`를 사용하여 업데이트된 행 수 확인
- UPDATE가 성공했는지 정확하게 확인 가능

---

## 테스트 체크리스트

- [ ] 학생이 캠프 템플릿을 작성 완료하면 초대 상태가 "accepted"로 변경되는지 확인
- [ ] 관리자 영역에서 초대 상태가 "accepted"로 표시되는지 확인
- [ ] 초대 상태 업데이트 시 에러가 발생하지 않는지 확인

---

## 참고 사항

- UPDATE 후 SELECT는 RLS 정책에 의해 실패할 수 있으므로, count를 사용하는 것이 더 안전합니다.
- `select("*", { count: "exact", head: true })`는 데이터를 반환하지 않고 count만 반환하므로 RLS 정책 문제를 회피할 수 있습니다.




