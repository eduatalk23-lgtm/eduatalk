# ë§ˆìŠ¤í„° ì½˜í…ì¸  ë²”ìœ„ ì„¤ì • ì‹œ ì˜¬ë°”ë¥¸ API í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •

## ğŸ“‹ ì‘ì—… ê°œìš”

í•™ìƒì´ ì œì¶œí•œ í…œí”Œë¦¿ì— ì¶”ê°€ëœ ë§ˆìŠ¤í„° ì½˜í…ì¸ ì˜ íšŒì°¨ ì •ë³´ë¥¼ ì¡°íšŒí•  ë•Œ, ì˜¬ë°”ë¥¸ API(`/api/master-content-details`)ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

## ğŸ› ë¬¸ì œ ìƒí™©

### ì¦ìƒ

- í•™ìƒì´ ì œì¶œí•œ í…œí”Œë¦¿ì— ì¶”ê°€ëœ ë§ˆìŠ¤í„° ì½˜í…ì¸ 
- ë§ˆìŠ¤í„° ì„œë¹„ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ì½˜í…ì¸  (íšŒì°¨ ì •ë³´ê°€ ìˆìŒ)
- í•˜ì§€ë§Œ `RangeSettingModal`ì—ì„œ íšŒì°¨ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨

### ì›ì¸ ë¶„ì„

1. **ì˜ëª»ëœ ì½˜í…ì¸  ID ì‚¬ìš©**: 
   - í…œí”Œë¦¿ì—ì„œ í•™ìƒì´ ì¶”ê°€í•œ ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” `content_id`ê°€ í•™ìƒ ì½˜í…ì¸  IDì´ê³ , `master_content_id`ê°€ ì‹¤ì œ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID
   - `RangeSettingModal`ì— `content.content_id`ë¥¼ ì „ë‹¬í•˜ë©´ í•™ìƒ ì½˜í…ì¸  APIë¥¼ í˜¸ì¶œí•˜ê²Œ ë¨

2. **ì˜ëª»ëœ API ì„ íƒ**:
   - ë§ˆìŠ¤í„° ì½˜í…ì¸ ì¸ë° `isRecommendedContent={false}`ë¡œ ì„¤ì •ë˜ì–´ `/api/student-content-details` í˜¸ì¶œ
   - ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” `/api/master-content-details`ë¥¼ í˜¸ì¶œí•´ì•¼ í•¨

3. **RLS ìš°íšŒ ëˆ„ë½**:
   - `master-content-details` APIì—ì„œ ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ ì ‘ê·¼ ì‹œ RLS ìš°íšŒê°€ ì—†ìŒ

## âœ… í•´ê²° ë°©ë²•

### 1. RecommendedContentsPanel ìˆ˜ì •

**handleEditRange í•¨ìˆ˜**:

```typescript
// ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ê²°ì •: master_content_idê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ content_id ì‚¬ìš©
// í…œí”Œë¦¿ì—ì„œ í•™ìƒì´ ì¶”ê°€í•œ ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” content_idê°€ í•™ìƒ ì½˜í…ì¸  IDì´ê³  master_content_idê°€ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID
const masterContentId = content.master_content_id || content.content_id;

// allRecommendedContentsì—ì„œ ì›ë³¸ ì •ë³´ ì°¾ê¸°
// content_idë¡œ ë¨¼ì € ì°¾ê³ , ì—†ìœ¼ë©´ master_content_idë¡œ ì°¾ê¸°
const originalContent = allRecommendedContents.find(
  (c) => c.id === content.content_id || c.id === masterContentId
);

setRangeModalContent({
  id: masterContentId, // ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ì‚¬ìš©
  type: content.content_type as "book" | "lecture",
  title: content.title || "ì œëª© ì—†ìŒ",
  recommendedContent: originalContent,
  currentRange: {
    start: String(content.start_range),
    end: String(content.end_range),
    start_detail_id: content.start_detail_id,
    end_detail_id: content.end_detail_id,
  },
});
```

**handleRangeSave í•¨ìˆ˜**:

```typescript
// ê¸°ì¡´ ì½˜í…ì¸  ì°¾ê¸° (content_id ë˜ëŠ” master_content_idë¡œ ì°¾ê¸°)
const existingIndex = selectedContents.findIndex(
  (c) => c.content_id === id || c.master_content_id === id
);

// ì›ë³¸ ì½˜í…ì¸  ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©)
const originalContent = existingIndex >= 0 ? selectedContents[existingIndex] : null;

// content_id ê²°ì •: ê¸°ì¡´ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ê¸°ì¡´ content_id ìœ ì§€ (í•™ìƒ ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìŒ), ì—†ìœ¼ë©´ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ì‚¬ìš©
const contentId = originalContent?.content_id || id;

const newContent: SelectedContent = {
  content_type: type,
  content_id: contentId, // ê¸°ì¡´ content_id ìœ ì§€ (í•™ìƒ ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìŒ)
  start_range: Number(range.start.replace(/[^\d]/g, "")),
  end_range: Number(range.end.replace(/[^\d]/g, "")),
  start_detail_id: range.start_detail_id,
  end_detail_id: range.end_detail_id,
  title,
  subject_category: recommendedContent?.subject_category || undefined,
  master_content_id: id, // ë§ˆìŠ¤í„° ì½˜í…ì¸  ID (RangeSettingModalì—ì„œ ì‚¬ìš©í•œ ID)
  is_auto_recommended: false,
};
```

### 2. StudentContentsPanel ìˆ˜ì •

**handleEditRange í•¨ìˆ˜**:

```typescript
// ë§ˆìŠ¤í„° ì½˜í…ì¸ ì¸ ê²½ìš°: master_content_idê°€ ìˆìœ¼ë©´ ë§ˆìŠ¤í„° ì½˜í…ì¸ ë¡œ ì²˜ë¦¬
// í…œí”Œë¦¿ì—ì„œ í•™ìƒì´ ì¶”ê°€í•œ ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” content_idê°€ í•™ìƒ ì½˜í…ì¸  IDì´ê³  master_content_idê°€ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID
const isMasterContent = !!content.master_content_id;
const contentIdToUse = isMasterContent ? content.master_content_id! : content.content_id;

setRangeModalContent({
  id: contentIdToUse,
  type: content.content_type,
  title: content.title || contentInfo?.title || "ì œëª© ì—†ìŒ",
  currentRange: {
    start: String(content.start_range),
    end: String(content.end_range),
    start_detail_id: content.start_detail_id,
    end_detail_id: content.end_detail_id,
  },
  isMasterContent, // ë§ˆìŠ¤í„° ì½˜í…ì¸  ì—¬ë¶€ ì „ë‹¬
});
```

**RangeSettingModal ì „ë‹¬**:

```typescript
<RangeSettingModal
  content={rangeModalContent}
  isRecommendedContent={rangeModalContent.isMasterContent || false} // ë§ˆìŠ¤í„° ì½˜í…ì¸ ì¸ ê²½ìš° ë§ˆìŠ¤í„° API ì‚¬ìš©
  currentRange={rangeModalContent.currentRange}
  onSave={handleRangeSave}
  studentId={studentId}
/>
```

**handleRangeSave í•¨ìˆ˜**:

```typescript
const { id, type, title, isMasterContent } = rangeModalContent;

// ê¸°ì¡´ ì½˜í…ì¸  ì°¾ê¸° (content_id ë˜ëŠ” master_content_idë¡œ ì°¾ê¸°)
const existingIndex = currentContents.findIndex(
  (c) => c.content_id === id || c.master_content_id === id
);

// ì›ë³¸ ì½˜í…ì¸  ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©)
const originalContent = existingIndex >= 0 ? currentContents[existingIndex] : null;

// content_id ê²°ì •: ë§ˆìŠ¤í„° ì½˜í…ì¸ ì¸ ê²½ìš° ê¸°ì¡´ content_id ìœ ì§€ (í•™ìƒ ì½˜í…ì¸  ID), ì—†ìœ¼ë©´ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ì‚¬ìš©
const contentId = isMasterContent && originalContent?.content_id 
  ? originalContent.content_id 
  : (isMasterContent ? id : id);

const newContent: SelectedContent = {
  content_type: type,
  content_id: contentId, // ê¸°ì¡´ content_id ìœ ì§€ (í•™ìƒ ì½˜í…ì¸  IDì¼ ìˆ˜ ìˆìŒ)
  start_range: Number(range.start.replace(/[^\d]/g, "")),
  end_range: Number(range.end.replace(/[^\d]/g, "")),
  start_detail_id: range.start_detail_id,
  end_detail_id: range.end_detail_id,
  title,
  subject_category: metadata?.subject || undefined,
  master_content_id: isMasterContent 
    ? id // ë§ˆìŠ¤í„° ì½˜í…ì¸  ID (RangeSettingModalì—ì„œ ì‚¬ìš©í•œ ID)
    : (type === "book"
        ? contents.books.find((b) => b.id === contentId)?.master_content_id
        : contents.lectures.find((l) => l.id === contentId)?.master_content_id),
};
```

### 3. master-content-details APIì— RLS ìš°íšŒ ì§€ì› ì¶”ê°€

**ìˆ˜ì • ìœ„ì¹˜**: `app/api/master-content-details/route.ts`

```typescript
const supabase = await createSupabaseServerClient();

// ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ê°€ ë‹¤ë¥¸ í…Œë„ŒíŠ¸ì˜ ë§ˆìŠ¤í„° ì½˜í…ì¸ ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” Admin í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš© (RLS ìš°íšŒ)
const masterQueryClient = (role === "admin" || role === "consultant") 
  ? createSupabaseAdminClient() || supabase
  : supabase;

if (contentType === "book") {
  try {
    const result = await getMasterBookById(contentId, masterQueryClient);
    // ...
  }
} else if (contentType === "lecture") {
  try {
    const result = await getMasterLectureById(contentId, masterQueryClient);
    // ...
  }
}
```

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼

- `app/(student)/plan/new-group/_components/_features/content-selection/components/RecommendedContentsPanel.tsx`
  - `handleEditRange`: `master_content_id` ìš°ì„  ì‚¬ìš©
  - `handleRangeSave`: ê¸°ì¡´ `content_id` ìœ ì§€í•˜ë©´ì„œ `master_content_id` ì„¤ì •
- `app/(student)/plan/new-group/_components/_features/content-selection/components/StudentContentsPanel.tsx`
  - `handleEditRange`: ë§ˆìŠ¤í„° ì½˜í…ì¸  ê°ì§€ ë° `isMasterContent` í”Œë˜ê·¸ ì¶”ê°€
  - `RangeSettingModal`: `isRecommendedContent` ë™ì  ì„¤ì •
  - `handleRangeSave`: ë§ˆìŠ¤í„° ì½˜í…ì¸  ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
- `app/api/master-content-details/route.ts`
  - ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ ì ‘ê·¼ ì‹œ Admin í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš© (RLS ìš°íšŒ)

## ğŸ¯ í•´ê²°ëœ ë¬¸ì œ

### ì´ì „ ë™ì‘

1. í…œí”Œë¦¿ì—ì„œ í•™ìƒì´ ì¶”ê°€í•œ ë§ˆìŠ¤í„° ì½˜í…ì¸ ì˜ ë²”ìœ„ ìˆ˜ì • ì‹œë„
2. `content.content_id` (í•™ìƒ ì½˜í…ì¸  ID)ë¥¼ `RangeSettingModal`ì— ì „ë‹¬
3. `isRecommendedContent={false}`ë¡œ ì„¤ì •ë˜ì–´ `/api/student-content-details` í˜¸ì¶œ
4. í•™ìƒ ì½˜í…ì¸  APIì—ì„œ ë§ˆìŠ¤í„° ì½˜í…ì¸  IDë¡œ ì¡°íšŒ ì‹œë„ â†’ ì‹¤íŒ¨

### ì´í›„ ë™ì‘

1. í…œí”Œë¦¿ì—ì„œ í•™ìƒì´ ì¶”ê°€í•œ ë§ˆìŠ¤í„° ì½˜í…ì¸ ì˜ ë²”ìœ„ ìˆ˜ì • ì‹œë„
2. `content.master_content_id` (ë§ˆìŠ¤í„° ì½˜í…ì¸  ID)ë¥¼ `RangeSettingModal`ì— ì „ë‹¬
3. `isRecommendedContent={true}`ë¡œ ì„¤ì •ë˜ì–´ `/api/master-content-details` í˜¸ì¶œ
4. ë§ˆìŠ¤í„° ì½˜í…ì¸  APIì—ì„œ ì˜¬ë°”ë¥¸ íšŒì°¨ ì •ë³´ ì¡°íšŒ ì„±ê³µ

## ğŸ” ì½˜í…ì¸  ID ì²˜ë¦¬ ë¡œì§

### í…œí”Œë¦¿ì—ì„œ í•™ìƒì´ ì¶”ê°€í•œ ë§ˆìŠ¤í„° ì½˜í…ì¸ 

```
plan_contents í…Œì´ë¸”:
- content_id: í•™ìƒ ì½˜í…ì¸  ID (ì˜ˆ: books.id, lectures.id)
- master_content_id: ë§ˆìŠ¤í„° ì½˜í…ì¸  ID (ì˜ˆ: master_books.id, master_lectures.id)
```

### ì²˜ë¦¬ ë°©ì‹

1. **ë²”ìœ„ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°**:
   - `master_content_id`ê°€ ìˆìœ¼ë©´ â†’ ë§ˆìŠ¤í„° ì½˜í…ì¸  ID ì‚¬ìš©
   - `isRecommendedContent={true}` ì„¤ì • â†’ ë§ˆìŠ¤í„° API í˜¸ì¶œ

2. **ë²”ìœ„ ì €ì¥**:
   - ê¸°ì¡´ `content_id` ìœ ì§€ (í•™ìƒ ì½˜í…ì¸  ID)
   - `master_content_id` ì„¤ì • (ë§ˆìŠ¤í„° ì½˜í…ì¸  ID)
   - ë°ì´í„°ë² ì´ìŠ¤ ì¼ê´€ì„± ìœ ì§€

## ğŸ“ ì°¸ê³  ì‚¬í•­

- **ë°ì´í„° ì¼ê´€ì„±**: `content_id`ëŠ” í•™ìƒ ì½˜í…ì¸  IDë¥¼ ìœ ì§€í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ì¼ê´€ì„± ë³´ì¥
- **API ì„ íƒ**: ë§ˆìŠ¤í„° ì½˜í…ì¸ ëŠ” í•­ìƒ `/api/master-content-details` ì‚¬ìš©
- **RLS ìš°íšŒ**: ê´€ë¦¬ì/ì»¨ì„¤í„´íŠ¸ ì ‘ê·¼ ì‹œ Admin í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©ìœ¼ë¡œ RLS ì •ì±… ìš°íšŒ

---

**ì‘ì—… ì¼ì‹œ**: 2025-12-22  
**ì‘ì—…ì**: AI Assistant

