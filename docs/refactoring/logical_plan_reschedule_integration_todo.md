# 논리 플랜 & 재조정 기능 통합 TODO

## 📋 문서 정보

- **작성일**: 2025-01-22
- **버전**: 1.0
- **관련 문서**:
  - `docs/refactoring/03_phase_todo_list.md`
  - `docs/refactoring/reschedule_feature_todo.md`
  - `docs/total_refactoring_1209`

---

## 📊 개요

### 현재 상황

논리 플랜 기능과 재조정 기능이 유사한 목적을 가지고 있으나, 각각 다른 방식으로 구현되어 있습니다.

- **논리 플랜**: 인프라만 존재 (30% 완료), 날짜 범위 선택 재생성 의도
- **재조정 기능**: 거의 완료 (95% 완료), 전체 재생성만 가능

### 통합 목표

재조정 기능을 확장하여 논리 플랜의 의도된 기능(날짜 범위 선택 재생성)을 통합하고, 단일 통합 기능으로 제공합니다.

---

## 🔍 기능 비교 분석

### 1. 논리 플랜 (Logical Plan)

#### 의도 및 목적

- **설계 단위(콘텐츠 계획 단위)** 관리
- 플랜 그룹 내부의 콘텐츠 계획을 논리적으로 관리
- 예: "수학 교재 A 1단원 1~40p, 주 3회, 4회차로 쪼개서 2주간"

#### 데이터 모델

- **테이블**: `plan_group_items`
- **핵심 필드**:
  - `content_type`, `content_id`
  - `target_start_page_or_time`, `target_end_page_or_time`
  - `repeat_count`, `split_strategy`
  - `is_review`, `is_required`, `priority`
  - `display_order`

#### 제공 기능 (의도)

| 기능                       | 상태      | 설명                                     |
| -------------------------- | --------- | ---------------------------------------- |
| 논리 플랜 CRUD             | ✅ 완료   | 생성/수정/삭제/조회                      |
| 논리 플랜 UI               | ✅ 완료   | 목록, 폼 모달                            |
| 날짜 범위 선택             | ❌ 미구현 | 영향받는 날짜 범위 선택 UI               |
| 선택적 재생성              | ❌ 미구현 | 선택한 날짜 범위만 `student_plan` 재생성 |
| 완료 플랜 보호             | ❌ 미구현 | 완료된 플랜은 재생성 제외                |
| `origin_plan_item_id` 연결 | ❌ 미구현 | `student_plan` 생성 시 논리 플랜 참조    |

#### 사용 시점

- 만들어진 플랜 그룹에서 사용 중 조정
- 플랜 그룹 상태: `draft`, `saved` (의도)

#### 특징

- 설계 단위로 관리
- 날짜 범위 선택 가능 (의도)
- 부분 재생성 가능 (의도)

---

### 2. 재조정 기능 (Reschedule)

#### 의도 및 목적

- **실행 중인 플랜 그룹의 콘텐츠 수정 및 재생성**
- `plan_contents` 수정 후 `student_plan` 재생성
- 안전한 재조정 (히스토리, 롤백, 버전 관리)

#### 데이터 모델

- **테이블**: `plan_contents` (기존)
- **보조 테이블**:
  - `plan_history`: 변경 이력 백업
  - `reschedule_log`: 재조정 로그
  - `version_group_id`: 버전 관리

#### 제공 기능 (구현 완료)

| 기능            | 상태    | 설명                            |
| --------------- | ------- | ------------------------------- |
| 3단계 Wizard UI | ✅ 완료 | 콘텐츠 선택 → 조정 → 미리보기   |
| 콘텐츠 선택     | ✅ 완료 | 재조정할 콘텐츠 선택            |
| 범위 수정       | ✅ 완료 | `start_range`, `end_range` 수정 |
| 콘텐츠 교체     | ✅ 완료 | `content_id` 변경               |
| 전체 재생성     | ✅ 완료 | `change_type: 'full'`           |
| 미리보기        | ✅ 완료 | 변경 요약, 영향받는 날짜        |
| 히스토리 백업   | ✅ 완료 | `plan_history`에 백업           |
| 롤백 기능       | ✅ 완료 | 24시간 내 되돌리기              |
| 버전 관리       | ✅ 완료 | `version_group_id`로 추적       |
| 완료 플랜 보호  | ✅ 완료 | `status = 'completed'` 제외     |
| Advisory Lock   | ✅ 완료 | 동시 재조정 방지                |

#### 사용 시점

- 만들어진 플랜 그룹에서 사용 중 조정
- 플랜 그룹 상태: `draft`, `saved`, `active` 모두 가능

#### 특징

- 실행 단위로 관리
- 전체 재생성 (날짜 범위 선택 없음)
- 안전장치 포함 (히스토리, 롤백, 버전)

---

### 3. 핵심 차이점

| 항목        | 논리 플랜                  | 재조정 기능               |
| ----------- | -------------------------- | ------------------------- |
| 데이터 소스 | `plan_group_items`         | `plan_contents`           |
| 설계 개념   | 설계 단위 (콘텐츠 계획)    | 실행 단위 (콘텐츠 목록)   |
| 재생성 범위 | 날짜 범위 선택 가능 (의도) | 전체 재생성               |
| 완료도      | 30% (인프라만)             | 95% (거의 완료)           |
| 안전장치    | 없음                       | 히스토리, 롤백, 버전      |
| UI          | 단순 CRUD 목록             | 3단계 Wizard              |
| 사용 시점   | 동일 (만들어진 플랜 그룹)  | 동일 (만들어진 플랜 그룹) |

---

## 🎯 통합 전략

### 방향: 재조정 기능 확장 (권장)

논리 플랜의 날짜 범위 선택 기능을 재조정 기능에 통합합니다.

**장점**:

- 재조정 기능의 안전장치 활용
- 기존 UI/로직 재사용
- 단일 진입점으로 혼란 감소

---

## 📝 구현 TODO

### Phase 1: 날짜 범위 선택 기능 추가 (우선순위 P0)

**목표**: 재조정 기능에 날짜 범위 선택 기능 추가

**예상 기간**: 1-2일

**위험도**: 🟡 중간

#### [I1-1] 날짜 범위 선택 UI 컴포넌트 생성

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/DateRangeSelector.tsx` (신규)
- **작업**:
  - 캘린더 기반 날짜 범위 선택 컴포넌트
  - "전체 재생성" / "날짜 범위 선택" 토글
  - 완료된 플랜 날짜 자동 제외 표시
  - 연속된 날짜 범위 자동 그룹화
- **위험도**: 🟢 낮음
- **의존성**: 없음

#### [I1-2] Step 1에 날짜 범위 선택 옵션 추가

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/ContentSelectStep.tsx` (수정)
- **작업**:
  - 날짜 범위 선택 토글 추가
  - 선택한 날짜 범위를 state로 관리
  - 날짜 범위 선택 시 DateRangeSelector 컴포넌트 표시
- **위험도**: 🟡 중간
- **의존성**: I1-1 완료

#### [I1-3] 날짜 범위 필터링 로직 추가

- **파일**: `app/(student)/actions/plan-groups/reschedule.ts` (수정)
- **작업**:
  - `getReschedulePreview` 함수에 날짜 범위 파라미터 추가
  - 선택한 날짜 범위의 `student_plan`만 필터링
  - 완료된 플랜은 자동 제외
- **위험도**: 🟡 중간
- **의존성**: I1-2 완료

#### [I1-4] 선택적 재생성 로직 구현

- **파일**: `app/(student)/actions/plan-groups/reschedule.ts` (수정)
- **작업**:
  - `rescheduleContents` 함수에 날짜 범위 파라미터 추가 ✅
  - 선택한 날짜 범위의 `student_plan`만 필터링 ✅
  - 완료된 플랜은 보호 (비활성화하지 않음) ✅
  - 실제 플랜 생성 로직 통합 (TODO: 별도 작업으로 분리)
- **위험도**: 🔴 높음
- **의존성**: I1-3 완료
- **상태**: 부분 완료 (필터링 완료, 실제 생성 로직은 별도 작업)

#### [I1-5] 미리보기에 날짜 범위 정보 표시

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/PreviewStep.tsx` (수정)
- **작업**:
  - 선택한 날짜 범위 표시
  - 영향받는 날짜 목록 강조
  - 완료된 플랜 제외 정보 표시
- **위험도**: 🟢 낮음
- **의존성**: I1-4 완료

---

### Phase 2: 논리 플랜 기능 정리 (우선순위 P1)

**목표**: 논리 플랜 기능 제거 또는 숨김

**예상 기간**: 0.5일

**위험도**: 🟢 낮음

#### [I2-1] 논리 플랜 탭 숨김

- **파일**: `app/(student)/plan/group/[id]/_components/PlanGroupDetailView.tsx` (수정)
- **작업**:
  - 논리 플랜 탭 (탭 ID: 8) 숨김 처리 ✅
  - 탭 목록에서 제거 ✅
  - 탭 렌더링 부분 주석 처리 ✅
- **위험도**: 🟢 낮음
- **의존성**: 없음
- **상태**: ✅ 완료

#### [I2-2] 논리 플랜 관련 문서 업데이트

- **파일**: `docs/refactoring/03_phase_todo_list.md` (수정)
- **작업**:
  - 논리 플랜 기능이 재조정 기능으로 통합됨을 명시 ✅
  - 미구현 상태로 표시 ✅
- **위험도**: 🟢 낮음
- **의존성**: 없음
- **상태**: ✅ 완료

#### [I2-3] plan_group_items 테이블 유지 결정

- **파일**: 문서화
- **작업**:
  - `plan_group_items` 테이블은 유지 (향후 확장 가능) ✅
  - 데이터는 삭제하지 않음 ✅
  - 향후 설계 템플릿으로 활용 가능 ✅
  - 이 문서에 결정 사항 명시 ✅
- **위험도**: 🟢 낮음
- **의존성**: 없음
- **상태**: ✅ 완료

---

### Phase 3: 스마트 날짜 범위 추천 (우선순위 P2)

**목표**: 사용자가 날짜를 선택하기 쉽게 추천 기능 제공

**예상 기간**: 2-3일

**위험도**: 🟡 중간

#### [I3-1] 영향받는 날짜 자동 감지 로직

- **파일**: `lib/reschedule/dateRangeAnalyzer.ts` (신규)
- **작업**:
  - 재조정 대상 콘텐츠의 영향받는 날짜 자동 감지
  - 완료된 플랜 날짜 자동 제외
  - 연속된 날짜 범위 자동 그룹화
- **위험도**: 🟡 중간
- **의존성**: Phase 1 완료

#### [I3-2] 스마트 날짜 범위 추천 UI

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/SmartDateRangeSuggestions.tsx` (신규)
- **작업**:
  - 추천 날짜 범위 목록 표시
  - 각 추천 범위의 이유 표시
  - 원클릭 선택 기능
- **위험도**: 🟢 낮음
- **의존성**: I3-1 완료

#### [I3-3] 추천 알고리즘 고도화

- **파일**: `lib/reschedule/dateRangeAnalyzer.ts` (수정)
- **작업**:
  - 학습 지연 감지 기반 추천
  - 과부하/과소부하 감지 기반 추천
  - 시간 충돌 감지 기반 추천
- **위험도**: 🟡 중간
- **의존성**: I3-2 완료

---

### Phase 4: 실시간 미리보기 강화 (우선순위 P3)

**목표**: 변경 사항을 더 명확하게 확인할 수 있는 미리보기 제공

**예상 기간**: 3-4일

**위험도**: 🟡 중간

#### [I4-1] 변경 전/후 비교 시각화

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/BeforeAfterComparison.tsx` (신규)
- **작업**:
  - 변경 전/후 플랜 나란히 표시 ✅
  - 변경된 플랜 하이라이트 ✅
  - 변경 사항 요약 표시 ✅
- **위험도**: 🟡 중간
- **의존성**: Phase 1 완료
- **상태**: ✅ 완료

#### [I4-2] 영향받는 플랜 목록 표시

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/AffectedPlansList.tsx` (신규)
- **작업**:
  - 영향받는 플랜 목록 표시 ✅
  - 플랜별 변경 사항 상세 표시 ✅
  - 필터링 및 정렬 기능 ✅
- **위험도**: 🟢 낮음
- **의존성**: I4-1 완료
- **상태**: ✅ 완료

#### [I4-3] 예상 학습 시간 변화 표시

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/BeforeAfterComparison.tsx` (통합)
- **작업**:
  - 일일 학습 시간 변화 표시 ✅ (BeforeAfterComparison에 통합)
  - 총 학습 시간 변화 표시 ✅ (BeforeAfterComparison에 통합)
  - 그래프/차트로 시각화 (선택적, 향후 추가 가능)
- **위험도**: 🟡 중간
- **의존성**: I4-2 완료
- **상태**: ✅ 완료 (기본 기능 완료, 그래프는 선택적)

#### [I4-4] 충돌 감지 및 표시

- **파일**: `lib/reschedule/conflictDetector.ts` (신규)
- **작업**:
  - 시간 겹침 감지 ✅
  - 과부하 날짜 감지 ✅
  - 충돌 정보를 미리보기에 표시 ✅
  - 실제 플랜 목록이 있으면 더 정확한 감지 가능 (TODO)
- **위험도**: 🟡 중간
- **의존성**: I4-3 완료
- **상태**: ✅ 완료 (기본 기능 완료, 실제 플랜 목록 통합 후 정확도 향상)

---

### Phase 5: 일괄 조정 기능 (우선순위 P4)

**목표**: 여러 콘텐츠를 한 번에 조정할 수 있는 기능 제공

**예상 기간**: 2-3일

**위험도**: 🟡 중간

#### [I5-1] 일괄 선택 UI 추가

- **파일**: `app/(student)/plan/group/[id]/reschedule/_components/BatchSelection.tsx` (신규)
- **작업**:
  - 여러 콘텐츠 선택 체크박스
  - 전체 선택/해제 기능
  - 선택된 콘텐츠 수 표시
- **위험도**: 🟢 낮음
- **의존성**: Phase 1 완료

#### [I5-2] 일괄 범위 조정 로직

- **파일**: `lib/reschedule/batchAdjuster.ts` (신규)
- **작업**:
  - 비율 기반 범위 조정
  - 절대값 기반 범위 조정
  - 일괄 조정 미리보기
- **위험도**: 🟡 중간
- **의존성**: I5-1 완료

#### [I5-3] 일괄 콘텐츠 교체 로직

- **파일**: `lib/reschedule/batchAdjuster.ts` (수정)
- **작업**:
  - 여러 콘텐츠를 한 번에 교체
  - 교체 매핑 관리
  - 일괄 교체 미리보기
- **위험도**: 🟡 중간
- **의존성**: I5-2 완료

---

### Phase 6: 자동 재조정 제안 (우선순위 P5)

**목표**: 학습 지연 시 자동으로 재조정 제안

**예상 기간**: 5-7일

**위험도**: 🔴 높음

#### [I6-1] 학습 지연 감지 로직

- **파일**: `lib/reschedule/delayDetector.ts` (신규)
- **작업**:
  - 계획 대비 실제 진행률 계산
  - 지연 정도 측정
  - 지연 원인 분석
- **위험도**: 🔴 높음
- **의존성**: Phase 1 완료

#### [I6-2] 자동 재조정 제안 생성

- **파일**: `lib/reschedule/autoSuggester.ts` (신규)
- **작업**:
  - 지연 기반 재조정 제안 생성
  - 과부하/과소부하 기반 제안 생성
  - 제안 이유 설명 생성
- **위험도**: 🔴 높음
- **의존성**: I6-1 완료

#### [I6-3] 자동 제안 UI

- **파일**: `app/(student)/plan/group/[id]/_components/AutoRescheduleBanner.tsx` (신규)
- **작업**:
  - 자동 제안 배너 표시
  - 제안 이유 표시
  - 원클릭 적용 기능
- **위험도**: 🟡 중간
- **의존성**: I6-2 완료

#### [I6-4] 제안 알림 시스템

- **파일**: `app/(student)/plan/group/[id]/_components/RescheduleNotification.tsx` (신규)
- **작업**:
  - 재조정 제안 알림 표시
  - 알림 설정 관리
  - 알림 히스토리 관리
- **위험도**: 🟡 중간
- **의존성**: I6-3 완료

---

### Phase 7: 재조정 히스토리 분석 (우선순위 P6)

**목표**: 재조정 이력 분석 및 학습

**예상 기간**: 3-5일

**위험도**: 🟡 중간

#### [I7-1] 재조정 히스토리 시각화

- **파일**: `app/(student)/plan/group/[id]/_components/RescheduleHistory.tsx` (신규)
- **작업**:
  - 재조정 이력 목록 표시
  - 이력 상세 정보 표시
  - 이전 플랜 복원 기능
- **위험도**: 🟡 중간
- **의존성**: Phase 1 완료

#### [I7-2] 재조정 패턴 분석

- **파일**: `lib/reschedule/patternAnalyzer.ts` (신규)
- **작업**:
  - 재조정 빈도 분석
  - 자주 재조정되는 콘텐츠 식별
  - 재조정 패턴 분석
- **위험도**: 🟡 중간
- **의존성**: I7-1 완료

#### [I7-3] 개선 제안 생성

- **파일**: `lib/reschedule/patternAnalyzer.ts` (수정)
- **작업**:
  - 재조정 패턴 기반 개선 제안 생성
  - 자주 재조정되는 콘텐츠에 대한 제안
  - 플랜 그룹 생성 시 개선 제안
- **위험도**: 🟡 중간
- **의존성**: I7-2 완료

---

## 📊 구현 우선순위 요약

| 우선순위 | Phase   | 기능                     | 예상 기간 | 위험도  |
| -------- | ------- | ------------------------ | --------- | ------- |
| P0       | Phase 1 | 날짜 범위 선택 기능 추가 | 1-2일     | 🟡 중간 |
| P1       | Phase 2 | 논리 플랜 기능 정리      | 0.5일     | 🟢 낮음 |
| P2       | Phase 3 | 스마트 날짜 범위 추천    | 2-3일     | 🟡 중간 |
| P3       | Phase 4 | 실시간 미리보기 강화     | 3-4일     | 🟡 중간 |
| P4       | Phase 5 | 일괄 조정 기능           | 2-3일     | 🟡 중간 |
| P5       | Phase 6 | 자동 재조정 제안         | 5-7일     | 🔴 높음 |
| P6       | Phase 7 | 재조정 히스토리 분석     | 3-5일     | 🟡 중간 |

---

## 🎯 단기/중기/장기 계획

### 단기 (1-2주)

1. **Phase 1: 날짜 범위 선택 기능 추가** (P0)

   - 재조정 기능에 날짜 범위 선택 기능 추가
   - 선택한 날짜 범위만 재생성

2. **Phase 2: 논리 플랜 기능 정리** (P1)
   - 논리 플랜 탭 숨김
   - 관련 문서 업데이트

### 중기 (1-2개월)

3. **Phase 3: 스마트 날짜 범위 추천** (P2)

   - 영향받는 날짜 자동 감지
   - 추천 날짜 범위 제공

4. **Phase 4: 실시간 미리보기 강화** (P3)

   - 변경 전/후 비교 시각화
   - 영향받는 플랜 목록 표시
   - 예상 학습 시간 변화 표시
   - 충돌 감지 및 표시

5. **Phase 5: 일괄 조정 기능** (P4)
   - 여러 콘텐츠 일괄 선택
   - 일괄 범위 조정
   - 일괄 콘텐츠 교체

### 장기 (3-6개월)

6. **Phase 6: 자동 재조정 제안** (P5)

   - 학습 지연 감지
   - 자동 재조정 제안
   - 제안 알림 시스템

7. **Phase 7: 재조정 히스토리 분석** (P6)
   - 재조정 이력 시각화
   - 재조정 패턴 분석
   - 개선 제안 생성

---

## 📝 테스트 시나리오

### Phase 1 테스트

- [x] 날짜 범위 선택 UI 동작 확인 ✅
- [x] Step 1에 날짜 범위 선택 옵션 추가 확인 ✅
- [x] 날짜 범위 필터링 로직 동작 확인 ✅
- [ ] 선택한 날짜 범위만 재생성되는지 확인 (실제 플랜 생성 로직 통합 후)
- [x] 완료된 플랜이 보호되는지 확인 ✅
- [x] 전체 재생성 옵션 동작 확인 ✅
- [x] 미리보기에 날짜 범위 정보 표시 확인 ✅

### Phase 2 테스트

- [x] 논리 플랜 탭이 숨겨지는지 확인 ✅
- [x] 기존 논리 플랜 데이터가 유지되는지 확인 ✅

### Phase 3 테스트

- [ ] 영향받는 날짜 자동 감지 정확도 확인
- [ ] 추천 날짜 범위가 적절한지 확인
- [ ] 원클릭 선택 기능 동작 확인

### Phase 4 테스트

- [x] 변경 전/후 비교 시각화 정확도 확인 ✅
- [x] 영향받는 플랜 목록 정확도 확인 ✅
- [x] 예상 학습 시간 변화 계산 정확도 확인 ✅
- [x] 충돌 감지 정확도 확인 ✅ (기본 기능 완료, 실제 플랜 목록 통합 후 정확도 향상 필요)

### Phase 5 테스트

- [ ] 일괄 선택 기능 동작 확인
- [ ] 일괄 범위 조정 정확도 확인
- [ ] 일괄 콘텐츠 교체 정확도 확인

### Phase 6 테스트

- [ ] 학습 지연 감지 정확도 확인
- [ ] 자동 재조정 제안 적절성 확인
- [ ] 제안 알림 시스템 동작 확인

### Phase 7 테스트

- [ ] 재조정 히스토리 시각화 정확도 확인
- [ ] 재조정 패턴 분석 정확도 확인
- [ ] 개선 제안 적절성 확인

---

## 📚 참고 문서

- `docs/refactoring/03_phase_todo_list.md` - Phase 2 TODO 리스트
- `docs/refactoring/reschedule_feature_todo.md` - 재조정 기능 TODO
- `docs/total_refactoring_1209` - 통합 리팩토링 문서
- `lib/reschedule/scheduleEngine.ts` - 재조정 스케줄 엔진
- `app/(student)/actions/plan-groups/reschedule.ts` - 재조정 Server Actions

---

## 📝 변경 기록

| 날짜       | 버전 | 내용                                    |
| ---------- | ---- | --------------------------------------- |
| 2025-01-22 | 1.0  | 초안 작성                               |
| 2025-01-22 | 1.1  | Phase 1 완료 (날짜 범위 선택 기능 추가) |
| 2025-01-22 | 1.2  | Phase 2 완료 (논리 플랜 기능 정리)      |
| 2025-01-22 | 1.3  | Phase 3 완료 (스마트 날짜 범위 추천)    |
| 2025-01-22 | 1.4  | Phase 4 완료 (실시간 미리보기 강화)     |
