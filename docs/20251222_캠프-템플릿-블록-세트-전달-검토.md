# ìº í”„ í…œí”Œë¦¿ ì œì¶œ ì‹œ ë¸”ë¡ ì„¸íŠ¸ê°’ ì „ë‹¬ ê²€í† 

**ì‘ì—… ì¼ì‹œ**: 2024ë…„ 12ì›” 22ì¼  
**ì‘ì—…ì**: AI Assistant

## ğŸ“‹ ê²€í†  ê°œìš”

í•™ìƒì˜ ìº í”„ í…œí”Œë¦¿ ì œì¶œ ì‹œ, í…œí”Œë¦¿ì— ì„¤ì •ë˜ì–´ ìˆë˜ ë¸”ë¡ ì„¸íŠ¸ê°’ì´ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë˜ëŠ”ì§€ ì „ì²´ ë°ì´í„° íë¦„ì„ ê²€í† í–ˆìŠµë‹ˆë‹¤.

## ğŸ” ë°ì´í„° íë¦„ ë¶„ì„

### 1. í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ

**íŒŒì¼**: `app/(student)/actions/campActions.ts` (line 295-308)

```typescript
// ì—°ê²° í…Œì´ë¸”ì—ì„œ í…œí”Œë¦¿ì— ì—°ê²°ëœ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
let templateBlockSetId: string | null = null;
const { data: templateBlockSetLink } = await supabase
  .from("camp_template_block_sets")
  .select("tenant_block_set_id")
  .eq("camp_template_id", template.id)
  .maybeSingle();

if (templateBlockSetLink) {
  templateBlockSetId = templateBlockSetLink.tenant_block_set_id;
} else if (templateData.block_set_id) {
  // í•˜ìœ„ í˜¸í™˜ì„±: template_data.block_set_idë„ í™•ì¸ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°ì´í„°ìš©)
  templateBlockSetId = templateData.block_set_id;
}
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- ì—°ê²° í…Œì´ë¸”(`camp_template_block_sets`)ì—ì„œ ìš°ì„  ì¡°íšŒ
- í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ `template_data.block_set_id`ë„ í™•ì¸
- ë‘ ê²½ë¡œ ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë¨

### 2. mergedDataì— block_set_id ì„¤ì •

**íŒŒì¼**: `app/(student)/actions/campActions.ts` (line 349)

```typescript
const mergedData: Partial<WizardData> = {
  ...templateData,
  block_set_id: wizardData.block_set_id || templateBlockSetId || "",
  // ... ê¸°íƒ€ í•„ë“œ
};
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- í•™ìƒì´ ì„ íƒí•œ ë¸”ë¡ ì„¸íŠ¸(`wizardData.block_set_id`)ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
- ì—†ìœ¼ë©´ í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸(`templateBlockSetId`) ì‚¬ìš©
- ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ (ë¹ˆ ë¬¸ìì—´ì€ ë‚˜ì¤‘ì— nullë¡œ ë³€í™˜ë¨)

### 3. scheduler_optionsì— template_block_set_id ì¶”ê°€

**íŒŒì¼**: `app/(student)/actions/campActions.ts` (line 421-445)

```typescript
// í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDë¥¼ scheduler_optionsì— ë¨¼ì € ì¶”ê°€
// syncWizardDataToCreationData í˜¸ì¶œ ì „ì— ì¶”ê°€í•˜ì—¬ ë³´ì¡´ë˜ë„ë¡ í•¨
const blockSetId = mergedData.block_set_id || templateBlockSetId;
console.log("[campActions] template_block_set_id ì €ì¥ ì¤€ë¹„:", {
  blockSetId,
  mergedData_block_set_id: mergedData.block_set_id,
  templateBlockSetId,
  mergedData_scheduler_options_before: mergedData.scheduler_options,
});

if (blockSetId) {
  if (!mergedData.scheduler_options) {
    mergedData.scheduler_options = {};
  }
  if (
    typeof mergedData.scheduler_options === "object" &&
    mergedData.scheduler_options !== null
  ) {
    (
      mergedData.scheduler_options as Record<string, unknown>
    ).template_block_set_id = blockSetId;
  }
  console.log(
    "[campActions] mergedData.scheduler_optionsì— template_block_set_id ì¶”ê°€:",
    {
      template_block_set_id: blockSetId,
      scheduler_options: mergedData.scheduler_options,
    }
  );
}
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- `syncWizardDataToCreationData` í˜¸ì¶œ **ì „ì—** `scheduler_options.template_block_set_id`ì— ì¶”ê°€
- `mergedData.block_set_id` ë˜ëŠ” `templateBlockSetId` ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©
- ë””ë²„ê¹… ë¡œê·¸ í¬í•¨

### 4. syncWizardDataToCreationData í˜¸ì¶œ

**íŒŒì¼**: `app/(student)/actions/campActions.ts` (line 479-482)  
**ë³€í™˜ í•¨ìˆ˜**: `lib/utils/planGroupDataSync.ts` (line 22-269)

```typescript
const { syncWizardDataToCreationData } =
  await import("@/lib/utils/planGroupDataSync");
const creationData = syncWizardDataToCreationData(fullWizardData);
```

**ë³€í™˜ í•¨ìˆ˜ ë‚´ë¶€ ì²˜ë¦¬** (`lib/utils/planGroupDataSync.ts` line 44-63):

```typescript
// 1. scheduler_options êµ¬ì„±
const schedulerOptions: Record<string, unknown> = {
  ...(validatedData.scheduler_options || {}),
};

// study_review_cycleì„ scheduler_optionsì— ë³‘í•©
if (validatedData.study_review_cycle) {
  schedulerOptions.study_days = validatedData.study_review_cycle.study_days;
  schedulerOptions.review_days = validatedData.study_review_cycle.review_days;
}

// time_settingsë¥¼ scheduler_optionsì— ì•ˆì „í•˜ê²Œ ë³‘í•© (ë³´í˜¸ í•„ë“œ ìë™ ë³´í˜¸)
let finalSchedulerOptions = schedulerOptions;
if (validatedData.time_settings) {
  finalSchedulerOptions = mergeTimeSettingsSafely(
    schedulerOptions,
    validatedData.time_settings
  );
}
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- `validatedData.scheduler_options`ë¥¼ spreadí•˜ë¯€ë¡œ `template_block_set_id`ê°€ ë³´ì¡´ë¨
- `mergeTimeSettingsSafely` í•¨ìˆ˜ì—ì„œ `template_block_set_id`ëŠ” **ë³´í˜¸ í•„ë“œ**ë¡œ ì²˜ë¦¬ë¨
- ë³´í˜¸ í•„ë“œ ëª©ë¡: `["template_block_set_id", "camp_template_id"]` (`lib/utils/schedulerOptionsMerge.ts` line 13)

### 5. ë³´í˜¸ í•„ë“œ ì²˜ë¦¬ í™•ì¸

**íŒŒì¼**: `lib/utils/schedulerOptionsMerge.ts` (line 13, 87-100)

```typescript
const PROTECTED_FIELDS = ["template_block_set_id", "camp_template_id"];

// ë³´í˜¸ í•„ë“œ ì¶”ì¶œ (schedulerOptionsì— ì¡´ì¬í•˜ëŠ” ê²½ìš°ë§Œ)
const protectedFields = Object.fromEntries(
  PROTECTED_FIELDS.filter((key) => schedulerOptions[key] !== undefined).map(
    (key) => [key, schedulerOptions[key]]
  )
);

// ë³‘í•© (ë³´í˜¸ í•„ë“œ ì œì™¸)
const merged = {
  ...schedulerOptions,
  ...timeSettings,
  ...protectedFields, // ë³´í˜¸ í•„ë“œ ì¬ì ìš©
};
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- `template_block_set_id`ëŠ” ë³´í˜¸ í•„ë“œë¡œ ë“±ë¡ë˜ì–´ ìˆìŒ
- `time_settings` ë³‘í•© ì‹œì—ë„ ë³´ì¡´ë¨
- ë³´í˜¸ í•„ë“œê°€ ì¬ì ìš©ë˜ì–´ ë®ì–´ì“°ì´ì§€ ì•ŠìŒ

### 6. ì¶”ê°€ í™•ì¸ ë¡œì§

**íŒŒì¼**: `app/(student)/actions/campActions.ts` (line 649-688)

```typescript
// ìº í”„ ëª¨ë“œì—ì„œëŠ” block_set_idë¥¼ nullë¡œ ì„¤ì •
// í…œí”Œë¦¿ì˜ block_set_idëŠ” template_block_sets í…Œì´ë¸”ì˜ IDì´ë¯€ë¡œ
// plan_groups.block_set_id (student_block_sets ì°¸ì¡°)ì— ì €ì¥í•  ìˆ˜ ì—†ìŒ
creationData.block_set_id = null;

// template_block_set_idëŠ” ì´ë¯¸ mergedData.scheduler_optionsì— ì¶”ê°€ë˜ì–´ ìˆìŒ
// syncWizardDataToCreationDataì—ì„œ scheduler_optionsë¥¼ ë³‘í•©í•  ë•Œ ë³´ì¡´ë¨
// ì¶”ê°€ í™•ì¸: creationData.scheduler_optionsì— template_block_set_idê°€ ìˆëŠ”ì§€ í™•ì¸
type SchedulerOptionsWithTemplateBlockSet = SchedulerOptions & {
  template_block_set_id?: string;
};

const schedulerOptions = creationData.scheduler_options as
  | SchedulerOptionsWithTemplateBlockSet
  | null
  | undefined;
if (!schedulerOptions?.template_block_set_id && blockSetId) {
  console.warn(
    "[campActions] creationData.scheduler_optionsì— template_block_set_idê°€ ì—†ì–´ ì¶”ê°€:",
    {
      blockSetId,
      creationData_scheduler_options: creationData.scheduler_options,
    }
  );
  if (!creationData.scheduler_options) {
    creationData.scheduler_options = {};
  }
  (
    creationData.scheduler_options as SchedulerOptionsWithTemplateBlockSet
  ).template_block_set_id = blockSetId;
  console.log(
    "[campActions] creationData.scheduler_optionsì— template_block_set_id ì¶”ê°€ ì™„ë£Œ:",
    {
      scheduler_options: creationData.scheduler_options,
    }
  );
} else {
  console.log(
    "[campActions] creationData.scheduler_optionsì— template_block_set_id í™•ì¸ë¨:",
    {
      template_block_set_id: schedulerOptions?.template_block_set_id,
    }
  );
}
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- `syncWizardDataToCreationData` í˜¸ì¶œ í›„ `template_block_set_id` ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- ì—†ìœ¼ë©´ ë‹¤ì‹œ ì¶”ê°€í•˜ëŠ” ì•ˆì „ì¥ì¹˜ í¬í•¨
- ë””ë²„ê¹… ë¡œê·¸ í¬í•¨

### 7. DB ì €ì¥

**íŒŒì¼**: `lib/data/planGroups.ts` (line 380-422)

```typescript
export async function createPlanGroup(group: {
  // ... ê¸°íƒ€ í•„ë“œ
  scheduler_options?: SchedulerOptions | null;
  // ...
}): Promise<{ success: boolean; groupId?: string; error?: string }> {
  const payload: PlanGroupPayload = {
    // ... ê¸°íƒ€ í•„ë“œ
  };

  // scheduler_optionsê°€ ì‹¤ì œ ê°’ì´ ìˆìœ¼ë©´ ì¶”ê°€ (ë°ì´í„°ë² ì´ìŠ¤ì— ì»¬ëŸ¼ì´ ìˆì„ ê²½ìš°)
  // nullì´ë‚˜ undefinedê°€ ì•„ë‹ ë•Œë§Œ ì¶”ê°€
  if (
    group.scheduler_options !== undefined &&
    group.scheduler_options !== null
  ) {
    payload.scheduler_options = group.scheduler_options;
  }

  // ... DB ì €ì¥ ë¡œì§
}
```

**ê²€í†  ê²°ê³¼**: âœ… ì •ìƒ

- `scheduler_options`ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥
- `template_block_set_id`ê°€ í¬í•¨ëœ ìƒíƒœë¡œ ì €ì¥ë¨

## âœ… ê²€í†  ê²°ê³¼ ìš”ì•½

### ì •ìƒ ë™ì‘ í™•ì¸

1. **í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ**: âœ… ì •ìƒ
   - ì—°ê²° í…Œì´ë¸”ì—ì„œ ìš°ì„  ì¡°íšŒ
   - í•˜ìœ„ í˜¸í™˜ì„± ê²½ë¡œë„ í™•ì¸

2. **ë°ì´í„° ë³‘í•©**: âœ… ì •ìƒ
   - í•™ìƒ ì„ íƒê°’ ìš°ì„ , í…œí”Œë¦¿ê°’ fallback
   - `mergedData.block_set_id`ì— ì˜¬ë°”ë¥´ê²Œ ì„¤ì •

3. **scheduler_optionsì— ì¶”ê°€**: âœ… ì •ìƒ
   - `syncWizardDataToCreationData` í˜¸ì¶œ ì „ì— ì¶”ê°€
   - ë³´í˜¸ í•„ë“œë¡œ ë“±ë¡ë˜ì–´ ë®ì–´ì“°ì´ì§€ ì•ŠìŒ

4. **ë°ì´í„° ë³€í™˜**: âœ… ì •ìƒ
   - `syncWizardDataToCreationData`ì—ì„œ ë³´ì¡´ë¨
   - `mergeTimeSettingsSafely`ì—ì„œ ë³´í˜¸ í•„ë“œë¡œ ì²˜ë¦¬ë¨

5. **ì•ˆì „ì¥ì¹˜**: âœ… ì •ìƒ
   - ë³€í™˜ í›„ ì¶”ê°€ í™•ì¸ ë¡œì§
   - ì—†ìœ¼ë©´ ë‹¤ì‹œ ì¶”ê°€í•˜ëŠ” fallback

6. **DB ì €ì¥**: âœ… ì •ìƒ
   - `scheduler_options`ì— `template_block_set_id` í¬í•¨í•˜ì—¬ ì €ì¥

### ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```
í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ
  â†“
camp_template_block_sets í…Œì´ë¸” ì¡°íšŒ
  â†“
templateBlockSetId ì„¤ì •
  â†“
mergedData.block_set_id ì„¤ì • (wizardData ìš°ì„ )
  â†“
scheduler_options.template_block_set_id ì¶”ê°€ (ë³´í˜¸ í•„ë“œ)
  â†“
syncWizardDataToCreationData í˜¸ì¶œ
  â†“
mergeTimeSettingsSafely (ë³´í˜¸ í•„ë“œ ë³´ì¡´)
  â†“
ì¶”ê°€ í™•ì¸ ë¡œì§ (fallback)
  â†“
DB ì €ì¥ (plan_groups.scheduler_options)
```

## ğŸ” ì ì¬ì  ì´ìŠˆ ë° ê°œì„  ì‚¬í•­

### í˜„ì¬ êµ¬í˜„ì˜ ê°•ì 

1. **ë‹¤ì¤‘ ê²½ë¡œ ì¡°íšŒ**: ì—°ê²° í…Œì´ë¸” + í•˜ìœ„ í˜¸í™˜ì„± ê²½ë¡œ
2. **ë³´í˜¸ í•„ë“œ ë©”ì»¤ë‹ˆì¦˜**: `template_block_set_id`ê°€ ë®ì–´ì“°ì´ì§€ ì•Šë„ë¡ ë³´í˜¸
3. **ì•ˆì „ì¥ì¹˜**: ë³€í™˜ í›„ ì¶”ê°€ í™•ì¸ ë¡œì§
4. **ë””ë²„ê¹… ë¡œê·¸**: ê° ë‹¨ê³„ì—ì„œ ìƒì„¸í•œ ë¡œê·¸ ì¶œë ¥

### ê°œì„  ì œì•ˆ (ì„ íƒì‚¬í•­)

1. **íƒ€ì… ì•ˆì „ì„± ê°•í™”**
   - `SchedulerOptions` íƒ€ì…ì— `template_block_set_id` í•„ë“œ ì¶”ê°€ ê³ ë ¤
   - í˜„ì¬ëŠ” íƒ€ì… ë‹¨ì–¸ìœ¼ë¡œ ì²˜ë¦¬ ì¤‘

2. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**
   - ë¸”ë¡ ì„¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
   - ì‚¬ìš©ìì—ê²Œ ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ

3. **í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¶”ê°€**
   - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: `syncWizardDataToCreationData`ì—ì„œ ë³´í˜¸ í•„ë“œ ë³´ì¡´ í™•ì¸
   - í†µí•© í…ŒìŠ¤íŠ¸: ì „ì²´ ë°ì´í„° íë¦„ ê²€ì¦

## ğŸ“ ê²°ë¡ 

**ìº í”„ í…œí”Œë¦¿ ì œì¶œ ì‹œ ë¸”ë¡ ì„¸íŠ¸ê°’ì´ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤.**

ì „ì²´ ë°ì´í„° íë¦„ì„ ê²€í† í•œ ê²°ê³¼:

- í…œí”Œë¦¿ ë¸”ë¡ ì„¸íŠ¸ IDê°€ ì •ìƒì ìœ¼ë¡œ ì¡°íšŒë¨
- `scheduler_options.template_block_set_id`ì— ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë¨
- ë³´í˜¸ í•„ë“œ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ë®ì–´ì“°ì´ì§€ ì•ŠìŒ
- DBì— ì •ìƒì ìœ¼ë¡œ ì €ì¥ë¨

í˜„ì¬ êµ¬í˜„ì€ ì•ˆì •ì ì´ë©°, ë³´í˜¸ í•„ë“œ ë©”ì»¤ë‹ˆì¦˜ê³¼ ì•ˆì „ì¥ì¹˜ê°€ ì˜ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.

## ğŸ”— ê´€ë ¨ íŒŒì¼

- `app/(student)/actions/campActions.ts` - ìº í”„ ì°¸ì—¬ ì •ë³´ ì œì¶œ ë¡œì§
- `lib/utils/planGroupDataSync.ts` - WizardData â†’ CreationData ë³€í™˜
- `lib/utils/schedulerOptionsMerge.ts` - ë³´í˜¸ í•„ë“œ ì²˜ë¦¬
- `lib/data/planGroups.ts` - í”Œëœ ê·¸ë£¹ ìƒì„± ë° ì €ì¥
- `lib/camp/campAdapter.ts` - ìº í”„ ë¸”ë¡ ì„¸íŠ¸ ID ì¡°íšŒ (3ë‹¨ê³„ ìš°ì„ ìˆœìœ„)

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [ìº í”„ í…œí”Œë¦¿ ë¸”ë¡ ì €ì¥ ë° ì¡°íšŒ ê²½ë¡œ ë¶„ì„](./camp-template-blocks-storage-analysis.md)
- [ìº í”„ í…œí”Œë¦¿ ì œì¶œ í›„ ì‹œê°„ë¸”ë¡ í‘œì‹œ ê°œì„ ](./camp-submission-template-blocks-fix.md)
- [ìº í”„ í…œí”Œë¦¿ í•™ìŠµ ì œì™¸ì¼ ê²€ì¦ ê°œì„ ](./20251222_055520-ìº í”„-í…œí”Œë¦¿-í•™ìŠµ-ì œì™¸ì¼-ê²€ì¦-ê°œì„ .md)
