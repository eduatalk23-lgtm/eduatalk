# 플래너/플랜 관리 기능 고도화 설계서

## 1. 개요

### 1.1 목적
관리자 영역의 플래너/플랜 관리 시스템을 고도화하여 시간 기반의 직관적인 플랜 배치 및 조율 기능을 제공한다.

### 1.2 핵심 개선 사항
- DailyDock 내 드래그앤드롭 순서 변경
- 순서 변경 시 시간 자동 재계산
- 비학습시간 인라인 조율
- 빈 시간 슬롯에 플랜 추가
- 비학습시간 단일 소스 관리 (플래너 레벨)

---

## 2. 현재 시스템 분석

### 2.1 현재 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            현재 구조                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  플래너 (Planner)                                                        │
│  ├── non_study_time_blocks[]     ─┐                                     │
│  ├── academy_schedules[]          │  복사                                │
│  └── exclusions[]                ─┘    ↓                                │
│                                                                          │
│  플랜 그룹 (Plan Group)                                                  │
│  ├── non_study_time_blocks[]     ← 사본 (동기화 문제)                    │
│  ├── academy_schedules[]         ← 사본                                 │
│  └── exclusions[]                ← 사본                                 │
│                                                                          │
│  DailyDock                                                               │
│  ├── 드래그앤드롭: 컨테이너 간 이동만 ⚠️                                 │
│  ├── 순서 변경: 미지원 ❌                                                │
│  ├── 시간 재계산: 미지원 ❌                                              │
│  └── 비학습시간 조율: 읽기 전용 ❌                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 현재 데이터 필드

| 테이블 | 필드 | 용도 |
|--------|------|------|
| `student_plan` | `estimated_minutes` | 예상 소요 시간 (분) |
| `student_plan` | `sequence` | 표시 순서 |
| `student_plan` | `block_index` | 시간 블록 인덱스 |
| `planners` | `non_study_time_blocks` | 비학습시간 (JSONB) |
| `planners` | `study_hours` | 학습 시간대 |
| `planner_academy_schedules` | - | 학원 일정 |

---

## 3. 개선 설계

### 3.1 핵심 원칙

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   ⭐ 핵심 원칙: 학생의 하루는 "하나"                                      │
│                                                                          │
│   • 비학습시간 = 플래너(학생) 레벨에서 단일 관리                          │
│   • 플랜 그룹 = 비학습시간을 "참조"만 함                                  │
│   • 날짜별 예외 = 플래너 레벨 오버라이드                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 개선된 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          개선된 구조                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  플래너 (Planner) ─────────────────────── Single Source of Truth        │
│  │                                                                       │
│  ├── 비학습시간 (전역)                                                   │
│  │   ├── 식사시간 (아침/점심/저녁)                                       │
│  │   ├── 학원일정 + 이동시간                                            │
│  │   ├── 개인활동 (운동, 취미 등)                                        │
│  │   └── 기타 (수면 등)                                                 │
│  │                                                                       │
│  ├── 날짜별 오버라이드 (신규)                                            │
│  │   └── 특정 날짜의 예외 설정                                          │
│  │                                                                       │
│  └── 플랜 그룹들                                                        │
│      │       ↑ 참조 (조회만)                                            │
│      ├── 수학 플랜그룹                                                  │
│      ├── 영어 플랜그룹                                                  │
│      └── ...                                                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 비학습시간 관리 계층

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  Level 1: 플래너 기본값 (전역)                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│  │  • 매일 적용되는 기본 설정                                           │
│  │  • day_of_week 없음 = 전체 적용                                      │
│  │                                                                       │
│  │  예: 점심 12:00-13:00 (매일)                                         │
│  │      저녁 18:00-19:00 (매일)                                         │
│  │                                                                       │
│  ▼                                                                       │
│  Level 2: 요일별 설정 (반복)                                             │
│  ─────────────────────────────────────────────────────────────────────  │
│  │  • 특정 요일에만 적용                                                │
│  │  • day_of_week: [1,3,5] = 월,수,금                                   │
│  │                                                                       │
│  │  예: 수학학원 15:00-17:00 (월,수,금)                                  │
│  │      운동 17:00-18:00 (월,수,금)                                      │
│  │                                                                       │
│  ▼                                                                       │
│  Level 3: 날짜별 오버라이드 (예외)           ← 신규                      │
│  ─────────────────────────────────────────────────────────────────────  │
│     • 특정 날짜에만 적용되는 예외                                        │
│     • 기존 설정을 덮어쓰거나 비활성화                                     │
│                                                                          │
│     예: 2/14 점심 12:30-14:00 (약속)                                    │
│         2/17 학원 비활성화 (휴원)                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 기능 상세 설계

### 4.1 DailyDock 내 드래그앤드롭 순서 변경

#### 현재 vs 개선

```
┌─────────────────────────────────────────────────────────────────────────┐
│  현재                              개선                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  DailyDock ↔ WeeklyDock            DailyDock 내부                        │
│  (컨테이너 간 이동)                 (순서 재정렬)                          │
│                                                                          │
│  ┌─────────┐    ┌─────────┐       ┌─────────┐                           │
│  │ Daily   │ ←→ │ Weekly  │       │ ≡ 영어  │ ←┐                        │
│  └─────────┘    └─────────┘       │ ≡ 수학  │  │ 순서                   │
│                                    │ ≡ 휴식  │  │ 변경                   │
│                                    │ ≡ 과학  │ ←┘                        │
│                                    └─────────┘                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### UI 상세

```
┌─────────────────────────────────────────────────────────────────────────┐
│  DailyDock - 2025-02-14 (금)                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  ≡  📘 영어 독해 (60분)                              09:00-10:00 │    │
│  │     진도: p.45-60                                         ○     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              ↕ 드래그                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  ≡  📗 수학 미적분 (45분)                            10:00-10:45 │    │
│  │     진도: 3단원 연습문제                                   ○     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              ↕ 드래그                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  ☕  휴식 (15분)                                     10:45-11:00 │    │
│  │                                                           ✏️     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              ↕ 드래그                                    │
│  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐    │
│  │                                                                  │    │
│  │     ➕ 빈 시간 (60분)                               11:00-12:00  │    │
│  │        클릭하여 플랜 추가                                        │    │
│  │                                                                  │    │
│  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  🍚  점심 (60분)                                    12:00-13:00 │    │
│  │                                                      🔒   ✏️     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│     ≡ = 드래그 핸들    ○ = 미완료    ● = 완료    🔒 = 고정    ✏️ = 수정   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 순서 변경 시 시간 자동 재계산

#### 계산 로직

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  시작 기준: 플래너 학습 시작 시간 (예: 09:00)                             │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  재정렬 전                         재정렬 후                      │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │                                                                  │    │
│  │  seq:1  영어 60분  09:00-10:00     seq:1  수학 45분  09:00-09:45 │    │
│  │  seq:2  수학 45분  10:00-10:45     seq:2  영어 60분  09:45-10:45 │    │
│  │  seq:3  휴식 15분  10:45-11:00     seq:3  휴식 15분  10:45-11:00 │    │
│  │                                                                  │    │
│  │         ↓ 수학을 1번으로 드래그                                   │    │
│  │                                                                  │    │
│  │  재계산 공식:                                                    │    │
│  │  ────────────────────────────────────────────────────────────── │    │
│  │  item[0].start = dayStartTime                                   │    │
│  │  item[0].end   = item[0].start + item[0].duration               │    │
│  │  item[n].start = item[n-1].end                                  │    │
│  │  item[n].end   = item[n].start + item[n].duration               │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ⚠️ 고정 시간 블록 (점심, 학원) 고려:                                     │
│  • 고정 블록 이전까지만 자동 배치                                        │
│  • 고정 블록 이후 시간에 나머지 배치                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 고정 블록 처리 예시

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  09:00  ████ 영어 60분                                                  │
│  10:00  ████ 수학 45분                                                  │
│  10:45  ████ 휴식 15분        ← 여기까지 자동 배치                       │
│  11:00  ░░░░ [빈 시간 60분]                                             │
│  12:00  ▓▓▓▓ 점심 60분 🔒     ← 고정 블록 (이동 불가)                   │
│  13:00  ████ 과학 45분        ← 고정 블록 이후 자동 배치                 │
│  13:45  ░░░░ [빈 시간 75분]                                             │
│  15:00  ▓▓▓▓ 학원 120분 🔒    ← 고정 블록                               │
│  17:00  ...                                                             │
│                                                                          │
│  범례: ████ 플랜  ░░░░ 빈시간  ▓▓▓▓ 고정(비학습)                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 비학습시간 인라인 조율

#### 수정 모달

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🍚 점심시간 수정                                                  ✕    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  현재 설정                                                       │    │
│  │  시작: 12:00    종료: 13:00    (60분)                           │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  변경할 값                                                       │    │
│  │                                                                  │    │
│  │  시작: [ 12:30 ▼ ]    종료: [ 14:00 ▼ ]    (90분)               │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  적용 범위                                                       │    │
│  │                                                                  │    │
│  │  ● 오늘만 적용 (2025-02-14)                                     │    │
│  │    이 날짜에만 예외로 적용됩니다.                                 │    │
│  │                                                                  │    │
│  │  ○ 플래너 전체 적용                                             │    │
│  │    기본 설정을 변경합니다.                                       │    │
│  │    □ 이미 생성된 플랜의 시간도 재조정                            │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│                                           [취소]    [적용]               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 비활성화 옵션 (학원 휴원 등)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🏫 수학학원 수정                                                  ✕    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  현재 설정                                                       │    │
│  │  15:00 - 17:00 (120분) + 이동시간 30분                          │    │
│  │  적용 요일: 월, 수, 금                                          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  이 날짜 설정 (2025-02-14 금)                                   │    │
│  │                                                                  │    │
│  │  ☑️ 이 날짜에 비활성화 (휴원)                                    │    │
│  │                                                                  │    │
│  │  사유: [ 학원 방학                    ]                         │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ℹ️ 비활성화하면 해당 시간이 학습 가능 시간으로 전환됩니다.               │
│                                                                          │
│                                           [취소]    [적용]               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 빈 시간 플랜 추가

#### 빈 시간 클릭 시 팝오버

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐    │
│  │     ➕ 빈 시간 (60분)                               11:00-12:00  │    │
│  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘    │
│                        │                                                 │
│                        ▼                                                 │
│           ┌────────────────────────────────┐                            │
│           │  11:00 - 12:00 (60분)          │                            │
│           ├────────────────────────────────┤                            │
│           │                                │                            │
│           │  ➕ 새 플랜 생성               │ → 플랜 생성 모달            │
│           │                                │                            │
│           │  📋 미완료 플랜 배치           │ → 미완료독 선택             │
│           │                                │                            │
│           │  📦 주간독에서 가져오기        │ → 주간독 선택               │
│           │                                │                            │
│           │  ☕ 휴식/비학습시간 추가       │ → 비학습시간 추가           │
│           │                                │                            │
│           └────────────────────────────────┘                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 모델 변경

### 5.1 신규 테이블: 날짜별 오버라이드

```sql
-- 날짜별 비학습시간/학원일정 오버라이드
CREATE TABLE planner_daily_overrides (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  planner_id UUID NOT NULL REFERENCES planners(id) ON DELETE CASCADE,
  override_date DATE NOT NULL,

  -- 오버라이드 대상
  override_type TEXT NOT NULL,  -- 'non_study_time' | 'academy' | 'lunch'
  source_index INT,             -- non_study_time_blocks 배열 인덱스
  source_academy_id UUID,       -- academy_schedule 참조

  -- 오버라이드 값
  is_disabled BOOLEAN DEFAULT FALSE,
  start_time_override TIME,
  end_time_override TIME,
  reason TEXT,

  -- 메타
  created_by UUID,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(planner_id, override_date, override_type, source_index)
);

-- 인덱스
CREATE INDEX idx_planner_daily_overrides_date
  ON planner_daily_overrides(planner_id, override_date);
```

### 5.2 기존 테이블 변경 없음

| 테이블 | 변경 사항 |
|--------|----------|
| `student_plan` | 변경 없음 (`sequence`, `estimated_minutes` 활용) |
| `planners` | 변경 없음 |
| `plan_groups` | 비학습시간 복사 로직 제거 (참조로 변경) |

---

## 6. 주요 API / Server Actions

### 6.1 순서 재정렬

```typescript
// 순서 재정렬 + 시간 재계산
interface ReorderPlansInput {
  plannerId: string;
  date: string;
  orderedPlanIds: string[];  // 새로운 순서
}

interface ReorderPlansResult {
  success: boolean;
  updatedPlans: Array<{
    id: string;
    sequence: number;
    calculatedStartTime: string;
    calculatedEndTime: string;
  }>;
}
```

### 6.2 비학습시간 오버라이드

```typescript
// 날짜별 오버라이드 생성/수정
interface CreateOverrideInput {
  plannerId: string;
  date: string;
  overrideType: 'non_study_time' | 'academy' | 'lunch';
  sourceIndex?: number;
  sourceAcademyId?: string;
  isDisabled?: boolean;
  startTimeOverride?: string;
  endTimeOverride?: string;
  reason?: string;
}

// 플래너 전역 수정
interface UpdatePlannerNonStudyTimeInput {
  plannerId: string;
  blockIndex: number;
  updates: {
    startTime?: string;
    endTime?: string;
    dayOfWeek?: number[];
  };
  syncToExistingPlans?: boolean;  // 기존 플랜 시간 재조정
}
```

### 6.3 빈 시간 조회

```typescript
// 특정 날짜의 빈 시간 슬롯 조회
interface GetEmptySlotsInput {
  plannerId: string;
  date: string;
}

interface EmptySlot {
  startTime: string;
  endTime: string;
  durationMinutes: number;
  afterPlanId?: string;  // 이 플랜 다음 위치
}
```

---

## 7. 전체 플로우 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│                         전체 시스템 플로우                                │
│                                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────┐                                                     │
│  │  플래너 설정    │                                                     │
│  │  (전역)        │                                                     │
│  └───────┬────────┘                                                     │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │  비학습시간 정의                                                 │     │
│  │  • 식사시간 (매일)                                              │     │
│  │  • 학원일정 (요일별)                                            │     │
│  │  • 개인활동 (요일별)                                            │     │
│  └────────────────────────────────────────────────────────────────┘     │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │  플랜 그룹 생성                                                  │     │
│  │  • 기간 설정                                                    │     │
│  │  • 콘텐츠 선택                                                  │     │
│  │  • 비학습시간 = 플래너 참조                                      │     │
│  └────────────────────────────────────────────────────────────────┘     │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │  플랜 생성/배치                                                  │     │
│  │                                                                  │     │
│  │  calculateAvailableSlots()                                      │     │
│  │  ├── 플래너 기본 비학습시간 조회                                 │     │
│  │  ├── 해당 날짜 오버라이드 조회                                   │     │
│  │  ├── 병합 (오버라이드 우선)                                     │     │
│  │  └── 가용 시간 슬롯 반환                                        │     │
│  │                                                                  │     │
│  └────────────────────────────────────────────────────────────────┘     │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │  DailyDock 표시 및 조작                                         │     │
│  │                                                                  │     │
│  │  ┌──────────────────────────────────────────────────────────┐  │     │
│  │  │  드래그앤드롭 순서 변경                                    │  │     │
│  │  │  → sequence 업데이트                                      │  │     │
│  │  │  → 시간 자동 재계산                                       │  │     │
│  │  └──────────────────────────────────────────────────────────┘  │     │
│  │                                                                  │     │
│  │  ┌──────────────────────────────────────────────────────────┐  │     │
│  │  │  비학습시간 수정 (✏️ 클릭)                                 │  │     │
│  │  │  → 적용 범위 선택 (오늘만 / 전역)                          │  │     │
│  │  │  → 오버라이드 또는 기본값 수정                             │  │     │
│  │  └──────────────────────────────────────────────────────────┘  │     │
│  │                                                                  │     │
│  │  ┌──────────────────────────────────────────────────────────┐  │     │
│  │  │  빈 시간 클릭                                             │  │     │
│  │  │  → 플랜 추가 (새로 생성 / 미완료독 / 주간독)               │  │     │
│  │  │  → 시간 자동 재계산                                       │  │     │
│  │  └──────────────────────────────────────────────────────────┘  │     │
│  │                                                                  │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 구현 우선순위

| 순서 | 기능 | 복잡도 | 영향도 | 의존성 |
|------|------|--------|--------|--------|
| **Phase 1** |||||
| 1-1 | DailyDock 내 순서 재정렬 DnD | 중 | 높음 | 없음 |
| 1-2 | 순서 변경 시 시간 자동 재계산 | 낮음 | 높음 | 1-1 |
| **Phase 2** |||||
| 2-1 | 빈 시간 슬롯 시각화 | 중 | 높음 | 1-2 |
| 2-2 | 빈 시간 클릭 → 플랜 추가 | 낮음 | 높음 | 2-1 |
| **Phase 3** |||||
| 3-1 | 날짜별 오버라이드 테이블 생성 | 낮음 | 중간 | 없음 |
| 3-2 | 비학습시간 수정 모달 UI | 중 | 중간 | 3-1 |
| 3-3 | 적용 범위 선택 (오늘/전역) | 중 | 중간 | 3-2 |
| **Phase 4** |||||
| 4-1 | 플랜그룹 비학습시간 참조 방식 전환 | 높음 | 중간 | 3-1 |
| 4-2 | 비학습시간 드래그 재정렬 | 중 | 낮음 | 1-1 |

---

## 9. 예상 결과

### Before (현재)

```
• 플랜 순서 변경 불가 (컨테이너 이동만)
• 비학습시간 조율 불가 (읽기 전용)
• 빈 시간 활용 어려움
• 플랜그룹마다 비학습시간 중복 관리
```

### After (개선)

```
• 드래그로 직관적 순서 변경
• 시간 자동 재계산으로 충돌 방지
• 비학습시간 유연한 조율 (오늘만/전역)
• 빈 시간에 바로 플랜 추가
• 단일 소스로 일관된 비학습시간 관리
```

---

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| v1.0 | 2025-01-30 | Claude Code | 초안 작성 |
