# Step 6 콘텐츠 검증 로직 수정

## 작업 일자
2025-12-04

## 문제 상황

Step 6에서 전략/취약 과목 설정을 하고 다음 버튼을 눌렀을 때 다음과 같은 에러가 발생했습니다:

```
플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요.
```

사용자는 Step 3과 Step 4에서 콘텐츠를 모두 선택했지만, 검증 로직이 콘텐츠가 없다고 판단했습니다.

## 원인 분석

`continueCampStepsForAdmin` 함수에서 Step 6일 때 플랜 생성 전 검증을 수행하는데, 검증 로직이 `plan_contents` 테이블에서만 콘텐츠를 조회하고 있었습니다:

```typescript
// 최종 콘텐츠 검증 (plan_contents 테이블 확인)
const { data: finalPlanContents } = await supabase
  .from("plan_contents")
  .select("id")
  .eq("plan_group_id", groupId)
  .limit(1);

if (!finalPlanContents || finalPlanContents.length === 0) {
  validationErrors.push(
    "플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요."
  );
}
```

문제는 플랜 생성이 아직 실행되지 않았기 때문에 `plan_contents` 테이블에 데이터가 없을 수 있다는 것입니다. 플랜 생성은 Step 6에서 Step 7로 넘어갈 때 발생하므로, Step 6에서 검증할 때는 `plan_contents` 테이블이 비어있을 수 있습니다.

또한 콘텐츠 저장 로직이 실행되더라도, 저장이 실패하거나 저장 후에도 `plan_contents` 테이블에 데이터가 없을 수 있습니다.

## 해결 방법

검증 로직을 수정하여 `wizardData`에서 콘텐츠를 우선적으로 확인하도록 변경했습니다:

1. **wizardData 우선 확인**: `wizardData.student_contents`와 `wizardData.recommended_contents`를 먼저 확인합니다.
2. **plan_contents 보조 확인**: `wizardData`에 콘텐츠가 없는 경우에만 `plan_contents` 테이블을 확인합니다 (이미 저장된 경우를 대비).

## 수정된 코드

```typescript
// 최종 콘텐츠 검증
// wizardData에서 콘텐츠 확인 (플랜 생성 전이므로 plan_contents 테이블이 비어있을 수 있음)
const finalStudentContents = wizardData.student_contents || [];
const finalRecommendedContents = wizardData.recommended_contents || [];
const finalTotalContents = finalStudentContents.length + finalRecommendedContents.length;

console.log("[campTemplateActions] Step 6 최종 콘텐츠 검증:", {
  wizardDataStudentContents: finalStudentContents.length,
  wizardDataRecommendedContents: finalRecommendedContents.length,
  wizardDataTotalContents: finalTotalContents,
});

// wizardData에 콘텐츠가 없으면 plan_contents 테이블 확인 (이미 저장된 경우를 대비)
if (finalTotalContents === 0) {
  const { data: finalPlanContents } = await supabase
    .from("plan_contents")
    .select("id")
    .eq("plan_group_id", groupId)
    .limit(1);

  console.log("[campTemplateActions] Step 6 plan_contents 테이블 확인:", {
    finalPlanContentsCount: finalPlanContents?.length || 0,
    hasFinalPlanContents: finalPlanContents && finalPlanContents.length > 0,
  });

  if (!finalPlanContents || finalPlanContents.length === 0) {
    validationErrors.push(
      "플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요."
    );
  }
}
```

## 개선 효과

1. ✅ **검증 성공**: `wizardData`에 콘텐츠가 있으면 검증을 통과합니다.
2. ✅ **플랜 생성 전 검증 가능**: 플랜 생성 전에도 콘텐츠 검증이 가능합니다.
3. ✅ **하위 호환성 유지**: 이미 저장된 경우를 대비하여 `plan_contents` 테이블도 확인합니다.

## 테스트 시나리오

1. **Step 6에서 콘텐츠가 있는 경우**
   - Step 3과 Step 4에서 콘텐츠를 선택
   - Step 6에서 전략/취약 과목 설정
   - 다음 버튼 클릭
   - 검증 통과 (wizardData에 콘텐츠가 있음)

2. **Step 6에서 콘텐츠가 없는 경우**
   - Step 3과 Step 4에서 콘텐츠를 선택하지 않음
   - Step 6에서 다음 버튼 클릭
   - 검증 실패 (wizardData와 plan_contents 모두에 콘텐츠가 없음)

3. **이미 저장된 콘텐츠가 있는 경우**
   - 이전에 콘텐츠를 저장했지만 wizardData에는 없음
   - Step 6에서 다음 버튼 클릭
   - 검증 통과 (plan_contents 테이블에 콘텐츠가 있음)

## 수정된 파일

1. `app/(admin)/actions/campTemplateActions.ts`
   - Step 6 최종 콘텐츠 검증 로직 수정
   - `wizardData` 우선 확인 로직 추가
   - `plan_contents` 테이블 보조 확인 로직 추가

