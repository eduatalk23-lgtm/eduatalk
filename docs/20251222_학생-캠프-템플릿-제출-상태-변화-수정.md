# 학생 영역의 캠프 템플릿 제출 후 상태 변화 (초대 수락) 수정

**작업 일시**: 2025-12-22  
**문제**: 학생이 캠프 템플릿을 제출해도 관리자 영역에서 학생의 상태가 변경되지 않음

---

## 문제 분석

### 발견된 문제점

1. **상태 업데이트 실패 시 에러 처리 부족**
   - `updateCampInvitationStatus` 함수가 실패하더라도 `submitCampParticipation`에서는 경고만 출력하고 계속 진행
   - 실제로 상태가 업데이트되지 않았는지 확인하기 어려움

2. **상태 업데이트 후 검증 부족**
   - UPDATE 쿼리 후 실제로 상태가 변경되었는지 확인하지 않음
   - RLS 정책으로 인해 SELECT가 실패할 수 있지만, UPDATE는 성공했을 수 있음

3. **디버깅 정보 부족**
   - 상태 업데이트 실패 시 원인 파악이 어려움
   - 사용자 ID, 학생 ID, 현재 상태 등의 정보가 부족

---

## 해결 방법

### 1. `updateCampInvitationStatus` 함수 개선

**파일**: `lib/data/campTemplates.ts`

**변경 사항**:

1. **사용자 컨텍스트 확인 추가**
   - UPDATE 전에 현재 사용자 ID 확인
   - 학생 ID와 사용자 ID 일치 여부 확인 (RLS 정책 검증)

2. **상세한 로깅 추가**
   - UPDATE 시도 전후의 모든 상태 로깅
   - 실패 시 원인 파악을 위한 상세 정보 로깅

3. **상태 변경 확인 로직 추가**
   - UPDATE 후 실제로 상태가 변경되었는지 확인
   - RLS 정책으로 인해 SELECT가 실패할 수 있지만, count 기반으로 성공 여부 판단

```typescript
// 주요 개선 사항
- 사용자 ID와 학생 ID 일치 확인 추가
- UPDATE 시도 전후 상세 로깅
- UPDATE 후 상태 변경 확인 로직 추가
- 실패 시 원인 파악을 위한 상세 에러 메시지
```

### 2. `submitCampParticipation` 함수 개선

**파일**: `app/(student)/actions/campActions.ts`

**변경 사항**:

1. **에러 처리 강화**
   - 상태 업데이트 실패 시 경고가 아닌 에러로 처리
   - 실패 원인을 명확히 로깅

2. **상세한 로깅 추가**
   - 상태 업데이트 성공/실패 시 상세 정보 로깅
   - 디버깅을 위한 컨텍스트 정보 포함

```typescript
// 주요 개선 사항
- 상태 업데이트 실패 시 에러 로깅 강화
- 성공 시에도 상세 로깅 추가
- 디버깅을 위한 컨텍스트 정보 포함
```

---

## 수정된 코드

### `lib/data/campTemplates.ts`

```typescript
export async function updateCampInvitationStatus(
  invitationId: string,
  status: "accepted" | "declined"
): Promise<{ success: boolean; error?: string }> {
  const supabase = await createSupabaseServerClient();

  // 현재 사용자 확인 (디버깅용)
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  
  // 먼저 현재 상태 확인
  const { data: currentInvitation, error: checkError } = await supabase
    .from("camp_invitations")
    .select("id, status, student_id")
    .eq("id", invitationId)
    .maybeSingle();

  // 사용자 ID와 학생 ID 일치 확인 (RLS 정책 검증)
  if (user?.id !== currentInvitation.student_id) {
    console.error("[data/campTemplates] updateCampInvitationStatus: 사용자 ID 불일치");
    return {
      success: false,
      error: "권한이 없습니다. 자신의 초대만 업데이트할 수 있습니다.",
    };
  }

  // UPDATE 후 상태 변경 확인
  const { error, count } = await supabase
    .from("camp_invitations")
    .update(updateData)
    .eq("id", invitationId)
    .eq("status", "pending")
    .select("*", { count: "exact", head: true });

  // UPDATE 후 실제로 상태가 변경되었는지 확인
  const { data: updatedInvitation } = await supabase
    .from("camp_invitations")
    .select("id, status, accepted_at, declined_at")
    .eq("id", invitationId)
    .maybeSingle();

  if (updatedInvitation?.status === status) {
    return { success: true };
  }
  
  // 상태가 변경되지 않은 경우 에러 반환
  return {
    success: false,
    error: `상태 업데이트가 실패했습니다. 예상 상태: ${status}, 실제 상태: ${updatedInvitation?.status}`,
  };
}
```

### `app/(student)/actions/campActions.ts`

```typescript
// 초대 상태 업데이트
const updateResult = await updateCampInvitationStatus(
  invitationId,
  "accepted"
);
if (!updateResult.success) {
  // 초대 상태 업데이트 실패는 심각한 문제이므로 에러로 처리
  console.error(
    "[campActions] 초대 상태 업데이트 실패 (심각):",
    {
      invitationId,
      groupId,
      studentId: user.userId,
      error: updateResult.error,
    }
  );
} else {
  console.log("[campActions] 초대 상태 업데이트 성공:", {
    invitationId,
    groupId,
    studentId: user.userId,
  });
}
```

---

## 테스트 체크리스트

- [ ] 학생이 캠프 템플릿을 제출하면 초대 상태가 "accepted"로 변경되는지 확인
- [ ] 관리자 영역에서 학생의 상태가 "accepted"로 표시되는지 확인
- [ ] 상태 업데이트 실패 시 에러 로그가 정상적으로 출력되는지 확인
- [ ] 상태 업데이트 성공 시 상세 로그가 정상적으로 출력되는지 확인
- [ ] RLS 정책 위반 시 적절한 에러 메시지가 표시되는지 확인

---

## 참고 사항

1. **RLS 정책**
   - `camp_invitations_update_for_student` 정책은 pending 상태인 초대만 업데이트 가능
   - 학생은 자신의 초대만 업데이트 가능

2. **캐시 무효화**
   - 상태 업데이트 후 `revalidatePath`를 호출하여 캐시 무효화
   - 관리자 영역 캐시도 무효화하여 최신 상태 반영

3. **에러 처리**
   - 상태 업데이트 실패 시에도 플랜 그룹은 생성되었으므로 성공으로 반환
   - 하지만 에러 로그를 남겨서 나중에 재시도할 수 있도록 함

---

## 향후 개선 사항

1. **재시도 로직 추가**
   - 상태 업데이트 실패 시 자동 재시도 로직 추가 고려
   - 재시도 횟수 제한 및 백오프 전략 적용

2. **모니터링 강화**
   - 상태 업데이트 실패율 모니터링
   - 실패 원인 분석을 위한 메트릭 수집

3. **사용자 피드백 개선**
   - 상태 업데이트 실패 시 사용자에게 명확한 피드백 제공
   - 관리자에게 알림 전송 고려

