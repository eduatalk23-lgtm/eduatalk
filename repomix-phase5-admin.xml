This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
actions/
  masterBooks/
    export.ts
    import.ts
  masterLectures/
    export.ts
    import.ts
  reschedule/
    cleanup.ts
  schools/
    export.ts
    import.ts
  subjects/
    export.ts
    import.ts
  adminUserActions.ts
  attendanceActions.ts
  attendanceSettingsActions.ts
  campTemplateActions.ts
  campTemplateBlockSets.ts
  careerFieldActions.ts
  consultingNoteActions.ts
  contentMetadataActions.ts
  masterCustomContentActions.ts
  parentStudentLinkActions.ts
  qrCodeActions.ts
  recommendationSettings.ts
  schedulerSettings.ts
  schoolActions.ts
  smsLogActions.ts
  studentManagementActions.ts
  subjectActions.ts
  templateBlockSets.ts
  tenantBlockSets.ts
  tenantSettingsActions.ts
  tenantUsers.ts
  unverifiedUserActions.ts
admin/
  attendance/
    _components/
      AttendanceFilters.tsx
      AttendanceList.tsx
      AttendanceRecordForm.tsx
      AttendanceStatistics.tsx
    [id]/
      edit/
        _components/
          EditAttendanceRecordForm.tsx
        page.tsx
    qr-code/
      _components/
        QRCodeDisplay.tsx
      manage/
        _components/
          QRCodeManageContent.tsx
        page.tsx
      page.tsx
    settings/
      _components/
        AttendanceSettingsTabs.tsx
        AttendanceSMSSettingsForm.tsx
        LocationSettingsForm.tsx
      page.tsx
    sms-logs/
      _components/
        SMSLogsFilters.tsx
        SMSLogsPagination.tsx
        SMSLogsTable.tsx
      page.tsx
    statistics/
      _components/
        DailyAttendanceChart.tsx
        MethodStatisticsChart.tsx
        TimeDistributionChart.tsx
      page.tsx
    page.tsx
  camp-templates/
    _components/
      TemplateCard.tsx
      TemplateCardNew.tsx
      TemplateChecklist.tsx
      TemplateFormChecklist.tsx
      TemplateWizardChecklist.tsx
    [id]/
      edit/
        CampTemplateEditForm.tsx
        page.tsx
      participants/
        _components/
          BatchOperationDialog.tsx
          BatchPlanWizard.tsx
          BulkRecommendContentsModal.tsx
          Step1ContentRecommendation.tsx
          Step2RangeAdjustment.tsx
          Step3PlanPreview.tsx
          Step4Results.tsx
        [groupId]/
          continue/
            page.tsx
          review/
            CampPlanGroupReviewForm.tsx
            page.tsx
        CampParticipantsList.tsx
        page.tsx
      time-management/
        _components/
          TemplateBlockForm.tsx
          TemplateBlockSetManagement.tsx
          TemplateBlocksViewer.tsx
        [setId]/
          _components/
            TemplateBlockSetDetail.tsx
          page.tsx
        page.tsx
      CampInvitationList.tsx
      CampTemplateDetail.tsx
      page.tsx
      StudentInvitationForm.tsx
    new/
      CampTemplateForm.tsx
      NewCampTemplateForm.tsx
      page.tsx
    page.tsx
  compare/
    _components/
      ComparePageClient.tsx
    page.tsx
  consulting/
    page.tsx
  content-metadata/
    _components/
      CareerFieldsManager.tsx
      ContentMetadataTabs.tsx
      CurriculumHierarchyManager.tsx
      CurriculumRevisionsManager.tsx
      PlatformsManager.tsx
      PublishersManager.tsx
      SubjectCategoriesManager.tsx
      SubjectsManager.tsx
      SubjectTypesManager.tsx
    page.tsx
  dashboard/
    page.tsx
  master-books/
    _components/
      ExcelActions.tsx
    [id]/
      edit/
        MasterBookEditForm.tsx
        page.tsx
      page.tsx
    new/
      MasterBookForm.tsx
      page.tsx
    page.tsx
  master-custom-contents/
    [id]/
      edit/
        MasterCustomContentEditForm.tsx
        page.tsx
      page.tsx
    new/
      MasterCustomContentForm.tsx
      page.tsx
    page.tsx
  master-lectures/
    _components/
      ExcelActions.tsx
    [id]/
      edit/
        MasterLectureEditForm.tsx
        page.tsx
      page.tsx
    new/
      MasterLectureForm.tsx
      page.tsx
    page.tsx
  parent-links/
    _components/
      PendingLinkRequestCard.tsx
      PendingLinkRequestsList.tsx
      PendingLinkRequestsSkeleton.tsx
    page.tsx
  plan-groups/
    [id]/
      page.tsx
  recommendation-settings/
    _components/
      RangeRecommendationSettings.tsx
    page.tsx
  reports/
    page.tsx
  reschedule-logs/
    _components/
      RescheduleLogDetail.tsx
      RescheduleLogsList.tsx
    page.tsx
  schools/
    _components/
      RegionFilter.tsx
      SchoolFilterPanel.tsx
      SchoolFormModal.tsx
      SchoolStats.tsx
      SchoolTable.tsx
      SchoolTypeTabs.tsx
    [id]/
      edit/
        page.tsx
        SchoolEditForm.tsx
    new/
      page.tsx
      SchoolForm.tsx
    page.tsx
  settings/
    scheduler/
      _components/
        SchedulerSettingsForm.tsx
      page.tsx
    page.tsx
  sms/
    _components/
      SingleRecipientSearch.tsx
      SMSPreviewModal.tsx
      SMSRecipientSelector.tsx
      SMSSendForm.tsx
      SMSSendSummary.tsx
    results/
      _components/
        SMSResultsClient.tsx
      page.tsx
    send/
      page.tsx
    page.tsx
  students/
    _components/
      StudentActions.tsx
    [id]/
      _components/
        AnalysisReportSection.tsx
        AnalysisReportSectionSkeleton.tsx
        AttendanceSection.tsx
        BasicInfoSection.tsx
        ConsultingNoteDeleteButton.tsx
        ConsultingNotesForm.tsx
        ConsultingNotesSection.tsx
        ConsultingNotesSectionSkeleton.tsx
        ContentListSection.tsx
        ContentListSectionSkeleton.tsx
        ContentProgressSection.tsx
        ContentUsageSection.tsx
        GoalsSummarySection.tsx
        HistorySection.tsx
        ParentCard.tsx
        ParentLinksSection.tsx
        ParentLinksSectionSkeleton.tsx
        ParentSearchModal.tsx
        PlanListSection.tsx
        PlanListSectionSkeleton.tsx
        RecommendationPanel.tsx
        RiskCard.tsx
        ScoreSummarySection.tsx
        ScoreTrendSection.tsx
        ScoreTrendSectionSkeleton.tsx
        SessionListSection.tsx
        SessionListSectionSkeleton.tsx
        StudentDetailTabs.tsx
        StudentDetailWrapper.tsx
        StudyTimeSection.tsx
        TabContent.tsx
        WeeklyCoachingSection.tsx
        WeeklySummarySection.tsx
      attendance-settings/
        _components/
          StudentAttendanceSettingsForm.tsx
        page.tsx
      page.tsx
    page.tsx
  subjects/
    _components/
      CurriculumRevisionAccordion.tsx
      CurriculumRevisionTabs.tsx
      GroupForm.tsx
      GroupFormModal.tsx
      RevisionForm.tsx
      RevisionFormModal.tsx
      SubjectForm.tsx
      SubjectFormModal.tsx
      SubjectGroupAccordion.tsx
      SubjectGroupManagement.tsx
      SubjectGroupSidebar.tsx
      SubjectList.tsx
      SubjectManagementPanel.tsx
      SubjectTable.tsx
      SubjectTypeForm.tsx
      SubjectTypeFormModal.tsx
      SubjectTypeList.tsx
      SubjectTypeTable.tsx
      UnifiedSubjectForm.tsx
    page.tsx
  tenant/
    settings/
      _components/
        TenantSettingsForm.tsx
      page.tsx
    users/
      _components/
        TenantUsersManagement.tsx
      page.tsx
  time-management/
    _components/
      TemplateBlockSetManagement.tsx
    [templateId]/
      _components/
        TemplateBlockForm.tsx
        TemplateBlockSetManagement.tsx
        TemplateBlocksViewer.tsx
      [setId]/
        _components/
          TemplateBlockSetDetail.tsx
        page.tsx
      page.tsx
    global/
      [setId]/
        page.tsx
    page.tsx
  tools/
    _components/
      ToolCard.tsx
    page.tsx
error.tsx
layout.tsx
loading.tsx
studentData.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="actions/masterBooks/export.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { exportToExcel } from "@/lib/utils/excel";

/**
 * 교재 관리 데이터를 Excel 파일로 다운로드
 */
export async function exportMasterBooksToExcel(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // 전체 교재 데이터 조회
  const { data: books, error } = await supabase
    .from("master_books")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    throw new Error(`교재 데이터 조회 실패: ${error.message}`);
  }

  // Excel 시트 데이터 준비
  const sheets = {
    master_books: (books || []).map((book) => ({
      id: book.id,
      tenant_id: book.tenant_id ?? "",
      is_active: book.is_active ?? true,
      curriculum_revision_id: book.curriculum_revision_id ?? "",
      subject_id: book.subject_id ?? "",
      grade_min: book.grade_min ?? "",
      grade_max: book.grade_max ?? "",
      school_type: book.school_type ?? "",
      revision: book.revision ?? "",
      content_category: book.content_category ?? "",
      // semester 필드 제거됨 (2025-02-04)
      title: book.title,
      subtitle: book.subtitle ?? "",
      series_name: book.series_name ?? "",
      author: book.author ?? "",
      publisher_id: book.publisher_id ?? "",
      publisher_name: book.publisher_name ?? "",
      isbn_10: book.isbn_10 ?? "",
      isbn_13: book.isbn_13 ?? "",
      edition: book.edition ?? "",
      published_date: book.published_date ?? "",
      total_pages: book.total_pages ?? "",
      target_exam_type: Array.isArray(book.target_exam_type) ? book.target_exam_type.join(", ") : "",
      description: book.description ?? "",
      toc: book.toc ?? "",
      publisher_review: book.publisher_review ?? "",
      tags: Array.isArray(book.tags) ? book.tags.join(", ") : "",
      source: book.source ?? "",
      source_product_code: book.source_product_code ?? "",
      source_url: book.source_url ?? "",
      cover_image_url: book.cover_image_url ?? "",
      difficulty_level: book.difficulty_level ?? "",
      notes: book.notes ?? "",
      pdf_url: book.pdf_url ?? "",
      overall_difficulty: book.overall_difficulty ?? "",
      created_at: book.created_at ?? "",
      updated_at: book.updated_at ?? "",
    })),
  };

  return exportToExcel(sheets);
}

/**
 * 교재 관리 양식 파일 다운로드
 */
export async function downloadMasterBooksTemplate(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const sheets = {
    master_books: [
      "id",
      "tenant_id",
      "is_active",
      "curriculum_revision_id",
      "subject_id",
      "grade_min",
      "grade_max",
      "school_type",
      "revision",
      "content_category",
      // "semester", // 제거됨 (2025-02-04)
      "title",
      "subtitle",
      "series_name",
      "author",
      "publisher_id",
      "publisher_name",
      "isbn_10",
      "isbn_13",
      "edition",
      "published_date",
      "total_pages",
      "target_exam_type",
      "description",
      "toc",
      "publisher_review",
      "tags",
      "source",
      "source_product_code",
      "source_url",
      "cover_image_url",
      "difficulty_level",
      "notes",
      "pdf_url",
      "overall_difficulty",
      "created_at",
      "updated_at",
    ],
  };

  const { generateTemplateExcel } = await import("@/lib/utils/excel");
  return generateTemplateExcel(sheets);
}
</file>

<file path="actions/masterBooks/import.ts">
"use server";

import { revalidatePath } from "next/cache";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { parseExcelFile, validateExcelFile } from "@/lib/utils/excel";
import { z } from "zod";

// Zod 스키마 정의
const masterBookSchema = z.object({
  id: z.string().uuid().optional(),
  tenant_id: z.string().uuid().optional().nullable(),
  is_active: z.union([z.boolean(), z.string()]).optional().transform((val) => {
    if (typeof val === "string") return val.toLowerCase() === "true";
    return val ?? true;
  }),
  curriculum_revision_id: z.string().uuid().optional().nullable(),
  subject_id: z.string().uuid().optional().nullable(),
  grade_min: z.union([z.number(), z.string()]).optional().nullable().transform((val) => {
    if (!val || val === "") return null;
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? null : num;
    }
    return val;
  }),
  grade_max: z.union([z.number(), z.string()]).optional().nullable().transform((val) => {
    if (!val || val === "") return null;
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? null : num;
    }
    return val;
  }),
  school_type: z.string().optional().nullable(),
  revision: z.string().optional().nullable(),
  content_category: z.string().optional().nullable(),
  semester: z.string().optional().nullable(),
  title: z.string().min(1),
  subtitle: z.string().optional().nullable(),
  series_name: z.string().optional().nullable(),
  author: z.string().optional().nullable(),
  publisher_id: z.string().uuid().optional().nullable(),
  publisher_name: z.string().optional().nullable(),
  isbn_10: z.string().optional().nullable(),
  isbn_13: z.string().optional().nullable(),
  edition: z.string().optional().nullable(),
  published_date: z.string().optional().nullable(),
  total_pages: z.union([z.number(), z.string()]).optional().nullable().transform((val) => {
    if (!val || val === "") return null;
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      if (isNaN(num) || num <= 0) return null;
      return num;
    }
    if (val <= 0) return null;
    return val;
  }),
  target_exam_type: z.string().optional().nullable().transform((val) => {
    if (!val || val === "") return null;
    return val.split(",").map((v: string) => v.trim()).filter(Boolean);
  }),
  description: z.string().optional().nullable(),
  toc: z.string().optional().nullable(),
  publisher_review: z.string().optional().nullable(),
  tags: z.string().optional().nullable().transform((val) => {
    if (!val || val === "") return null;
    return val.split(",").map((v: string) => v.trim()).filter(Boolean);
  }),
  source: z.string().optional().nullable(),
  source_product_code: z.string().optional().nullable(),
  source_url: z.string().optional().nullable(),
  cover_image_url: z.string().optional().nullable(),
  difficulty_level: z.string().optional().nullable(),
  notes: z.string().optional().nullable(),
  pdf_url: z.string().optional().nullable(),
  overall_difficulty: z.union([z.number(), z.string()]).optional().nullable().transform((val) => {
    if (val === null || val === undefined || val === "") return null;
    if (typeof val === "string") {
      const num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    return val;
  }),
});

/**
 * 교재 관리 데이터를 Excel 파일에서 가져와 전체 교체
 */
export async function importMasterBooksFromExcel(
  fileBuffer: Buffer | Uint8Array
): Promise<{ success: boolean; message: string; errors?: string[] }> {
  // Uint8Array를 Buffer로 변환
  const buffer = Buffer.isBuffer(fileBuffer) ? fileBuffer : Buffer.from(fileBuffer);
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // Excel 파일 검증
  const validation = validateExcelFile(buffer, ["master_books"]);
  if (!validation.valid) {
    return {
      success: false,
      message: validation.error || "Excel 파일 검증에 실패했습니다.",
    };
  }

  // Excel 파일 파싱
  const sheets = parseExcelFile(buffer);
  const errors: string[] = [];

  try {
    // 1. 기존 데이터 삭제
    const { error: deleteError } = await supabase
      .from("master_books")
      .delete()
      .neq("id", "00000000-0000-0000-0000-000000000000");

    if (deleteError) {
      throw new Error(`기존 데이터 삭제 실패: ${deleteError.message}`);
    }

    // 2. 새 데이터 삽입
    const booksData = sheets.master_books || [];
    const booksToInsert: any[] = [];

    for (const row of booksData) {
      try {
        const validated = masterBookSchema.parse(row);
        
        const bookData: any = {
          title: validated.title,
          tenant_id: validated.tenant_id || null,
          is_active: validated.is_active ?? true,
          curriculum_revision_id: validated.curriculum_revision_id || null,
          subject_id: validated.subject_id || null,
          grade_min: validated.grade_min || null,
          grade_max: validated.grade_max || null,
          school_type: validated.school_type || null,
          revision: validated.revision || null,
          content_category: validated.content_category || null,
          semester: validated.semester || null,
          subtitle: validated.subtitle || null,
          series_name: validated.series_name || null,
          author: validated.author || null,
          publisher_id: validated.publisher_id || null,
          publisher_name: validated.publisher_name || null,
          isbn_10: validated.isbn_10 || null,
          isbn_13: validated.isbn_13 || null,
          edition: validated.edition || null,
          published_date: validated.published_date || null,
          total_pages: validated.total_pages || null,
          target_exam_type: validated.target_exam_type || null,
          description: validated.description || null,
          toc: validated.toc || null,
          publisher_review: validated.publisher_review || null,
          tags: validated.tags || null,
          source: validated.source || null,
          source_product_code: validated.source_product_code || null,
          source_url: validated.source_url || null,
          cover_image_url: validated.cover_image_url || null,
          difficulty_level: validated.difficulty_level || null,
          notes: validated.notes || null,
          pdf_url: validated.pdf_url || null,
          overall_difficulty: validated.overall_difficulty || null,
        };

        // ID가 있으면 포함
        if (validated.id) {
          bookData.id = validated.id;
        }

        booksToInsert.push(bookData);
      } catch (error) {
        errors.push(
          `교재 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`
        );
      }
    }

    // 배치 삽입 (Supabase는 최대 1000개까지 한 번에 삽입 가능)
    const batchSize = 1000;
    for (let i = 0; i < booksToInsert.length; i += batchSize) {
      const batch = booksToInsert.slice(i, i + batchSize);
      const { error: insertError } = await supabase
        .from("master_books")
        .insert(batch);

      if (insertError) {
        throw new Error(`데이터 삽입 실패: ${insertError.message}`);
      }
    }

    revalidatePath("/admin/master-books");

    if (errors.length > 0) {
      return {
        success: true,
        message: `데이터를 가져왔지만 일부 오류가 발생했습니다. (${errors.length}개 오류)`,
        errors,
      };
    }

    return {
      success: true,
      message: `데이터를 성공적으로 가져왔습니다. (${booksToInsert.length}개 교재)`,
    };
  } catch (error) {
    return {
      success: false,
      message: `데이터 가져오기 실패: ${error instanceof Error ? error.message : "알 수 없는 오류"}`,
      errors: [error instanceof Error ? error.message : "알 수 없는 오류"],
    };
  }
}
</file>

<file path="actions/masterLectures/export.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { exportToExcel } from "@/lib/utils/excel";

/**
 * 강의 관리 데이터를 Excel 파일로 다운로드
 */
export async function exportMasterLecturesToExcel(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // 전체 강의 데이터 조회
  const { data: lectures, error } = await supabase
    .from("master_lectures")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    throw new Error(`강의 데이터 조회 실패: ${error.message}`);
  }

  // Excel 시트 데이터 준비
  const sheets = {
    master_lectures: (lectures || []).map((lecture) => ({
      id: lecture.id,
      tenant_id: lecture.tenant_id ?? "",
      linked_book_id: lecture.linked_book_id ?? "",
      revision: lecture.revision ?? "",
      content_category: lecture.content_category ?? "",
      // semester 필드 제거됨 (2025-02-04)
      subject_category: lecture.subject_category ?? "",
      subject: lecture.subject ?? "",
      title: lecture.title,
      platform: lecture.platform ?? "",
      instructor: lecture.instructor ?? "",
      total_episodes: lecture.total_episodes ?? "",
      difficulty_level: lecture.difficulty_level ?? "",
      notes: lecture.notes ?? "",
      video_url: lecture.video_url ?? "",
      overall_difficulty: lecture.overall_difficulty ?? "",
      created_at: lecture.created_at ?? "",
      updated_at: lecture.updated_at ?? "",
    })),
  };

  return exportToExcel(sheets);
}

/**
 * 강의 관리 양식 파일 다운로드
 */
export async function downloadMasterLecturesTemplate(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const sheets = {
    master_lectures: [
      "id",
      "tenant_id",
      "linked_book_id",
      "revision",
      "content_category",
      // "semester", // 제거됨 (2025-02-04)
      "subject_category",
      "subject",
      "title",
      "platform",
      "instructor",
      "total_episodes",
      "difficulty_level",
      "notes",
      "video_url",
      "overall_difficulty",
      "created_at",
      "updated_at",
    ],
  };

  const { generateTemplateExcel } = await import("@/lib/utils/excel");
  return generateTemplateExcel(sheets);
}
</file>

<file path="actions/masterLectures/import.ts">
"use server";

import { revalidatePath } from "next/cache";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { parseExcelFile, validateExcelFile } from "@/lib/utils/excel";
import { z } from "zod";

// Zod 스키마 정의
const masterLectureSchema = z.object({
  id: z.string().uuid().optional(),
  tenant_id: z.string().uuid().optional().nullable(),
  linked_book_id: z.string().uuid().optional().nullable(),
  revision: z.string().optional().nullable(),
  content_category: z.string().optional().nullable(),
  semester: z.string().optional().nullable(),
  subject_category: z.string().optional().nullable(),
  subject: z.string().optional().nullable(),
  title: z.string().min(1),
  platform: z.string().optional().nullable(),
  instructor: z.string().optional().nullable(),
  total_episodes: z.union([z.number(), z.string()]).optional().nullable().transform((val) => {
    if (val === null || val === undefined || val === "") return null;
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? null : num;
    }
    return val;
  }),
  difficulty_level: z.string().optional().nullable(),
  notes: z.string().optional().nullable(),
  video_url: z.string().optional().nullable(),
  overall_difficulty: z.union([z.number(), z.string()]).optional().nullable().transform((val) => {
    if (val === null || val === undefined || val === "") return null;
    if (typeof val === "string") {
      const num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    return val;
  }),
});

/**
 * 강의 관리 데이터를 Excel 파일에서 가져와 전체 교체
 */
export async function importMasterLecturesFromExcel(
  fileBuffer: Buffer | Uint8Array
): Promise<{ success: boolean; message: string; errors?: string[] }> {
  // Uint8Array를 Buffer로 변환
  const buffer = Buffer.isBuffer(fileBuffer) ? fileBuffer : Buffer.from(fileBuffer);
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // Excel 파일 검증
  const validation = validateExcelFile(buffer, ["master_lectures"]);
  if (!validation.valid) {
    return {
      success: false,
      message: validation.error || "Excel 파일 검증에 실패했습니다.",
    };
  }

  // Excel 파일 파싱
  const sheets = parseExcelFile(buffer);
  const errors: string[] = [];

  try {
    // 1. 기존 데이터 삭제
    const { error: deleteError } = await supabase
      .from("master_lectures")
      .delete()
      .neq("id", "00000000-0000-0000-0000-000000000000");

    if (deleteError) {
      throw new Error(`기존 데이터 삭제 실패: ${deleteError.message}`);
    }

    // 2. 새 데이터 삽입
    const lecturesData = sheets.master_lectures || [];
    const lecturesToInsert: any[] = [];

    for (const row of lecturesData) {
      try {
        const validated = masterLectureSchema.parse(row);
        
        const lectureData: any = {
          title: validated.title,
          tenant_id: validated.tenant_id || null,
          linked_book_id: validated.linked_book_id || null,
          revision: validated.revision || null,
          content_category: validated.content_category || null,
          semester: validated.semester || null,
          subject_category: validated.subject_category || null,
          subject: validated.subject || null,
          platform: validated.platform || null,
          instructor: validated.instructor || null,
          total_episodes: validated.total_episodes || null,
          difficulty_level: validated.difficulty_level || null,
          notes: validated.notes || null,
          video_url: validated.video_url || null,
          overall_difficulty: validated.overall_difficulty || null,
        };

        // ID가 있으면 포함
        if (validated.id) {
          lectureData.id = validated.id;
        }

        lecturesToInsert.push(lectureData);
      } catch (error) {
        errors.push(
          `강의 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`
        );
      }
    }

    // 배치 삽입 (Supabase는 최대 1000개까지 한 번에 삽입 가능)
    const batchSize = 1000;
    for (let i = 0; i < lecturesToInsert.length; i += batchSize) {
      const batch = lecturesToInsert.slice(i, i + batchSize);
      const { error: insertError } = await supabase
        .from("master_lectures")
        .insert(batch);

      if (insertError) {
        throw new Error(`데이터 삽입 실패: ${insertError.message}`);
      }
    }

    revalidatePath("/admin/master-lectures");

    if (errors.length > 0) {
      return {
        success: true,
        message: `데이터를 가져왔지만 일부 오류가 발생했습니다. (${errors.length}개 오류)`,
        errors,
      };
    }

    return {
      success: true,
      message: `데이터를 성공적으로 가져왔습니다. (${lecturesToInsert.length}개 강의)`,
    };
  } catch (error) {
    return {
      success: false,
      message: `데이터 가져오기 실패: ${error instanceof Error ? error.message : "알 수 없는 오류"}`,
      errors: [error instanceof Error ? error.message : "알 수 없는 오류"],
    };
  }
}
</file>

<file path="actions/reschedule/cleanup.ts">
/**
 * 재조정 강제 정리 Server Actions
 * 
 * 비정상 상태의 재조정을 정리하고 복구합니다.
 * 
 * @module app/(admin)/actions/reschedule/cleanup
 */

"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { requireTenantContext } from "@/lib/tenant/requireTenantContext";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";

// ============================================
// 타입 정의
// ============================================

/**
 * 정리 결과
 */
export interface CleanupResult {
  success: boolean;
  cleanedPlans: number;
  restoredPlans: number;
  error?: string;
}

/**
 * 복구 결과
 */
export interface RecoveryResult {
  success: boolean;
  recoveredLogs: number;
  error?: string;
}

// ============================================
// 정리 함수
// ============================================

/**
 * 비정상 상태 플랜 정리
 * 
 * is_active=false이고 replaced_by가 없는 고아 플랜을 정리합니다.
 * 
 * @param groupId 플랜 그룹 ID
 * @returns 정리 결과
 */
async function _cleanupOrphanedPlans(
  groupId: string
): Promise<CleanupResult> {
  return (async () => {
    const { role } = await getCurrentUserRole();
    if (!isAdminRole(role)) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const tenantContext = await requireTenantContext();
    const supabase = await createSupabaseServerClient();

    // 비정상 상태 플랜 조회
    // is_active=false이고 version_group_id가 있지만 활성 버전이 없는 경우
    const { data: orphanedPlans, error: fetchError } = await supabase
      .from("student_plan")
      .select("id, version_group_id")
      .eq("plan_group_id", groupId)
      .eq("is_active", false)
      .not("version_group_id", "is", null);

    if (fetchError) {
      throw new AppError(
        `플랜 조회 실패: ${fetchError.message}`,
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    if (!orphanedPlans || orphanedPlans.length === 0) {
      return {
        success: true,
        cleanedPlans: 0,
        restoredPlans: 0,
      };
    }

    // version_group_id별로 그룹화하여 활성 버전이 있는지 확인
    const versionGroups = new Set(
      orphanedPlans.map((p) => p.version_group_id).filter(Boolean)
    );

    let cleanedCount = 0;
    let restoredCount = 0;

    for (const versionGroupId of versionGroups) {
      // 활성 버전 확인
      const { data: activePlan } = await supabase
        .from("student_plan")
        .select("id")
        .eq("version_group_id", versionGroupId)
        .eq("is_active", true)
        .maybeSingle();

      if (activePlan) {
        // 활성 버전이 있으면 고아 플랜 삭제
        const orphanedIds = orphanedPlans
          .filter((p) => p.version_group_id === versionGroupId)
          .map((p) => p.id);

        const { error: deleteError } = await supabase
          .from("student_plan")
          .delete()
          .in("id", orphanedIds);

        if (!deleteError) {
          cleanedCount += orphanedIds.length;
        }
      } else {
        // 활성 버전이 없으면 가장 최신 버전을 활성화
        const { data: latestPlan } = await supabase
          .from("student_plan")
          .select("id")
          .eq("version_group_id", versionGroupId)
          .order("version", { ascending: false })
          .limit(1)
          .maybeSingle();

        if (latestPlan) {
          const { error: restoreError } = await supabase
            .from("student_plan")
            .update({ is_active: true })
            .eq("id", latestPlan.id);

          if (!restoreError) {
            restoredCount++;
          }
        }
      }
    }

    return {
      success: true,
      cleanedPlans: cleanedCount,
      restoredPlans: restoredCount,
    };
  })();
}

export const cleanupOrphanedPlans = withErrorHandling(_cleanupOrphanedPlans);

/**
 * 실패한 재조정 복구
 * 
 * status='failed'인 재조정 로그를 복구합니다.
 * 
 * @param rescheduleLogId 재조정 로그 ID
 * @returns 복구 결과
 */
async function _recoverFailedReschedule(
  rescheduleLogId: string
): Promise<RecoveryResult> {
  return (async () => {
    const { role } = await getCurrentUserRole();
    if (!isAdminRole(role)) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const tenantContext = await requireTenantContext();
    const supabase = await createSupabaseServerClient();

    // 실패한 재조정 로그 조회
    const { data: log, error: logError } = await supabase
      .from("reschedule_log")
      .select("*")
      .eq("id", rescheduleLogId)
      .eq("status", "failed")
      .single();

    if (logError || !log) {
      throw new AppError(
        "실패한 재조정 로그를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // TODO: 실제 복구 로직 구현
    // 1. plan_history에서 백업된 플랜 복원
    // 2. 재조정 로그 상태 업데이트
    // 3. 관련 플랜 정리

    // 임시로 상태만 업데이트
    const { error: updateError } = await supabase
      .from("reschedule_log")
      .update({ status: "pending" }) // 재시도 가능하도록 pending으로 변경
      .eq("id", rescheduleLogId);

    if (updateError) {
      throw new AppError(
        `로그 상태 업데이트 실패: ${updateError.message}`,
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    return {
      success: true,
      recoveredLogs: 1,
    };
  })();
}

export const recoverFailedReschedule = withErrorHandling(_recoverFailedReschedule);
</file>

<file path="actions/schools/export.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { exportToExcel } from "@/lib/utils/excel";

/**
 * 학교 관리 데이터를 Excel 파일로 다운로드
 */
export async function exportSchoolsToExcel(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // 전체 학교 데이터 조회
  const { data: schools, error } = await supabase
    .from("schools")
    .select("*")
    .order("type", { ascending: true })
    .order("name", { ascending: true });

  if (error) {
    throw new Error(`학교 데이터 조회 실패: ${error.message}`);
  }

  // Excel 시트 데이터 준비
  const sheets = {
    schools: (schools || []).map((school) => ({
      id: school.id,
      name: school.name,
      type: school.type ?? "",
      region_id: school.region_id ?? "",
      address: school.address ?? "",
      postal_code: school.postal_code ?? "",
      address_detail: school.address_detail ?? "",
      city: school.city ?? "",
      district: school.district ?? "",
      phone: school.phone ?? "",
      category: school.category ?? "",
      university_type: school.university_type ?? "",
      university_ownership: school.university_ownership ?? "",
      campus_name: school.campus_name ?? "",
      display_order: school.display_order ?? 0,
      is_active: school.is_active ?? true,
      created_at: school.created_at ?? "",
      updated_at: school.updated_at ?? "",
    })),
  };

  return exportToExcel(sheets);
}

/**
 * 학교 관리 양식 파일 다운로드
 */
export async function downloadSchoolsTemplate(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const sheets = {
    schools: [
      "id",
      "name",
      "type",
      "region_id",
      "address",
      "postal_code",
      "address_detail",
      "city",
      "district",
      "phone",
      "category",
      "university_type",
      "university_ownership",
      "campus_name",
      "display_order",
      "is_active",
      "created_at",
      "updated_at",
    ],
  };

  const { generateTemplateExcel } = await import("@/lib/utils/excel");
  return generateTemplateExcel(sheets);
}
</file>

<file path="actions/schools/import.ts">
"use server";

import { revalidatePath } from "next/cache";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { parseExcelFile, validateExcelFile } from "@/lib/utils/excel";
import { z } from "zod";

// Zod 스키마 정의
const schoolSchema = z.object({
  id: z.string().uuid().optional(),
  name: z.string().min(1),
  type: z.enum(["중학교", "고등학교", "대학교"]).optional().nullable(),
  region_id: z.string().uuid().optional().nullable(),
  address: z.string().optional().nullable(),
  postal_code: z.string().optional().nullable(),
  address_detail: z.string().optional().nullable(),
  city: z.string().optional().nullable(),
  district: z.string().optional().nullable(),
  phone: z.string().optional().nullable(),
  category: z.enum(["일반고", "특목고", "자사고", "특성화고"]).optional().nullable(),
  university_type: z.enum(["4년제", "2년제"]).optional().nullable(),
  university_ownership: z.enum(["국립", "사립"]).optional().nullable(),
  campus_name: z.string().optional().nullable(),
  display_order: z.union([z.number(), z.string()]).default(0).transform((val) => {
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? 0 : num;
    }
    return val ?? 0;
  }),
  is_active: z.union([z.boolean(), z.string()]).default(true).transform((val) => {
    if (typeof val === "string") {
      return val === "true" || val === "1" || val === "on";
    }
    return val ?? true;
  }),
});

/**
 * 학교 관리 데이터를 Excel 파일에서 가져와 전체 교체
 */
export async function importSchoolsFromExcel(
  fileBuffer: Buffer | Uint8Array
): Promise<{ success: boolean; message: string; errors?: string[] }> {
  // Uint8Array를 Buffer로 변환
  const buffer = Buffer.isBuffer(fileBuffer) ? fileBuffer : Buffer.from(fileBuffer);
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // Excel 파일 검증
  const validation = validateExcelFile(buffer, ["schools"]);
  if (!validation.valid) {
    return {
      success: false,
      message: validation.error || "Excel 파일 검증에 실패했습니다.",
    };
  }

  // Excel 파일 파싱
  const sheets = parseExcelFile(buffer);
  const errors: string[] = [];

  try {
    // 1. 기존 데이터 삭제
    const { error: deleteError } = await supabase
      .from("schools")
      .delete()
      .neq("id", "00000000-0000-0000-0000-000000000000");

    if (deleteError) {
      throw new Error(`기존 데이터 삭제 실패: ${deleteError.message}`);
    }

    // 2. 새 데이터 삽입
    const schoolsData = sheets.schools || [];
    const schoolsToInsert: any[] = [];

    for (const row of schoolsData) {
      try {
        const validated = schoolSchema.parse(row);
        
        const schoolData: any = {
          name: validated.name,
          type: validated.type || null,
          region_id: validated.region_id || null,
          address: validated.address || null,
          postal_code: validated.postal_code || null,
          address_detail: validated.address_detail || null,
          city: validated.city || null,
          district: validated.district || null,
          phone: validated.phone || null,
          category: validated.category || null,
          university_type: validated.university_type || null,
          university_ownership: validated.university_ownership || null,
          campus_name: validated.campus_name || null,
          display_order: validated.display_order,
          is_active: validated.is_active,
        };

        // ID가 있으면 포함
        if (validated.id) {
          schoolData.id = validated.id;
        }

        schoolsToInsert.push(schoolData);
      } catch (error) {
        errors.push(
          `학교 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`
        );
      }
    }

    // 배치 삽입 (Supabase는 최대 1000개까지 한 번에 삽입 가능)
    const batchSize = 1000;
    for (let i = 0; i < schoolsToInsert.length; i += batchSize) {
      const batch = schoolsToInsert.slice(i, i + batchSize);
      const { error: insertError } = await supabase
        .from("schools")
        .insert(batch);

      if (insertError) {
        throw new Error(`데이터 삽입 실패: ${insertError.message}`);
      }
    }

    revalidatePath("/admin/schools");

    if (errors.length > 0) {
      return {
        success: true,
        message: `데이터를 가져왔지만 일부 오류가 발생했습니다. (${errors.length}개 오류)`,
        errors,
      };
    }

    return {
      success: true,
      message: `데이터를 성공적으로 가져왔습니다. (${schoolsToInsert.length}개 학교)`,
    };
  } catch (error) {
    return {
      success: false,
      message: `데이터 가져오기 실패: ${error instanceof Error ? error.message : "알 수 없는 오류"}`,
      errors: [error instanceof Error ? error.message : "알 수 없는 오류"],
    };
  }
}
</file>

<file path="actions/subjects/export.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { exportToExcel } from "@/lib/utils/excel";
import { getCurriculumRevisions } from "@/lib/data/contentMetadata";
import {
  getSubjectGroups,
  getSubjectsByGroup,
  getSubjectTypes,
} from "@/lib/data/subjects";

/**
 * 교과/과목 관리 데이터를 Excel 파일로 다운로드
 * 4개 시트로 구성: curriculum_revisions, subject_groups, subjects, subject_types
 */
export async function exportSubjectsToExcel(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // 1. 개정교육과정 조회
  const curriculumRevisions = await getCurriculumRevisions();

  // 2. 교과 그룹 조회 (모든 개정교육과정)
  const allSubjectGroups = await getSubjectGroups();

  // 3. 과목 조회 (모든 교과 그룹)
  const allSubjects: any[] = [];
  for (const group of allSubjectGroups) {
    const subjects = await getSubjectsByGroup(group.id);
    allSubjects.push(...subjects);
  }

  // 4. 과목구분 조회 (모든 개정교육과정)
  const allSubjectTypes = await getSubjectTypes();

  // Excel 시트 데이터 준비
  const sheets = {
    curriculum_revisions: curriculumRevisions.map((rev) => ({
      id: rev.id,
      name: rev.name,
      year: rev.year ?? "",
      is_active: rev.is_active ?? true,
      created_at: rev.created_at ?? "",
      updated_at: rev.updated_at ?? "",
    })),
    subject_groups: allSubjectGroups.map((group) => ({
      id: group.id,
      curriculum_revision_id: group.curriculum_revision_id,
      curriculum_revision_name: curriculumRevisions.find(
        (r) => r.id === group.curriculum_revision_id
      )?.name ?? "",
      name: group.name,
      created_at: group.created_at ?? "",
      updated_at: group.updated_at ?? "",
    })),
    subjects: allSubjects.map((subject) => ({
      id: subject.id,
      subject_group_id: subject.subject_group_id,
      subject_group_name: allSubjectGroups.find(
        (g) => g.id === subject.subject_group_id
      )?.name ?? "",
      name: subject.name,
      subject_type_id: subject.subject_type_id ?? "",
      subject_type_name: allSubjectTypes.find(
        (t) => t.id === subject.subject_type_id
      )?.name ?? "",
      is_active: subject.is_active ?? true,
      created_at: subject.created_at ?? "",
      updated_at: subject.updated_at ?? "",
    })),
    subject_types: allSubjectTypes.map((type) => ({
      id: type.id,
      curriculum_revision_id: type.curriculum_revision_id,
      curriculum_revision_name: curriculumRevisions.find(
        (r) => r.id === type.curriculum_revision_id
      )?.name ?? "",
      name: type.name,
      is_active: type.is_active ?? true,
      created_at: type.created_at ?? "",
      updated_at: type.updated_at ?? "",
    })),
  };

  return exportToExcel(sheets);
}

/**
 * 교과/과목 관리 양식 파일 다운로드
 */
export async function downloadSubjectsTemplate(): Promise<Buffer> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const sheets = {
    curriculum_revisions: [
      "id",
      "name",
      "year",
      "is_active",
      "created_at",
      "updated_at",
    ],
    subject_groups: [
      "id",
      "curriculum_revision_id",
      "curriculum_revision_name",
      "name",
      "created_at",
      "updated_at",
    ],
    subjects: [
      "id",
      "subject_group_id",
      "subject_group_name",
      "name",
      "subject_type_id",
      "subject_type_name",
      "is_active",
      "created_at",
      "updated_at",
    ],
    subject_types: [
      "id",
      "curriculum_revision_id",
      "curriculum_revision_name",
      "name",
      "is_active",
      "created_at",
      "updated_at",
    ],
  };

  const { generateTemplateExcel } = await import("@/lib/utils/excel");
  return generateTemplateExcel(sheets);
}
</file>

<file path="actions/subjects/import.ts">
"use server";

import { revalidatePath } from "next/cache";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { parseExcelFile, validateExcelFile } from "@/lib/utils/excel";
import { z } from "zod";

// Zod 스키마 정의
const curriculumRevisionSchema = z.object({
  id: z.string().uuid().optional(),
  name: z.string().min(1),
  year: z.union([z.number(), z.string()]).optional().transform((val) => {
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? null : num;
    }
    return val ?? null;
  }),
  display_order: z.union([z.number(), z.string()]).default(0).transform((val) => {
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? 0 : num;
    }
    return val ?? 0;
  }),
  is_active: z.union([z.boolean(), z.string()]).default(true).transform((val) => {
    if (typeof val === "string") {
      return val === "true" || val === "1" || val === "on";
    }
    return val ?? true;
  }),
});

const subjectGroupSchema = z.object({
  id: z.string().uuid().optional(),
  curriculum_revision_id: z.string().uuid().optional(),
  curriculum_revision_name: z.string().optional(),
  name: z.string().min(1),
  display_order: z.union([z.number(), z.string()]).default(0).transform((val) => {
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? 0 : num;
    }
    return val ?? 0;
  }),
});

const subjectSchema = z.object({
  id: z.string().uuid().optional(),
  subject_group_id: z.string().uuid().optional(),
  subject_group_name: z.string().optional(),
  name: z.string().min(1),
  subject_type_id: z.string().uuid().optional().nullable(),
  subject_type_name: z.string().optional(),
  display_order: z.union([z.number(), z.string()]).default(0).transform((val) => {
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? 0 : num;
    }
    return val ?? 0;
  }),
  is_active: z.union([z.boolean(), z.string()]).default(true).transform((val) => {
    if (typeof val === "string") {
      return val === "true" || val === "1" || val === "on";
    }
    return val ?? true;
  }),
});

const subjectTypeSchema = z.object({
  id: z.string().uuid().optional(),
  curriculum_revision_id: z.string().uuid().optional(),
  curriculum_revision_name: z.string().optional(),
  name: z.string().min(1),
  display_order: z.union([z.number(), z.string()]).default(0).transform((val) => {
    if (typeof val === "string") {
      const num = parseInt(val, 10);
      return isNaN(num) ? 0 : num;
    }
    return val ?? 0;
  }),
  is_active: z.union([z.boolean(), z.string()]).default(true).transform((val) => {
    if (typeof val === "string") {
      return val === "true" || val === "1" || val === "on";
    }
    return val ?? true;
  }),
});

/**
 * 교과/과목 관리 데이터를 Excel 파일에서 가져와 전체 교체
 */
export async function importSubjectsFromExcel(
  fileBuffer: Buffer | Uint8Array
): Promise<{ success: boolean; message: string; errors?: string[] }> {
  // Uint8Array를 Buffer로 변환
  const buffer = Buffer.isBuffer(fileBuffer) ? fileBuffer : Buffer.from(fileBuffer);
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const supabase = createSupabaseAdminClient();
  if (!supabase) {
    throw new Error("데이터베이스 연결에 실패했습니다.");
  }

  // Excel 파일 검증
  const validation = validateExcelFile(buffer, [
    "curriculum_revisions",
    "subject_groups",
    "subjects",
    "subject_types",
  ]);
  if (!validation.valid) {
    return {
      success: false,
      message: validation.error || "Excel 파일 검증에 실패했습니다.",
    };
  }

  // Excel 파일 파싱
  const sheets = parseExcelFile(buffer);
  const errors: string[] = [];

  try {
    // 트랜잭션 시작 (Supabase는 자동 트랜잭션을 지원하지 않으므로 순차 처리)
    
    // 1. 기존 데이터 삭제 (외래키 제약조건 고려하여 역순으로 삭제)
    await supabase.from("subjects").delete().neq("id", "00000000-0000-0000-0000-000000000000");
    await supabase.from("subject_groups").delete().neq("id", "00000000-0000-0000-0000-000000000000");
    await supabase.from("subject_types").delete().neq("id", "00000000-0000-0000-0000-000000000000");
    await supabase.from("curriculum_revisions").delete().neq("id", "00000000-0000-0000-0000-000000000000");

    // 2. 개정교육과정 데이터 처리
    const curriculumRevisionsData = sheets.curriculum_revisions || [];
    const revisionMap = new Map<string, string>(); // name -> id 매핑
    const revisionIdMap = new Map<string, string>(); // 기존 id -> 새 id 매핑

    for (const row of curriculumRevisionsData) {
      try {
        const validated = curriculumRevisionSchema.parse(row);
        
        // ID가 있으면 기존 ID 사용, 없으면 새로 생성
        let revisionId = validated.id;
        if (!revisionId) {
          const { data: existing } = await supabase
            .from("curriculum_revisions")
            .select("id")
            .eq("name", validated.name)
            .maybeSingle();
          
          if (existing) {
            revisionId = existing.id;
          } else {
            const { data: newRevision, error } = await supabase
              .from("curriculum_revisions")
              .insert({
                name: validated.name,
                year: validated.year,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            revisionId = newRevision.id;
          }
        } else {
          // 기존 ID로 업데이트 또는 생성
          const { data: existing } = await supabase
            .from("curriculum_revisions")
            .select("id")
            .eq("id", revisionId)
            .maybeSingle();
          
          if (existing) {
            await supabase
              .from("curriculum_revisions")
              .update({
                name: validated.name,
                year: validated.year,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .eq("id", revisionId);
          } else {
            const { data: newRevision, error } = await supabase
              .from("curriculum_revisions")
              .insert({
                id: revisionId,
                name: validated.name,
                year: validated.year,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            revisionId = newRevision.id;
          }
        }
        
        if (revisionId) {
          revisionMap.set(validated.name, revisionId);
          if (validated.id) {
            revisionIdMap.set(validated.id, revisionId);
          }
        }
      } catch (error) {
        errors.push(`개정교육과정 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`);
      }
    }

    // 3. 과목구분 데이터 처리 (개정교육과정이 먼저 필요)
    const subjectTypesData = sheets.subject_types || [];
    const subjectTypeMap = new Map<string, string>(); // (revision_name, type_name) -> id 매핑

    for (const row of subjectTypesData) {
      try {
        const validated = subjectTypeSchema.parse(row);
        
        // curriculum_revision_id 또는 curriculum_revision_name으로 개정교육과정 찾기
        let revisionId = validated.curriculum_revision_id;
        if (!revisionId && validated.curriculum_revision_name) {
          revisionId = revisionMap.get(validated.curriculum_revision_name);
        }
        
        if (!revisionId) {
          throw new Error(`개정교육과정을 찾을 수 없습니다: ${validated.curriculum_revision_name || validated.curriculum_revision_id}`);
        }

        let typeId = validated.id;
        if (!typeId) {
          const { data: existing } = await supabase
            .from("subject_types")
            .select("id")
            .eq("curriculum_revision_id", revisionId)
            .eq("name", validated.name)
            .maybeSingle();
          
          if (existing) {
            typeId = existing.id;
          } else {
            const { data: newType, error } = await supabase
              .from("subject_types")
              .insert({
                curriculum_revision_id: revisionId,
                name: validated.name,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            typeId = newType.id;
          }
        } else {
          const { data: existing } = await supabase
            .from("subject_types")
            .select("id")
            .eq("id", typeId)
            .maybeSingle();
          
          if (existing) {
            await supabase
              .from("subject_types")
              .update({
                curriculum_revision_id: revisionId,
                name: validated.name,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .eq("id", typeId);
          } else {
            const { data: newType, error } = await supabase
              .from("subject_types")
              .insert({
                id: typeId,
                curriculum_revision_id: revisionId,
                name: validated.name,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            typeId = newType.id;
          }
        }
        
        if (typeId) {
          const key = `${validated.curriculum_revision_name || revisionId}:${validated.name}`;
          subjectTypeMap.set(key, typeId);
        }
      } catch (error) {
        errors.push(`과목구분 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`);
      }
    }

    // 4. 교과 그룹 데이터 처리
    const subjectGroupsData = sheets.subject_groups || [];
    const subjectGroupMap = new Map<string, string>(); // (revision_name, group_name) -> id 매핑

    for (const row of subjectGroupsData) {
      try {
        const validated = subjectGroupSchema.parse(row);
        
        // curriculum_revision_id 또는 curriculum_revision_name으로 개정교육과정 찾기
        let revisionId = validated.curriculum_revision_id;
        if (!revisionId && validated.curriculum_revision_name) {
          revisionId = revisionMap.get(validated.curriculum_revision_name);
        }
        
        if (!revisionId) {
          throw new Error(`개정교육과정을 찾을 수 없습니다: ${validated.curriculum_revision_name || validated.curriculum_revision_id}`);
        }

        let groupId = validated.id;
        if (!groupId) {
          const { data: existing } = await supabase
            .from("subject_groups")
            .select("id")
            .eq("curriculum_revision_id", revisionId)
            .eq("name", validated.name)
            .maybeSingle();
          
          if (existing) {
            groupId = existing.id;
          } else {
            const { data: newGroup, error } = await supabase
              .from("subject_groups")
              .insert({
                curriculum_revision_id: revisionId,
                name: validated.name,
                display_order: validated.display_order,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            groupId = newGroup.id;
          }
        } else {
          const { data: existing } = await supabase
            .from("subject_groups")
            .select("id")
            .eq("id", groupId)
            .maybeSingle();
          
          if (existing) {
            await supabase
              .from("subject_groups")
              .update({
                curriculum_revision_id: revisionId,
                name: validated.name,
                display_order: validated.display_order,
              })
              .eq("id", groupId);
          } else {
            const { data: newGroup, error } = await supabase
              .from("subject_groups")
              .insert({
                id: groupId,
                curriculum_revision_id: revisionId,
                name: validated.name,
                display_order: validated.display_order,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            groupId = newGroup.id;
          }
        }
        
        if (groupId) {
          const key = `${validated.curriculum_revision_name || revisionId}:${validated.name}`;
          subjectGroupMap.set(key, groupId);
        }
      } catch (error) {
        errors.push(`교과 그룹 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`);
      }
    }

    // 5. 과목 데이터 처리 (교과 그룹과 과목구분이 먼저 필요)
    const subjectsData = sheets.subjects || [];

    for (const row of subjectsData) {
      try {
        const validated = subjectSchema.parse(row);
        
        // subject_group_id 또는 subject_group_name으로 교과 그룹 찾기
        let groupId = validated.subject_group_id;
        if (!groupId && validated.subject_group_name) {
          // revision_name도 함께 확인
          for (const [key, id] of subjectGroupMap.entries()) {
            if (key.endsWith(`:${validated.subject_group_name}`)) {
              groupId = id;
              break;
            }
          }
        }
        
        if (!groupId) {
          throw new Error(`교과 그룹을 찾을 수 없습니다: ${validated.subject_group_name || validated.subject_group_id}`);
        }

        // subject_type_id 또는 subject_type_name으로 과목구분 찾기
        let typeId = validated.subject_type_id;
        if (!typeId && validated.subject_type_name) {
          // revision_name도 함께 확인
          for (const [key, id] of subjectTypeMap.entries()) {
            if (key.endsWith(`:${validated.subject_type_name}`)) {
              typeId = id;
              break;
            }
          }
        }

        let subjectId = validated.id;
        if (!subjectId) {
          const { data: existing } = await supabase
            .from("subjects")
            .select("id")
            .eq("subject_group_id", groupId)
            .eq("name", validated.name)
            .maybeSingle();
          
          if (existing) {
            subjectId = existing.id;
          } else {
            const { data: newSubject, error } = await supabase
              .from("subjects")
              .insert({
                subject_group_id: groupId,
                name: validated.name,
                subject_type_id: typeId || null,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            subjectId = newSubject.id;
          }
        } else {
          const { data: existing } = await supabase
            .from("subjects")
            .select("id")
            .eq("id", subjectId)
            .maybeSingle();
          
          if (existing) {
            await supabase
              .from("subjects")
              .update({
                subject_group_id: groupId,
                name: validated.name,
                subject_type_id: typeId || null,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .eq("id", subjectId);
          } else {
            const { data: newSubject, error } = await supabase
              .from("subjects")
              .insert({
                id: subjectId,
                subject_group_id: groupId,
                name: validated.name,
                subject_type_id: typeId || null,
                display_order: validated.display_order,
                is_active: validated.is_active,
              })
              .select("id")
              .single();
            
            if (error) throw error;
            subjectId = newSubject.id;
          }
        }
      } catch (error) {
        errors.push(`과목 처리 실패 (${JSON.stringify(row)}): ${error instanceof Error ? error.message : "알 수 없는 오류"}`);
      }
    }

    revalidatePath("/admin/subjects");

    if (errors.length > 0) {
      return {
        success: true,
        message: `데이터를 가져왔지만 일부 오류가 발생했습니다. (${errors.length}개 오류)`,
        errors,
      };
    }

    return {
      success: true,
      message: "데이터를 성공적으로 가져왔습니다.",
    };
  } catch (error) {
    return {
      success: false,
      message: `데이터 가져오기 실패: ${error instanceof Error ? error.message : "알 수 없는 오류"}`,
      errors: [error instanceof Error ? error.message : "알 수 없는 오류"],
    };
  }
}
</file>

<file path="actions/adminUserActions.ts">
"use server";

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";

/**
 * 관리자 계정 생성
 */
export async function createAdminUser(formData: FormData) {
  const { role: currentRole } = await getCurrentUserRole();

  // Super Admin만 접근 가능
  if (currentRole !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const userEmail = formData.get("user_email")?.toString();
  const userRole = formData.get("role")?.toString() as "admin" | "consultant";

  if (!userEmail || !userRole) {
    throw new Error("이메일과 역할을 입력해주세요.");
  }

  if (userRole !== "admin" && userRole !== "consultant") {
    throw new Error("올바른 역할을 선택해주세요.");
  }

  const supabase = await createSupabaseServerClient();

  // 이메일로 사용자 조회 (Service Role Key 필요)
  const adminClient = createSupabaseAdminClient();
  if (!adminClient) {
    throw new Error(
      "SUPABASE_SERVICE_ROLE_KEY 환경 변수가 설정되지 않았습니다."
    );
  }

  const { data: users, error: listError } =
    await adminClient.auth.admin.listUsers();

  if (listError) {
    console.error("[admin-users] 사용자 목록 조회 실패:", listError);
    throw new Error("사용자 목록을 조회할 수 없습니다.");
  }

  const user = users.users.find(
    (u: { email?: string }) => u.email === userEmail
  );

  if (!user) {
    throw new Error("해당 이메일의 사용자를 찾을 수 없습니다.");
  }

  // 이미 관리자인지 확인
  const { data: existingAdmin } = await supabase
    .from("admin_users")
    .select("id")
    .eq("id", user.id)
    .maybeSingle();

  if (existingAdmin) {
    throw new Error("이미 관리자로 등록된 사용자입니다.");
  }

  // admin_users에 추가
  const { error: insertError } = await supabase.from("admin_users").insert({
    id: user.id,
    role: userRole,
  });

  if (insertError) {
    console.error("[admin-users] 관리자 계정 생성 실패:", insertError);
    throw new Error(insertError.message || "관리자 계정 생성에 실패했습니다.");
  }
}

/**
 * 관리자 권한 제거
 */
export async function deleteAdminUser(userId: string) {
  const { role: currentRole, userId: currentUserId } =
    await getCurrentUserRole();

  // Super Admin만 접근 가능
  if (currentRole !== "admin") {
    throw new Error("관리자 권한이 필요합니다.");
  }

  // 자신의 권한은 제거할 수 없음
  if (currentUserId === userId) {
    throw new Error("자신의 관리자 권한은 제거할 수 없습니다.");
  }

  const supabase = await createSupabaseServerClient();

  const { error: deleteError } = await supabase
    .from("admin_users")
    .delete()
    .eq("id", userId);

  if (deleteError) {
    console.error("[admin-users] 관리자 권한 제거 실패:", deleteError);
    throw new Error(deleteError.message || "관리자 권한 제거에 실패했습니다.");
  }
}
</file>

<file path="actions/attendanceActions.ts">
"use server";

import { revalidatePath } from "next/cache";
import { requireAdminAuth } from "@/lib/auth/requireAdminAuth";
import {
  recordAttendance,
  getAttendanceRecords,
  getAttendanceByStudent,
  calculateAttendanceStats,
  deleteAttendanceRecord as deleteRecord,
  validateAttendanceRecord,
} from "@/lib/domains/attendance/service";
import type {
  CreateAttendanceRecordInput,
  UpdateAttendanceRecordInput,
  AttendanceFilters,
} from "@/lib/domains/attendance/types";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";
import { sendAttendanceSMSIfEnabled } from "@/lib/services/attendanceSMSService";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import type { UpdateAttendanceRecordRequest, AttendanceRecordHistory } from "@/lib/types/attendance";

/**
 * 출석 기록 생성 또는 수정
 */
export async function recordAttendanceAction(
  input: CreateAttendanceRecordInput
): Promise<{ success: boolean; error?: string }> {
  const handler = withErrorHandling(async () => {
    await requireAdminAuth();

    // 입력 검증
    if (!input.student_id) {
      throw new AppError(
        "학생 ID가 필요합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!input.attendance_date) {
      throw new AppError(
        "출석 날짜가 필요합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const record = await recordAttendance(input);

    // 출석 기록 저장 후 자동 SMS 발송 (비동기, 실패해도 출석 기록은 저장됨)
    try {
      const tenantContext = await getTenantContext();
      const supabase = await createSupabaseServerClient();

      // 학생 정보 조회
      const { data: student } = await supabase
        .from("students")
        .select("id, name, mother_phone, father_phone")
        .eq("id", input.student_id)
        .single();

      // student_profiles 테이블에서 phone 정보 조회 (선택사항)
      let profile: { phone?: string | null; mother_phone?: string | null; father_phone?: string | null } | null = null;
      try {
        const { data: profileData } = await supabase
          .from("student_profiles")
          .select("phone, mother_phone, father_phone")
          .eq("id", input.student_id)
          .maybeSingle();
        if (profileData) {
          profile = profileData;
        }
      } catch (e) {
        // student_profiles 테이블이 없으면 무시
      }

      // 학원명 조회
      const { data: tenant } = await supabase
        .from("tenants")
        .select("name")
        .eq("id", tenantContext?.tenantId)
        .single();

      // 학부모 연락처 확인 (mother_phone 또는 father_phone이 있는지)
      const hasParentContact = 
        profile?.mother_phone || 
        profile?.father_phone || 
        student?.mother_phone || 
        student?.father_phone;

      // 학부모 연락처가 있고, 출석 상태에 따라 SMS 발송
      if (hasParentContact && tenant?.name) {
        const academyName = tenant.name;
        const studentName = student?.name || "학생";
        const attendanceDate = new Date(input.attendance_date).toLocaleDateString(
          "ko-KR",
          { month: "long", day: "numeric" }
        );

        // 입실 알림: present 상태이고 check_in_time이 있는 경우
        if (
          record.status === "present" &&
          record.check_in_time &&
          !record.check_out_time
        ) {
          const checkInTime = new Date(
            `${input.attendance_date}T${record.check_in_time}`
          ).toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          await sendAttendanceSMSIfEnabled(
            input.student_id,
            "attendance_check_in",
            {
              학원명: academyName,
              학생명: studentName,
              시간: checkInTime,
            },
            false // 관리자가 기록한 경우
          );
        }

        // 퇴실 알림: present 상태이고 check_out_time이 있는 경우
        if (
          record.status === "present" &&
          record.check_out_time
        ) {
          const checkOutTime = new Date(
            `${input.attendance_date}T${record.check_out_time}`
          ).toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          await sendAttendanceSMSIfEnabled(
            input.student_id,
            "attendance_check_out",
            {
              학원명: academyName,
              학생명: studentName,
              시간: checkOutTime,
            },
            false // 관리자가 기록한 경우
          );
        }

        // 결석 알림: absent 상태인 경우
        if (record.status === "absent") {
          await sendAttendanceSMSIfEnabled(
            input.student_id,
            "attendance_absent",
            {
              학원명: academyName,
              학생명: studentName,
              날짜: attendanceDate,
            },
            false // 관리자가 기록한 경우
          );
        }

        // 지각 알림: late 상태인 경우
        if (record.status === "late" && record.check_in_time) {
          const checkInTime = new Date(
            `${input.attendance_date}T${record.check_in_time}`
          ).toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          await sendAttendanceSMSIfEnabled(
            input.student_id,
            "attendance_late",
            {
              학원명: academyName,
              학생명: studentName,
              시간: checkInTime,
            },
            false // 관리자가 기록한 경우
          );
        }
      }
    } catch (error) {
      // SMS 발송 실패는 로그만 남기고 출석 기록 저장은 정상 처리
      console.error("[Attendance] SMS 발송 중 오류:", error);
    }

    revalidatePath("/admin/attendance");
    revalidatePath(`/admin/students/${input.student_id}`);
    return { success: true };
  });
  return await handler();
}

/**
 * 출석 기록 조회
 */
export async function getAttendanceRecordsAction(
  filters: AttendanceFilters
): Promise<{
  success: boolean;
  data?: Array<{
    id: string;
    student_id: string;
    attendance_date: string;
    check_in_time: string | null;
    check_out_time: string | null;
    check_in_method: string | null;
    check_out_method: string | null;
    status: string;
    notes: string | null;
    created_at: string;
  }>;
  error?: string;
}> {
  const handler = withErrorHandling(async () => {
    await requireAdminAuth();

    const records = await getAttendanceRecords(filters);

    return {
      success: true,
      data: records.map((record) => ({
        id: record.id,
        student_id: record.student_id,
        attendance_date: record.attendance_date,
        check_in_time: record.check_in_time,
        check_out_time: record.check_out_time,
        check_in_method: record.check_in_method,
        check_out_method: record.check_out_method,
        status: record.status,
        notes: record.notes,
        created_at: record.created_at,
      })),
    };
  });
  return await handler();
}

/**
 * 학생별 출석 기록 조회
 */
export async function getAttendanceByStudentAction(
  studentId: string,
  startDate?: string,
  endDate?: string
): Promise<{
  success: boolean;
  data?: Array<{
    id: string;
    attendance_date: string;
    check_in_time: string | null;
    check_out_time: string | null;
    status: string;
    notes: string | null;
  }>;
  error?: string;
}> {
  const handler = withErrorHandling(async () => {
    await requireAdminAuth();

    const records = await getAttendanceByStudent(studentId, startDate, endDate);

    return {
      success: true,
      data: records.map((record) => ({
        id: record.id,
        attendance_date: record.attendance_date,
        check_in_time: record.check_in_time,
        check_out_time: record.check_out_time,
        status: record.status,
        notes: record.notes,
      })),
    };
  });
  return await handler();
}

/**
 * 출석 통계 조회
 */
export async function getAttendanceStatisticsAction(
  studentId: string,
  startDate?: string,
  endDate?: string
): Promise<{
  success: boolean;
  data?: {
    total_days: number;
    present_count: number;
    absent_count: number;
    late_count: number;
    early_leave_count: number;
    excused_count: number;
    attendance_rate: number;
    late_rate: number;
    absent_rate: number;
  };
  error?: string;
}> {
  const handler = withErrorHandling(async () => {
    await requireAdminAuth();

    const stats = await calculateAttendanceStats(
      studentId,
      startDate,
      endDate
    );

    return {
      success: true,
      data: stats,
    };
  });
  return await handler();
}

/**
 * 출석 기록 삭제
 */
export async function deleteAttendanceRecordAction(
  recordId: string,
  studentId: string
): Promise<{ success: boolean; error?: string }> {
  const handler = withErrorHandling(async () => {
    await requireAdminAuth();

    await deleteRecord(recordId);

    revalidatePath("/admin/attendance");
    revalidatePath(`/admin/students/${studentId}`);
    return { success: true };
  });
  return await handler();
}

/**
 * 출석 기록 수정
 */
export async function updateAttendanceRecord(
  recordId: string,
  updates: UpdateAttendanceRecordRequest
): Promise<{ success: boolean; error?: string }> {
  const handler = withErrorHandling(async () => {
    // 1. 관리자 인증 확인
    const admin = await requireAdminAuth();
    
    // 2. 테넌트 컨텍스트 확인
    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404
      );
    }
    
    const supabase = await createSupabaseServerClient();
    
    // 3. 기존 기록 조회 및 원본 백업
    const { data: existingRecord, error: fetchError } = await supabase
      .from("attendance_records")
      .select("*")
      .eq("id", recordId)
      .eq("tenant_id", tenantContext.tenantId)
      .single();
    
    if (fetchError || !existingRecord) {
      throw new AppError(
        "출석 기록을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404
      );
    }
    
    // 4. 수정 데이터 준비
    const updateData: Partial<typeof existingRecord> = {
      updated_at: new Date().toISOString(),
    };
    
    if (updates.check_in_time !== undefined) {
      updateData.check_in_time = updates.check_in_time;
    }
    if (updates.check_out_time !== undefined) {
      updateData.check_out_time = updates.check_out_time;
    }
    if (updates.check_in_method !== undefined) {
      updateData.check_in_method = updates.check_in_method;
    }
    if (updates.check_out_method !== undefined) {
      updateData.check_out_method = updates.check_out_method;
    }
    if (updates.status !== undefined) {
      updateData.status = updates.status;
    }
    if (updates.notes !== undefined) {
      updateData.notes = updates.notes;
    }
    
    // 5. 검증 (수정된 데이터 기준)
    const updatedRecord = { ...existingRecord, ...updateData };
    // 검증을 위해 student_id와 attendance_date를 포함한 전체 입력 객체 생성
    const validationInput: UpdateAttendanceRecordInput = {
      ...updateData,
    };
    const validation = await validateAttendanceRecord(validationInput, existingRecord);
    if (!validation.valid) {
      throw new AppError(
        validation.errors[0]?.message || "검증 실패",
        ErrorCode.VALIDATION_ERROR,
        400
      );
    }
    
    // 6. 트랜잭션: 기록 수정 + 이력 저장
    const { error: updateError } = await supabase
      .from("attendance_records")
      .update(updateData)
      .eq("id", recordId);
    
    if (updateError) {
      throw new AppError(
        `출석 기록 수정 실패: ${updateError.message}`,
        ErrorCode.DATABASE_ERROR,
        500
      );
    }
    
    // 7. 수정 이력 저장
    const { error: historyError } = await supabase
      .from("attendance_record_history")
      .insert({
        attendance_record_id: recordId,
        tenant_id: tenantContext.tenantId,
        student_id: existingRecord.student_id,
        before_data: existingRecord,
        after_data: updatedRecord,
        modified_by: admin.userId,
        reason: updates.reason,
      });
    
    if (historyError) {
      // 이력 저장 실패는 경고만 하고 롤백하지 않음 (기록 수정은 성공)
      console.error("[attendance] 수정 이력 저장 실패:", historyError);
    }
    
    revalidatePath("/admin/attendance");
    revalidatePath(`/admin/attendance/${recordId}/edit`);
    
    return { success: true };
  });

  return await handler();
}

/**
 * 출석 기록 수정 이력 조회
 */
export async function getAttendanceRecordHistory(
  recordId: string
): Promise<{ data: AttendanceRecordHistory[] | null; error?: string }> {
  const handler = withErrorHandling(async () => {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();
    
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404
      );
    }
    
    const supabase = await createSupabaseServerClient();
    const { data, error } = await supabase
      .from("attendance_record_history")
      .select("*")
      .eq("attendance_record_id", recordId)
      .eq("tenant_id", tenantContext.tenantId)
      .order("modified_at", { ascending: false });
    
    if (error) {
      throw new AppError(
        `이력 조회 실패: ${error.message}`,
        ErrorCode.DATABASE_ERROR,
        500
      );
    }
    
    return { data: data as AttendanceRecordHistory[] | null };
  });

  return await handler();
}
</file>

<file path="actions/attendanceSettingsActions.ts">
"use server";

import { requireAdminAuth } from "@/lib/auth/requireAdminAuth";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { revalidatePath } from "next/cache";
import {
  AppError,
  ErrorCode,
  normalizeError,
  getUserFacingMessage,
  logError,
} from "@/lib/errors";
import { DATABASE_ERROR_CODES } from "@/lib/constants/databaseErrorCodes";
import type { AttendanceSMSSettings } from "@/lib/types/attendance";

export type LocationSettingsInput = {
  latitude: number;
  longitude: number;
  radiusMeters: number;
};

/**
 * 위치 설정 업데이트
 */
export async function updateLocationSettings(
  input: LocationSettingsInput
): Promise<{ success: boolean; error?: string }> {
  try {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();

    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 좌표 유효성 검증
    if (
      typeof input.latitude !== "number" ||
      typeof input.longitude !== "number" ||
      isNaN(input.latitude) ||
      isNaN(input.longitude)
    ) {
      throw new AppError(
        "유효하지 않은 좌표입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (
      input.latitude < -90 ||
      input.latitude > 90 ||
      input.longitude < -180 ||
      input.longitude > 180
    ) {
      throw new AppError(
        "좌표가 범위를 벗어났습니다. (위도: -90~90, 경도: -180~180)",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (
      typeof input.radiusMeters !== "number" ||
      isNaN(input.radiusMeters) ||
      input.radiusMeters <= 0
    ) {
      throw new AppError(
        "반경은 0보다 큰 숫자여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    // 위치 정보 업데이트
    const { error } = await supabase
      .from("tenants")
      .update({
        location_latitude: input.latitude,
        location_longitude: input.longitude,
        location_radius_meters: input.radiusMeters,
        updated_at: new Date().toISOString(),
      })
      .eq("id", tenantContext.tenantId);

    if (error) {
      console.error("[attendanceSettings] 위치 설정 업데이트 실패:", error);
      throw new AppError(
        error.message || "위치 설정 업데이트에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    revalidatePath("/admin/attendance/settings");
    return { success: true };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "updateLocationSettings" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * 현재 위치 설정 조회
 */
export async function getLocationSettings(): Promise<{
  success: boolean;
  data?: {
    latitude: number | null;
    longitude: number | null;
    radiusMeters: number | null;
  } | null;
  error?: string;
}> {
  try {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();

    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    const { data: tenant, error } = await supabase
      .from("tenants")
      .select("location_latitude, location_longitude, location_radius_meters")
      .eq("id", tenantContext.tenantId)
      .single();

    if (error) {
      console.error("[attendanceSettings] 위치 설정 조회 실패:", error);
      throw new AppError(
        error.message || "위치 설정 조회에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    if (!tenant) {
      return {
        success: true,
        data: null,
      };
    }

    return {
      success: true,
      data: {
        latitude: tenant.location_latitude,
        longitude: tenant.location_longitude,
        radiusMeters: tenant.location_radius_meters,
      },
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "getLocationSettings" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * 출석 SMS 설정 조회
 */
export async function getAttendanceSMSSettings(): Promise<{
  success: boolean;
  data?: AttendanceSMSSettings | null;
  error?: string;
}> {
  try {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();

    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    const { data: tenant, error } = await supabase
      .from("tenants")
      .select(
        "attendance_sms_check_in_enabled, attendance_sms_check_out_enabled, attendance_sms_absent_enabled, attendance_sms_late_enabled, attendance_sms_student_checkin_enabled, attendance_sms_recipient, attendance_sms_show_failure_to_user"
      )
      .eq("id", tenantContext.tenantId)
      .single();

    if (error) {
      console.error("[attendanceSettings] SMS 설정 조회 실패:", error);
      throw new AppError(
        error.message || "SMS 설정 조회에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    if (!tenant) {
      return {
        success: true,
        data: null,
      };
    }

    return {
      success: true,
      data: {
        attendance_sms_check_in_enabled:
          tenant.attendance_sms_check_in_enabled ?? true,
        attendance_sms_check_out_enabled:
          tenant.attendance_sms_check_out_enabled ?? true,
        attendance_sms_absent_enabled:
          tenant.attendance_sms_absent_enabled ?? true,
        attendance_sms_late_enabled: tenant.attendance_sms_late_enabled ?? true,
        attendance_sms_student_checkin_enabled:
          tenant.attendance_sms_student_checkin_enabled ?? false,
        attendance_sms_recipient:
          (tenant.attendance_sms_recipient as 'mother' | 'father' | 'both' | 'auto') ?? 'auto',
        attendance_sms_show_failure_to_user:
          tenant.attendance_sms_show_failure_to_user ?? false,
      },
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "getAttendanceSMSSettings" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * 출석 SMS 설정 업데이트
 */
export async function updateAttendanceSMSSettings(
  input: AttendanceSMSSettings
): Promise<{ success: boolean; error?: string }> {
  try {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();

    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 입력 데이터 검증
    const validRecipientValues = ['mother', 'father', 'both', 'auto'] as const;
    if (!validRecipientValues.includes(input.attendance_sms_recipient)) {
      throw new AppError(
        `SMS 수신자 선택 값이 올바르지 않습니다. 허용된 값: ${validRecipientValues.join(', ')}`,
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // boolean 값 검증
    if (
      typeof input.attendance_sms_check_in_enabled !== 'boolean' ||
      typeof input.attendance_sms_check_out_enabled !== 'boolean' ||
      typeof input.attendance_sms_absent_enabled !== 'boolean' ||
      typeof input.attendance_sms_late_enabled !== 'boolean' ||
      typeof input.attendance_sms_student_checkin_enabled !== 'boolean'
    ) {
      throw new AppError(
        'SMS 설정 값이 올바르지 않습니다. 모든 설정은 boolean 값이어야 합니다.',
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // Admin 클라이언트 사용 (RLS 정책 우회)
    const supabase = createSupabaseAdminClient();
    if (!supabase) {
      throw new AppError(
        "서버 설정 오류가 발생했습니다. 관리자에게 문의하세요.",
        ErrorCode.INTERNAL_ERROR,
        500,
        true
      );
    }

    // 업데이트할 데이터 준비
    const updateData = {
      attendance_sms_check_in_enabled: input.attendance_sms_check_in_enabled,
      attendance_sms_check_out_enabled:
        input.attendance_sms_check_out_enabled,
      attendance_sms_absent_enabled: input.attendance_sms_absent_enabled,
      attendance_sms_late_enabled: input.attendance_sms_late_enabled,
      attendance_sms_student_checkin_enabled:
        input.attendance_sms_student_checkin_enabled,
      attendance_sms_recipient: input.attendance_sms_recipient,
      attendance_sms_show_failure_to_user:
        input.attendance_sms_show_failure_to_user ?? false,
      updated_at: new Date().toISOString(),
    };

    console.log("[attendanceSettings] SMS 설정 업데이트 시작:", {
      tenantId: tenantContext.tenantId,
      inputData: input,
      updateData,
      usingAdminClient: true,
    });

    // SMS 설정 업데이트
    const { error, data } = await supabase
      .from("tenants")
      .update(updateData)
      .eq("id", tenantContext.tenantId)
      .select(
        "attendance_sms_check_in_enabled, attendance_sms_check_out_enabled, attendance_sms_absent_enabled, attendance_sms_late_enabled, attendance_sms_student_checkin_enabled, attendance_sms_recipient, attendance_sms_show_failure_to_user"
      );

    // 에러 처리
    if (error) {
      console.error("[attendanceSettings] SMS 설정 업데이트 실패:", {
        error,
        errorCode: error.code,
        errorMessage: error.message,
        errorDetails: error.details,
        errorHint: error.hint,
        tenantId: tenantContext.tenantId,
        updateData,
        isRLSPolicyViolation: error.code === DATABASE_ERROR_CODES.RLS_POLICY_VIOLATION,
      });

      // RLS 정책 위반 에러 명시적 처리
      if (error.code === DATABASE_ERROR_CODES.RLS_POLICY_VIOLATION) {
        throw new AppError(
          "권한이 없습니다. 관리자 권한으로 다시 시도해주세요.",
          ErrorCode.FORBIDDEN,
          403,
          true
        );
      }

      throw new AppError(
        error.message || "SMS 설정 업데이트에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    // update().select() 결과 확인
    if (!data || data.length === 0) {
      console.error("[attendanceSettings] 업데이트된 행이 없습니다:", {
        tenantId: tenantContext.tenantId,
        updateData,
        errorCode: (error as any)?.code,
        errorMessage: (error as any)?.message,
      });
      throw new AppError(
        "SMS 설정 업데이트에 실패했습니다. 업데이트된 행이 없습니다. RLS 정책 문제일 수 있습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    const updatedRow = data[0];
    console.log("[attendanceSettings] 업데이트 직후 결과 확인:", {
      tenantId: tenantContext.tenantId,
      updatedRow,
      requested: updateData,
      immediateMatch: {
        checkIn: updatedRow.attendance_sms_check_in_enabled === input.attendance_sms_check_in_enabled,
        checkOut: updatedRow.attendance_sms_check_out_enabled === input.attendance_sms_check_out_enabled,
        absent: updatedRow.attendance_sms_absent_enabled === input.attendance_sms_absent_enabled,
        late: updatedRow.attendance_sms_late_enabled === input.attendance_sms_late_enabled,
        studentCheckIn: updatedRow.attendance_sms_student_checkin_enabled === input.attendance_sms_student_checkin_enabled,
        recipient: updatedRow.attendance_sms_recipient === input.attendance_sms_recipient,
        showFailure: updatedRow.attendance_sms_show_failure_to_user === (input.attendance_sms_show_failure_to_user ?? false),
      },
    });

    // 업데이트 직후 값 불일치 확인
    const mismatches: string[] = [];
    if (updatedRow.attendance_sms_check_in_enabled !== input.attendance_sms_check_in_enabled) {
      mismatches.push(`입실 알림: 요청=${input.attendance_sms_check_in_enabled}, 저장=${updatedRow.attendance_sms_check_in_enabled}`);
    }
    if (updatedRow.attendance_sms_check_out_enabled !== input.attendance_sms_check_out_enabled) {
      mismatches.push(`퇴실 알림: 요청=${input.attendance_sms_check_out_enabled}, 저장=${updatedRow.attendance_sms_check_out_enabled}`);
    }
    if (updatedRow.attendance_sms_absent_enabled !== input.attendance_sms_absent_enabled) {
      mismatches.push(`결석 알림: 요청=${input.attendance_sms_absent_enabled}, 저장=${updatedRow.attendance_sms_absent_enabled}`);
    }
    if (updatedRow.attendance_sms_late_enabled !== input.attendance_sms_late_enabled) {
      mismatches.push(`지각 알림: 요청=${input.attendance_sms_late_enabled}, 저장=${updatedRow.attendance_sms_late_enabled}`);
    }
    if (updatedRow.attendance_sms_student_checkin_enabled !== input.attendance_sms_student_checkin_enabled) {
      mismatches.push(`학생 직접 체크인: 요청=${input.attendance_sms_student_checkin_enabled}, 저장=${updatedRow.attendance_sms_student_checkin_enabled}`);
    }
    if (updatedRow.attendance_sms_recipient !== input.attendance_sms_recipient) {
      mismatches.push(`SMS 수신자: 요청=${input.attendance_sms_recipient}, 저장=${updatedRow.attendance_sms_recipient}`);
    }
    if (updatedRow.attendance_sms_show_failure_to_user !== (input.attendance_sms_show_failure_to_user ?? false)) {
      mismatches.push(`SMS 발송 실패 알림: 요청=${input.attendance_sms_show_failure_to_user ?? false}, 저장=${updatedRow.attendance_sms_show_failure_to_user}`);
    }

    if (mismatches.length > 0) {
      console.error("[attendanceSettings] 업데이트 직후 값 불일치 감지:", {
        tenantId: tenantContext.tenantId,
        mismatches,
        updatedRow,
        requested: updateData,
      });
      throw new AppError(
        `SMS 설정 저장 중 오류가 발생했습니다. 일부 설정이 올바르게 저장되지 않았습니다: ${mismatches.join(", ")}`,
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    // 추가 검증: 재조회하여 최종 확인 (이중 검증)
    const { data: verifyData, error: verifyError } = await supabase
      .from("tenants")
      .select(
        "attendance_sms_check_in_enabled, attendance_sms_check_out_enabled, attendance_sms_absent_enabled, attendance_sms_late_enabled, attendance_sms_student_checkin_enabled, attendance_sms_recipient, attendance_sms_show_failure_to_user"
      )
      .eq("id", tenantContext.tenantId)
      .single();

    if (verifyError) {
      console.error("[attendanceSettings] SMS 설정 재검증 실패:", {
        error: verifyError,
        errorCode: verifyError.code,
        errorMessage: verifyError.message,
        tenantId: tenantContext.tenantId,
      });
      // 재검증 실패는 경고만 로깅 (이미 업데이트는 성공했을 수 있음)
    } else if (verifyData) {
      // 최종 검증: 재조회한 값과 요청한 값 비교
      const finalMismatches: string[] = [];
      if (verifyData.attendance_sms_recipient !== input.attendance_sms_recipient) {
        finalMismatches.push(`SMS 수신자: 요청=${input.attendance_sms_recipient}, 저장=${verifyData.attendance_sms_recipient}`);
      }
      if (verifyData.attendance_sms_student_checkin_enabled !== input.attendance_sms_student_checkin_enabled) {
        finalMismatches.push(`학생 직접 체크인: 요청=${input.attendance_sms_student_checkin_enabled}, 저장=${verifyData.attendance_sms_student_checkin_enabled}`);
      }
      if (verifyData.attendance_sms_check_in_enabled !== input.attendance_sms_check_in_enabled) {
        finalMismatches.push(`입실 알림: 요청=${input.attendance_sms_check_in_enabled}, 저장=${verifyData.attendance_sms_check_in_enabled}`);
      }
      if (verifyData.attendance_sms_check_out_enabled !== input.attendance_sms_check_out_enabled) {
        finalMismatches.push(`퇴실 알림: 요청=${input.attendance_sms_check_out_enabled}, 저장=${verifyData.attendance_sms_check_out_enabled}`);
      }
      if (verifyData.attendance_sms_absent_enabled !== input.attendance_sms_absent_enabled) {
        finalMismatches.push(`결석 알림: 요청=${input.attendance_sms_absent_enabled}, 저장=${verifyData.attendance_sms_absent_enabled}`);
      }
      if (verifyData.attendance_sms_late_enabled !== input.attendance_sms_late_enabled) {
        finalMismatches.push(`지각 알림: 요청=${input.attendance_sms_late_enabled}, 저장=${verifyData.attendance_sms_late_enabled}`);
      }
      if (verifyData.attendance_sms_show_failure_to_user !== (input.attendance_sms_show_failure_to_user ?? false)) {
        finalMismatches.push(`SMS 발송 실패 알림: 요청=${input.attendance_sms_show_failure_to_user ?? false}, 저장=${verifyData.attendance_sms_show_failure_to_user}`);
      }

      if (finalMismatches.length > 0) {
        console.error("[attendanceSettings] 재검증 시 값 불일치 감지:", {
          tenantId: tenantContext.tenantId,
          mismatches: finalMismatches,
          verifyData,
          requested: input,
        });
        throw new AppError(
          `SMS 설정 저장 후 검증 중 오류가 발생했습니다. 일부 설정이 올바르게 저장되지 않았습니다: ${finalMismatches.join(", ")}`,
          ErrorCode.DATABASE_ERROR,
          500,
          true
        );
      }

      console.log("[attendanceSettings] SMS 설정 업데이트 성공 및 검증 완료:", {
        tenantId: tenantContext.tenantId,
        savedData: verifyData,
        allFieldsMatch: true,
      });
    }

    revalidatePath("/admin/attendance/settings");
    return { success: true };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "updateAttendanceSMSSettings" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * 학생별 출석 알림 설정 업데이트
 */
export async function updateStudentAttendanceSettings(
  studentId: string,
  settings: {
    attendance_check_in_enabled?: boolean | null;
    attendance_check_out_enabled?: boolean | null;
    attendance_absent_enabled?: boolean | null;
    attendance_late_enabled?: boolean | null;
  }
): Promise<{ success: boolean; error?: string }> {
  try {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();

    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    // 학생이 해당 테넌트에 속하는지 확인
    const { data: student, error: studentError } = await supabase
      .from("students")
      .select("id")
      .eq("id", studentId)
      .eq("tenant_id", tenantContext.tenantId)
      .single();

    if (studentError || !student) {
      throw new AppError(
        "학생을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 기존 설정 확인
    const { data: existing } = await supabase
      .from("student_notification_preferences")
      .select("id")
      .eq("student_id", studentId)
      .single();

    const updateData = {
      attendance_check_in_enabled: settings.attendance_check_in_enabled ?? null,
      attendance_check_out_enabled: settings.attendance_check_out_enabled ?? null,
      attendance_absent_enabled: settings.attendance_absent_enabled ?? null,
      attendance_late_enabled: settings.attendance_late_enabled ?? null,
      updated_at: new Date().toISOString(),
    };

    if (existing) {
      // 업데이트
      const { error } = await supabase
        .from("student_notification_preferences")
        .update(updateData)
        .eq("student_id", studentId);

      if (error) {
        console.error("[attendanceSettings] 학생 알림 설정 업데이트 실패:", error);
        throw new AppError(
          error.message || "학생 알림 설정 업데이트에 실패했습니다.",
          ErrorCode.DATABASE_ERROR,
          500,
          true
        );
      }
    } else {
      // 생성
      const { error } = await supabase
        .from("student_notification_preferences")
        .insert({
          student_id: studentId,
          ...updateData,
        });

      if (error) {
        console.error("[attendanceSettings] 학생 알림 설정 생성 실패:", error);
        throw new AppError(
          error.message || "학생 알림 설정 생성에 실패했습니다.",
          ErrorCode.DATABASE_ERROR,
          500,
          true
        );
      }
    }

    revalidatePath(`/admin/students/${studentId}/attendance-settings`);
    revalidatePath(`/admin/students/${studentId}`);
    return { success: true };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "updateStudentAttendanceSettings" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}
</file>

<file path="actions/campTemplateActions.ts">
"use server";

import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  getCampTemplate,
  createCampTemplate,
  getCampInvitationsForTemplate as getCampInvitationsForTemplateData,
} from "@/lib/data/campTemplates";
import { WizardData } from "@/app/(student)/plan/new-group/_components/PlanGroupWizard";
import {
  AppError,
  ErrorCode,
  withErrorHandling,
  getUserFacingMessage,
} from "@/lib/errors";
import { requireAdminOrConsultant } from "@/lib/auth/guards";
import {
  linkBlockSetToTemplate,
  unlinkBlockSetFromTemplate,
} from "./campTemplateBlockSets";
import { getRecommendedMasterContents } from "@/lib/recommendations/masterContentRecommendation";
import { createPlanContents, getPlanContents } from "@/lib/data/planGroups";
import { timeToMinutes } from "@/lib/plan/assignPlanTimes";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { getMasterBookById, getMasterLectureById } from "@/lib/data/contentMasters";
import { calculateRecommendedRanges, type ScheduleSummary } from "@/lib/plan/rangeRecommendation";
import { getRangeRecommendationConfig } from "@/lib/recommendations/config/configManager";
import { mergeTimeSettingsSafely } from "@/lib/utils/schedulerOptionsMerge";

/**
 * 캠프 템플릿 목록 조회
 */
export const getCampTemplates = withErrorHandling(async () => {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError(
      "기관 정보를 찾을 수 없습니다.",
      ErrorCode.NOT_FOUND,
      404,
      true
    );
  }

  const supabase = await createSupabaseServerClient();
  const { data, error } = await supabase
    .from("camp_templates")
    .select("*")
    .eq("tenant_id", tenantContext.tenantId)
    .order("created_at", { ascending: false });

  if (error) {
    throw new AppError(
      "템플릿 목록을 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  return { success: true, templates: data || [] };
});

/**
 * 캠프 템플릿 상세 조회
 */
export const getCampTemplateById = withErrorHandling(
  async (templateId: string) => {
    // 권한 검증
    const { role } = await getCurrentUserRole();
    if (role !== "admin" && role !== "consultant") {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    // 템플릿 ID 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // tenant_id로 필터링하여 조회 (RLS 정책 및 권한 검증 강화)
    const supabase = await createSupabaseServerClient();

    // 먼저 tenant_id 없이 조회하여 템플릿 존재 여부 확인 (디버깅용)
    const { data: templateWithoutTenant, error: checkError } = await supabase
      .from("camp_templates")
      .select("id, tenant_id, name")
      .eq("id", templateId)
      .maybeSingle();

    if (
      process.env.NODE_ENV === "development" &&
      checkError &&
      checkError.code !== "PGRST116"
    ) {
      console.warn("[getCampTemplateById] tenant_id 없이 조회 시도 실패", {
        templateId,
        errorCode: checkError.code,
        errorMessage: checkError.message,
      });
    }

    // tenant_id로 필터링하여 조회
    const { data: template, error: templateError } = await supabase
      .from("camp_templates")
      .select("*")
      .eq("id", templateId)
      .eq("tenant_id", tenantContext.tenantId)
      .maybeSingle();

    if (templateError) {
      // PGRST116은 결과가 0개일 때 발생하는 정상적인 에러
      if (templateError.code !== "PGRST116") {
        console.error("[getCampTemplateById] 템플릿 조회 실패", {
          templateId,
          tenantId: tenantContext.tenantId,
          errorCode: templateError.code,
          errorMessage: templateError.message,
        });
        throw new AppError(
          "템플릿 조회 중 오류가 발생했습니다.",
          ErrorCode.DATABASE_ERROR,
          500,
          true,
          {
            templateId,
            tenantId: tenantContext.tenantId,
            originalError: templateError.message,
          }
        );
      }
    }

    if (!template) {
      // 디버깅 정보 포함
      if (process.env.NODE_ENV === "development") {
        const debugInfo: Record<string, unknown> = {
          templateId,
          tenantId: tenantContext.tenantId,
        };

        // tenant_id 없이 조회한 결과가 있으면 tenant_id 불일치 가능성 표시
        if (templateWithoutTenant) {
          debugInfo.templateExists = true;
          debugInfo.templateTenantId = templateWithoutTenant.tenant_id;
          debugInfo.tenantMismatch =
            templateWithoutTenant.tenant_id !== tenantContext.tenantId;
          debugInfo.templateName = templateWithoutTenant.name;
        } else {
          debugInfo.templateExists = false;
        }

        console.warn("[getCampTemplateById] 템플릿을 찾을 수 없음", debugInfo);
      }

      // tenant_id 불일치인 경우와 존재하지 않는 경우를 구분
      const errorMessage =
        templateWithoutTenant &&
        templateWithoutTenant.tenant_id !== tenantContext.tenantId
          ? "다른 기관의 템플릿이거나 권한이 없습니다."
          : "템플릿을 찾을 수 없습니다.";

      throw new AppError(errorMessage, ErrorCode.NOT_FOUND, 404, true, {
        templateId,
        tenantId: tenantContext.tenantId,
        templateExists: !!templateWithoutTenant,
        templateTenantId: templateWithoutTenant?.tenant_id,
      });
    }

    return { success: true, template };
  }
);

/**
 * 캠프 템플릿 초안 생성 (최소 정보만으로 템플릿 ID 생성)
 * 템플릿 생성 시작 시 호출하여 템플릿 ID를 먼저 생성
 */
export const createCampTemplateDraftAction = withErrorHandling(
  async (
    formData: FormData
  ): Promise<{ success: boolean; templateId?: string; error?: string }> => {
    const { userId } = await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 최소 정보만 검증 (이름, 프로그램 유형)
    const name = String(formData.get("name") ?? "").trim();
    const programType = String(formData.get("program_type") ?? "").trim();

    if (!name || name.length === 0) {
      throw new AppError(
        "템플릿명은 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (name.length > 200) {
      throw new AppError(
        "템플릿명은 200자 이하여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!programType) {
      throw new AppError(
        "프로그램 유형은 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const validProgramTypes = ["윈터캠프", "썸머캠프", "파이널캠프", "기타"];
    if (!validProgramTypes.includes(programType)) {
      throw new AppError(
        "올바른 프로그램 유형을 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 추가 필드 추출 및 검증
    const description = String(formData.get("description") ?? "").trim() || null;
    const campStartDate = String(formData.get("camp_start_date") ?? "").trim() || null;
    const campEndDate = String(formData.get("camp_end_date") ?? "").trim() || null;
    const campLocation = String(formData.get("camp_location") ?? "").trim() || null;

    // 날짜 형식 검증 (YYYY-MM-DD)
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (campStartDate && !dateRegex.test(campStartDate)) {
      throw new AppError(
        "캠프 시작일 형식이 올바르지 않습니다. (YYYY-MM-DD 형식)",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }
    if (campEndDate && !dateRegex.test(campEndDate)) {
      throw new AppError(
        "캠프 종료일 형식이 올바르지 않습니다. (YYYY-MM-DD 형식)",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 종료일이 시작일보다 이후인지 검증
    if (campStartDate && campEndDate && campEndDate < campStartDate) {
      throw new AppError(
        "캠프 종료일은 시작일보다 이후여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 캠프 장소 길이 검증
    if (campLocation && campLocation.length > 200) {
      throw new AppError(
        "캠프 장소는 200자 이하여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 빈 template_data로 템플릿 생성
    const emptyTemplateData: Partial<WizardData> = {
      name,
      plan_purpose: "",
      scheduler_type: "",
      period_start: "",
      period_end: "",
      block_set_id: undefined,
      exclusions: [],
      academy_schedules: [],
      student_contents: [],
      recommended_contents: [],
    };

    // 템플릿 생성 (기본 정보 포함)
    const result = await createCampTemplate({
      tenant_id: tenantContext.tenantId,
      name,
      description: description || undefined,
      program_type: programType,
      template_data: emptyTemplateData,
      created_by: userId,
      camp_start_date: campStartDate || undefined,
      camp_end_date: campEndDate || undefined,
      camp_location: campLocation || undefined,
    });

    if (!result.success || !result.templateId) {
      throw new AppError(
        result.error || "템플릿 생성에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    return result;
  }
);

/**
 * 캠프 템플릿 생성 (전체 정보 포함)
 */
export const createCampTemplateAction = withErrorHandling(
  async (
    formData: FormData
  ): Promise<{ success: boolean; templateId?: string; error?: string }> => {
    const { userId } = await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 입력값 검증
    const name = String(formData.get("name") ?? "").trim();
    const description =
      String(formData.get("description") ?? "").trim() || null;
    const programType = String(formData.get("program_type") ?? "").trim();
    const templateDataJson = String(formData.get("template_data") ?? "");
    const campStartDate =
      String(formData.get("camp_start_date") ?? "").trim() || null;
    const campEndDate =
      String(formData.get("camp_end_date") ?? "").trim() || null;
    const campLocation =
      String(formData.get("camp_location") ?? "").trim() || null;

    if (!name || name.length === 0) {
      throw new AppError(
        "템플릿명은 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (name.length > 200) {
      throw new AppError(
        "템플릿명은 200자 이하여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!programType) {
      throw new AppError(
        "프로그램 유형은 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const validProgramTypes = ["윈터캠프", "썸머캠프", "파이널캠프", "기타"];
    if (!validProgramTypes.includes(programType)) {
      throw new AppError(
        "올바른 프로그램 유형을 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!templateDataJson) {
      throw new AppError(
        "템플릿 데이터는 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    let templateData: Partial<WizardData>;
    try {
      templateData = JSON.parse(templateDataJson);
    } catch (e) {
      throw new AppError(
        "템플릿 데이터 형식이 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // block_set_id를 추출하고 template_data에서 제거 (연결 테이블로 관리)
    const blockSetId = templateData.block_set_id && templateData.block_set_id !== "" 
      ? templateData.block_set_id 
      : null;
    
    // template_data에서 block_set_id 제거
    const { block_set_id, ...templateDataWithoutBlockSetId } = templateData;

    // 날짜 유효성 검증
    if (campStartDate && campEndDate) {
      const start = new Date(campStartDate);
      const end = new Date(campEndDate);
      if (end < start) {
        throw new AppError(
          "종료일은 시작일보다 이후여야 합니다.",
          ErrorCode.VALIDATION_ERROR,
          400,
          true
        );
      }
    }

    // 장소 길이 검증
    if (campLocation && campLocation.length > 200) {
      throw new AppError(
        "캠프 장소는 200자 이하여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 템플릿 생성 (block_set_id는 template_data에서 제거됨)
    const result = await createCampTemplate({
      tenant_id: tenantContext.tenantId,
      name,
      description: description || undefined,
      program_type: programType,
      template_data: templateDataWithoutBlockSetId,
      created_by: userId,
      camp_start_date: campStartDate || undefined,
      camp_end_date: campEndDate || undefined,
      camp_location: campLocation || undefined,
    });

    if (!result.success || !result.templateId) {
      throw new AppError(
        result.error || "템플릿 생성에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    // 블록 세트 연결 처리
    if (blockSetId) {
      try {
        await linkBlockSetToTemplate(result.templateId, blockSetId);
      } catch (linkError) {
        console.error("[createCampTemplateAction] 블록 세트 연결 실패:", linkError);
        // 연결 실패해도 템플릿 생성은 성공으로 처리 (나중에 수동으로 연결 가능)
      }
    }

    return result;
  }
);

/**
 * 캠프 템플릿 수정
 */
export const updateCampTemplateAction = withErrorHandling(
  async (
    templateId: string,
    formData: FormData
  ): Promise<{ success: boolean; error?: string }> => {
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인 (강화된 검증)
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const name = String(formData.get("name") ?? "").trim();
    const description =
      String(formData.get("description") ?? "").trim() || null;
    const programType = String(formData.get("program_type") ?? "").trim();
    const status = String(formData.get("status") ?? "").trim();
    const templateDataJson = String(formData.get("template_data") ?? "");
    const campStartDate =
      String(formData.get("camp_start_date") ?? "").trim() || null;
    const campEndDate =
      String(formData.get("camp_end_date") ?? "").trim() || null;
    const campLocation =
      String(formData.get("camp_location") ?? "").trim() || null;

    // 입력값 검증
    if (!name || name.length === 0) {
      throw new AppError(
        "템플릿명은 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (name.length > 200) {
      throw new AppError(
        "템플릿명은 200자 이하여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!programType) {
      throw new AppError(
        "프로그램 유형은 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const validProgramTypes = ["윈터캠프", "썸머캠프", "파이널캠프", "기타"];
    if (!validProgramTypes.includes(programType)) {
      throw new AppError(
        "올바른 프로그램 유형을 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const validStatuses = ["draft", "active", "archived"];
    if (status && !validStatuses.includes(status)) {
      throw new AppError(
        "올바른 상태를 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!templateDataJson) {
      throw new AppError(
        "템플릿 데이터는 필수입니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    let templateData: Partial<WizardData>;
    try {
      templateData = JSON.parse(templateDataJson);
    } catch (e) {
      throw new AppError(
        "템플릿 데이터 형식이 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // block_set_id를 추출하고 template_data에서 제거 (연결 테이블로 관리)
    const blockSetId = templateData.block_set_id && templateData.block_set_id !== "" 
      ? templateData.block_set_id 
      : null;
    
    // template_data에서 block_set_id 제거
    const { block_set_id, ...templateDataWithoutBlockSetId } = templateData;

    // 날짜 유효성 검증
    if (campStartDate && campEndDate) {
      const start = new Date(campStartDate);
      const end = new Date(campEndDate);
      if (end < start) {
        throw new AppError(
          "종료일은 시작일보다 이후여야 합니다.",
          ErrorCode.VALIDATION_ERROR,
          400,
          true
        );
      }
    }

    // 장소 길이 검증
    if (campLocation && campLocation.length > 200) {
      throw new AppError(
        "캠프 장소는 200자 이하여야 합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const supabase = await createSupabaseServerClient();
    const updateData: any = {
      name,
      description,
      program_type: programType,
      status: status || "draft",
      template_data: templateDataWithoutBlockSetId, // block_set_id 제거된 데이터
      updated_at: new Date().toISOString(),
    };

    // 날짜/장소 필드 추가
    if (campStartDate !== null) {
      updateData.camp_start_date = campStartDate || null;
    }
    if (campEndDate !== null) {
      updateData.camp_end_date = campEndDate || null;
    }
    if (campLocation !== null) {
      updateData.camp_location = campLocation || null;
    }

    const { error } = await supabase
      .from("camp_templates")
      .update(updateData)
      .eq("id", templateId)
      .eq("tenant_id", tenantContext.tenantId);

    if (error) {
      throw new AppError(
        "템플릿 수정에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true,
        { originalError: error.message }
      );
    }

    // 블록 세트 연결 처리
    if (blockSetId) {
      try {
        await linkBlockSetToTemplate(templateId, blockSetId);
      } catch (linkError) {
        console.error("[updateCampTemplateAction] 블록 세트 연결 실패:", linkError);
        // 연결 실패해도 템플릿 수정은 성공으로 처리
      }
    } else {
      // block_set_id가 없으면 연결 해제
      try {
        await unlinkBlockSetFromTemplate(templateId);
      } catch (unlinkError) {
        console.error("[updateCampTemplateAction] 블록 세트 연결 해제 실패:", unlinkError);
        // 연결 해제 실패해도 템플릿 수정은 성공으로 처리
      }
    }

    return { success: true };
  }
);

/**
 * 캠프 템플릿 상태 변경
 */
export const updateCampTemplateStatusAction = withErrorHandling(
  async (
    templateId: string,
    status: "draft" | "active" | "archived"
  ): Promise<{ success: boolean; error?: string }> => {
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const validStatuses = ["draft", "active", "archived"];
    if (!validStatuses.includes(status)) {
      throw new AppError(
        "올바른 상태를 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    // 상태 변경
    const supabase = await createSupabaseServerClient();
    const { error } = await supabase
      .from("camp_templates")
      .update({
        status,
        updated_at: new Date().toISOString(),
      })
      .eq("id", templateId)
      .eq("tenant_id", tenantContext.tenantId);

    if (error) {
      throw new AppError(
        "템플릿 상태 변경에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true,
        { originalError: error.message }
      );
    }

    return { success: true };
  }
);

/**
 * 캠프 템플릿 삭제
 */
export const deleteCampTemplateAction = withErrorHandling(
  async (templateId: string): Promise<{ success: boolean; error?: string }> => {
    // 권한 검증
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인 (강화된 검증)
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    // 템플릿 삭제 전에 관련된 플랜 그룹 삭제
    const { deletePlanGroupsByTemplateId } = await import(
      "@/lib/data/planGroups"
    );
    const planGroupResult = await deletePlanGroupsByTemplateId(templateId);

    if (!planGroupResult.success) {
      console.error(
        "[campTemplateActions] 플랜 그룹 삭제 실패",
        planGroupResult.error
      );
      // 플랜 그룹 삭제 실패해도 템플릿 삭제는 계속 진행
      // (데이터 정합성 문제가 있을 수 있지만, 템플릿 삭제 자체는 완료)
      console.warn(
        "[campTemplateActions] 플랜 그룹 삭제 실패했지만 템플릿 삭제는 계속 진행합니다."
      );
    } else if (planGroupResult.deletedGroupIds && planGroupResult.deletedGroupIds.length > 0) {
      console.log(
        `[campTemplateActions] 템플릿 삭제 전 ${planGroupResult.deletedGroupIds.length}개의 플랜 그룹 삭제 완료`
      );
    }

    const supabase = await createSupabaseServerClient();
    const { error } = await supabase
      .from("camp_templates")
      .delete()
      .eq("id", templateId)
      .eq("tenant_id", tenantContext.tenantId);

    if (error) {
      throw new AppError(
        "템플릿 삭제에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true,
        { originalError: error.message }
      );
    }

    return { success: true };
  }
);

/**
 * 학생 초대 발송
 */
export const sendCampInvitationsAction = withErrorHandling(
  async (
    templateId: string,
    studentIds: string[]
  ): Promise<{ success: boolean; error?: string; count?: number }> => {
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!Array.isArray(studentIds) || studentIds.length === 0) {
      throw new AppError(
        "최소 1명 이상의 학생을 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 중복 제거
    const uniqueStudentIds = Array.from(new Set(studentIds));

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인 (강화된 검증)
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    // 템플릿이 활성 상태인지 확인 (active 상태만 초대 가능)
    if (template.status !== "active") {
      const statusMessage =
        template.status === "archived"
          ? "보관된 템플릿에는 초대를 발송할 수 없습니다."
          : template.status === "draft"
          ? "초안 상태의 템플릿에는 초대를 발송할 수 없습니다. 템플릿을 활성화한 후 초대를 발송해주세요."
          : "활성 상태의 템플릿만 초대를 발송할 수 있습니다.";
      throw new AppError(statusMessage, ErrorCode.VALIDATION_ERROR, 400, true);
    }

    const supabase = await createSupabaseServerClient();

    // 기존 초대 확인 (중복 방지)
    const { data: existingInvitations } = await supabase
      .from("camp_invitations")
      .select("student_id")
      .eq("camp_template_id", templateId)
      .in("student_id", studentIds);

    const existingStudentIds = new Set(
      (existingInvitations || []).map((inv) => inv.student_id)
    );

    // 새로 초대할 학생만 필터링
    const newStudentIds = studentIds.filter(
      (id) => !existingStudentIds.has(id)
    );

    if (newStudentIds.length === 0) {
      return {
        success: true,
        count: 0,
        error: "모든 학생이 이미 초대되었습니다.",
      };
    }

    // 초대 생성
    const invitations = newStudentIds.map((studentId) => ({
      tenant_id: tenantContext.tenantId,
      camp_template_id: templateId,
      student_id: studentId,
      status: "pending",
    }));

    const { error } = await supabase
      .from("camp_invitations")
      .insert(invitations);

    if (error) {
      console.error("[actions/campTemplateActions] 초대 발송 실패", error);
      return { success: false, error: error.message };
    }

    return { success: true, count: newStudentIds.length };
  }
);

/**
 * 템플릿별 캠프 초대 목록 조회
 */
export const getCampInvitationsForTemplate = withErrorHandling(
  async (templateId: string) => {
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 확인 (템플릿이 없어도 초대 목록은 조회 가능 - 삭제된 템플릿의 초대도 볼 수 있어야 함)
    const template = await getCampTemplate(templateId);
    if (template) {
      // 템플릿이 존재하는 경우, 권한 확인
      if (template.tenant_id !== tenantContext.tenantId) {
        throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
      }
    }
    // 템플릿이 없는 경우 (삭제된 경우 등)에도 초대 목록은 조회 가능
    // 초대 목록 자체가 tenant_id로 필터링되므로 보안 문제 없음

    // 초대 목록 조회 (tenant_id로 필터링하여 권한 확인)
    const supabase = await createSupabaseServerClient();
    const { data: invitations, error } = await supabase
      .from("camp_invitations")
      .select(
        `
        *,
        students:student_id (
          name,
          grade,
          class
        )
      `
      )
      .eq("camp_template_id", templateId)
      .eq("tenant_id", tenantContext.tenantId)
      .order("invited_at", { ascending: false });

    if (error) {
      console.error("[campTemplateActions] 초대 목록 조회 실패", error);
      return { success: true, invitations: [] };
    }

    // 학생 정보를 평탄화
    const formattedInvitations = (invitations || []).map((invitation: any) => ({
      ...invitation,
      student_name: invitation.students?.name || null,
      student_grade: invitation.students?.grade || null,
      student_class: invitation.students?.class || null,
    }));

    return { success: true, invitations: formattedInvitations };
  }
);

/**
 * 캠프 초대 삭제
 */
export const deleteCampInvitationAction = withErrorHandling(
  async (
    invitationId: string
  ): Promise<{ success: boolean; error?: string }> => {
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!invitationId || typeof invitationId !== "string") {
      throw new AppError(
        "초대 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 초대 존재 및 권한 확인 (강화된 검증)
    const { getCampInvitation } = await import("@/lib/data/campTemplates");
    const invitation = await getCampInvitation(invitationId);
    if (!invitation) {
      throw new AppError(
        "초대를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 권한 확인
    const template = await getCampTemplate(invitation.camp_template_id);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const { deleteCampInvitation } = await import("@/lib/data/campTemplates");
    const result = await deleteCampInvitation(invitationId);

    if (!result.success) {
      throw new AppError(
        result.error || "초대 삭제에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    return result;
  }
);

/**
 * 캠프 초대 일괄 삭제
 */
export async function deleteCampInvitationsAction(
  invitationIds: string[]
): Promise<{ success: boolean; error?: string; count?: number }> {
  await requireAdminOrConsultant();

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    return { success: false, error: "기관 정보를 찾을 수 없습니다." };
  }

  if (!invitationIds || invitationIds.length === 0) {
    return { success: false, error: "삭제할 초대를 선택해주세요." };
  }

  // 모든 초대의 템플릿 권한 확인
  const { getCampInvitation } = await import("@/lib/data/campTemplates");
  const invitations = await Promise.all(
    invitationIds.map((id) => getCampInvitation(id))
  );

  const validInvitations = invitations.filter(Boolean);
  if (validInvitations.length !== invitationIds.length) {
    return { success: false, error: "일부 초대를 찾을 수 없습니다." };
  }

  // 템플릿 권한 확인
  const templateIds = new Set(
    validInvitations.map((inv) => inv!.camp_template_id)
  );
  const templates = await Promise.all(
    Array.from(templateIds).map((id) => getCampTemplate(id))
  );

  const invalidTemplates = templates.some(
    (t) => !t || t.tenant_id !== tenantContext.tenantId
  );
  if (invalidTemplates) {
    return { success: false, error: "권한이 없는 초대가 포함되어 있습니다." };
  }

  const { deleteCampInvitations } = await import("@/lib/data/campTemplates");
  const result = await deleteCampInvitations(invitationIds);

  return result;
}

/**
 * 캠프 초대 재발송
 */
export const resendCampInvitationsAction = withErrorHandling(
  async (
    templateId: string,
    invitationIds: string[]
  ): Promise<{ success: boolean; error?: string; count?: number }> => {
    await requireAdminOrConsultant();

    // 입력값 검증
    if (!templateId || typeof templateId !== "string") {
      throw new AppError(
        "템플릿 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!Array.isArray(invitationIds) || invitationIds.length === 0) {
      throw new AppError(
        "재발송할 초대를 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 중복 제거
    const uniqueInvitationIds = Array.from(new Set(invitationIds));

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인 (강화된 검증)
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    // 템플릿이 활성 상태인지 확인 (active 상태만 재발송 가능)
    if (template.status !== "active") {
      const statusMessage =
        template.status === "archived"
          ? "보관된 템플릿에는 초대를 재발송할 수 없습니다."
          : template.status === "draft"
          ? "초안 상태의 템플릿에는 초대를 재발송할 수 없습니다. 템플릿을 활성화한 후 재발송해주세요."
          : "활성 상태의 템플릿만 초대를 재발송할 수 있습니다.";
      throw new AppError(statusMessage, ErrorCode.VALIDATION_ERROR, 400, true);
    }

    // 초대 조회 및 학생 ID 추출
    const { getCampInvitation } = await import("@/lib/data/campTemplates");
    const invitations = await Promise.all(
      uniqueInvitationIds.map((id) => getCampInvitation(id))
    );

    const validInvitations = invitations.filter(Boolean);
    if (validInvitations.length === 0) {
      throw new AppError(
        "유효한 초대를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 모든 초대가 같은 템플릿인지 확인
    const allSameTemplate = validInvitations.every(
      (inv) => inv!.camp_template_id === templateId
    );
    if (!allSameTemplate) {
      throw new AppError(
        "같은 템플릿의 초대만 재발송할 수 있습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const studentIds = validInvitations.map((inv) => inv!.student_id);

    // 기존 초대 삭제 후 재발송
    const { deleteCampInvitations } = await import("@/lib/data/campTemplates");
    const deleteResult = await deleteCampInvitations(uniqueInvitationIds);
    if (!deleteResult.success) {
      throw new AppError(
        "기존 초대 삭제에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    // 재발송
    const result = await sendCampInvitationsAction(templateId, studentIds);

    return result;
  }
);

/**
 * 관리자용 캠프 플랜 그룹 조회 (검토용)
 */
export const getCampPlanGroupForReview = withErrorHandling(
  async (groupId: string) => {
    console.log("[getCampPlanGroupForReview] 함수 호출됨, groupId:", groupId);

    const { role } = await getCurrentUserRole();
    if (role !== "admin" && role !== "consultant") {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    console.log(
      "[getCampPlanGroupForReview] 플랜 그룹 조회 시작, tenantId:",
      tenantContext.tenantId
    );

    const { getPlanGroupWithDetailsForAdmin } = await import(
      "@/lib/data/planGroups"
    );
    const result = await getPlanGroupWithDetailsForAdmin(
      groupId,
      tenantContext.tenantId
    );

    if (!result.group) {
      console.error(
        "[getCampPlanGroupForReview] 플랜 그룹을 찾을 수 없음, groupId:",
        groupId
      );
      throw new AppError(
        "플랜 그룹을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    console.log("[getCampPlanGroupForReview] 플랜 그룹 조회 성공:", {
      groupId: result.group.id,
      planType: result.group.plan_type,
      campTemplateId: result.group.camp_template_id,
      schedulerOptions: JSON.stringify(result.group.scheduler_options),
    });

    // 캠프 플랜 그룹인지 확인
    if (result.group.plan_type !== "camp") {
      throw new AppError(
        "캠프 플랜 그룹이 아닙니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 템플릿 블록 정보 조회
    let templateBlocks: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }> = [];
    let templateBlockSetName: string | null = null;
    let templateBlockSetId: string | null = null;

    if (result.group.camp_template_id) {
      const supabase = await createSupabaseServerClient();

      // 템플릿 조회
      const { data: template, error: templateError } = await supabase
        .from("camp_templates")
        .select("template_data")
        .eq("id", result.group.camp_template_id)
        .maybeSingle();

      if (templateError) {
        console.error(
          "[getCampPlanGroupForReview] 템플릿 조회 에러:",
          templateError
        );
      } else if (!template) {
        console.warn(
          "[getCampPlanGroupForReview] 템플릿을 찾을 수 없음:",
          result.group.camp_template_id
        );
      } else {
        // block_set_id 찾기: 공통 함수 사용
        const { getTemplateBlockSetId } = await import("@/lib/plan/blocks");
        const schedulerOptions = (result.group.scheduler_options as any) || {};
        const tenantBlockSetId = await getTemplateBlockSetId(
          result.group.camp_template_id,
          schedulerOptions
        );

        if (tenantBlockSetId) {
          // 2. tenant_block_sets에서 블록 세트 정보 조회
          const { data: templateBlockSet, error: blockSetError } =
            await supabase
              .from("tenant_block_sets")
              .select("id, name")
              .eq("id", tenantBlockSetId)
              .eq("tenant_id", tenantContext.tenantId)
              .maybeSingle();

          if (blockSetError) {
            console.error(
              "[getCampPlanGroupForReview] 템플릿 블록 세트 조회 에러:",
              {
                error: blockSetError,
                tenantBlockSetId,
                templateId: result.group.camp_template_id,
              }
            );
          } else if (templateBlockSet) {
            templateBlockSetName = templateBlockSet.name;
            templateBlockSetId = templateBlockSet.id;

            // 3. tenant_blocks 테이블에서 블록 조회
            const { data: blocks, error: blocksError } = await supabase
              .from("tenant_blocks")
              .select("id, day_of_week, start_time, end_time")
              .eq("tenant_block_set_id", tenantBlockSetId)
              .order("day_of_week", { ascending: true })
              .order("start_time", { ascending: true });

            if (blocksError) {
              console.error(
                "[getCampPlanGroupForReview] 템플릿 블록 조회 에러:",
                {
                  error: blocksError,
                  tenantBlockSetId,
                }
              );
            } else if (blocks && blocks.length > 0) {
              templateBlocks = blocks.map((b) => ({
                id: b.id,
                day_of_week: b.day_of_week,
                start_time: b.start_time,
                end_time: b.end_time,
              }));

              console.log(
                "[getCampPlanGroupForReview] 템플릿 블록 조회 성공:",
                {
                  blockSetName: templateBlockSetName,
                  blockCount: templateBlocks.length,
                }
              );
            } else {
              console.warn("[getCampPlanGroupForReview] 템플릿 블록이 없음:", {
                tenantBlockSetId,
                templateBlockSetName,
              });
            }
          } else {
            console.warn(
              "[getCampPlanGroupForReview] 템플릿 블록 세트를 찾을 수 없음:",
              {
                tenantBlockSetId,
                templateId: result.group.camp_template_id,
              }
            );
          }
        } else {
          console.warn(
            "[getCampPlanGroupForReview] template_block_set_id를 찾을 수 없음:",
            {
              campTemplateId: result.group.camp_template_id,
              schedulerOptions: JSON.stringify(schedulerOptions),
              hasTemplateData: !!template.template_data,
            }
          );
        }
      }
    } else {
      console.warn(
        "[getCampPlanGroupForReview] camp_template_id가 없음, groupId:",
        groupId
      );
    }

    console.log("[getCampPlanGroupForReview] 최종 결과:", {
      templateBlocksCount: templateBlocks.length,
      templateBlockSetName,
      exclusionsCount: result.exclusions.length,
      academySchedulesCount: result.academySchedules.length,
    });

    // 콘텐츠 상세 정보 조회 (관리자가 학생의 추가 콘텐츠 정보를 제대로 볼 수 있도록)
    let contentsWithDetails = result.contents;
    if (result.group.student_id && result.contents.length > 0) {
      try {
        // 입력 데이터 검증 및 로그
        console.log("[getCampPlanGroupForReview] 콘텐츠 상세 정보 조회 시작:", {
          groupId: result.group.id,
          studentId: result.group.student_id,
          contentsCount: result.contents.length,
          contents: result.contents.map((c) => ({
            content_type: c.content_type,
            content_id: c.content_id,
            master_content_id: c.master_content_id,
            start_range: c.start_range,
            end_range: c.end_range,
          })),
        });

        const { classifyPlanContents } = await import(
          "@/lib/data/planContents"
        );
        // 관리자/컨설턴트가 다른 학생의 콘텐츠를 조회할 때는 역할 정보 전달 (RLS 우회)
        const { userId } = await getCurrentUserRole();
        const { studentContents, recommendedContents } =
          await classifyPlanContents(result.contents, result.group.student_id, {
            currentUserRole: role,
            currentUserId: userId || undefined,
          });

        // 조회된 콘텐츠 개수 검증
        const totalClassifiedContents = studentContents.length + recommendedContents.length;
        const totalOriginalContents = result.contents.length;
        
        if (totalClassifiedContents !== totalOriginalContents) {
          console.warn("[getCampPlanGroupForReview] 콘텐츠 개수 불일치:", {
            groupId: result.group.id,
            studentId: result.group.student_id,
            originalCount: totalOriginalContents,
            classifiedCount: totalClassifiedContents,
            studentContentsCount: studentContents.length,
            recommendedContentsCount: recommendedContents.length,
            missingCount: totalOriginalContents - totalClassifiedContents,
          });
        }

        // 상세 페이지 형식으로 변환
        const allContents = [...studentContents, ...recommendedContents];
        const contentsMap = new Map(allContents.map((c) => [c.content_id, c]));

        // 각 타입별 누락 개수 집계
        const missingByType = {
          book: 0,
          lecture: 0,
          custom: 0,
        };

        contentsWithDetails = result.contents.map((content) => {
          const detail = contentsMap.get(content.content_id);
          if (!detail) {
            missingByType[content.content_type]++;
            console.warn(
              `[getCampPlanGroupForReview] 콘텐츠를 찾을 수 없음:`,
              {
                content_type: content.content_type,
                content_id: content.content_id,
                studentId: result.group?.student_id,
                groupId: result.group?.id,
              }
            );
            return {
              ...content,
              contentTitle: "알 수 없음",
              contentSubtitle: null,
              isRecommended: false,
            };
          }

          return {
            ...content,
            contentTitle: detail.title || "알 수 없음",
            contentSubtitle: detail.subject_category || null,
            isRecommended: detail.isRecommended,
          };
        });

        // 누락된 콘텐츠가 있는 경우 경고 로그
        const totalMissing =
          missingByType.book + missingByType.lecture + missingByType.custom;
        if (totalMissing > 0) {
          console.warn(
            "[getCampPlanGroupForReview] 누락된 콘텐츠 집계:",
            {
              groupId: result.group.id,
              studentId: result.group.student_id,
              missingByType,
              totalMissing,
              totalContents: result.contents.length,
            }
          );
        }

        console.log("[getCampPlanGroupForReview] 콘텐츠 상세 정보 조회 완료:", {
          groupId: result.group.id,
          studentId: result.group.student_id,
          originalContentsCount: result.contents.length,
          studentContentsCount: studentContents.length,
          recommendedContentsCount: recommendedContents.length,
          totalClassifiedCount: studentContents.length + recommendedContents.length,
          missingCount: totalMissing,
          missingByType,
        });
      } catch (error) {
        console.error(
          "[getCampPlanGroupForReview] 콘텐츠 상세 정보 조회 실패:",
          {
            error: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : undefined,
            groupId: result.group.id,
            studentId: result.group.student_id,
            contentsCount: result.contents.length,
            contents: result.contents.map((c) => ({
              content_type: c.content_type,
              content_id: c.content_id,
            })),
          }
        );
        // 에러가 발생해도 원본 contents 반환
      }
    }

    return {
      success: true,
      group: result.group,
      contents: contentsWithDetails,
      originalContents: result.contents, // 원본 contents (master_content_id 포함) - classifyPlanContents 호출용
      exclusions: result.exclusions,
      academySchedules: result.academySchedules,
      templateBlocks,
      templateBlockSetName,
      templateBlockSetId,
      student_id: result.group.student_id, // 관리자 모드에서 Step6FinalReview에 전달하기 위해
    };
  }
);

/**
 * 관리자용 캠프 플랜 그룹 남은 단계 진행 (Step 5, 6, 7)
 */
export const continueCampStepsForAdmin = withErrorHandling(
  async (
    groupId: string,
    wizardData: Partial<WizardData>,
    step?: number
  ): Promise<{ success: boolean; error?: string }> => {
    // 권한 검증
    const { role } = await getCurrentUserRole();
    if (role !== "admin" && role !== "consultant") {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    // 입력값 검증
    if (!groupId || typeof groupId !== "string") {
      throw new AppError(
        "플랜 그룹 ID가 올바르지 않습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    if (!wizardData) {
      throw new AppError(
        "참여 정보가 필요합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 관리자용 Admin 클라이언트 사용 (RLS 우회)
    // 관리자가 다른 학생의 데이터를 조회/수정해야 하므로 Admin 클라이언트 필요
    const { createSupabaseAdminClient } = await import("@/lib/supabase/admin");
    const supabase = createSupabaseAdminClient();
    
    if (!supabase) {
      throw new AppError(
        "서버 설정 오류: Service Role Key가 설정되지 않았습니다.",
        ErrorCode.INTERNAL_ERROR,
        500,
        true
      );
    }
    
    console.log("[continueCampStepsForAdmin] Admin 클라이언트 사용 (RLS 우회)");

    // 플랜 그룹 조회 및 권한 확인
    const { getPlanGroupWithDetailsForAdmin } = await import(
      "@/lib/data/planGroups"
    );
    const result = await getPlanGroupWithDetailsForAdmin(
      groupId,
      tenantContext.tenantId
    );

    if (!result.group) {
      throw new AppError(
        "플랜 그룹을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 캠프 모드 확인
    if (result.group.plan_type !== "camp") {
      throw new AppError(
        "캠프 모드 플랜 그룹이 아닙니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 이미 플랜이 생성된 경우 확인
    const { data: plans } = await supabase
      .from("student_plan")
      .select("id")
      .eq("plan_group_id", groupId)
      .limit(1);

    const hasPlans = plans && plans.length > 0;

    // Step 7이 아닌 경우에만 플랜 생성 여부 확인 (Step 7에서는 플랜 생성이 목적이므로 허용)
    if (hasPlans && step !== 7) {
      throw new AppError(
        "이미 플랜이 생성된 그룹은 수정할 수 없습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 플랜 그룹 업데이트 (관리자용 직접 업데이트)
    const { syncWizardDataToCreationData } = await import(
      "@/lib/utils/planGroupDataSync"
    );
    const {
      createPlanContents,
      createPlanExclusions,
      createStudentAcademySchedules,
    } = await import("@/lib/data/planGroups");

    // plan_purpose 정규화 함수 (planGroupActions에서 복사)
    const normalizePlanPurpose = (
      purpose: string | null | undefined
    ): string | null => {
      if (!purpose) return null;
      if (purpose === "수능" || purpose === "모의고사") return "모의고사(수능)";
      return purpose;
    };

    try {
      const creationData = syncWizardDataToCreationData(
        wizardData as WizardData
      );

      creationData.plan_type = "camp";
      if (result.group.camp_template_id) {
        creationData.camp_template_id = result.group.camp_template_id;
        
        // 캠프 모드에서 템플릿 블록 세트 ID 조회 (공통 함수 사용)
        const { getTemplateBlockSetId } = await import("@/lib/plan/blocks");
        const schedulerOptions = (result.group.scheduler_options as any) || {};
        const tenantBlockSetId = await getTemplateBlockSetId(
          result.group.camp_template_id,
          schedulerOptions
        );

        // 조회된 block_set_id 설정
        if (tenantBlockSetId) {
          creationData.block_set_id = tenantBlockSetId;
        } else {
          console.warn(
            "[continueCampStepsForAdmin] 템플릿 블록 세트 ID를 찾을 수 없습니다:",
            result.group.camp_template_id
          );
        }
      }
      if (result.group.camp_invitation_id) {
        creationData.camp_invitation_id = result.group.camp_invitation_id;
      }

      // time_settings를 scheduler_options에 안전하게 병합 (보호 필드 자동 보호)
      const mergedSchedulerOptions = mergeTimeSettingsSafely(
        creationData.scheduler_options || {},
        creationData.time_settings
      );

      // 플랜 그룹 메타데이터 업데이트 (관리자가 직접 Supabase 사용)
      const updatePayload: Record<string, any> = {
        updated_at: new Date().toISOString(),
      };

      if (creationData.name !== undefined)
        updatePayload.name = creationData.name || null;
      if (creationData.plan_purpose !== undefined)
        updatePayload.plan_purpose = normalizePlanPurpose(
          creationData.plan_purpose
        );
      if (creationData.scheduler_type !== undefined)
        updatePayload.scheduler_type = creationData.scheduler_type || null;
      if (Object.keys(mergedSchedulerOptions).length > 0) {
        updatePayload.scheduler_options = mergedSchedulerOptions;
      } else {
        updatePayload.scheduler_options = null;
      }
      if (creationData.period_start !== undefined)
        updatePayload.period_start = creationData.period_start;
      if (creationData.period_end !== undefined)
        updatePayload.period_end = creationData.period_end;
      if (creationData.target_date !== undefined)
        updatePayload.target_date = creationData.target_date || null;
      if (creationData.block_set_id !== undefined)
        updatePayload.block_set_id = creationData.block_set_id || null;
      if (creationData.daily_schedule !== undefined)
        updatePayload.daily_schedule = creationData.daily_schedule || null;
      if (creationData.subject_constraints !== undefined)
        updatePayload.subject_constraints =
          creationData.subject_constraints || null;
      if (creationData.additional_period_reallocation !== undefined)
        updatePayload.additional_period_reallocation =
          creationData.additional_period_reallocation || null;
      if (creationData.non_study_time_blocks !== undefined)
        updatePayload.non_study_time_blocks =
          creationData.non_study_time_blocks || null;
      if (creationData.plan_type !== undefined)
        updatePayload.plan_type = creationData.plan_type || null;
      if (creationData.camp_template_id !== undefined)
        updatePayload.camp_template_id = creationData.camp_template_id || null;
      if (creationData.camp_invitation_id !== undefined)
        updatePayload.camp_invitation_id =
          creationData.camp_invitation_id || null;

      const { error: updateError } = await supabase
        .from("plan_groups")
        .update(updatePayload)
        .eq("id", groupId)
        .eq("tenant_id", tenantContext.tenantId);

      if (updateError) {
        throw new AppError(
          `플랜 그룹 업데이트 실패: ${updateError.message}`,
          ErrorCode.DATABASE_ERROR,
          500,
          true
        );
      }

      // 콘텐츠 업데이트 (기존 콘텐츠 보존 로직 개선)
      // wizardData에서 student_contents와 recommended_contents를 확인하여
      // 명시적으로 전달된 경우에만 업데이트하고, 그렇지 않으면 기존 콘텐츠 보존
      const hasStudentContents = wizardData.student_contents !== undefined;
      const hasRecommendedContents = wizardData.recommended_contents !== undefined;
      
      console.log("[continueCampStepsForAdmin] 콘텐츠 업데이트 시작:", {
        groupId,
        step,
        hasStudentContents,
        studentContentsLength: wizardData.student_contents?.length ?? 0,
        hasRecommendedContents,
        recommendedContentsLength: wizardData.recommended_contents?.length ?? 0,
        studentContentsIsEmptyArray: hasStudentContents && wizardData.student_contents?.length === 0,
        recommendedContentsIsEmptyArray: hasRecommendedContents && wizardData.recommended_contents?.length === 0,
      });
      
      // 기존 콘텐츠 조회 (보존할 콘텐츠 확인용)
      const { data: existingPlanContents } = await supabase
        .from("plan_contents")
        .select("*")
        .eq("plan_group_id", groupId);

      // 기존 콘텐츠를 학생 콘텐츠와 추천 콘텐츠로 분류
      const existingStudentContents: typeof existingPlanContents = [];
      const existingRecommendedContents: typeof existingPlanContents = [];
      
      if (existingPlanContents) {
        for (const content of existingPlanContents) {
          // 콘텐츠 분류:
          // - is_auto_recommended: true, recommendation_source: "auto" → Step 4에서 자동 배정된 콘텐츠
          // - is_auto_recommended: false, recommendation_source: "admin" → 관리자가 일괄 적용한 콘텐츠
          // - 둘 다 없으면 → 학생이 직접 등록한 콘텐츠
          if (content.is_auto_recommended || content.recommendation_source) {
            existingRecommendedContents.push(content);
          } else {
            existingStudentContents.push(content);
          }
        }
      }
      
      console.log("[continueCampStepsForAdmin] 기존 콘텐츠 조회 결과:", {
        groupId,
        existingTotalCount: existingPlanContents?.length ?? 0,
        existingStudentContentsCount: existingStudentContents.length,
        existingRecommendedContentsCount: existingRecommendedContents.length,
      });

      // 콘텐츠 업데이트가 필요한 경우에만 처리
      if (hasStudentContents || hasRecommendedContents) {
        // 기존 콘텐츠 삭제
        const { error: deleteError } = await supabase
          .from("plan_contents")
          .delete()
          .eq("plan_group_id", groupId);

        if (deleteError) {
          throw new AppError(
            `기존 콘텐츠 삭제 실패: ${deleteError.message}`,
            ErrorCode.DATABASE_ERROR,
            500,
            true
          );
        }

        // 병합할 콘텐츠 목록 생성
        const contentsToSave: Array<{
          content_type: string;
          content_id: string;
          start_range: number;
          end_range: number;
          display_order: number;
          master_content_id?: string | null;
          is_auto_recommended?: boolean;
          recommendation_source?: "auto" | "admin" | "template" | null;
          recommendation_reason?: string | null;
          recommendation_metadata?: any;
        }> = [];
        
        // 학생 콘텐츠 처리
        if (hasStudentContents && wizardData.student_contents && wizardData.student_contents.length > 0) {
          // wizardData의 student_contents를 creationData 형식으로 변환하여 추가
          const studentContentsForCreation = wizardData.student_contents.map((c, idx) => ({
            content_type: c.content_type,
            content_id: c.content_id,
            start_range: c.start_range,
            end_range: c.end_range,
            display_order: idx,
            master_content_id: (c as any).master_content_id || null,
            is_auto_recommended: false, // 학생 콘텐츠는 항상 false
            recommendation_source: null,
            recommendation_reason: null,
            recommendation_metadata: null,
          }));
          contentsToSave.push(...studentContentsForCreation);
        } else if (
          (!hasStudentContents || (hasStudentContents && wizardData.student_contents && wizardData.student_contents.length === 0)) &&
          existingStudentContents.length > 0
        ) {
          // wizardData에 student_contents가 없거나 빈 배열인 경우 기존 학생 콘텐츠 보존
          // 빈 배열을 전달하면 hasStudentContents는 true이지만 length > 0이 false가 되어 보존되지 않는 문제 해결
          const preservedStudentContents = existingStudentContents.map((c) => ({
            content_type: c.content_type,
            content_id: c.content_id,
            start_range: c.start_range,
            end_range: c.end_range,
            display_order: c.display_order ?? 0,
            master_content_id: (c as any).master_content_id || null,
            is_auto_recommended: false, // 학생 콘텐츠는 항상 false
            recommendation_source: null,
            recommendation_reason: null,
            recommendation_metadata: null,
          }));
          contentsToSave.push(...preservedStudentContents);
          
          console.log("[continueCampStepsForAdmin] 기존 학생 콘텐츠 보존:", {
            groupId,
            hasStudentContents,
            wizardDataStudentContentsLength: wizardData.student_contents?.length ?? 0,
            existingStudentContentsCount: existingStudentContents.length,
            preservedCount: preservedStudentContents.length,
          });
        }

        // 추천 콘텐츠 처리
        if (hasRecommendedContents && wizardData.recommended_contents && wizardData.recommended_contents.length > 0) {
          // wizardData의 recommended_contents를 creationData 형식으로 변환하여 추가
          // 관리자가 추가하는 경우는 항상 is_auto_recommended: false, recommendation_source: "admin"으로 강제 설정
          const recommendedContentsForCreation: Array<{
            content_type: string;
            content_id: string;
            start_range: number;
            end_range: number;
            display_order: number;
            master_content_id?: string | null;
            is_auto_recommended?: boolean;
            recommendation_source?: "auto" | "admin" | "template" | null;
            recommendation_reason?: string | null;
            recommendation_metadata?: any;
          }> = wizardData.recommended_contents.map((c, idx) => ({
            content_type: c.content_type,
            content_id: c.content_id,
            start_range: c.start_range,
            end_range: c.end_range,
            display_order: (contentsToSave.length + idx),
            master_content_id: (c as any).master_content_id || null,
            is_auto_recommended: false, // 관리자 추가는 항상 false
            recommendation_source: "admin" as const, // 관리자 추가는 항상 "admin"으로 강제 설정
            recommendation_reason: (c as any).recommendation_reason || null,
            recommendation_metadata: (c as any).recommendation_metadata || null,
          }));
          contentsToSave.push(...recommendedContentsForCreation);
        } else if (
          (!hasRecommendedContents || (hasRecommendedContents && wizardData.recommended_contents && wizardData.recommended_contents.length === 0)) &&
          existingRecommendedContents.length > 0
        ) {
          // wizardData에 recommended_contents가 없거나 빈 배열인 경우 기존 추천 콘텐츠 보존
          // 빈 배열을 전달하면 hasRecommendedContents는 true이지만 length > 0이 false가 되어 보존되지 않는 문제 해결
          const preservedRecommendedContents = existingRecommendedContents.map((c) => ({
            content_type: c.content_type,
            content_id: c.content_id,
            start_range: c.start_range,
            end_range: c.end_range,
            display_order: (contentsToSave.length + (c.display_order ?? 0)),
            master_content_id: (c as any).master_content_id || null,
            is_auto_recommended: c.is_auto_recommended ?? false,
            recommendation_source: c.recommendation_source || null,
            recommendation_reason: (c as any).recommendation_reason || null,
            recommendation_metadata: (c as any).recommendation_metadata || null,
          }));
          contentsToSave.push(...preservedRecommendedContents);
          
          console.log("[continueCampStepsForAdmin] 기존 추천 콘텐츠 보존:", {
            groupId,
            hasRecommendedContents,
            wizardDataRecommendedContentsLength: wizardData.recommended_contents?.length ?? 0,
            existingRecommendedContentsCount: existingRecommendedContents.length,
            preservedCount: preservedRecommendedContents.length,
          });
        }

        console.log("[continueCampStepsForAdmin] 저장할 콘텐츠 목록:", {
          groupId,
          totalContentsToSave: contentsToSave.length,
          studentContentsToSave: contentsToSave.filter((c) => !c.is_auto_recommended && !c.recommendation_source).length,
          recommendedContentsToSave: contentsToSave.filter((c) => c.is_auto_recommended || c.recommendation_source).length,
        });
        
        if (contentsToSave.length > 0) {
          // 학생이 실제로 가지고 있는 콘텐츠만 필터링
          const studentId = result.group.student_id;
          const validContents: Array<{
            content_type: string;
            content_id: string;
            start_range: number;
            end_range: number;
            display_order: number;
            master_content_id?: string | null;
            is_auto_recommended?: boolean;
            recommendation_source?: "auto" | "admin" | "template" | null;
            recommendation_reason?: string | null;
            recommendation_metadata?: any;
          }> = [];

          for (const content of contentsToSave) {
            let isValidContent = false;
            let actualContentId = content.content_id;

            if (content.content_type === "book") {
              // 먼저 학생 교재로 직접 조회
              const { data: studentBook } = await supabase
                .from("books")
                .select("id")
                .eq("id", content.content_id)
                .eq("student_id", studentId)
                .maybeSingle();

              if (studentBook) {
                isValidContent = true;
                actualContentId = studentBook.id;
              } else {
                // 마스터 교재인지 확인
                const { data: masterBook } = await supabase
                  .from("master_books")
                  .select("id")
                  .eq("id", content.content_id)
                  .maybeSingle();

                if (masterBook) {
                  // 마스터 교재인 경우, 해당 학생의 교재를 master_content_id로 찾기
                  const { data: studentBookByMaster } = await supabase
                    .from("books")
                    .select("id, master_content_id")
                    .eq("student_id", studentId)
                    .eq("master_content_id", content.content_id)
                    .maybeSingle();

                  if (studentBookByMaster) {
                    isValidContent = true;
                    actualContentId = studentBookByMaster.id;
                  } else {
                    // 마스터 교재를 학생 교재로 복사 (캠프 모드에서 자동 복사)
                    try {
                      const { copyMasterBookToStudent } = await import(
                        "@/lib/data/contentMasters"
                      );
                      const { bookId } = await copyMasterBookToStudent(
                        content.content_id,
                        studentId,
                        tenantContext.tenantId
                      );
                      isValidContent = true;
                      actualContentId = bookId;
                      console.log(
                        `[campTemplateActions] 마스터 교재(${content.content_id})를 학생 교재(${bookId})로 복사했습니다.`
                      );
                    } catch (copyError) {
                      console.error(
                        `[campTemplateActions] 마스터 교재 복사 실패: ${content.content_id}`,
                        copyError
                      );
                      // 복사 실패 시에도 마스터 콘텐츠 ID를 사용 (플랜 생성 시 자동 복사됨)
                      isValidContent = true;
                      actualContentId = content.content_id;
                    }
                  }
                } else {
                  console.warn(
                    `[campTemplateActions] 교재(${content.content_id})를 찾을 수 없습니다. 콘텐츠에서 제외합니다.`
                  );
                }
              }
            } else if (content.content_type === "lecture") {
              // 먼저 학생 강의로 직접 조회
              const { data: studentLecture } = await supabase
                .from("lectures")
                .select("id")
                .eq("id", content.content_id)
                .eq("student_id", studentId)
                .maybeSingle();

              if (studentLecture) {
                isValidContent = true;
                actualContentId = studentLecture.id;
              } else {
                // 마스터 강의인지 확인
                const { data: masterLecture } = await supabase
                  .from("master_lectures")
                  .select("id")
                  .eq("id", content.content_id)
                  .maybeSingle();

                if (masterLecture) {
                  // 마스터 강의인 경우, 해당 학생의 강의를 master_content_id로 찾기
                  const { data: studentLectureByMaster } = await supabase
                    .from("lectures")
                    .select("id, master_content_id")
                    .eq("student_id", studentId)
                    .eq("master_content_id", content.content_id)
                    .maybeSingle();

                  if (studentLectureByMaster) {
                    isValidContent = true;
                    actualContentId = studentLectureByMaster.id;
                  } else {
                    // 마스터 강의를 학생 강의로 복사 (캠프 모드에서 자동 복사)
                    try {
                      const { copyMasterLectureToStudent } = await import(
                        "@/lib/data/contentMasters"
                      );
                      const { lectureId } = await copyMasterLectureToStudent(
                        content.content_id,
                        studentId,
                        tenantContext.tenantId
                      );
                      isValidContent = true;
                      actualContentId = lectureId;
                      console.log(
                        `[campTemplateActions] 마스터 강의(${content.content_id})를 학생 강의(${lectureId})로 복사했습니다.`
                      );
                    } catch (copyError) {
                      console.error(
                        `[campTemplateActions] 마스터 강의 복사 실패: ${content.content_id}`,
                        copyError
                      );
                      // 복사 실패 시에도 마스터 콘텐츠 ID를 사용 (플랜 생성 시 자동 복사됨)
                      isValidContent = true;
                      actualContentId = content.content_id;
                    }
                  }
                } else {
                  console.warn(
                    `[campTemplateActions] 강의(${content.content_id})를 찾을 수 없습니다. 콘텐츠에서 제외합니다.`
                  );
                }
              }
            } else if (content.content_type === "custom") {
              // 커스텀 콘텐츠는 학생 ID로 직접 조회
              const { data: customContent } = await supabase
                .from("student_custom_contents")
                .select("id")
                .eq("id", content.content_id)
                .eq("student_id", studentId)
                .maybeSingle();

              if (customContent) {
                isValidContent = true;
                actualContentId = customContent.id;
              } else {
                console.warn(
                  `[campTemplateActions] 커스텀 콘텐츠(${content.content_id})를 찾을 수 없습니다. 콘텐츠에서 제외합니다.`
                );
              }
            }

            if (isValidContent) {
              const contentWithRecommendation = content as typeof content & {
                is_auto_recommended?: boolean;
                recommendation_source?: "auto" | "admin" | "template" | string | null;
                recommendation_reason?: string | null;
                recommendation_metadata?: any;
              };
              const recommendationSource = contentWithRecommendation.recommendation_source;
              const validRecommendationSource: "auto" | "admin" | "template" | null = 
                recommendationSource === "auto" || recommendationSource === "admin" || recommendationSource === "template"
                  ? recommendationSource
                  : null;
              validContents.push({
                content_type: content.content_type,
                content_id: actualContentId,
                start_range: content.start_range,
                end_range: content.end_range,
                display_order: content.display_order ?? 0,
                master_content_id: content.master_content_id || null,
                is_auto_recommended: contentWithRecommendation.is_auto_recommended ?? false,
                recommendation_source: validRecommendationSource,
                recommendation_reason: contentWithRecommendation.recommendation_reason || null,
                recommendation_metadata: contentWithRecommendation.recommendation_metadata || null,
              });
            }
          }

          if (validContents.length > 0) {
            const contentsResult = await createPlanContents(
              groupId,
              tenantContext.tenantId,
              validContents
            );

            if (!contentsResult.success) {
              throw new AppError(
                contentsResult.error || "콘텐츠 업데이트에 실패했습니다.",
                ErrorCode.DATABASE_ERROR,
                500,
                true
              );
            }

            // 데이터 병합 검증: 저장된 콘텐츠 확인
            const { data: savedContents } = await supabase
              .from("plan_contents")
              .select("*")
              .eq("plan_group_id", groupId);

            const savedStudentContents = savedContents?.filter(
              (c) => !c.is_auto_recommended && !c.recommendation_source
            ) || [];
            const savedRecommendedContents = savedContents?.filter(
              (c) => c.is_auto_recommended || c.recommendation_source
            ) || [];

            console.log("[campTemplateActions] 콘텐츠 병합 검증:", {
              groupId,
              studentId,
              hasStudentContents,
              hasRecommendedContents,
              existingStudentContentsCount: existingStudentContents.length,
              existingRecommendedContentsCount: existingRecommendedContents.length,
              savedStudentContentsCount: savedStudentContents.length,
              savedRecommendedContentsCount: savedRecommendedContents.length,
              validContentsCount: validContents.length,
              contentsToSaveCount: contentsToSave.length,
            });

            // 검증: 기존 학생 콘텐츠가 보존되었는지 확인
            // hasStudentContents가 false이거나 빈 배열인 경우 기존 콘텐츠가 보존되어야 함
            if (
              (!hasStudentContents || (hasStudentContents && wizardData.student_contents && wizardData.student_contents.length === 0)) &&
              existingStudentContents.length > 0
            ) {
              const preservedCount = savedStudentContents.filter((saved) =>
                existingStudentContents.some(
                  (existing) =>
                    existing.content_type === saved.content_type &&
                    existing.content_id === saved.content_id
                )
              ).length;

              if (preservedCount !== existingStudentContents.length) {
                console.warn(
                  `[campTemplateActions] 기존 학생 콘텐츠 보존 검증 실패:`,
                  {
                    expected: existingStudentContents.length,
                    actual: preservedCount,
                    groupId,
                    studentId,
                  }
                );
              } else {
                console.log(
                  `[campTemplateActions] 기존 학생 콘텐츠 보존 검증 성공: ${preservedCount}개 보존됨`
                );
              }
            }

            // 검증: 기존 추천 콘텐츠가 보존되었는지 확인
            // hasRecommendedContents가 false이거나 빈 배열인 경우 기존 콘텐츠가 보존되어야 함
            if (
              (!hasRecommendedContents || (hasRecommendedContents && wizardData.recommended_contents && wizardData.recommended_contents.length === 0)) &&
              existingRecommendedContents.length > 0
            ) {
              const preservedCount = savedRecommendedContents.filter((saved) =>
                existingRecommendedContents.some(
                  (existing) =>
                    existing.content_type === saved.content_type &&
                    existing.content_id === saved.content_id
                )
              ).length;

              if (preservedCount !== existingRecommendedContents.length) {
                console.warn(
                  `[campTemplateActions] 기존 추천 콘텐츠 보존 검증 실패:`,
                  {
                    expected: existingRecommendedContents.length,
                    actual: preservedCount,
                    groupId,
                    studentId,
                    hasRecommendedContents,
                    wizardDataRecommendedContentsLength: wizardData.recommended_contents?.length ?? 0,
                  }
                );
              } else {
                console.log(
                  `[campTemplateActions] 기존 추천 콘텐츠 보존 검증 성공: ${preservedCount}개 보존됨`
                );
              }
            }
          } else if (contentsToSave.length > 0) {
            // 유효한 콘텐츠가 없는 경우 경고만 출력 (에러는 발생시키지 않음)
            console.warn(
              `[campTemplateActions] 학생(${studentId})이 가지고 있는 유효한 콘텐츠가 없습니다.`
            );
          }
        }
      }

      // 제외일 업데이트 (기존 삭제 후 재생성)
      if (creationData.exclusions !== undefined) {
        const { error: deleteError } = await supabase
          .from("plan_exclusions")
          .delete()
          .eq("plan_group_id", groupId);

        if (deleteError) {
          console.error(
            "[campTemplateActions] 기존 제외일 삭제 실패",
            deleteError
          );
        }

        if (creationData.exclusions.length > 0) {
          const exclusionsResult = await createPlanExclusions(
            groupId,
            tenantContext.tenantId,
            creationData.exclusions.map((e) => ({
              exclusion_date: e.exclusion_date,
              exclusion_type: e.exclusion_type,
              reason: e.reason || null,
            }))
          );

          if (!exclusionsResult.success) {
            throw new AppError(
              exclusionsResult.error || "제외일 업데이트에 실패했습니다.",
              ErrorCode.DATABASE_ERROR,
              500,
              true
            );
          }
        }
      }

      // 학원 일정 업데이트 (학생별 전역 관리, UPSERT 방식)
      if (creationData.academy_schedules !== undefined) {
        const studentId = result.group.student_id;

        // 기존 학원 일정 조회 (중복 체크용)
        const { getStudentAcademySchedules } = await import("@/lib/data/planGroups");
        const existingSchedules = await getStudentAcademySchedules(studentId, tenantContext.tenantId);
        
        // 기존 학원 일정을 키로 매핑 (요일:시작시간:종료시간:학원명:과목)
        const existingKeys = new Set(
          existingSchedules.map((s) => 
            `${s.day_of_week}:${s.start_time}:${s.end_time}:${s.academy_name || ""}:${s.subject || ""}`
          )
        );

        // 새로운 학원 일정 중 중복되지 않은 것만 필터링
        const newSchedules = creationData.academy_schedules.filter((s) => {
          const key = `${s.day_of_week}:${s.start_time}:${s.end_time}:${s.academy_name || ""}:${s.subject || ""}`;
          return !existingKeys.has(key);
        });

        console.log("[campTemplateActions] 학원 일정 업데이트:", {
          studentId,
          totalSchedules: creationData.academy_schedules.length,
          existingSchedulesCount: existingSchedules.length,
          newSchedulesCount: newSchedules.length,
          skippedCount: creationData.academy_schedules.length - newSchedules.length,
        });

        // 중복되지 않은 새로운 학원 일정만 추가 (관리자 모드: Admin 클라이언트 사용)
        if (newSchedules.length > 0) {
          const schedulesResult = await createStudentAcademySchedules(
            studentId,
            tenantContext.tenantId,
            newSchedules.map((s) => ({
              day_of_week: s.day_of_week,
              start_time: s.start_time,
              end_time: s.end_time,
              academy_name: s.academy_name || null,
              subject: s.subject || null,
            })),
            true // 관리자 모드: Admin 클라이언트 사용 (RLS 우회)
          );

          if (!schedulesResult.success) {
            throw new AppError(
              schedulesResult.error || "학원 일정 업데이트에 실패했습니다.",
              ErrorCode.DATABASE_ERROR,
              500,
              true
            );
          }
        } else if (creationData.academy_schedules.length > 0) {
          // 모든 학원 일정이 이미 존재하는 경우 로그만 출력
          console.log("[campTemplateActions] 모든 학원 일정이 이미 존재합니다.");
        }
      }

      // Step 7에서만 플랜 생성
      // Step 4, 5, 6에서는 데이터 저장만 수행
      if (step === 7) {
        // 플랜 생성 전 필수 데이터 검증
        const validationErrors: string[] = [];

        // 1. 기간 검증
        const periodStart =
          updatePayload.period_start || result.group.period_start;
        const periodEnd = updatePayload.period_end || result.group.period_end;
        if (!periodStart || !periodEnd) {
          validationErrors.push("학습 기간이 설정되지 않았습니다.");
        } else {
          const start = new Date(periodStart);
          const end = new Date(periodEnd);
          if (start >= end) {
            validationErrors.push("시작일은 종료일보다 이전이어야 합니다.");
          }
        }

        // 2. 콘텐츠 검증 및 저장 보장
        // plan_contents 테이블에 콘텐츠가 있는지 먼저 확인 (DB 우선 확인)
        const { data: existingPlanContents } = await supabase
          .from("plan_contents")
          .select("id")
          .eq("plan_group_id", groupId)
          .limit(1);

        const hasPlanContents = existingPlanContents && existingPlanContents.length > 0;

        console.log("[campTemplateActions] Step 6 콘텐츠 검증 시작:", {
          groupId,
          step,
          hasPlanContents,
          existingPlanContentsCount: existingPlanContents?.length || 0,
          wizardDataStudentContents: wizardData.student_contents?.length ?? 0,
          wizardDataRecommendedContents: wizardData.recommended_contents?.length ?? 0,
          wizardDataStudentContentsIsUndefined: wizardData.student_contents === undefined,
          wizardDataRecommendedContentsIsUndefined: wizardData.recommended_contents === undefined,
        });

        // wizardData에서 콘텐츠 확인 (플랜 생성 전이므로 plan_contents 테이블이 비어있을 수 있음)
        // wizardData가 undefined이면 DB에서 콘텐츠를 로드하여 wizardData에 채움
        // continue/page.tsx에서 빈 배열을 undefined로 변환하여 전달하므로, undefined인 경우 DB에서 로드 필요
        let studentContents = wizardData.student_contents;
        let recommendedContents = wizardData.recommended_contents;
        
        // wizardData에 콘텐츠가 없고(undefined) DB에 콘텐츠가 있으면 DB에서 로드
        // 또는 wizardData에 콘텐츠가 빈 배열이고 DB에 콘텐츠가 있으면 DB에서 로드
        const hasWizardDataContents = 
          (wizardData.student_contents !== undefined && wizardData.student_contents.length > 0) ||
          (wizardData.recommended_contents !== undefined && wizardData.recommended_contents.length > 0);
        
        if (
          (!hasWizardDataContents && hasPlanContents) ||
          (wizardData.student_contents === undefined || wizardData.recommended_contents === undefined)
        ) {
          console.log("[campTemplateActions] Step 6 DB에서 콘텐츠 로드:", {
            wizardDataStudentContentsIsUndefined: wizardData.student_contents === undefined,
            wizardDataRecommendedContentsIsUndefined: wizardData.recommended_contents === undefined,
            hasPlanContents,
          });
          
          // DB에서 콘텐츠 조회
          const { getPlanGroupWithDetailsForAdmin } = await import(
            "@/lib/data/planGroups"
          );
          const dbResult = await getPlanGroupWithDetailsForAdmin(
            groupId,
            tenantContext.tenantId
          );
          
          if (dbResult.contents && dbResult.contents.length > 0) {
            // DB 콘텐츠를 wizardData 형식으로 변환
            const { syncCreationDataToWizardData } = await import(
              "@/lib/utils/planGroupDataSync"
            );
            const dbWizardData = syncCreationDataToWizardData({
              group: result.group,
              contents: dbResult.contents,
              exclusions: dbResult.exclusions || [],
              academySchedules: dbResult.academySchedules || [],
            });
            
            // wizardData에 채움 (undefined인 경우만)
            if (wizardData.student_contents === undefined) {
              studentContents = dbWizardData.student_contents || [];
            }
            if (wizardData.recommended_contents === undefined) {
              recommendedContents = dbWizardData.recommended_contents || [];
            }
          }
        }
        
        // undefined인 경우 빈 배열로 변환 (계산을 위해)
        if (studentContents === undefined) studentContents = [];
        if (recommendedContents === undefined) recommendedContents = [];
        
        // DB에서 로드한 콘텐츠 로그 (undefined 체크 이후)
        if (hasPlanContents) {
          console.log("[campTemplateActions] Step 6 DB에서 로드한 콘텐츠:", {
            loadedStudentContentsCount: studentContents.length,
            loadedRecommendedContentsCount: recommendedContents.length,
            totalLoadedContents: studentContents.length + recommendedContents.length,
          });
        }
        
        const totalContents = studentContents.length + recommendedContents.length;

        // DB에 콘텐츠가 있으면 저장 로직 스킵 (이미 저장되어 있음)
        if (hasPlanContents) {
          console.log("[campTemplateActions] Step 6 콘텐츠 저장 스킵:", {
            reason: "DB에 이미 콘텐츠가 있음",
            existingPlanContentsCount: existingPlanContents?.length || 0,
            wizardDataTotalContents: totalContents,
          });
        } else if (totalContents > 0) {
          // wizardData에 콘텐츠가 있고 plan_contents에 없으면 저장
          console.log("[campTemplateActions] Step 6에서 콘텐츠 저장 필요:", {
            totalContents,
            studentContents: studentContents.length,
            recommendedContents: recommendedContents.length,
          });

          // creationData를 다시 생성하여 콘텐츠 저장
          const creationDataForContents = syncWizardDataToCreationData(
            wizardData as WizardData
          );

          if (creationDataForContents.contents && creationDataForContents.contents.length > 0) {
            const studentId = result.group.student_id;
            const validContents: Array<{
              content_type: string;
              content_id: string;
              start_range: number;
              end_range: number;
              display_order: number;
              master_content_id?: string | null;
            }> = [];

            for (const content of creationDataForContents.contents) {
              let isValidContent = false;
              let actualContentId = content.content_id;
              let masterContentId: string | null = null;

              if (content.content_type === "book") {
                // 먼저 학생 교재로 직접 조회
                const { data: studentBook } = await supabase
                  .from("books")
                  .select("id, master_content_id")
                  .eq("id", content.content_id)
                  .eq("student_id", studentId)
                  .maybeSingle();

                if (studentBook) {
                  isValidContent = true;
                  actualContentId = studentBook.id;
                  masterContentId = studentBook.master_content_id || null;
                } else {
                  // 마스터 교재인지 확인
                  const { data: masterBook } = await supabase
                    .from("master_books")
                    .select("id")
                    .eq("id", content.content_id)
                    .maybeSingle();

                  if (masterBook) {
                    // 마스터 교재인 경우, 해당 학생의 교재를 master_content_id로 찾기
                    const { data: studentBookByMaster } = await supabase
                      .from("books")
                      .select("id, master_content_id")
                      .eq("student_id", studentId)
                      .eq("master_content_id", content.content_id)
                      .maybeSingle();

                    if (studentBookByMaster) {
                      isValidContent = true;
                      actualContentId = studentBookByMaster.id;
                      masterContentId = content.content_id; // 원본 마스터 콘텐츠 ID
                    } else {
                      // 마스터 교재를 학생 교재로 복사 (캠프 모드에서 자동 복사)
                      try {
                        const { copyMasterBookToStudent } = await import(
                          "@/lib/data/contentMasters"
                        );
                        const { bookId } = await copyMasterBookToStudent(
                          content.content_id,
                          studentId,
                          tenantContext.tenantId
                        );
                        isValidContent = true;
                        actualContentId = bookId;
                        masterContentId = content.content_id; // 원본 마스터 콘텐츠 ID
                        console.log(
                          `[campTemplateActions] 마스터 교재(${content.content_id})를 학생 교재(${bookId})로 복사했습니다.`
                        );
                      } catch (copyError) {
                        console.error(
                          `[campTemplateActions] 마스터 교재 복사 실패: ${content.content_id}`,
                          copyError
                        );
                        // 복사 실패 시에도 마스터 콘텐츠 ID를 사용 (플랜 생성 시 자동 복사됨)
                        isValidContent = true;
                        actualContentId = content.content_id;
                        masterContentId = content.content_id;
                      }
                    }
                  }
                }
              } else if (content.content_type === "lecture") {
                // 먼저 학생 강의로 직접 조회
                const { data: studentLecture } = await supabase
                  .from("lectures")
                  .select("id, master_content_id")
                  .eq("id", content.content_id)
                  .eq("student_id", studentId)
                  .maybeSingle();

                if (studentLecture) {
                  isValidContent = true;
                  actualContentId = studentLecture.id;
                  masterContentId = studentLecture.master_content_id || null;
                } else {
                  // 마스터 강의인지 확인
                  const { data: masterLecture } = await supabase
                    .from("master_lectures")
                    .select("id")
                    .eq("id", content.content_id)
                    .maybeSingle();

                  if (masterLecture) {
                    // 마스터 강의인 경우, 해당 학생의 강의를 master_content_id로 찾기
                    const { data: studentLectureByMaster } = await supabase
                      .from("lectures")
                      .select("id, master_content_id")
                      .eq("student_id", studentId)
                      .eq("master_content_id", content.content_id)
                      .maybeSingle();

                    if (studentLectureByMaster) {
                      isValidContent = true;
                      actualContentId = studentLectureByMaster.id;
                      masterContentId = content.content_id; // 원본 마스터 콘텐츠 ID
                    } else {
                      // 마스터 강의를 학생 강의로 복사 (캠프 모드에서 자동 복사)
                      try {
                        const { copyMasterLectureToStudent } = await import(
                          "@/lib/data/contentMasters"
                        );
                        const { lectureId } = await copyMasterLectureToStudent(
                          content.content_id,
                          studentId,
                          tenantContext.tenantId
                        );
                        isValidContent = true;
                        actualContentId = lectureId;
                        masterContentId = content.content_id; // 원본 마스터 콘텐츠 ID
                        console.log(
                          `[campTemplateActions] 마스터 강의(${content.content_id})를 학생 강의(${lectureId})로 복사했습니다.`
                        );
                      } catch (copyError) {
                        console.error(
                          `[campTemplateActions] 마스터 강의 복사 실패: ${content.content_id}`,
                          copyError
                        );
                        // 복사 실패 시에도 마스터 콘텐츠 ID를 사용 (플랜 생성 시 자동 복사됨)
                        isValidContent = true;
                        actualContentId = content.content_id;
                        masterContentId = content.content_id;
                      }
                    }
                  }
                }
              } else if (content.content_type === "custom") {
                // 커스텀 콘텐츠는 학생 ID로 직접 조회
                const { data: customContent } = await supabase
                  .from("student_custom_contents")
                  .select("id")
                  .eq("id", content.content_id)
                  .eq("student_id", studentId)
                  .maybeSingle();

                if (customContent) {
                  isValidContent = true;
                  actualContentId = customContent.id;
                }
              }

              if (isValidContent) {
                validContents.push({
                  content_type: content.content_type,
                  content_id: actualContentId,
                  start_range: content.start_range,
                  end_range: content.end_range,
                  display_order: content.display_order ?? 0,
                  master_content_id: masterContentId,
                });
              }
            }

            if (validContents.length > 0) {
              // 추천 콘텐츠 정보 추출 (wizardData에서)
              const recommendedContentIds = new Set(
                recommendedContents.map((c) => c.content_id)
              );
              
              const contentsToSave: Array<{
                content_type: string;
                content_id: string;
                start_range: number;
                end_range: number;
                display_order: number;
                master_content_id: string | null;
                is_auto_recommended: boolean;
                recommendation_source: "auto" | "admin" | "template" | null;
                recommendation_reason: string | null;
                recommendation_metadata: any;
              }> = validContents.map((c, idx) => {
                const isRecommended = recommendedContentIds.has(c.content_id) || 
                  (c.master_content_id && recommendedContentIds.has(c.master_content_id));
                
                // wizardData에서 추천 정보 가져오기
                const recommendedContent = recommendedContents.find(
                  (rc) => rc.content_id === c.content_id || rc.content_id === c.master_content_id
                );
                
                // 관리자가 추가하는 경우는 항상 is_auto_recommended: false, recommendation_source: "admin"으로 강제 설정
                return {
                  content_type: c.content_type,
                  content_id: c.content_id,
                  start_range: c.start_range,
                  end_range: c.end_range,
                  display_order: c.display_order ?? idx,
                  master_content_id: c.master_content_id || null,
                  is_auto_recommended: false, // 관리자 추가는 항상 false
                  recommendation_source: (isRecommended ? "admin" : null) as "auto" | "admin" | "template" | null, // 관리자 추가는 항상 "admin"으로 강제 설정
                  recommendation_reason: (recommendedContent as any)?.recommendation_reason ?? null,
                  recommendation_metadata: (recommendedContent as any)?.recommendation_metadata ?? null,
                };
              });

              const contentsResult = await createPlanContents(
                groupId,
                tenantContext.tenantId,
                contentsToSave
              );

              if (!contentsResult.success) {
                throw new AppError(
                  contentsResult.error || "콘텐츠 저장에 실패했습니다.",
                  ErrorCode.DATABASE_ERROR,
                  500,
                  true
                );
              }

              console.log("[campTemplateActions] Step 6에서 콘텐츠 저장 완료:", {
                savedCount: validContents.length,
                totalContents: creationDataForContents.contents.length,
              });
            } else {
              // 콘텐츠 저장 실패: 모든 콘텐츠가 필터링됨
              console.error(
                `[campTemplateActions] 학생(${result.group.student_id})이 가지고 있는 유효한 콘텐츠가 없습니다.`,
                {
                  creationDataContentsCount: creationDataForContents.contents.length,
                  validContentsCount: validContents.length,
                  wizardDataStudentContents: studentContents.length,
                  wizardDataRecommendedContents: recommendedContents.length,
                  reason: "콘텐츠 저장 과정에서 모든 콘텐츠가 필터링되었습니다. 학생이 해당 콘텐츠를 가지고 있지 않거나, 콘텐츠 ID가 유효하지 않을 수 있습니다.",
                }
              );
              // 이 경우에도 플랜 생성은 가능하도록 허용 (플랜 생성 시 콘텐츠가 자동으로 처리될 수 있음)
              // 단, 경고 로그만 남기고 검증 에러는 발생시키지 않음
            }
          } else {
            console.warn(
              "[campTemplateActions] Step 6에서 creationDataForContents.contents가 비어있습니다.",
              {
                wizardDataStudentContents: studentContents.length,
                wizardDataRecommendedContents: recommendedContents.length,
              }
            );
          }
        } else {
          console.log("[campTemplateActions] Step 6 콘텐츠 저장 스킵:", {
            totalContents,
            hasPlanContents,
            reason:
              totalContents === 0
                ? "wizardData에 콘텐츠가 없음"
                : "plan_contents에 이미 콘텐츠가 있음",
          });
        }

        // 최종 콘텐츠 검증
        // 위에서 로드한 콘텐츠 사용 (wizardData 또는 DB에서 로드)
        const finalStudentContents = studentContents;
        const finalRecommendedContents = recommendedContents;
        const finalTotalContents = finalStudentContents.length + finalRecommendedContents.length;

        console.log("[campTemplateActions] Step 6 최종 콘텐츠 검증:", {
          wizardDataStudentContents: finalStudentContents.length,
          wizardDataRecommendedContents: finalRecommendedContents.length,
          wizardDataTotalContents: finalTotalContents,
          hasPlanContents,
          existingPlanContentsCount: existingPlanContents?.length || 0,
        });

        // 최종적으로 plan_contents 테이블에 콘텐츠가 있는지 확인
        // (wizardData에 콘텐츠가 없어도 DB에 있으면 플랜 생성 가능)
        const { data: finalPlanContents } = await supabase
          .from("plan_contents")
          .select("id")
          .eq("plan_group_id", groupId)
          .limit(1);

        console.log("[campTemplateActions] Step 6 최종 plan_contents 테이블 확인:", {
          finalPlanContentsCount: finalPlanContents?.length || 0,
          hasFinalPlanContents: finalPlanContents && finalPlanContents.length > 0,
          wizardDataTotalContents: finalTotalContents,
          wizardDataStudentContents: finalStudentContents.length,
          wizardDataRecommendedContents: finalRecommendedContents.length,
        });

        // 검증: DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우에만 에러
        const hasFinalPlanContents = finalPlanContents && finalPlanContents.length > 0;
        const hasWizardContents = finalTotalContents > 0;

        if (!hasFinalPlanContents && !hasWizardContents) {
          // DB에 콘텐츠가 없고 wizardData에도 콘텐츠가 없는 경우
          validationErrors.push(
            "플랜에 포함될 콘텐츠가 없습니다. Step 3 또는 Step 4에서 콘텐츠를 선택해주세요."
          );
        } else if (!hasFinalPlanContents && hasWizardContents) {
          // wizardData에 콘텐츠가 있지만 DB에 저장되지 않은 경우
          // (콘텐츠 저장 과정에서 모든 콘텐츠가 필터링되었을 수 있음)
          console.warn(
            "[campTemplateActions] Step 6 검증: wizardData에 콘텐츠가 있지만 DB에 저장되지 않음. 콘텐츠 저장 과정을 확인하세요.",
            {
              wizardDataStudentContents: finalStudentContents.length,
              wizardDataRecommendedContents: finalRecommendedContents.length,
              wizardDataTotalContents: finalTotalContents,
            }
          );
          // 이 경우에도 플랜 생성은 가능하도록 허용 (플랜 생성 시 콘텐츠가 자동으로 처리될 수 있음)
          // 단, 경고 로그만 남기고 검증 에러는 발생시키지 않음
        } else {
          console.log("[campTemplateActions] Step 6 최종 검증: 콘텐츠가 있어 플랜 생성 가능:", {
            hasFinalPlanContents,
            hasWizardContents,
            finalPlanContentsCount: finalPlanContents?.length || 0,
            wizardDataTotalContents: finalTotalContents,
          });
        }

        // 3. 템플릿 블록 세트 검증 (캠프 모드)
        if (result.group.camp_template_id) {
          // 새로운 연결 테이블 방식으로 블록 세트 조회
          const { data: templateBlockSetLink } = await supabase
            .from("camp_template_block_sets")
            .select("tenant_block_set_id")
            .eq("camp_template_id", result.group.camp_template_id)
            .maybeSingle();

          let tenantBlockSetId: string | null = null;
          if (templateBlockSetLink) {
            tenantBlockSetId = templateBlockSetLink.tenant_block_set_id;
          } else {
            // 하위 호환성: template_data.block_set_id 확인 (마이그레이션 전 데이터용)
            const { data: templateData } = await supabase
              .from("camp_templates")
              .select("template_data")
              .eq("id", result.group.camp_template_id)
              .maybeSingle();

            if (templateData?.template_data?.block_set_id) {
              tenantBlockSetId = templateData.template_data.block_set_id;
            }
          }

          if (tenantBlockSetId) {
            // tenant_blocks 테이블에서 블록 조회
            const { data: templateBlocks } = await supabase
              .from("tenant_blocks")
              .select("id")
              .eq("tenant_block_set_id", tenantBlockSetId)
              .limit(1);

            if (!templateBlocks || templateBlocks.length === 0) {
              validationErrors.push(
                "템플릿 블록 세트에 블록이 없습니다. 관리자에게 문의해주세요."
              );
            }
          } else {
            validationErrors.push(
              "템플릿 블록 세트가 설정되지 않았습니다. 관리자에게 문의해주세요."
            );
          }
        }

        // 검증 실패 시 에러 발생
        if (validationErrors.length > 0) {
          throw new AppError(
            `플랜 생성 전 검증 실패:\n${validationErrors.join("\n")}`,
            ErrorCode.VALIDATION_ERROR,
            400,
            true
          );
        }

        // 플랜이 이미 생성되어 있는지 확인
        const { data: existingPlans } = await supabase
          .from("student_plan")
          .select("id")
          .eq("plan_group_id", groupId)
          .limit(1);

        const plansAlreadyExist = existingPlans && existingPlans.length > 0;

        // 플랜이 이미 생성되어 있으면 플랜 생성 스킵
        if (!plansAlreadyExist) {
        // generatePlansFromGroupAction은 verifyPlanGroupAccess를 사용하여
        // Admin/Consultant 권한도 지원합니다 (planGroupAuth.ts 참조)
        const { generatePlansFromGroupAction } = await import(
          "@/app/(student)/actions/planGroupActions"
        );

        try {
          await generatePlansFromGroupAction(groupId);

          // 플랜 생성 후 상태를 "saved"로 변경
          const { error: statusUpdateError } = await supabase
            .from("plan_groups")
            .update({ status: "saved", updated_at: new Date().toISOString() })
            .eq("id", groupId);

          if (statusUpdateError) {
            console.error(
              "[campTemplateActions] 플랜 그룹 상태 업데이트 실패:",
              statusUpdateError
            );
            // 상태 업데이트 실패는 경고만 (플랜은 생성됨)
            console.warn(
              "[campTemplateActions] 플랜 그룹 상태를 saved로 변경하지 못했습니다."
            );
          }
        } catch (planError) {
          console.error("[campTemplateActions] 플랜 생성 실패:", planError);
          throw new AppError(
            planError instanceof Error
              ? planError.message
              : "플랜 생성에 실패했습니다.",
            ErrorCode.DATABASE_ERROR,
            500,
            true
          );
          }
        } else {
          console.log("[campTemplateActions] 플랜이 이미 생성되어 있어 플랜 생성 스킵:", {
            groupId,
            existingPlansCount: existingPlans?.length || 0,
          });
        }
      }
    } catch (error) {
      console.error("[campTemplateActions] 캠프 남은 단계 진행 실패:", error);
      throw new AppError(
        error instanceof Error
          ? error.message
          : "플랜 그룹 업데이트에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    return {
      success: true,
    };
  }
);

/**
 * 관리자용 캠프 플랜 그룹 subject_allocations 업데이트
 */
export const updateCampPlanGroupSubjectAllocations = withErrorHandling(
  async (
    groupId: string,
    subjectAllocations: Array<{
      subject_id: string;
      subject_name: string;
      subject_type: "strategy" | "weakness";
      weekly_days?: number;
    }> | null
  ) => {
    const { role } = await getCurrentUserRole();
    if (role !== "admin" && role !== "consultant") {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    // 플랜 그룹 존재 및 권한 확인
    const { data: group, error: groupError } = await supabase
      .from("plan_groups")
      .select("id, plan_type, tenant_id")
      .eq("id", groupId)
      .eq("tenant_id", tenantContext.tenantId)
      .maybeSingle();

    if (groupError || !group) {
      throw new AppError(
        "플랜 그룹을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (group.plan_type !== "camp") {
      throw new AppError(
        "캠프 플랜 그룹이 아닙니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // scheduler_options 업데이트 (subject_allocations 포함)
    const { data: currentGroup } = await supabase
      .from("plan_groups")
      .select("scheduler_options")
      .eq("id", groupId)
      .maybeSingle();

    const currentSchedulerOptions =
      (currentGroup?.scheduler_options as any) || {};
    const updatedSchedulerOptions = {
      ...currentSchedulerOptions,
      subject_allocations: subjectAllocations,
    };

    const { error: updateError } = await supabase
      .from("plan_groups")
      .update({
        scheduler_options: updatedSchedulerOptions,
        updated_at: new Date().toISOString(),
      })
      .eq("id", groupId);

    if (updateError) {
      throw new AppError(
        "전략과목/취약과목 설정 업데이트에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true,
        { originalError: updateError.message }
      );
    }

    return { success: true };
  }
);

/**
 * 관리자용 캠프 플랜 그룹 상태 변경 (단일)
 */
export const updateCampPlanGroupStatus = withErrorHandling(
  async (
    groupId: string,
    status: string
  ): Promise<{ success: boolean; error?: string }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    // 플랜 그룹 존재 및 권한 확인
    const { data: group, error: groupError } = await supabase
      .from("plan_groups")
      .select("id, student_id, plan_type, tenant_id, status, camp_template_id")
      .eq("id", groupId)
      .eq("tenant_id", tenantContext.tenantId)
      .maybeSingle();

    if (groupError || !group) {
      throw new AppError(
        "플랜 그룹을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (group.plan_type !== "camp") {
      throw new AppError(
        "캠프 플랜 그룹이 아닙니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 상태 전이 검증
    const { PlanValidator } = await import("@/lib/validation/planValidator");
    const statusValidation = PlanValidator.validateStatusTransition(
      group.status as any,
      status as any
    );
    if (!statusValidation.valid) {
      throw new AppError(
        statusValidation.errors.join(", ") || "상태 전이가 불가능합니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // active로 변경 시 플랜 생성 여부 확인
    if (status === "active") {
      const { count, error: plansError } = await supabase
        .from("student_plan")
        .select("*", { count: "exact", head: true })
        .eq("plan_group_id", groupId);

      if (plansError) {
        console.error("[campTemplateActions] 플랜 개수 확인 실패", plansError);
        throw new AppError(
          "플랜 개수 확인에 실패했습니다.",
          ErrorCode.DATABASE_ERROR,
          500,
          true
        );
      }

      if ((count ?? 0) === 0) {
        throw new AppError(
          "플랜이 생성되지 않은 플랜 그룹은 활성화할 수 없습니다.",
          ErrorCode.VALIDATION_ERROR,
          400,
          true
        );
      }

      // 활성화 시 같은 모드(캠프 모드)의 다른 활성 플랜 그룹만 비활성화
      // 일반 모드와 캠프 모드는 각각 1개씩 활성화 가능
      // 이 함수는 캠프 플랜 그룹 활성화이므로, 캠프 모드 활성 플랜 그룹만 비활성화
      const { data: allActiveGroups, error: activeGroupsError } = await supabase
        .from("plan_groups")
        .select("id, plan_type, camp_template_id, camp_invitation_id")
        .eq("student_id", group.student_id)
        .eq("status", "active")
        .neq("id", groupId)
        .is("deleted_at", null);

      if (activeGroupsError) {
        console.error(
          "[campTemplateActions] 활성 플랜 그룹 조회 실패",
          activeGroupsError
        );
      } else if (allActiveGroups && allActiveGroups.length > 0) {
        // 캠프 모드 활성 플랜 그룹만 필터링
        const campModeGroups = allActiveGroups.filter(
          (g) =>
            g.plan_type === "camp" ||
            g.camp_template_id !== null ||
            g.camp_invitation_id !== null
        );

        if (campModeGroups.length > 0) {
          // 같은 모드(캠프 모드)의 다른 활성 플랜 그룹들을 "saved" 상태로 변경
          const activeGroupIds = campModeGroups.map((g) => g.id);
          const { error: deactivateError } = await supabase
            .from("plan_groups")
            .update({ status: "saved", updated_at: new Date().toISOString() })
            .in("id", activeGroupIds);

          if (deactivateError) {
            console.error(
              "[campTemplateActions] 같은 모드(캠프 모드)의 다른 활성 플랜 그룹 비활성화 실패",
              deactivateError
            );
            // 비활성화 실패해도 계속 진행 (경고만)
          }
        }
      }
    }

    // 상태 업데이트
    const { error: updateError } = await supabase
      .from("plan_groups")
      .update({
        status,
        updated_at: new Date().toISOString(),
      })
      .eq("id", groupId);

    if (updateError) {
      throw new AppError(
        "플랜 그룹 상태 업데이트에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true,
        { originalError: updateError.message }
      );
    }

    return { success: true };
  }
);

/**
 * 관리자용 캠프 플랜 그룹 상태 일괄 변경
 */
export const batchUpdateCampPlanGroupStatus = withErrorHandling(
  async (
    groupIds: string[],
    status: string
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ groupId: string; error: string }>;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (!Array.isArray(groupIds) || groupIds.length === 0) {
      throw new AppError(
        "플랜 그룹을 선택해주세요.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // 중복 제거
    const uniqueGroupIds = Array.from(new Set(groupIds));

    const supabase = await createSupabaseServerClient();

    // 모든 플랜 그룹 조회 및 권한 확인
    const { data: groups, error: groupsError } = await supabase
      .from("plan_groups")
      .select("id, student_id, plan_type, tenant_id, status, camp_template_id")
      .in("id", uniqueGroupIds)
      .eq("tenant_id", tenantContext.tenantId);

    if (groupsError) {
      throw new AppError(
        "플랜 그룹 조회에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true,
        { originalError: groupsError.message }
      );
    }

    if (!groups || groups.length === 0) {
      throw new AppError(
        "선택한 플랜 그룹을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 캠프 플랜 그룹인지 확인
    const invalidGroups = groups.filter((g) => g.plan_type !== "camp");
    if (invalidGroups.length > 0) {
      throw new AppError(
        "캠프 플랜 그룹이 아닌 항목이 포함되어 있습니다.",
        ErrorCode.VALIDATION_ERROR,
        400,
        true
      );
    }

    // active로 변경 시 플랜 생성 여부 일괄 확인
    if (status === "active") {
      const { data: plansData, error: plansError } = await supabase
        .from("student_plan")
        .select("plan_group_id")
        .in("plan_group_id", uniqueGroupIds);

      if (plansError) {
        console.error(
          "[campTemplateActions] 플랜 개수 일괄 확인 실패",
          plansError
        );
        throw new AppError(
          "플랜 개수 확인에 실패했습니다.",
          ErrorCode.DATABASE_ERROR,
          500,
          true
        );
      }

      // 플랜 그룹별 플랜 존재 여부 매핑
      const plansMap = new Set((plansData || []).map((p) => p.plan_group_id));
      const groupsWithoutPlans = groups.filter((g) => !plansMap.has(g.id));

      if (groupsWithoutPlans.length > 0) {
        throw new AppError(
          `플랜이 생성되지 않은 플랜 그룹이 ${groupsWithoutPlans.length}개 있습니다.`,
          ErrorCode.VALIDATION_ERROR,
          400,
          true
        );
      }

      // 활성화 시 각 학생별로 다른 활성 플랜 그룹 비활성화
      const studentIds = Array.from(new Set(groups.map((g) => g.student_id)));
      for (const studentId of studentIds) {
        const studentGroups = groups.filter((g) => g.student_id === studentId);
        const studentGroupIds = new Set(studentGroups.map((g) => g.id));

        // 해당 학생의 모든 활성 플랜 그룹 조회
        const { data: allActiveGroups } = await supabase
          .from("plan_groups")
          .select("id")
          .eq("student_id", studentId)
          .eq("status", "active")
          .is("deleted_at", null);

        if (allActiveGroups && allActiveGroups.length > 0) {
          // 현재 선택한 그룹을 제외한 다른 활성 플랜 그룹들만 필터링
          const otherActiveGroupIds = allActiveGroups
            .map((g) => g.id)
            .filter((id) => !studentGroupIds.has(id));

          if (otherActiveGroupIds.length > 0) {
            // 다른 활성 플랜 그룹들을 "saved" 상태로 변경
            await supabase
              .from("plan_groups")
              .update({ status: "saved", updated_at: new Date().toISOString() })
              .in("id", otherActiveGroupIds);
            // 에러는 무시 (경고만)
          }
        }
      }
    }

    // 각 그룹에 대한 상태 전이 검증 및 일괄 업데이트
    const { PlanValidator } = await import("@/lib/validation/planValidator");
    const errors: Array<{ groupId: string; error: string }> = [];
    const successGroupIds: string[] = [];

    for (const group of groups) {
      const statusValidation = PlanValidator.validateStatusTransition(
        group.status as any,
        status as any
      );

      if (!statusValidation.valid) {
        errors.push({
          groupId: group.id,
          error:
            statusValidation.errors.join(", ") || "상태 전이가 불가능합니다.",
        });
        continue;
      }

      successGroupIds.push(group.id);
    }

    // 성공한 그룹들만 일괄 업데이트
    let successCount = 0;
    if (successGroupIds.length > 0) {
      const { error: updateError } = await supabase
        .from("plan_groups")
        .update({
          status,
          updated_at: new Date().toISOString(),
        })
        .in("id", successGroupIds);

      if (updateError) {
        // 일괄 업데이트 실패 시 개별 업데이트 시도
        console.error(
          "[campTemplateActions] 일괄 상태 업데이트 실패, 개별 업데이트 시도",
          updateError
        );

        for (const groupId of successGroupIds) {
          const { error: individualError } = await supabase
            .from("plan_groups")
            .update({
              status,
              updated_at: new Date().toISOString(),
            })
            .eq("id", groupId);

          if (individualError) {
            errors.push({
              groupId,
              error: individualError.message || "상태 업데이트에 실패했습니다.",
            });
          } else {
            successCount++;
          }
        }
      } else {
        successCount = successGroupIds.length;
      }
    }

    return {
      success: errors.length === 0,
      successCount,
      failureCount: errors.length,
      errors: errors.length > 0 ? errors : undefined,
    };
  }
);

/**
 * 다수 학생에게 추천 콘텐츠 일괄 적용
 */
export const bulkApplyRecommendedContents = withErrorHandling(
  async (
    templateId: string,
    groupIds: string[],
    subjectCountsMap: Record<string, Record<string, number>>, // groupId -> (subject -> count)
    options?: {
      replaceExisting?: boolean; // 기존 추천 콘텐츠 교체 여부 (기본값: false, 유지)
    }
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ groupId: string; error: string }>;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const supabase = await createSupabaseServerClient();
    const errors: Array<{ groupId: string; error: string }> = [];
    let successCount = 0;

    // 각 플랜 그룹에 대해 추천 콘텐츠 적용
    for (const groupId of groupIds) {
      try {
        // 플랜 그룹 정보 조회
        const { data: group, error: groupError } = await supabase
          .from("plan_groups")
          .select("id, student_id, tenant_id")
          .eq("id", groupId)
          .eq("tenant_id", tenantContext.tenantId)
          .maybeSingle();

        if (groupError || !group) {
          errors.push({
            groupId,
            error: groupError?.message || "플랜 그룹을 찾을 수 없습니다.",
          });
          continue;
        }

        // 학생 ID 조회
        const studentId = group.student_id;
        if (!studentId) {
          errors.push({
            groupId,
            error: "학생 ID를 찾을 수 없습니다.",
          });
          continue;
        }

        // 해당 그룹의 교과/수량 설정 조회
        const subjectCounts = subjectCountsMap[groupId];
        if (!subjectCounts || Object.keys(subjectCounts).length === 0) {
          // 수량 설정이 없으면 스킵
          continue;
        }

        // Map으로 변환
        const requestedSubjectCounts = new Map<string, number>();
        for (const [subject, count] of Object.entries(subjectCounts)) {
          if (count > 0) {
            requestedSubjectCounts.set(subject, count);
          }
        }

        if (requestedSubjectCounts.size === 0) {
          continue;
        }

        // 추천 콘텐츠 조회
        const recommendations = await getRecommendedMasterContents(
          supabase,
          studentId,
          tenantContext.tenantId,
          requestedSubjectCounts
        );

        if (recommendations.length === 0) {
          console.warn(
            `[bulkApplyRecommendedContents] 추천 콘텐츠가 없습니다. groupId: ${groupId}, studentId: ${studentId}`
          );
          continue;
        }

        // 기존 추천 콘텐츠 처리
        if (options?.replaceExisting) {
          // 기존 추천 콘텐츠 삭제 (is_auto_recommended가 true이거나 recommendation_source가 있는 것만)
          const existingContents = await getPlanContents(
            groupId,
            tenantContext.tenantId
          );

          if (existingContents && existingContents.length > 0) {
            const recommendedContentIds = existingContents
              .filter(
                (c) =>
                  c.is_auto_recommended || c.recommendation_source !== null
              )
              .map((c) => c.id);

            if (recommendedContentIds.length > 0) {
              const { error: deleteError } = await supabase
                .from("plan_contents")
                .delete()
                .in("id", recommendedContentIds);

              if (deleteError) {
                console.error(
                  `[bulkApplyRecommendedContents] 기존 추천 콘텐츠 삭제 실패:`,
                  deleteError
                );
              }
            }
          }
        }

        // 학생이 실제로 가지고 있는 콘텐츠만 필터링
        const validContents: Array<{
          content_type: "book" | "lecture";
          content_id: string;
          start_range: number;
          end_range: number;
          display_order: number;
          master_content_id: string | null;
          is_auto_recommended: boolean;
          recommendation_source: "admin" | null;
        }> = [];

        for (const rec of recommendations) {
          let actualContentId: string | null = null;
          let isValidContent = false;

          // 학생 콘텐츠 조회
          if (rec.contentType === "book") {
            const { data: book } = await supabase
              .from("books")
              .select("id, master_content_id")
              .eq("student_id", studentId)
              .eq("master_content_id", rec.id)
              .maybeSingle();

            if (book) {
              actualContentId = book.id;
              isValidContent = true;
            }
          } else if (rec.contentType === "lecture") {
            const { data: lecture } = await supabase
              .from("lectures")
              .select("id, master_content_id")
              .eq("student_id", studentId)
              .eq("master_content_id", rec.id)
              .maybeSingle();

            if (lecture) {
              actualContentId = lecture.id;
              isValidContent = true;
            }
          }

          if (isValidContent && actualContentId) {
            // 콘텐츠 상세 정보 조회하여 범위 설정
            let startRange = 1;
            let endRange = 100;

            try {
              if (rec.contentType === "book") {
                const { data: bookDetails } = await supabase
                  .from("book_details")
                  .select("page_number")
                  .eq("book_id", actualContentId)
                  .order("page_number", { ascending: true })
                  .limit(1);

                if (bookDetails && bookDetails.length > 0) {
                  startRange = bookDetails[0].page_number || 1;
                }

                const { data: totalData } = await supabase
                  .from("books")
                  .select("total_pages")
                  .eq("id", actualContentId)
                  .maybeSingle();

                if (totalData?.total_pages) {
                  endRange = totalData.total_pages;
                }
              } else if (rec.contentType === "lecture") {
                const { data: lectureDetails } = await supabase
                  .from("lecture_episodes")
                  .select("episode_number")
                  .eq("lecture_id", actualContentId)
                  .order("episode_number", { ascending: true })
                  .limit(1);

                if (lectureDetails && lectureDetails.length > 0) {
                  startRange = lectureDetails[0].episode_number || 1;
                }

                const { data: totalData } = await supabase
                  .from("lectures")
                  .select("total_episodes")
                  .eq("id", actualContentId)
                  .maybeSingle();

                if (totalData?.total_episodes) {
                  endRange = totalData.total_episodes;
                }
              }
            } catch (infoError) {
              // 상세 정보 조회 실패는 무시 (기본값 사용)
            }

            validContents.push({
              content_type: rec.contentType,
              content_id: actualContentId,
              start_range: startRange,
              end_range: endRange,
              display_order: validContents.length,
              master_content_id: rec.id,
              is_auto_recommended: false, // 관리자 추가는 항상 false
              recommendation_source: "admin", // 관리자 추가는 항상 "admin"
            });
          }
        }

        // 학생당 최대 9개 제한 검증
        const existingPlanContents = await getPlanContents(
          groupId,
          tenantContext.tenantId
        );
        const currentCount = existingPlanContents?.length || 0;
        const newCount = validContents.length;
        const totalCount = options?.replaceExisting
          ? currentCount -
              (existingPlanContents?.filter(
                (c) => c.is_auto_recommended || c.recommendation_source !== null
              ).length || 0) +
              newCount
          : currentCount + newCount;

        if (totalCount > 9) {
          errors.push({
            groupId,
            error: `최대 콘텐츠 수(9개)를 초과합니다. 현재: ${currentCount}개, 추가 예정: ${newCount}개, 총합: ${totalCount}개`,
          });
          continue;
        }

        // 추천 콘텐츠 저장
        if (validContents.length > 0) {
          const contentsResult = await createPlanContents(
            groupId,
            tenantContext.tenantId,
            validContents.map((c) => ({
              content_type: c.content_type,
              content_id: c.content_id,
              start_range: c.start_range,
              end_range: c.end_range,
              display_order: c.display_order,
              master_content_id: c.master_content_id,
              is_auto_recommended: c.is_auto_recommended,
              recommendation_source: c.recommendation_source,
            }))
          );

          if (!contentsResult.success) {
            errors.push({
              groupId,
              error: contentsResult.error || "콘텐츠 저장에 실패했습니다.",
            });
            continue;
          }

          successCount++;
        }
      } catch (error) {
        console.error(
          `[bulkApplyRecommendedContents] 그룹 ${groupId} 처리 실패:`,
          error
        );
        errors.push({
          groupId,
          error:
            error instanceof Error
              ? error.message
              : "알 수 없는 오류가 발생했습니다.",
        });
      }
    }

    return {
      success: errors.length === 0,
      successCount,
      failureCount: errors.length,
      errors: errors.length > 0 ? errors : undefined,
    };
  }
);

/**
 * 다수 학생에게 플랜 그룹 일괄 생성
 */
export const bulkCreatePlanGroupsForCamp = withErrorHandling(
  async (
    templateId: string,
    invitationIds: string[]
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ invitationId: string; error: string }>;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    // 템플릿 존재 및 권한 확인
    const template = await getCampTemplate(templateId);
    if (!template) {
      throw new AppError(
        "템플릿을 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    if (template.tenant_id !== tenantContext.tenantId) {
      throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
    }

    const supabase = await createSupabaseServerClient();
    const errors: Array<{ invitationId: string; error: string }> = [];
    let successCount = 0;

    // 템플릿 데이터 준비
    const templateData = template.template_data as Partial<WizardData>;

    // 연결 테이블에서 템플릿에 연결된 블록 세트 조회
    let templateBlockSetId: string | null = null;
    const { data: templateBlockSetLink } = await supabase
      .from("camp_template_block_sets")
      .select("tenant_block_set_id")
      .eq("camp_template_id", template.id)
      .maybeSingle();

    if (templateBlockSetLink) {
      templateBlockSetId = templateBlockSetLink.tenant_block_set_id;
    } else if (templateData.block_set_id) {
      templateBlockSetId = templateData.block_set_id;
    }

    // 템플릿 제외일과 학원 일정에 source, is_locked 필드 추가
    const templateExclusions = (templateData.exclusions || []).map((exclusion: any) => ({
      ...exclusion,
      source: "template" as const,
      is_locked: true,
    }));

    const templateAcademySchedules = (templateData.academy_schedules || []).map((schedule: any) => ({
      ...schedule,
      source: "template" as const,
      is_locked: true,
    }));

    // 각 초대에 대해 플랜 그룹 생성
    for (const invitationId of invitationIds) {
      try {
        // 초대 정보 조회
        const { data: invitation, error: invitationError } = await supabase
          .from("camp_invitations")
          .select("id, student_id, camp_template_id, status")
          .eq("id", invitationId)
          .maybeSingle();

        if (invitationError || !invitation) {
          errors.push({
            invitationId,
            error: invitationError?.message || "초대를 찾을 수 없습니다.",
          });
          continue;
        }

        // 이미 플랜 그룹이 있는지 확인
        const { data: existingGroup } = await supabase
          .from("plan_groups")
          .select("id")
          .eq("camp_invitation_id", invitationId)
          .is("deleted_at", null)
          .maybeSingle();

        if (existingGroup) {
          // 이미 플랜 그룹이 있으면 스킵
          continue;
        }

        // 템플릿 기본값으로 병합된 데이터 생성
        const mergedData: Partial<WizardData> = {
          ...templateData,
          name: templateData.name || "",
          plan_purpose: templateData.plan_purpose || "",
          scheduler_type: templateData.scheduler_type || "1730_timetable",
          period_start: templateData.period_start || "",
          period_end: templateData.period_end || "",
          block_set_id: templateBlockSetId || "",
          academy_schedules: templateAcademySchedules,
          student_contents: [],
          recommended_contents: [],
          exclusions: templateExclusions,
          subject_allocations: undefined,
          student_level: templateData.student_level || undefined,
          time_settings: templateData.time_settings,
          scheduler_options: templateData.scheduler_options,
          study_review_cycle: templateData.study_review_cycle,
        };

        // 플랜 그룹 생성 데이터 변환
        const { syncWizardDataToCreationData } = await import(
          "@/lib/utils/planGroupDataSync"
        );
        const creationData = syncWizardDataToCreationData(mergedData as WizardData);

        // 플랜 그룹 생성
        const { createPlanGroup } = await import("@/lib/data/planGroups");
        const groupResult = await createPlanGroup({
          tenant_id: tenantContext.tenantId,
          student_id: invitation.student_id,
          name: creationData.name || null,
          plan_purpose: creationData.plan_purpose || null,
          scheduler_type: creationData.scheduler_type,
          scheduler_options: creationData.scheduler_options || null,
          period_start: creationData.period_start,
          period_end: creationData.period_end,
          target_date: creationData.target_date || null,
          block_set_id: creationData.block_set_id || null,
          status: "draft",
          subject_constraints: creationData.subject_constraints || null,
          additional_period_reallocation: creationData.additional_period_reallocation || null,
          non_study_time_blocks: creationData.non_study_time_blocks || null,
          daily_schedule: creationData.daily_schedule || null,
          plan_type: "camp",
          camp_template_id: templateId,
          camp_invitation_id: invitationId,
        });

        if (!groupResult.success || !groupResult.groupId) {
          errors.push({
            invitationId,
            error: groupResult.error || "플랜 그룹 생성에 실패했습니다.",
          });
          continue;
        }

        const groupId = groupResult.groupId;

        // 제외일 생성
        if (creationData.exclusions && creationData.exclusions.length > 0) {
          const { createPlanExclusions } = await import("@/lib/data/planGroups");
          await createPlanExclusions(
            groupId,
            tenantContext.tenantId,
            creationData.exclusions.map((e) => ({
              exclusion_date: e.exclusion_date,
              exclusion_type: e.exclusion_type,
              reason: e.reason || null,
            }))
          );
        }

        // 학원 일정 생성
        if (creationData.academy_schedules && creationData.academy_schedules.length > 0) {
          const { createStudentAcademySchedules } = await import("@/lib/data/planGroups");
          await createStudentAcademySchedules(
            invitation.student_id,
            tenantContext.tenantId,
            creationData.academy_schedules.map((s) => ({
              day_of_week: s.day_of_week,
              start_time: s.start_time,
              end_time: s.end_time,
              academy_name: s.academy_name || null,
              subject: s.subject || null,
            })),
            true // 관리자 모드: Admin 클라이언트 사용
          );
        }

        successCount++;
      } catch (error) {
        console.error(
          `[bulkCreatePlanGroupsForCamp] 초대 ${invitationId} 처리 실패:`,
          error
        );
        errors.push({
          invitationId,
          error:
            error instanceof Error
              ? error.message
              : "알 수 없는 오류가 발생했습니다.",
        });
      }
    }

    return {
      success: errors.length === 0,
      successCount,
      failureCount: errors.length,
      errors: errors.length > 0 ? errors : undefined,
    };
  }
);

/**
 * 플랜 그룹 콘텐츠 범위 일괄 조절
 */
export const bulkAdjustPlanRanges = withErrorHandling(
  async (
    groupIds: string[],
    rangeAdjustments: Record<string, Array<{
      contentId: string;
      contentType: "book" | "lecture";
      startRange?: number;
      endRange?: number;
    }>>
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ groupId: string; error: string }>;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();
    const errors: Array<{ groupId: string; error: string }> = [];
    let successCount = 0;

    for (const groupId of groupIds) {
      try {
        // 플랜 그룹 존재 및 권한 확인
        const { data: group, error: groupError } = await supabase
          .from("plan_groups")
          .select("id, tenant_id")
          .eq("id", groupId)
          .eq("tenant_id", tenantContext.tenantId)
          .maybeSingle();

        if (groupError || !group) {
          errors.push({
            groupId,
            error: groupError?.message || "플랜 그룹을 찾을 수 없습니다.",
          });
          continue;
        }

        // 해당 그룹의 범위 조절 정보 조회
        const adjustments = rangeAdjustments[groupId];
        if (!adjustments || adjustments.length === 0) {
          // 조절할 내용이 없으면 스킵
          successCount++;
          continue;
        }

        // 각 콘텐츠의 범위 업데이트
        for (const adjustment of adjustments) {
          const updateData: {
            start_range?: number;
            end_range?: number;
            updated_at: string;
          } = {
            updated_at: new Date().toISOString(),
          };

          if (adjustment.startRange !== undefined) {
            updateData.start_range = adjustment.startRange;
          }
          if (adjustment.endRange !== undefined) {
            updateData.end_range = adjustment.endRange;
          }

          // 범위 유효성 검증
          if (
            updateData.start_range !== undefined &&
            updateData.end_range !== undefined &&
            updateData.start_range >= updateData.end_range
          ) {
            errors.push({
              groupId,
              error: `콘텐츠 ${adjustment.contentId}의 범위가 유효하지 않습니다 (시작 >= 종료).`,
            });
            continue;
          }

          const { error: updateError } = await supabase
            .from("plan_contents")
            .update(updateData)
            .eq("plan_group_id", groupId)
            .eq("content_id", adjustment.contentId)
            .eq("content_type", adjustment.contentType);

          if (updateError) {
            console.error(
              `[bulkAdjustPlanRanges] 콘텐츠 범위 업데이트 실패:`,
              {
                groupId,
                contentId: adjustment.contentId,
                error: updateError.message,
              }
            );
            errors.push({
              groupId,
              error: `콘텐츠 ${adjustment.contentId} 범위 업데이트 실패: ${updateError.message}`,
            });
          }
        }

        // 에러가 없으면 성공으로 카운트
        if (!errors.some((e) => e.groupId === groupId)) {
          successCount++;
        }
      } catch (error) {
        console.error(
          `[bulkAdjustPlanRanges] 그룹 ${groupId} 처리 실패:`,
          error
        );
        errors.push({
          groupId,
          error:
            error instanceof Error
              ? error.message
              : "알 수 없는 오류가 발생했습니다.",
        });
      }
    }

    return {
      success: errors.length === 0,
      successCount,
      failureCount: errors.length,
      errors: errors.length > 0 ? errors : undefined,
    };
  }
);

/**
 * 플랜 그룹 콘텐츠 및 스케줄 정보 조회 (클라이언트 컴포넌트용)
 */
export const getPlanGroupContentsForRangeAdjustment = withErrorHandling(
  async (
    groupId: string
  ): Promise<{
    success: boolean;
    contents?: Array<{
      contentId: string;
      contentType: "book" | "lecture";
      title: string;
      totalAmount: number;
      currentStartRange: number;
      currentEndRange: number;
    }>;
    scheduleSummary?: {
      total_study_days: number;
      total_study_hours: number;
    } | null;
    recommendedRanges?: Record<string, { start: number; end: number; reason: string }>;
    unavailableReasons?: Record<string, string>;
    error?: string;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();
    const adminSupabase = await createSupabaseAdminClient();

    if (!adminSupabase) {
      return {
        success: false,
        error: "Admin 클라이언트를 생성할 수 없습니다.",
      };
    }

    try {
      // 플랜 그룹 정보 조회 (period_start, period_end, daily_schedule 포함)
      const { data: group, error: groupError } = await supabase
        .from("plan_groups")
        .select("id, period_start, period_end, daily_schedule")
        .eq("id", groupId)
        .eq("tenant_id", tenantContext.tenantId)
        .maybeSingle();

      if (groupError || !group) {
        return {
          success: false,
          error: groupError?.message || "플랜 그룹을 찾을 수 없습니다.",
        };
      }

      // 콘텐츠 조회
      const contents = await getPlanContents(groupId, tenantContext.tenantId);

      // 콘텐츠 상세 정보 조회 (총량 정보 포함)
      // Admin 클라이언트를 사용하여 RLS 정책 우회
      const contentInfos: Array<{
        contentId: string;
        contentType: "book" | "lecture";
        title: string;
        totalAmount: number;
        currentStartRange: number;
        currentEndRange: number;
      }> = [];

      for (const content of contents) {
        // custom 콘텐츠는 범위 조절 대상이 아니므로 제외
        if (content.content_type === "custom") {
          continue;
        }

        try {
          let totalAmount = 0;
          let title = "알 수 없음";

          if (content.content_type === "book") {
            // Admin 클라이언트를 사용하여 학생 교재 조회 (RLS 우회)
            const { data: book } = await adminSupabase
              .from("books")
              .select("title, master_content_id")
              .eq("id", content.content_id)
              .maybeSingle();

            if (book) {
              title = book.title || "알 수 없음";

              // 마스터 콘텐츠 정보 조회
              if (book.master_content_id) {
                try {
                  const { book: masterBook } = await getMasterBookById(book.master_content_id);
                  if (masterBook) {
                    totalAmount = masterBook.total_pages || 0;
                  } else {
                    // 마스터 교재 조회 실패 시 Admin 클라이언트로 직접 조회 시도
                    const { data: bookInfo } = await adminSupabase
                      .from("master_books")
                      .select("total_pages")
                      .eq("id", book.master_content_id)
                      .maybeSingle();
                    totalAmount = bookInfo?.total_pages || 0;
                  }
                } catch (error) {
                  console.error(`마스터 교재 ${book.master_content_id} 조회 실패:`, error);
                  // 마스터 교재 조회 실패 시 Admin 클라이언트로 직접 조회 시도
                  const { data: bookInfo } = await adminSupabase
                    .from("master_books")
                    .select("total_pages")
                    .eq("id", book.master_content_id)
                    .maybeSingle();
                  totalAmount = bookInfo?.total_pages || 0;
                }
              } else {
                // 마스터 콘텐츠 ID가 없으면 직접 조회 시도
                const { data: bookInfo } = await adminSupabase
                  .from("master_books")
                  .select("total_pages")
                  .eq("id", content.content_id)
                  .maybeSingle();
                totalAmount = bookInfo?.total_pages || 0;
              }
            }
          } else if (content.content_type === "lecture") {
            // Admin 클라이언트를 사용하여 학생 강의 조회 (RLS 우회)
            const { data: lecture } = await adminSupabase
              .from("lectures")
              .select("title, master_content_id")
              .eq("id", content.content_id)
              .maybeSingle();

            if (lecture) {
              title = lecture.title || "알 수 없음";

              // 마스터 콘텐츠 정보 조회
              if (lecture.master_content_id) {
                try {
                  const { lecture: masterLecture } = await getMasterLectureById(lecture.master_content_id);
                  if (masterLecture) {
                    totalAmount = masterLecture.total_episodes || 0;
                  } else {
                    // 마스터 강의 조회 실패 시 Admin 클라이언트로 직접 조회 시도
                    const { data: lectureInfo } = await adminSupabase
                      .from("master_lectures")
                      .select("total_episodes")
                      .eq("id", lecture.master_content_id)
                      .maybeSingle();
                    totalAmount = lectureInfo?.total_episodes || 0;
                  }
                } catch (error) {
                  console.error(`마스터 강의 ${lecture.master_content_id} 조회 실패:`, error);
                  // 마스터 강의 조회 실패 시 Admin 클라이언트로 직접 조회 시도
                  const { data: lectureInfo } = await adminSupabase
                    .from("master_lectures")
                    .select("total_episodes")
                    .eq("id", lecture.master_content_id)
                    .maybeSingle();
                  totalAmount = lectureInfo?.total_episodes || 0;
                }
              } else {
                // 마스터 콘텐츠 ID가 없으면 직접 조회 시도
                const { data: lectureInfo } = await adminSupabase
                  .from("master_lectures")
                  .select("total_episodes")
                  .eq("id", content.content_id)
                  .maybeSingle();
                totalAmount = lectureInfo?.total_episodes || 0;
              }
            }
          }

          contentInfos.push({
            contentId: content.content_id,
            contentType: content.content_type,
            title,
            totalAmount,
            currentStartRange: content.start_range,
            currentEndRange: content.end_range,
          });
        } catch (error) {
          console.error(`콘텐츠 ${content.content_id} 정보 조회 실패:`, error);
        }
      }

      // 스케줄 요약 정보 계산
      let scheduleSummary: {
        total_study_days: number;
        total_study_hours: number;
      } | null = null;
      
      if (group.period_start && group.period_end) {
        let totalStudyDays = 0;
        let totalHours = 0;
        
        // daily_schedule이 있으면 그것을 기반으로 계산
        if (group.daily_schedule && Array.isArray(group.daily_schedule)) {
          const dailySchedule = group.daily_schedule as any[];
          
          dailySchedule.forEach((day) => {
            // 학습일만 카운트
            if (day.day_type === "학습일" || day.day_type === "복습일") {
              totalStudyDays++;
            }
            
            // study_hours가 있으면 합산
            if (typeof day.study_hours === "number") {
              totalHours += day.study_hours;
            } else if (day.time_slots && Array.isArray(day.time_slots)) {
              // time_slots가 있으면 그것을 기반으로 계산
              day.time_slots.forEach((slot: any) => {
                if (slot.type === "학습시간" && slot.start && slot.end) {
                  try {
                    const startMinutes = timeToMinutes(slot.start);
                    const endMinutes = timeToMinutes(slot.end);
                    const hours = (endMinutes - startMinutes) / 60;
                    totalHours += hours;
                  } catch (error) {
                    // 시간 파싱 실패 시 무시
                  }
                }
              });
            }
          });
        }
        
        // daily_schedule이 없거나 비어있으면 기간 기반으로 기본값 계산
        if (totalStudyDays === 0 || totalHours === 0) {
          const startDate = new Date(group.period_start);
          const endDate = new Date(group.period_end);
          const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // 시작일과 종료일 포함
          
          totalStudyDays = diffDays;
          totalHours = diffDays * 3; // 기본값: 하루 3시간
        }
        
        scheduleSummary = {
          total_study_days: totalStudyDays,
          total_study_hours: totalHours,
        };
      }

      // 범위 추천 계산 (서버에서만 실행)
      let recommendedRanges: Map<string, { start: number; end: number; reason: string }> = new Map();
      let unavailableReasons: Map<string, string> = new Map();

      if (scheduleSummary && contentInfos.length > 0) {
        try {
          // 테넌트별 설정 조회
          const config = await getRangeRecommendationConfig(tenantContext.tenantId);
          
          const recommendationResult = await calculateRecommendedRanges(
            scheduleSummary,
            contentInfos.map((c) => ({
              content_id: c.contentId,
              content_type: c.contentType,
              total_amount: c.totalAmount,
            })),
            { config }
          );

          recommendedRanges = recommendationResult.ranges;
          unavailableReasons = recommendationResult.unavailableReasons;
        } catch (error) {
          console.error("[getPlanGroupContentsForRangeAdjustment] 범위 추천 계산 실패:", error);
          // 범위 추천 실패해도 기본 정보는 반환
        }
      }

      return {
        success: true,
        contents: contentInfos,
        scheduleSummary,
        recommendedRanges: Object.fromEntries(recommendedRanges),
        unavailableReasons: Object.fromEntries(unavailableReasons),
      };
    } catch (error) {
      console.error(`[getPlanGroupContentsForRangeAdjustment] 그룹 ${groupId} 처리 실패:`, error);
      return {
        success: false,
        error: error instanceof Error ? error.message : "알 수 없는 오류가 발생했습니다.",
      };
    }
  }
);

/**
 * 플랜 일괄 미리보기
 */
export const bulkPreviewPlans = withErrorHandling(
  async (
    groupIds: string[]
  ): Promise<{
    success: boolean;
    previews: Array<{
      groupId: string;
      studentName: string;
      planCount: number;
      previewData?: Array<any>;
      error?: string;
    }>;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();
    const { previewPlansFromGroupAction } = await import(
      "@/app/(student)/actions/planGroupActions"
    );

    const previews: Array<{
      groupId: string;
      studentName: string;
      planCount: number;
      previewData?: Array<any>;
      error?: string;
    }> = [];

    for (const groupId of groupIds) {
      try {
        // 플랜 그룹 및 학생 정보 조회
        const { data: group, error: groupError } = await supabase
          .from("plan_groups")
          .select("id, student_id, tenant_id, students:student_id(name)")
          .eq("id", groupId)
          .eq("tenant_id", tenantContext.tenantId)
          .maybeSingle();

        if (groupError || !group) {
          previews.push({
            groupId,
            studentName: "알 수 없음",
            planCount: 0,
            error: groupError?.message || "플랜 그룹을 찾을 수 없습니다.",
          });
          continue;
        }

        const studentName = (group.students as any)?.name || "알 수 없음";

        // 플랜 미리보기 실행
        try {
          const result = await previewPlansFromGroupAction(groupId);
          previews.push({
            groupId,
            studentName,
            planCount: result.plans.length,
            previewData: result.plans,
          });
        } catch (previewError) {
          previews.push({
            groupId,
            studentName,
            planCount: 0,
            error:
              previewError instanceof Error
                ? previewError.message
                : "플랜 미리보기에 실패했습니다.",
          });
        }
      } catch (error) {
        console.error(
          `[bulkPreviewPlans] 그룹 ${groupId} 처리 실패:`,
          error
        );
        previews.push({
          groupId,
          studentName: "알 수 없음",
          planCount: 0,
          error:
            error instanceof Error
              ? error.message
              : "알 수 없는 오류가 발생했습니다.",
        });
      }
    }

    return {
      success: true,
      previews,
    };
  }
);

/**
 * 플랜 일괄 생성
 */
export const bulkGeneratePlans = withErrorHandling(
  async (
    groupIds: string[]
  ): Promise<{
    success: boolean;
    successCount: number;
    failureCount: number;
    errors?: Array<{ groupId: string; error: string }>;
  }> => {
    await requireAdminOrConsultant();

    const tenantContext = await getTenantContext();
    if (!tenantContext?.tenantId) {
      throw new AppError(
        "기관 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();
    const { generatePlansFromGroupAction } = await import(
      "@/app/(student)/actions/planGroupActions"
    );

    const errors: Array<{ groupId: string; error: string }> = [];
    let successCount = 0;

    for (const groupId of groupIds) {
      try {
        // 플랜 그룹 존재 및 권한 확인
        const { data: group, error: groupError } = await supabase
          .from("plan_groups")
          .select("id, tenant_id")
          .eq("id", groupId)
          .eq("tenant_id", tenantContext.tenantId)
          .maybeSingle();

        if (groupError || !group) {
          errors.push({
            groupId,
            error: groupError?.message || "플랜 그룹을 찾을 수 없습니다.",
          });
          continue;
        }

        // 플랜 생성 실행
        try {
          await generatePlansFromGroupAction(groupId);
          successCount++;
        } catch (generateError) {
          console.error(
            `[bulkGeneratePlans] 그룹 ${groupId} 플랜 생성 실패:`,
            generateError
          );
          errors.push({
            groupId,
            error:
              generateError instanceof Error
                ? generateError.message
                : "플랜 생성에 실패했습니다.",
          });
        }
      } catch (error) {
        console.error(
          `[bulkGeneratePlans] 그룹 ${groupId} 처리 실패:`,
          error
        );
        errors.push({
          groupId,
          error:
            error instanceof Error
              ? error.message
              : "알 수 없는 오류가 발생했습니다.",
        });
      }
    }

    return {
      success: errors.length === 0,
      successCount,
      failureCount: errors.length,
      errors: errors.length > 0 ? errors : undefined,
    };
  }
);
</file>

<file path="actions/campTemplateBlockSets.ts">
"use server";

import { revalidatePath } from "next/cache";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";
import { requireAdminOrConsultant } from "@/lib/auth/guards";

/**
 * 템플릿에 블록 세트 연결 (기존 연결이 있으면 업데이트)
 */
async function _linkBlockSetToTemplate(
  templateId: string,
  blockSetId: string
): Promise<void> {
  await requireAdminOrConsultant();

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  // 템플릿 존재 및 권한 확인
  const { data: template } = await supabase
    .from("camp_templates")
    .select("id, tenant_id")
    .eq("id", templateId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!template) {
    throw new AppError("템플릿을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("tenant_block_sets")
    .select("id")
    .eq("id", blockSetId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // UPSERT: 기존 연결이 있으면 업데이트, 없으면 생성
  const { error } = await supabase
    .from("camp_template_block_sets")
    .upsert(
      {
        camp_template_id: templateId,
        tenant_block_set_id: blockSetId,
      },
      {
        onConflict: "camp_template_id",
      }
    );

  if (error) {
    throw new AppError(
      "블록 세트 연결에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath(`/admin/camp-templates/${templateId}/edit`);
  revalidatePath(`/admin/camp-templates/${templateId}`);
}

/**
 * 템플릿에서 블록 세트 연결 해제
 */
async function _unlinkBlockSetFromTemplate(templateId: string): Promise<void> {
  await requireAdminOrConsultant();

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  // 템플릿 존재 및 권한 확인
  const { data: template } = await supabase
    .from("camp_templates")
    .select("id, tenant_id")
    .eq("id", templateId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!template) {
    throw new AppError("템플릿을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 연결 해제
  const { error } = await supabase
    .from("camp_template_block_sets")
    .delete()
    .eq("camp_template_id", templateId);

  if (error) {
    throw new AppError(
      "블록 세트 연결 해제에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath(`/admin/camp-templates/${templateId}/edit`);
  revalidatePath(`/admin/camp-templates/${templateId}`);
}

/**
 * 특정 템플릿에 연결된 블록 세트 조회 (1개만 반환)
 */
async function _getTemplateBlockSet(templateId: string): Promise<{
  id: string;
  name: string;
  blocks: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
} | null> {
  await requireAdminOrConsultant();

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  // 템플릿 존재 및 권한 확인
  const { data: template } = await supabase
    .from("camp_templates")
    .select("id, tenant_id")
    .eq("id", templateId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!template) {
    throw new AppError("템플릿을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 연결된 블록 세트 조회
  const { data: link, error: linkError } = await supabase
    .from("camp_template_block_sets")
    .select("tenant_block_set_id")
    .eq("camp_template_id", templateId)
    .maybeSingle();

  if (linkError) {
    throw new AppError(
      "블록 세트 연결 정보를 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: linkError.message }
    );
  }

  if (!link) {
    return null;
  }

  // 블록 세트 정보 조회
  const { data: blockSet, error: blockSetError } = await supabase
    .from("tenant_block_sets")
    .select("id, name")
    .eq("id", link.tenant_block_set_id)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (blockSetError || !blockSet) {
    return null;
  }

  // 블록 조회
  const { data: blocks, error: blocksError } = await supabase
    .from("tenant_blocks")
    .select("id, day_of_week, start_time, end_time")
    .eq("tenant_block_set_id", blockSet.id)
    .order("day_of_week", { ascending: true })
    .order("start_time", { ascending: true });

  if (blocksError) {
    console.error(`[campTemplateBlockSets] 블록 조회 실패 (세트 ${blockSet.id}):`, blocksError);
    return {
      id: blockSet.id,
      name: blockSet.name,
      blocks: [],
    };
  }

  return {
    id: blockSet.id,
    name: blockSet.name,
    blocks:
      (blocks as Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>) ?? [],
  };
}

/**
 * 특정 블록 세트를 사용하는 템플릿 목록 조회 (1:N 관계에서 N 방향)
 */
async function _getBlockSetTemplates(blockSetId: string): Promise<
  Array<{
    id: string;
    name: string;
    program_type: string;
  }>
> {
  await requireAdminOrConsultant();

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("tenant_block_sets")
    .select("id")
    .eq("id", blockSetId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 연결된 템플릿 조회
  const { data: links, error: linksError } = await supabase
    .from("camp_template_block_sets")
    .select("camp_template_id")
    .eq("tenant_block_set_id", blockSetId);

  if (linksError) {
    throw new AppError(
      "템플릿 연결 정보를 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: linksError.message }
    );
  }

  if (!links || links.length === 0) {
    return [];
  }

  // 템플릿 정보 조회
  const templateIds = links.map((link) => link.camp_template_id);
  const { data: templates, error: templatesError } = await supabase
    .from("camp_templates")
    .select("id, name, program_type")
    .in("id", templateIds)
    .eq("tenant_id", tenantContext.tenantId);

  if (templatesError) {
    throw new AppError(
      "템플릿 정보를 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: templatesError.message }
    );
  }

  return (
    templates?.map((t) => ({
      id: t.id,
      name: t.name,
      program_type: t.program_type,
    })) ?? []
  );
}

// 에러 핸들링 래퍼 적용
export const linkBlockSetToTemplate = withErrorHandling(_linkBlockSetToTemplate);
export const unlinkBlockSetFromTemplate = withErrorHandling(_unlinkBlockSetFromTemplate);
export const getTemplateBlockSet = withErrorHandling(_getTemplateBlockSet);
export const getBlockSetTemplates = withErrorHandling(_getBlockSetTemplates);
</file>

<file path="actions/careerFieldActions.ts">
"use server";

import { getCurrentUser } from "@/lib/auth/getCurrentUser";
import {
  getCareerFields,
  getAllCareerFields,
  createCareerField,
  updateCareerField,
  deleteCareerField,
} from "@/lib/data/careerFields";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";

// 진로 계열 목록 조회 (활성화된 항목만)
export const getCareerFieldsAction = withErrorHandling(async () => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await getCareerFields();
});

// 진로 계열 목록 조회 (모든 항목, 관리자용)
export const getAllCareerFieldsAction = withErrorHandling(async () => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await getAllCareerFields();
});

// 진로 계열 생성
export const createCareerFieldAction = withErrorHandling(
  async (name: string, display_order?: number) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    const result = await createCareerField(name, display_order);
    if (!result.success) {
      throw new AppError(
        result.error || "진로 계열 생성에 실패했습니다.",
        ErrorCode.INTERNAL_ERROR,
        500,
        true
      );
    }
    return result;
  }
);

// 진로 계열 수정
export const updateCareerFieldAction = withErrorHandling(
  async (
    id: string,
    updates: Partial<{ name: string; display_order: number; is_active: boolean }>
  ) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    const result = await updateCareerField(id, updates);
    if (!result.success) {
      throw new AppError(
        result.error || "진로 계열 수정에 실패했습니다.",
        ErrorCode.INTERNAL_ERROR,
        500,
        true
      );
    }
    return result;
  }
);

// 진로 계열 삭제
export const deleteCareerFieldAction = withErrorHandling(async (id: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  const result = await deleteCareerField(id);
  if (!result.success) {
    throw new AppError(
      result.error || "진로 계열 삭제에 실패했습니다.",
      ErrorCode.INTERNAL_ERROR,
      500,
      true
    );
  }
  return result;
});
</file>

<file path="actions/consultingNoteActions.ts">
"use server";

import { revalidatePath } from "next/cache";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUser } from "@/lib/auth/getCurrentUser";

export async function addConsultingNote(
  studentId: string,
  consultantId: string,
  formData: FormData
): Promise<{ success: boolean; error?: string } | null> {
  try {
    const user = await getCurrentUser();

    if (!user || (user.role !== "admin" && user.role !== "consultant")) {
      return { success: false, error: "권한이 없습니다." };
    }

    if (user.userId !== consultantId) {
      return { success: false, error: "잘못된 요청입니다." };
    }

    const note = String(formData.get("note") ?? "").trim();

    if (!note) {
      return { success: false, error: "상담 내용을 입력해주세요." };
    }

    const supabase = await createSupabaseServerClient();

    const { error } = await supabase.from("student_consulting_notes").insert({
      student_id: studentId,
      consultant_id: consultantId,
      note,
    });

    if (error) {
      console.error("[consultingNotes] 상담노트 저장 실패", error);
      return { success: false, error: error.message };
    }

    revalidatePath(`/admin/students/${studentId}`);
    return { success: true };
  } catch (error) {
    console.error("[consultingNotes] 상담노트 저장 실패", error);
    return { success: false, error: "상담노트 저장에 실패했습니다." };
  }
}

export async function deleteConsultingNote(
  noteId: string,
  studentId: string
): Promise<{ success: boolean; error?: string }> {
  try {
    const user = await getCurrentUser();

    if (!user || (user.role !== "admin" && user.role !== "consultant")) {
      return { success: false, error: "권한이 없습니다." };
    }

    const supabase = await createSupabaseServerClient();

    // 상담노트 조회 및 권한 확인
    const { data: note, error: fetchError } = await supabase
      .from("student_consulting_notes")
      .select("consultant_id")
      .eq("id", noteId)
      .eq("student_id", studentId)
      .maybeSingle();

    if (fetchError || !note) {
      return { success: false, error: "상담노트를 찾을 수 없습니다." };
    }

    // 본인이 작성한 노트만 삭제 가능 (또는 admin은 모든 노트 삭제 가능)
    if (user.role !== "admin" && note.consultant_id !== user.userId) {
      return { success: false, error: "권한이 없습니다." };
    }

    const { error } = await supabase
      .from("student_consulting_notes")
      .delete()
      .eq("id", noteId);

    if (error) {
      console.error("[consultingNotes] 상담노트 삭제 실패", error);
      return { success: false, error: error.message };
    }

    revalidatePath(`/admin/students/${studentId}`);
    return { success: true };
  } catch (error) {
    console.error("[consultingNotes] 상담노트 삭제 실패", error);
    return { success: false, error: "상담노트 삭제에 실패했습니다." };
  }
}
</file>

<file path="actions/contentMetadataActions.ts">
"use server";

import { getCurrentUser } from "@/lib/auth/getCurrentUser";
import {
  getCurriculumRevisions,
  createCurriculumRevision,
  updateCurriculumRevision,
  deleteCurriculumRevision,
  getSubjectCategories,
  createSubjectCategory,
  updateSubjectCategory,
  deleteSubjectCategory,
  getSubjects,
  createSubject,
  updateSubject,
  deleteSubject,
  getPlatforms,
  createPlatform,
  updatePlatform,
  deletePlatform,
  getPublishers,
  createPublisher,
  updatePublisher,
  deletePublisher,
} from "@/lib/data/contentMetadata";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";

// 개정교육과정
export const getCurriculumRevisionsAction = withErrorHandling(async () => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await getCurriculumRevisions();
});

export const createCurriculumRevisionAction = withErrorHandling(
  async (name: string, displayOrder?: number) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    // display_order가 제공되지 않으면 자동 계산
    let finalDisplayOrder = displayOrder;
    if (finalDisplayOrder === undefined) {
      const existingRevisions = await getCurriculumRevisions();
      finalDisplayOrder = existingRevisions.length > 0
        ? Math.max(...existingRevisions.map(r => r.display_order ?? 0)) + 1
        : 0;
    }
    return await createCurriculumRevision(name, finalDisplayOrder);
  }
);

export const updateCurriculumRevisionAction = withErrorHandling(
  async (
    id: string,
    updates: Partial<{ name: string; display_order: number; is_active: boolean }>
  ) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await updateCurriculumRevision(id, updates);
  }
);

export const deleteCurriculumRevisionAction = withErrorHandling(async (id: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await deleteCurriculumRevision(id);
});

// 교과 (Deprecated: getSubjectGroupsAction 사용 권장)
/**
 * @deprecated 이 함수는 더 이상 사용되지 않습니다. getSubjectGroupsAction을 사용하세요.
 */
export const getSubjectCategoriesAction = withErrorHandling(async (revisionId?: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  
  // subject_groups로 변환하여 반환 (하위 호환성)
  const { getSubjectGroupsAction } = await import("./subjectActions");
  const groups = await getSubjectGroupsAction(revisionId);
  
  // SubjectCategory 형태로 변환
  return groups.map((group) => ({
    id: group.id,
    name: group.name,
    display_order: (group as any).display_order ?? 0,
    is_active: true,
  }));
});

export const createSubjectCategoryAction = withErrorHandling(
  async (revision_id: string, name: string, display_order: number) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await createSubjectCategory(revision_id, name, display_order);
  }
);

export const updateSubjectCategoryAction = withErrorHandling(
  async (
    id: string,
    updates: Partial<{ name: string; display_order: number; is_active: boolean }>
  ) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await updateSubjectCategory(id, updates);
  }
);

export const deleteSubjectCategoryAction = withErrorHandling(async (id: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await deleteSubjectCategory(id);
});

// 과목 (Deprecated: getSubjectsByGroupAction 사용 권장)
/**
 * @deprecated 이 함수는 더 이상 사용되지 않습니다. getSubjectsByGroupAction을 사용하세요.
 */
export const getSubjectsAction = withErrorHandling(async (subjectCategoryId?: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  
  if (!subjectCategoryId) {
    return [];
  }

  // getSubjectsByGroupAction 사용
  const { getSubjectsByGroupAction } = await import("./subjectActions");
  const subjects = await getSubjectsByGroupAction(subjectCategoryId);
  
  // Subject 형태로 변환
  return subjects.map((subject) => ({
    id: subject.id,
    name: subject.name,
    subject_category_id: subject.subject_group_id,
    display_order: (subject as any).display_order ?? 0,
    is_active: true,
  }));
});

export const createSubjectAction = withErrorHandling(
  async (subject_category_id: string, name: string, display_order: number) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await createSubject(subject_category_id, name, display_order);
  }
);

export const updateSubjectAction = withErrorHandling(
  async (id: string, updates: Partial<{ name: string; display_order: number; is_active: boolean }>) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await updateSubject(id, updates);
  }
);

export const deleteSubjectAction = withErrorHandling(async (id: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await deleteSubject(id);
});

// 플랫폼
export const getPlatformsAction = withErrorHandling(async () => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await getPlatforms();
});

export const createPlatformAction = withErrorHandling(
  async (name: string, display_order: number) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await createPlatform(name, display_order);
  }
);

export const updatePlatformAction = withErrorHandling(
  async (id: string, updates: Partial<{ name: string; display_order: number; is_active: boolean }>) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await updatePlatform(id, updates);
  }
);

export const deletePlatformAction = withErrorHandling(async (id: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await deletePlatform(id);
});

// 출판사
export const getPublishersAction = withErrorHandling(async () => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await getPublishers();
});

export const createPublisherAction = withErrorHandling(
  async (name: string, display_order: number) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await createPublisher(name, display_order);
  }
);

export const updatePublisherAction = withErrorHandling(
  async (id: string, updates: Partial<{ name: string; display_order: number; is_active: boolean }>) => {
    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
    }
    return await updatePublisher(id, updates);
  }
);

export const deletePublisherAction = withErrorHandling(async (id: string) => {
  const user = await getCurrentUser();
  if (!user || user.role !== "admin") {
    throw new AppError("권한이 없습니다.", ErrorCode.UNAUTHORIZED, 401, true);
  }
  return await deletePublisher(id);
});
</file>

<file path="actions/masterCustomContentActions.ts">
"use server";

import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  createMasterCustomContent,
  updateMasterCustomContent,
  deleteMasterCustomContent,
} from "@/lib/data/contentMasters";
import { MasterCustomContent } from "@/lib/types/plan";

/**
 * 서비스 마스터 커스텀 콘텐츠 생성
 */
export async function addMasterCustomContent(formData: FormData) {
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    throw new Error("권한이 없습니다.");
  }

  const tenantContext = await getTenantContext();
  const supabase = await createSupabaseServerClient();

  // subject_id 처리 (빈 문자열 체크)
  const subjectIdRaw = formData.get("subject_id")?.toString();
  const subjectId = subjectIdRaw && subjectIdRaw.trim() !== "" ? subjectIdRaw.trim() : null;

  const contentData: Omit<MasterCustomContent, "id" | "created_at" | "updated_at"> = {
    tenant_id: tenantContext?.tenantId || null,
    revision: formData.get("revision")?.toString() || null,
    content_category: formData.get("content_category")?.toString() || null,
    title: formData.get("title")?.toString() || "",
    difficulty_level: formData.get("difficulty_level")?.toString() || null,
    notes: formData.get("notes")?.toString() || null,
    content_type: formData.get("content_type")?.toString() || null,
    total_page_or_time: formData.get("total_page_or_time") 
      ? parseInt(formData.get("total_page_or_time")!.toString()) 
      : null,
    subject: formData.get("subject")?.toString() || null,
    subject_category: formData.get("subject_category")?.toString() || null,
    curriculum_revision_id: formData.get("curriculum_revision_id")?.toString() || null,
    subject_id: subjectId,
    subject_group_id: formData.get("subject_group_id")?.toString() || null,
  };

  if (!contentData.title) {
    throw new Error("제목은 필수입니다.");
  }

  await createMasterCustomContent(contentData);

  redirect("/admin/master-custom-contents");
}

/**
 * 서비스 마스터 커스텀 콘텐츠 수정
 */
export async function updateMasterCustomContentAction(
  id: string,
  formData: FormData
) {
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    throw new Error("권한이 없습니다.");
  }

  // subject_id 처리 (빈 문자열 체크)
  const subjectIdRaw = formData.get("subject_id")?.toString();
  const subjectId = subjectIdRaw && subjectIdRaw.trim() !== "" ? subjectIdRaw.trim() : null;

  const updates: Partial<Omit<MasterCustomContent, "id" | "created_at" | "updated_at">> = {
    revision: formData.get("revision")?.toString() || null,
    content_category: formData.get("content_category")?.toString() || null,
    title: formData.get("title")?.toString() || "",
    difficulty_level: formData.get("difficulty_level")?.toString() || null,
    notes: formData.get("notes")?.toString() || null,
    content_type: formData.get("content_type")?.toString() || null,
    total_page_or_time: formData.get("total_page_or_time") 
      ? parseInt(formData.get("total_page_or_time")!.toString()) 
      : null,
    subject: formData.get("subject")?.toString() || null,
    subject_category: formData.get("subject_category")?.toString() || null,
    curriculum_revision_id: formData.get("curriculum_revision_id")?.toString() || null,
    subject_id: subjectId,
    subject_group_id: formData.get("subject_group_id")?.toString() || null,
  };

  if (!updates.title) {
    throw new Error("제목은 필수입니다.");
  }

  await updateMasterCustomContent(id, updates);

  revalidatePath("/admin/master-custom-contents");
  revalidatePath(`/admin/master-custom-contents/${id}`);
  redirect(`/admin/master-custom-contents/${id}`);
}

/**
 * 서비스 마스터 커스텀 콘텐츠 삭제
 */
export async function deleteMasterCustomContentAction(id: string) {
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    throw new Error("권한이 없습니다.");
  }

  await deleteMasterCustomContent(id);

  revalidatePath("/admin/master-custom-contents");
  redirect("/admin/master-custom-contents");
}
</file>

<file path="actions/parentStudentLinkActions.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";
import { PARENT_STUDENT_LINK_MESSAGES } from "@/lib/constants/parentStudentLinkMessages";

// 타입 정의
export type StudentParent = {
  linkId: string;
  parentId: string;
  parentName: string | null;
  parentEmail: string | null;
  relation: string;
};

export type SearchableParent = {
  id: string;
  name: string | null;
  email: string | null;
};

export type ParentRelation = "father" | "mother" | "guardian" | "other";

export type PendingLinkRequest = {
  id: string;
  studentId: string;
  studentName: string | null;
  studentGrade: string | null;
  studentClass: string | null;
  parentId: string;
  parentName: string | null;
  parentEmail: string | null;
  relation: string;
  created_at: string;
};

// Supabase 쿼리 결과 타입
type ParentStudentLinkRow = {
  id: string;
  parent_id: string;
  relation: string;
  parent_users: {
    id: string;
    name: string | null;
  } | {
    id: string;
    name: string | null;
  }[] | null;
};

type ParentStudentLinkWithStudentRow = {
  id: string;
  student_id: string;
  parent_id: string;
  relation: string;
  created_at: string;
  students: {
    id: string;
    name: string | null;
    grade: string | null;
    class: string | null;
  } | {
    id: string;
    name: string | null;
    grade: string | null;
    class: string | null;
  }[] | null;
  parent_users: {
    id: string;
    name: string | null;
  } | {
    id: string;
    name: string | null;
  }[] | null;
};

type SearchableParentRow = {
  id: string;
  name: string | null;
};

/**
 * 학생에 연결된 학부모 목록 조회
 */
export async function getStudentParents(
  studentId: string
): Promise<{ success: boolean; data?: StudentParent[]; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  const supabase = await createSupabaseServerClient();

  try {
    const selectLinks = () =>
      supabase
        .from("parent_student_links")
        .select(`
          id,
          relation,
          parent_id,
          parent_users:parent_id(
            id,
            name
          )
        `)
        .eq("student_id", studentId);

    let { data: links, error } = await selectLinks();

    // 컬럼 없음 에러 처리 (42703)
    if (error && error.code === "42703") {
      ({ data: links, error } = await selectLinks());
    }

    if (error) {
      console.error("[admin/parentStudentLink] 학부모 목록 조회 실패", error);
      return {
        success: false,
        error: error.message || "학부모 목록을 조회할 수 없습니다.",
      };
    }

    if (!links) {
      return { success: true, data: [] };
    }

    // 데이터 변환
    const parents: StudentParent[] = links
      .map((link: ParentStudentLinkRow): StudentParent | null => {
        const parentUser = Array.isArray(link.parent_users) ? link.parent_users[0] : link.parent_users;
        if (!parentUser) return null;

        return {
          linkId: link.id,
          parentId: link.parent_id,
          parentName: parentUser.name,
          parentEmail: null,
          relation: link.relation || "other",
        };
      })
      .filter((p): p is StudentParent => p !== null);

    return { success: true, data: parents };
  } catch (error) {
    console.error("[admin/parentStudentLink] 학부모 목록 조회 중 오류", error);
    return {
      success: false,
      error: "학부모 목록을 조회하는 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 학부모 검색 (이름 또는 이메일)
 */
export async function searchParents(
  query: string,
  tenantId?: string
): Promise<{ success: boolean; data?: SearchableParent[]; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  // 최소 2글자 이상 검색
  if (!query || query.trim().length < 2) {
    return { success: true, data: [] };
  }

  const supabase = await createSupabaseServerClient();

  try {
    const searchQuery = query.trim();

    // parent_users에서 직접 검색 (name만 사용, email은 auth.users에 있어 조회 불가)
    const selectParents = () =>
      supabase
        .from("parent_users")
        .select(`
          id,
          name
        `)
        .ilike("name", `%${searchQuery}%`)
        .limit(10);

    // tenant_id 필터 추가 (있는 경우)
    let queryBuilder = selectParents();
    if (tenantId) {
      queryBuilder = queryBuilder.eq("tenant_id", tenantId);
    }

    let { data: parents, error } = await queryBuilder;

    // 컬럼 없음 에러 처리 (42703)
    if (error && error.code === "42703") {
      ({ data: parents, error } = await queryBuilder);
    }

    if (error) {
      console.error("[admin/parentStudentLink] 학부모 검색 실패", error);
      return {
        success: false,
        error: error.message || "학부모 검색에 실패했습니다.",
      };
    }

    if (!parents) {
      return { success: true, data: [] };
    }

    // 데이터 변환
    const searchResults: SearchableParent[] = parents
      .map((parent: SearchableParentRow): SearchableParent | null => {
        if (!parent.name) return null;

        return {
          id: parent.id,
          name: parent.name,
          email: null,
        };
      })
      .filter((p): p is SearchableParent => p !== null);

    return { success: true, data: searchResults };
  } catch (error) {
    console.error("[admin/parentStudentLink] 학부모 검색 중 오류", error);
    return {
      success: false,
      error: "학부모 검색 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 학생-학부모 연결 생성
 */
export async function createParentStudentLink(
  studentId: string,
  parentId: string,
  relation: ParentRelation
): Promise<{ success: boolean; linkId?: string; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  // relation 값 검증
  const validRelations: ParentRelation[] = ["father", "mother", "guardian", "other"];
  if (!validRelations.includes(relation)) {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.INVALID_RELATION };
  }

  const supabase = await createSupabaseServerClient();

  try {
    // 중복 체크
    const { data: existing, error: checkError } = await supabase
      .from("parent_student_links")
      .select("id")
      .eq("student_id", studentId)
      .eq("parent_id", parentId)
      .maybeSingle();

    if (checkError && checkError.code !== "PGRST116") {
      console.error("[admin/parentStudentLink] 중복 체크 실패", checkError);
      return {
        success: false,
        error: "연결 확인 중 오류가 발생했습니다.",
      };
    }

    if (existing) {
      return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.LINK_ALREADY_EXISTS };
    }

    // 연결 생성
    const { data, error } = await supabase
      .from("parent_student_links")
      .insert({
        student_id: studentId,
        parent_id: parentId,
        relation: relation,
      })
      .select("id")
      .single();

    if (error) {
      // UNIQUE 제약조건 에러 처리
      if (error.code === "23505") {
        return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.LINK_ALREADY_EXISTS };
      }

      console.error("[admin/parentStudentLink] 연결 생성 실패", error);
      return {
        success: false,
        error: error.message || "연결 생성에 실패했습니다.",
      };
    }

    revalidatePath("/admin/students");
    revalidatePath(`/admin/students/${studentId}`);

    return { success: true, linkId: data.id };
  } catch (error) {
    console.error("[admin/parentStudentLink] 연결 생성 중 오류", error);
    return {
      success: false,
      error: "연결 생성 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 학생-학부모 연결 삭제
 */
export async function deleteParentStudentLink(
  linkId: string
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  const supabase = await createSupabaseServerClient();

  try {
    // 먼저 student_id를 조회하여 revalidatePath에 사용
    const { data: link, error: fetchError } = await supabase
      .from("parent_student_links")
      .select("student_id")
      .eq("id", linkId)
      .maybeSingle();

    if (fetchError) {
      console.error("[admin/parentStudentLink] 연결 조회 실패", fetchError);
      return {
        success: false,
        error: "연결 정보를 찾을 수 없습니다.",
      };
    }

    if (!link) {
      return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.LINK_NOT_FOUND };
    }

    const studentId = link.student_id;

    // 연결 삭제
    const { error } = await supabase
      .from("parent_student_links")
      .delete()
      .eq("id", linkId);

    if (error) {
      console.error("[admin/parentStudentLink] 연결 삭제 실패", error);
      return {
        success: false,
        error: error.message || "연결 삭제에 실패했습니다.",
      };
    }

    revalidatePath("/admin/students");
    revalidatePath(`/admin/students/${studentId}`);

    return { success: true };
  } catch (error) {
    console.error("[admin/parentStudentLink] 연결 삭제 중 오류", error);
    return {
      success: false,
      error: "연결 삭제 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 연결의 관계 수정
 */
export async function updateLinkRelation(
  linkId: string,
  relation: ParentRelation
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  // relation 값 검증
  const validRelations: ParentRelation[] = ["father", "mother", "guardian", "other"];
  if (!validRelations.includes(relation)) {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.INVALID_RELATION };
  }

  const supabase = await createSupabaseServerClient();

  try {
    // 먼저 student_id를 조회하여 revalidatePath에 사용
    const { data: link, error: fetchError } = await supabase
      .from("parent_student_links")
      .select("student_id")
      .eq("id", linkId)
      .maybeSingle();

    if (fetchError) {
      console.error("[admin/parentStudentLink] 연결 조회 실패", fetchError);
      return {
        success: false,
        error: "연결 정보를 찾을 수 없습니다.",
      };
    }

    if (!link) {
      return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.LINK_NOT_FOUND };
    }

    const studentId = link.student_id;

    // 관계 수정
    const { error } = await supabase
      .from("parent_student_links")
      .update({ relation })
      .eq("id", linkId);

    if (error) {
      console.error("[admin/parentStudentLink] 관계 수정 실패", error);
      return {
        success: false,
        error: error.message || "관계 수정에 실패했습니다.",
      };
    }

    revalidatePath("/admin/students");
    revalidatePath(`/admin/students/${studentId}`);

    return { success: true };
  } catch (error) {
    console.error("[admin/parentStudentLink] 관계 수정 중 오류", error);
    return {
      success: false,
      error: "관계 수정 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 승인 대기 중인 연결 요청 목록 조회
 */
export async function getPendingLinkRequests(
  tenantId?: string
): Promise<{
  success: boolean;
  data?: PendingLinkRequest[];
  error?: string;
}> {
  const { role, tenantId: userTenantId } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  const supabase = await createSupabaseServerClient();
  const targetTenantId = tenantId || userTenantId;

  try {
    // 테넌트 필터링: 먼저 해당 테넌트의 학생 ID 목록 조회
    let studentIds: string[] | undefined;
    if (targetTenantId) {
      const { data: students, error: studentsError } = await supabase
        .from("students")
        .select("id")
        .eq("tenant_id", targetTenantId);

      if (studentsError) {
        console.error(
          "[admin/parentStudentLink] 학생 목록 조회 실패",
          studentsError
        );
        return {
          success: false,
          error: "학생 목록을 조회할 수 없습니다.",
        };
      }

      studentIds = students?.map((s) => s.id) || [];
      if (studentIds.length === 0) {
        // 해당 테넌트에 학생이 없으면 빈 배열 반환
        return { success: true, data: [] };
      }
    }

    const selectLinks = () => {
      let query = supabase
        .from("parent_student_links")
        .select(`
          id,
          student_id,
          parent_id,
          relation,
          created_at,
          students:student_id(
            id,
            name,
            grade,
            class
          ),
          parent_users:parent_id(
            id,
            name
          )
        `)
        .or("is_approved.is.null,is_approved.eq.false")
        .order("created_at", { ascending: false });

      // 테넌트 필터링: 학생 ID 목록으로 필터링
      if (studentIds && studentIds.length > 0) {
        query = query.in("student_id", studentIds);
      }

      return query;
    };

    let { data: links, error } = await selectLinks();

    // 컬럼 없음 에러 처리 (42703)
    if (error && error.code === "42703") {
      ({ data: links, error } = await selectLinks());
    }

    if (error) {
      console.error(
        "[admin/parentStudentLink] 승인 대기 요청 조회 실패",
        error
      );
      return {
        success: false,
        error: error.message || "승인 대기 요청을 조회할 수 없습니다.",
      };
    }

    if (!links) {
      return { success: true, data: [] };
    }

    // parent_users.id 목록 수집
    const parentIds = links
      .map((link) => {
        const parentUser = Array.isArray(link.parent_users) ? link.parent_users[0] : link.parent_users;
        return parentUser?.id;
      })
      .filter((id): id is string => id !== undefined);

    // auth.users에서 email 조회 (parent_users.id = auth.users.id)
    const parentEmailsMap = new Map<string, string | null>();
    if (parentIds.length > 0) {
      // Supabase Admin Client를 사용하여 auth.users 조회
      // 또는 각 parent_id에 대해 auth.admin.getUserById() 사용
      // 하지만 PostgREST를 통해 직접 조회할 수 없으므로,
      // 일단 email은 null로 처리하고, 필요시 별도 API로 조회
      // TODO: email 조회 로직 추가 필요 (auth.users는 PostgREST로 직접 조회 불가)
    }

    // 데이터 변환
    const requests: PendingLinkRequest[] = links
      .map((link: ParentStudentLinkWithStudentRow) => {
        const student = Array.isArray(link.students) ? link.students[0] : link.students;
        if (!student) return null;

        const parentUser = Array.isArray(link.parent_users) ? link.parent_users[0] : link.parent_users;
        if (!parentUser) return null;

        return {
          id: link.id,
          studentId: link.student_id,
          studentName: student.name,
          studentGrade: student.grade,
          studentClass: student.class,
          parentId: link.parent_id,
          parentName: parentUser.name,
          parentEmail: parentEmailsMap.get(parentUser.id) || null,
          relation: link.relation || "other",
          created_at: link.created_at,
        };
      })
      .filter((r): r is PendingLinkRequest => r !== null);

    return { success: true, data: requests };
  } catch (error) {
    console.error(
      "[admin/parentStudentLink] 승인 대기 요청 조회 중 오류",
      error
    );
    return {
      success: false,
      error: "승인 대기 요청 조회 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 연결 요청 승인
 */
export async function approveLinkRequest(
  linkId: string
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  const supabase = await createSupabaseServerClient();

  try {
    // 먼저 요청 존재 여부 확인
    const { data: link, error: fetchError } = await supabase
      .from("parent_student_links")
      .select("id, student_id, is_approved")
      .eq("id", linkId)
      .maybeSingle();

    if (fetchError) {
      console.error("[admin/parentStudentLink] 요청 조회 실패", fetchError);
      return {
        success: false,
        error: PARENT_STUDENT_LINK_MESSAGES.errors.FETCH_ERROR,
      };
    }

    if (!link) {
      return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.REQUEST_NOT_FOUND };
    }

    // 이미 승인된 경우
    if (link.is_approved === true) {
      return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.REQUEST_ALREADY_APPROVED };
    }

    // 승인 처리
    const { error } = await supabase
      .from("parent_student_links")
      .update({
        is_approved: true,
        approved_at: new Date().toISOString(),
      })
      .eq("id", linkId);

    if (error) {
      console.error("[admin/parentStudentLink] 요청 승인 실패", error);
      return {
        success: false,
        error: error.message || "요청 승인에 실패했습니다.",
      };
    }

    revalidatePath("/admin/parent-links");
    revalidatePath(`/admin/students/${link.student_id}`);

    return { success: true };
  } catch (error) {
    console.error("[admin/parentStudentLink] 요청 승인 중 오류", error);
    return {
      success: false,
      error: "요청 승인 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 연결 요청 거부 (삭제)
 */
export async function rejectLinkRequest(
  linkId: string
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.UNAUTHORIZED };
  }

  const supabase = await createSupabaseServerClient();

  try {
    // 먼저 요청 존재 여부 확인
    const { data: link, error: fetchError } = await supabase
      .from("parent_student_links")
      .select("id, student_id")
      .eq("id", linkId)
      .maybeSingle();

    if (fetchError) {
      console.error("[admin/parentStudentLink] 요청 조회 실패", fetchError);
      return {
        success: false,
        error: PARENT_STUDENT_LINK_MESSAGES.errors.FETCH_ERROR,
      };
    }

    if (!link) {
      return { success: false, error: PARENT_STUDENT_LINK_MESSAGES.errors.REQUEST_NOT_FOUND };
    }

    const studentId = link.student_id;

    // 요청 삭제 (거부)
    const { error } = await supabase
      .from("parent_student_links")
      .delete()
      .eq("id", linkId);

    if (error) {
      console.error("[admin/parentStudentLink] 요청 거부 실패", error);
      return {
        success: false,
        error: error.message || "요청 거부에 실패했습니다.",
      };
    }

    revalidatePath("/admin/parent-links");
    revalidatePath(`/admin/students/${studentId}`);

    return { success: true };
  } catch (error) {
    console.error("[admin/parentStudentLink] 요청 거부 중 오류", error);
    return {
      success: false,
      error: "요청 거부 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 여러 연결 요청을 한 번에 승인
 */
export async function approveLinkRequests(
  linkIds: string[]
): Promise<{
  success: boolean;
  approvedCount?: number;
  errors?: Array<{ linkId: string; error: string }>;
}> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, errors: [] };
  }

  if (!linkIds || linkIds.length === 0) {
    return { success: false, errors: [] };
  }

  const supabase = await createSupabaseServerClient();
  const errors: Array<{ linkId: string; error: string }> = [];
  let approvedCount = 0;
  const studentIds = new Set<string>();

  try {
    // 병렬 처리
    const updatePromises = linkIds.map(async (linkId) => {
      try {
        // 먼저 요청 존재 여부 확인
        const { data: link, error: fetchError } = await supabase
          .from("parent_student_links")
          .select("id, student_id, is_approved")
          .eq("id", linkId)
          .maybeSingle();

        if (fetchError || !link) {
          return {
            linkId,
            error: fetchError
              ? PARENT_STUDENT_LINK_MESSAGES.errors.FETCH_ERROR
              : PARENT_STUDENT_LINK_MESSAGES.errors.REQUEST_NOT_FOUND,
            link: null,
          };
        }

        // 이미 승인된 경우
        if (link.is_approved === true) {
          return {
            linkId,
            error: "이미 승인된 요청입니다.",
            link: null,
          };
        }

        // 승인 처리
        const { error } = await supabase
          .from("parent_student_links")
          .update({
            is_approved: true,
            approved_at: new Date().toISOString(),
          })
          .eq("id", linkId);

        if (error) {
          return {
            linkId,
            error: error.message || "요청 승인에 실패했습니다.",
            link: null,
          };
        }

        return { linkId, error: null, link };
      } catch (error) {
        console.error(
          `[admin/parentStudentLink] 요청 승인 중 오류 (linkId: ${linkId})`,
          error
        );
        return {
          linkId,
          error: "요청 승인 중 오류가 발생했습니다.",
          link: null,
        };
      }
    });

    const results = await Promise.all(updatePromises);

    // 결과 집계
    for (const result of results) {
      if (result.error) {
        errors.push({ linkId: result.linkId, error: result.error });
      } else if (result.link) {
        approvedCount++;
        studentIds.add(result.link.student_id);
      }
    }

    // 성공한 항목이 있으면 경로 재검증
    if (approvedCount > 0) {
      revalidatePath("/admin/parent-links");
      for (const studentId of studentIds) {
        revalidatePath(`/admin/students/${studentId}`);
      }
    }

    return {
      success: errors.length === 0,
      approvedCount,
      errors: errors.length > 0 ? errors : undefined,
    };
  } catch (error) {
    console.error("[admin/parentStudentLink] 일괄 승인 중 오류", error);
    return {
      success: false,
      approvedCount: 0,
      errors: [{ linkId: "", error: "일괄 승인 중 오류가 발생했습니다." }],
    };
  }
}

/**
 * 여러 연결 요청을 한 번에 거부 (삭제)
 */
export async function rejectLinkRequests(
  linkIds: string[]
): Promise<{
  success: boolean;
  rejectedCount?: number;
  errors?: Array<{ linkId: string; error: string }>;
}> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, errors: [] };
  }

  if (!linkIds || linkIds.length === 0) {
    return { success: false, errors: [] };
  }

  const supabase = await createSupabaseServerClient();
  const errors: Array<{ linkId: string; error: string }> = [];
  let rejectedCount = 0;
  const studentIds = new Set<string>();

  try {
    // 병렬 처리
    const deletePromises = linkIds.map(async (linkId) => {
      try {
        // 먼저 요청 존재 여부 확인
        const { data: link, error: fetchError } = await supabase
          .from("parent_student_links")
          .select("id, student_id")
          .eq("id", linkId)
          .maybeSingle();

        if (fetchError || !link) {
          return {
            linkId,
            error: fetchError
              ? PARENT_STUDENT_LINK_MESSAGES.errors.FETCH_ERROR
              : PARENT_STUDENT_LINK_MESSAGES.errors.REQUEST_NOT_FOUND,
            studentId: null,
          };
        }

        const studentId = link.student_id;

        // 요청 삭제 (거부)
        const { error } = await supabase
          .from("parent_student_links")
          .delete()
          .eq("id", linkId);

        if (error) {
          return {
            linkId,
            error: error.message || "요청 거부에 실패했습니다.",
            studentId: null,
          };
        }

        return { linkId, error: null, studentId };
      } catch (error) {
        console.error(
          `[admin/parentStudentLink] 요청 거부 중 오류 (linkId: ${linkId})`,
          error
        );
        return {
          linkId,
          error: "요청 거부 중 오류가 발생했습니다.",
          studentId: null,
        };
      }
    });

    const results = await Promise.all(deletePromises);

    // 결과 집계
    for (const result of results) {
      if (result.error) {
        errors.push({ linkId: result.linkId, error: result.error });
      } else if (result.studentId) {
        rejectedCount++;
        studentIds.add(result.studentId);
      }
    }

    // 성공한 항목이 있으면 경로 재검증
    if (rejectedCount > 0) {
      revalidatePath("/admin/parent-links");
      for (const studentId of studentIds) {
        revalidatePath(`/admin/students/${studentId}`);
      }
    }

    return {
      success: errors.length === 0,
      rejectedCount,
      errors: errors.length > 0 ? errors : undefined,
    };
  } catch (error) {
    console.error("[admin/parentStudentLink] 일괄 거부 중 오류", error);
    return {
      success: false,
      rejectedCount: 0,
      errors: [{ linkId: "", error: "일괄 거부 중 오류가 발생했습니다." }],
    };
  }
}
</file>

<file path="actions/qrCodeActions.ts">
"use server";

import { requireAdminAuth } from "@/lib/auth/requireAdminAuth";
import { generateAttendanceQRCode } from "@/lib/services/qrCodeService";
import { normalizeError, getUserFacingMessage, logError } from "@/lib/errors";
import { service } from "@/lib/domains/qrCode";
import type { QRCodeRecord } from "@/lib/services/qrCodeService";

/**
 * 출석용 QR 코드 생성 (서버 액션)
 */
export async function generateQRCodeAction(): Promise<{
  success: boolean;
  qrCodeUrl?: string;
  qrCodeId?: string;
  error?: string;
}> {
  try {
    await requireAdminAuth();
    const result = await generateAttendanceQRCode();
    return {
      success: true,
      qrCodeUrl: result.qrCodeUrl,
      qrCodeId: result.qrCodeId,
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "generateQRCodeAction" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * 현재 활성 QR 코드 조회
 */
export async function getActiveQRCodeAction(): Promise<{
  success: boolean;
  data?: QRCodeRecord | null;
  error?: string;
}> {
  try {
    await requireAdminAuth();
    const qrCode = await service.getActiveQRCode();
    return {
      success: true,
      data: qrCode,
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "getActiveQRCodeAction" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * QR 코드 비활성화
 */
export async function deactivateQRCodeAction(qrCodeId: string): Promise<{
  success: boolean;
  error?: string;
}> {
  try {
    await requireAdminAuth();
    await service.deactivateQRCode(qrCodeId);
    return {
      success: true,
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "deactivateQRCodeAction" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}

/**
 * QR 코드 이력 조회
 */
export async function getQRCodeHistoryAction(limit?: number): Promise<{
  success: boolean;
  data?: QRCodeRecord[];
  error?: string;
}> {
  try {
    await requireAdminAuth();
    const history = await service.getQRCodeHistory(limit || 50);
    return {
      success: true,
      data: history,
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "getQRCodeHistoryAction" });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}
</file>

<file path="actions/recommendationSettings.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  getRangeRecommendationConfig,
  updateRangeRecommendationConfig,
  resetRangeRecommendationConfig,
} from "@/lib/recommendations/config/configManager";
import type { RangeRecommendationConfig } from "@/lib/recommendations/config/types";
import { revalidatePath } from "next/cache";

/**
 * 범위 추천 설정 조회
 */
export async function getRangeRecommendationSettingsAction(): Promise<{
  success: boolean;
  config?: RangeRecommendationConfig;
  error?: string;
}> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    return {
      success: false,
      error: "관리자 권한이 필요합니다.",
    };
  }

  try {
    const tenantContext = await getTenantContext();
    const config = await getRangeRecommendationConfig(tenantContext?.tenantId || null);

    return {
      success: true,
      config,
    };
  } catch (error) {
    console.error("[recommendationSettings] 설정 조회 실패:", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "설정 조회에 실패했습니다.",
    };
  }
}

/**
 * 범위 추천 설정 업데이트
 */
export async function updateRangeRecommendationSettingsAction(
  config: RangeRecommendationConfig
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    return {
      success: false,
      error: "관리자 권한이 필요합니다.",
    };
  }

  try {
    const tenantContext = await getTenantContext();
    const result = await updateRangeRecommendationConfig(
      config,
      tenantContext?.tenantId || null
    );

    if (result.success) {
      revalidatePath("/admin/recommendation-settings");
    }

    return result;
  } catch (error) {
    console.error("[recommendationSettings] 설정 업데이트 실패:", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "설정 업데이트에 실패했습니다.",
    };
  }
}

/**
 * 범위 추천 설정을 기본값으로 재설정
 */
export async function resetRangeRecommendationSettingsAction(): Promise<{
  success: boolean;
  error?: string;
}> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin") {
    return {
      success: false,
      error: "관리자 권한이 필요합니다.",
    };
  }

  try {
    const tenantContext = await getTenantContext();
    const result = await resetRangeRecommendationConfig(
      tenantContext?.tenantId || null
    );

    if (result.success) {
      revalidatePath("/admin/recommendation-settings");
    }

    return result;
  } catch (error) {
    console.error("[recommendationSettings] 설정 재설정 실패:", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "설정 재설정에 실패했습니다.",
    };
  }
}
</file>

<file path="actions/schedulerSettings.ts">
"use server";

import { requireAdminAuth } from "@/lib/auth/requireAdminAuth";
import {
  getTenantSchedulerSettings,
  upsertTenantSchedulerSettings,
} from "@/lib/data/schedulerSettings";
import type { TenantSchedulerSettings } from "@/lib/types/schedulerSettings";

/**
 * 기관 전역 스케줄러 설정 조회
 */
export async function getTenantSchedulerSettingsAction(): Promise<TenantSchedulerSettings | null> {
  const { tenantId } = await requireAdminAuth();
  if (!tenantId) {
    return null;
  }
  return getTenantSchedulerSettings(tenantId);
}

/**
 * 기관 전역 스케줄러 설정 저장
 */
export async function saveTenantSchedulerSettingsAction(
  settings: Partial<
    Omit<TenantSchedulerSettings, "id" | "tenant_id" | "created_at" | "updated_at">
  >
): Promise<{ success: boolean; error?: string }> {
  const { tenantId } = await requireAdminAuth();
  if (!tenantId) {
    return { success: false, error: "기관 정보를 찾을 수 없습니다." };
  }
  return upsertTenantSchedulerSettings(tenantId, settings);
}
</file>

<file path="actions/schoolActions.ts">
"use server";

/**
 * 관리자용 학교 관련 Server Actions
 *
 * 새 테이블 구조:
 * - school_info: 중·고등학교 (읽기 전용, 나이스 데이터)
 * - universities: 대학교 (읽기 전용)
 * - university_campuses: 대학교 캠퍼스 (읽기 전용)
 * - all_schools_view: 통합 조회 VIEW
 *
 * 주의: 새 테이블들은 외부 데이터 기반으로 읽기 전용입니다.
 */

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import {
  getAllSchools,
  searchAllSchools,
  getSchoolByUnifiedId,
  getSchoolInfoList,
  getUniversityCampuses,
  getRegions,
  getRegionsByLevel,
  getRegionsByParent,
} from "@/lib/data/schools";
import type {
  School,
  Region,
  AllSchoolsView,
  SchoolInfo,
  UniversityWithCampus,
} from "@/lib/data/schools";
import type {
  SchoolType,
  SchoolTypeKor,
} from "@/lib/domains/school/types";

// Re-export types
export type { School, Region };

// 상수
const SCHOOL_TYPE_REVERSE_MAP: Record<SchoolTypeKor, SchoolType> = {
  "중학교": "MIDDLE",
  "고등학교": "HIGH",
  "대학교": "UNIVERSITY",
};

const SCHOOL_TYPE_MAP: Record<SchoolType, SchoolTypeKor> = {
  MIDDLE: "중학교",
  HIGH: "고등학교",
  UNIVERSITY: "대학교",
};

/**
 * 학교 목록 조회 (클라이언트용)
 */
export async function getSchoolsAction(options?: {
  regionId?: string;
  type?: SchoolTypeKor;
  includeInactive?: boolean;
}): Promise<School[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  const schoolType = options?.type ? SCHOOL_TYPE_REVERSE_MAP[options.type] : undefined;
  
  const allSchools = await getAllSchools({
    schoolType,
    limit: 1000,
  });

  return allSchools.map((s) => ({
    id: s.id,
    name: s.name,
    type: SCHOOL_TYPE_MAP[s.school_type],
    region: s.region,
    region_id: null,
    address: s.address,
    postal_code: s.postal_code,
    phone: s.phone,
    campus_name: s.campus_name,
    university_type: s.university_type,
    display_order: 0,
    is_active: true,
    created_at: s.created_at,
  }));
}

/**
 * 지역 목록 조회 (클라이언트용)
 */
export async function getRegionsAction(): Promise<Region[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await getRegions();
}

/**
 * 레벨별 지역 조회 (클라이언트용)
 */
export async function getRegionsByLevelAction(
  level: 1 | 2 | 3
): Promise<Region[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await getRegionsByLevel(level);
}

/**
 * 상위 지역별 하위 지역 조회 (클라이언트용)
 */
export async function getRegionsByParentAction(
  parentId: string
): Promise<Region[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await getRegionsByParent(parentId);
}

/**
 * 통합 학교 목록 조회 (새 API)
 */
export async function getAllSchoolsAction(options?: {
  schoolType?: SchoolType;
  region?: string;
  limit?: number;
}): Promise<AllSchoolsView[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await getAllSchools(options);
}

/**
 * 중·고등학교 목록 조회 (새 API)
 */
export async function getSchoolInfoListAction(options?: {
  schoolLevel?: "중" | "고";
  region?: string;
  limit?: number;
}): Promise<SchoolInfo[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await getSchoolInfoList(options);
}

/**
 * 대학교 캠퍼스 목록 조회 (새 API)
 */
export async function getUniversityCampusesAction(options?: {
  universityId?: number;
  region?: string;
  limit?: number;
}): Promise<UniversityWithCampus[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await getUniversityCampuses(options);
}

/**
 * 학교 검색 (새 API)
 */
export async function searchSchoolsAction(
  query: string,
  schoolType?: SchoolType,
  limit = 50
): Promise<{ id: string; name: string; schoolType: SchoolType; region: string | null }[]> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return [];
  }

  return await searchAllSchools({
    query,
    schoolType,
    limit,
  });
}

// ============================================
// Deprecated Functions (읽기 전용으로 변경됨)
// ============================================

/**
 * @deprecated 새 테이블은 읽기 전용입니다.
 * 학교 생성은 더 이상 지원되지 않습니다.
 */
export async function createSchool(
  formData: FormData
): Promise<{ success: boolean; error?: string }> {
  console.warn("[actions/schoolActions] createSchool은 더 이상 지원되지 않습니다. 새 테이블은 읽기 전용입니다.");
  return { 
    success: false, 
    error: "학교 데이터는 외부 데이터(나이스 등) 기반으로 읽기 전용입니다. 학교 추가가 필요하면 관리자에게 문의하세요." 
  };
}

/**
 * @deprecated 새 테이블은 읽기 전용입니다.
 * 학교 수정은 더 이상 지원되지 않습니다.
 */
export async function updateSchool(
  formData: FormData
): Promise<{ success: boolean; error?: string }> {
  console.warn("[actions/schoolActions] updateSchool은 더 이상 지원되지 않습니다. 새 테이블은 읽기 전용입니다.");
  return { 
    success: false, 
    error: "학교 데이터는 외부 데이터(나이스 등) 기반으로 읽기 전용입니다." 
  };
}

/**
 * @deprecated 새 테이블은 읽기 전용입니다.
 * 학교 삭제는 더 이상 지원되지 않습니다.
 */
export async function deleteSchool(
  schoolId: string
): Promise<{ success: boolean; error?: string }> {
  console.warn("[actions/schoolActions] deleteSchool은 더 이상 지원되지 않습니다. 새 테이블은 읽기 전용입니다.");
  return { 
    success: false, 
    error: "학교 데이터는 외부 데이터(나이스 등) 기반으로 읽기 전용입니다." 
  };
}
</file>

<file path="actions/smsLogActions.ts">
"use server";

import { requireAdminAuth } from "@/lib/auth/requireAdminAuth";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  AppError,
  ErrorCode,
  normalizeError,
  getUserFacingMessage,
  logError,
} from "@/lib/errors";

export type SMSLogFilter = {
  startDate?: string;
  endDate?: string;
  studentId?: string;
  status?: "pending" | "sent" | "delivered" | "failed";
  smsType?: "attendance_check_in" | "attendance_check_out" | "attendance_absent" | "attendance_late";
};

export type SMSLog = {
  id: string;
  tenant_id: string;
  recipient_id: string | null;
  recipient_phone: string;
  message_content: string;
  template_id: string | null;
  status: "pending" | "sent" | "delivered" | "failed";
  sent_at: string | null;
  delivered_at: string | null;
  error_message: string | null;
  created_at: string;
  student_name?: string | null;
};

/**
 * 출석 관련 SMS 로그 조회
 */
export async function getAttendanceSMSLogs(
  filters: SMSLogFilter = {},
  page: number = 1,
  pageSize: number = 50
): Promise<{
  success: boolean;
  data?: SMSLog[];
  total?: number;
  error?: string;
}> {
  try {
    await requireAdminAuth();
    const tenantContext = await getTenantContext();

    if (!tenantContext?.tenantId) {
      throw new AppError(
        "테넌트 정보를 찾을 수 없습니다.",
        ErrorCode.NOT_FOUND,
        404,
        true
      );
    }

    const supabase = await createSupabaseServerClient();

    // 출석 관련 SMS 메시지 키워드로 필터링
    const attendanceKeywords = ["입실", "퇴실", "결석", "지각", "출석"];
    
    let query = supabase
      .from("sms_logs")
      .select(
        "id, tenant_id, recipient_id, recipient_phone, message_content, template_id, status, sent_at, delivered_at, error_message, created_at",
        { count: "exact" }
      )
      .eq("tenant_id", tenantContext.tenantId)
      .or(
        attendanceKeywords.map((keyword) => `message_content.ilike.%${keyword}%`).join(",")
      )
      .order("created_at", { ascending: false });

    // 필터 적용
    if (filters.startDate) {
      query = query.gte("created_at", filters.startDate);
    }

    if (filters.endDate) {
      // endDate는 하루의 끝까지 포함
      const endDate = new Date(filters.endDate);
      endDate.setHours(23, 59, 59, 999);
      query = query.lte("created_at", endDate.toISOString());
    }

    if (filters.studentId) {
      query = query.eq("recipient_id", filters.studentId);
    }

    if (filters.status) {
      query = query.eq("status", filters.status);
    }

    // 페이지네이션
    const from = (page - 1) * pageSize;
    const to = from + pageSize - 1;
    query = query.range(from, to);

    const { data: logs, error, count } = await query;

    if (error) {
      console.error("[smsLogs] SMS 로그 조회 실패:", error);
      throw new AppError(
        error.message || "SMS 로그 조회에 실패했습니다.",
        ErrorCode.DATABASE_ERROR,
        500,
        true
      );
    }

    // 학생 이름 조회 (recipient_id가 있는 경우)
    const studentIds = logs
      ?.filter((log) => log.recipient_id)
      .map((log) => log.recipient_id)
      .filter((id): id is string => id !== null) || [];

    let studentNames: Record<string, string | null> = {};
    if (studentIds.length > 0) {
      const { data: students } = await supabase
        .from("students")
        .select("id, name")
        .in("id", studentIds);

      if (students) {
        studentNames = students.reduce(
          (acc, student) => {
            acc[student.id] = student.name;
            return acc;
          },
          {} as Record<string, string | null>
        );
      }
    }

    // 학생 이름 추가
    const logsWithStudentNames: SMSLog[] =
      logs?.map((log) => ({
        ...log,
        student_name: log.recipient_id ? studentNames[log.recipient_id] || null : null,
      })) || [];

    // SMS 타입 필터링 (메시지 내용 기반)
    let filteredLogs = logsWithStudentNames;
    if (filters.smsType) {
      const typeKeywords: Record<string, string[]> = {
        attendance_check_in: ["입실"],
        attendance_check_out: ["퇴실"],
        attendance_absent: ["결석"],
        attendance_late: ["지각"],
      };

      const keywords = typeKeywords[filters.smsType] || [];
      if (keywords.length > 0) {
        filteredLogs = logsWithStudentNames.filter((log) =>
          keywords.some((keyword) => log.message_content.includes(keyword))
        );
      }
    }

    return {
      success: true,
      data: filteredLogs,
      total: count || 0,
    };
  } catch (error) {
    // Next.js의 redirect()와 notFound()는 재throw
    if (
      error &&
      typeof error === "object" &&
      "digest" in error &&
      typeof (error as { digest: string }).digest === "string"
    ) {
      const digest = (error as { digest: string }).digest;
      if (
        digest.startsWith("NEXT_REDIRECT") ||
        digest.startsWith("NEXT_NOT_FOUND")
      ) {
        throw error;
      }
    }

    const normalizedError = normalizeError(error);
    logError(normalizedError, { function: "getAttendanceSMSLogs", filters });

    return {
      success: false,
      error: getUserFacingMessage(normalizedError),
    };
  }
}
</file>

<file path="actions/studentManagementActions.ts">
"use server";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";

/**
 * 학생 계정 비활성화/활성화
 */
export async function toggleStudentStatus(
  studentId: string,
  isActive: boolean
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: "권한이 없습니다." };
  }

  const supabase = await createSupabaseServerClient();

  const { error } = await supabase
    .from("students")
    .update({ is_active: isActive })
    .eq("id", studentId);

  if (error) {
    console.error("[admin/studentManagement] 학생 상태 변경 실패", error);
    return {
      success: false,
      error: error.message || "상태 변경에 실패했습니다.",
    };
  }

  revalidatePath("/admin/students");
  revalidatePath(`/admin/students/${studentId}`);

  return { success: true };
}

/**
 * 학생 계정 삭제 (소프트 삭제: is_active를 false로 설정하고 auth.users에서도 삭제)
 */
export async function deleteStudent(
  studentId: string
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin") {
    return { success: false, error: "관리자만 학생을 삭제할 수 있습니다." };
  }

  const supabase = await createSupabaseServerClient();

  // 1. students 테이블에서 is_active를 false로 설정 (소프트 삭제)
  const { error: updateError } = await supabase
    .from("students")
    .update({ is_active: false })
    .eq("id", studentId);

  if (updateError) {
    console.error("[admin/studentManagement] 학생 비활성화 실패", updateError);
    return {
      success: false,
      error: updateError.message || "학생 삭제에 실패했습니다.",
    };
  }

  // 2. auth.users에서도 삭제 (관리자 권한 필요)
  try {
    const { error: deleteError } = await supabase.auth.admin.deleteUser(
      studentId
    );
    if (deleteError) {
      console.error(
        "[admin/studentManagement] 인증 사용자 삭제 실패",
        deleteError
      );
      // 인증 사용자 삭제 실패해도 students 테이블은 업데이트되었으므로 경고만
      console.warn(
        "[admin/studentManagement] 인증 사용자 삭제 실패했지만 학생 정보는 비활성화되었습니다."
      );
    }
  } catch (error) {
    console.error("[admin/studentManagement] 인증 사용자 삭제 중 오류", error);
    // 인증 사용자 삭제 실패해도 students 테이블은 업데이트되었으므로 경고만
  }

  revalidatePath("/admin/students");
  revalidatePath(`/admin/students/${studentId}`);

  return { success: true };
}

/**
 * 학생 반 정보 업데이트 (관리자 전용)
 */
export async function updateStudentClass(
  studentId: string,
  classValue: string | null
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: "권한이 없습니다." };
  }

  const supabase = await createSupabaseServerClient();

  // 빈 문자열을 null로 변환
  const normalizedClass = classValue?.trim() || null;

  const { error } = await supabase
    .from("students")
    .update({ class: normalizedClass })
    .eq("id", studentId);

  if (error) {
    console.error("[admin/studentManagement] 학생 반 정보 변경 실패", error);
    return {
      success: false,
      error: error.message || "반 정보 변경에 실패했습니다.",
    };
  }

  revalidatePath("/admin/students");
  revalidatePath(`/admin/students/${studentId}`);

  return { success: true };
}
</file>

<file path="actions/subjectActions.ts">
"use server";

import { revalidatePath } from "next/cache";
import { getCurrentUser } from "@/lib/auth/getCurrentUser";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { getSubjectGroups, getSubjectsByGroup, getSubjectTypes, getSubjectGroupsWithSubjects } from "@/lib/data/subjects";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";

// 교과 그룹 목록 조회 (전역 관리)
export async function getSubjectGroupsAction(
  curriculumRevisionId?: string
): Promise<SubjectGroup[]> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  return getSubjectGroups(curriculumRevisionId);
}

// 교과 그룹과 과목 목록 함께 조회 (전역 관리)
export async function getSubjectGroupsWithSubjectsAction(
  curriculumRevisionId?: string
): Promise<(SubjectGroup & { subjects: Subject[] })[]> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  return getSubjectGroupsWithSubjects(curriculumRevisionId);
}

// 교과 그룹에 속한 과목 목록 조회 (전역 관리)
export async function getSubjectsByGroupAction(
  subjectGroupId: string
): Promise<Subject[]> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  return getSubjectsByGroup(subjectGroupId);
}

// 과목구분 목록 조회 (개정교육과정별)
export async function getSubjectTypesAction(
  curriculumRevisionId?: string
): Promise<SubjectType[]> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  return getSubjectTypes(curriculumRevisionId);
}

// 교과 그룹 생성 (전역 관리)
export async function createSubjectGroup(formData: FormData): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const curriculumRevisionId = String(formData.get("curriculum_revision_id") ?? "").trim();
  const name = String(formData.get("name") ?? "").trim();

  if (!curriculumRevisionId) {
    throw new Error("개정교육과정을 선택해주세요.");
  }

  if (!name) {
    throw new Error("교과 그룹명을 입력해주세요.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subject_groups")
    .insert({
      curriculum_revision_id: curriculumRevisionId,
      name,
    });

  if (error) {
    if (error.code === "23505") {
      throw new Error("이미 존재하는 교과 그룹명입니다.");
    }
    throw new Error(`교과 그룹 생성에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/subjects");
}

// 교과 그룹 수정 (전역 관리)
export async function updateSubjectGroup(
  id: string,
  formData: FormData
): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const curriculumRevisionId = String(formData.get("curriculum_revision_id") ?? "").trim();
  const name = String(formData.get("name") ?? "").trim();

  if (!curriculumRevisionId) {
    throw new Error("개정교육과정을 선택해주세요.");
  }

  if (!name) {
    throw new Error("교과 그룹명을 입력해주세요.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subject_groups")
    .update({
      curriculum_revision_id: curriculumRevisionId,
      name,
    })
    .eq("id", id);

  if (error) {
    if (error.code === "23505") {
      throw new Error("이미 존재하는 교과 그룹명입니다.");
    }
    throw new Error(`교과 그룹 수정에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/subjects");
}

// 교과 그룹 삭제 (전역 관리)
export async function deleteSubjectGroup(id: string): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  // 관련 과목이 있는지 확인
  const { data: subjects, error: checkError } = await supabaseAdmin
    .from("subjects")
    .select("id")
    .eq("subject_group_id", id)
    .limit(1);

  if (checkError) {
    throw new Error(`과목 확인 중 오류가 발생했습니다: ${checkError.message}`);
  }

  if (subjects && subjects.length > 0) {
    throw new Error("과목이 있는 교과 그룹은 삭제할 수 없습니다. 먼저 모든 과목을 삭제해주세요.");
  }

  const { error } = await supabaseAdmin
    .from("subject_groups")
    .delete()
    .eq("id", id);

  if (error) {
    throw new Error(`교과 그룹 삭제에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/subjects");
}

// 과목 생성 (전역 관리)
export async function createSubject(formData: FormData): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const subjectGroupId = String(formData.get("subject_group_id") ?? "").trim();
  const name = String(formData.get("name") ?? "").trim();
  const subjectTypeId = String(formData.get("subject_type_id") ?? "").trim() || null;

  if (!subjectGroupId) {
    throw new Error("교과 그룹을 선택해주세요.");
  }

  if (!name) {
    throw new Error("과목명을 입력해주세요.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subjects")
    .insert({
      subject_group_id: subjectGroupId,
      name,
      subject_type_id: subjectTypeId,
    });

  if (error) {
    if (error.code === "23505") {
      throw new Error("이미 존재하는 과목명입니다.");
    }
    throw new Error(`과목 생성에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/subjects");
}

// 과목 수정 (전역 관리)
export async function updateSubject(
  id: string,
  formData: FormData
): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const subjectGroupId = String(formData.get("subject_group_id") ?? "").trim();
  const name = String(formData.get("name") ?? "").trim();
  const subjectTypeId = String(formData.get("subject_type_id") ?? "").trim() || null;

  if (!subjectGroupId) {
    throw new Error("교과 그룹을 선택해주세요.");
  }

  if (!name) {
    throw new Error("과목명을 입력해주세요.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subjects")
    .update({
      subject_group_id: subjectGroupId,
      name,
      subject_type_id: subjectTypeId,
    })
    .eq("id", id);

  if (error) {
    if (error.code === "23505") {
      throw new Error("이미 존재하는 과목명입니다.");
    }
    throw new Error(`과목 수정에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/subjects");
}

// 과목 삭제 (전역 관리)
export async function deleteSubject(id: string): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subjects")
    .delete()
    .eq("id", id);

  if (error) {
    throw new Error(`과목 삭제에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/subjects");
}

// 과목구분 생성 (개정교육과정별)
export async function createSubjectType(formData: FormData): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const curriculumRevisionId = String(formData.get("curriculum_revision_id") ?? "").trim();
  const name = String(formData.get("name") ?? "").trim();
  const isActiveInput = String(formData.get("is_active") ?? "true").trim();

  if (!curriculumRevisionId) {
    throw new Error("개정교육과정을 선택해주세요.");
  }

  if (!name) {
    throw new Error("과목구분명을 입력해주세요.");
  }

  const isActive = isActiveInput === "true" || isActiveInput === "on";

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subject_types")
    .insert({
      curriculum_revision_id: curriculumRevisionId,
      name,
      is_active: isActive,
    });

  if (error) {
    if (error.code === "23505") {
      throw new Error("이미 존재하는 과목구분명입니다.");
    }
    throw new Error(`과목구분 생성에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/content-metadata");
  revalidatePath("/admin/subjects");
}

// 과목구분 수정 (개정교육과정별)
export async function updateSubjectType(
  id: string,
  formData: FormData
): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  const curriculumRevisionId = String(formData.get("curriculum_revision_id") ?? "").trim();
  const name = String(formData.get("name") ?? "").trim();
  const isActiveInput = String(formData.get("is_active") ?? "true").trim();

  if (!curriculumRevisionId) {
    throw new Error("개정교육과정을 선택해주세요.");
  }

  if (!name) {
    throw new Error("과목구분명을 입력해주세요.");
  }

  const isActive = isActiveInput === "true" || isActiveInput === "on";

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  const { error } = await supabaseAdmin
    .from("subject_types")
    .update({
      curriculum_revision_id: curriculumRevisionId,
      name,
      is_active: isActive,
    })
    .eq("id", id);

  if (error) {
    if (error.code === "23505") {
      throw new Error("이미 존재하는 과목구분명입니다.");
    }
    throw new Error(`과목구분 수정에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/content-metadata");
  revalidatePath("/admin/subjects");
}

// 과목구분 삭제 (개정교육과정별)
export async function deleteSubjectType(id: string): Promise<void> {
  const user = await getCurrentUser();
  if (!user || (user.role !== "admin" && user.role !== "consultant")) {
    throw new Error("관리자 권한이 필요합니다.");
  }

  // 전역 관리 작업이므로 Admin 클라이언트 사용 (RLS 우회)
  const supabaseAdmin = createSupabaseAdminClient();
  
  if (!supabaseAdmin) {
    throw new Error("관리자 권한이 필요합니다. Service Role Key가 설정되지 않았습니다.");
  }

  // 사용 중인 과목이 있는지 확인
  const { data: subjects, error: checkError } = await supabaseAdmin
    .from("subjects")
    .select("id")
    .eq("subject_type_id", id)
    .limit(1);

  if (checkError) {
    throw new Error(`과목 확인 중 오류가 발생했습니다: ${checkError.message}`);
  }

  if (subjects && subjects.length > 0) {
    throw new Error("과목구분을 사용 중인 과목이 있어 삭제할 수 없습니다. 먼저 해당 과목의 과목구분을 변경해주세요.");
  }

  const { error } = await supabaseAdmin
    .from("subject_types")
    .delete()
    .eq("id", id);

  if (error) {
    throw new Error(`과목구분 삭제에 실패했습니다: ${error.message}`);
  }

  revalidatePath("/admin/content-metadata");
  revalidatePath("/admin/subjects");
}
</file>

<file path="actions/templateBlockSets.ts">
"use server";

import { revalidatePath } from "next/cache";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";
import { blockSchema, validateFormData } from "@/lib/validation/schemas";

/**
 * 템플릿 블록 세트 생성
 */
async function _createTemplateBlockSet(formData: FormData): Promise<{ blockSetId: string; name: string }> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const templateId = formData.get("template_id");
  const name = formData.get("name");
  const description = formData.get("description");

  // template_id는 선택적 (템플릿 없이도 생성 가능)
  const templateIdValue = templateId && typeof templateId === "string" ? templateId : null;

  if (!name || typeof name !== "string" || name.trim() === "") {
    throw new AppError("세트 이름을 입력해주세요.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (name.length > 100) {
    throw new AppError("세트 이름은 100자 이하여야 합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 템플릿이 제공된 경우 존재 및 권한 확인
  if (templateIdValue) {
    const { data: template } = await supabase
      .from("camp_templates")
      .select("id, tenant_id")
      .eq("id", templateIdValue)
      .eq("tenant_id", tenantContext.tenantId)
      .single();

    if (!template) {
      throw new AppError("템플릿을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
    }
  }

  // 중복 이름 확인 (같은 템플릿 내에서만, 템플릿이 없으면 tenant_id 기준)
  const existingSetQuery = supabase
    .from("template_block_sets")
    .select("id")
    .eq("name", name.trim())
    .eq("tenant_id", tenantContext.tenantId);

  if (templateIdValue) {
    existingSetQuery.eq("template_id", templateIdValue);
  } else {
    existingSetQuery.is("template_id", null);
  }

  const { data: existingSet } = await existingSetQuery.maybeSingle();

  if (existingSet) {
    throw new AppError("이미 같은 이름의 세트가 있습니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const { data: newSet, error } = await supabase
    .from("template_block_sets")
    .insert({
      template_id: templateIdValue,
      tenant_id: tenantContext.tenantId,
      name: name.trim(),
      description: description && typeof description === "string" ? description.trim() : null,
    })
    .select("id, name")
    .single();

  if (error) {
    throw new AppError(
      "블록 세트 생성에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  if (!newSet) {
    throw new AppError("블록 세트 생성에 실패했습니다.", ErrorCode.INTERNAL_ERROR, 500, true);
  }

  // 템플릿이 있는 경우에만 템플릿 편집 페이지 revalidate
  if (templateIdValue) {
    revalidatePath(`/admin/camp-templates/${templateIdValue}/edit`);
  }
  revalidatePath("/admin/time-management");
  return { blockSetId: newSet.id, name: newSet.name };
}

/**
 * 템플릿 블록 세트 수정
 */
async function _updateTemplateBlockSet(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const setId = formData.get("id");
  const name = formData.get("name");
  const description = formData.get("description");

  if (!setId || typeof setId !== "string") {
    throw new AppError("세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (!name || typeof name !== "string" || name.trim() === "") {
    throw new AppError("세트 이름을 입력해주세요.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (name.length > 100) {
    throw new AppError("세트 이름은 100자 이하여야 합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 세트 존재 및 권한 확인
  const { data: existingSet } = await supabase
    .from("template_block_sets")
    .select("id, template_id, name")
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!existingSet) {
    throw new AppError("세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 이름 변경 시 중복 확인 (자기 자신 제외)
  if (existingSet.name !== name.trim()) {
    const { data: duplicateSet } = await supabase
      .from("template_block_sets")
      .select("id")
      .eq("template_id", existingSet.template_id)
      .eq("name", name.trim())
      .neq("id", setId)
      .maybeSingle();

    if (duplicateSet) {
      throw new AppError("이미 같은 이름의 세트가 있습니다.", ErrorCode.VALIDATION_ERROR, 400, true);
    }
  }

  const { error } = await supabase
    .from("template_block_sets")
    .update({
      name: name.trim(),
      description: description && typeof description === "string" ? description.trim() : null,
    })
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId);

  if (error) {
    throw new AppError(
      "블록 세트 수정에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  if (existingSet.template_id) {
    revalidatePath(`/admin/camp-templates/${existingSet.template_id}/edit`);
  }
  revalidatePath("/admin/time-management");
}

/**
 * 템플릿 블록 세트 삭제
 */
async function _deleteTemplateBlockSet(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const setId = formData.get("id");

  if (!setId || typeof setId !== "string") {
    throw new AppError("세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 세트 존재 및 권한 확인
  const { data: existingSet } = await supabase
    .from("template_block_sets")
    .select("id, template_id")
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!existingSet) {
    throw new AppError("세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // CASCADE로 블록도 함께 삭제됨
  const { error } = await supabase
    .from("template_block_sets")
    .delete()
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId);

  if (error) {
    throw new AppError(
      "블록 세트 삭제에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  if (existingSet.template_id) {
    revalidatePath(`/admin/camp-templates/${existingSet.template_id}/edit`);
  }
  revalidatePath("/admin/time-management");
}

/**
 * 템플릿 블록 세트 목록 조회
 * templateId가 null이면 템플릿에 연결되지 않은 블록 세트만 조회
 */
async function _getTemplateBlockSets(templateId: string | null = null): Promise<
  Array<{
    id: string;
    name: string;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  }>
> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  // templateId가 제공된 경우 템플릿 존재 및 권한 확인
  if (templateId) {
    const { data: template } = await supabase
      .from("camp_templates")
      .select("id")
      .eq("id", templateId)
      .eq("tenant_id", tenantContext.tenantId)
      .single();

    if (!template) {
      throw new AppError("템플릿을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
    }
  }

  // templateId가 있으면 해당 템플릿의 블록 세트, 없으면 템플릿에 연결되지 않은 블록 세트 조회
  const blockSetsQuery = supabase
    .from("template_block_sets")
    .select("id, name")
    .eq("tenant_id", tenantContext.tenantId)
    .order("created_at", { ascending: true });

  if (templateId) {
    blockSetsQuery.eq("template_id", templateId);
  } else {
    blockSetsQuery.is("template_id", null);
  }

  const { data: blockSets, error: setsError } = await blockSetsQuery;

  if (setsError) {
    throw new AppError(
      "블록 세트 목록을 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: setsError.message }
    );
  }

  if (!blockSets || blockSets.length === 0) {
    return [];
  }

  // 각 블록 세트의 시간 블록 조회
  const blockSetsWithBlocks = await Promise.all(
    blockSets.map(async (set) => {
      const { data: blocks, error: blocksError } = await supabase
        .from("template_blocks")
        .select("id, day_of_week, start_time, end_time")
        .eq("template_block_set_id", set.id)
        .order("day_of_week", { ascending: true })
        .order("start_time", { ascending: true });

      if (blocksError) {
        console.error(`[templateBlockSets] 블록 조회 실패 (세트 ${set.id}):`, blocksError);
        return { ...set, blocks: [] };
      }

      return {
        ...set,
        blocks:
          (blocks as Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>) ?? [],
      };
    })
  );

  return blockSetsWithBlocks;
}

/**
 * 템플릿 블록 추가
 */
async function _addTemplateBlock(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 입력 검증
  const validation = validateFormData(formData, blockSchema);
  if (!validation.success) {
    const firstError = validation.errors.issues[0];
    throw new AppError(
      firstError?.message || "입력값이 올바르지 않습니다.",
      ErrorCode.VALIDATION_ERROR,
      400,
      true
    );
  }

  const { day, start_time: startTime, end_time: endTime } = validation.data;
  const blockSetId = formData.get("block_set_id");

  if (!blockSetId || typeof blockSetId !== "string") {
    throw new AppError("블록 세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("template_block_sets")
    .select("id, template_id")
    .eq("id", blockSetId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 중복 블록 확인
  const { data: existingBlock } = await supabase
    .from("template_blocks")
    .select("id")
    .eq("template_block_set_id", blockSetId)
    .eq("day_of_week", day)
    .eq("start_time", startTime)
    .eq("end_time", endTime)
    .maybeSingle();

  if (existingBlock) {
    throw new AppError("이미 같은 시간 블록이 있습니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const { error } = await supabase.from("template_blocks").insert({
    template_block_set_id: blockSetId,
    day_of_week: day,
    start_time: startTime,
    end_time: endTime,
  });

  if (error) {
    throw new AppError(
      "블록 추가에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath(`/admin/camp-templates/${blockSet.template_id}/edit`);
}

/**
 * 템플릿 블록 삭제
 */
async function _deleteTemplateBlock(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const blockId = formData.get("id");

  if (!blockId || typeof blockId !== "string") {
    throw new AppError("블록 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 블록 존재 확인
  const { data: block } = await supabase
    .from("template_blocks")
    .select("id, template_block_set_id")
    .eq("id", blockId)
    .single();

  if (!block) {
    throw new AppError("블록을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("template_block_sets")
    .select("template_id, tenant_id")
    .eq("id", block.template_block_set_id)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  if (blockSet.tenant_id !== tenantContext.tenantId) {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const { error } = await supabase.from("template_blocks").delete().eq("id", blockId);

  if (error) {
    throw new AppError(
      "블록 삭제에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  if (blockSet.template_id) {
    revalidatePath(`/admin/camp-templates/${blockSet.template_id}/edit`);
  }
  revalidatePath("/admin/time-management");
}

/**
 * 템플릿에 연결되지 않은 블록 세트 목록 조회 (전체 조회)
 */
async function _getAllTemplateBlockSets(): Promise<
  Array<{
    id: string;
    name: string;
    template_id: string | null;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  }>
> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  const { data: blockSets, error: setsError } = await supabase
    .from("template_block_sets")
    .select("id, name, template_id")
    .eq("tenant_id", tenantContext.tenantId)
    .order("created_at", { ascending: true });

  if (setsError) {
    throw new AppError(
      "블록 세트 목록을 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: setsError.message }
    );
  }

  if (!blockSets || blockSets.length === 0) {
    return [];
  }

  // 각 블록 세트의 시간 블록 조회
  const blockSetsWithBlocks = await Promise.all(
    blockSets.map(async (set) => {
      const { data: blocks, error: blocksError } = await supabase
        .from("template_blocks")
        .select("id, day_of_week, start_time, end_time")
        .eq("template_block_set_id", set.id)
        .order("day_of_week", { ascending: true })
        .order("start_time", { ascending: true });

      if (blocksError) {
        console.error(`[templateBlockSets] 블록 조회 실패 (세트 ${set.id}):`, blocksError);
        return { ...set, blocks: [] };
      }

      return {
        ...set,
        blocks:
          (blocks as Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>) ?? [],
      };
    })
  );

  return blockSetsWithBlocks;
}

// 에러 핸들링 래퍼 적용
export const createTemplateBlockSet = withErrorHandling(_createTemplateBlockSet);
export const updateTemplateBlockSet = withErrorHandling(_updateTemplateBlockSet);
export const deleteTemplateBlockSet = withErrorHandling(_deleteTemplateBlockSet);
export const getTemplateBlockSets = withErrorHandling(_getTemplateBlockSets);
export const getAllTemplateBlockSets = withErrorHandling(_getAllTemplateBlockSets);
export const addTemplateBlock = withErrorHandling(_addTemplateBlock);
export const deleteTemplateBlock = withErrorHandling(_deleteTemplateBlock);
</file>

<file path="actions/tenantBlockSets.ts">
"use server";

import { revalidatePath } from "next/cache";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { AppError, ErrorCode, withErrorHandling } from "@/lib/errors";
import { blockSchema, validateFormData } from "@/lib/validation/schemas";

/**
 * 테넌트 블록 세트 생성
 */
async function _createTenantBlockSet(formData: FormData): Promise<{ blockSetId: string; name: string }> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const name = formData.get("name");
  const description = formData.get("description");

  if (!name || typeof name !== "string" || name.trim() === "") {
    throw new AppError("세트 이름을 입력해주세요.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (name.length > 100) {
    throw new AppError("세트 이름은 100자 이하여야 합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 중복 이름 확인 (tenant_id 기준)
  const { data: existingSet } = await supabase
    .from("tenant_block_sets")
    .select("id")
    .eq("name", name.trim())
    .eq("tenant_id", tenantContext.tenantId)
    .maybeSingle();

  if (existingSet) {
    throw new AppError("이미 같은 이름의 세트가 있습니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const { data: newSet, error } = await supabase
    .from("tenant_block_sets")
    .insert({
      tenant_id: tenantContext.tenantId,
      name: name.trim(),
      description: description && typeof description === "string" ? description.trim() : null,
    })
    .select("id, name")
    .single();

  if (error) {
    throw new AppError(
      "블록 세트 생성에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  if (!newSet) {
    throw new AppError("블록 세트 생성에 실패했습니다.", ErrorCode.INTERNAL_ERROR, 500, true);
  }

  revalidatePath("/admin/time-management");
  return { blockSetId: newSet.id, name: newSet.name };
}

/**
 * 테넌트 블록 세트 수정
 */
async function _updateTenantBlockSet(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const setId = formData.get("id");
  const name = formData.get("name");
  const description = formData.get("description");

  if (!setId || typeof setId !== "string") {
    throw new AppError("세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (!name || typeof name !== "string" || name.trim() === "") {
    throw new AppError("세트 이름을 입력해주세요.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (name.length > 100) {
    throw new AppError("세트 이름은 100자 이하여야 합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 세트 존재 및 권한 확인
  const { data: existingSet } = await supabase
    .from("tenant_block_sets")
    .select("id, name")
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!existingSet) {
    throw new AppError("세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 이름 변경 시 중복 확인 (자기 자신 제외)
  if (existingSet.name !== name.trim()) {
    const { data: duplicateSet } = await supabase
      .from("tenant_block_sets")
      .select("id")
      .eq("tenant_id", tenantContext.tenantId)
      .eq("name", name.trim())
      .neq("id", setId)
      .maybeSingle();

    if (duplicateSet) {
      throw new AppError("이미 같은 이름의 세트가 있습니다.", ErrorCode.VALIDATION_ERROR, 400, true);
    }
  }

  const { error } = await supabase
    .from("tenant_block_sets")
    .update({
      name: name.trim(),
      description: description && typeof description === "string" ? description.trim() : null,
    })
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId);

  if (error) {
    throw new AppError(
      "블록 세트 수정에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath("/admin/time-management");
}

/**
 * 테넌트 블록 세트 삭제
 */
async function _deleteTenantBlockSet(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const setId = formData.get("id");

  if (!setId || typeof setId !== "string") {
    throw new AppError("세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 세트 존재 및 권한 확인
  const { data: existingSet } = await supabase
    .from("tenant_block_sets")
    .select("id")
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!existingSet) {
    throw new AppError("세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // CASCADE로 블록도 함께 삭제됨
  const { error } = await supabase
    .from("tenant_block_sets")
    .delete()
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId);

  if (error) {
    throw new AppError(
      "블록 세트 삭제에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath("/admin/time-management");
}

/**
 * 테넌트 블록 세트 목록 조회 (모든 테넌트 블록 세트)
 */
async function _getTenantBlockSets(): Promise<
  Array<{
    id: string;
    name: string;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  }>
> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const supabase = await createSupabaseServerClient();

  // 모든 테넌트 블록 세트 조회
  const { data: blockSets, error: setsError } = await supabase
    .from("tenant_block_sets")
    .select("id, name")
    .eq("tenant_id", tenantContext.tenantId)
    .order("created_at", { ascending: true });

  if (setsError) {
    throw new AppError(
      "블록 세트 목록을 불러오는데 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: setsError.message }
    );
  }

  if (!blockSets || blockSets.length === 0) {
    return [];
  }

  // 각 블록 세트의 시간 블록 조회
  const blockSetsWithBlocks = await Promise.all(
    blockSets.map(async (set) => {
      const { data: blocks, error: blocksError } = await supabase
        .from("tenant_blocks")
        .select("id, day_of_week, start_time, end_time")
        .eq("tenant_block_set_id", set.id)
        .order("day_of_week", { ascending: true })
        .order("start_time", { ascending: true });

      if (blocksError) {
        console.error(`[tenantBlockSets] 블록 조회 실패 (세트 ${set.id}):`, blocksError);
        return { ...set, blocks: [] };
      }

      return {
        ...set,
        blocks:
          (blocks as Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>) ?? [],
      };
    })
  );

  return blockSetsWithBlocks;
}

/**
 * 테넌트 블록 추가
 */
async function _addTenantBlock(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 입력 검증
  const validation = validateFormData(formData, blockSchema);
  if (!validation.success) {
    const firstError = validation.errors.issues[0];
    throw new AppError(
      firstError?.message || "입력값이 올바르지 않습니다.",
      ErrorCode.VALIDATION_ERROR,
      400,
      true
    );
  }

  const { day, start_time: startTime, end_time: endTime } = validation.data;
  const blockSetId = formData.get("block_set_id");

  if (!blockSetId || typeof blockSetId !== "string") {
    throw new AppError("블록 세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("tenant_block_sets")
    .select("id")
    .eq("id", blockSetId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 중복 블록 확인
  const { data: existingBlock } = await supabase
    .from("tenant_blocks")
    .select("id")
    .eq("tenant_block_set_id", blockSetId)
    .eq("day_of_week", day)
    .eq("start_time", startTime)
    .eq("end_time", endTime)
    .maybeSingle();

  if (existingBlock) {
    throw new AppError("이미 같은 시간 블록이 있습니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const { error } = await supabase.from("tenant_blocks").insert({
    tenant_block_set_id: blockSetId,
    day_of_week: day,
    start_time: startTime,
    end_time: endTime,
  });

  if (error) {
    throw new AppError(
      "블록 추가에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath("/admin/time-management");
}

/**
 * 테넌트 블록 일괄 추가 (여러 요일에 동일 시간대 블록 추가)
 */
async function _addTenantBlocksToMultipleDays(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const targetDays = formData.get("target_days"); // "1,2,3,4,5" 형식
  const startTime = formData.get("start_time");
  const endTime = formData.get("end_time");
  const blockSetId = formData.get("block_set_id");

  if (!targetDays || typeof targetDays !== "string") {
    throw new AppError("대상 요일이 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (!startTime || typeof startTime !== "string") {
    throw new AppError("시작 시간이 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (!endTime || typeof endTime !== "string") {
    throw new AppError("종료 시간이 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  if (!blockSetId || typeof blockSetId !== "string") {
    throw new AppError("블록 세트 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const targetDayNums = targetDays
    .split(",")
    .map((d) => Number(d.trim()))
    .filter((d) => !isNaN(d) && d >= 0 && d <= 6);

  if (targetDayNums.length === 0) {
    throw new AppError("추가할 요일을 최소 1개 이상 선택해주세요.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("tenant_block_sets")
    .select("id")
    .eq("id", blockSetId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 각 대상 요일로 블록 추가 (겹치는 블록은 스킵하고 나머지만 추가)
  const insertPromises = targetDayNums.map(async (targetDay) => {
    // 대상 요일의 기존 블록 조회
    const { data: existingBlock } = await supabase
      .from("tenant_blocks")
      .select("id")
      .eq("tenant_block_set_id", blockSetId)
      .eq("day_of_week", targetDay)
      .eq("start_time", startTime)
      .eq("end_time", endTime)
      .maybeSingle();

    if (existingBlock) {
      return { 
        targetDay, 
        skipped: true, 
        reason: "이미 같은 시간 블록이 있습니다"
      };
    }

    // 블록 삽입
    const { error } = await supabase.from("tenant_blocks").insert({
      tenant_block_set_id: blockSetId,
      day_of_week: targetDay,
      start_time: startTime,
      end_time: endTime,
    });

    if (error) {
      return { 
        targetDay, 
        skipped: true, 
        reason: error.message || "블록 추가 중 오류가 발생했습니다"
      };
    }

    return { 
      targetDay, 
      skipped: false
    };
  });

  const results = await Promise.all(insertPromises);
  const successResults = results.filter((r) => !r.skipped);
  const skippedResults = results.filter((r) => r.skipped);

  // 부분 성공도 허용하되, 상세한 피드백 제공
  if (successResults.length === 0) {
    // 모든 요일이 실패한 경우
    const skippedDays = skippedResults.map((r) => ["일", "월", "화", "수", "목", "금", "토"][r.targetDay]).join(", ");
    const reasons = skippedResults.map((r) => r.reason).filter(Boolean).join("; ");
    throw new AppError(
      `모든 요일(${skippedDays})로의 추가가 실패했습니다. ${reasons}`,
      ErrorCode.VALIDATION_ERROR,
      400,
      true
    );
  }

  revalidatePath("/admin/time-management");

  // 부분 성공인 경우 상세 정보 제공 (성공으로 처리하되 정보 메시지 전달)
  if (skippedResults.length > 0) {
    const successDays = successResults.map((r) => ["일", "월", "화", "수", "목", "금", "토"][r.targetDay]).join(", ");
    const skippedDays = skippedResults.map((r) => ["일", "월", "화", "수", "목", "금", "토"][r.targetDay]).join(", ");
    
    // 부분 성공 정보를 포함한 정보성 메시지 (성공으로 처리)
    const infoMessage = `${successDays}요일에 블록이 추가되었습니다. ${skippedDays}요일은 이미 같은 시간 블록이 있어 스킵되었습니다.`;
    
    // 정보 메시지를 포함한 에러로 전달 (클라이언트에서 성공 메시지로 표시)
    throw new AppError(
      `INFO: ${infoMessage}`,
      ErrorCode.BUSINESS_LOGIC_ERROR,
      200,
      true
    );
  }
}

/**
 * 테넌트 블록 삭제
 */
async function _deleteTenantBlock(formData: FormData): Promise<void> {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    throw new AppError("기관 정보를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  const blockId = formData.get("id");

  if (!blockId || typeof blockId !== "string") {
    throw new AppError("블록 ID가 필요합니다.", ErrorCode.VALIDATION_ERROR, 400, true);
  }

  const supabase = await createSupabaseServerClient();

  // 블록 존재 확인
  const { data: block } = await supabase
    .from("tenant_blocks")
    .select("id, tenant_block_set_id")
    .eq("id", blockId)
    .single();

  if (!block) {
    throw new AppError("블록을 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  // 블록 세트 존재 및 권한 확인
  const { data: blockSet } = await supabase
    .from("tenant_block_sets")
    .select("tenant_id")
    .eq("id", block.tenant_block_set_id)
    .single();

  if (!blockSet) {
    throw new AppError("블록 세트를 찾을 수 없습니다.", ErrorCode.NOT_FOUND, 404, true);
  }

  if (blockSet.tenant_id !== tenantContext.tenantId) {
    throw new AppError("권한이 없습니다.", ErrorCode.FORBIDDEN, 403, true);
  }

  const { error } = await supabase.from("tenant_blocks").delete().eq("id", blockId);

  if (error) {
    throw new AppError(
      "블록 삭제에 실패했습니다.",
      ErrorCode.DATABASE_ERROR,
      500,
      true,
      { originalError: error.message }
    );
  }

  revalidatePath("/admin/time-management");
}

// 에러 핸들링 래퍼 적용
export const createTenantBlockSet = withErrorHandling(_createTenantBlockSet);
export const updateTenantBlockSet = withErrorHandling(_updateTenantBlockSet);
export const deleteTenantBlockSet = withErrorHandling(_deleteTenantBlockSet);
export const getTenantBlockSets = withErrorHandling(_getTenantBlockSets);
export const addTenantBlock = withErrorHandling(_addTenantBlock);
export const addTenantBlocksToMultipleDays = withErrorHandling(_addTenantBlocksToMultipleDays);
export const deleteTenantBlock = withErrorHandling(_deleteTenantBlock);
</file>

<file path="actions/tenantSettingsActions.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";

export type ParentRelation = "father" | "mother" | "guardian" | "other";

export type AutoApproveSettings = {
  enabled: boolean;
  conditions: {
    sameTenantOnly: boolean;
    allowedRelations: ParentRelation[];
  };
};

/**
 * 테넌트의 자동 승인 설정 조회
 */
export async function getAutoApproveSettings(
  tenantId?: string
): Promise<{
  success: boolean;
  data?: AutoApproveSettings;
  error?: string;
}> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: "권한이 없습니다." };
  }

  const tenantContext = await getTenantContext();
  const targetTenantId = tenantId || tenantContext?.tenantId;

  if (!targetTenantId) {
    return { success: false, error: "테넌트 정보를 찾을 수 없습니다." };
  }

  const supabase = await createSupabaseServerClient();

  try {
    const { data: tenant, error } = await supabase
      .from("tenants")
      .select("settings")
      .eq("id", targetTenantId)
      .maybeSingle();

    if (error) {
      console.error(
        "[tenantSettings] 자동 승인 설정 조회 실패",
        error
      );
      return {
        success: false,
        error: error.message || "설정 조회에 실패했습니다.",
      };
    }

    if (!tenant) {
      return { success: false, error: "테넌트를 찾을 수 없습니다." };
    }

    // settings에서 parentLinkAutoApprove 추출
    const settings = tenant.settings as Record<string, unknown> | null;
    const autoApprove = settings?.parentLinkAutoApprove as
      | AutoApproveSettings
      | undefined;

    // 기본값 반환 (설정이 없는 경우)
    const defaultSettings: AutoApproveSettings = {
      enabled: false,
      conditions: {
        sameTenantOnly: true,
        allowedRelations: ["father", "mother"],
      },
    };

    return {
      success: true,
      data: autoApprove || defaultSettings,
    };
  } catch (error) {
    console.error("[tenantSettings] 자동 승인 설정 조회 중 오류", error);
    return {
      success: false,
      error: "설정 조회 중 오류가 발생했습니다.",
    };
  }
}

/**
 * 테넌트의 자동 승인 설정 업데이트
 */
export async function updateAutoApproveSettings(
  settings: AutoApproveSettings,
  tenantId?: string
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin" && role !== "consultant") {
    return { success: false, error: "권한이 없습니다." };
  }

  // 설정 검증
  if (
    !Array.isArray(settings.conditions.allowedRelations) ||
    settings.conditions.allowedRelations.length === 0
  ) {
    return {
      success: false,
      error: "최소 하나 이상의 관계를 선택해야 합니다.",
    };
  }

  const validRelations: ParentRelation[] = [
    "father",
    "mother",
    "guardian",
    "other",
  ];
  for (const relation of settings.conditions.allowedRelations) {
    if (!validRelations.includes(relation)) {
      return {
        success: false,
        error: `올바르지 않은 관계 값: ${relation}`,
      };
    }
  }

  const tenantContext = await getTenantContext();
  const targetTenantId = tenantId || tenantContext?.tenantId;

  if (!targetTenantId) {
    return { success: false, error: "테넌트 정보를 찾을 수 없습니다." };
  }

  const supabase = await createSupabaseServerClient();

  try {
    // 기존 설정 조회
    const { data: tenant, error: fetchError } = await supabase
      .from("tenants")
      .select("settings")
      .eq("id", targetTenantId)
      .maybeSingle();

    if (fetchError) {
      console.error(
        "[tenantSettings] 테넌트 조회 실패",
        fetchError
      );
      return {
        success: false,
        error: "테넌트 정보를 찾을 수 없습니다.",
      };
    }

    if (!tenant) {
      return { success: false, error: "테넌트를 찾을 수 없습니다." };
    }

    // 기존 settings 유지하고 parentLinkAutoApprove만 업데이트
    const currentSettings =
      (tenant.settings as Record<string, unknown>) || {};
    const updatedSettings = {
      ...currentSettings,
      parentLinkAutoApprove: settings,
    };

    // 업데이트
    const { error } = await supabase
      .from("tenants")
      .update({ settings: updatedSettings })
      .eq("id", targetTenantId);

    if (error) {
      console.error(
        "[tenantSettings] 자동 승인 설정 업데이트 실패",
        error
      );
      return {
        success: false,
        error: error.message || "설정 업데이트에 실패했습니다.",
      };
    }

    revalidatePath("/admin/tenant/settings");

    return { success: true };
  } catch (error) {
    console.error("[tenantSettings] 자동 승인 설정 업데이트 중 오류", error);
    return {
      success: false,
      error: "설정 업데이트 중 오류가 발생했습니다.",
    };
  }
}
</file>

<file path="actions/tenantUsers.ts">
"use server";

import { requireAdminAuth } from "@/lib/auth/requireAdminAuth";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";

export type TenantUser = {
  id: string;
  email: string | null;
  name: string | null;
  tenant_id: string | null;
  type: "student" | "parent";
  // student specific
  grade?: string | null;
  class?: string | null;
  // parent specific
  relationship?: string | null;
};

/**
 * 기관별 사용자 목록 조회 (모든 기관의 학생/학부모)
 * Super Admin만 모든 기관의 사용자를 조회할 수 있음
 */
export async function getTenantUsersAction(
  currentTenantId: string
): Promise<TenantUser[]> {
  const { role, tenantId } = await requireAdminAuth();

  // Super Admin이 아니면 현재 기관의 사용자만 조회
  const targetTenantId = role === "superadmin" ? null : tenantId;

  const supabase = await createSupabaseServerClient();

  // 학생 목록 조회
  const { data: students, error: studentsError } = await supabase
    .from("students")
    .select("id, tenant_id, user_id, grade, name")
    .order("created_at", { ascending: false });

  if (studentsError) {
    console.error("[tenantUsers] 학생 목록 조회 실패:", studentsError);
  }

  // 학부모 목록 조회
  const { data: parents, error: parentsError } = await supabase
    .from("parent_users")
    .select("id, tenant_id, relationship")
    .order("created_at", { ascending: false });

  if (parentsError) {
    console.error("[tenantUsers] 학부모 목록 조회 실패:", parentsError);
  }

  // 사용자 기본 정보 조회 (이메일, 이름)
  const allUserIds = [
    ...(students || []).map((s) => s.user_id || s.id),
    ...(parents || []).map((p) => p.id),
  ];

  let userMetadata: Map<string, { email: string | null; name: string | null }> =
    new Map();

  if (allUserIds.length > 0) {
    // Supabase Auth에서 사용자 정보 조회
    const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();

    if (!authError && authUsers?.users) {
      authUsers.users.forEach((user) => {
        userMetadata.set(user.id, {
          email: user.email || null,
          name: (user.user_metadata?.display_name as string) || null,
        });
      });
    }
  }

  // 학생 데이터 변환
  const studentUsers: TenantUser[] = (students || []).map((student) => {
    const userId = student.user_id || student.id;
    const metadata = userMetadata.get(userId) || {
      email: null,
      name: student.name || null,
    };
    return {
      id: userId,
      email: metadata.email,
      name: metadata.name || student.name || null,
      tenant_id: student.tenant_id,
      type: "student" as const,
      grade: student.grade?.toString() || null,
      class: null, // students 테이블에 class 필드가 없을 수 있음
    };
  });

  // 학부모 데이터 변환
  const parentUsers: TenantUser[] = (parents || []).map((parent) => {
    const metadata = userMetadata.get(parent.id) || {
      email: null,
      name: null,
    };
    return {
      id: parent.id,
      email: metadata.email,
      name: metadata.name,
      tenant_id: parent.tenant_id,
      type: "parent" as const,
      relationship: parent.relationship || null,
    };
  });

  // 필터링: Super Admin이 아니면 현재 기관의 사용자만
  const filteredUsers = [...studentUsers, ...parentUsers].filter((user) => {
    if (targetTenantId === null) {
      // Super Admin: 모든 사용자
      return true;
    }
    // 일반 Admin: 현재 기관의 사용자만
    return user.tenant_id === targetTenantId || !user.tenant_id;
  });

  return filteredUsers;
}

/**
 * 사용자를 기관에 할당/이동
 */
export async function assignUserToTenantAction(
  userId: string,
  tenantId: string,
  userType: "student" | "parent"
): Promise<{ success: boolean; error?: string }> {
  const { role } = await requireAdminAuth();

  if (role !== "admin" && role !== "superadmin") {
    return { success: false, error: "권한이 없습니다." };
  }

  const supabase = await createSupabaseServerClient();

  try {
    if (userType === "student") {
      // 학생 테이블 업데이트 (user_id로 먼저 시도, 없으면 id로)
      let studentError = null;
      
      // user_id로 시도
      const { error: error1 } = await supabase
        .from("students")
        .update({ tenant_id: tenantId })
        .eq("user_id", userId);
      
      if (error1) {
        // id로 시도
        const { error: error2 } = await supabase
          .from("students")
          .update({ tenant_id: tenantId })
          .eq("id", userId);
        
        studentError = error2;
      }

      if (studentError) {
        console.error("[tenantUsers] 학생 기관 할당 실패:", studentError);
        return {
          success: false,
          error: studentError.message || "학생 기관 할당에 실패했습니다.",
        };
      }
    } else {
      // 학부모 테이블 업데이트
      const { error: parentError } = await supabase
        .from("parent_users")
        .update({ tenant_id: tenantId })
        .eq("id", userId);

      if (parentError) {
        console.error("[tenantUsers] 학부모 기관 할당 실패:", parentError);
        return {
          success: false,
          error: parentError.message || "학부모 기관 할당에 실패했습니다.",
        };
      }
    }

    revalidatePath("/admin/tenant/users");
    revalidatePath("/admin/tenant/settings");

    return { success: true };
  } catch (error) {
    console.error("[tenantUsers] 사용자 기관 할당 중 오류:", error);
    return {
      success: false,
      error:
        error instanceof Error
          ? error.message
          : "사용자 기관 할당 중 오류가 발생했습니다.",
    };
  }
}
</file>

<file path="actions/unverifiedUserActions.ts">
"use server";

import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { createSupabaseAdminClient } from "@/lib/supabase/admin";
import { revalidatePath } from "next/cache";

/**
 * 미인증 사용자 삭제
 */
export async function deleteUnverifiedUser(
  userId: string
): Promise<{ success: boolean; error?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin") {
    return { success: false, error: "관리자 권한이 필요합니다." };
  }

  try {
    const adminClient = createSupabaseAdminClient();
    if (!adminClient) {
      return {
        success: false,
        error: "SUPABASE_SERVICE_ROLE_KEY 환경 변수가 설정되지 않았습니다.",
      };
    }

    const { error } = await adminClient.auth.admin.deleteUser(userId);

    if (error) {
      console.error("[admin/unverified-users] 사용자 삭제 실패", error);
      return { success: false, error: error.message || "사용자 삭제에 실패했습니다." };
    }

    revalidatePath("/admin/unverified-users");
    return { success: true };
  } catch (error) {
    console.error("[admin/unverified-users] 사용자 삭제 중 오류", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "사용자 삭제에 실패했습니다.",
    };
  }
}

/**
 * 미인증 사용자에게 인증 메일 재발송
 */
export async function resendVerificationEmail(
  email: string
): Promise<{ success: boolean; error?: string; message?: string }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin") {
    return { success: false, error: "관리자 권한이 필요합니다." };
  }

  try {
    const adminClient = createSupabaseAdminClient();
    if (!adminClient) {
      return {
        success: false,
        error: "SUPABASE_SERVICE_ROLE_KEY 환경 변수가 설정되지 않았습니다.",
      };
    }
    
    // 사용자 조회
    const { data: usersData, error: listError } = await adminClient.auth.admin.listUsers();
    if (listError) {
      return { success: false, error: "사용자를 찾을 수 없습니다." };
    }

    const user = usersData?.users.find((u) => u.email === email);
    if (!user) {
      return { success: false, error: "해당 이메일의 사용자를 찾을 수 없습니다." };
    }

    // 인증 링크 생성 및 이메일 발송
    // 기존 사용자이므로 magiclink 사용 (password 불필요)
    const { data: linkData, error: linkError } = await adminClient.auth.admin.generateLink({
      type: "magiclink",
      email: email,
    });

    if (linkError) {
      console.error("[admin/unverified-users] 인증 링크 생성 실패", linkError);
      return { success: false, error: linkError.message || "인증 메일 재발송에 실패했습니다." };
    }

    // Supabase는 generateLink만으로는 이메일을 자동 발송하지 않으므로,
    // 실제로는 Supabase의 이메일 템플릿 설정이나 별도의 이메일 서비스를 사용해야 합니다.
    // 여기서는 링크가 생성되었음을 알려주고, 수동으로 이메일을 발송하도록 안내합니다.

    return {
      success: true,
      message: "인증 링크가 생성되었습니다. (이메일 발송은 Supabase 설정에 따라 자동으로 처리됩니다.)",
    };
  } catch (error) {
    console.error("[admin/unverified-users] 인증 메일 재발송 중 오류", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "인증 메일 재발송에 실패했습니다.",
    };
  }
}

/**
 * 미인증 사용자 일괄 삭제
 */
export async function deleteMultipleUnverifiedUsers(
  userIds: string[]
): Promise<{ success: boolean; error?: string; deletedCount?: number }> {
  const { role } = await getCurrentUserRole();

  if (role !== "admin") {
    return { success: false, error: "관리자 권한이 필요합니다." };
  }

  try {
    const adminClient = createSupabaseAdminClient();
    if (!adminClient) {
      return {
        success: false,
        error: "SUPABASE_SERVICE_ROLE_KEY 환경 변수가 설정되지 않았습니다.",
      };
    }

    let deletedCount = 0;
    const errors: string[] = [];

    for (const userId of userIds) {
      const { error } = await adminClient.auth.admin.deleteUser(userId);
      if (error) {
        errors.push(`${userId}: ${error.message}`);
      } else {
        deletedCount++;
      }
    }

    if (errors.length > 0) {
      console.error("[admin/unverified-users] 일부 사용자 삭제 실패", errors);
    }

    revalidatePath("/admin/unverified-users");
    return { success: true, deletedCount };
  } catch (error) {
    console.error("[admin/unverified-users] 일괄 삭제 중 오류", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "일괄 삭제에 실패했습니다.",
    };
  }
}
</file>

<file path="admin/attendance/_components/AttendanceFilters.tsx">
"use client";

type AttendanceFiltersProps = {
  startDateFilter?: string;
  endDateFilter?: string;
  statusFilter?: string;
};

export function AttendanceFilters({
  startDateFilter,
  endDateFilter,
  statusFilter,
}: AttendanceFiltersProps) {
  return (
    <form method="get" className="flex flex-col gap-4 md:flex-row">
      <input
        type="date"
        name="start_date"
        placeholder="시작 날짜"
        defaultValue={startDateFilter}
        className="rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
      />
      <input
        type="date"
        name="end_date"
        placeholder="종료 날짜"
        defaultValue={endDateFilter}
        className="rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
      />
      <select
        name="status"
        defaultValue={statusFilter}
        className="rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
      >
        <option value="">전체 상태</option>
        <option value="present">출석</option>
        <option value="absent">결석</option>
        <option value="late">지각</option>
        <option value="early_leave">조퇴</option>
        <option value="excused">공결</option>
      </select>
      <button
        type="submit"
        className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
      >
        검색
      </button>
      {(startDateFilter || endDateFilter || statusFilter) && (
        <a
          href="/admin/attendance"
          className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          초기화
        </a>
      )}
    </form>
  );
}
</file>

<file path="admin/attendance/_components/AttendanceList.tsx">
"use client";

import Link from "next/link";
import type { AttendanceRecord } from "@/lib/domains/attendance/types";
import {
  ATTENDANCE_STATUS_LABELS,
  CHECK_METHOD_LABELS,
} from "@/lib/domains/attendance/types";

type AttendanceListProps = {
  records: AttendanceRecord[];
  studentMap: Map<string, string>;
  onDelete?: (recordId: string, studentId: string) => void;
};

export function AttendanceList({
  records,
  studentMap,
  onDelete,
}: AttendanceListProps) {
  const getStatusBadgeClass = (status: string) => {
    switch (status) {
      case "present":
        return "bg-green-100 text-green-800";
      case "late":
        return "bg-yellow-100 text-yellow-800";
      case "early_leave":
        return "bg-orange-100 text-orange-800";
      case "absent":
        return "bg-red-100 text-red-800";
      case "excused":
        return "bg-blue-100 text-blue-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  if (records.length === 0) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
        <p className="text-sm text-gray-500">출석 기록이 없습니다.</p>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4">
      {records.map((record) => {
        const studentName = studentMap.get(record.student_id) ?? "이름 없음";
        return (
          <div
            key={record.id}
            className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-6 shadow-sm"
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Link
                  href={`/admin/students/${record.student_id}`}
                  className="font-semibold text-indigo-600 hover:text-indigo-800"
                >
                  {studentName}
                </Link>
                <span className="text-sm text-gray-500">
                  {record.attendance_date}
                </span>
                <span
                  className={`rounded-full px-2 py-1 text-xs font-medium ${getStatusBadgeClass(record.status)}`}
                >
                  {ATTENDANCE_STATUS_LABELS[record.status as keyof typeof ATTENDANCE_STATUS_LABELS]}
                </span>
              </div>
              <div className="flex items-center gap-3">
                <Link
                  href={`/admin/attendance/${record.id}/edit`}
                  className="text-sm text-indigo-600 hover:text-indigo-800"
                >
                  수정
                </Link>
                {onDelete && (
                  <button
                    onClick={() => onDelete(record.id, record.student_id)}
                    className="text-sm text-red-600 hover:text-red-800"
                  >
                    삭제
                  </button>
                )}
              </div>
            </div>
            <div className="flex flex-col gap-1 text-sm text-gray-600">
              {record.check_in_time && (
                <div>
                  입실: {new Date(record.check_in_time).toLocaleTimeString("ko-KR")}
                  {record.check_in_method &&
                    ` (${CHECK_METHOD_LABELS[record.check_in_method]})`}
                </div>
              )}
              {record.check_out_time && (
                <div>
                  퇴실: {new Date(record.check_out_time).toLocaleTimeString("ko-KR")}
                  {record.check_out_method &&
                    ` (${CHECK_METHOD_LABELS[record.check_out_method]})`}
                </div>
              )}
              {record.notes && (
                <div className="text-gray-700">{record.notes}</div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="admin/attendance/_components/AttendanceRecordForm.tsx">
"use client";

import { useState, useTransition } from "react";
import { recordAttendanceAction } from "@/app/(admin)/actions/attendanceActions";
import Button from "@/components/atoms/Button";
import Input from "@/components/atoms/Input";
import Label from "@/components/atoms/Label";
import Select from "@/components/atoms/Select";
import type { AttendanceStatus, CheckMethod } from "@/lib/domains/attendance/types";
import {
  ATTENDANCE_STATUS_LABELS,
  CHECK_METHOD_LABELS,
} from "@/lib/domains/attendance/types";

type AttendanceRecordFormProps = {
  studentId: string;
  studentName: string;
  defaultDate?: string;
  onSuccess?: () => void;
};

export function AttendanceRecordForm({
  studentId,
  studentName,
  defaultDate,
  onSuccess,
}: AttendanceRecordFormProps) {
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  // 오늘 날짜를 기본값으로 사용
  const today = defaultDate || new Date().toISOString().slice(0, 10);

  const [formData, setFormData] = useState({
    attendance_date: today,
    check_in_time: "",
    check_out_time: "",
    check_in_method: "manual" as CheckMethod | "",
    check_out_method: "manual" as CheckMethod | "",
    status: "present" as AttendanceStatus,
    notes: "",
  });

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError(null);
    setSuccess(false);

    startTransition(async () => {
      try {
        const result = await recordAttendanceAction({
          student_id: studentId,
          attendance_date: formData.attendance_date,
          check_in_time: formData.check_in_time || null,
          check_out_time: formData.check_out_time || null,
          check_in_method: formData.check_in_method || null,
          check_out_method: formData.check_out_method || null,
          status: formData.status,
          notes: formData.notes || null,
        });

        if (result.success) {
          setSuccess(true);
          if (onSuccess) {
            onSuccess();
          }
          // 폼 초기화
          setTimeout(() => {
            setFormData({
              attendance_date: today,
              check_in_time: "",
              check_out_time: "",
              check_in_method: "manual",
              check_out_method: "manual",
              status: "present",
              notes: "",
            });
            setSuccess(false);
          }, 2000);
        } else {
          setError(result.error || "출석 기록 저장에 실패했습니다.");
        }
      } catch (err: any) {
        setError(err.message || "출석 기록 저장 중 오류가 발생했습니다.");
      }
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <Label htmlFor="student_name">학생</Label>
        <Input
          id="student_name"
          value={studentName}
          disabled
          className="bg-gray-50"
        />
      </div>

      <div>
        <Label htmlFor="attendance_date">출석 날짜 *</Label>
        <Input
          id="attendance_date"
          type="date"
          value={formData.attendance_date}
          onChange={(e) =>
            setFormData({ ...formData, attendance_date: e.target.value })
          }
          required
        />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label htmlFor="check_in_time">입실 시간</Label>
          <Input
            id="check_in_time"
            type="time"
            value={formData.check_in_time}
            onChange={(e) =>
              setFormData({ ...formData, check_in_time: e.target.value })
            }
          />
        </div>
        <div>
          <Label htmlFor="check_out_time">퇴실 시간</Label>
          <Input
            id="check_out_time"
            type="time"
            value={formData.check_out_time}
            onChange={(e) =>
              setFormData({ ...formData, check_out_time: e.target.value })
            }
          />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label htmlFor="check_in_method">입실 방법</Label>
          <Select
            id="check_in_method"
            value={formData.check_in_method}
            onChange={(e) =>
              setFormData({
                ...formData,
                check_in_method: e.target.value as CheckMethod,
              })
            }
          >
            {Object.entries(CHECK_METHOD_LABELS).map(([value, label]) => (
              <option key={value} value={value}>
                {label}
              </option>
            ))}
          </Select>
        </div>
        <div>
          <Label htmlFor="check_out_method">퇴실 방법</Label>
          <Select
            id="check_out_method"
            value={formData.check_out_method}
            onChange={(e) =>
              setFormData({
                ...formData,
                check_out_method: e.target.value as CheckMethod,
              })
            }
          >
            {Object.entries(CHECK_METHOD_LABELS).map(([value, label]) => (
              <option key={value} value={value}>
                {label}
              </option>
            ))}
          </Select>
        </div>
      </div>

      <div>
        <Label htmlFor="status">출석 상태 *</Label>
        <Select
          id="status"
          value={formData.status}
          onChange={(e) =>
            setFormData({ ...formData, status: e.target.value as AttendanceStatus })
          }
          required
        >
          {Object.entries(ATTENDANCE_STATUS_LABELS).map(([value, label]) => (
            <option key={value} value={value}>
              {label}
            </option>
          ))}
        </Select>
      </div>

      <div>
        <Label htmlFor="notes">비고</Label>
        <textarea
          id="notes"
          value={formData.notes}
          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
          className="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          rows={3}
        />
      </div>

      {error && (
        <div className="rounded-lg bg-red-50 p-3 text-sm text-red-600">
          {error}
        </div>
      )}

      {success && (
        <div className="rounded-lg bg-green-50 p-3 text-sm text-green-600">
          출석 기록이 저장되었습니다.
        </div>
      )}

      <Button type="submit" disabled={isPending}>
        {isPending ? "저장 중..." : "저장"}
      </Button>
    </form>
  );
}

type AttendanceRecordFormWithStudentSelectProps = {
  students: Array<{ id: string; name: string | null }>;
  defaultDate?: string;
  onSuccess?: () => void;
};

export function AttendanceRecordFormWithStudentSelect({
  students,
  defaultDate,
  onSuccess,
}: AttendanceRecordFormWithStudentSelectProps) {
  const [selectedStudentId, setSelectedStudentId] = useState(
    students[0]?.id || ""
  );

  const selectedStudent = students.find((s) => s.id === selectedStudentId);

  if (!selectedStudent) {
    return (
      <p className="text-sm text-gray-500">등록된 학생이 없습니다.</p>
    );
  }

  return (
    <div className="space-y-4">
      <div>
        <Label htmlFor="student_select">학생 선택 *</Label>
        <Select
          id="student_select"
          value={selectedStudentId}
          onChange={(e) => setSelectedStudentId(e.target.value)}
          required
        >
          {students.map((student) => (
            <option key={student.id} value={student.id}>
              {student.name || "이름 없음"}
            </option>
          ))}
        </Select>
      </div>
      <AttendanceRecordForm
        studentId={selectedStudentId}
        studentName={selectedStudent.name || ""}
        defaultDate={defaultDate}
        onSuccess={onSuccess}
      />
    </div>
  );
}
</file>

<file path="admin/attendance/_components/AttendanceStatistics.tsx">
"use client";

import type { AttendanceStatistics } from "@/lib/domains/attendance/types";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";

type AttendanceStatisticsProps = {
  statistics: AttendanceStatistics;
  title?: string;
};

export function AttendanceStatistics({
  statistics,
  title = "출석 통계",
}: AttendanceStatisticsProps) {
  return (
    <Card>
      <CardHeader title={title} />
      <CardContent>
        <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
          <div className="rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">전체 일수</div>
            <div className="text-2xl font-bold text-gray-900">
              {statistics.total_days}
            </div>
          </div>
          <div className="rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">출석률</div>
            <div className="text-2xl font-bold text-green-600">
              {statistics.attendance_rate.toFixed(1)}%
            </div>
          </div>
          <div className="rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">지각률</div>
            <div className="text-2xl font-bold text-yellow-600">
              {statistics.late_rate.toFixed(1)}%
            </div>
          </div>
          <div className="rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">결석률</div>
            <div className="text-2xl font-bold text-red-600">
              {statistics.absent_rate.toFixed(1)}%
            </div>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4 md:grid-cols-5">
          <div className="text-center">
            <div className="text-sm text-gray-600">출석</div>
            <div className="text-lg font-semibold text-green-600">
              {statistics.present_count}
            </div>
          </div>
          <div className="text-center">
            <div className="text-sm text-gray-600">결석</div>
            <div className="text-lg font-semibold text-red-600">
              {statistics.absent_count}
            </div>
          </div>
          <div className="text-center">
            <div className="text-sm text-gray-600">지각</div>
            <div className="text-lg font-semibold text-yellow-600">
              {statistics.late_count}
            </div>
          </div>
          <div className="text-center">
            <div className="text-sm text-gray-600">조퇴</div>
            <div className="text-lg font-semibold text-orange-600">
              {statistics.early_leave_count}
            </div>
          </div>
          <div className="text-center">
            <div className="text-sm text-gray-600">공결</div>
            <div className="text-lg font-semibold text-blue-600">
              {statistics.excused_count}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/[id]/edit/_components/EditAttendanceRecordForm.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { updateAttendanceRecord } from "@/app/(admin)/actions/attendanceActions";
import type { UpdateAttendanceRecordRequest } from "@/lib/types/attendance";
import Button from "@/components/atoms/Button";
import Input from "@/components/atoms/Input";
import Label from "@/components/atoms/Label";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";

type EditAttendanceRecordFormProps = {
  recordId: string;
  initialData: {
    check_in_time?: string | null;
    check_out_time?: string | null;
    check_in_method?: string | null;
    check_out_method?: string | null;
    status?: string;
    notes?: string | null;
  };
};

export function EditAttendanceRecordForm({
  recordId,
  initialData,
}: EditAttendanceRecordFormProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);
  
  // datetime-local 형식으로 변환 (YYYY-MM-DDTHH:mm)
  const formatDateTimeLocal = (isoString: string | null | undefined): string => {
    if (!isoString) return "";
    try {
      const date = new Date(isoString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch {
      return "";
    }
  };
  
  const [formData, setFormData] = useState<UpdateAttendanceRecordRequest>({
    check_in_time: formatDateTimeLocal(initialData.check_in_time),
    check_out_time: formatDateTimeLocal(initialData.check_out_time),
    check_in_method: (initialData.check_in_method as any) || null,
    check_out_method: (initialData.check_out_method as any) || null,
    status: (initialData.status as any) || "present",
    notes: initialData.notes || "",
    reason: "", // 필수
  });
  
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    
    if (!formData.reason.trim()) {
      setError("수정 사유를 입력해주세요.");
      return;
    }
    
    // datetime-local을 ISO 형식으로 변환
    const submitData: UpdateAttendanceRecordRequest = {
      ...formData,
      check_in_time: formData.check_in_time
        ? new Date(formData.check_in_time).toISOString()
        : null,
      check_out_time: formData.check_out_time
        ? new Date(formData.check_out_time).toISOString()
        : null,
    };
    
    startTransition(async () => {
      const result = await updateAttendanceRecord(recordId, submitData);
      if (result.success) {
        router.push(`/admin/attendance`);
        router.refresh();
      } else {
        setError(result.error || "수정에 실패했습니다.");
      }
    });
  };
  
  return (
    <Card>
      <CardHeader title="출석 기록 수정" />
      <CardContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-6">
          {/* 시간 입력 필드 */}
          <div className="grid gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-1">
              <Label htmlFor="check_in_time">입실 시간</Label>
              <Input
                id="check_in_time"
                type="datetime-local"
                value={formData.check_in_time || ""}
                onChange={(e) =>
                  setFormData({ ...formData, check_in_time: e.target.value })
                }
              />
            </div>
            <div className="flex flex-col gap-1">
              <Label htmlFor="check_out_time">퇴실 시간</Label>
              <Input
                id="check_out_time"
                type="datetime-local"
                value={formData.check_out_time || ""}
                onChange={(e) =>
                  setFormData({ ...formData, check_out_time: e.target.value })
                }
              />
            </div>
          </div>
          
          {/* 방법 선택 */}
          <div className="grid gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-1">
              <Label htmlFor="check_in_method">입실 방법</Label>
              <select
                id="check_in_method"
                value={formData.check_in_method || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData,
                    check_in_method: e.target.value || null,
                  } as UpdateAttendanceRecordRequest)
                }
                className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm text-gray-900 dark:text-gray-100 focus:border-gray-900 dark:focus:border-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900/20 dark:focus:ring-gray-100/20"
              >
                <option value="">선택 안 함</option>
                <option value="manual">수동</option>
                <option value="qr">QR 코드</option>
                <option value="location">위치</option>
                <option value="auto">자동</option>
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <Label htmlFor="check_out_method">퇴실 방법</Label>
              <select
                id="check_out_method"
                value={formData.check_out_method || ""}
                onChange={(e) =>
                  setFormData({
                    ...formData,
                    check_out_method: e.target.value || null,
                  } as UpdateAttendanceRecordRequest)
                }
                className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm text-gray-900 dark:text-gray-100 focus:border-gray-900 dark:focus:border-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900/20 dark:focus:ring-gray-100/20"
              >
                <option value="">선택 안 함</option>
                <option value="manual">수동</option>
                <option value="qr">QR 코드</option>
                <option value="location">위치</option>
                <option value="auto">자동</option>
              </select>
            </div>
          </div>
          
          {/* 상태 선택 */}
          <div className="flex flex-col gap-1">
            <Label htmlFor="status">출석 상태</Label>
            <select
              id="status"
              value={formData.status || ""}
              onChange={(e) =>
                setFormData({ ...formData, status: e.target.value as any })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm text-gray-900 dark:text-gray-100 focus:border-gray-900 dark:focus:border-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900/20 dark:focus:ring-gray-100/20"
            >
              <option value="present">출석</option>
              <option value="absent">결석</option>
              <option value="late">지각</option>
              <option value="early_leave">조퇴</option>
              <option value="excused">공결</option>
            </select>
          </div>
          
          {/* 메모 */}
          <div className="flex flex-col gap-1">
            <Label htmlFor="notes">메모</Label>
            <textarea
              id="notes"
              value={formData.notes || ""}
              onChange={(e) =>
                setFormData({ ...formData, notes: e.target.value })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 focus:border-gray-900 dark:focus:border-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900/20 dark:focus:ring-gray-100/20"
              rows={3}
            />
          </div>
          
          {/* 수정 사유 (필수) */}
          <div className="flex flex-col gap-1">
            <Label htmlFor="reason">
              수정 사유 <span className="text-red-500">*</span>
            </Label>
            <textarea
              id="reason"
              value={formData.reason}
              onChange={(e) =>
                setFormData({ ...formData, reason: e.target.value })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 focus:border-gray-900 dark:focus:border-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900/20 dark:focus:ring-gray-100/20"
              rows={3}
              required
              placeholder="수정 사유를 입력해주세요."
            />
          </div>
          
          {error && (
            <div className="rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-3 text-sm text-red-800 dark:text-red-200">
              {error}
            </div>
          )}
          
          <div className="flex gap-3">
            <Button type="submit" disabled={isPending} isLoading={isPending}>
              {isPending ? "수정 중..." : "수정하기"}
            </Button>
            <Button
              type="button"
              variant="outline"
              onClick={() => router.back()}
              disabled={isPending}
            >
              취소
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/[id]/edit/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { EditAttendanceRecordForm } from "./_components/EditAttendanceRecordForm";

export default async function EditAttendanceRecordPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { userId, role } = await getCurrentUserRole();
  
  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }
  
  const { id } = await params;
  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();
  
  if (!tenantContext?.tenantId) {
    redirect("/admin/attendance");
  }
  
  const { data: record } = await supabase
    .from("attendance_records")
    .select("*")
    .eq("id", id)
    .eq("tenant_id", tenantContext.tenantId)
    .single();
  
  if (!record) {
    redirect("/admin/attendance");
  }
  
  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">출석 기록 수정</h1>
      
      <EditAttendanceRecordForm recordId={id} initialData={record} />
    </div>
  );
}
</file>

<file path="admin/attendance/qr-code/_components/QRCodeDisplay.tsx">
"use client";

import { useState, useEffect, useCallback } from "react";
import {
  generateQRCodeAction,
  getActiveQRCodeAction,
} from "@/app/(admin)/actions/qrCodeActions";
import Button from "@/components/atoms/Button";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import type { QRCodeRecord } from "@/lib/services/qrCodeService";

export function QRCodeDisplay() {
  const [qrCodeUrl, setQrCodeUrl] = useState<string | null>(null);
  const [qrCodeInfo, setQrCodeInfo] = useState<QRCodeRecord | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const loadQRCode = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      // 먼저 활성 QR 코드 조회 시도
      const activeResult = await getActiveQRCodeAction();
      if (activeResult.success && activeResult.data) {
        // 활성 QR 코드가 있으면 표시
        setQrCodeInfo(activeResult.data);
        setQrCodeUrl(activeResult.data.qr_code_url || null);
        setLoading(false);
        return;
      }

      // 활성 QR 코드가 없으면 새로 생성
      const result = await generateQRCodeAction();
      if (result.success && result.qrCodeUrl) {
        setQrCodeUrl(result.qrCodeUrl);
        // 생성 후 다시 활성 QR 코드 정보 조회
        const updatedResult = await getActiveQRCodeAction();
        if (updatedResult.success && updatedResult.data) {
          setQrCodeInfo(updatedResult.data);
        }
      } else {
        setError(result.error || "QR 코드 생성에 실패했습니다.");
      }
    } catch (err: any) {
      setError(err.message || "QR 코드 생성에 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadQRCode();
  }, [loadQRCode]);

  const handleDownload = () => {
    if (!qrCodeUrl) return;

    const link = document.createElement("a");
    link.href = qrCodeUrl;
    link.download = "attendance-qr-code.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handlePrint = () => {
    if (!qrCodeUrl) return;

    const printWindow = window.open("", "_blank");
    if (printWindow) {
      printWindow.document.write(`
        <html>
          <head>
            <title>출석용 QR 코드</title>
            <style>
              body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                font-family: Arial, sans-serif;
              }
              .qr-container {
                text-align: center;
              }
              .qr-code {
                max-width: 400px;
                margin: 20px 0;
              }
              .instructions {
                margin-top: 20px;
                font-size: 14px;
                color: rgb(107 114 128);
              }
            </style>
          </head>
          <body>
            <div class="qr-container">
              <h1>출석용 QR 코드</h1>
              <img src="${qrCodeUrl}" alt="QR Code" class="qr-code" />
              <div class="instructions">
                <p>이 QR 코드를 학원 입구에 부착하세요.</p>
                <p>학생들이 이 QR 코드를 스캔하여 출석을 체크합니다.</p>
              </div>
            </div>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
  };

  if (loading) {
    return (
      <Card>
        <CardContent>
          <div className="text-center py-8">
            <div className="text-sm text-gray-500">QR 코드 생성 중...</div>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent>
          <div className="flex flex-col gap-4">
            <div className="rounded-lg bg-red-50 p-4 text-sm text-red-600">
              {error}
            </div>
            <Button onClick={loadQRCode}>
              다시 시도
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader title="QR 코드" />
      <CardContent>
        <div className="space-y-6">
          {qrCodeUrl && (
            <div className="flex justify-center">
              <img
                src={qrCodeUrl}
                alt="출석용 QR 코드"
                className="rounded-lg border border-gray-200"
              />
            </div>
          )}

          <div className="flex flex-col gap-3 sm:flex-row">
            <Button onClick={loadQRCode} variant="outline" className="flex-1">
              새로고침
            </Button>
            <Button
              onClick={handleDownload}
              variant="outline"
              className="flex-1"
            >
              다운로드
            </Button>
            <Button onClick={handlePrint} variant="outline" className="flex-1">
              인쇄
            </Button>
          </div>

          {qrCodeInfo && (
            <div className="flex flex-col gap-2 rounded-lg bg-gray-50 p-4 text-sm">
              <p className="font-semibold text-gray-900">QR 코드 정보:</p>
              <div className="flex flex-col gap-1 text-gray-700">
                <p>
                  생성 시간:{" "}
                  {new Date(qrCodeInfo.created_at).toLocaleString("ko-KR")}
                </p>
                <p>
                  만료 시간:{" "}
                  {new Date(qrCodeInfo.expires_at).toLocaleString("ko-KR")}
                </p>
                <p>사용 횟수: {qrCodeInfo.usage_count}회</p>
                {qrCodeInfo.last_used_at && (
                  <p>
                    마지막 사용:{" "}
                    {new Date(qrCodeInfo.last_used_at).toLocaleString("ko-KR")}
                  </p>
                )}
              </div>
            </div>
          )}

          <div className="flex flex-col gap-2 rounded-lg bg-blue-50 p-4 text-sm text-blue-800">
            <p className="font-semibold">사용 방법:</p>
            <ul className="list-disc list-inside flex flex-col gap-1 text-blue-700">
              <li>이 QR 코드를 출력하여 학원 입구에 부착하세요.</li>
              <li>학생들이 출석 체크 페이지에서 이 QR 코드를 스캔합니다.</li>
              <li>QR 코드는 24시간마다 갱신하는 것을 권장합니다.</li>
              <li>
                새 QR 코드를 생성하면 이전 QR 코드는 자동으로 비활성화됩니다.
              </li>
            </ul>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/qr-code/manage/_components/QRCodeManageContent.tsx">
"use client";

import { useState, useEffect, useCallback } from "react";
import {
  getQRCodeHistoryAction,
  deactivateQRCodeAction,
} from "@/app/(admin)/actions/qrCodeActions";
import Button from "@/components/atoms/Button";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import type { QRCodeRecord } from "@/lib/services/qrCodeService";

export function QRCodeManageContent() {
  const [history, setHistory] = useState<QRCodeRecord[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [deactivating, setDeactivating] = useState<string | null>(null);

  const loadHistory = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const result = await getQRCodeHistoryAction(50);
      if (result.success && result.data) {
        setHistory(result.data);
      } else {
        setError(result.error || "QR 코드 이력을 불러올 수 없습니다.");
      }
    } catch (err: unknown) {
      const errorMessage = err instanceof Error ? err.message : "QR 코드 이력을 불러올 수 없습니다.";
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadHistory();
  }, [loadHistory]);

  const handleDeactivate = async (qrCodeId: string) => {
    if (!confirm("이 QR 코드를 비활성화하시겠습니까?")) {
      return;
    }

    setDeactivating(qrCodeId);
    try {
      const result = await deactivateQRCodeAction(qrCodeId);
      if (result.success) {
        await loadHistory();
      } else {
        alert(result.error || "QR 코드 비활성화에 실패했습니다.");
      }
    } catch (err: unknown) {
      const errorMessage = err instanceof Error ? err.message : "QR 코드 비활성화 중 오류가 발생했습니다.";
      alert(errorMessage);
    } finally {
      setDeactivating(null);
    }
  };

  if (loading) {
    return (
      <Card>
        <CardContent>
          <div className="text-center py-8">
            <div className="text-sm text-gray-500">로딩 중...</div>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent>
          <div className="flex flex-col gap-4">
            <div className="rounded-lg bg-red-50 p-4 text-sm text-red-600">
              {error}
            </div>
            <Button onClick={loadHistory}>
              다시 시도
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader title="QR 코드 이력" />
      <CardContent>
        {history.length === 0 ? (
          <div className="text-center py-8">
            <p className="text-sm text-gray-500">생성된 QR 코드가 없습니다.</p>
          </div>
        ) : (
          <div className="space-y-4">
            {history.map((qrCode) => {
              const isExpired = new Date(qrCode.expires_at) < new Date();
              const isActive = qrCode.is_active && !isExpired;

              return (
                <div
                  key={qrCode.id}
                  className="rounded-lg border border-gray-200 p-4"
                >
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1 space-y-2">
                      <div className="flex items-center gap-2">
                        <span
                          className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                            isActive
                              ? "bg-green-100 text-green-800"
                              : "bg-gray-100 text-gray-800"
                          }`}
                        >
                          {isActive ? "활성" : "비활성"}
                        </span>
                        {isExpired && (
                          <span className="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-red-100 text-red-800">
                            만료됨
                          </span>
                        )}
                      </div>

                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <p className="text-gray-500">생성 시간</p>
                          <p className="font-medium text-gray-900">
                            {new Date(qrCode.created_at).toLocaleString(
                              "ko-KR"
                            )}
                          </p>
                        </div>
                        <div>
                          <p className="text-gray-500">만료 시간</p>
                          <p className="font-medium text-gray-900">
                            {new Date(qrCode.expires_at).toLocaleString(
                              "ko-KR"
                            )}
                          </p>
                        </div>
                        <div>
                          <p className="text-gray-500">사용 횟수</p>
                          <p className="font-medium text-gray-900">
                            {qrCode.usage_count}회
                          </p>
                        </div>
                        {qrCode.last_used_at && (
                          <div>
                            <p className="text-gray-500">마지막 사용</p>
                            <p className="font-medium text-gray-900">
                              {new Date(qrCode.last_used_at).toLocaleString(
                                "ko-KR"
                              )}
                            </p>
                          </div>
                        )}
                      </div>

                      {qrCode.deactivated_at && (
                        <div className="text-xs text-gray-500">
                          비활성화:{" "}
                          {new Date(qrCode.deactivated_at).toLocaleString(
                            "ko-KR"
                          )}
                        </div>
                      )}
                    </div>

                    {isActive && (
                      <Button
                        onClick={() => handleDeactivate(qrCode.id)}
                        variant="outline"
                        disabled={deactivating === qrCode.id}
                        isLoading={deactivating === qrCode.id}
                      >
                        비활성화
                      </Button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/qr-code/manage/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { QRCodeManageContent } from "./_components/QRCodeManageContent";

export const dynamic = "force-dynamic";

export default async function QRCodeManagePage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-3xl font-bold text-gray-900">QR 코드 관리</h1>
        <p className="text-sm text-gray-600">
          QR 코드 생성 이력 및 사용 통계를 확인하고 관리할 수 있습니다.
        </p>
      </div>

      <QRCodeManageContent />
    </div>
  );
}
</file>

<file path="admin/attendance/qr-code/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { QRCodeDisplay } from "./_components/QRCodeDisplay";

export const dynamic = "force-dynamic";

export default async function QRCodePage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-3xl font-bold text-gray-900">출석용 QR 코드</h1>
        <p className="text-sm text-gray-600">
          이 QR 코드를 출력하여 학원 입구에 부착하세요.
        </p>
      </div>

      <QRCodeDisplay />
    </div>
  );
}
</file>

<file path="admin/attendance/settings/_components/AttendanceSettingsTabs.tsx">
"use client";

import { useState } from "react";
import { Card, CardContent } from "@/components/molecules/Card";

type AttendanceSettingsTabsProps = {
  locationForm: React.ReactNode;
  smsForm: React.ReactNode;
};

export function AttendanceSettingsTabs({
  locationForm,
  smsForm,
}: AttendanceSettingsTabsProps) {
  const [activeTab, setActiveTab] = useState<"location" | "sms">("location");

  return (
    <div className="space-y-6">
      {/* 탭 네비게이션 */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          <button
            onClick={() => setActiveTab("location")}
            className={`
              py-4 px-1 border-b-2 font-medium text-sm transition-colors
              ${
                activeTab === "location"
                  ? "border-blue-500 text-blue-600"
                  : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              }
            `}
          >
            위치 설정
          </button>
          <button
            onClick={() => setActiveTab("sms")}
            className={`
              py-4 px-1 border-b-2 font-medium text-sm transition-colors
              ${
                activeTab === "sms"
                  ? "border-blue-500 text-blue-600"
                  : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              }
            `}
          >
            SMS 알림 설정
          </button>
        </nav>
      </div>

      {/* 탭 컨텐츠 */}
      <div>
        {activeTab === "location" && locationForm}
        {activeTab === "sms" && smsForm}
      </div>
    </div>
  );
}
</file>

<file path="admin/attendance/settings/_components/AttendanceSMSSettingsForm.tsx">
"use client";

import { useState, useEffect, useCallback } from "react";
import {
  getAttendanceSMSSettings,
  updateAttendanceSMSSettings,
} from "@/app/(admin)/actions/attendanceSettingsActions";
import Button from "@/components/atoms/Button";
import Label from "@/components/atoms/Label";
import ToggleSwitch from "@/components/atoms/ToggleSwitch";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import { Badge } from "@/components/atoms/Badge";
import { AlertTriangle } from "lucide-react";

export function AttendanceSMSSettingsForm() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [formData, setFormData] = useState({
    attendance_sms_check_in_enabled: true,
    attendance_sms_check_out_enabled: true,
    attendance_sms_absent_enabled: true,
    attendance_sms_late_enabled: true,
    attendance_sms_student_checkin_enabled: false,
    attendance_sms_recipient: 'auto' as 'mother' | 'father' | 'both' | 'auto',
    attendance_sms_show_failure_to_user: false,
  });

  const loadSettings = useCallback(async () => {
    setLoading(true);
    try {
      const result = await getAttendanceSMSSettings();
      if (result.success && result.data) {
        setFormData({
          attendance_sms_check_in_enabled:
            result.data.attendance_sms_check_in_enabled ?? true,
          attendance_sms_check_out_enabled:
            result.data.attendance_sms_check_out_enabled ?? true,
          attendance_sms_absent_enabled:
            result.data.attendance_sms_absent_enabled ?? true,
          attendance_sms_late_enabled:
            result.data.attendance_sms_late_enabled ?? true,
          attendance_sms_student_checkin_enabled:
            result.data.attendance_sms_student_checkin_enabled ?? false,
          attendance_sms_recipient:
            result.data.attendance_sms_recipient ?? 'auto',
          attendance_sms_show_failure_to_user:
            result.data.attendance_sms_show_failure_to_user ?? false,
        });
      }
    } catch (err: any) {
      setError(err.message || "SMS 설정을 불러올 수 없습니다.");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadSettings();
  }, [loadSettings]);

  const handleRecipientChange = (value: string) => {
    setFormData({
      ...formData,
      attendance_sms_recipient: value as 'mother' | 'father' | 'both' | 'auto',
    });
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    setSuccess(false);

    // 폼 데이터 유효성 검증
    const validRecipientValues = ['mother', 'father', 'both', 'auto'] as const;
    if (!validRecipientValues.includes(formData.attendance_sms_recipient)) {
      setError('SMS 수신자 선택 값이 올바르지 않습니다.');
      setSaving(false);
      return;
    }

    try {
      console.log('[AttendanceSMSSettingsForm] 폼 제출 데이터:', formData);
      const result = await updateAttendanceSMSSettings(formData);
      console.log('[AttendanceSMSSettingsForm] 서버 응답:', result);

      if (result.success) {
        setSuccess(true);
        setError(null);
        // 저장 성공 후 설정 다시 로드
        await loadSettings();
        setTimeout(() => setSuccess(false), 3000);
      } else {
        // 서버에서 반환된 에러 메시지 표시
        const errorMessage = result.error || "SMS 설정 저장에 실패했습니다.";
        console.error('[AttendanceSMSSettingsForm] 저장 실패:', errorMessage);
        setError(errorMessage);
      }
    } catch (err: any) {
      // 네트워크 에러 또는 예상치 못한 에러 처리
      console.error('[AttendanceSMSSettingsForm] 예외 발생:', err);
      
      let errorMessage = "SMS 설정 저장 중 오류가 발생했습니다.";
      
      if (err instanceof Error) {
        errorMessage = err.message;
      } else if (typeof err === 'string') {
        errorMessage = err;
      } else if (err?.message) {
        errorMessage = err.message;
      }
      
      // 네트워크 에러인지 확인
      if (err?.name === 'NetworkError' || err?.code === 'ECONNREFUSED' || err?.code === 'ETIMEDOUT') {
        errorMessage = "네트워크 연결에 문제가 있습니다. 인터넷 연결을 확인하고 다시 시도해주세요.";
      }
      
      setError(errorMessage);
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <Card>
        <CardContent>
          <div className="text-center py-8">
            <div className="text-sm text-gray-500">로딩 중...</div>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader title="출석 SMS 알림 설정" />
      <CardContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-6">
          <div className="flex flex-col gap-4">
            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <Label htmlFor="check_in_enabled">입실 알림</Label>
                <p className="text-xs text-gray-500">
                  학생이 입실할 때 학부모에게 SMS를 발송합니다.
                  <br />
                  <span className="text-gray-400">
                    ※ 관리자가 직접 체크인한 경우에만 발송됩니다. 학생이 직접
                    체크인한 경우는 "학생 직접 체크인 시 발송" 설정도 확인해야
                    합니다.
                  </span>
                </p>
              </div>
              <ToggleSwitch
                id="check_in_enabled"
                checked={formData.attendance_sms_check_in_enabled}
                onCheckedChange={(checked) =>
                  setFormData({
                    ...formData,
                    attendance_sms_check_in_enabled: checked,
                  })
                }
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <Label htmlFor="check_out_enabled">퇴실 알림</Label>
                <p className="text-xs text-gray-500">
                  학생이 퇴실할 때 학부모에게 SMS를 발송합니다.
                  <br />
                  <span className="text-gray-400">
                    ※ 관리자가 직접 체크아웃한 경우에만 발송됩니다. 학생이 직접
                    체크아웃한 경우는 "학생 직접 체크인 시 발송" 설정도 확인해야
                    합니다.
                  </span>
                </p>
              </div>
              <ToggleSwitch
                id="check_out_enabled"
                checked={formData.attendance_sms_check_out_enabled}
                onCheckedChange={(checked) =>
                  setFormData({
                    ...formData,
                    attendance_sms_check_out_enabled: checked,
                  })
                }
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <Label htmlFor="absent_enabled">결석 알림</Label>
                <p className="text-xs text-gray-500">
                  학생이 결석할 때 학부모에게 SMS를 발송합니다.
                </p>
              </div>
              <ToggleSwitch
                id="absent_enabled"
                checked={formData.attendance_sms_absent_enabled}
                onCheckedChange={(checked) =>
                  setFormData({
                    ...formData,
                    attendance_sms_absent_enabled: checked,
                  })
                }
              />
            </div>

            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <Label htmlFor="late_enabled">지각 알림</Label>
                <p className="text-xs text-gray-500">
                  학생이 지각할 때 학부모에게 SMS를 발송합니다.
                </p>
              </div>
              <ToggleSwitch
                id="late_enabled"
                checked={formData.attendance_sms_late_enabled}
                onCheckedChange={(checked) =>
                  setFormData({
                    ...formData,
                    attendance_sms_late_enabled: checked,
                  })
                }
              />
            </div>

            <div className="flex items-center justify-between pt-4 border-t">
              <div className="flex flex-col gap-1 flex-1">
                <div className="flex items-center gap-2">
                  <Label htmlFor="student_checkin_enabled">
                    학생 직접 체크인 시 발송
                  </Label>
                  {!formData.attendance_sms_student_checkin_enabled && (
                    <Badge variant="warning" size="xs">
                      <AlertTriangle className="h-3 w-3" />
                      중요
                    </Badge>
                  )}
                </div>
                <p className="text-xs text-gray-500">
                  학생이 QR코드나 위치로 직접 체크인/퇴실할 때도 SMS를
                  발송합니다.
                </p>
                {!formData.attendance_sms_student_checkin_enabled && (
                  <div className="rounded-lg bg-amber-50 border border-amber-200 p-2">
                    <p className="text-xs text-amber-800">
                      ⚠️ 이 설정이 꺼져 있으면 학생이 직접 체크인해도 SMS가
                      발송되지 않습니다. "입실 알림"이 켜져 있어도 이 설정이
                      꺼져 있으면 발송되지 않으니 주의하세요.
                    </p>
                  </div>
                )}
              </div>
              <ToggleSwitch
                id="student_checkin_enabled"
                checked={formData.attendance_sms_student_checkin_enabled}
                onCheckedChange={(checked) =>
                  setFormData({
                    ...formData,
                    attendance_sms_student_checkin_enabled: checked,
                  })
                }
              />
            </div>

            <div className="flex items-center justify-between pt-4 border-t">
              <div className="flex flex-col gap-1">
                <Label htmlFor="show_failure_to_user">
                  SMS 발송 실패 시 사용자에게 알림
                </Label>
                <p className="text-xs text-gray-500">
                  SMS 발송에 실패한 경우 사용자에게 경고 메시지를 표시합니다.
                  <br />
                  <span className="text-gray-400">
                    (출석 기록은 정상 저장됩니다.)
                  </span>
                </p>
              </div>
              <ToggleSwitch
                id="show_failure_to_user"
                checked={formData.attendance_sms_show_failure_to_user}
                onCheckedChange={(checked) =>
                  setFormData({
                    ...formData,
                    attendance_sms_show_failure_to_user: checked,
                  })
                }
              />
            </div>

            <div className="pt-4 border-t">
              <div className="flex flex-col gap-3">
                <div className="flex flex-col gap-1">
                  <Label htmlFor="sms_recipient">SMS 수신자 선택</Label>
                  <p className="text-xs text-gray-500">
                    출석 알림 SMS를 받을 학부모를 선택하세요.
                  </p>
                </div>
                <div className="space-y-2">
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input
                      type="radio"
                      name="sms_recipient"
                      value="auto"
                      checked={formData.attendance_sms_recipient === 'auto'}
                      onChange={(e) => handleRecipientChange(e.target.value)}
                      className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">
                      자동 (먼저 있는 번호)
                    </span>
                  </label>
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input
                      type="radio"
                      name="sms_recipient"
                      value="mother"
                      checked={formData.attendance_sms_recipient === 'mother'}
                      onChange={(e) => handleRecipientChange(e.target.value)}
                      className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">어머니만</span>
                  </label>
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input
                      type="radio"
                      name="sms_recipient"
                      value="father"
                      checked={formData.attendance_sms_recipient === 'father'}
                      onChange={(e) => handleRecipientChange(e.target.value)}
                      className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">아버지만</span>
                  </label>
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input
                      type="radio"
                      name="sms_recipient"
                      value="both"
                      checked={formData.attendance_sms_recipient === 'both'}
                      onChange={(e) => handleRecipientChange(e.target.value)}
                      className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">둘 다</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          {error && (
            <div className="rounded-lg bg-red-50 p-3 text-sm text-red-600">
              {error}
            </div>
          )}

          {success && (
            <div className="rounded-lg bg-green-50 p-3 text-sm text-green-600">
              SMS 설정이 저장되었습니다.
            </div>
          )}

          <Button
            type="submit"
            disabled={saving}
            isLoading={saving}
            className="w-full"
          >
            저장
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/settings/_components/LocationSettingsForm.tsx">
"use client";

import { useState, useEffect, useCallback } from "react";
import {
  getLocationSettings,
  updateLocationSettings,
} from "@/app/(admin)/actions/attendanceSettingsActions";
import Button from "@/components/atoms/Button";
import Input from "@/components/atoms/Input";
import Label from "@/components/atoms/Label";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";

export function LocationSettingsForm() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [formData, setFormData] = useState({
    latitude: "",
    longitude: "",
    radiusMeters: "100",
  });

  const loadSettings = useCallback(async () => {
    setLoading(true);
    try {
      const result = await getLocationSettings();
      if (result.success && result.data) {
        setFormData({
          latitude: result.data.latitude?.toString() || "",
          longitude: result.data.longitude?.toString() || "",
          radiusMeters: result.data.radiusMeters?.toString() || "100",
        });
      }
    } catch (err: any) {
      setError(err.message || "위치 설정을 불러올 수 없습니다.");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadSettings();
  }, [loadSettings]);

  const handleGetCurrentLocation = () => {
    if (!navigator.geolocation) {
      setError("브라우저가 위치 서비스를 지원하지 않습니다.");
      return;
    }

    setError(null);
    navigator.geolocation.getCurrentPosition(
      (position) => {
        setFormData({
          ...formData,
          latitude: position.coords.latitude.toFixed(8),
          longitude: position.coords.longitude.toFixed(8),
        });
      },
      (err) => {
        let errorMessage = "위치를 가져올 수 없습니다.";
        if (err.code === 1) {
          errorMessage =
            "위치 권한이 필요합니다. 브라우저 설정에서 위치 권한을 허용해주세요.";
        } else if (err.code === 2) {
          errorMessage =
            "위치를 가져올 수 없습니다. GPS가 켜져 있는지 확인해주세요.";
        }
        setError(errorMessage);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
      }
    );
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    setSuccess(false);

    try {
      const latitude = parseFloat(formData.latitude);
      const longitude = parseFloat(formData.longitude);
      const radiusMeters = parseInt(formData.radiusMeters, 10);

      if (isNaN(latitude) || isNaN(longitude) || isNaN(radiusMeters)) {
        setError("모든 필드를 올바르게 입력해주세요.");
        setSaving(false);
        return;
      }

      const result = await updateLocationSettings({
        latitude,
        longitude,
        radiusMeters,
      });

      if (result.success) {
        setSuccess(true);
        setTimeout(() => setSuccess(false), 3000);
      } else {
        setError(result.error || "위치 설정 저장에 실패했습니다.");
      }
    } catch (err: any) {
      setError(err.message || "위치 설정 저장 중 오류가 발생했습니다.");
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <Card>
        <CardContent>
          <div className="text-center py-8">
            <div className="text-sm text-gray-500">로딩 중...</div>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader title="위치 설정" />
      <CardContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-6">
          <div className="flex flex-col gap-1">
            <Label htmlFor="latitude">위도 (Latitude) *</Label>
            <Input
              id="latitude"
              type="number"
              step="any"
              value={formData.latitude}
              onChange={(e) =>
                setFormData({ ...formData, latitude: e.target.value })
              }
              placeholder="37.5665"
              required
            />
            <p className="text-xs text-gray-500">위도 범위: -90 ~ 90</p>
          </div>

          <div className="flex flex-col gap-1">
            <Label htmlFor="longitude">경도 (Longitude) *</Label>
            <Input
              id="longitude"
              type="number"
              step="any"
              value={formData.longitude}
              onChange={(e) =>
                setFormData({ ...formData, longitude: e.target.value })
              }
              placeholder="126.9780"
              required
            />
            <p className="text-xs text-gray-500">경도 범위: -180 ~ 180</p>
          </div>

          <div>
            <Button
              type="button"
              onClick={handleGetCurrentLocation}
              variant="outline"
              className="w-full"
            >
              현재 위치 가져오기
            </Button>
          </div>

          <div>
            <Label htmlFor="radiusMeters">출석 인정 반경 (미터) *</Label>
            <Input
              id="radiusMeters"
              type="number"
              min="1"
              value={formData.radiusMeters}
              onChange={(e) =>
                setFormData({ ...formData, radiusMeters: e.target.value })
              }
              placeholder="100"
              required
            />
            <p className="text-xs text-gray-500">
              학생이 이 반경 내에 있어야 출석이 인정됩니다. (기본값: 100m)
            </p>
          </div>

          {error && (
            <div className="rounded-lg bg-red-50 p-3 text-sm text-red-600">
              {error}
            </div>
          )}

          {success && (
            <div className="rounded-lg bg-green-50 p-3 text-sm text-green-600">
              위치 설정이 저장되었습니다.
            </div>
          )}

          <Button
            type="submit"
            disabled={saving}
            isLoading={saving}
            className="w-full"
          >
            저장
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/settings/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { LocationSettingsForm } from "./_components/LocationSettingsForm";
import { AttendanceSMSSettingsForm } from "./_components/AttendanceSMSSettingsForm";
import { AttendanceSettingsTabs } from "./_components/AttendanceSettingsTabs";

export const dynamic = "force-dynamic";

export default async function AttendanceSettingsPage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-3xl font-bold text-gray-900">출석 설정</h1>
        <p className="text-sm text-gray-600">
          출석 관련 위치 및 SMS 알림 설정을 관리할 수 있습니다.
        </p>
      </div>

      <AttendanceSettingsTabs
        locationForm={<LocationSettingsForm />}
        smsForm={<AttendanceSMSSettingsForm />}
      />
    </div>
  );
}
</file>

<file path="admin/attendance/sms-logs/_components/SMSLogsFilters.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import Button from "@/components/atoms/Button";
import Label from "@/components/atoms/Label";
import { Card, CardContent } from "@/components/molecules/Card";
import type { SMSLogFilter } from "@/app/(admin)/actions/smsLogActions";

type SMSLogsFiltersProps = {
  currentFilters: SMSLogFilter;
};

export function SMSLogsFilters({ currentFilters }: SMSLogsFiltersProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [filters, setFilters] = useState<SMSLogFilter>(currentFilters);

  const handleFilterChange = (key: keyof SMSLogFilter, value: string | undefined) => {
    setFilters((prev) => ({
      ...prev,
      [key]: value || undefined,
    }));
  };

  const handleApplyFilters = () => {
    startTransition(() => {
      const params = new URLSearchParams();
      
      if (filters.startDate) params.set("startDate", filters.startDate);
      if (filters.endDate) params.set("endDate", filters.endDate);
      if (filters.studentId) params.set("studentId", filters.studentId);
      if (filters.status) params.set("status", filters.status);
      if (filters.smsType) params.set("smsType", filters.smsType);
      params.set("page", "1"); // 필터 적용 시 첫 페이지로

      router.push(`?${params.toString()}`);
    });
  };

  const handleResetFilters = () => {
    setFilters({});
    startTransition(() => {
      router.push("?page=1");
    });
  };

  return (
    <Card>
      <CardContent>
        <div className="grid gap-4 md:grid-cols-5">
          <div className="flex flex-col gap-1">
            <Label htmlFor="startDate">시작 날짜</Label>
            <input
              type="date"
              id="startDate"
              value={filters.startDate || ""}
              onChange={(e) => handleFilterChange("startDate", e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            />
          </div>
          <div className="flex flex-col gap-1">
            <Label htmlFor="endDate">종료 날짜</Label>
            <input
              type="date"
              id="endDate"
              value={filters.endDate || ""}
              onChange={(e) => handleFilterChange("endDate", e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            />
          </div>
          <div className="flex flex-col gap-1">
            <Label htmlFor="status">상태</Label>
            <select
              id="status"
              value={filters.status || ""}
              onChange={(e) => handleFilterChange("status", e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            >
              <option value="">전체</option>
              <option value="pending">대기</option>
              <option value="sent">발송됨</option>
              <option value="delivered">전달됨</option>
              <option value="failed">실패</option>
            </select>
          </div>
          <div className="flex flex-col gap-1">
            <Label htmlFor="smsType">SMS 타입</Label>
            <select
              id="smsType"
              value={filters.smsType || ""}
              onChange={(e) => handleFilterChange("smsType", e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            >
              <option value="">전체</option>
              <option value="attendance_check_in">입실</option>
              <option value="attendance_check_out">퇴실</option>
              <option value="attendance_absent">결석</option>
              <option value="attendance_late">지각</option>
            </select>
          </div>
          <div className="flex items-end gap-2">
            <Button
              onClick={handleApplyFilters}
              disabled={isPending}
              className="flex-1"
            >
              적용
            </Button>
            <Button
              variant="outline"
              onClick={handleResetFilters}
              disabled={isPending}
            >
              초기화
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/sms-logs/_components/SMSLogsPagination.tsx">
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import Button from "@/components/atoms/Button";

type SMSLogsPaginationProps = {
  currentPage: number;
  totalPages: number;
};

export function SMSLogsPagination({
  currentPage,
  totalPages,
}: SMSLogsPaginationProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const handlePageChange = (newPage: number) => {
    const params = new URLSearchParams(searchParams.toString());
    params.set("page", String(newPage));
    router.push(`?${params.toString()}`);
  };

  if (totalPages <= 1) {
    return null;
  }

  return (
    <div className="flex items-center justify-center gap-2">
      <Button
        variant="outline"
        disabled={currentPage <= 1}
        onClick={() => handlePageChange(currentPage - 1)}
      >
        이전
      </Button>
      <span className="text-sm text-gray-600">
        {currentPage} / {totalPages}
      </span>
      <Button
        variant="outline"
        disabled={currentPage >= totalPages}
        onClick={() => handlePageChange(currentPage + 1)}
      >
        다음
      </Button>
    </div>
  );
}
</file>

<file path="admin/attendance/sms-logs/_components/SMSLogsTable.tsx">
"use client";

import { useState } from "react";
import { Badge } from "@/components/atoms/Badge";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import { maskPhoneNumber } from "@/lib/utils/phoneMasking";
import type { SMSLog } from "@/app/(admin)/actions/smsLogActions";

type SMSLogsTableProps = {
  logs: SMSLog[];
  loading?: boolean;
};

export function SMSLogsTable({ logs, loading }: SMSLogsTableProps) {
  const getStatusBadge = (status: SMSLog["status"]) => {
    switch (status) {
      case "sent":
      case "delivered":
        return <Badge variant="success" size="xs">성공</Badge>;
      case "failed":
        return <Badge variant="error" size="xs">실패</Badge>;
      case "pending":
        return <Badge variant="info" size="xs">대기</Badge>;
      default:
        return <Badge variant="gray" size="xs">{status}</Badge>;
    }
  };

  const getSMSType = (message: string): string => {
    if (message.includes("입실")) return "입실";
    if (message.includes("퇴실")) return "퇴실";
    if (message.includes("결석")) return "결석";
    if (message.includes("지각")) return "지각";
    return "기타";
  };

  const formatDateTime = (dateString: string | null): string => {
    if (!dateString) return "-";
    const date = new Date(dateString);
    return date.toLocaleString("ko-KR", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  if (loading) {
    return (
      <Card>
        <CardContent>
          <div className="text-center py-8">
            <div className="text-sm text-gray-500">로딩 중...</div>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (logs.length === 0) {
    return (
      <Card>
        <CardContent>
          <div className="text-center py-8">
            <div className="text-sm text-gray-500">SMS 로그가 없습니다.</div>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader title="SMS 발송 로그" />
      <CardContent>
        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr className="border-b border-gray-200">
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  발송 시간
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  학생명
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  수신자 번호
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  SMS 타입
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  상태
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  메시지
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  에러
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {logs.map((log) => (
                <tr key={log.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 text-sm text-gray-900">
                    {formatDateTime(log.sent_at || log.created_at)}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-900">
                    {log.student_name || "-"}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {maskPhoneNumber(log.recipient_phone)}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-900">
                    {getSMSType(log.message_content)}
                  </td>
                  <td className="px-4 py-3">
                    {getStatusBadge(log.status)}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">
                    {log.message_content}
                  </td>
                  <td className="px-4 py-3 text-sm text-red-600 max-w-xs truncate">
                    {log.error_message || "-"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/attendance/sms-logs/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { getAttendanceSMSLogs } from "@/app/(admin)/actions/smsLogActions";
import { SMSLogsTable } from "./_components/SMSLogsTable";
import { Card, CardContent } from "@/components/molecules/Card";
import { SMSLogsFilters } from "./_components/SMSLogsFilters";
import { SMSLogsPagination } from "./_components/SMSLogsPagination";
import { PageHeader } from "@/components/layout/PageHeader";

export default async function SMSLogsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const params = await searchParams;
  const page = parseInt(params.page || "1", 10);
  const pageSize = 50;

  // 필터 파라미터 파싱
  const filters = {
    startDate: params.startDate,
    endDate: params.endDate,
    studentId: params.studentId,
    status: params.status as "pending" | "sent" | "delivered" | "failed" | undefined,
    smsType: params.smsType as
      | "attendance_check_in"
      | "attendance_check_out"
      | "attendance_absent"
      | "attendance_late"
      | undefined,
  };

  // SMS 로그 조회
  const result = await getAttendanceSMSLogs(filters, page, pageSize);

  if (!result.success) {
    return (
      <div className="p-6 md:p-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-6 text-center text-red-700">
          {result.error || "SMS 로그를 불러올 수 없습니다."}
        </div>
      </div>
    );
  }

  const logs = result.data || [];
  const total = result.total || 0;
  const totalPages = Math.ceil(total / pageSize);

  return (
    <div className="p-6 md:p-10">
      <div className="flex flex-col gap-6">
        <PageHeader
          title="출석 SMS 발송 로그"
          description="출석 관련 SMS 발송 이력을 확인할 수 있습니다."
        />

        {/* 필터 */}
        <SMSLogsFilters currentFilters={filters} />

        {/* 통계 */}
        <div className="grid grid-cols-1 gap-4 md:grid-cols-4">
          <Card>
            <CardContent>
              <div className="text-sm text-gray-500">전체 로그</div>
              <div className="text-2xl font-semibold text-gray-900">{total}</div>
            </CardContent>
          </Card>
          <Card>
            <CardContent>
              <div className="text-sm text-gray-500">성공</div>
              <div className="text-2xl font-semibold text-green-600">
                {logs.filter((log) => log.status === "sent" || log.status === "delivered").length}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent>
              <div className="text-sm text-gray-500">실패</div>
              <div className="text-2xl font-semibold text-red-600">
                {logs.filter((log) => log.status === "failed").length}
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent>
              <div className="text-sm text-gray-500">대기</div>
              <div className="text-2xl font-semibold text-amber-600">
                {logs.filter((log) => log.status === "pending").length}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* 로그 테이블 */}
        <SMSLogsTable logs={logs} />

        {/* 페이지네이션 */}
        <SMSLogsPagination currentPage={page} totalPages={totalPages} />
      </div>
    </div>
  );
}
</file>

<file path="admin/attendance/statistics/_components/DailyAttendanceChart.tsx">
"use client";

import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { AttendanceChartData } from "@/lib/domains/attendance/statistics";
import { getChartColor } from "@/lib/constants/colors";

type DailyAttendanceChartProps = {
  data: AttendanceChartData[];
};

export function DailyAttendanceChart({ data }: DailyAttendanceChartProps) {
  const { recharts, loading } = useRecharts();

  if (data.length === 0) {
    return (
      <div className="flex h-[300px] items-center justify-center text-sm text-gray-500">
        데이터가 없습니다.
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={300} />;
  }

  const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;

  return (
    <ResponsiveContainer width="100%" height={300}>
      <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis
          dataKey="date"
          tick={{ fontSize: 12 }}
          angle={-45}
          textAnchor="end"
          height={60}
        />
        <YAxis tick={{ fontSize: 12 }} />
        <Tooltip />
        <Legend />
        <Line type="monotone" dataKey="present" stroke={getChartColor(4)} name="출석" strokeWidth={2} />
        <Line type="monotone" dataKey="absent" stroke={getChartColor(6)} name="결석" strokeWidth={2} />
        <Line type="monotone" dataKey="late" stroke={getChartColor(3)} name="지각" strokeWidth={2} />
        <Line type="monotone" dataKey="early_leave" stroke={getChartColor(3)} name="조퇴" strokeWidth={2} />
        <Line type="monotone" dataKey="excused" stroke={getChartColor(5)} name="공결" strokeWidth={2} />
      </LineChart>
    </ResponsiveContainer>
  );
}
</file>

<file path="admin/attendance/statistics/_components/MethodStatisticsChart.tsx">
"use client";

import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { MethodStatistics } from "@/lib/domains/attendance/statistics";
import { getChartColor } from "@/lib/constants/colors";

type MethodStatisticsChartProps = {
  data: MethodStatistics[];
};

const METHOD_LABELS: Record<string, string> = {
  manual: "수동",
  qr: "QR 코드",
  location: "위치",
  auto: "자동",
};

export function MethodStatisticsChart({ data }: MethodStatisticsChartProps) {
  const { recharts, loading } = useRecharts();

  if (data.length === 0) {
    return (
      <div className="flex h-[300px] items-center justify-center text-sm text-gray-500">
        데이터가 없습니다.
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={300} />;
  }

  const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = recharts;

  const chartData = data.map((item) => ({
    name: METHOD_LABELS[item.method] || item.method,
    value: item.count,
    percentage: item.percentage,
  }));

  return (
    <ResponsiveContainer width="100%" height={300}>
      <PieChart>
        <Pie
          data={chartData}
          cx="50%"
          cy="50%"
          labelLine={false}
          label={({ name, percent }: any) => `${name}: ${(percent * 100).toFixed(1)}%`}
          outerRadius={80}
          fill={getChartColor(0)}
          dataKey="value"
        >
          {chartData.map((entry, index) => (
            <Cell key={`cell-${index}`} fill={getChartColor(index)} />
          ))}
        </Pie>
        <Tooltip />
        <Legend />
      </PieChart>
    </ResponsiveContainer>
  );
}
</file>

<file path="admin/attendance/statistics/_components/TimeDistributionChart.tsx">
"use client";

import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import type { TimeDistribution } from "@/lib/domains/attendance/statistics";
import { getChartColor } from "@/lib/constants/colors";

type TimeDistributionChartProps = {
  data: TimeDistribution[];
};

export function TimeDistributionChart({ data }: TimeDistributionChartProps) {
  const { recharts, loading } = useRecharts();

  if (data.length === 0) {
    return (
      <div className="flex h-[300px] items-center justify-center text-sm text-gray-500">
        데이터가 없습니다.
      </div>
    );
  }

  if (loading || !recharts) {
    return <ChartLoadingSkeleton height={300} />;
  }

  const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = recharts;

  const chartData = data.map((item) => ({
    hour: `${item.hour}시`,
    count: item.count,
  }));

  return (
    <ResponsiveContainer width="100%" height={300}>
      <AreaChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="hour" tick={{ fontSize: 12 }} />
        <YAxis tick={{ fontSize: 12 }} />
        <Tooltip />
        <Area
          type="monotone"
          dataKey="count"
          stroke={getChartColor(5)}
          fill={getChartColor(5)}
          fillOpacity={0.6}
        />
      </AreaChart>
    </ResponsiveContainer>
  );
}
</file>

<file path="admin/attendance/statistics/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import {
  getDailyAttendanceStats,
  getCheckInMethodStats,
  getCheckInTimeDistribution,
  getStudentAttendanceRanking,
} from "@/lib/domains/attendance/statistics";
import { DailyAttendanceChart } from "./_components/DailyAttendanceChart";
import { MethodStatisticsChart } from "./_components/MethodStatisticsChart";
import { TimeDistributionChart } from "./_components/TimeDistributionChart";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import Button from "@/components/atoms/Button";
import Input from "@/components/atoms/Input";

export default async function AttendanceStatisticsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();
  
  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }
  
  const params = await searchParams;
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);
  
  const startDate = params.start_date || thirtyDaysAgo.toISOString().slice(0, 10);
  const endDate = params.end_date || today.toISOString().slice(0, 10);
  const studentId = params.student_id;
  
  const [dailyStats, methodStats, timeDistribution, ranking] = await Promise.all([
    getDailyAttendanceStats(startDate, endDate, studentId),
    getCheckInMethodStats(startDate, endDate, studentId),
    getCheckInTimeDistribution(startDate, endDate, studentId),
    getStudentAttendanceRanking(startDate, endDate, 10),
  ]);
  
  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div>
        <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">출석 통계</h1>
      </div>
      
      {/* 필터 */}
      <div>
        <form method="get" className="flex flex-col gap-4 md:flex-row">
          <Input
            type="date"
            name="start_date"
            defaultValue={startDate}
            className="w-full md:w-auto"
          />
          <Input
            type="date"
            name="end_date"
            defaultValue={endDate}
            className="w-full md:w-auto"
          />
          <Button type="submit" variant="primary">
            조회
          </Button>
          {(params.start_date || params.end_date || params.student_id) && (
            <a
              href="/admin/attendance/statistics"
              className="rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-6 py-2 text-sm font-semibold text-gray-700 dark:text-gray-200 transition hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center justify-center"
            >
              초기화
            </a>
          )}
        </form>
      </div>
      
      {/* 차트 그리드 */}
      <div className="grid gap-6 md:grid-cols-2">
        <Card>
          <CardHeader title="일별 출석 통계" />
          <CardContent>
            <DailyAttendanceChart data={dailyStats} />
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader title="입실 방법별 통계" />
          <CardContent>
            <MethodStatisticsChart data={methodStats} />
          </CardContent>
        </Card>
        
        <Card className="md:col-span-2">
          <CardHeader title="시간대별 입실 분포" />
          <CardContent>
            <TimeDistributionChart data={timeDistribution} />
          </CardContent>
        </Card>
      </div>
      
      {/* 학생별 출석률 랭킹 */}
      <Card>
        <CardHeader title="학생별 출석률 랭킹" />
        <CardContent>
          {ranking.length === 0 ? (
            <div className="py-8 text-center text-sm text-gray-500">
              데이터가 없습니다.
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-gray-200 dark:border-gray-700">
                    <th className="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">순위</th>
                    <th className="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">학생명</th>
                    <th className="px-4 py-2 text-right text-sm font-semibold text-gray-900 dark:text-gray-100">출석률</th>
                  </tr>
                </thead>
                <tbody>
                  {ranking.map((student, index) => (
                    <tr key={student.student_id} className="border-b border-gray-100 dark:border-gray-800">
                      <td className="px-4 py-2 text-sm text-gray-700 dark:text-gray-300">{index + 1}</td>
                      <td className="px-4 py-2 text-sm text-gray-900 dark:text-gray-100">{student.student_name}</td>
                      <td className="px-4 py-2 text-right text-sm font-semibold text-gray-900 dark:text-gray-100">
                        {student.attendance_rate.toFixed(1)}%
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="admin/attendance/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { Suspense } from "react";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { getAttendanceRecords } from "@/lib/domains/attendance/service";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { EmptyState } from "@/components/ui/EmptyState";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import { PageHeader } from "@/components/layout/PageHeader";
import { SuspenseFallback } from "@/components/ui/LoadingSkeleton";
import {
  AttendanceRecordFormWithStudentSelect,
} from "./_components/AttendanceRecordForm";
import { AttendanceList } from "./_components/AttendanceList";
import { AttendanceStatistics } from "./_components/AttendanceStatistics";
import { AttendanceFilters as AttendanceFiltersComponent } from "./_components/AttendanceFilters";
import type {
  AttendanceFilters,
  AttendanceRecord,
} from "@/lib/domains/attendance/types";
import { calculateAttendanceStats } from "@/lib/domains/attendance/service";

type StudentRow = {
  id: string;
  name?: string | null;
};

type AttendancePageProps = {
  searchParams: Promise<Record<string, string | undefined>>;
};

async function AttendanceContent({
  searchParams,
}: {
  searchParams: Record<string, string | undefined>;
}) {
  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();

  if (!tenantContext?.tenantId) {
    return (
      <div className="rounded-xl border border-red-200 bg-red-50 p-8 text-center">
        <p className="text-sm text-red-700">기관 정보를 찾을 수 없습니다.</p>
      </div>
    );
  }

  // 필터 파라미터
  const studentIdFilter = searchParams.student_id?.trim() ?? "";
  const startDateFilter = searchParams.start_date?.trim() ?? "";
  const endDateFilter = searchParams.end_date?.trim() ?? "";
  const statusFilter = searchParams.status?.trim() ?? "";

  // 출석 기록 조회
  const filters: AttendanceFilters = {
    start_date: startDateFilter || undefined,
    end_date: endDateFilter || undefined,
    status: statusFilter
      ? (statusFilter as AttendanceFilters["status"])
      : undefined,
  };

  if (studentIdFilter) {
    filters.student_id = studentIdFilter;
  }

  let records: AttendanceRecord[] = [];
  try {
    records = await getAttendanceRecords(filters);
  } catch (error: any) {
    // 에러 객체 전체를 먼저 로깅
    console.error("[admin/attendance] 출석 기록 조회 실패 - 원본 에러:", error);
    console.error("[admin/attendance] 에러 타입:", typeof error);
    console.error("[admin/attendance] 에러 constructor:", error?.constructor?.name);
    
    // Supabase 에러 객체의 주요 속성 추출
    const errorInfo: Record<string, unknown> = {
      message: error?.message || error?.toString() || String(error) || "알 수 없는 에러",
      code: error?.code || "UNKNOWN",
      name: error?.name,
      stack: error?.stack,
    };
    
    // Supabase PostgrestError 속성 확인
    if (error && typeof error === "object") {
      if ("details" in error) {
        errorInfo.details = (error as { details?: unknown }).details;
      }
      if ("hint" in error) {
        errorInfo.hint = (error as { hint?: unknown }).hint;
      }
      if ("statusCode" in error) {
        errorInfo.statusCode = (error as { statusCode?: unknown }).statusCode;
      }
      // AppError 속성 확인
      if ("statusCode" in error && "code" in error) {
        errorInfo.appErrorCode = (error as { code?: unknown }).code;
        errorInfo.appErrorStatusCode = (error as { statusCode?: unknown }).statusCode;
      }
    }
    
    console.error("[admin/attendance] 출석 기록 조회 실패 - 상세 정보:", errorInfo);
    
    // 테이블이 없는 경우 (PGRST205, 42P01 에러 또는 AppError로 변환된 경우)
    const errorCode = error?.code || errorInfo.code;
    const errorMessage = error?.message || errorInfo.message || "";
    if (
      errorCode === "PGRST205" ||
      errorCode === "42P01" ||
      errorCode === "NOT_FOUND" ||
      errorMessage.includes("Could not find the table") ||
      errorMessage.includes("테이블")
    ) {
      return (
        <div className="p-6 md:p-10">
          <div className="flex flex-col gap-6 md:gap-8">
            <PageHeader title="출석 관리" />
            <div className="flex flex-col gap-2 rounded-xl border border-yellow-200 bg-yellow-50 p-8 text-center">
              <p className="text-sm font-medium text-yellow-800">
                출석 기록 테이블이 아직 생성되지 않았습니다.
              </p>
              <p className="text-xs text-yellow-700">
                데이터베이스 마이그레이션을 실행해주세요.
              </p>
              <p className="text-xs text-yellow-600">
                마이그레이션 파일: supabase/migrations/20250203000000_create_attendance_tables.sql
              </p>
              <p className="text-xs text-yellow-600">
                Supabase CLI: <code className="bg-yellow-100 px-1 rounded">supabase migration up</code>
              </p>
            </div>
          </div>
        </div>
      );
    }
  }

  // 학생 정보 조회
  const studentIds = [
    ...new Set(records.map((r) => r.student_id).filter(Boolean)),
  ];
  const { data: students } = await supabase
    .from("students")
    .select("id,name")
    .in("id", studentIds.length > 0 ? studentIds : [""]);

  const studentMap = new Map(
    (students ?? []).map((s: StudentRow) => [s.id, s.name ?? "이름 없음"])
  );

  // 전체 통계 계산 (필터링된 기록 기준)
  let overallStats = {
    total_days: 0,
    present_count: 0,
    absent_count: 0,
    late_count: 0,
    early_leave_count: 0,
    excused_count: 0,
    attendance_rate: 0,
    late_rate: 0,
    absent_rate: 0,
  };

  if (records.length > 0) {
    const totalDays = records.length;
    const presentCount = records.filter((r) => r.status === "present").length;
    const absentCount = records.filter((r) => r.status === "absent").length;
    const lateCount = records.filter((r) => r.status === "late").length;
    const earlyLeaveCount = records.filter(
      (r) => r.status === "early_leave"
    ).length;
    const excusedCount = records.filter((r) => r.status === "excused").length;

    overallStats = {
      total_days: totalDays,
      present_count: presentCount,
      absent_count: absentCount,
      late_count: lateCount,
      early_leave_count: earlyLeaveCount,
      excused_count: excusedCount,
      attendance_rate: totalDays > 0 ? (presentCount / totalDays) * 100 : 0,
      late_rate: totalDays > 0 ? (lateCount / totalDays) * 100 : 0,
      absent_rate: totalDays > 0 ? (absentCount / totalDays) * 100 : 0,
    };
  }

  // 학생 목록 조회 (출석 기록 입력 폼용)
  const { data: allStudents } = await supabase
    .from("students")
    .select("id,name")
    .eq("tenant_id", tenantContext.tenantId)
    .eq("is_active", true)
    .order("name", { ascending: true })
    .limit(100);

  return (
    <div className="p-6 md:p-10">
      <div className="flex flex-col gap-6 md:gap-8">
        <PageHeader title="출석 관리" />

        <div className="grid gap-6 md:grid-cols-2">
          {/* 출석 기록 입력 폼 */}
          <Card>
            <CardHeader title="출석 기록 입력" />
            <CardContent>
              {allStudents && allStudents.length > 0 ? (
                <AttendanceRecordFormWithStudentSelect
                  students={allStudents}
                />
              ) : (
                <p className="text-sm text-gray-500">등록된 학생이 없습니다.</p>
              )}
            </CardContent>
          </Card>

          {/* 출석 통계 */}
          <Card>
            <CardHeader title="전체 통계" />
            <CardContent>
              <AttendanceStatistics statistics={overallStats} />
            </CardContent>
          </Card>
        </div>

        {/* 필터 */}
        <AttendanceFiltersComponent
          startDateFilter={startDateFilter}
          endDateFilter={endDateFilter}
          statusFilter={statusFilter}
        />

        {/* 출석 기록 목록 */}
        {records.length === 0 ? (
          <EmptyState
            title="출석 기록이 없습니다"
            description="아직 등록된 출석 기록이 없습니다."
          />
        ) : (
          <AttendanceList records={records} studentMap={studentMap} />
        )}
      </div>
    </div>
  );
}

export default async function AdminAttendancePage({
  searchParams,
}: AttendancePageProps) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const params = await searchParams;

  return (
    <Suspense
      fallback={
        <div className="p-6 md:p-10">
          <div className="flex flex-col gap-6 md:gap-8">
            <PageHeader title="출석 관리" />
            <SuspenseFallback />
          </div>
        </div>
      }
    >
      <AttendanceContent searchParams={params} />
    </Suspense>
  );
}
</file>

<file path="admin/camp-templates/_components/TemplateCard.tsx">
"use client";

import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { CampTemplate } from "@/lib/types/plan";
import { deleteCampTemplateAction, updateCampTemplateStatusAction } from "@/app/(admin)/actions/campTemplateActions";
import { useToast } from "@/components/ui/ToastProvider";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";
import { MoreVertical } from "lucide-react";

type TemplateCardProps = {
  template: CampTemplate;
};

export function TemplateCard({ template }: TemplateCardProps) {
  const router = useRouter();
  const toast = useToast();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [currentStatus, setCurrentStatus] = useState<"draft" | "active" | "archived">(template.status);
  const [isChangingStatus, setIsChangingStatus] = useState(false);
  const [showDropdown, setShowDropdown] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);


  const confirmDelete = async () => {
    setIsDeleting(true);
    try {
      const result = await deleteCampTemplateAction(template.id);
      if (result.success) {
        toast.showSuccess("템플릿이 삭제되었습니다.");
        setShowDeleteDialog(false); // 다이얼로그 먼저 닫기
        setIsDeleting(false); // 상태 리셋
        router.push("/admin/camp-templates"); // 목록 페이지로 이동
      } else {
        toast.showError(result.error || "템플릿 삭제에 실패했습니다.");
        setIsDeleting(false);
      }
    } catch (error) {
      console.error("템플릿 삭제 실패:", error);
      const errorMessage =
        error instanceof Error ? error.message : "템플릿 삭제에 실패했습니다.";
      toast.showError(errorMessage);
      setIsDeleting(false);
    }
  };

  // 외부 클릭 시 드롭다운 닫기
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node)
      ) {
        setShowDropdown(false);
      }
    }

    if (showDropdown) {
      document.addEventListener("mousedown", handleClickOutside);
      return () => document.removeEventListener("mousedown", handleClickOutside);
    }
  }, [showDropdown]);

  const handleStatusChange = async (newStatus: "draft" | "active" | "archived") => {
    if (currentStatus === newStatus) {
      setShowDropdown(false);
      return;
    }
    
    setIsChangingStatus(true);
    setShowDropdown(false);
    try {
      const result = await updateCampTemplateStatusAction(template.id, newStatus);
      if (result.success) {
        setCurrentStatus(newStatus);
        toast.showSuccess(
          newStatus === "active" 
            ? "템플릿이 활성화되었습니다." 
            : newStatus === "archived"
            ? "템플릿이 보관되었습니다."
            : "템플릿이 초안 상태로 변경되었습니다."
        );
        router.refresh();
      } else {
        toast.showError(result.error || "상태 변경에 실패했습니다.");
      }
    } catch (error) {
      console.error("상태 변경 실패:", error);
      const errorMessage =
        error instanceof Error ? error.message : "상태 변경에 실패했습니다.";
      toast.showError(errorMessage);
    } finally {
      setIsChangingStatus(false);
    }
  };

  const handleDeleteClick = () => {
    setShowDropdown(false);
    setShowDeleteDialog(true);
  };

  const getStatusBadge = () => {
    if (currentStatus === "draft") {
      return (
        <span className="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-800">
          초안
        </span>
      );
    }
    if (currentStatus === "active") {
      return (
        <span className="inline-flex items-center rounded-full bg-green-100 px-2.5 py-1 text-xs font-medium text-green-800">
          활성
        </span>
      );
    }
    return (
      <span className="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-800">
        보관
      </span>
    );
  };

  return (
    <>
      <div className="group relative rounded-lg border border-gray-200 bg-white p-4 transition hover:border-indigo-300 hover:shadow-md">
        <div className="flex items-center gap-4 md:gap-6">
          {/* 본문 정보 - 가로 배치 */}
          <Link
            href={`/admin/camp-templates/${template.id}`}
            className="flex flex-1 items-center gap-3 md:gap-6 min-w-0"
          >
            {/* 이름 */}
            <div className="flex-shrink-0 min-w-[120px] md:min-w-[150px]">
              <h3 className="text-sm md:text-base font-semibold text-gray-900 truncate">
                {template.name}
              </h3>
            </div>

            {/* 유형 */}
            <div className="flex-shrink-0 hidden sm:block">
              <p className="text-xs md:text-sm text-gray-700 whitespace-nowrap">
                {template.program_type}
              </p>
            </div>

            {/* 설명 */}
            {template.description && (
              <div className="flex-1 min-w-0 hidden md:block">
                <p className="text-sm text-gray-600 truncate">
                  {template.description}
                </p>
              </div>
            )}

            {/* 날짜 */}
            <div className="flex-shrink-0 ml-auto">
              <p className="text-xs text-gray-500 whitespace-nowrap">
                {new Date(template.created_at).toLocaleDateString("ko-KR")}
              </p>
            </div>
          </Link>

          {/* 상태 배지 및 드롭다운 메뉴 */}
          <div className="flex items-center gap-3 flex-shrink-0">
            {getStatusBadge()}
            
            {/* 드롭다운 메뉴 */}
            <div className="relative" ref={dropdownRef}>
              <button
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setShowDropdown(!showDropdown);
                }}
                className="rounded-lg p-1.5 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600"
                title="더보기"
              >
                <MoreVertical className="h-5 w-5" />
              </button>

              {/* 드롭다운 메뉴 */}
              {showDropdown && (
                <div className="absolute right-0 top-full z-10 w-48 rounded-lg border border-gray-200 bg-white shadow-lg">
                  <div className="flex flex-col gap-1 py-1">
                    {/* 상태 변경 옵션 */}
                    {currentStatus === "draft" && (
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          handleStatusChange("active");
                        }}
                        disabled={isChangingStatus}
                        className="w-full px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                      >
                        {isChangingStatus ? "변경 중..." : "활성화"}
                      </button>
                    )}
                    {currentStatus === "active" && (
                      <>
                        <button
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            handleStatusChange("draft");
                          }}
                          disabled={isChangingStatus}
                          className="w-full px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                        >
                          {isChangingStatus ? "변경 중..." : "초안으로 변경"}
                        </button>
                        <button
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            handleStatusChange("archived");
                          }}
                          disabled={isChangingStatus}
                          className="w-full px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                        >
                          {isChangingStatus ? "변경 중..." : "보관"}
                        </button>
                      </>
                    )}
                    {currentStatus === "archived" && (
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          handleStatusChange("draft");
                        }}
                        disabled={isChangingStatus}
                        className="w-full px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                      >
                        {isChangingStatus ? "변경 중..." : "초안으로 복원"}
                      </button>
                    )}

                    {/* 구분선 */}
                    <div className="border-t border-gray-200" />

                    {/* 삭제 옵션 */}
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleDeleteClick();
                      }}
                      className="w-full px-4 py-2 text-left text-sm text-red-600 transition hover:bg-red-50"
                    >
                      삭제
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* 삭제 확인 다이얼로그 */}
      <Dialog
        open={showDeleteDialog}
        onOpenChange={setShowDeleteDialog}
        title="템플릿 삭제 확인"
        description={`정말로 "${template.name}" 템플릿을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`}
        variant="destructive"
        maxWidth="md"
      >
        <div className="py-4">
          <p className="text-sm text-gray-700">
            이 템플릿을 삭제하면 관련된 모든 데이터가 함께 삭제됩니다. 삭제된 템플릿은 복구할 수 없습니다.
          </p>
        </div>
        <DialogFooter>
          <button
            onClick={() => setShowDeleteDialog(false)}
            disabled={isDeleting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
          <button
            onClick={confirmDelete}
            disabled={isDeleting}
            className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
          >
            {isDeleting ? "삭제 중..." : "삭제"}
          </button>
        </DialogFooter>
      </Dialog>
    </>
  );
}
</file>

<file path="admin/camp-templates/_components/TemplateCardNew.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Trash2 } from "lucide-react";
import { CampTemplate } from "@/lib/types/plan";
import { deleteCampTemplateAction, updateCampTemplateStatusAction } from "@/app/(admin)/actions/campTemplateActions";
import { useToast } from "@/components/ui/ToastProvider";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";
import { TemplateCard } from "@/app/(student)/plan/_shared/PlanCard";

type TemplateCardProps = {
  template: CampTemplate;
};

export function TemplateCardComponent({ template }: TemplateCardProps) {
  const router = useRouter();
  const toast = useToast();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [currentStatus, setCurrentStatus] = useState<"draft" | "active" | "archived">(template.status);
  const [isChangingStatus, setIsChangingStatus] = useState(false);

  const handleDelete = async (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setShowDeleteDialog(true);
  };

  const confirmDelete = async () => {
    setIsDeleting(true);
    try {
      const result = await deleteCampTemplateAction(template.id);
      if (result.success) {
        toast.showSuccess("템플릿이 삭제되었습니다.");
        setShowDeleteDialog(false);
        setIsDeleting(false);
        router.push("/admin/camp-templates");
      } else {
        toast.showError(result.error || "템플릿 삭제에 실패했습니다.");
        setIsDeleting(false);
      }
    } catch (error) {
      console.error("템플릿 삭제 실패:", error);
      const errorMessage =
        error instanceof Error ? error.message : "템플릿 삭제에 실패했습니다.";
      toast.showError(errorMessage);
      setIsDeleting(false);
    }
  };

  const handleStatusChange = async (e: React.MouseEvent, newStatus: "draft" | "active" | "archived") => {
    e.preventDefault();
    e.stopPropagation();
    
    if (currentStatus === newStatus) return;
    
    setIsChangingStatus(true);
    try {
      const result = await updateCampTemplateStatusAction(template.id, newStatus);
      if (result.success) {
        setCurrentStatus(newStatus);
        toast.showSuccess(
          newStatus === "active" 
            ? "템플릿이 활성화되었습니다." 
            : "템플릿이 초안 상태로 변경되었습니다."
        );
        router.refresh();
      } else {
        toast.showError(result.error || "상태 변경에 실패했습니다.");
      }
    } catch (error) {
      console.error("상태 변경 실패:", error);
      const errorMessage =
        error instanceof Error ? error.message : "상태 변경에 실패했습니다.";
      toast.showError(errorMessage);
    } finally {
      setIsChangingStatus(false);
    }
  };

  const statusActions = (
    <>
      {currentStatus === "draft" && (
        <button
          onClick={(e) => handleStatusChange(e, "active")}
          disabled={isChangingStatus}
          className="opacity-0 transition-opacity group-hover:opacity-100 rounded-lg px-2 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          title="활성화"
        >
          {isChangingStatus ? "변경 중..." : "활성화"}
        </button>
      )}
      {currentStatus === "active" && (
        <>
          <button
            onClick={(e) => handleStatusChange(e, "draft")}
            disabled={isChangingStatus}
            className="opacity-0 transition-opacity group-hover:opacity-100 rounded-lg px-2 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
            title="초안으로 변경"
          >
            {isChangingStatus ? "변경 중..." : "초안"}
          </button>
          <button
            onClick={(e) => handleStatusChange(e, "archived")}
            disabled={isChangingStatus}
            className="opacity-0 transition-opacity group-hover:opacity-100 rounded-lg px-2 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
            title="보관"
          >
            {isChangingStatus ? "변경 중..." : "보관"}
          </button>
        </>
      )}
      {currentStatus === "archived" && (
        <button
          onClick={(e) => handleStatusChange(e, "draft")}
          disabled={isChangingStatus}
          className="opacity-0 transition-opacity group-hover:opacity-100 rounded-lg px-2 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          title="초안으로 복원"
        >
          {isChangingStatus ? "변경 중..." : "복원"}
        </button>
      )}
      <button
        onClick={handleDelete}
        className="opacity-0 transition-opacity group-hover:opacity-100 rounded-lg p-1.5 text-gray-400 hover:bg-red-50 hover:text-red-600"
        title="템플릿 삭제"
      >
        <Trash2 className="h-4 w-4" />
      </button>
    </>
  );

  return (
    <>
      <TemplateCard
        title={template.name}
        subtitle={template.program_type}
        description={template.description}
        href={`/admin/camp-templates/${template.id}`}
        status={currentStatus}
        createdAt={template.created_at}
        actions={statusActions}
        className="group"
      />

      {/* 삭제 확인 다이얼로그 */}
      <Dialog
        open={showDeleteDialog}
        onOpenChange={setShowDeleteDialog}
        title="템플릿 삭제 확인"
        description={`정말로 "${template.name}" 템플릿을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`}
        variant="destructive"
        maxWidth="md"
      >
        <div className="py-4">
          <p className="text-sm text-gray-700">
            이 템플릿을 삭제하면 관련된 모든 데이터가 함께 삭제됩니다. 삭제된 템플릿은 복구할 수 없습니다.
          </p>
        </div>
        <DialogFooter>
          <button
            onClick={() => setShowDeleteDialog(false)}
            disabled={isDeleting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
          <button
            onClick={confirmDelete}
            disabled={isDeleting}
            className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
          >
            {isDeleting ? "삭제 중..." : "삭제"}
          </button>
        </DialogFooter>
      </Dialog>
    </>
  );
}
</file>

<file path="admin/camp-templates/_components/TemplateChecklist.tsx">
"use client";

import { ChecklistItem, getCampTemplateChecklist, getChecklistCompletion, groupChecklistByCategory } from "@/lib/utils/campTemplateValidation";
import { CampTemplate } from "@/lib/types/plan";
import { CheckCircle2, Circle, AlertCircle } from "lucide-react";
import { cn } from "@/lib/cn";
import { ProgressBar } from "@/components/atoms";

type TemplateChecklistProps = {
  template: CampTemplate;
  compact?: boolean;
};

export function TemplateChecklist({ template, compact = false }: TemplateChecklistProps) {
  const items = getCampTemplateChecklist(template);
  const { completed, total, percentage } = getChecklistCompletion(items);
  const grouped = groupChecklistByCategory(items);

  const categoryLabels = {
    basic: "기본 정보",
    template_data: "템플릿 데이터",
    wizard_data: "템플릿 설정",
  };

  if (compact) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-semibold text-gray-900">필수요소 점검</h3>
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-gray-700">
              {completed}/{total}
            </span>
            <ProgressBar
              value={percentage}
              max={100}
              autoColor={true}
              size="sm"
              className="w-24"
            />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex flex-col gap-4">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-semibold text-gray-900">필수요소 점검</h2>
          <div className="flex items-center gap-3">
            <span className="text-sm text-gray-700">
              완료: <span className="font-semibold">{completed}/{total}</span>
            </span>
            <div className="flex items-center gap-2">
              <ProgressBar
                value={percentage}
                max={100}
                autoColor={true}
                size="sm"
                className="w-32"
              />
              <span className="text-sm font-medium text-gray-900">{percentage}%</span>
            </div>
          </div>
        </div>

        <div className="flex flex-col gap-6">
        {/* 기본 정보 */}
        {grouped.basic.length > 0 && (
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-semibold text-gray-800">
              {categoryLabels.basic}
            </h3>
            <ul className="flex flex-col gap-2">
              {grouped.basic.map((item) => (
                <ChecklistItemComponent key={item.id} item={item} />
              ))}
            </ul>
          </div>
        )}

        {/* 템플릿 데이터 */}
        {grouped.template_data.length > 0 && (
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-semibold text-gray-800">
              {categoryLabels.template_data}
            </h3>
            <ul className="flex flex-col gap-2">
              {grouped.template_data.map((item) => (
                <ChecklistItemComponent key={item.id} item={item} />
              ))}
            </ul>
          </div>
        )}

        {/* 템플릿 설정 */}
        {grouped.wizard_data.length > 0 && (
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-semibold text-gray-800">
              {categoryLabels.wizard_data}
            </h3>
            <ul className="flex flex-col gap-2">
              {grouped.wizard_data.map((item) => (
                <ChecklistItemComponent key={item.id} item={item} />
              ))}
            </ul>
          </div>
        )}
        </div>

        {percentage === 100 && (
          <div className="flex items-center gap-2 rounded-lg bg-green-50 p-3">
            <CheckCircle2 className="h-5 w-5 text-green-600" />
            <p className="text-sm font-medium text-green-800">
              모든 필수 항목이 완료되었습니다.
            </p>
          </div>
        )}

        {percentage < 100 && (
          <div className="flex items-center gap-2 rounded-lg bg-yellow-50 p-3">
            <AlertCircle className="h-5 w-5 text-yellow-600" />
            <p className="text-sm font-medium text-yellow-800">
              {total - completed}개의 항목이 아직 완료되지 않았습니다.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

type ChecklistItemComponentProps = {
  item: ChecklistItem;
};

function ChecklistItemComponent({ item }: ChecklistItemComponentProps) {
  return (
    <li className="flex items-start gap-3">
      <div className="mt-0.5 flex-shrink-0">
        {item.checked ? (
          <CheckCircle2 className="h-5 w-5 text-green-600" />
        ) : (
          <Circle className="h-5 w-5 text-gray-300" />
        )}
      </div>
      <div className="flex-1 flex flex-col gap-1">
        <div className="flex items-center gap-2">
          <span
            className={cn(
              "text-sm font-medium",
              item.checked ? "text-gray-900" : "text-gray-700"
            )}
          >
            {item.label}
          </span>
        </div>
        {item.description && !item.checked && (
          <p className="text-xs text-gray-700">{item.description}</p>
        )}
      </div>
    </li>
  );
}
</file>

<file path="admin/camp-templates/_components/TemplateFormChecklist.tsx">
"use client";

import { CheckCircle2, Circle } from "lucide-react";
import { cn } from "@/lib/cn";
import { ProgressBar } from "@/components/atoms";

type TemplateFormChecklistProps = {
  name?: string;
  programType: string;
  compact?: boolean;
};

export function TemplateFormChecklist({
  name,
  programType,
  compact = false,
}: TemplateFormChecklistProps) {
  const items = [
    {
      id: "name",
      label: "템플릿 이름",
      checked: !!(name && name.trim().length > 0),
      description: "템플릿의 이름을 입력해주세요",
    },
    {
      id: "program_type",
      label: "프로그램 유형",
      checked: !!programType && programType.trim().length > 0,
      description: "프로그램 유형을 선택해주세요 (윈터캠프, 썸머캠프, 파이널캠프, 기타)",
    },
  ];

  const completed = items.filter((item) => item.checked).length;
  const total = items.length;
  const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

  if (compact) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-semibold text-gray-900">기본 정보</h3>
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-gray-700">
              {completed}/{total}
            </span>
            <ProgressBar
              value={percentage}
              max={100}
              autoColor={true}
              size="sm"
              className="w-24"
            />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex flex-col gap-4">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-semibold text-gray-900">기본 정보 체크리스트</h2>
          <div className="flex items-center gap-3">
            <span className="text-sm text-gray-700">
              완료: <span className="font-semibold">{completed}/{total}</span>
            </span>
            <div className="flex items-center gap-2">
              <ProgressBar
                value={percentage}
                max={100}
                autoColor={true}
                size="sm"
                className="w-32"
              />
              <span className="text-sm font-medium text-gray-900">{percentage}%</span>
            </div>
          </div>
        </div>

        <ul className="flex flex-col gap-3">
        {items.map((item) => (
          <li key={item.id} className="flex items-start gap-3">
            <div className="mt-0.5 flex-shrink-0">
              {item.checked ? (
                <CheckCircle2 className="h-5 w-5 text-green-600" />
              ) : (
                <Circle className="h-5 w-5 text-gray-300" />
              )}
            </div>
            <div className="flex-1 flex flex-col gap-1">
              <div className="flex items-center gap-2">
                <span
                className={cn(
                  "text-sm font-medium",
                  item.checked ? "text-gray-900" : "text-gray-700"
                )}
                >
                  {item.label}
                </span>
              </div>
              {item.description && !item.checked && (
                <p className="text-xs text-gray-700">{item.description}</p>
              )}
            </div>
          </li>
        ))}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/_components/TemplateWizardChecklist.tsx">
"use client";

import { WizardData } from "@/app/(student)/plan/new-group/_components/PlanGroupWizard";
import { CheckCircle2, Circle, AlertCircle } from "lucide-react";
import { cn } from "@/lib/cn";
import { ProgressBar } from "@/components/atoms";

type TemplateWizardChecklistProps = {
  wizardData: Partial<WizardData>;
  compact?: boolean;
};

/**
 * 템플릿 생성/수정 위저드용 필수요소 체크리스트
 */
export function TemplateWizardChecklist({
  wizardData,
  compact = false,
}: TemplateWizardChecklistProps) {
  const lockedFields = wizardData.templateLockedFields?.step1 || {};

  // 학생 입력 허용 필드 확인 헬퍼
  const isStudentInputAllowed = (fieldName: string): boolean => {
    const allowFieldName = `allow_student_${fieldName}` as keyof typeof lockedFields;
    return lockedFields[allowFieldName] === true;
  };

  const items: Array<{
    id: string;
    label: string;
    checked: boolean;
    description?: string;
    category: "basic" | "wizard_data";
    isOptional?: boolean;
  }> = [];

  // 캠프 이름 (항상 필수)
  items.push({
    id: "name",
    label: "캠프 이름",
    checked: !!(wizardData.name && wizardData.name.trim().length > 0),
    description: "캠프 이름을 입력해주세요",
    category: "basic",
  });

  // 학습 기간 (학생 입력 허용이 아닐 때만 필수)
  if (!isStudentInputAllowed("period")) {
    items.push({
      id: "period",
      label: "학습 기간",
      checked: !!(
        wizardData.period_start &&
        wizardData.period_end &&
        wizardData.period_start.trim().length > 0 &&
        wizardData.period_end.trim().length > 0
      ),
      description: "학습 시작일과 종료일을 설정해주세요",
      category: "wizard_data",
    });
  } else {
    items.push({
      id: "period",
      label: "학습 기간",
      checked: true, // 학생 입력 허용이므로 선택사항으로 표시
      description: "학생이 입력할 항목입니다",
      category: "wizard_data",
      isOptional: true,
    });
  }

  // 블록 세트는 기본값 옵션이 추가되어 체크리스트에서 제외

  // 스케줄러 유형 (학생 입력 허용이 아닐 때만 필수)
  if (!isStudentInputAllowed("scheduler_type")) {
    items.push({
      id: "scheduler_type",
      label: "스케줄러 유형",
      checked: !!(wizardData.scheduler_type && wizardData.scheduler_type.trim().length > 0),
      description: "스케줄러 유형을 선택해주세요",
      category: "wizard_data",
    });
  } else {
    items.push({
      id: "scheduler_type",
      label: "스케줄러 유형",
      checked: true,
      description: "학생이 입력할 항목입니다",
      category: "wizard_data",
      isOptional: true,
    });
  }

  // 학생 수준 항목이 삭제되어 체크리스트에서 제외
  // 과목 배정은 학생 입력폼 제출 후 관리자 영역이므로 체크리스트에서 제외

  const requiredItems = items.filter((item) => !item.isOptional);
  const completedRequired = requiredItems.filter((item) => item.checked).length;
  const totalRequired = requiredItems.length;
  const percentage = totalRequired > 0 ? Math.round((completedRequired / totalRequired) * 100) : 100;

  if (compact) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-semibold text-gray-900">필수요소 점검</h3>
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-gray-600">
              {completedRequired}/{totalRequired}
            </span>
            <ProgressBar
              value={percentage}
              max={100}
              autoColor={true}
              size="sm"
              className="w-24"
            />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6">
      <div className="flex flex-col gap-4">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-semibold text-gray-900">필수요소 점검</h2>
          <div className="flex items-center gap-3">
            <span className="text-sm text-gray-600">
              완료: <span className="font-semibold">{completedRequired}/{totalRequired}</span>
            </span>
            <div className="flex items-center gap-2">
              <ProgressBar
                value={percentage}
                max={100}
                autoColor={true}
                size="sm"
                className="w-32"
              />
              <span className="text-sm font-medium text-gray-900">{percentage}%</span>
            </div>
          </div>
        </div>

        <div className="flex flex-col gap-6">
          {/* 템플릿 설정 */}
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-semibold text-gray-700">템플릿 설정</h3>
          <ul className="flex flex-col gap-2">
            {items.map((item) => (
              <li key={item.id} className="flex items-start gap-3">
                <div className="mt-0.5 flex-shrink-0">
                  {item.isOptional ? (
                    <Circle className="h-5 w-5 text-gray-300" />
                  ) : item.checked ? (
                    <CheckCircle2 className="h-5 w-5 text-green-600" />
                  ) : (
                    <Circle className="h-5 w-5 text-gray-300" />
                  )}
                </div>
                <div className="flex-1 flex flex-col gap-1">
                  <div className="flex items-center gap-2">
                    <span
                      className={cn(
                        "text-sm font-medium",
                        item.isOptional
                          ? "text-gray-500"
                          : item.checked
                          ? "text-gray-900"
                          : "text-gray-600"
                      )}
                    >
                      {item.label}
                      {item.isOptional && (
                        <span className="ml-1 text-xs text-gray-400">(선택)</span>
                      )}
                    </span>
                  </div>
                  {item.description && !item.checked && !item.isOptional && (
                    <p className="text-xs text-gray-500">{item.description}</p>
                  )}
                  {item.isOptional && (
                    <p className="text-xs text-gray-400 italic">{item.description}</p>
                  )}
                </div>
              </li>
            ))}
          </ul>
          </div>
        </div>

        {percentage === 100 && (
          <div className="flex items-center gap-2 rounded-lg bg-green-50 p-3">
            <CheckCircle2 className="h-5 w-5 text-green-600" />
            <p className="text-sm font-medium text-green-800">
              모든 필수 항목이 완료되었습니다.
            </p>
          </div>
        )}

        {percentage < 100 && (
          <div className="flex items-center gap-2 rounded-lg bg-yellow-50 p-3">
            <AlertCircle className="h-5 w-5 text-yellow-600" />
            <p className="text-sm font-medium text-yellow-800">
              {totalRequired - completedRequired}개의 필수 항목이 아직 완료되지 않았습니다.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/edit/CampTemplateEditForm.tsx">
"use client";

import { useState, useCallback, useTransition } from "react";
import { useRouter } from "next/navigation";
import { ChevronDown, ChevronUp } from "lucide-react";
import { updateCampTemplateAction } from "@/app/(admin)/actions/campTemplateActions";
import {
  PlanGroupWizard,
  WizardData,
} from "@/app/(student)/plan/new-group/_components/PlanGroupWizard";
import { CampTemplate, CampProgramType } from "@/lib/types/plan";
import { useToast } from "@/components/ui/ToastProvider";
import { BlockSetWithBlocks } from "@/lib/data/blockSets";
import { CampTemplateImpactSummary } from "@/lib/data/campTemplates";

type CampTemplateEditFormProps = {
  template: CampTemplate;
  initialBlockSets: BlockSetWithBlocks[];
  selectedBlockSetId?: string | null;
  impactSummary?: CampTemplateImpactSummary | null;
};

const programTypes: Array<{ value: CampProgramType; label: string }> = [
  { value: "윈터캠프", label: "윈터캠프" },
  { value: "썸머캠프", label: "썸머캠프" },
  { value: "파이널캠프", label: "파이널캠프" },
  { value: "기타", label: "기타" },
];

const statuses: Array<{
  value: "draft" | "active" | "archived";
  label: string;
}> = [
  { value: "draft", label: "초안" },
  { value: "active", label: "활성" },
  { value: "archived", label: "보관" },
];

export function CampTemplateEditForm({
  template,
  initialBlockSets,
  selectedBlockSetId = null,
  impactSummary,
}: CampTemplateEditFormProps) {
  const router = useRouter();
  const toast = useToast();
  const [isPending, startTransition] = useTransition();

  // template_data에서 템플릿 이름 추출
  const templateData = (template.template_data as Partial<WizardData>) || {};
  const [templateName, setTemplateName] = useState(
    (templateData as Partial<WizardData>).name || template.name || ""
  );
  const [programType, setProgramType] = useState<CampProgramType>(
    template.program_type
  );
  const [description, setDescription] = useState(template.description || "");

  // 날짜 형식 안전하게 변환 (이미 문자열인 경우 처리)
  const formatDateForInput = (dateValue: string | null | undefined): string => {
    if (!dateValue) return "";
    // 이미 YYYY-MM-DD 형식인 경우
    if (
      typeof dateValue === "string" &&
      /^\d{4}-\d{2}-\d{2}$/.test(dateValue)
    ) {
      return dateValue;
    }
    // ISO 형식인 경우 (YYYY-MM-DDTHH:mm:ss 형식)
    if (typeof dateValue === "string" && dateValue.includes("T")) {
      return dateValue.split("T")[0];
    }
    return "";
  };

  const [campStartDate, setCampStartDate] = useState(
    formatDateForInput(template.camp_start_date)
  );
  const [campEndDate, setCampEndDate] = useState(
    formatDateForInput(template.camp_end_date)
  );
  const [campLocation, setCampLocation] = useState(
    template.camp_location || ""
  );
  const [isBasicInfoOpen, setIsBasicInfoOpen] = useState(false);
  const [wizardSaveFunction, setWizardSaveFunction] = useState<
    (() => Promise<void>) | null
  >(null);
  const [isSaving, setIsSaving] = useState(false);

  // 저장 함수를 받는 콜백을 useCallback으로 메모이제이션
  const handleSaveRequest = useCallback((saveFn: () => Promise<void>) => {
    setWizardSaveFunction(() => saveFn);
  }, []);

  const handleTemplateUpdate = async (wizardData: WizardData) => {
    const finalWizardData: WizardData = {
      ...wizardData,
      name: templateName || wizardData.name, // templateName을 우선 사용
    };

    const formData = new FormData();
    formData.append("name", templateName || finalWizardData.name); // templateName을 명시적으로 사용
    formData.append("program_type", programType);
    formData.append("description", description);
    // 상태는 수정 폼에서 변경하지 않음 (액션 버튼으로만 변경)
    formData.append("template_data", JSON.stringify(finalWizardData));
    if (campStartDate) {
      formData.append("camp_start_date", campStartDate);
    }
    if (campEndDate) {
      formData.append("camp_end_date", campEndDate);
    }
    if (campLocation) {
      formData.append("camp_location", campLocation);
    }

    const result = await updateCampTemplateAction(template.id, formData);
    if (!result.success) {
      throw new Error(result.error || "템플릿 수정에 실패했습니다.");
    }

    toast.showSuccess("템플릿이 성공적으로 수정되었습니다.");
    router.replace(`/admin/camp-templates/${template.id}`);
  };

  // template_data를 initialData로 변환
  // templateId는 항상 template.id로 설정 (template_data에 있더라도 덮어쓰기)
  const initialData = {
    ...templateData,
    // 명시적으로 template.id 사용 (항상 최우선)
    templateId: template.id,
    templateProgramType: template.program_type,
    templateStatus: template.status,
    // 학습기간 명시적으로 포함 (templateData에서 가져오기)
    period_start: templateData.period_start || "",
    period_end: templateData.period_end || "",
    // 블록 세트 ID: 연결 테이블에서 가져온 값 우선, 없으면 template_data에서 (하위 호환성)
    block_set_id: selectedBlockSetId || templateData.block_set_id || "",
  };

  // 디버깅: templateId 확인 (개발 환경에서만)
  if (process.env.NODE_ENV === "development" && !initialData.templateId) {
    console.error("[CampTemplateEditForm] templateId가 없습니다:", {
      templateId: template.id,
      templateData,
      initialData,
    });
  }

  // templateId가 제대로 전달되는지 확인
  if (!initialData.templateId) {
    console.error("[CampTemplateEditForm] templateId가 없습니다:", {
      templateId: template.id,
      initialData,
    });
  }

  return (
    <div className="flex flex-col gap-6">
      {/* 액션 버튼 - PlanGroupWizard의 액션 바와 동일한 스타일 */}
      <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
        <button
          type="button"
          onClick={() => {
            startTransition(() => {
              router.replace(`/admin/camp-templates/${template.id}`);
            });
          }}
          disabled={isPending}
          className="inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <svg
            className="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M15 19l-7-7 7-7"
            />
          </svg>
          {isPending ? "이동 중..." : "템플릿 상세보기"}
        </button>
        <div className="flex items-center gap-4">
          <button
            type="button"
            onClick={() => {
              if (confirm("변경사항을 저장하지 않고 나가시겠습니까?")) {
                startTransition(() => {
                  router.replace(`/admin/camp-templates/${template.id}`);
                });
              }
            }}
            disabled={isPending}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          >
            취소
          </button>
          <button
            type="button"
            onClick={async () => {
              if (!wizardSaveFunction) return;
              setIsSaving(true);
              try {
                await wizardSaveFunction();
              } catch (error) {
                console.error("템플릿 저장 실패:", error);
              } finally {
                setIsSaving(false);
              }
            }}
            disabled={isSaving || !wizardSaveFunction || !templateName}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isSaving ? "저장 중..." : "저장"}
          </button>
        </div>
      </div>

      {/* 템플릿 메타 정보 입력 섹션 */}
      <div className="rounded-lg border border-gray-200 bg-white shadow-sm">
        <button
          type="button"
          onClick={() => setIsBasicInfoOpen(!isBasicInfoOpen)}
          className="flex w-full items-center justify-between p-6 text-left"
        >
          <h2 className="text-lg font-semibold text-gray-900">
            템플릿 기본 정보
          </h2>
          {isBasicInfoOpen ? (
            <ChevronUp className="h-5 w-5 text-gray-500" />
          ) : (
            <ChevronDown className="h-5 w-5 text-gray-500" />
          )}
        </button>
        {isBasicInfoOpen && (
          <div className="border-t border-gray-200 p-6">
            <div className="grid gap-4 md:grid-cols-2">
              {/* 템플릿 이름 */}
              <div className="md:col-span-2">
                <label
                  htmlFor="template_name"
                  className="mb-2 block text-sm font-medium text-gray-700"
                >
                  템플릿 이름 <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="template_name"
                  value={templateName}
                  onChange={(e) => {
                    setTemplateName(e.target.value);
                  }}
                  placeholder="템플릿 이름을 입력하세요"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
                  required
                />
              </div>

              {/* 프로그램 유형 */}
              <div>
                <label
                  htmlFor="program_type"
                  className="mb-2 block text-sm font-medium text-gray-700"
                >
                  프로그램 유형 <span className="text-red-500">*</span>
                </label>
                <select
                  id="program_type"
                  value={programType}
                  onChange={(e) =>
                    setProgramType(e.target.value as CampProgramType)
                  }
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
                  required
                >
                  {programTypes.map((type) => (
                    <option key={type.value} value={type.value}>
                      {type.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* 설명 */}
              <div className="md:col-span-2">
                <label
                  htmlFor="description"
                  className="mb-2 block text-sm font-medium text-gray-700"
                >
                  설명
                </label>
                <textarea
                  id="description"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="템플릿에 대한 설명을 입력하세요. (선택사항)"
                  rows={3}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
                />
              </div>

              {/* 캠프 기간 */}
              <div>
                <label
                  htmlFor="camp_start_date"
                  className="mb-2 block text-sm font-medium text-gray-700"
                >
                  캠프 시작일
                </label>
                <input
                  type="date"
                  id="camp_start_date"
                  value={campStartDate}
                  onChange={(e) => setCampStartDate(e.target.value)}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
                />
              </div>

              <div>
                <label
                  htmlFor="camp_end_date"
                  className="mb-2 block text-sm font-medium text-gray-700"
                >
                  캠프 종료일
                </label>
                <input
                  type="date"
                  id="camp_end_date"
                  value={campEndDate}
                  onChange={(e) => setCampEndDate(e.target.value)}
                  min={campStartDate || undefined}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
                />
              </div>

              {/* 캠프 장소 */}
              <div className="md:col-span-2">
                <label
                  htmlFor="camp_location"
                  className="mb-2 block text-sm font-medium text-gray-700"
                >
                  캠프 장소
                </label>
                <input
                  type="text"
                  id="camp_location"
                  value={campLocation}
                  onChange={(e) => setCampLocation(e.target.value)}
                  placeholder="캠프 장소를 입력하세요. (선택사항)"
                  maxLength={200}
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
                />
              </div>
            </div>
          </div>
        )}
      </div>

      {/* 플랜 그룹 위저드 */}
      <PlanGroupWizard
        initialBlockSets={initialBlockSets}
        initialContents={{ books: [], lectures: [], custom: [] }}
        initialData={{
          ...initialData,
          name: templateName, // templateName state와 동기화
          templateId: template.id, // 명시적으로 template.id 전달 (최우선)
        }}
        isTemplateMode={true}
        onTemplateSave={handleTemplateUpdate}
        onSaveRequest={handleSaveRequest}
      />
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/edit/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getCampTemplateById } from "@/app/(admin)/actions/campTemplateActions";
import { getTenantBlockSets } from "@/app/(admin)/actions/tenantBlockSets";
import { getTemplateBlockSet } from "@/app/(admin)/actions/campTemplateBlockSets";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getCampTemplateImpactSummary } from "@/lib/data/campTemplates";
import { CampTemplateEditForm } from "./CampTemplateEditForm";

export default async function EditCampTemplatePage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { id } = await params;
  const result = await getCampTemplateById(id);

  if (!result.success || !result.template) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">
            템플릿을 찾을 수 없습니다.
          </p>
        </div>
      </section>
    );
  }

  // 활성 상태의 템플릿은 수정 불가
  if (result.template.status === "active") {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-amber-200 bg-amber-50 p-6">
          <h2 className="mb-2 text-lg font-semibold text-amber-900">템플릿 수정 불가</h2>
          <p className="mb-4 text-sm text-amber-800">
            활성 상태의 템플릿은 수정할 수 없습니다. 템플릿을 초안 상태로 변경한 후 수정해주세요.
          </p>
          <div className="flex gap-3">
            <a
              href={`/admin/camp-templates/${id}`}
              className="inline-flex items-center justify-center rounded-lg bg-amber-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-amber-700"
            >
              템플릿 상세로 돌아가기
            </a>
          </div>
        </div>
      </section>
    );
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">기관 정보를 찾을 수 없습니다.</p>
        </div>
      </section>
    );
  }

  const impactSummary = await getCampTemplateImpactSummary(
    id,
    tenantContext.tenantId
  );

  // 테넌트 블록 세트 조회 및 템플릿에 연결된 블록 세트 확인
  let initialBlockSets: Array<{ id: string; name: string; blocks: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }> }> = [];
  let selectedBlockSetId: string | null = null;
  
  try {
    // 모든 테넌트 블록 세트 조회
    const allBlockSets = await getTenantBlockSets();
    initialBlockSets = allBlockSets.map(bs => ({
      id: bs.id,
      name: bs.name,
      blocks: bs.blocks || []
    }));
    
    console.log("[EditCampTemplatePage] 테넌트 블록 세트 조회 성공:", {
      template_id: id,
      block_sets_count: initialBlockSets.length,
      block_set_ids: initialBlockSets.map(bs => bs.id),
    });
    
    // 템플릿에 연결된 블록 세트 조회
    const linkedBlockSet = await getTemplateBlockSet(id);
    if (linkedBlockSet) {
      selectedBlockSetId = linkedBlockSet.id;
      
      // 연결된 블록 세트가 initialBlockSets에 없으면 추가
      const hasBlockSet = initialBlockSets.some(set => set.id === linkedBlockSet.id);
      if (!hasBlockSet) {
        initialBlockSets = [{ ...linkedBlockSet, blocks: linkedBlockSet.blocks || [] }, ...initialBlockSets];
      }
      
      console.log("[EditCampTemplatePage] 템플릿에 연결된 블록 세트:", {
        block_set_id: linkedBlockSet.id,
        block_set_name: linkedBlockSet.name,
      });
    }
  } catch (error) {
    console.error("[EditCampTemplatePage] 블록 세트 조회 실패:", {
      template_id: id,
      error: error instanceof Error ? error.message : String(error),
      stack: error instanceof Error ? error.stack : undefined,
    });
    // 에러가 발생해도 빈 배열로 계속 진행
  }

  return (
    <section className="mx-auto w-full max-w-4xl px-4 py-10">
      <div className="flex flex-col gap-6">
        <div>
          <h1 className="text-3xl font-semibold text-gray-900">캠프 템플릿 수정</h1>
          <p className="text-sm text-gray-500">템플릿 정보를 수정하세요.</p>
        </div>

        <CampTemplateEditForm 
          template={result.template} 
          initialBlockSets={initialBlockSets}
          selectedBlockSetId={selectedBlockSetId}
          impactSummary={impactSummary}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/BatchOperationDialog.tsx">
"use client";

import { Dialog } from "@/components/ui/Dialog";

type BatchOperationDialogProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  operationType: "activate" | "status_change";
  participantCount: number;
  status?: string;
  onConfirm: () => void;
  isPending?: boolean;
};

export function BatchOperationDialog({
  open,
  onOpenChange,
  operationType,
  participantCount,
  status,
  onConfirm,
  isPending = false,
}: BatchOperationDialogProps) {
  const getTitle = () => {
    if (operationType === "activate") {
      return "플랜 그룹 일괄 활성화";
    }
    return "플랜 그룹 상태 일괄 변경";
  };

  const getDescription = () => {
    if (operationType === "activate") {
      return `${participantCount}명의 참여자 플랜 그룹을 활성화하시겠습니까? 활성화된 플랜 그룹의 학생들은 학습을 시작할 수 있습니다.`;
    }
    
    const statusLabels: Record<string, string> = {
      active: "활성",
      saved: "저장됨",
      paused: "일시정지",
      completed: "완료",
      cancelled: "취소",
    };
    
    const statusLabel = status ? statusLabels[status] || status : "해당 상태";
    return `${participantCount}명의 참여자 플랜 그룹 상태를 "${statusLabel}"로 변경하시겠습니까?`;
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <div className="flex flex-col gap-6 p-6">
        <div className="flex flex-col gap-2">
          <h2 className="text-lg font-semibold text-gray-900">{getTitle()}</h2>
          <p className="text-sm text-gray-700">{getDescription()}</p>
        </div>
        
        <div className="flex justify-end gap-3">
          <button
            type="button"
            onClick={() => onOpenChange(false)}
            disabled={isPending}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          >
            취소
          </button>
          <button
            type="button"
            onClick={onConfirm}
            disabled={isPending}
            className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isPending ? "처리 중..." : "확인"}
          </button>
        </div>
      </div>
    </Dialog>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/BatchPlanWizard.tsx">
"use client";

import { useState } from "react";
import { Dialog } from "@/components/ui/Dialog";
import { Step1ContentRecommendation } from "./Step1ContentRecommendation";
import { Step2RangeAdjustment } from "./Step2RangeAdjustment";
import { Step3PlanPreview } from "./Step3PlanPreview";
import { Step4Results } from "./Step4Results";
import { ChevronLeft, ChevronRight } from "lucide-react";

type Participant = {
  groupId: string;
  studentId: string;
  studentName: string;
};

type BatchPlanWizardProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  templateId: string;
  participants: Participant[];
  onSuccess?: () => void;
};

type WizardStep = 1 | 2 | 3 | 4;

// Step 1 데이터: 콘텐츠 추천 설정
type Step1Data = {
  subjectCounts: Record<string, Record<string, number>>; // groupId -> (subject -> count)
  replaceExisting: boolean;
};

// Step 2 데이터: 범위 조절
type Step2Data = {
  rangeAdjustments: Record<string, Array<{
    contentId: string;
    contentType: "book" | "lecture";
    startRange: number;
    endRange: number;
  }>>;
};

// Step 3 데이터: 플랜 미리보기 및 생성 선택
type Step3Data = {
  selectedGroupIds: Set<string>; // 플랜 생성할 그룹 ID들
  previewResults?: Record<string, {
    planCount: number;
    previewData?: any[];
    error?: string;
  }>;
};

// Step 4 데이터: 결과
type Step4Data = {
  results: {
    contentRecommendation: {
      success: boolean;
      successCount: number;
      failureCount: number;
      errors?: Array<{ groupId: string; error: string }>;
    };
    rangeAdjustment: {
      success: boolean;
      successCount: number;
      failureCount: number;
      errors?: Array<{ groupId: string; error: string }>;
    };
    planGeneration: {
      success: boolean;
      successCount: number;
      failureCount: number;
      errors?: Array<{ groupId: string; error: string }>;
    };
  };
};

export function BatchPlanWizard({
  open,
  onOpenChange,
  templateId,
  participants,
  onSuccess,
}: BatchPlanWizardProps) {
  const [currentStep, setCurrentStep] = useState<WizardStep>(1);
  const [step1Data, setStep1Data] = useState<Step1Data | null>(null);
  const [step2Data, setStep2Data] = useState<Step2Data | null>(null);
  const [step3Data, setStep3Data] = useState<Step3Data | null>(null);
  const [step4Data, setStep4Data] = useState<Step4Data | null>(null);

  const handleStep1Complete = (data: Step1Data) => {
    setStep1Data(data);
    setCurrentStep(2);
  };

  const handleStep2Complete = (data: Step2Data) => {
    setStep2Data(data);
    setCurrentStep(3);
  };

  const handleStep3Complete = (data: Step3Data) => {
    setStep3Data(data);
    setCurrentStep(4);
  };

  const handleStep4Complete = () => {
    onSuccess?.();
    onOpenChange(false);
    // 초기화
    setCurrentStep(1);
    setStep1Data(null);
    setStep2Data(null);
    setStep3Data(null);
    setStep4Data(null);
  };

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep((prev) => (prev - 1) as WizardStep);
    }
  };

  const handleClose = () => {
    if (confirm("진행 중인 작업을 취소하시겠습니까?")) {
      onOpenChange(false);
      // 초기화
      setCurrentStep(1);
      setStep1Data(null);
      setStep2Data(null);
      setStep3Data(null);
      setStep4Data(null);
    }
  };

  const stepLabels = {
    1: "콘텐츠 추천 설정",
    2: "범위 조절",
    3: "플랜 미리보기",
    4: "결과",
  };

  return (
    <Dialog open={open} onOpenChange={handleClose} maxWidth="full">
      <div className="flex flex-col h-full max-h-[90vh] max-w-[95vw]">
        {/* 헤더 - 고정 */}
        <div className="flex flex-col gap-2 flex-shrink-0 border-b border-gray-200 bg-white px-6 py-4">
          <h2 className="text-2xl font-semibold text-gray-900">
            일괄 설정 및 플랜 생성
          </h2>
          <p className="text-sm text-gray-700">
            선택한 {participants.length}명의 학생에게 콘텐츠 추천, 범위 조절, 플랜 생성을 단계별로 진행합니다.
          </p>
        </div>

        {/* 진행 단계 표시 - 고정 */}
        <div className="flex-shrink-0 border-b border-gray-200 bg-white px-6 py-4">
          <div className="flex items-center justify-between">
            {[1, 2, 3, 4].map((step) => {
              const stepNum = step as WizardStep;
              const isActive = currentStep === stepNum;
              const isCompleted = currentStep > stepNum;
              const isPending = currentStep < stepNum;

              return (
                <div key={step} className="flex items-center flex-1">
                  <div className="flex flex-col items-center flex-1">
                    <div
                      className={`flex h-10 w-10 items-center justify-center rounded-full border-2 font-semibold transition ${
                        isActive
                          ? "border-indigo-600 bg-indigo-600 text-white"
                          : isCompleted
                          ? "border-green-600 bg-green-600 text-white"
                          : "border-gray-300 bg-white text-gray-400"
                      }`}
                    >
                      {isCompleted ? "✓" : step}
                    </div>
                    <div
                      className={`text-xs font-medium ${
                        isActive
                          ? "text-indigo-600"
                          : isCompleted
                          ? "text-green-600"
                          : "text-gray-400"
                      }`}
                    >
                      {stepLabels[stepNum]}
                    </div>
                  </div>
                  {step < 4 && (
                    <div
                      className={`h-0.5 flex-1 ${
                        isCompleted ? "bg-green-600" : "bg-gray-300"
                      }`}
                    />
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* 단계별 콘텐츠 - 스크롤 가능 */}
        <div className="flex-1 overflow-y-auto overflow-x-hidden px-6 py-4">
          <div className="min-h-[400px]">
          {currentStep === 1 && (
            <Step1ContentRecommendation
              templateId={templateId}
              participants={participants}
              initialData={step1Data}
              onComplete={handleStep1Complete}
              onBack={() => handleClose()}
            />
          )}
          {currentStep === 2 && step1Data && (
            <Step2RangeAdjustment
              templateId={templateId}
              participants={participants}
              step1Data={step1Data}
              initialData={step2Data}
              onComplete={handleStep2Complete}
              onBack={handleBack}
            />
          )}
          {currentStep === 3 && step1Data && step2Data && (
            <Step3PlanPreview
              templateId={templateId}
              participants={participants}
              step1Data={step1Data}
              step2Data={step2Data}
              initialData={step3Data}
              onComplete={handleStep3Complete}
              onBack={handleBack}
            />
          )}
          {currentStep === 4 && step1Data && step2Data && step3Data && (
            <Step4Results
              templateId={templateId}
              participants={participants}
              step1Data={step1Data}
              step2Data={step2Data}
              step3Data={step3Data}
              initialData={step4Data}
              onComplete={handleStep4Complete}
              onBack={handleBack}
            />
          )}
          </div>
        </div>
      </div>
    </Dialog>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/BulkRecommendContentsModal.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { Dialog } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import { bulkApplyRecommendedContents } from "@/app/(admin)/actions/campTemplateActions";
import { AVAILABLE_SUBJECTS } from "@/app/(student)/plan/new-group/_components/Step4RecommendedContents/constants";
import { Minus, Plus, Users, BookOpen, AlertTriangle, CheckCircle2 } from "lucide-react";

type Participant = {
  groupId: string;
  studentId: string;
  studentName: string;
};

type BulkRecommendContentsModalProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  templateId: string;
  participants: Participant[];
  onSuccess?: () => void;
};

type SubjectCounts = Record<string, number>; // subject -> count
type StudentSubjectCounts = Record<string, SubjectCounts>; // groupId -> (subject -> count)

export function BulkRecommendContentsModal({
  open,
  onOpenChange,
  templateId,
  participants,
  onSuccess,
}: BulkRecommendContentsModalProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  
  // 학생별 교과/수량 설정: groupId -> (subject -> count)
  const [subjectCounts, setSubjectCounts] = useState<StudentSubjectCounts>({});
  
  // 학생 선택 체크박스
  const [selectedStudentIds, setSelectedStudentIds] = useState<Set<string>>(
    new Set(participants.map((p) => p.groupId))
  );
  
  // 개별 조율 팝오버 상태
  const [openPopoverId, setOpenPopoverId] = useState<string | null>(null);
  
  // 전체 조율 설정
  const [globalSubjectCounts, setGlobalSubjectCounts] = useState<SubjectCounts>({});
  const [globalAdjustSubject, setGlobalAdjustSubject] = useState<string>("");
  const [globalAdjustAmount, setGlobalAdjustAmount] = useState<number>(0);
  
  // 개별 조율 설정
  const [individualSubjectCounts, setIndividualSubjectCounts] = useState<SubjectCounts>({});
  const [individualAdjustSubject, setIndividualAdjustSubject] = useState<string>("");
  const [individualAdjustAmount, setIndividualAdjustAmount] = useState<number>(0);
  
  // 적용 옵션
  const [replaceExisting, setReplaceExisting] = useState<boolean>(false);

  // 초기화: 모든 학생의 수량을 0으로 설정
  useEffect(() => {
    if (open && participants.length > 0) {
      const initialCounts: StudentSubjectCounts = {};
      participants.forEach((p) => {
        initialCounts[p.groupId] = {};
        AVAILABLE_SUBJECTS.forEach((subject) => {
          initialCounts[p.groupId][subject] = 0;
        });
      });
      setSubjectCounts(initialCounts);
      setSelectedStudentIds(new Set(participants.map((p) => p.groupId)));
    }
  }, [open, participants]);

  // 학생당 총합 계산
  const calculateTotal = (groupId: string): number => {
    const counts = subjectCounts[groupId] || {};
    return Object.values(counts).reduce((sum, count) => sum + count, 0);
  };

  // 전체 통계 계산
  const calculateSummary = () => {
    let totalContents = 0;
    const subjectTotals: Record<string, number> = {};
    let overLimitCount = 0;

    participants.forEach((p) => {
      const total = calculateTotal(p.groupId);
      totalContents += total;
      if (total > 9) {
        overLimitCount++;
      }

      AVAILABLE_SUBJECTS.forEach((subject) => {
        const count = subjectCounts[p.groupId]?.[subject] || 0;
        subjectTotals[subject] = (subjectTotals[subject] || 0) + count;
      });
    });

    return {
      totalContents,
      subjectTotals,
      overLimitCount,
    };
  };

  // 학생당 최대 9개 제한 검증
  const validateCounts = (): { valid: boolean; errors: Array<{ groupId: string; studentName: string; total: number }> } => {
    const errors: Array<{ groupId: string; studentName: string; total: number }> = [];
    
    participants.forEach((p) => {
      const total = calculateTotal(p.groupId);
      if (total > 9) {
        errors.push({
          groupId: p.groupId,
          studentName: p.studentName,
          total,
        });
      }
    });
    
    return {
      valid: errors.length === 0,
      errors,
    };
  };

  // 수량 업데이트
  const updateCount = (groupId: string, subject: string, count: number) => {
    setSubjectCounts((prev) => {
      const newCounts = { ...prev };
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      newCounts[groupId] = {
        ...newCounts[groupId],
        [subject]: Math.max(0, Math.min(9, count)), // 0-9 범위 제한
      };
      return newCounts;
    });
  };

  // 전체 일괄 적용
  const handleGlobalApply = () => {
    const newCounts = { ...subjectCounts };
    participants.forEach((p) => {
      if (!newCounts[p.groupId]) {
        newCounts[p.groupId] = {};
      }
      AVAILABLE_SUBJECTS.forEach((subject) => {
        newCounts[p.groupId][subject] = globalSubjectCounts[subject] || 0;
      });
    });
    setSubjectCounts(newCounts);
    setGlobalSubjectCounts({});
    toast.showSuccess("모든 학생에게 일괄 적용되었습니다.");
  };

  // 전체 증가/감소
  const handleGlobalAdjust = () => {
    if (!globalAdjustSubject || globalAdjustAmount === 0) {
      toast.showError("교과와 조정량을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    participants.forEach((p) => {
      if (!newCounts[p.groupId]) {
        newCounts[p.groupId] = {};
      }
      const current = newCounts[p.groupId][globalAdjustSubject] || 0;
      const newValue = Math.max(0, Math.min(9, current + globalAdjustAmount));
      newCounts[p.groupId][globalAdjustSubject] = newValue;
    });
    setSubjectCounts(newCounts);
    setGlobalAdjustSubject("");
    setGlobalAdjustAmount(0);
    toast.showSuccess(`모든 학생의 ${globalAdjustSubject} 수량이 조정되었습니다.`);
  };

  // 선택한 학생 일괄 적용
  const handleIndividualApply = () => {
    if (selectedStudentIds.size === 0) {
      toast.showError("적용할 학생을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    selectedStudentIds.forEach((groupId) => {
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      AVAILABLE_SUBJECTS.forEach((subject) => {
        newCounts[groupId][subject] = individualSubjectCounts[subject] || 0;
      });
    });
    setSubjectCounts(newCounts);
    setIndividualSubjectCounts({});
    setOpenPopoverId(null);
    toast.showSuccess(`${selectedStudentIds.size}명의 학생에게 일괄 적용되었습니다.`);
  };

  // 선택한 학생 증가/감소
  const handleIndividualAdjust = () => {
    if (selectedStudentIds.size === 0) {
      toast.showError("조정할 학생을 선택해주세요.");
      return;
    }
    if (!individualAdjustSubject || individualAdjustAmount === 0) {
      toast.showError("교과와 조정량을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    selectedStudentIds.forEach((groupId) => {
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      const current = newCounts[groupId][individualAdjustSubject] || 0;
      const newValue = Math.max(0, Math.min(9, current + individualAdjustAmount));
      newCounts[groupId][individualAdjustSubject] = newValue;
    });
    setSubjectCounts(newCounts);
    setIndividualAdjustSubject("");
    setIndividualAdjustAmount(0);
    setOpenPopoverId(null);
    toast.showSuccess(`${selectedStudentIds.size}명의 학생의 ${individualAdjustSubject} 수량이 조정되었습니다.`);
  };

  // 선택한 학생 초기화
  const handleIndividualReset = () => {
    if (selectedStudentIds.size === 0) {
      toast.showError("초기화할 학생을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    selectedStudentIds.forEach((groupId) => {
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      AVAILABLE_SUBJECTS.forEach((subject) => {
        newCounts[groupId][subject] = 0;
      });
    });
    setSubjectCounts(newCounts);
    setOpenPopoverId(null);
    toast.showSuccess(`${selectedStudentIds.size}명의 학생이 초기화되었습니다.`);
  };

  // 제출
  const handleSubmit = () => {
    const validation = validateCounts();
    if (!validation.valid) {
      const errorMsg = validation.errors
        .map((e) => `${e.studentName}: ${e.total}개 (최대 9개)`)
        .join(", ");
      toast.showError(`최대 수량을 초과한 학생이 있습니다: ${errorMsg}`);
      return;
    }

    // groupId -> (subject -> count) 형식으로 변환
    const subjectCountsMap: Record<string, Record<string, number>> = {};
    participants.forEach((p) => {
      const counts = subjectCounts[p.groupId] || {};
      const filteredCounts: Record<string, number> = {};
      AVAILABLE_SUBJECTS.forEach((subject) => {
        const count = counts[subject] || 0;
        if (count > 0) {
          filteredCounts[subject] = count;
        }
      });
      if (Object.keys(filteredCounts).length > 0) {
        subjectCountsMap[p.groupId] = filteredCounts;
      }
    });

    if (Object.keys(subjectCountsMap).length === 0) {
      toast.showError("적용할 추천 콘텐츠가 없습니다. 최소 1개 이상의 교과/수량을 설정해주세요.");
      return;
    }

    startTransition(async () => {
      try {
        const result = await bulkApplyRecommendedContents(
          templateId,
          participants.map((p) => p.groupId),
          subjectCountsMap,
          { replaceExisting }
        );

        if (result.success) {
          toast.showSuccess(
            `${result.successCount}명의 학생에게 추천 콘텐츠가 적용되었습니다.`
          );
          onSuccess?.();
          onOpenChange(false);
        } else {
          const errorMsg =
            result.errors && result.errors.length > 0
              ? `${result.failureCount}개 실패: ${result.errors[0].error}`
              : "일괄 적용에 실패했습니다.";
          toast.showError(errorMsg);
        }
      } catch (error) {
        console.error("추천 콘텐츠 일괄 적용 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "일괄 적용에 실패했습니다."
        );
      }
    });
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange} maxWidth="full">
      <div className="max-h-[90vh] overflow-y-auto overflow-x-hidden p-6 md:p-8 max-w-[95vw]">
        <h2 className="text-xl font-semibold text-gray-900">
          추천 콘텐츠 일괄 적용
        </h2>
        <p className="text-sm text-gray-700">
          선택한 {participants.length}명의 학생에게 추천 콘텐츠를 일괄 적용합니다.
          학생당 최대 9개까지 설정할 수 있습니다.
        </p>

        {/* 요약 섹션 */}
        {(() => {
          const summary = calculateSummary();
          return (
            <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
              <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
                <div className="flex items-center gap-2 text-xs text-gray-600">
                  <Users className="h-4 w-4" />
                  <span>선택된 학생</span>
                </div>
                <div className="text-2xl font-bold text-gray-900">
                  {participants.length}
                </div>
              </div>
              <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
                <div className="flex items-center gap-2 text-xs text-gray-600">
                  <BookOpen className="h-4 w-4" />
                  <span>전체 콘텐츠</span>
                </div>
                <div className="text-2xl font-bold text-gray-900">
                  {summary.totalContents}
                </div>
              </div>
              <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
                <div className="flex items-center gap-2 text-xs text-gray-600">
                  <CheckCircle2 className="h-4 w-4" />
                  <span>교과별 합계</span>
                </div>
                <div className="flex flex-col gap-0.5">
                  {AVAILABLE_SUBJECTS.map((subject) => (
                    <div key={subject} className="text-xs font-semibold text-gray-900">
                      <span className="text-gray-600">{subject}:</span>{" "}
                      <span className="text-gray-900">{summary.subjectTotals[subject] || 0}</span>
                    </div>
                  ))}
                </div>
              </div>
              <div className={`flex flex-col gap-1 rounded-lg border p-4 ${
                summary.overLimitCount > 0
                  ? "border-red-200 bg-red-50"
                  : "border-gray-200 bg-white"
              }`}>
                <div className="flex items-center gap-2 text-xs text-gray-600">
                  <AlertTriangle className={`h-4 w-4 ${
                    summary.overLimitCount > 0 ? "text-red-600" : "text-gray-400"
                  }`} />
                  <span>초과 학생</span>
                </div>
                <div className={`text-2xl font-bold ${
                  summary.overLimitCount > 0 ? "text-red-600" : "text-gray-900"
                }`}>
                  {summary.overLimitCount}
                </div>
              </div>
            </div>
          );
        })()}

        {/* 전체 조율 컨트롤 */}
        <div className="flex flex-col gap-5 rounded-lg border border-gray-200 bg-gray-50 p-5 md:p-6">
          <h3 className="text-sm font-semibold text-gray-900">전체 조율</h3>
          
          {/* 일괄 적용 */}
          <div className="flex flex-col gap-3">
            <label className="block text-xs font-medium text-gray-700">
              모든 학생에게 일괄 적용
            </label>
            <div className="flex flex-row flex-wrap gap-2 items-center">
              {AVAILABLE_SUBJECTS.map((subject) => {
                const current = globalSubjectCounts[subject] || 0;
                return (
                  <div key={subject} className="flex items-center gap-1.5 shrink-0">
                    <label className="text-xs font-medium text-gray-700 whitespace-nowrap">{subject}:</label>
                    <div className="flex items-center gap-1">
                      <button
                        type="button"
                        onClick={() =>
                          setGlobalSubjectCounts({
                            ...globalSubjectCounts,
                            [subject]: Math.max(0, current - 1),
                          })
                        }
                        disabled={current === 0}
                        className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white shrink-0"
                        aria-label={`${subject} 감소`}
                      >
                        <Minus className="h-3 w-3" />
                      </button>
                      <span className="min-w-[1.5rem] text-center text-xs font-semibold text-gray-900">
                        {current}
                      </span>
                      <button
                        type="button"
                        onClick={() =>
                          setGlobalSubjectCounts({
                            ...globalSubjectCounts,
                            [subject]: Math.min(9, current + 1),
                          })
                        }
                        disabled={current === 9}
                        className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white shrink-0"
                        aria-label={`${subject} 증가`}
                      >
                        <Plus className="h-3 w-3" />
                      </button>
                    </div>
                  </div>
                );
              })}
              <button
                type="button"
                onClick={handleGlobalApply}
                className="ml-auto shrink-0 rounded bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
              >
                적용
              </button>
            </div>
          </div>

          {/* 일괄 증가/감소 */}
          <div className="flex flex-col gap-3">
            <label className="block text-xs font-medium text-gray-700">
              모든 학생 증가/감소
            </label>
            <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
              <select
                value={globalAdjustSubject}
                onChange={(e) => setGlobalAdjustSubject(e.target.value)}
                className="rounded border border-gray-300 px-2 py-1 text-sm"
              >
                <option value="">교과 선택</option>
                {AVAILABLE_SUBJECTS.map((subject) => (
                  <option key={subject} value={subject}>
                    {subject}
                  </option>
                ))}
              </select>
              <button
                type="button"
                onClick={() => setGlobalAdjustAmount(-1)}
                className="rounded border border-gray-300 bg-white px-2 py-1 text-sm hover:bg-gray-50"
              >
                -1
              </button>
              <button
                type="button"
                onClick={() => setGlobalAdjustAmount(1)}
                className="rounded border border-gray-300 bg-white px-2 py-1 text-sm hover:bg-gray-50"
              >
                +1
              </button>
              <button
                type="button"
                onClick={handleGlobalAdjust}
                disabled={!globalAdjustSubject || globalAdjustAmount === 0}
                className="rounded bg-indigo-600 px-3 py-1 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
              >
                적용
              </button>
            </div>
          </div>
        </div>

        {/* 테이블 */}
        <div className="max-h-[60vh] overflow-y-auto overflow-x-hidden pt-8">
          <table className="w-full border-collapse rounded-lg border border-gray-200 bg-white text-sm">
            <thead className="sticky top-0 z-10 bg-gray-50 shadow-sm">
              <tr>
                <th className="border-b border-gray-200 px-3 py-2 text-left text-xs font-semibold text-gray-900">
                  <input
                    type="checkbox"
                    checked={selectedStudentIds.size === participants.length}
                    onChange={(e) => {
                      if (e.target.checked) {
                        setSelectedStudentIds(new Set(participants.map((p) => p.groupId)));
                      } else {
                        setSelectedStudentIds(new Set());
                      }
                    }}
                    className="rounded border-gray-300"
                  />
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-900 min-w-[120px]">
                  학생명
                </th>
                {AVAILABLE_SUBJECTS.map((subject) => (
                  <th
                    key={subject}
                    className="border-b border-gray-200 px-3 py-3 text-center text-xs font-semibold text-gray-900 min-w-[100px]"
                  >
                    {subject}
                  </th>
                ))}
                <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900 min-w-[80px]">
                  총합
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900 min-w-[80px]">
                  조율
                </th>
              </tr>
            </thead>
            <tbody>
              {participants.map((p) => {
                const total = calculateTotal(p.groupId);
                const isSelected = selectedStudentIds.has(p.groupId);
                const isOverLimit = total > 9;
                
                return (
                  <tr
                    key={p.groupId}
                    className={`transition-colors ${
                      isOverLimit
                        ? "bg-red-50 hover:bg-red-100"
                        : total === 9
                        ? "bg-orange-50 hover:bg-orange-100"
                        : "hover:bg-gray-50"
                    }`}
                  >
                    <td className="border-b border-gray-200 px-4 py-3">
                      <input
                        type="checkbox"
                        checked={isSelected}
                        onChange={(e) => {
                          const newSet = new Set(selectedStudentIds);
                          if (e.target.checked) {
                            newSet.add(p.groupId);
                          } else {
                            newSet.delete(p.groupId);
                          }
                          setSelectedStudentIds(newSet);
                        }}
                        className="rounded border-gray-300"
                      />
                    </td>
                    <td className="border-b border-gray-200 px-4 py-3 font-medium text-gray-900 min-w-[120px]">
                      <div className="truncate" title={p.studentName}>
                        {p.studentName}
                      </div>
                    </td>
                    {AVAILABLE_SUBJECTS.map((subject) => {
                      const current = subjectCounts[p.groupId]?.[subject] || 0;
                      return (
                        <td key={subject} className="border-b border-gray-200 px-3 py-3">
                          <div className="flex items-center justify-center gap-1.5">
                            <button
                              type="button"
                              onClick={() => updateCount(p.groupId, subject, current - 1)}
                              disabled={current === 0}
                              className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                              aria-label={`${subject} 감소`}
                            >
                              <Minus className="h-3.5 w-3.5" />
                            </button>
                            <span className="min-w-[2rem] text-center text-sm font-semibold text-gray-900">
                              {current}
                            </span>
                            <button
                              type="button"
                              onClick={() => updateCount(p.groupId, subject, current + 1)}
                              disabled={current === 9}
                              className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                              aria-label={`${subject} 증가`}
                            >
                              <Plus className="h-3.5 w-3.5" />
                            </button>
                          </div>
                        </td>
                      );
                    })}
                    <td
                      className={`border-b border-gray-200 px-4 py-3 text-center font-semibold ${
                        isOverLimit
                          ? "text-red-600"
                          : total === 9
                          ? "text-orange-600"
                          : "text-gray-900"
                      }`}
                    >
                      <div className="flex items-center justify-center gap-1">
                        {isOverLimit && <AlertTriangle className="h-4 w-4 text-red-600" />}
                        {total === 9 && !isOverLimit && (
                          <AlertTriangle className="h-4 w-4 text-orange-600" />
                        )}
                        <span>
                          {total}/9
                        </span>
                      </div>
                    </td>
                    <td className="border-b border-gray-200 px-4 py-3 text-center">
                      <div className="relative">
                        <button
                          type="button"
                          onClick={() =>
                            setOpenPopoverId(
                              openPopoverId === p.groupId ? null : p.groupId
                            )
                          }
                          className="rounded border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 transition hover:bg-gray-50 hover:border-gray-400"
                        >
                          조율
                        </button>
                        {openPopoverId === p.groupId && (
                          <div className="absolute right-0 top-full z-10 w-72 rounded-lg border border-gray-200 bg-white p-4 shadow-xl">
                            <div className="flex flex-col gap-3">
                              <div className="flex flex-col gap-2">
                                <label className="block text-xs font-medium text-gray-700">
                                  선택한 학생에게 일괄 적용
                                </label>
                                <div className="flex flex-col gap-2">
                                  {AVAILABLE_SUBJECTS.map((subject) => {
                                    const current = individualSubjectCounts[subject] || 0;
                                    return (
                                      <div key={subject} className="flex items-center justify-between gap-2">
                                        <label className="text-xs font-medium text-gray-700 min-w-[3rem]">{subject}:</label>
                                        <div className="flex items-center gap-1.5">
                                          <button
                                            type="button"
                                            onClick={() =>
                                              setIndividualSubjectCounts({
                                                ...individualSubjectCounts,
                                                [subject]: Math.max(0, current - 1),
                                              })
                                            }
                                            disabled={current === 0}
                                            className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                                            aria-label={`${subject} 감소`}
                                          >
                                            <Minus className="h-3 w-3" />
                                          </button>
                                          <span className="min-w-[1.5rem] text-center text-xs font-semibold text-gray-900">
                                            {current}
                                          </span>
                                          <button
                                            type="button"
                                            onClick={() =>
                                              setIndividualSubjectCounts({
                                                ...individualSubjectCounts,
                                                [subject]: Math.min(9, current + 1),
                                              })
                                            }
                                            disabled={current === 9}
                                            className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                                            aria-label={`${subject} 증가`}
                                          >
                                            <Plus className="h-3 w-3" />
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                                <button
                                  type="button"
                                  onClick={handleIndividualApply}
                                  className="w-full rounded bg-indigo-600 px-2 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
                                >
                                  적용
                                </button>
                              </div>
                              
                              <div className="flex flex-col gap-2">
                                <label className="block text-xs font-medium text-gray-700">
                                  선택한 학생 증가/감소
                                </label>
                                <div className="flex items-center gap-1">
                                  <select
                                    value={individualAdjustSubject}
                                    onChange={(e) => setIndividualAdjustSubject(e.target.value)}
                                    className="flex-1 rounded border border-gray-300 px-2 py-1 text-xs"
                                  >
                                    <option value="">교과 선택</option>
                                    {AVAILABLE_SUBJECTS.map((subject) => (
                                      <option key={subject} value={subject}>
                                        {subject}
                                      </option>
                                    ))}
                                  </select>
                                  <button
                                    type="button"
                                    onClick={() => setIndividualAdjustAmount(-1)}
                                    className="rounded border border-gray-300 bg-white px-2 py-1 text-xs hover:bg-gray-50"
                                  >
                                    -1
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => setIndividualAdjustAmount(1)}
                                    className="rounded border border-gray-300 bg-white px-2 py-1 text-xs hover:bg-gray-50"
                                  >
                                    +1
                                  </button>
                                </div>
                                <button
                                  type="button"
                                  onClick={handleIndividualAdjust}
                                  disabled={!individualAdjustSubject || individualAdjustAmount === 0}
                                  className="w-full rounded bg-indigo-600 px-2 py-1 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
                                >
                                  적용
                                </button>
                              </div>
                              
                              <div>
                                <button
                                  type="button"
                                  onClick={handleIndividualReset}
                                  className="w-full rounded border border-red-300 bg-white px-2 py-1 text-xs font-semibold text-red-600 hover:bg-red-50"
                                >
                                  선택한 학생 초기화
                                </button>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>

        {/* 적용 옵션 */}
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-5 md:p-6">
          <label className="flex items-center gap-3 cursor-pointer">
            <input
              type="checkbox"
              checked={replaceExisting}
              onChange={(e) => setReplaceExisting(e.target.checked)}
              className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
            />
            <span className="text-sm text-gray-700">
              기존 추천 콘텐츠 교체 (체크 시 기존 추천 콘텐츠를 삭제하고 새로 추가)
            </span>
          </label>
        </div>

        {/* 액션 버튼 */}
        <div className="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
          <button
            type="button"
            onClick={() => onOpenChange(false)}
            disabled={isPending}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
          >
            취소
          </button>
          <button
            type="button"
            onClick={handleSubmit}
            disabled={isPending}
            className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isPending ? "적용 중..." : "적용"}
          </button>
        </div>
      </div>
    </Dialog>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/Step1ContentRecommendation.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { bulkApplyRecommendedContents } from "@/app/(admin)/actions/campTemplateActions";
import { AVAILABLE_SUBJECTS } from "@/app/(student)/plan/new-group/_components/Step4RecommendedContents/constants";
import { Minus, Plus, Users, BookOpen, AlertTriangle, CheckCircle2 } from "lucide-react";

type Participant = {
  groupId: string;
  studentId: string;
  studentName: string;
};

type Step1ContentRecommendationProps = {
  templateId: string;
  participants: Participant[];
  initialData?: {
    subjectCounts: Record<string, Record<string, number>>;
    replaceExisting: boolean;
  } | null;
  onComplete: (data: {
    subjectCounts: Record<string, Record<string, number>>;
    replaceExisting: boolean;
  }) => void;
  onBack: () => void;
};

type SubjectCounts = Record<string, number>; // subject -> count
type StudentSubjectCounts = Record<string, SubjectCounts>; // groupId -> (subject -> count)

export function Step1ContentRecommendation({
  templateId,
  participants,
  initialData,
  onComplete,
  onBack,
}: Step1ContentRecommendationProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  
  // 학생별 교과/수량 설정: groupId -> (subject -> count)
  const [subjectCounts, setSubjectCounts] = useState<StudentSubjectCounts>(() => {
    if (initialData?.subjectCounts) {
      return initialData.subjectCounts;
    }
    const initial: StudentSubjectCounts = {};
    participants.forEach((p) => {
      initial[p.groupId] = {};
      AVAILABLE_SUBJECTS.forEach((subject) => {
        initial[p.groupId][subject] = 0;
      });
    });
    return initial;
  });
  
  // 학생 선택 체크박스
  const [selectedStudentIds, setSelectedStudentIds] = useState<Set<string>>(
    new Set(participants.map((p) => p.groupId))
  );
  
  // 개별 조율 팝오버 상태
  const [openPopoverId, setOpenPopoverId] = useState<string | null>(null);
  
  // 전체 조율 설정
  const [globalSubjectCounts, setGlobalSubjectCounts] = useState<SubjectCounts>({});
  const [globalAdjustSubject, setGlobalAdjustSubject] = useState<string>("");
  const [globalAdjustAmount, setGlobalAdjustAmount] = useState<number>(0);
  
  // 개별 조율 설정
  const [individualSubjectCounts, setIndividualSubjectCounts] = useState<SubjectCounts>({});
  const [individualAdjustSubject, setIndividualAdjustSubject] = useState<string>("");
  const [individualAdjustAmount, setIndividualAdjustAmount] = useState<number>(0);
  
  // 적용 옵션
  const [replaceExisting, setReplaceExisting] = useState<boolean>(
    initialData?.replaceExisting ?? false
  );

  // 학생당 총합 계산
  const calculateTotal = (groupId: string): number => {
    const counts = subjectCounts[groupId] || {};
    return Object.values(counts).reduce((sum, count) => sum + count, 0);
  };

  // 전체 통계 계산
  const calculateSummary = () => {
    let totalContents = 0;
    const subjectTotals: Record<string, number> = {};
    let overLimitCount = 0;

    participants.forEach((p) => {
      const total = calculateTotal(p.groupId);
      totalContents += total;
      if (total > 9) {
        overLimitCount++;
      }

      AVAILABLE_SUBJECTS.forEach((subject) => {
        const count = subjectCounts[p.groupId]?.[subject] || 0;
        subjectTotals[subject] = (subjectTotals[subject] || 0) + count;
      });
    });

    return {
      totalContents,
      subjectTotals,
      overLimitCount,
    };
  };

  // 학생당 최대 9개 제한 검증
  const validateCounts = (): { valid: boolean; errors: Array<{ groupId: string; studentName: string; total: number }> } => {
    const errors: Array<{ groupId: string; studentName: string; total: number }> = [];
    
    participants.forEach((p) => {
      const total = calculateTotal(p.groupId);
      if (total > 9) {
        errors.push({
          groupId: p.groupId,
          studentName: p.studentName,
          total,
        });
      }
    });
    
    return {
      valid: errors.length === 0,
      errors,
    };
  };

  // 수량 업데이트
  const updateCount = (groupId: string, subject: string, count: number) => {
    setSubjectCounts((prev) => {
      const newCounts = { ...prev };
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      newCounts[groupId] = {
        ...newCounts[groupId],
        [subject]: Math.max(0, Math.min(9, count)), // 0-9 범위 제한
      };
      return newCounts;
    });
  };

  // 전체 일괄 적용
  const handleGlobalApply = () => {
    const newCounts = { ...subjectCounts };
    participants.forEach((p) => {
      if (!newCounts[p.groupId]) {
        newCounts[p.groupId] = {};
      }
      AVAILABLE_SUBJECTS.forEach((subject) => {
        newCounts[p.groupId][subject] = globalSubjectCounts[subject] || 0;
      });
    });
    setSubjectCounts(newCounts);
    setGlobalSubjectCounts({});
    toast.showSuccess("모든 학생에게 일괄 적용되었습니다.");
  };

  // 전체 증가/감소
  const handleGlobalAdjust = () => {
    if (!globalAdjustSubject || globalAdjustAmount === 0) {
      toast.showError("교과와 조정량을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    participants.forEach((p) => {
      if (!newCounts[p.groupId]) {
        newCounts[p.groupId] = {};
      }
      const current = newCounts[p.groupId][globalAdjustSubject] || 0;
      const newValue = Math.max(0, Math.min(9, current + globalAdjustAmount));
      newCounts[p.groupId][globalAdjustSubject] = newValue;
    });
    setSubjectCounts(newCounts);
    setGlobalAdjustSubject("");
    setGlobalAdjustAmount(0);
    toast.showSuccess(`모든 학생의 ${globalAdjustSubject} 수량이 조정되었습니다.`);
  };

  // 선택한 학생 일괄 적용
  const handleIndividualApply = () => {
    if (selectedStudentIds.size === 0) {
      toast.showError("적용할 학생을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    selectedStudentIds.forEach((groupId) => {
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      AVAILABLE_SUBJECTS.forEach((subject) => {
        newCounts[groupId][subject] = individualSubjectCounts[subject] || 0;
      });
    });
    setSubjectCounts(newCounts);
    setIndividualSubjectCounts({});
    setOpenPopoverId(null);
    toast.showSuccess(`${selectedStudentIds.size}명의 학생에게 일괄 적용되었습니다.`);
  };

  // 선택한 학생 증가/감소
  const handleIndividualAdjust = () => {
    if (selectedStudentIds.size === 0) {
      toast.showError("조정할 학생을 선택해주세요.");
      return;
    }
    if (!individualAdjustSubject || individualAdjustAmount === 0) {
      toast.showError("교과와 조정량을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    selectedStudentIds.forEach((groupId) => {
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      const current = newCounts[groupId][individualAdjustSubject] || 0;
      const newValue = Math.max(0, Math.min(9, current + individualAdjustAmount));
      newCounts[groupId][individualAdjustSubject] = newValue;
    });
    setSubjectCounts(newCounts);
    setIndividualAdjustSubject("");
    setIndividualAdjustAmount(0);
    setOpenPopoverId(null);
    toast.showSuccess(`${selectedStudentIds.size}명의 학생의 ${individualAdjustSubject} 수량이 조정되었습니다.`);
  };

  // 선택한 학생 초기화
  const handleIndividualReset = () => {
    if (selectedStudentIds.size === 0) {
      toast.showError("초기화할 학생을 선택해주세요.");
      return;
    }

    const newCounts = { ...subjectCounts };
    selectedStudentIds.forEach((groupId) => {
      if (!newCounts[groupId]) {
        newCounts[groupId] = {};
      }
      AVAILABLE_SUBJECTS.forEach((subject) => {
        newCounts[groupId][subject] = 0;
      });
    });
    setSubjectCounts(newCounts);
    setOpenPopoverId(null);
    toast.showSuccess(`${selectedStudentIds.size}명의 학생이 초기화되었습니다.`);
  };

  // 다음 단계로 진행 (콘텐츠 추천 적용 후)
  const handleNext = () => {
    const validation = validateCounts();
    if (!validation.valid) {
      const errorMsg = validation.errors
        .map((e) => `${e.studentName}: ${e.total}개 (최대 9개)`)
        .join(", ");
      toast.showError(`최대 수량을 초과한 학생이 있습니다: ${errorMsg}`);
      return;
    }

    // groupId -> (subject -> count) 형식으로 변환
    const subjectCountsMap: Record<string, Record<string, number>> = {};
    participants.forEach((p) => {
      const counts = subjectCounts[p.groupId] || {};
      const filteredCounts: Record<string, number> = {};
      AVAILABLE_SUBJECTS.forEach((subject) => {
        const count = counts[subject] || 0;
        if (count > 0) {
          filteredCounts[subject] = count;
        }
      });
      if (Object.keys(filteredCounts).length > 0) {
        subjectCountsMap[p.groupId] = filteredCounts;
      }
    });

    if (Object.keys(subjectCountsMap).length === 0) {
      toast.showError("적용할 추천 콘텐츠가 없습니다. 최소 1개 이상의 교과/수량을 설정해주세요.");
      return;
    }

    // 콘텐츠 추천 적용
    startTransition(async () => {
      try {
        const result = await bulkApplyRecommendedContents(
          templateId,
          participants.map((p) => p.groupId),
          subjectCountsMap,
          { replaceExisting }
        );

        if (result.success) {
          toast.showSuccess(
            `${result.successCount}명의 학생에게 추천 콘텐츠가 적용되었습니다.`
          );
          onComplete({
            subjectCounts: subjectCountsMap,
            replaceExisting,
          });
        } else {
          const errorMsg =
            result.errors && result.errors.length > 0
              ? `${result.failureCount}개 실패: ${result.errors[0].error}`
              : "일괄 적용에 실패했습니다.";
          toast.showError(errorMsg);
        }
      } catch (error) {
        console.error("추천 콘텐츠 일괄 적용 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "일괄 적용에 실패했습니다."
        );
      }
    });
  };

  const summary = calculateSummary();

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h3 className="text-lg font-semibold text-gray-900">Step 1: 콘텐츠 추천 설정</h3>
        <p className="text-sm text-gray-700">
          학생별로 교과와 수량을 설정합니다. 학생당 최대 9개까지 설정할 수 있습니다.
        </p>
      </div>

      {/* 요약 섹션 */}
      <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
        <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <Users className="h-4 w-4" />
            <span>선택된 학생</span>
          </div>
          <div className="text-2xl font-bold text-gray-900">
            {participants.length}
          </div>
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <BookOpen className="h-4 w-4" />
            <span>전체 콘텐츠</span>
          </div>
          <div className="text-2xl font-bold text-gray-900">
            {summary.totalContents}
          </div>
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <CheckCircle2 className="h-4 w-4" />
            <span>교과별 합계</span>
          </div>
          <div className="flex flex-col gap-0.5">
            {AVAILABLE_SUBJECTS.map((subject) => (
              <div key={subject} className="text-xs font-semibold text-gray-900">
                <span className="text-gray-600">{subject}:</span>{" "}
                <span className="text-gray-900">{summary.subjectTotals[subject] || 0}</span>
              </div>
            ))}
          </div>
        </div>
        <div className={`rounded-lg border p-4 ${
          summary.overLimitCount > 0
            ? "border-red-200 bg-red-50"
            : "border-gray-200 bg-white"
        }`}>
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <AlertTriangle className={`h-4 w-4 ${
              summary.overLimitCount > 0 ? "text-red-600" : "text-gray-400"
            }`} />
            <span>초과 학생</span>
          </div>
          <div className={`text-2xl font-bold ${
            summary.overLimitCount > 0 ? "text-red-600" : "text-gray-900"
          }`}>
            {summary.overLimitCount}
          </div>
        </div>
      </div>

      {/* 전체 조율 컨트롤 */}
      <div className="flex flex-col gap-5 rounded-lg border border-gray-200 bg-gray-50 p-5 md:p-6">
        <h3 className="text-sm font-semibold text-gray-900">전체 조율</h3>
        
        {/* 일괄 적용 */}
        <div className="flex flex-col gap-3">
          <label className="block text-xs font-medium text-gray-700">
            모든 학생에게 일괄 적용
          </label>
          <div className="flex flex-row flex-wrap gap-2 items-center">
            {AVAILABLE_SUBJECTS.map((subject) => {
              const current = globalSubjectCounts[subject] || 0;
              return (
                <div key={subject} className="flex items-center gap-1.5 shrink-0">
                  <label className="text-xs font-medium text-gray-700 whitespace-nowrap">{subject}:</label>
                  <div className="flex items-center gap-1">
                    <button
                      type="button"
                      onClick={() =>
                        setGlobalSubjectCounts({
                          ...globalSubjectCounts,
                          [subject]: Math.max(0, current - 1),
                        })
                      }
                      disabled={current === 0}
                      className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white shrink-0"
                      aria-label={`${subject} 감소`}
                    >
                      <Minus className="h-3 w-3" />
                    </button>
                    <span className="min-w-[1.5rem] text-center text-xs font-semibold text-gray-900">
                      {current}
                    </span>
                    <button
                      type="button"
                      onClick={() =>
                        setGlobalSubjectCounts({
                          ...globalSubjectCounts,
                          [subject]: Math.min(9, current + 1),
                        })
                      }
                      disabled={current === 9}
                      className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white shrink-0"
                      aria-label={`${subject} 증가`}
                    >
                      <Plus className="h-3 w-3" />
                    </button>
                  </div>
                </div>
              );
            })}
            <button
              type="button"
              onClick={handleGlobalApply}
              className="ml-auto shrink-0 rounded bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
            >
              적용
            </button>
          </div>
        </div>

        {/* 일괄 증가/감소 */}
        <div className="flex flex-col gap-3">
          <label className="block text-xs font-medium text-gray-700">
            모든 학생 증가/감소
          </label>
          <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
            <select
              value={globalAdjustSubject}
              onChange={(e) => setGlobalAdjustSubject(e.target.value)}
              className="rounded border border-gray-300 px-2 py-1 text-sm"
            >
              <option value="">교과 선택</option>
              {AVAILABLE_SUBJECTS.map((subject) => (
                <option key={subject} value={subject}>
                  {subject}
                </option>
              ))}
            </select>
            <button
              type="button"
              onClick={() => setGlobalAdjustAmount(-1)}
              className="rounded border border-gray-300 bg-white px-2 py-1 text-sm hover:bg-gray-50"
            >
              -1
            </button>
            <button
              type="button"
              onClick={() => setGlobalAdjustAmount(1)}
              className="rounded border border-gray-300 bg-white px-2 py-1 text-sm hover:bg-gray-50"
            >
              +1
            </button>
            <button
              type="button"
              onClick={handleGlobalAdjust}
              disabled={!globalAdjustSubject || globalAdjustAmount === 0}
              className="rounded bg-indigo-600 px-3 py-1 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
            >
              적용
            </button>
          </div>
        </div>
      </div>

      {/* 테이블 */}
      <div className="max-h-[60vh] overflow-y-auto overflow-x-hidden">
        <table className="w-full border-collapse rounded-lg border border-gray-200 bg-white text-sm">
          <thead className="sticky top-0 z-10 bg-gray-50 shadow-sm">
            <tr>
              <th className="border-b border-gray-200 px-3 py-2 text-left text-xs font-semibold text-gray-900">
                <input
                  type="checkbox"
                  checked={selectedStudentIds.size === participants.length}
                  onChange={(e) => {
                    if (e.target.checked) {
                      setSelectedStudentIds(new Set(participants.map((p) => p.groupId)));
                    } else {
                      setSelectedStudentIds(new Set());
                    }
                  }}
                  className="rounded border-gray-300"
                />
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-900 min-w-[120px]">
                학생명
              </th>
              {AVAILABLE_SUBJECTS.map((subject) => (
                <th
                  key={subject}
                  className="border-b border-gray-200 px-3 py-3 text-center text-xs font-semibold text-gray-900 min-w-[100px]"
                >
                  {subject}
                </th>
              ))}
              <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900 min-w-[80px]">
                총합
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900 min-w-[80px]">
                조율
              </th>
            </tr>
          </thead>
          <tbody>
            {participants.map((p) => {
              const total = calculateTotal(p.groupId);
              const isSelected = selectedStudentIds.has(p.groupId);
              const isOverLimit = total > 9;
              
              return (
                <tr
                  key={p.groupId}
                  className={`transition-colors ${
                    isOverLimit
                      ? "bg-red-50 hover:bg-red-100"
                      : total === 9
                      ? "bg-orange-50 hover:bg-orange-100"
                      : "hover:bg-gray-50"
                  }`}
                >
                  <td className="border-b border-gray-200 px-4 py-3">
                    <input
                      type="checkbox"
                      checked={isSelected}
                      onChange={(e) => {
                        const newSet = new Set(selectedStudentIds);
                        if (e.target.checked) {
                          newSet.add(p.groupId);
                        } else {
                          newSet.delete(p.groupId);
                        }
                        setSelectedStudentIds(newSet);
                      }}
                      className="rounded border-gray-300"
                    />
                  </td>
                  <td className="border-b border-gray-200 px-4 py-3 font-medium text-gray-900 min-w-[120px]">
                    <div className="truncate" title={p.studentName}>
                      {p.studentName}
                    </div>
                  </td>
                  {AVAILABLE_SUBJECTS.map((subject) => {
                    const current = subjectCounts[p.groupId]?.[subject] || 0;
                    return (
                      <td key={subject} className="border-b border-gray-200 px-3 py-3">
                        <div className="flex items-center justify-center gap-1.5">
                          <button
                            type="button"
                            onClick={() => updateCount(p.groupId, subject, current - 1)}
                            disabled={current === 0}
                            className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                            aria-label={`${subject} 감소`}
                          >
                            <Minus className="h-3.5 w-3.5" />
                          </button>
                          <span className="min-w-[2rem] text-center text-sm font-semibold text-gray-900">
                            {current}
                          </span>
                          <button
                            type="button"
                            onClick={() => updateCount(p.groupId, subject, current + 1)}
                            disabled={current === 9}
                            className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                            aria-label={`${subject} 증가`}
                          >
                            <Plus className="h-3.5 w-3.5" />
                          </button>
                        </div>
                      </td>
                    );
                  })}
                  <td
                    className={`border-b border-gray-200 px-4 py-3 text-center font-semibold ${
                      isOverLimit
                        ? "text-red-600"
                        : total === 9
                        ? "text-orange-600"
                        : "text-gray-900"
                    }`}
                  >
                    <div className="flex items-center justify-center gap-1">
                      {isOverLimit && <AlertTriangle className="h-4 w-4 text-red-600" />}
                      {total === 9 && !isOverLimit && (
                        <AlertTriangle className="h-4 w-4 text-orange-600" />
                      )}
                      <span>
                        {total}/9
                      </span>
                    </div>
                  </td>
                  <td className="border-b border-gray-200 px-4 py-3 text-center">
                    <div className="relative">
                      <button
                        type="button"
                        onClick={() =>
                          setOpenPopoverId(
                            openPopoverId === p.groupId ? null : p.groupId
                          )
                        }
                        className="rounded border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 transition hover:bg-gray-50 hover:border-gray-400"
                      >
                        조율
                      </button>
                      {openPopoverId === p.groupId && (
                        <div className="absolute right-0 top-full z-10 w-72 rounded-lg border border-gray-200 bg-white p-4 shadow-xl">
                          <div className="flex flex-col gap-3">
                            <div className="flex flex-col gap-2">
                              <label className="block text-xs font-medium text-gray-700">
                                선택한 학생에게 일괄 적용
                              </label>
                              <div className="flex flex-col gap-2">
                                {AVAILABLE_SUBJECTS.map((subject) => {
                                  const current = individualSubjectCounts[subject] || 0;
                                  return (
                                    <div key={subject} className="flex items-center justify-between gap-2">
                                      <label className="text-xs font-medium text-gray-700 min-w-[3rem]">{subject}:</label>
                                      <div className="flex items-center gap-1.5">
                                        <button
                                          type="button"
                                          onClick={() =>
                                            setIndividualSubjectCounts({
                                              ...individualSubjectCounts,
                                              [subject]: Math.max(0, current - 1),
                                            })
                                          }
                                          disabled={current === 0}
                                          className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                                          aria-label={`${subject} 감소`}
                                        >
                                          <Minus className="h-3 w-3" />
                                        </button>
                                        <span className="min-w-[1.5rem] text-center text-xs font-semibold text-gray-900">
                                          {current}
                                        </span>
                                        <button
                                          type="button"
                                          onClick={() =>
                                            setIndividualSubjectCounts({
                                              ...individualSubjectCounts,
                                              [subject]: Math.min(9, current + 1),
                                            })
                                          }
                                          disabled={current === 9}
                                          className="flex h-6 w-6 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-30 disabled:hover:bg-white"
                                          aria-label={`${subject} 증가`}
                                        >
                                          <Plus className="h-3 w-3" />
                                        </button>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                              <button
                                type="button"
                                onClick={handleIndividualApply}
                                className="w-full rounded bg-indigo-600 px-2 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
                              >
                                적용
                              </button>
                            </div>
                            
                            <div className="flex flex-col gap-2">
                              <label className="block text-xs font-medium text-gray-700">
                                선택한 학생 증가/감소
                              </label>
                              <div className="flex items-center gap-1">
                                <select
                                  value={individualAdjustSubject}
                                  onChange={(e) => setIndividualAdjustSubject(e.target.value)}
                                  className="flex-1 rounded border border-gray-300 px-2 py-1 text-xs"
                                >
                                  <option value="">교과 선택</option>
                                  {AVAILABLE_SUBJECTS.map((subject) => (
                                    <option key={subject} value={subject}>
                                      {subject}
                                    </option>
                                  ))}
                                </select>
                                <button
                                  type="button"
                                  onClick={() => setIndividualAdjustAmount(-1)}
                                  className="rounded border border-gray-300 bg-white px-2 py-1 text-xs hover:bg-gray-50"
                                >
                                  -1
                                </button>
                                <button
                                  type="button"
                                  onClick={() => setIndividualAdjustAmount(1)}
                                  className="rounded border border-gray-300 bg-white px-2 py-1 text-xs hover:bg-gray-50"
                                >
                                  +1
                                </button>
                              </div>
                              <button
                                type="button"
                                onClick={handleIndividualAdjust}
                                disabled={!individualAdjustSubject || individualAdjustAmount === 0}
                                className="w-full rounded bg-indigo-600 px-2 py-1 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
                              >
                                적용
                              </button>
                            </div>
                            
                            <div>
                              <button
                                type="button"
                                onClick={handleIndividualReset}
                                className="w-full rounded border border-red-300 bg-white px-2 py-1 text-xs font-semibold text-red-600 hover:bg-red-50"
                              >
                                선택한 학생 초기화
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* 적용 옵션 */}
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-5 md:p-6">
        <label className="flex items-center gap-3 cursor-pointer">
          <input
            type="checkbox"
            checked={replaceExisting}
            onChange={(e) => setReplaceExisting(e.target.checked)}
            className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
          />
          <span className="text-sm text-gray-700">
            기존 추천 콘텐츠 교체 (체크 시 기존 추천 콘텐츠를 삭제하고 새로 추가)
          </span>
        </label>
      </div>

      {/* 액션 버튼 */}
      <div className="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
        <button
          type="button"
          onClick={onBack}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </button>
        <button
          type="button"
          onClick={handleNext}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {isPending ? "적용 중..." : "다음 단계"}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/Step2RangeAdjustment.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { getPlanGroupContentsForRangeAdjustment } from "@/app/(admin)/actions/campTemplateActions";
import type { ScheduleSummary } from "@/lib/plan/rangeRecommendation";
import { Minus, Plus, AlertTriangle, Loader2 } from "lucide-react";

type Participant = {
  groupId: string;
  studentId: string;
  studentName: string;
};

type Step2RangeAdjustmentProps = {
  templateId: string;
  participants: Participant[];
  step1Data: {
    subjectCounts: Record<string, Record<string, number>>;
    replaceExisting: boolean;
  };
  initialData?: {
    rangeAdjustments: Record<string, Array<{
      contentId: string;
      contentType: "book" | "lecture";
      startRange: number;
      endRange: number;
    }>>;
  } | null;
  onComplete: (data: {
    rangeAdjustments: Record<string, Array<{
      contentId: string;
      contentType: "book" | "lecture";
      startRange: number;
      endRange: number;
    }>>;
  }) => void;
  onBack: () => void;
};

type ContentInfo = {
  contentId: string;
  contentType: "book" | "lecture";
  title: string;
  totalAmount: number;
  currentStartRange: number;
  currentEndRange: number;
  recommendedStartRange?: number;
  recommendedEndRange?: number;
  unavailableReason?: string;
};

type StudentContentData = {
  groupId: string;
  studentName: string;
  contents: ContentInfo[];
  scheduleSummary: ScheduleSummary | null;
  loading: boolean;
  error?: string;
};

export function Step2RangeAdjustment({
  templateId,
  participants,
  step1Data,
  initialData,
  onComplete,
  onBack,
}: Step2RangeAdjustmentProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  const [studentData, setStudentData] = useState<Map<string, StudentContentData>>(new Map());
  const [rangeAdjustments, setRangeAdjustments] = useState<Record<string, Array<{
    contentId: string;
    contentType: "book" | "lecture";
    startRange: number;
    endRange: number;
  }>>>(initialData?.rangeAdjustments || {});

  // Step 1에서 설정한 콘텐츠에 대한 범위 추천 계산
  useEffect(() => {
    const loadData = async () => {
      const newStudentData = new Map<string, StudentContentData>();

      // 각 학생의 콘텐츠 및 스케줄 정보 조회
      for (const participant of participants) {
        try {
          // 서버 액션을 통해 콘텐츠 및 스케줄 정보 조회
          const result = await getPlanGroupContentsForRangeAdjustment(participant.groupId);

          if (!result.success || !result.contents) {
            newStudentData.set(participant.groupId, {
              groupId: participant.groupId,
              studentName: participant.studentName,
              contents: [],
              scheduleSummary: null,
              loading: false,
              error: result.error || "데이터 조회에 실패했습니다.",
            });
            continue;
          }

          // 콘텐츠 정보 변환
          const contentInfos: ContentInfo[] = result.contents.map((content) => ({
            contentId: content.contentId,
            contentType: content.contentType,
            title: content.title,
            totalAmount: content.totalAmount,
            currentStartRange: content.currentStartRange,
            currentEndRange: content.currentEndRange,
          }));

          // 스케줄 요약 정보
          const scheduleSummary: ScheduleSummary | null = result.scheduleSummary || null;

          // 서버에서 계산된 범위 추천 정보 사용
          const recommendedRanges = result.recommendedRanges || {};
          const unavailableReasons = result.unavailableReasons || {};

          // 추천 범위 적용
          const contentsWithRecommendation = contentInfos.map((content) => {
            const recommended = recommendedRanges[content.contentId];
            const unavailableReason = unavailableReasons[content.contentId];

            return {
              ...content,
              recommendedStartRange: recommended?.start,
              recommendedEndRange: recommended?.end,
              unavailableReason,
            };
          });

          newStudentData.set(participant.groupId, {
            groupId: participant.groupId,
            studentName: participant.studentName,
            contents: contentsWithRecommendation,
            scheduleSummary,
            loading: false,
          });
        } catch (error) {
          console.error(`학생 ${participant.studentName} 데이터 로드 실패:`, error);
          newStudentData.set(participant.groupId, {
            groupId: participant.groupId,
            studentName: participant.studentName,
            contents: [],
            scheduleSummary: null,
            loading: false,
            error: error instanceof Error ? error.message : "데이터 로드 실패",
          });
        }
      }

      setStudentData(newStudentData);

      // 초기 범위 조절 데이터 설정 (추천 범위 사용)
      const initialAdjustments: Record<string, Array<{
        contentId: string;
        contentType: "book" | "lecture";
        startRange: number;
        endRange: number;
      }>> = {};

      newStudentData.forEach((data, groupId) => {
        if (data.contents.length > 0) {
          initialAdjustments[groupId] = data.contents.map((content) => ({
            contentId: content.contentId,
            contentType: content.contentType,
            startRange: content.recommendedStartRange ?? content.currentStartRange,
            endRange: content.recommendedEndRange ?? content.currentEndRange,
          }));
        }
      });

      setRangeAdjustments(initialAdjustments);
    };

    loadData();
  }, [templateId, participants, step1Data, toast]);

  const updateRange = (groupId: string, contentId: string, field: "startRange" | "endRange", value: number) => {
    setRangeAdjustments((prev) => {
      const adjustments = prev[groupId] || [];
      const updated = adjustments.map((adj) =>
        adj.contentId === contentId ? { ...adj, [field]: value } : adj
      );
      return { ...prev, [groupId]: updated };
    });
  };

  const applyRecommendedRange = (groupId: string, contentId: string) => {
    const studentDataItem = studentData.get(groupId);
    if (!studentDataItem) return;

    const content = studentDataItem.contents.find((c) => c.contentId === contentId);
    if (!content || !content.recommendedStartRange || !content.recommendedEndRange) return;

    updateRange(groupId, contentId, "startRange", content.recommendedStartRange);
    updateRange(groupId, contentId, "endRange", content.recommendedEndRange);
  };

  const handleNext = () => {
    // 범위 유효성 검증
    const errors: string[] = [];
    Object.entries(rangeAdjustments).forEach(([groupId, adjustments]) => {
      const studentName = studentData.get(groupId)?.studentName || "알 수 없음";
      adjustments.forEach((adj) => {
        if (adj.startRange >= adj.endRange) {
          errors.push(`${studentName}: 콘텐츠 ${adj.contentId}의 범위가 유효하지 않습니다.`);
        }
      });
    });

    if (errors.length > 0) {
      toast.showError(errors[0]);
      return;
    }

    onComplete({ rangeAdjustments });
  };

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h3 className="text-lg font-semibold text-gray-900">Step 2: 범위 조절</h3>
        <p className="text-sm text-gray-700">
          각 콘텐츠의 학습 범위를 조절합니다. 자동 추천된 범위를 사용하거나 수동으로 조절할 수 있습니다.
        </p>
      </div>

      {/* 학생별 콘텐츠 범위 테이블 */}
      <div className="flex flex-col gap-6">
        {Array.from(studentData.values()).map((data) => (
          <div key={data.groupId} className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4">
            <h4 className="text-sm font-semibold text-gray-900">
              {data.studentName}
            </h4>
            {data.loading ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="h-6 w-6 animate-spin text-gray-400" />
                <span className="text-sm text-gray-600">로딩 중...</span>
              </div>
            ) : data.error ? (
              <div className="rounded-lg border border-red-200 bg-red-50 p-4">
                <p className="text-sm text-red-800">{data.error}</p>
              </div>
            ) : data.contents.length === 0 ? (
              <p className="text-sm text-gray-500">콘텐츠가 없습니다.</p>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-2 text-left text-xs font-semibold text-gray-900">
                        콘텐츠
                      </th>
                      <th className="px-4 py-2 text-center text-xs font-semibold text-gray-900">
                        총량
                      </th>
                      <th className="px-4 py-2 text-center text-xs font-semibold text-gray-900">
                        시작 범위
                      </th>
                      <th className="px-4 py-2 text-center text-xs font-semibold text-gray-900">
                        종료 범위
                      </th>
                      <th className="px-4 py-2 text-center text-xs font-semibold text-gray-900">
                        작업
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.contents.map((content) => {
                      const adjustments = rangeAdjustments[data.groupId] || [];
                      const adjustment = adjustments.find((a) => a.contentId === content.contentId);
                      const startRange = adjustment?.startRange ?? content.currentStartRange;
                      const endRange = adjustment?.endRange ?? content.currentEndRange;
                      const hasRecommendation = content.recommendedStartRange !== undefined && content.recommendedEndRange !== undefined;

                      return (
                        <tr key={content.contentId} className="border-b border-gray-100">
                          <td className="px-4 py-3">
                            <div className="font-medium text-gray-900">{content.title}</div>
                            <div className="text-xs text-gray-500">{content.contentType === "book" ? "교재" : "강의"}</div>
                          </td>
                          <td className="px-4 py-3 text-center text-gray-600">
                            {content.totalAmount > 0 ? content.totalAmount : "—"}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex items-center justify-center gap-1">
                              <button
                                type="button"
                                onClick={() => updateRange(data.groupId, content.contentId, "startRange", Math.max(1, startRange - 1))}
                                className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50"
                              >
                                <Minus className="h-3.5 w-3.5" />
                              </button>
                              <input
                                type="number"
                                value={startRange}
                                onChange={(e) => {
                                  const value = parseInt(e.target.value) || 1;
                                  updateRange(data.groupId, content.contentId, "startRange", Math.max(1, Math.min(value, endRange - 1)));
                                }}
                                className="w-20 rounded border border-gray-300 px-2 py-1 text-center text-sm"
                                min={1}
                                max={endRange - 1}
                              />
                              <button
                                type="button"
                                onClick={() => updateRange(data.groupId, content.contentId, "startRange", Math.min(startRange + 1, endRange - 1))}
                                className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50"
                              >
                                <Plus className="h-3.5 w-3.5" />
                              </button>
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex items-center justify-center gap-1">
                              <button
                                type="button"
                                onClick={() => updateRange(data.groupId, content.contentId, "endRange", Math.max(startRange + 1, endRange - 1))}
                                className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50"
                              >
                                <Minus className="h-3.5 w-3.5" />
                              </button>
                              <input
                                type="number"
                                value={endRange}
                                onChange={(e) => {
                                  const value = parseInt(e.target.value) || 1;
                                  updateRange(data.groupId, content.contentId, "endRange", Math.max(startRange + 1, Math.min(value, content.totalAmount || 9999)));
                                }}
                                className="w-20 rounded border border-gray-300 px-2 py-1 text-center text-sm"
                                min={startRange + 1}
                                max={content.totalAmount || 9999}
                              />
                              <button
                                type="button"
                                onClick={() => updateRange(data.groupId, content.contentId, "endRange", Math.min(endRange + 1, content.totalAmount || 9999))}
                                className="flex h-7 w-7 items-center justify-center rounded border border-gray-300 bg-white text-gray-700 transition hover:bg-gray-50"
                              >
                                <Plus className="h-3.5 w-3.5" />
                              </button>
                            </div>
                          </td>
                          <td className="px-4 py-3 text-center">
                            {hasRecommendation && (
                              <button
                                type="button"
                                onClick={() => applyRecommendedRange(data.groupId, content.contentId)}
                                className="rounded border border-indigo-300 bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700 transition hover:bg-indigo-100"
                              >
                                추천 적용
                              </button>
                            )}
                            {content.unavailableReason && (
                              <div className="flex items-center gap-1 text-xs text-red-600">
                                <AlertTriangle className="h-3 w-3" />
                                <span>{content.unavailableReason}</span>
                              </div>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* 액션 버튼 */}
      <div className="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
        <button
          type="button"
          onClick={onBack}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          이전
        </button>
        <button
          type="button"
          onClick={handleNext}
          disabled={isPending}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          다음 단계
        </button>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/Step3PlanPreview.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { bulkPreviewPlans, bulkAdjustPlanRanges } from "@/app/(admin)/actions/campTemplateActions";
import { Loader2, CheckCircle2, AlertTriangle } from "lucide-react";

type Participant = {
  groupId: string;
  studentId: string;
  studentName: string;
};

type Step3PlanPreviewProps = {
  templateId: string;
  participants: Participant[];
  step1Data: {
    subjectCounts: Record<string, Record<string, number>>;
    replaceExisting: boolean;
  };
  step2Data: {
    rangeAdjustments: Record<string, Array<{
      contentId: string;
      contentType: "book" | "lecture";
      startRange: number;
      endRange: number;
    }>>;
  };
  initialData?: {
    selectedGroupIds: Set<string>;
    previewResults?: Record<string, {
      planCount: number;
      previewData?: any[];
      error?: string;
    }>;
  } | null;
  onComplete: (data: {
    selectedGroupIds: Set<string>;
    previewResults?: Record<string, {
      planCount: number;
      previewData?: any[];
      error?: string;
    }>;
  }) => void;
  onBack: () => void;
};

export function Step3PlanPreview({
  templateId,
  participants,
  step1Data,
  step2Data,
  initialData,
  onComplete,
  onBack,
}: Step3PlanPreviewProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  const [loading, setLoading] = useState(false);
  const [selectedGroupIds, setSelectedGroupIds] = useState<Set<string>>(
    initialData?.selectedGroupIds || new Set(participants.map((p) => p.groupId))
  );
  const [previewResults, setPreviewResults] = useState<Record<string, {
    planCount: number;
    previewData?: any[];
    error?: string;
  }>>(initialData?.previewResults || {});

  // 범위 조절 저장 (플랜 미리보기 전에 저장)
  const saveRanges = async () => {
    try {
      const result = await bulkAdjustPlanRanges(
        participants.map((p) => p.groupId),
        step2Data.rangeAdjustments
      );

      if (!result.success) {
        toast.showError("범위 조절 저장에 실패했습니다.");
        return false;
      }
      return true;
    } catch (error) {
      console.error("범위 조절 저장 실패:", error);
      toast.showError("범위 조절 저장 중 오류가 발생했습니다.");
      return false;
    }
  };

  const handlePreview = async () => {
    setLoading(true);
    try {
      // 먼저 범위 조절 저장
      const saved = await saveRanges();
      if (!saved) {
        setLoading(false);
        return;
      }

      // 플랜 미리보기 실행
      const result = await bulkPreviewPlans(participants.map((p) => p.groupId));
      
      const resultsMap: Record<string, {
        planCount: number;
        previewData?: any[];
        error?: string;
      }> = {};

      result.previews.forEach((preview) => {
        resultsMap[preview.groupId] = {
          planCount: preview.planCount,
          previewData: preview.previewData,
          error: preview.error,
        };
      });

      setPreviewResults(resultsMap);
      toast.showSuccess("플랜 미리보기가 완료되었습니다.");
    } catch (error) {
      console.error("플랜 미리보기 실패:", error);
      toast.showError("플랜 미리보기에 실패했습니다.");
    } finally {
      setLoading(false);
    }
  };

  const handleNext = () => {
    if (selectedGroupIds.size === 0) {
      toast.showError("플랜을 생성할 학생을 최소 1명 이상 선택해주세요.");
      return;
    }

    onComplete({
      selectedGroupIds,
      previewResults,
    });
  };

  const toggleSelection = (groupId: string) => {
    setSelectedGroupIds((prev) => {
      const next = new Set(prev);
      if (next.has(groupId)) {
        next.delete(groupId);
      } else {
        next.add(groupId);
      }
      return next;
    });
  };

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h3 className="text-lg font-semibold text-gray-900">Step 3: 플랜 미리보기</h3>
        <p className="text-sm text-gray-700">
          각 학생의 플랜을 미리보고, 플랜을 생성할 학생을 선택합니다.
        </p>
      </div>

      <div className="flex items-center justify-between">
        <button
          type="button"
          onClick={handlePreview}
          disabled={loading}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          {loading ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin" />
              미리보기 중...
            </>
          ) : (
            "플랜 미리보기"
          )}
        </button>
      </div>

      {/* 학생별 미리보기 결과 */}
      <div className="space-y-4">
        {participants.map((participant) => {
          const result = previewResults[participant.groupId];
          const isSelected = selectedGroupIds.has(participant.groupId);
          const hasError = result?.error;
          const planCount = result?.planCount ?? 0;

          return (
            <div
              key={participant.groupId}
              className={`rounded-lg border p-4 ${
                hasError
                  ? "border-red-200 bg-red-50"
                  : isSelected
                  ? "border-indigo-200 bg-indigo-50"
                  : "border-gray-200 bg-white"
              }`}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <input
                    type="checkbox"
                    checked={isSelected}
                    onChange={() => toggleSelection(participant.groupId)}
                    disabled={hasError !== undefined}
                    className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                  />
                  <div>
                    <div className="font-medium text-gray-900">
                      {participant.studentName}
                    </div>
                    {result && (
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        {hasError ? (
                          <>
                            <AlertTriangle className="h-4 w-4 text-red-600" />
                            <span className="text-red-600">{result.error}</span>
                          </>
                        ) : (
                          <>
                            <CheckCircle2 className="h-4 w-4 text-green-600" />
                            <span>{planCount}개의 플랜이 생성됩니다.</span>
                          </>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* 액션 버튼 */}
      <div className="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
        <button
          type="button"
          onClick={onBack}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          이전
        </button>
        <button
          type="button"
          onClick={handleNext}
          disabled={isPending || selectedGroupIds.size === 0}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          다음 단계
        </button>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/_components/Step4Results.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { bulkApplyRecommendedContents, bulkAdjustPlanRanges, bulkGeneratePlans } from "@/app/(admin)/actions/campTemplateActions";
import { CheckCircle2, XCircle, AlertTriangle, Loader2 } from "lucide-react";

type Participant = {
  groupId: string;
  studentId: string;
  studentName: string;
};

type Step4ResultsProps = {
  templateId: string;
  participants: Participant[];
  step1Data: {
    subjectCounts: Record<string, Record<string, number>>;
    replaceExisting: boolean;
  };
  step2Data: {
    rangeAdjustments: Record<string, Array<{
      contentId: string;
      contentType: "book" | "lecture";
      startRange: number;
      endRange: number;
    }>>;
  };
  step3Data: {
    selectedGroupIds: Set<string>;
    previewResults?: Record<string, {
      planCount: number;
      previewData?: any[];
      error?: string;
    }>;
  };
  initialData?: {
    results: {
      contentRecommendation: {
        success: boolean;
        successCount: number;
        failureCount: number;
        errors?: Array<{ groupId: string; error: string }>;
      };
      rangeAdjustment: {
        success: boolean;
        successCount: number;
        failureCount: number;
        errors?: Array<{ groupId: string; error: string }>;
      };
      planGeneration: {
        success: boolean;
        successCount: number;
        failureCount: number;
        errors?: Array<{ groupId: string; error: string }>;
      };
    };
  } | null;
  onComplete: () => void;
  onBack: () => void;
};

export function Step4Results({
  templateId,
  participants,
  step1Data,
  step2Data,
  step3Data,
  initialData,
  onComplete,
  onBack,
}: Step4ResultsProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  const [processing, setProcessing] = useState(false);
  const [results, setResults] = useState<Step4ResultsProps["initialData"]>(initialData);

  // 결과 처리 실행
  useEffect(() => {
    if (results) return; // 이미 처리됨

    const processAll = async () => {
      setProcessing(true);
      try {
        // Step 1: 콘텐츠 추천 적용 (이미 Step 2에서 적용했지만 다시 확인)
        const contentResult = await bulkApplyRecommendedContents(
          templateId,
          participants.map((p) => p.groupId),
          step1Data.subjectCounts,
          { replaceExisting: step1Data.replaceExisting }
        );

        // Step 2: 범위 조절 적용
        const rangeResult = await bulkAdjustPlanRanges(
          participants.map((p) => p.groupId),
          step2Data.rangeAdjustments
        );

        // Step 3: 플랜 생성
        const selectedGroupIdsArray = Array.from(step3Data.selectedGroupIds);
        const planResult = await bulkGeneratePlans(selectedGroupIdsArray);

        setResults({
          results: {
            contentRecommendation: contentResult,
            rangeAdjustment: rangeResult,
            planGeneration: planResult,
          },
        });

        // 전체 성공 여부 확인
        const allSuccess =
          contentResult.success &&
          rangeResult.success &&
          planResult.success;

        if (allSuccess) {
          toast.showSuccess("모든 작업이 완료되었습니다.");
        } else {
          toast.showError("일부 작업이 실패했습니다. 결과를 확인해주세요.");
        }
      } catch (error) {
        console.error("작업 처리 실패:", error);
        toast.showError("작업 처리 중 오류가 발생했습니다.");
      } finally {
        setProcessing(false);
      }
    };

    processAll();
  }, [results, templateId, participants, step1Data, step2Data, step3Data, toast]);

  if (processing || !results) {
    return (
      <div className="flex flex-col items-center justify-center gap-4 py-12">
        <Loader2 className="h-8 w-8 animate-spin text-indigo-600" />
        <p className="text-sm text-gray-600">작업을 처리하는 중...</p>
      </div>
    );
  }

  const { contentRecommendation, rangeAdjustment, planGeneration } = results.results;

  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col gap-1">
        <h3 className="text-lg font-semibold text-gray-900">Step 4: 결과</h3>
        <p className="text-sm text-gray-700">
          모든 작업이 완료되었습니다. 결과를 확인해주세요.
        </p>
      </div>

      {/* 통계 */}
      <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">콘텐츠 추천</div>
          <div className="flex items-center gap-2">
            {contentRecommendation.success ? (
              <CheckCircle2 className="h-5 w-5 text-green-600" />
            ) : (
              <XCircle className="h-5 w-5 text-red-600" />
            )}
            <span className="text-lg font-semibold text-gray-900">
              {contentRecommendation.successCount} / {participants.length}
            </span>
          </div>
        </div>
        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">범위 조절</div>
          <div className="flex items-center gap-2">
            {rangeAdjustment.success ? (
              <CheckCircle2 className="h-5 w-5 text-green-600" />
            ) : (
              <XCircle className="h-5 w-5 text-red-600" />
            )}
            <span className="text-lg font-semibold text-gray-900">
              {rangeAdjustment.successCount} / {participants.length}
            </span>
          </div>
        </div>
        <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">플랜 생성</div>
          <div className="flex items-center gap-2">
            {planGeneration.success ? (
              <CheckCircle2 className="h-5 w-5 text-green-600" />
            ) : (
              <XCircle className="h-5 w-5 text-red-600" />
            )}
            <span className="text-lg font-semibold text-gray-900">
              {planGeneration.successCount} / {step3Data.selectedGroupIds.size}
            </span>
          </div>
        </div>
      </div>

      {/* 상세 결과 테이블 */}
      <div className="overflow-x-auto">
        <table className="w-full border-collapse rounded-lg border border-gray-200 bg-white text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-900">
                학생명
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900">
                콘텐츠 추천
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900">
                범위 조절
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-900">
                플랜 생성
              </th>
            </tr>
          </thead>
          <tbody>
            {participants.map((participant) => {
              const contentError = contentRecommendation.errors?.find(
                (e) => e.groupId === participant.groupId
              );
              const rangeError = rangeAdjustment.errors?.find(
                (e) => e.groupId === participant.groupId
              );
              const planError = planGeneration.errors?.find(
                (e) => e.groupId === participant.groupId
              );
              const wasSelected = step3Data.selectedGroupIds.has(participant.groupId);

              const contentSuccess = !contentError;
              const rangeSuccess = !rangeError;
              const planSuccess = !wasSelected || !planError;

              return (
                <tr key={participant.groupId} className="border-b border-gray-100">
                  <td className="px-4 py-3 font-medium text-gray-900">
                    {participant.studentName}
                  </td>
                  <td className="px-4 py-3 text-center">
                    {contentSuccess ? (
                      <CheckCircle2 className="mx-auto h-5 w-5 text-green-600" />
                    ) : (
                      <div className="flex flex-col items-center gap-1">
                        <XCircle className="h-5 w-5 text-red-600" />
                        <span className="text-xs text-red-600">{contentError?.error}</span>
                      </div>
                    )}
                  </td>
                  <td className="px-4 py-3 text-center">
                    {rangeSuccess ? (
                      <CheckCircle2 className="mx-auto h-5 w-5 text-green-600" />
                    ) : (
                      <div className="flex flex-col items-center gap-1">
                        <XCircle className="h-5 w-5 text-red-600" />
                        <span className="text-xs text-red-600">{rangeError?.error}</span>
                      </div>
                    )}
                  </td>
                  <td className="px-4 py-3 text-center">
                    {!wasSelected ? (
                      <span className="text-xs text-gray-400">선택 안 함</span>
                    ) : planSuccess ? (
                      <CheckCircle2 className="mx-auto h-5 w-5 text-green-600" />
                    ) : (
                      <div className="flex flex-col items-center gap-1">
                        <XCircle className="h-5 w-5 text-red-600" />
                        <span className="text-xs text-red-600">{planError?.error}</span>
                      </div>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* 액션 버튼 */}
      <div className="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
        <button
          type="button"
          onClick={onBack}
          className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          이전
        </button>
        <button
          type="button"
          onClick={onComplete}
          className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          완료
        </button>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/[groupId]/continue/page.tsx">
import { redirect, notFound } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getCampPlanGroupForReview } from "@/app/(admin)/actions/campTemplateActions";
import { PlanGroupWizard } from "@/app/(student)/plan/new-group/_components/PlanGroupWizard";
import { fetchAllStudentContents, classifyPlanContents } from "@/lib/data/planContents";
import { fetchBlockSetsWithBlocks } from "@/lib/data/blockSets";
import { syncCreationDataToWizardData } from "@/lib/utils/planGroupDataSync";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import Link from "next/link";

type CampContinuePageProps = {
  params: Promise<{ id: string; groupId: string }>;
  searchParams: Promise<{ step?: string }>;
};

export default async function CampContinuePage({
  params,
  searchParams,
}: CampContinuePageProps) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { id: templateId, groupId } = await params;
  const { step } = await searchParams;

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  // 플랜 그룹 및 관련 데이터 조회
  const result = await getCampPlanGroupForReview(groupId);

  if (!result.success || !result.group) {
    notFound();
  }

  const { group, contents, originalContents, exclusions, academySchedules } = result;

  // 캠프 모드 확인
  if (group.plan_type !== "camp") {
    redirect(`/admin/camp-templates/${templateId}/participants/${groupId}/review`);
  }

  // 이미 플랜이 생성된 경우 검토 페이지로 리다이렉트
  const supabase = await createSupabaseServerClient();
  const { data: plans } = await supabase
    .from("student_plan")
    .select("id")
    .eq("plan_group_id", groupId)
    .limit(1);

  if (plans && plans.length > 0) {
    redirect(`/admin/camp-templates/${templateId}/participants/${groupId}/review`);
  }

  // 학생 정보 조회 (콘텐츠 조회용 및 표시용)
  const studentId = group.student_id;
  const { data: studentInfo } = await supabase
    .from("students")
    .select("name, grade, class")
    .eq("id", studentId)
    .single();

  // 템플릿 블록 세트 조회 (캠프 모드) - 새로운 연결 테이블 방식
  let templateBlockSet: {
    id: string;
    name: string;
    blocks?: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  } | null = null;

  if (group.camp_template_id) {
    // 1. 연결 테이블에서 템플릿에 연결된 블록 세트 조회
    const { data: templateBlockSetLink, error: linkError } = await supabase
      .from("camp_template_block_sets")
      .select("tenant_block_set_id")
      .eq("camp_template_id", group.camp_template_id)
      .maybeSingle();

    let tenantBlockSetId: string | null = null;
    if (templateBlockSetLink) {
      tenantBlockSetId = templateBlockSetLink.tenant_block_set_id;
    } else {
      // 하위 호환성: template_data.block_set_id 확인 (마이그레이션 전 데이터용)
      const { data: templateBlockSetData } = await supabase
        .from("camp_templates")
        .select("template_data")
        .eq("id", group.camp_template_id)
        .maybeSingle();

      if (templateBlockSetData?.template_data?.block_set_id) {
        tenantBlockSetId = templateBlockSetData.template_data.block_set_id;
      }
    }

    if (tenantBlockSetId) {
      // 2. tenant_block_sets에서 블록 세트 정보 조회
      const { data: templateBlockSetInfo, error: blockSetError } = await supabase
        .from("tenant_block_sets")
        .select("id, name")
        .eq("id", tenantBlockSetId)
        .eq("tenant_id", tenantContext.tenantId)
        .maybeSingle();

      if (blockSetError) {
        console.error("[CampContinuePage] 템플릿 블록 세트 조회 에러:", blockSetError);
      } else if (templateBlockSetInfo) {
        // 3. tenant_blocks 테이블에서 블록 조회
        const { data: templateBlocks, error: blocksError } = await supabase
          .from("tenant_blocks")
          .select("id, day_of_week, start_time, end_time")
          .eq("tenant_block_set_id", tenantBlockSetId)
          .order("day_of_week", { ascending: true })
          .order("start_time", { ascending: true });

        if (blocksError) {
          console.error("[CampContinuePage] 템플릿 블록 조회 에러:", blocksError);
        } else if (templateBlocks && templateBlocks.length > 0) {
          templateBlockSet = {
            id: templateBlockSetInfo.id,
            name: `${templateBlockSetInfo.name} (템플릿)`,
            blocks: templateBlocks.map((b) => ({
              id: b.id,
              day_of_week: b.day_of_week,
              start_time: b.start_time,
              end_time: b.end_time,
            })),
          };
        }
      }
    }
  }

  // 학생 블록 세트 조회
  const studentBlockSets = await fetchBlockSetsWithBlocks(studentId);
  const blockSets = templateBlockSet
    ? [templateBlockSet, ...studentBlockSets]
    : studentBlockSets;

  // 콘텐츠 조회
  const { books, lectures, custom } = await fetchAllStudentContents(studentId);

  console.log("[CampContinuePage] 콘텐츠 조회 결과:", {
    groupId,
    studentId,
    booksCount: books.length,
    lecturesCount: lectures.length,
    customCount: custom.length,
    planContentsCount: contents.length,
    originalContentsCount: originalContents?.length || 0,
  });

  // 콘텐츠 정보 조회 및 학생/추천 구분 (제목, 과목 등 메타데이터 포함)
  // originalContents를 사용하여 master_content_id가 포함된 원본 데이터로 조회
  // 관리자/컨설턴트가 다른 학생의 콘텐츠를 조회할 때는 역할 정보 전달 (RLS 우회)
  const contentsForClassification = originalContents || contents;
  const { userId } = await getCurrentUserRole();
  const { studentContents: classifiedStudentContents, recommendedContents: classifiedRecommendedContents } = 
    await classifyPlanContents(contentsForClassification, studentId, {
      currentUserRole: role,
      currentUserId: userId || undefined,
    });

  console.log("[CampContinuePage] 콘텐츠 분류 결과:", {
    groupId,
    studentId,
    inputContentsCount: contentsForClassification.length,
    classifiedStudentContentsCount: classifiedStudentContents.length,
    classifiedRecommendedContentsCount: classifiedRecommendedContents.length,
    totalClassifiedCount: classifiedStudentContents.length + classifiedRecommendedContents.length,
    missingCount: contentsForClassification.length - (classifiedStudentContents.length + classifiedRecommendedContents.length),
  });

  // 콘텐츠 정보를 Map으로 변환하여 빠른 조회 (content_id를 키로 사용)
  const contentsMap = new Map(
    [...classifiedStudentContents, ...classifiedRecommendedContents].map((c) => [c.content_id, c])
  );

  // 플랜 그룹 데이터를 WizardData로 변환
  // classifyPlanContents로 조회한 정보를 사용하여 콘텐츠 정보를 제대로 표시
  // 남은 단계 진행 시에는 기존 추천 콘텐츠를 제거하여 Step 4에서 새로 선택할 수 있도록 함
  // originalContents를 사용하여 master_content_id가 포함된 원본 데이터로 변환
  const contentsForWizard = originalContents || contents;
  
  // DB에서 불러온 모든 콘텐츠 정보 로깅
  console.log("[CampContinuePage] DB에서 불러온 콘텐츠 정보:", {
    groupId,
    studentId,
    totalContentsCount: contentsForWizard.length,
    contents: contentsForWizard.map((c) => ({
      content_id: c.content_id,
      content_type: c.content_type,
      is_auto_recommended: c.is_auto_recommended,
      recommendation_source: c.recommendation_source,
      // syncCreationDataToWizardData의 분류 기준에 따른 예상 분류
      willBeStudentContent: !(c.is_auto_recommended || c.recommendation_source),
      willBeRecommendedContent: !!(c.is_auto_recommended || c.recommendation_source),
    })),
  });
  
  // 모든 콘텐츠를 syncCreationDataToWizardData에 전달
  // syncCreationDataToWizardData가 학생/추천 콘텐츠로 자동 분류함
  const wizardData = syncCreationDataToWizardData({
    group,
    contents: contentsForWizard.map((c) => {
      // classifyPlanContents에서 조회한 정보를 우선적으로 사용
      const classifiedContent = contentsMap.get(c.content_id);
      return {
        ...c,
        // classifyPlanContents에서 조회한 정보가 있으면 사용
        // title과 subject_category를 명시적으로 전달하여 정보 손실 방지
        // master_content_id는 원본 데이터(c.master_content_id)를 우선 사용
        title: classifiedContent?.title || undefined,
        subject_category: classifiedContent?.subject_category || undefined,
        master_content_id: c.master_content_id || classifiedContent?.masterContentId || undefined,
      };
    }),
    exclusions,
    academySchedules,
  });
  
  // syncCreationDataToWizardData가 분류한 결과 로깅
  console.log("[CampContinuePage] syncCreationDataToWizardData 분류 결과:", {
    groupId,
    studentId,
    studentContentsCount: wizardData.student_contents.length,
    recommendedContentsCount: wizardData.recommended_contents.length,
    totalContentsCount: wizardData.student_contents.length + wizardData.recommended_contents.length,
    studentContents: wizardData.student_contents.map((c) => ({
      content_id: c.content_id,
      content_type: c.content_type,
      title: c.title,
    })),
    recommendedContents: wizardData.recommended_contents.map((c) => ({
      content_id: c.content_id,
      content_type: c.content_type,
      title: c.title,
      is_auto_recommended: (c as any).is_auto_recommended,
      recommendation_source: (c as any).recommendation_source,
    })),
  });
  
  // 남은 단계 진행 시에는 추천 콘텐츠를 제거하여 Step 4에서 새로 선택할 수 있도록 함
  // student_contents는 그대로 유지 (학생이 추가한 콘텐츠는 보존)
  // 단, 빈 배열인 경우 undefined로 설정하여 continueCampStepsForAdmin에서 기존 학생 콘텐츠가 보존되도록 함
  // (빈 배열로 설정하면 hasStudentContents가 true이지만 length > 0이 false가 되어 기존 학생 콘텐츠가 보존되지 않음)
  // recommended_contents를 undefined로 설정하여 continueCampStepsForAdmin에서 기존 추천 콘텐츠가 보존되도록 함
  // (빈 배열로 설정하면 hasRecommendedContents가 true가 되어 기존 추천 콘텐츠가 삭제됨)
  const filteredWizardData = {
    ...wizardData,
    // student_contents가 빈 배열이면 undefined로 설정하여 기존 학생 콘텐츠 보존
    // 빈 배열을 전달하면 hasStudentContents는 true이지만 length > 0이 false가 되어 보존되지 않음
    student_contents: wizardData.student_contents && wizardData.student_contents.length > 0
      ? wizardData.student_contents
      : undefined,
    recommended_contents: undefined, // undefined로 설정하여 기존 추천 콘텐츠 보존 (Step 4에서 새로 선택 가능)
  };
  
  // 필터링 후 최종 결과 로깅
  const recommendedContentsArray = Array.isArray(filteredWizardData.recommended_contents) 
    ? filteredWizardData.recommended_contents 
    : [];
  console.log("[CampContinuePage] 필터링 후 최종 결과:", {
    groupId,
    studentId,
    originalStudentContentsCount: wizardData.student_contents.length,
    finalStudentContentsCount: filteredWizardData.student_contents?.length ?? 0,
    finalRecommendedContentsCount: recommendedContentsArray.length,
    originalRecommendedContentsCount: wizardData.recommended_contents.length,
    studentContentsWillBePreserved: filteredWizardData.student_contents === undefined,
    recommendedContentsWillBePreserved: filteredWizardData.recommended_contents === undefined,
    finalStudentContents: filteredWizardData.student_contents?.map((c) => ({
      content_id: c.content_id,
      content_type: c.content_type,
      title: c.title,
    })) || [],
  });

  // 템플릿 제외일과 학원 일정에 source, is_locked 필드 추가
  if (filteredWizardData.exclusions) {
    filteredWizardData.exclusions = filteredWizardData.exclusions.map((exclusion) => ({
      ...exclusion,
      source: (exclusion as any).source || ("student" as const),
      is_locked: (exclusion as any).is_locked || false,
    }));
  }

  if (filteredWizardData.academy_schedules) {
    filteredWizardData.academy_schedules = filteredWizardData.academy_schedules.map(
      (schedule) => ({
        ...schedule,
        source: (schedule as any).source || ("student" as const),
        is_locked: (schedule as any).is_locked || false,
      })
    );
  }

  // URL에서 step 파라미터가 있으면 해당 단계부터 시작, 없으면 Step 4부터 시작
  const startStep = step ? parseInt(step, 10) : 4;
  const validStartStep = startStep >= 4 && startStep <= 7 ? startStep : 4;

  // Step 4부터 시작하도록 설정 (콘텐츠 추가하기 단계)
  const initialData = {
    ...filteredWizardData, // 필터링된 wizardData 사용
    templateId: templateId, // URL의 templateId 사용 (관리자 페이지로 돌아가기 위해)
    groupId: group.id,
    // 템플릿 블록 세트 ID 설정 (Step1BasicInfo에서 자동 선택하기 위해)
    block_set_id: templateBlockSet?.id || filteredWizardData.block_set_id || "",
    _startStep: validStartStep, // URL 파라미터에서 받은 step 또는 기본값 4
    student_id: studentId, // Step6FinalReview에서 API 호출 시 사용
  };

  return (
    <section className="mx-auto w-full max-w-4xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-start justify-between gap-4">
          <div className="flex flex-col gap-2 flex-1">
            <p className="text-sm font-medium text-gray-500">캠프 관리</p>
            <h1 className="text-3xl font-semibold text-gray-900">
              남은 단계 진행하기
            </h1>
            <p className="text-sm text-gray-500">
              학생이 등록한 콘텐츠를 확인하고, 추천 콘텐츠를 선택하여 조율하세요.
            </p>
          </div>
          <Link
            href={`/admin/camp-templates/${templateId}/participants`}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
          >
            참여자 목록으로 돌아가기
          </Link>
        </div>
      </div>

      {/* 학생 정보 및 진행 상태 카드 */}
      <div className="flex flex-col gap-6 rounded-lg border border-blue-200 bg-blue-50 p-4">
        <div className="flex items-start justify-between">
          <div className="flex flex-col gap-2 flex-1">
            <h3 className="font-semibold text-blue-900">학생 정보</h3>
            <p className="text-sm text-blue-700">
              {studentInfo?.name || "학생"} 
              {studentInfo?.grade && studentInfo?.class 
                ? ` (${studentInfo.grade}학년 ${studentInfo.class}반)`
                : ""}
            </p>
            <p className="text-xs text-blue-600">
              플랜 그룹: {group.name || "이름 없음"}
            </p>
          </div>
          <div className="text-right">
            <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
              Step 4-7 진행 중
            </span>
          </div>
        </div>
      </div>

      <PlanGroupWizard
        initialBlockSets={blockSets || []}
        initialContents={{
          books,
          lectures,
          custom,
        }}
        initialData={initialData}
        isEditMode={true}
        isCampMode={true}
        isAdminMode={true}
        isAdminContinueMode={true}
      />
    </section>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/[groupId]/review/CampPlanGroupReviewForm.tsx">
"use client";

import { useState, useEffect, useMemo } from "react";
import Link from "next/link";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getCampPlanGroupForReview,
} from "@/app/(admin)/actions/campTemplateActions";
import { PlanGroup, PlanContent, PlanExclusion, AcademySchedule } from "@/lib/types/plan";
import { createSupabaseBrowserClient } from "@/lib/supabase/client";
import { Step1BasicInfo } from "@/app/(student)/plan/new-group/_components/Step1BasicInfo";
import { Step2TimeSettings } from "@/app/(student)/plan/new-group/_components/Step2TimeSettings";
import { Step3ContentSelection } from "@/app/(student)/plan/new-group/_components/Step3ContentSelection";
import { planGroupToWizardData } from "@/lib/utils/planGroupAdapters";
import { planPurposeLabels, schedulerTypeLabels } from "@/lib/constants/planLabels";

type CampPlanGroupReviewFormProps = {
  templateId: string;
  groupId: string;
  group: PlanGroup;
  contents: PlanContent[];
  exclusions: PlanExclusion[];
  academySchedules: AcademySchedule[];
  templateBlocks?: Array<{
    id: string;
    day_of_week: number;
    start_time: string;
    end_time: string;
  }>;
  templateBlockSetName?: string | null;
  templateBlockSetId?: string | null;
  studentInfo?: {
    name: string;
    grade: string | null;
    class: string | null;
  } | null;
};

export function CampPlanGroupReviewForm({
  templateId,
  groupId,
  group,
  contents: initialContents,
  exclusions,
  academySchedules,
  templateBlocks = [],
  templateBlockSetName = null,
  templateBlockSetId = null,
  studentInfo,
}: CampPlanGroupReviewFormProps) {
  const toast = useToast();
  const [contents, setContents] = useState(initialContents);
  const [contentInfos, setContentInfos] = useState<
    Array<{
      content_id: string;
      content_type: "book" | "lecture" | "custom";
      title: string;
      subject_category?: string | null;
    }>
  >([]);
  const [loading, setLoading] = useState(true);
  const [currentTab, setCurrentTab] = useState<"overview" | "step1" | "step2" | "step3" | "step4">("overview");

  // 콘텐츠 상세 정보 조회 (서버에서 이미 조회한 경우 재조회하지 않음)
  useEffect(() => {
    const loadContentInfos = async () => {
      try {
        setLoading(true);
        
        // 서버에서 이미 상세 정보를 포함한 경우 확인
        const hasServerDetails = contents.some(
          (c) => (c as any).contentTitle || (c as any).contentSubtitle !== undefined
        );

        if (hasServerDetails) {
          // 서버에서 이미 조회한 정보 사용
          const infos = contents.map((content) => ({
            content_id: content.content_id,
            content_type: content.content_type,
            title: (content as any).contentTitle || "",
            subject_category: (content as any).contentSubtitle || null,
          }));
          setContentInfos(infos);
          setLoading(false);
          return;
        }

        // 서버에서 조회하지 않은 경우 클라이언트에서 조회
        const supabase = createSupabaseBrowserClient();

        // 콘텐츠별로 과목 정보 조회
        const infos = await Promise.all(
          contents.map(async (content) => {
            let title = "";
            let subject_category: string | null = null;

            if (content.content_type === "book") {
              // 학생 교재 조회
              const { data: book } = await supabase
                .from("books")
                .select("title, subject_category")
                .eq("id", content.content_id)
                .maybeSingle();

              if (book) {
                title = book.title || "";
                subject_category = book.subject_category || null;
              } else {
                // 마스터 교재 조회
                const { data: masterBook } = await supabase
                  .from("master_books")
                  .select("title, subject_category")
                  .eq("id", content.content_id)
                  .maybeSingle();

                if (masterBook) {
                  title = masterBook.title || "";
                  subject_category = masterBook.subject_category || null;
                }
              }
            } else if (content.content_type === "lecture") {
              // 학생 강의 조회
              const { data: lecture } = await supabase
                .from("lectures")
                .select("title, subject_category")
                .eq("id", content.content_id)
                .maybeSingle();

              if (lecture) {
                title = lecture.title || "";
                subject_category = lecture.subject_category || null;
              } else {
                // 마스터 강의 조회
                const { data: masterLecture } = await supabase
                  .from("master_lectures")
                  .select("title, subject_category")
                  .eq("id", content.content_id)
                  .maybeSingle();

                if (masterLecture) {
                  title = masterLecture.title || "";
                  subject_category = masterLecture.subject_category || null;
                }
              }
            } else if (content.content_type === "custom") {
              // 커스텀 콘텐츠 조회
              const { data: custom } = await supabase
                .from("student_custom_contents")
                .select("title, subject")
                .eq("id", content.content_id)
                .maybeSingle();

              if (custom) {
                title = custom.title || "";
                subject_category = custom.subject || null;
              }
            }

            return {
              content_id: content.content_id,
              content_type: content.content_type,
              title,
              subject_category,
            };
          })
        );

        setContentInfos(infos);
      } catch (error) {
        console.error("콘텐츠 정보 조회 실패:", error);
        toast.showError("콘텐츠 정보를 불러오는데 실패했습니다.");
      } finally {
        setLoading(false);
      }
    };

    if (contents.length > 0) {
      loadContentInfos();
    } else {
      setLoading(false);
    }
  }, [contents, toast]);


  // 학생 콘텐츠와 추천 콘텐츠 분리
  const studentContents = useMemo(() => {
    return contents.filter((c) => {
      // is_recommended 필드가 있으면 그것을 사용, 없으면 추정
      return !(c as any).is_recommended;
    });
  }, [contents]);

  // 콘텐츠 상세 정보 추가
  const studentContentsWithDetails = useMemo(() => {
    return studentContents.map((content) => {
      const info = contentInfos.find((ci) => ci.content_id === content.content_id);
      return {
        ...content,
        contentTitle: info?.title || "알 수 없음",
        contentSubtitle: info?.subject_category || null,
        isRecommended: false,
      };
    });
  }, [studentContents, contentInfos]);

  // WizardData 생성 (Step 컴포넌트에서 사용)
  const wizardData = useMemo(() => {
    return planGroupToWizardData(
      group,
      exclusions,
      academySchedules,
      studentContentsWithDetails,
      templateBlocks,
      templateBlockSetName
    );
  }, [
    group,
    exclusions,
    academySchedules,
    studentContentsWithDetails,
    templateBlocks,
    templateBlockSetName,
  ]);

  if (loading) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="text-sm text-gray-500">콘텐츠 정보를 불러오는 중...</div>
      </section>
    );
  }

  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p className="text-sm font-medium text-gray-500">캠프 관리</p>
            <h1 className="text-3xl font-semibold text-gray-900">플랜 그룹 검토</h1>
            <p className="text-sm text-gray-500">{group.name || "플랜 그룹"}</p>
            {studentInfo && (
              <p className="text-sm text-gray-600">
                학생: {studentInfo.name}
                {studentInfo.grade && studentInfo.class
                  ? ` (${studentInfo.grade}학년 ${studentInfo.class}반)`
                  : ""}
              </p>
            )}
          </div>
          <Link
            href={`/admin/camp-templates/${templateId}/participants`}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
          >
            참여자 목록으로 돌아가기
          </Link>
        </div>

        {/* 탭 네비게이션 */}
        <div className="border-b border-gray-200">
          <nav className="-mb-px flex space-x-8">
            <button
              onClick={() => setCurrentTab("overview")}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium ${
                currentTab === "overview"
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              개요
            </button>
            <button
              onClick={() => setCurrentTab("step1")}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium ${
                currentTab === "step1"
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              Step 1: 기본 정보
            </button>
            <button
              onClick={() => setCurrentTab("step2")}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium ${
                currentTab === "step2"
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              Step 2: 블록 및 제외일
            </button>
            <button
              onClick={() => setCurrentTab("step3")}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium ${
                currentTab === "step3"
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              Step 3: 스케줄 확인
            </button>
            <button
              onClick={() => setCurrentTab("step4")}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium ${
                currentTab === "step4"
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              Step 4: 콘텐츠 선택
            </button>
          </nav>
        </div>

        {/* 탭 컨텐츠 */}
        {currentTab === "overview" && (
          <>
            {/* 플랜 그룹 정보 */}
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
              <h2 className="text-lg font-semibold text-gray-900">플랜 그룹 정보</h2>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="font-medium text-gray-700">학습 기간:</span>
                  <span className="text-gray-900">
                    {new Date(group.period_start).toLocaleDateString("ko-KR")} ~{" "}
                    {new Date(group.period_end).toLocaleDateString("ko-KR")}
                  </span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">스케줄러 유형:</span>
                  <span className="text-gray-900">
                    {group.scheduler_type
                      ? schedulerTypeLabels[group.scheduler_type] || group.scheduler_type
                      : "—"}
                  </span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">플랜 목적:</span>
                  <span className="text-gray-900">
                    {group.plan_purpose
                      ? planPurposeLabels[group.plan_purpose] || group.plan_purpose
                      : "—"}
                  </span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">콘텐츠 개수:</span>
                  <span className="text-gray-900">{studentContents.length}개</span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">제외일 개수:</span>
                  <span className="text-gray-900">{exclusions.length}개</span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">학원 일정 개수:</span>
                  <span className="text-gray-900">{academySchedules.length}개</span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">상태:</span>
                  <span className="text-gray-900">{group.status}</span>
                </div>
                <div>
                  <span className="font-medium text-gray-700">제출일:</span>
                  <span className="text-gray-900">
                    {group.created_at
                      ? new Date(group.created_at).toLocaleDateString("ko-KR")
                      : "—"}
                  </span>
                </div>
              </div>
            </div>

            {/* 블록 세트 정보 */}
            {templateBlockSetName && (
              <div className="flex flex-col gap-3 border-t border-gray-100 pt-4">
                <label className="text-xs font-medium text-gray-500">블록 세트</label>
                <div>
                  <p className="text-sm font-semibold text-gray-900">{templateBlockSetName}</p>
                </div>
                {templateBlocks.length > 0 ? (
                  <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                    {templateBlocks.map((block) => (
                      <div
                        key={block.id}
                        className="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
                      >
                        <div className="text-sm font-medium text-gray-900">
                          {["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"][block.day_of_week]}
                        </div>
                        <div className="text-xs text-gray-600">
                          {block.start_time} ~ {block.end_time}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-sm text-gray-500">등록된 시간 블록이 없습니다.</p>
                )}
              </div>
            )}
          </>
        )}

        {currentTab === "step1" && (
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <Step1BasicInfo
              data={wizardData}
              onUpdate={() => {}} // readonly 모드에서는 업데이트 불필요
              blockSets={[]} // 검토 모드에서는 블록세트 선택 불필요
              editable={false}
              isCampMode={true}
              isTemplateMode={false}
            />
          </div>
        )}

        {currentTab === "step2" && (
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <Step2TimeSettings
              data={wizardData}
              onUpdate={() => {}} // readonly 모드에서는 업데이트 불필요
              periodStart={group.period_start}
              periodEnd={group.period_end}
              campMode={true}
              isTemplateMode={false}
            />
          </div>
        )}

        {currentTab === "step3" && (
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <div className="flex flex-col gap-6">
              <div className="flex flex-col gap-1">
                <h2 className="text-xl font-semibold text-gray-900">스케줄 확인</h2>
                <p className="text-sm text-gray-500">
                  학생이 확인한 스케줄 미리보기 정보입니다.
                </p>
              </div>
              <div className="rounded-lg border border-gray-200 bg-gray-50 p-4">
                <p className="text-sm text-gray-600">
                  스케줄 미리보기는 학생이 입력한 블록 및 제외일, 학원 일정을 기반으로 생성됩니다.
                </p>
              </div>
            </div>
          </div>
        )}

        {currentTab === "step4" && (
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <Step3ContentSelection
              data={wizardData}
              onUpdate={() => {}} // readonly 모드에서는 업데이트 불필요
              contents={{ books: [], lectures: [], custom: [] }} // 검토 모드에서는 선택 가능한 콘텐츠 목록 불필요
              editable={false}
              isCampMode={true}
              studentId={group.student_id}
            />
          </div>
        )}

      </div>
    </section>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/[groupId]/review/page.tsx">
import { redirect, notFound } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getCampPlanGroupForReview } from "@/app/(admin)/actions/campTemplateActions";
import { CampPlanGroupReviewForm } from "./CampPlanGroupReviewForm";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getStudentById } from "@/lib/data/students";

export default async function CampPlanGroupReviewPage({
  params,
}: {
  params: Promise<{ id: string; groupId: string }>;
}) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { id: templateId, groupId } = await params;
  const result = await getCampPlanGroupForReview(groupId);

  if (!result.success || !result.group) {
    notFound();
  }

  // 학생 정보 조회
  const studentInfo = await getStudentById(result.group.student_id);

  return (
    <CampPlanGroupReviewForm
      templateId={templateId}
      groupId={groupId}
      group={result.group}
      contents={result.contents}
      exclusions={result.exclusions}
      academySchedules={result.academySchedules}
      templateBlocks={result.templateBlocks || []}
      templateBlockSetName={result.templateBlockSetName || null}
      templateBlockSetId={result.templateBlockSetId || null}
      studentInfo={studentInfo ? {
        name: studentInfo.name || "이름 없음",
        grade: studentInfo.grade || null,
        class: studentInfo.class || null,
      } : null}
    />
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/CampParticipantsList.tsx">
"use client";

import { useState, useEffect, useTransition, useCallback, useRef, useMemo } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { createSupabaseBrowserClient } from "@/lib/supabase/client";
import { useToast } from "@/components/ui/ToastProvider";
import { BatchOperationDialog } from "./_components/BatchOperationDialog";
import { BulkRecommendContentsModal } from "./_components/BulkRecommendContentsModal";
import { BatchPlanWizard } from "./_components/BatchPlanWizard";
import { batchUpdateCampPlanGroupStatus, bulkCreatePlanGroupsForCamp } from "@/app/(admin)/actions/campTemplateActions";

type Participant = {
  invitation_id: string;
  student_id: string;
  student_name: string;
  student_grade: string | null;
  student_class: string | null;
  invitation_status: string; // 원본 상태 (pending, accepted, declined)
  display_status?: string; // 표시용 상태 (submitted 추가)
  plan_group_id: string | null;
  plan_group_name: string | null;
  plan_group_status: string | null;
  hasPlans: boolean;
  invited_at: string;
  accepted_at: string | null;
};

type CampParticipantsListProps = {
  templateId: string;
  templateName: string;
};

export function CampParticipantsList({
  templateId,
  templateName,
}: CampParticipantsListProps) {
  const toast = useToast();
  const pathname = usePathname();
  const [isPending, startTransition] = useTransition();
  const [participants, setParticipants] = useState<Participant[]>([]);
  const [loading, setLoading] = useState(true);
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [selectedParticipantIds, setSelectedParticipantIds] = useState<
    Set<string>
  >(new Set());
  const [batchDialogOpen, setBatchDialogOpen] = useState(false);
  const [batchOperationType, setBatchOperationType] = useState<
    "activate" | "status_change"
  >("activate");
  const [batchStatus, setBatchStatus] = useState<string>("active");
  const [bulkRecommendModalOpen, setBulkRecommendModalOpen] = useState(false);
  const [batchWizardOpen, setBatchWizardOpen] = useState(false);
  
  // 마지막 로드 시간 추적 (중복 로드 방지)
  const lastLoadTimeRef = useRef<number>(0);
  const isLoadingRef = useRef<boolean>(false);

  // loadParticipants 함수를 useCallback으로 메모이제이션
  const loadParticipants = useCallback(async () => {
    // 중복 로드 방지: 1초 이내 재요청 차단
    const now = Date.now();
    if (isLoadingRef.current || (now - lastLoadTimeRef.current < 1000)) {
      return;
    }
    
    isLoadingRef.current = true;
    lastLoadTimeRef.current = now;
    
    try {
      setLoading(true);
      const supabase = createSupabaseBrowserClient();

      // 초대와 학생 정보 조회
      const { data: invitationsData, error: invitationsError } = await supabase
        .from("camp_invitations")
        .select(
          `
          id,
          student_id,
          status,
          invited_at,
          accepted_at,
          students:student_id (
            name,
            grade,
            class
          )
        `
        )
        .eq("camp_template_id", templateId)
        .order("invited_at", { ascending: false });

      if (invitationsError) {
        console.error("[CampParticipantsList] 초대 조회 실패:", {
          templateId,
          error: invitationsError.message,
          errorCode: invitationsError.code,
          errorDetails: invitationsError.details,
        });
        throw invitationsError;
      }

      // 플랜 그룹 정보 별도 조회 (camp_invitation_id로)
      const invitationIds = (invitationsData || []).map((inv: any) => inv.id);
      let planGroupsData: any[] = [];

      if (invitationIds.length > 0) {
        // 방법 1: camp_invitation_id로 직접 조회
        const { data: method1Data, error: method1Error } = await supabase
          .from("plan_groups")
          .select("id, name, status, camp_invitation_id, student_id")
          .in("camp_invitation_id", invitationIds)
          .is("deleted_at", null);

        if (method1Error) {
          console.error(
            "[CampParticipantsList] 플랜 그룹 조회 실패 (방법 1):",
            {
              templateId,
              invitationIdsCount: invitationIds.length,
              error: method1Error.message,
              errorCode: method1Error.code,
              errorDetails: method1Error.details,
            }
          );
        } else if (method1Data) {
          planGroupsData = [
            ...planGroupsData,
            ...method1Data.filter((pg: any) => pg.camp_invitation_id !== null),
          ];
        }

        // 방법 2: camp_template_id와 student_id로 조회 (fallback)
        // accepted 또는 pending 상태인 초대에 대해 플랜 그룹 조회
        // (학생이 제출했지만 상태가 아직 pending인 경우도 포함)
        const invitationsWithPlanGroups = (invitationsData || []).filter(
          (inv: any) => inv.status === "accepted" || inv.status === "pending"
        );

        if (invitationsWithPlanGroups.length > 0) {
          const studentIds = invitationsWithPlanGroups.map(
            (inv: any) => inv.student_id
          );
          const { data: method2Data, error: method2Error } = await supabase
            .from("plan_groups")
            .select(
              "id, name, status, camp_invitation_id, camp_template_id, student_id"
            )
            .eq("camp_template_id", templateId)
            .eq("plan_type", "camp")
            .in("student_id", studentIds)
            .is("deleted_at", null);

          if (method2Error) {
            console.error(
              "[CampParticipantsList] 플랜 그룹 조회 실패 (방법 2):",
              {
                templateId,
                studentIdsCount: studentIds.length,
                error: method2Error.message,
                errorCode: method2Error.code,
                errorDetails: method2Error.details,
              }
            );
          } else if (method2Data) {
            // 이미 조회된 플랜 그룹 제외하고 추가
            const existingGroupIds = new Set(
              planGroupsData.map((pg: any) => pg.id)
            );
            const newGroups = method2Data.filter(
              (pg: any) => !existingGroupIds.has(pg.id)
            );

            // camp_invitation_id가 없는 경우 매핑 시도 및 업데이트
            const groupsToUpdate: Array<{
              groupId: string;
              invitationId: string;
            }> = [];

            newGroups.forEach((pg: any) => {
              if (!pg.camp_invitation_id) {
                // student_id로 매칭되는 초대 찾기 (accepted 우선, 없으면 pending)
                const matchingInvitation =
                  invitationsWithPlanGroups.find(
                    (inv: any) =>
                      inv.student_id === pg.student_id &&
                      inv.status === "accepted"
                  ) ||
                  invitationsWithPlanGroups.find(
                    (inv: any) =>
                      inv.student_id === pg.student_id &&
                      inv.status === "pending"
                  );

                if (matchingInvitation) {
                  pg.camp_invitation_id = matchingInvitation.id;
                  groupsToUpdate.push({
                    groupId: pg.id,
                    invitationId: matchingInvitation.id,
                  });
                } else if (process.env.NODE_ENV === "development") {
                  console.warn(
                    "[CampParticipantsList] 매칭되는 초대를 찾을 수 없음:",
                    {
                      planGroupId: pg.id,
                      studentId: pg.student_id,
                      templateId: pg.camp_template_id,
                    }
                  );
                }
              }
            });

            // 매핑된 플랜 그룹들의 camp_invitation_id 업데이트 (비동기)
            if (groupsToUpdate.length > 0) {
              (async () => {
                for (const { groupId, invitationId } of groupsToUpdate) {
                  try {
                    const { error: updateError } = await supabase
                      .from("plan_groups")
                      .update({
                        camp_invitation_id: invitationId,
                        updated_at: new Date().toISOString(),
                      })
                      .eq("id", groupId);

                    if (updateError) {
                      console.error(
                        "[CampParticipantsList] camp_invitation_id 업데이트 실패 (방법 2):",
                        {
                          groupId,
                          invitationId,
                          error: updateError.message || updateError.toString(),
                          errorCode: updateError.code,
                          errorDetails: updateError.details,
                          fullError: updateError,
                        }
                      );
                    }
                  } catch (error) {
                    console.error(
                      "[CampParticipantsList] camp_invitation_id 업데이트 중 예외 (방법 2):",
                      {
                        groupId,
                        invitationId,
                        error:
                          error instanceof Error
                            ? error.message
                            : String(error),
                      }
                    );
                  }
                }
              })();
            }

            planGroupsData = [...planGroupsData, ...newGroups];
          }
        }

        // 개발 환경에서 조회 결과 로깅
        if (process.env.NODE_ENV === "development") {
          console.log("[CampParticipantsList] 플랜 그룹 조회 결과:", {
            totalInvitations: invitationIds.length,
            planGroupsFound: planGroupsData.length,
            planGroupsWithInvitationId: planGroupsData.filter(
              (pg: any) => pg.camp_invitation_id
            ).length,
          });
        }
      }

      // 플랜 생성 여부 확인 (student_plan 테이블 조회)
      const planGroupIds = (planGroupsData || []).map((pg: any) => pg.id);
      let plansMap = new Map<string, boolean>();

      if (planGroupIds.length > 0) {
        const { data: plansData, error: plansError } = await supabase
          .from("student_plan")
          .select("plan_group_id")
          .in("plan_group_id", planGroupIds)
          .limit(1000);

        if (plansError) {
          console.error("[CampParticipantsList] 플랜 조회 실패:", plansError);
          // 에러 발생 시 빈 맵 사용 (플랜이 없다고 간주)
          if (process.env.NODE_ENV === "development") {
            console.warn(
              "[CampParticipantsList] 플랜 조회 실패로 인해 hasPlans가 모두 false로 설정됩니다.",
              {
                planGroupIdsCount: planGroupIds.length,
                error: plansError.message,
              }
            );
          }
        } else {
          // 플랜 그룹별 플랜 생성 여부 매핑
          (plansData || []).forEach((plan: any) => {
            if (plan.plan_group_id) {
              plansMap.set(plan.plan_group_id, true);
            }
          });

          // 개발 환경에서 조회 결과 로깅
          if (process.env.NODE_ENV === "development") {
            console.log("[CampParticipantsList] 플랜 조회 결과:", {
              planGroupIdsCount: planGroupIds.length,
              plansFound: plansData?.length || 0,
              uniquePlanGroups: plansMap.size,
            });
          }
        }
      }

      // 플랜 그룹을 invitation_id로 매핑
      const planGroupsMap = new Map<string, any>();
      const planGroupsByStudentId = new Map<string, any[]>();

      // 먼저 camp_invitation_id가 있는 경우 매핑
      (planGroupsData || []).forEach((pg: any) => {
        if (pg.camp_invitation_id) {
          planGroupsMap.set(pg.camp_invitation_id, {
            ...pg,
            hasPlans: plansMap.has(pg.id),
          });
        }

        // student_id로도 매핑 (fallback용)
        if (pg.student_id) {
          if (!planGroupsByStudentId.has(pg.student_id)) {
            planGroupsByStudentId.set(pg.student_id, []);
          }
          planGroupsByStudentId.get(pg.student_id)!.push({
            ...pg,
            hasPlans: plansMap.has(pg.id),
          });
        }
      });

      // 데이터 병합
      const data = (invitationsData || []).map((invitation: any) => {
        let planGroup = planGroupsMap.get(invitation.id);

        // camp_invitation_id로 매핑되지 않은 경우, student_id로 fallback 시도
        if (!planGroup && invitation.student_id) {
          const studentPlanGroups = planGroupsByStudentId.get(
            invitation.student_id
          );
          if (studentPlanGroups && studentPlanGroups.length > 0) {
            // 가장 최근 플랜 그룹 선택 (camp_template_id가 일치하는 것 우선)
            const matchingGroup =
              studentPlanGroups.find(
                (pg: any) => pg.camp_template_id === templateId
              ) || studentPlanGroups[0];

            planGroup = matchingGroup;

            // camp_invitation_id가 없는 경우 업데이트 시도 (비동기)
            // UI 블로킹을 방지하기 위해 비동기로 처리하되, 에러 처리를 강화
            if (planGroup && !planGroup.camp_invitation_id) {
              (async () => {
                try {
                  const { error: updateError } = await supabase
                    .from("plan_groups")
                    .update({
                      camp_invitation_id: invitation.id,
                      updated_at: new Date().toISOString(),
                    })
                    .eq("id", planGroup.id);

                  if (updateError) {
                    console.error(
                      "[CampParticipantsList] camp_invitation_id 업데이트 실패:",
                      {
                        planGroupId: planGroup.id,
                        invitationId: invitation.id,
                        studentId: invitation.student_id,
                        error: updateError.message || updateError.toString(),
                        errorCode: updateError.code,
                        errorDetails: updateError.details,
                        fullError: updateError,
                      }
                    );
                  } else if (process.env.NODE_ENV === "development") {
                    console.log(
                      "[CampParticipantsList] camp_invitation_id 업데이트 성공:",
                      {
                        planGroupId: planGroup.id,
                        invitationId: invitation.id,
                        studentId: invitation.student_id,
                      }
                    );
                  }
                } catch (error) {
                  console.error(
                    "[CampParticipantsList] camp_invitation_id 업데이트 중 예외:",
                    {
                      planGroupId: planGroup.id,
                      invitationId: invitation.id,
                      error:
                        error instanceof Error ? error.message : String(error),
                    }
                  );
                }
              })();
            }
          }
        }

        // 디버깅: 초대 상태가 accepted 또는 pending인데 플랜 그룹이 없는 경우
        if (
          (invitation.status === "accepted" ||
            invitation.status === "pending") &&
          !planGroup
        ) {
          if (process.env.NODE_ENV === "development") {
            console.warn(
              "[CampParticipantsList] 초대 상태는 " +
                invitation.status +
                "인데 플랜 그룹이 조회되지 않음:",
              {
                invitationId: invitation.id,
                studentId: invitation.student_id,
                invitationStatus: invitation.status,
                planGroupsFound: planGroupsData?.length || 0,
                planGroupsForStudent:
                  planGroupsByStudentId.get(invitation.student_id)?.length || 0,
              }
            );
          }
        }

        // pending 상태이지만 플랜 그룹이 있는 경우: 제출 완료 상태로 간주
        // (학생이 제출했지만 아직 accepted로 변경되지 않은 경우)
        if (invitation.status === "pending" && planGroup) {
          // 제출 완료 상태로 표시하기 위해 planGroup에 플래그 추가
          planGroup.isSubmitted = true;
        }

        return {
          ...invitation,
          plan_group: planGroup || null,
        };
      });

      // 데이터 변환
      const participantsData: Participant[] = data.map((invitation: any) => {
        // pending 상태이지만 플랜 그룹이 있는 경우: 제출 완료 상태로 표시
        const isSubmitted =
          invitation.status === "pending" && invitation.plan_group !== null;
        const displayStatus = isSubmitted ? "submitted" : invitation.status;

        return {
          invitation_id: invitation.id,
          student_id: invitation.student_id,
          student_name: invitation.students?.name || "이름 없음",
          student_grade: invitation.students?.grade || null,
          student_class: invitation.students?.class || null,
          invitation_status: invitation.status, // 원본 상태 유지
          display_status: displayStatus, // 표시용 상태
          plan_group_id: invitation.plan_group?.id || null,
          plan_group_name: invitation.plan_group?.name || null,
          plan_group_status: invitation.plan_group?.status || null,
          hasPlans: invitation.plan_group?.hasPlans || false,
          invited_at: invitation.invited_at,
          accepted_at: invitation.accepted_at,
        };
      });

      setParticipants(participantsData);
    } catch (error) {
      console.error("[CampParticipantsList] 참여자 목록 로드 실패:", {
        templateId,
        error: error instanceof Error ? error.message : String(error),
        errorStack: error instanceof Error ? error.stack : undefined,
      });
      toast.showError(
        error instanceof Error
          ? `참여자 목록을 불러오는데 실패했습니다: ${error.message}`
          : "참여자 목록을 불러오는데 실패했습니다."
      );
      // 에러 발생 시에도 기존 데이터는 유지
    } finally {
      setLoading(false);
      isLoadingRef.current = false;
    }
  }, [templateId, toast]);

  // 초기 로드 및 templateId 변경 시
  useEffect(() => {
    loadParticipants();
  }, [loadParticipants]);

  // 페이지 포커스 시 자동 새로고침 (다른 페이지에서 돌아왔을 때)
  useEffect(() => {
    const handleFocus = () => {
      // 현재 페이지가 참여자 목록 페이지인지 확인
      if (pathname?.includes('/participants') && !pathname?.includes('/participants/')) {
        // 마지막 로드 후 5초 이상 지났을 때만 새로고침
        const now = Date.now();
        if (now - lastLoadTimeRef.current > 5000) {
          loadParticipants();
        }
      }
    };

    window.addEventListener('focus', handleFocus);
    return () => {
      window.removeEventListener('focus', handleFocus);
    };
  }, [pathname, loadParticipants]);

  // 페이지 가시성 변경 시 (탭 전환 등)
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible') {
        // 마지막 로드 후 10초 이상 지났을 때만 새로고침
        const now = Date.now();
        if (now - lastLoadTimeRef.current > 10000) {
          loadParticipants();
        }
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [loadParticipants]);

  // 필터링된 참여자 목록 (메모이제이션)
  const filteredParticipants = useMemo(() => {
    return participants.filter((p) => {
      if (statusFilter === "all") return true;
      if (statusFilter === "accepted") return p.invitation_status === "accepted";
      if (statusFilter === "pending") return p.invitation_status === "pending";
      if (statusFilter === "declined") return p.invitation_status === "declined";
      return true;
    });
  }, [participants, statusFilter]);

  // 선택 가능한 참여자만 필터링 (플랜이 생성된 참여자만 활성화 가능) - 메모이제이션
  const selectableParticipants = useMemo(() => {
    return filteredParticipants.filter(
      (p) => p.plan_group_id !== null && p.hasPlans
    );
  }, [filteredParticipants]);

  // 플랜 그룹이 없는 참여자 (플랜 생성 대상) - 메모이제이션
  const participantsWithoutGroup = useMemo(() => {
    return filteredParticipants.filter(
      (p) => p.plan_group_id === null
    );
  }, [filteredParticipants]);

  // 전체 선택/해제 핸들러 (메모이제이션)
  const handleSelectAll = useCallback((checked: boolean) => {
    if (checked) {
      const selectableIds = new Set<string>();
      // 플랜 그룹이 있는 경우 plan_group_id, 없는 경우 invitation_id 사용
      filteredParticipants.forEach((p) => {
        const key = p.plan_group_id || p.invitation_id;
        selectableIds.add(key);
      });
      setSelectedParticipantIds(selectableIds);
    } else {
      setSelectedParticipantIds(new Set());
    }
  }, [filteredParticipants]);

  // 개별 선택/해제 핸들러 (메모이제이션)
  const handleToggleSelect = useCallback((participant: Participant) => {
    // 플랜 그룹이 있으면 plan_group_id, 없으면 invitation_id를 키로 사용
    const key = participant.plan_group_id || participant.invitation_id;

    setSelectedParticipantIds((prev) => {
      const next = new Set(prev);
      if (next.has(key)) {
        next.delete(key);
      } else {
        next.add(key);
      }
      return next;
    });
  }, []);

  // 필터 변경 시 선택 해제 (필터가 실제로 변경되었을 때만)
  const prevStatusFilterRef = useRef<string>(statusFilter);
  useEffect(() => {
    if (prevStatusFilterRef.current !== statusFilter) {
      setSelectedParticipantIds(new Set());
      prevStatusFilterRef.current = statusFilter;
    }
  }, [statusFilter]);

  // 일괄 작업 핸들러 (메모이제이션)
  const handleBatchActivate = useCallback(() => {
    // 플랜 그룹이 있는 학생들만 필터링
    const selectedWithGroup = participants.filter((p) => {
      const key = p.plan_group_id || p.invitation_id;
      return selectedParticipantIds.has(key) && p.plan_group_id !== null;
    });

    if (selectedWithGroup.length === 0) {
      toast.showError("플랜 그룹이 있는 참여자를 선택해주세요.");
      return;
    }

    setBatchOperationType("activate");
    setBatchStatus("active");
    setBatchDialogOpen(true);
  }, [participants, selectedParticipantIds, toast]);

  const handleBatchStatusChange = useCallback((status: string) => {
    // 플랜 그룹이 있는 학생들만 필터링
    const selectedWithGroup = participants.filter((p) => {
      const key = p.plan_group_id || p.invitation_id;
      return selectedParticipantIds.has(key) && p.plan_group_id !== null;
    });

    if (selectedWithGroup.length === 0) {
      toast.showError("플랜 그룹이 있는 참여자를 선택해주세요.");
      return;
    }

    setBatchOperationType("status_change");
    setBatchStatus(status);
    setBatchDialogOpen(true);
  }, [participants, selectedParticipantIds, toast]);

  // 플랜 그룹 일괄 생성 핸들러
  const handleBulkCreatePlanGroups = useCallback(async () => {
    // 플랜 그룹이 없는 학생들만 필터링
    const selectedWithoutGroup = participants.filter((p) => {
      const key = p.plan_group_id || p.invitation_id;
      return selectedParticipantIds.has(key) && p.plan_group_id === null;
    });

    if (selectedWithoutGroup.length === 0) {
      toast.showError("플랜 그룹이 없는 참여자를 선택해주세요.");
      return;
    }

    const invitationIds = selectedWithoutGroup.map((p) => p.invitation_id);

    startTransition(async () => {
      try {
        const result = await bulkCreatePlanGroupsForCamp(templateId, invitationIds);

        if (result.success) {
          toast.showSuccess(
            `${result.successCount}명의 학생에게 플랜 그룹이 생성되었습니다.`
          );
          // 상태 초기화 후 데이터 새로고침
          setSelectedParticipantIds(new Set());
          // 약간의 지연을 두어 DB 동기화 시간 확보
          setTimeout(() => {
            loadParticipants();
          }, 500);
        } else {
          const errorMsg =
            result.errors && result.errors.length > 0
              ? `${result.failureCount}개 실패: ${result.errors[0].error}`
              : "플랜 그룹 일괄 생성에 실패했습니다.";
          toast.showError(errorMsg);

          if (result.successCount > 0) {
            // 부분 성공 시에도 데이터 새로고침
            setTimeout(() => {
              loadParticipants();
            }, 500);
          }
        }
      } catch (error) {
        console.error("플랜 그룹 일괄 생성 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "플랜 그룹 일괄 생성에 실패했습니다."
        );
      }
    });
  }, [participants, selectedParticipantIds, templateId, toast, loadParticipants]);

  const handleBatchConfirm = useCallback(async () => {
    if (selectedParticipantIds.size === 0) {
      toast.showError("선택된 참여자가 없습니다.");
      setBatchDialogOpen(false);
      return;
    }

    const groupIds = Array.from(selectedParticipantIds).filter((id) => {
      // plan_group_id인지 확인 (invitation_id가 아닌 경우만)
      return participants.some((p) => p.plan_group_id === id);
    });

    startTransition(async () => {
      try {
        const result = await batchUpdateCampPlanGroupStatus(
          groupIds,
          batchStatus
        );

        if (result.success) {
          toast.showSuccess(
            `${result.successCount}개 플랜 그룹의 상태가 변경되었습니다.`
          );
          setSelectedParticipantIds(new Set());
          setBatchDialogOpen(false);
          // 약간의 지연을 두어 DB 동기화 시간 확보
          setTimeout(() => {
            loadParticipants();
          }, 500);
        } else {
          const errorMsg =
            result.errors && result.errors.length > 0
              ? `${result.failureCount}개 실패: ${result.errors[0].error}`
              : "일괄 작업에 실패했습니다.";
          toast.showError(errorMsg);

          if (result.successCount > 0) {
            // 부분 성공 시 선택된 항목 갱신
            const successIds = new Set(
              groupIds.filter(
                (id) => !result.errors?.some((e) => e.groupId === id)
              )
            );
            setSelectedParticipantIds(successIds);
            // 부분 성공 시에도 데이터 새로고침
            setTimeout(() => {
              loadParticipants();
            }, 500);
          }
        }
      } catch (error) {
        console.error("일괄 작업 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "일괄 작업에 실패했습니다."
        );
      }
    });
  }, [selectedParticipantIds, participants, batchStatus, toast, loadParticipants]);

  // 통계 (메모이제이션)
  const stats = useMemo(() => {
    return {
      total: participants.length,
      accepted: participants.filter((p) => p.display_status === "accepted")
        .length,
      pending: participants.filter(
        (p) => p.display_status === "pending" || p.display_status === "submitted"
      ).length,
      declined: participants.filter((p) => p.display_status === "declined")
        .length,
      withPlan: participants.filter((p) => p.plan_group_id !== null).length,
      needsAction: participants.filter(
        (p) => p.plan_group_id !== null && !p.hasPlans
      ).length,
    };
  }, [participants]);

  // 작업이 필요한 참여자 목록 (메모이제이션)
  const needsActionParticipants = useMemo(() => {
    return participants.filter(
      (p) => p.plan_group_id !== null && !p.hasPlans
    );
  }, [participants]);

  if (loading) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="text-sm text-gray-500">
          참여자 목록을 불러오는 중...
        </div>
      </section>
    );
  }


  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p className="text-sm font-medium text-gray-500">캠프 관리</p>
            <h1 className="text-3xl font-semibold text-gray-900">
              참여자 목록
            </h1>
            <p className="text-sm text-gray-500">{templateName}</p>
          </div>
          <Link
            href={`/admin/camp-templates/${templateId}`}
            className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
          >
            템플릿으로 돌아가기
          </Link>
        </div>

        {/* 작업 필요 알림 */}
        {needsActionParticipants.length > 0 && (
          <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
            <div className="flex items-start gap-3">
              <div className="flex-shrink-0">
                <svg
                  className="h-5 w-5 text-blue-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div className="flex-1">
                <h3 className="text-sm font-semibold text-blue-900">
                  작업이 필요한 참여자가 있습니다
                </h3>
                <p className="text-sm text-blue-700">
                  {needsActionParticipants.length}명의 참여자가 제출을
                  완료했지만 플랜이 생성되지 않았습니다. "남은 단계 진행" 버튼을
                  클릭하여 플랜 생성을 완료해주세요.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 통계 */}
        <div className="grid grid-cols-2 gap-4 md:grid-cols-6">
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">전체</div>
            <div className="text-2xl font-semibold text-gray-900">
              {stats.total}
            </div>
          </div>
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">수락</div>
            <div className="text-2xl font-semibold text-green-600">
              {stats.accepted}
            </div>
          </div>
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">대기중</div>
            <div className="text-2xl font-semibold text-yellow-600">
              {stats.pending}
            </div>
          </div>
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">거절</div>
            <div className="text-2xl font-semibold text-red-600">
              {stats.declined}
            </div>
          </div>
          <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white p-4">
            <div className="text-sm text-gray-600">플랜 생성 완료</div>
            <div className="text-2xl font-semibold text-blue-600">
              {participants.filter((p) => p.hasPlans).length}
            </div>
          </div>
          <div
            className={`flex flex-col gap-1 rounded-lg border p-4 ${
              needsActionParticipants.length > 0
                ? "border-orange-200 bg-orange-50"
                : "border-gray-200 bg-white"
            }`}
          >
            <div className="text-sm text-gray-600">작업 필요</div>
            <div
              className={`text-2xl font-semibold ${
                needsActionParticipants.length > 0
                  ? "text-orange-600"
                  : "text-gray-900"
              }`}
            >
              {stats.needsAction}
            </div>
          </div>
        </div>

        {/* 필터 및 일괄 작업 버튼 */}
        <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex items-center gap-3">
            <label className="text-sm font-medium text-gray-700">
              상태 필터:
            </label>
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="all">전체</option>
              <option value="accepted">수락</option>
              <option value="pending">대기중</option>
              <option value="declined">거절</option>
            </select>
          </div>

          {selectedParticipantIds.size > 0 && (
            <div className="flex items-center gap-3">
              <div className="text-sm text-gray-600">
                <span className="font-medium">
                  {selectedParticipantIds.size}
                </span>
                개 선택됨
              </div>
              <div className="flex items-center gap-2">
                {/* 플랜 그룹이 없는 학생들: 플랜 그룹 일괄 생성 */}
                {(() => {
                  const selectedWithoutGroup = participants.filter((p) => {
                    const key = p.plan_group_id || p.invitation_id;
                    return selectedParticipantIds.has(key) && p.plan_group_id === null;
                  });
                  return selectedWithoutGroup.length > 0 ? (
                    <button
                      type="button"
                      onClick={handleBulkCreatePlanGroups}
                      disabled={isPending}
                      className="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50"
                      title="선택한 참여자에게 플랜 그룹을 일괄 생성합니다"
                    >
                      플랜 그룹 일괄 생성 ({selectedWithoutGroup.length})
                    </button>
                  ) : null;
                })()}
                {/* 플랜 그룹이 있는 학생들: 일괄 설정 및 플랜 생성 위저드 */}
                {(() => {
                  const selectedWithGroup = participants.filter((p) => {
                    const key = p.plan_group_id || p.invitation_id;
                    return selectedParticipantIds.has(key) && p.plan_group_id !== null;
                  });
                  return selectedWithGroup.length > 0 ? (
                    <button
                      type="button"
                      onClick={() => setBatchWizardOpen(true)}
                      disabled={isPending}
                      className="inline-flex items-center justify-center rounded-lg bg-purple-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-purple-700 disabled:cursor-not-allowed disabled:opacity-50"
                      title="선택한 참여자에게 콘텐츠 추천, 범위 조절, 플랜 생성을 단계별로 진행합니다"
                    >
                      일괄 설정 및 플랜 생성 ({selectedWithGroup.length})
                    </button>
                  ) : null;
                })()}
                {/* 플랜 그룹이 있는 학생들만 추천 콘텐츠 일괄 적용 가능 (기존 기능 유지) */}
                {(() => {
                  const selectedWithGroup = participants.filter((p) => {
                    const key = p.plan_group_id || p.invitation_id;
                    return selectedParticipantIds.has(key) && p.plan_group_id !== null;
                  });
                  return selectedWithGroup.length > 0 ? (
                    <button
                      type="button"
                      onClick={() => setBulkRecommendModalOpen(true)}
                      disabled={isPending}
                      className="inline-flex items-center justify-center rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-green-700 disabled:cursor-not-allowed disabled:opacity-50"
                      title="선택한 참여자에게 추천 콘텐츠만 일괄 적용합니다"
                    >
                      추천 콘텐츠만 적용 ({selectedWithGroup.length})
                    </button>
                  ) : null;
                })()}
                {(() => {
                  const selectedWithGroup = participants.filter((p) => {
                    const key = p.plan_group_id || p.invitation_id;
                    return selectedParticipantIds.has(key) && p.plan_group_id !== null;
                  });
                  return selectedWithGroup.length > 0 ? (
                <button
                  type="button"
                  onClick={handleBatchActivate}
                  disabled={isPending}
                  className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
                  title="선택한 참여자의 플랜 그룹을 활성화합니다"
                >
                      일괄 활성화 ({selectedWithGroup.length})
                </button>
                  ) : null;
                })()}
                <select
                  value=""
                  onChange={(e) => {
                    if (e.target.value) {
                      handleBatchStatusChange(e.target.value);
                      e.target.value = "";
                    }
                  }}
                  disabled={isPending}
                  className="rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  <option value="">상태 변경</option>
                  <option value="active">활성</option>
                  <option value="saved">저장됨</option>
                  <option value="paused">일시정지</option>
                  <option value="completed">완료</option>
                </select>
              </div>
            </div>
          )}
        </div>

        {/* 참여자 목록 */}
        <div className="overflow-x-auto">
          <table className="w-full border-collapse rounded-lg border border-gray-200 bg-white">
            <thead className="bg-gray-50">
              <tr>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  <input
                    type="checkbox"
                    checked={
                        filteredParticipants.length > 0 &&
                        filteredParticipants.every((p) => {
                          const key = p.plan_group_id || p.invitation_id;
                          return selectedParticipantIds.has(key);
                        })
                    }
                    onChange={(e) => handleSelectAll(e.target.checked)}
                    className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                  />
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  학생명
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  학년/반
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  초대 상태
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  플랜 그룹
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  플랜 상태
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  참여일
                </th>
                <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  작업
                </th>
              </tr>
            </thead>
            <tbody>
              {filteredParticipants.length === 0 ? (
                <tr>
                  <td
                    colSpan={8}
                    className="px-4 py-8 text-center text-sm text-gray-500"
                  >
                    참여자가 없습니다.
                  </td>
                </tr>
              ) : (
                filteredParticipants.map((participant) => {
                  // 플랜 그룹이 있으면 plan_group_id, 없으면 invitation_id를 키로 사용
                  const key = participant.plan_group_id || participant.invitation_id;
                  
                  const isSelectable = true; // 모든 참여자 선택 가능
                  const isSelected = selectedParticipantIds.has(key);

                  // 작업 필요 여부 확인
                  const needsAction =
                    participant.plan_group_id !== null && !participant.hasPlans;

                  return (
                    <tr
                      key={participant.invitation_id}
                      className={`hover:bg-gray-50 ${
                        needsAction ? "bg-orange-50/30" : ""
                      }`}
                    >
                      <td className="border-b border-gray-100 px-4 py-3">
                        <div className="relative">
                          <input
                            type="checkbox"
                            checked={isSelected}
                            onChange={() => handleToggleSelect(participant)}
                            className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                            title="선택"
                            aria-label={`${participant.student_name} 선택`}
                          />
                          {!isSelectable && (
                            <span className="sr-only">
                              {needsAction
                                ? "플랜이 생성되지 않아 선택할 수 없습니다. 남은 단계 진행 버튼을 사용하여 플랜을 생성해주세요."
                                : "선택할 수 없습니다."}
                            </span>
                          )}
                        </div>
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm font-medium text-gray-900">
                        {participant.student_name}
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                        {participant.student_grade && participant.student_class
                          ? `${participant.student_grade}학년 ${participant.student_class}반`
                          : "—"}
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm">
                        {participant.display_status === "submitted" && (
                          <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                            제출 완료
                          </span>
                        )}
                        {participant.display_status === "pending" && (
                          <span className="inline-flex items-center rounded-full bg-yellow-100 px-3 py-1 text-xs font-medium text-yellow-800">
                            대기중
                          </span>
                        )}
                        {participant.display_status === "accepted" && (
                          <span className="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800">
                            수락
                          </span>
                        )}
                        {participant.display_status === "declined" && (
                          <span className="inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-xs font-medium text-red-800">
                            거절
                          </span>
                        )}
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                        {participant.plan_group_name || "—"}
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm">
                        {needsAction ? (
                          <span className="inline-flex items-center rounded-full bg-orange-100 px-3 py-1 text-xs font-semibold text-orange-800">
                            작업 필요
                          </span>
                        ) : participant.plan_group_status ? (
                          <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                            {participant.plan_group_status}
                          </span>
                        ) : (
                          "—"
                        )}
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                        {participant.accepted_at
                          ? new Date(
                              participant.accepted_at
                            ).toLocaleDateString("ko-KR")
                          : "—"}
                      </td>
                      <td className="border-b border-gray-100 px-4 py-3 text-sm">
                        <div className="flex items-center gap-2">
                          {participant.plan_group_id ? (
                            <>
                              {/* 플랜이 생성되지 않은 경우 남은 단계 진행 버튼 표시 */}
                              {!participant.hasPlans ? (
                                <>
                                  <Link
                                    href={`/admin/camp-templates/${templateId}/participants/${participant.plan_group_id}/continue`}
                                    className="inline-flex items-center justify-center rounded-lg bg-orange-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-orange-700 shadow-sm"
                                    title="플랜 생성을 완료하려면 클릭하세요"
                                  >
                                    🔧 남은 단계 진행
                                  </Link>
                                  <Link
                                    href={`/admin/camp-templates/${templateId}/participants/${participant.plan_group_id}/review`}
                                    className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 transition hover:bg-gray-50"
                                    title="학생이 제출한 내용을 확인합니다"
                                  >
                                    제출 내용 확인
                                  </Link>
                                  {process.env.NODE_ENV === "development" && (
                                    <span
                                      className="text-xs text-gray-400"
                                      title={`hasPlans: ${participant.hasPlans}, plan_group_id: ${participant.plan_group_id}`}
                                    >
                                      (디버그)
                                    </span>
                                  )}
                                </>
                              ) : (
                                <>
                                  <Link
                                    href={`/admin/camp-templates/${templateId}/participants/${participant.plan_group_id}/review`}
                                    className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-medium text-white transition hover:bg-indigo-700"
                                  >
                                    상세 보기
                                  </Link>
                                  <Link
                                    href={`/admin/plan-groups/${participant.plan_group_id}`}
                                    className="text-indigo-600 hover:text-indigo-800 text-xs"
                                  >
                                    플랜 보기
                                  </Link>
                                </>
                              )}
                            </>
                          ) : (participant.display_status === "accepted" ||
                              participant.display_status === "submitted") &&
                            !participant.plan_group_id ? (
                            <div className="flex flex-col gap-1">
                              <span className="text-xs text-orange-600 font-medium">
                                ⚠️ 제출 완료 (플랜 그룹 없음)
                              </span>
                              <span className="text-xs text-gray-500">
                                플랜 그룹이 생성되지 않았을 수 있습니다
                              </span>
                              {process.env.NODE_ENV === "development" && (
                                <span className="text-xs text-gray-400">
                                  디버그: invitation_id=
                                  {participant.invitation_id}, student_id=
                                  {participant.student_id}, status=
                                  {participant.invitation_status}
                                </span>
                              )}
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    lastLoadTimeRef.current = 0; // 강제 새로고침
                                    loadParticipants();
                                  }}
                                  disabled={loading}
                                  className="text-xs text-blue-600 hover:text-blue-800 underline disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                  {loading ? "새로고침 중..." : "새로고침"}
                                </button>
                                <Link
                                  href={`/admin/camp-templates/${templateId}/participants?studentId=${participant.student_id}`}
                                  className="text-xs text-indigo-600 hover:text-indigo-800 underline"
                                >
                                  상세 확인
                                </Link>
                              </div>
                            </div>
                          ) : (
                            <span className="text-xs text-gray-400">
                              참여 대기중
                            </span>
                          )}
                        </div>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>

        {/* 일괄 설정 및 플랜 생성 위저드 */}
        <BatchPlanWizard
          open={batchWizardOpen}
          onOpenChange={setBatchWizardOpen}
          templateId={templateId}
          participants={participants
            .filter((p) => {
              const key = p.plan_group_id || p.invitation_id;
              return selectedParticipantIds.has(key) && p.plan_group_id !== null;
            })
            .map((p) => ({
              groupId: p.plan_group_id!,
              studentId: p.student_id,
              studentName: p.student_name,
            }))}
          onSuccess={() => {
            setSelectedParticipantIds(new Set());
            // 약간의 지연을 두어 DB 동기화 시간 확보
            setTimeout(() => {
              loadParticipants();
            }, 500);
          }}
        />

        {/* 추천 콘텐츠 일괄 적용 모달 (기존 기능 유지) */}
        <BulkRecommendContentsModal
          open={bulkRecommendModalOpen}
          onOpenChange={setBulkRecommendModalOpen}
          templateId={templateId}
          participants={participants
            .filter((p) => {
              const key = p.plan_group_id || p.invitation_id;
              return selectedParticipantIds.has(key) && p.plan_group_id !== null;
            })
            .map((p) => ({
              groupId: p.plan_group_id!,
              studentId: p.student_id,
              studentName: p.student_name,
            }))}
          onSuccess={() => {
            // 약간의 지연을 두어 DB 동기화 시간 확보
            setTimeout(() => {
              loadParticipants();
            }, 500);
          }}
        />

        {/* 일괄 작업 다이얼로그 */}
        <BatchOperationDialog
          open={batchDialogOpen}
          onOpenChange={setBatchDialogOpen}
          operationType={batchOperationType}
          participantCount={selectedParticipantIds.size}
          status={batchStatus}
          onConfirm={handleBatchConfirm}
          isPending={isPending}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/camp-templates/[id]/participants/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getCampTemplateById } from "@/app/(admin)/actions/campTemplateActions";
import { CampParticipantsList } from "./CampParticipantsList";

export default async function CampParticipantsPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { id } = await params;
  const result = await getCampTemplateById(id);

  if (!result.success || !result.template) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">
            템플릿을 찾을 수 없습니다.
          </p>
        </div>
      </section>
    );
  }

  return <CampParticipantsList templateId={result.template.id} templateName={result.template.name} />;
}
</file>

<file path="admin/camp-templates/[id]/time-management/_components/TemplateBlockForm.tsx">
"use client";

import { useState, useActionState, useEffect } from "react";
import { addTenantBlock } from "@/app/(admin)/actions/tenantBlockSets";
import { useToast } from "@/components/ui/ToastProvider";

type TemplateBlockFormState = {
  error: string | null;
  success: boolean;
};

const initialState: TemplateBlockFormState = {
  error: null,
  success: false,
};

type TemplateBlockFormProps = {
  onClose?: () => void;
  blockSetId?: string | null;
  onBlockChange?: (setId: string) => void | Promise<void>;
};

export default function TemplateBlockForm({ 
  onClose, 
  blockSetId, 
  onBlockChange 
}: TemplateBlockFormProps) {
  const toast = useToast();
  const [selectedWeekdays, setSelectedWeekdays] = useState<number[]>([]);
  const [startTime, setStartTime] = useState<string>("");
  const [endTime, setEndTime] = useState<string>("");

  const [state, formAction, isPending] = useActionState(
    async (
      _prev: TemplateBlockFormState,
      formData: FormData
    ): Promise<TemplateBlockFormState> => {
      try {
        if (!blockSetId) {
          return { error: "블록 세트 ID가 필요합니다.", success: false };
        }

        if (selectedWeekdays.length === 0) {
          return { error: "최소 1개 이상의 요일을 선택해주세요.", success: false };
        }

        // 각 요일별로 블록 추가
        const errors: string[] = [];
        let successCount = 0;

        for (const day of selectedWeekdays) {
          const blockFormData = new FormData();
          blockFormData.append("day", String(day));
          blockFormData.append("start_time", formData.get("start_time") as string);
          blockFormData.append("end_time", formData.get("end_time") as string);
          blockFormData.append("block_set_id", blockSetId);
          
          try {
            await addTenantBlock(blockFormData);
            successCount++;
          } catch (blockError: any) {
            const dayLabel = ["일", "월", "화", "수", "목", "금", "토"][day];
            errors.push(`${dayLabel}요일: ${blockError.message || "추가 실패"}`);
          }
        }

        if (successCount === 0) {
          return { 
            error: `모든 블록 추가에 실패했습니다:\n${errors.join("\n")}`, 
            success: false 
          };
        }

        if (errors.length > 0) {
          return { 
            error: `${successCount}개 블록이 추가되었습니다. 일부 실패:\n${errors.join("\n")}`, 
            success: true 
          };
        }

        return { error: null, success: true };
      } catch (err: any) {
        return { error: err.message || "블록 추가에 실패했습니다.", success: false };
      }
    },
    initialState
  );

  const toggleWeekday = (day: number) => {
    setSelectedWeekdays((prev) =>
      prev.includes(day) ? prev.filter((d) => d !== day) : [...prev, day]
    );
  };

  // 성공 시 폼 리셋 및 닫기
  useEffect(() => {
    if (state.success) {
      setSelectedWeekdays([]);
      setStartTime("");
      setEndTime("");
      
      if (blockSetId && onBlockChange) {
        onBlockChange(blockSetId);
      }
      
      if (state.error) {
        toast.showInfo(state.error);
      } else {
        toast.showSuccess("블록이 성공적으로 추가되었습니다.");
      }
      
      const timer = setTimeout(() => {
        if (onClose) {
          onClose();
        }
      }, 1500);
      return () => clearTimeout(timer);
    }
  }, [state.success, onClose, blockSetId, onBlockChange, state.error, toast]);

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-gray-900">
            새 시간 블록 추가
          </h2>
          {onClose && (
            <button
              type="button"
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 transition-colors"
              disabled={isPending}
            >
              <span className="text-2xl">×</span>
            </button>
          )}
        </div>

        {state.error && !state.success && (
          <div className="mb-4 p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded">
            {state.error}
          </div>
        )}

        {state.success && (
          <div className="mb-4 p-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded">
            {state.error || "블록이 성공적으로 추가되었습니다."}
          </div>
        )}

        <form action={formAction} className="flex flex-col gap-4">
          <div className="flex flex-col gap-2">
            <label className="block text-sm font-medium text-gray-700">
              추가할 요일 선택
            </label>
            <div className="flex flex-wrap gap-2">
              {[
                { value: 0, label: "일" },
                { value: 1, label: "월" },
                { value: 2, label: "화" },
                { value: 3, label: "수" },
                { value: 4, label: "목" },
                { value: 5, label: "금" },
                { value: 6, label: "토" },
              ].map((day) => (
                <button
                  key={day.value}
                  type="button"
                  onClick={() => toggleWeekday(day.value)}
                  className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                    selectedWeekdays.includes(day.value)
                      ? "bg-indigo-600 text-white"
                      : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                  }`}
                >
                  {day.label}요일
                </button>
              ))}
            </div>
            {selectedWeekdays.length === 0 && (
              <p className="text-xs text-amber-600">
                추가할 요일을 최소 1개 이상 선택해주세요.
              </p>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                시작 시간
              </label>
              <input
                type="time"
                name="start_time"
                value={startTime}
                onChange={(e) => setStartTime(e.target.value)}
                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                required
              />
            </div>

            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                종료 시간
              </label>
              <input
                type="time"
                name="end_time"
                value={endTime}
                onChange={(e) => setEndTime(e.target.value)}
                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                required
              />
            </div>
          </div>

          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              💡 <strong>팁:</strong> 선택한 요일들에 동일한 시간 블록이 일괄 추가됩니다.
            </p>
          </div>

          <div className="flex gap-2">
            <button
              type="submit"
              disabled={
                isPending ||
                selectedWeekdays.length === 0 ||
                !startTime ||
                !endTime
              }
              className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isPending ? "저장 중..." : "블록 추가하기"}
            </button>
            {onClose && (
              <button
                type="button"
                onClick={onClose}
                disabled={isPending}
                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50"
              >
                취소
              </button>
            )}
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/time-management/_components/TemplateBlockSetManagement.tsx">
"use client";

import { useEffect, useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import TemplateBlocksViewer from "./TemplateBlocksViewer";

type BlockSet = {
  id: string;
  name: string;
  description?: string | null;
  blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
};

type TemplateBlockSetManagementProps = {
  templateId: string;
  initialBlockSets?: Array<{ 
    id: string; 
    name: string; 
    description?: string | null;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }> 
  }>;
  selectedBlockSetId?: string | null;
};

export default function TemplateBlockSetManagement({
  templateId,
  initialBlockSets = [],
  selectedBlockSetId = null,
}: TemplateBlockSetManagementProps) {
  const router = useRouter();
  const [blockSets, setBlockSets] = useState<BlockSet[]>(initialBlockSets.map(set => ({
    id: set.id,
    name: set.name,
    description: set.description ?? null,
    blocks: set.blocks ?? [],
  })));
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // 특정 세트의 블록만 업데이트
  const updateSetBlocks = useCallback(async (setId: string) => {
    try {
      const { getTenantBlockSets } = await import("@/app/(admin)/actions/tenantBlockSets");
      const { getTemplateBlockSet } = await import("@/app/(admin)/actions/campTemplateBlockSets");
      
      // 모든 테넌트 블록 세트 조회
      const allBlockSets = await getTenantBlockSets();
      
      // 템플릿에 연결된 블록 세트 조회
      const linkedBlockSet = await getTemplateBlockSet(templateId);
      let data = allBlockSets;
      
      if (linkedBlockSet) {
        const hasBlockSet = allBlockSets.some(set => set.id === linkedBlockSet.id);
        if (!hasBlockSet) {
          data = [linkedBlockSet, ...allBlockSets];
        }
      }
      
      const updatedSet = data.find(s => s.id === setId);
      if (updatedSet) {
        setBlockSets((prevSets) =>
          prevSets.map((set) =>
            set.id === setId
              ? { ...set, blocks: updatedSet.blocks ?? [] }
              : set
          )
        );
      }
    } catch (error) {
      console.error(`세트 ${setId}의 블록 조회 실패:`, error);
    }
  }, [templateId]);

  // 전체 데이터 로드
  const loadData = useCallback(async (skipLoadingState = false) => {
    try {
      if (!skipLoadingState) {
        setIsLoading(true);
        setError(null);
      }

      const { getTenantBlockSets } = await import("@/app/(admin)/actions/tenantBlockSets");
      const { getTemplateBlockSet } = await import("@/app/(admin)/actions/campTemplateBlockSets");
      
      // 모든 테넌트 블록 세트 조회
      const allBlockSets = await getTenantBlockSets();
      
      // 템플릿에 연결된 블록 세트 조회
      const linkedBlockSet = await getTemplateBlockSet(templateId);
      let data = allBlockSets;
      
      if (linkedBlockSet) {
        const hasBlockSet = allBlockSets.some(set => set.id === linkedBlockSet.id);
        if (!hasBlockSet) {
          data = [linkedBlockSet, ...allBlockSets];
        }
      }

      const updatedSets = (data || []).map(set => ({
        id: set.id,
        name: set.name,
        description: null,
        blocks: set.blocks ?? [],
      }));

      setBlockSets(updatedSets);
      setError(null);
    } catch (error: any) {
      console.error("블록 데이터 로드 실패:", error);
      const errorMessage = error?.message || "블록 데이터를 불러오는 중 오류가 발생했습니다.";
      setError(errorMessage);
    } finally {
      if (!skipLoadingState) {
        setIsLoading(false);
      }
    }
  }, [templateId]);

  // 초기 마운트 시 서버 데이터 사용
  useEffect(() => {
    if (initialBlockSets.length === 0) {
      loadData(true);
    }
  }, [loadData, initialBlockSets.length]);

  return (
    <div>
      {/* 에러 메시지 */}
      {error && (
        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0">
              <span className="text-2xl">⚠️</span>
            </div>
            <div className="flex-1">
              <h3 className="text-sm font-semibold text-red-800 mb-1">
                데이터 로드 실패
              </h3>
              <p className="text-sm text-red-700 mb-3">{error}</p>
              <button
                type="button"
                onClick={() => loadData()}
                className="text-sm text-red-700 hover:text-red-900 underline font-medium"
              >
                다시 시도
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 블록 뷰어 */}
      <TemplateBlocksViewer 
        templateId={templateId}
        blocks={[]} 
        blockSets={blockSets} 
        selectedBlockSetId={selectedBlockSetId}
        isLoading={isLoading}
        onCreateSetSuccess={async () => {
          router.refresh();
        }}
        onBlockChange={updateSetBlocks}
        existingSetCount={blockSets.length}
      />
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/time-management/_components/TemplateBlocksViewer.tsx">
"use client";

import { useMemo, useState, useActionState } from "react";
import { useRouter } from "next/navigation";
import TemplateBlockForm from "./TemplateBlockForm";
import { createTenantBlockSet } from "@/app/(admin)/actions/tenantBlockSets";
import { validateFormData, blockSetSchema } from "@/lib/validation/schemas";
import { useToast } from "@/components/ui/ToastProvider";

type BlockSet = {
  id: string;
  name: string;
  description?: string | null;
  blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
};

type TemplateBlocksViewerProps = {
  templateId: string;
  blocks: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  blockSets: BlockSet[];
  selectedBlockSetId: string | null;
  isLoading?: boolean;
  onCreateSetSuccess?: () => void;
  onBlockChange?: (setId: string) => Promise<void>;
  existingSetCount?: number;
};

const DAYS = ["일", "월", "화", "수", "목", "금", "토"];

export default function TemplateBlocksViewer({
  templateId,
  blocks,
  blockSets,
  selectedBlockSetId,
  isLoading = false,
  onCreateSetSuccess,
  onBlockChange,
  existingSetCount = 0,
}: TemplateBlocksViewerProps) {
  const router = useRouter();
  const toast = useToast();
  const [creating, setCreating] = useState(false);
  
  // 각 블록 세트별 총 시간 계산
  const blockSetsWithStats = useMemo(() => {
    return blockSets.map((set) => {
      const setBlocks = set.blocks ?? [];
      const totalMinutes = setBlocks.reduce((acc, block) => {
        const [startH, startM] = (block.start_time ?? "00:00").split(":").map(Number);
        const [endH, endM] = (block.end_time ?? "00:00").split(":").map(Number);
        const start = startH * 60 + startM;
        const end = endH * 60 + endM;
        const duration = end - start;
        return acc + (duration > 0 ? duration : 0);
      }, 0);

      const totalHours = Math.floor(totalMinutes / 60);
      const remainingMinutes = Math.max(0, totalMinutes % 60);

      // 요일별 블록 개수 계산
      const dayDistribution = setBlocks.reduce((acc, block) => {
        const day = DAYS[block.day_of_week] ?? "";
        acc[day] = (acc[day] || 0) + 1;
        return acc;
      }, {} as Record<string, number>);

      return {
        ...set,
        blockCount: setBlocks.length,
        totalHours,
        remainingMinutes,
        dayDistribution,
      };
    });
  }, [blockSets]);

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[1, 2, 3].map((i) => (
          <div key={i} className="flex flex-col gap-4 bg-white border border-gray-200 rounded-lg p-6 animate-pulse">
            <div className="h-6 bg-gray-200 rounded w-3/4"></div>
            <div className="flex flex-col gap-2">
              <div className="h-4 bg-gray-200 rounded w-1/2"></div>
              <div className="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  return (
    <>
      {/* 새 세트 추가 폼 (모달) */}
      {creating && (
        <TemplateBlockSetCreateForm
          templateId={templateId}
          onSuccess={async (newSetId?: string) => {
            setCreating(false);
            if (newSetId && onBlockChange) {
              await onBlockChange(newSetId);
            }
            if (onCreateSetSuccess) {
              await onCreateSetSuccess();
            }
            router.refresh();
          }}
          onCancel={() => setCreating(false)}
          existingCount={existingSetCount}
        />
      )}

      {/* 블록 세트 목록 */}
      {blockSetsWithStats.length > 0 ? (
        <div className="flex flex-col gap-8">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-medium text-gray-900">등록된 블록 세트</h2>
            <button
              type="button"
              onClick={() => setCreating(true)}
              disabled={creating}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              + 새 세트 추가하기
            </button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {blockSetsWithStats.map((set) => (
              <div
                key={set.id}
                className={`bg-white border-2 rounded-lg p-6 transition-all hover:shadow-md flex flex-col ${
                  selectedBlockSetId === set.id
                    ? "border-indigo-500 bg-indigo-50"
                    : "border-gray-200 hover:border-gray-300"
                }`}
              >
                {/* 헤더 */}
                <div className="flex items-start justify-between">
                  <div className="flex flex-col gap-1 flex-1">
                    <h3 className="text-lg font-semibold text-gray-900">{set.name}</h3>
                    {selectedBlockSetId === set.id && (
                      <span className="inline-block px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 rounded">
                        선택됨
                      </span>
                    )}
                  </div>
                  <button
                    type="button"
                    onClick={async (e) => {
                      e.stopPropagation();
                      if (!confirm(`"${set.name}" 세트를 삭제하시겠습니까? 포함된 모든 블록도 함께 삭제됩니다.`)) {
                        return;
                      }
                      try {
                        const { deleteTenantBlockSet } = await import("@/app/(admin)/actions/tenantBlockSets");
                        const formData = new FormData();
                        formData.append("id", set.id);
                        await deleteTenantBlockSet(formData);
                        if (onCreateSetSuccess) {
                          await onCreateSetSuccess();
                        }
                        router.refresh();
                      } catch (error: any) {
                        toast.showError(error.message || "세트 삭제에 실패했습니다.");
                      }
                    }}
                    className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    title="세트 삭제"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      className="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      />
                    </svg>
                  </button>
                </div>

                {/* 설명 */}
                {set.description && (
                  <p className="text-sm text-gray-600">{set.description}</p>
                )}

                {/* 통계 정보 */}
                <div className="flex flex-col gap-2 flex-1">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">블록 개수</span>
                    <span className="font-medium text-gray-900">{set.blockCount}개</span>
                  </div>
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">주간 총 시간</span>
                    <span className="font-medium text-gray-900">
                      {set.totalHours}시간 {set.remainingMinutes}분
                    </span>
                  </div>
                  {set.blockCount > 0 && (
                    <div className="flex flex-col gap-1 pt-2 border-t border-gray-200">
                      <div className="text-xs text-gray-500">요일별 블록</div>
                      <div className="flex flex-wrap gap-1">
                        {Object.entries(set.dayDistribution).map(([day, count]) => (
                          <span
                            key={day}
                            className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded"
                          >
                            {day} {count}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* 액션 버튼들 - 하단 고정 */}
                <div className="flex gap-2 mt-auto">
                  {selectedBlockSetId !== set.id && (
                    <button
                      type="button"
                      onClick={async () => {
                        if (!confirm(`"${set.name}" 블록 세트를 이 템플릿에 연결하시겠습니까?`)) {
                          return;
                        }
                        try {
                          const { updateCampTemplateAction } = await import("@/app/(admin)/actions/campTemplateActions");
                          // 템플릿 조회
                          const { getCampTemplateById } = await import("@/app/(admin)/actions/campTemplateActions");
                          const templateResult = await getCampTemplateById(templateId);
                          if (!templateResult.success || !templateResult.template) {
                            throw new Error("템플릿을 찾을 수 없습니다.");
                          }
                          
                          // template_data 업데이트
                          const templateData = templateResult.template.template_data || {};
                          const updatedTemplateData = {
                            ...templateData,
                            block_set_id: set.id,
                          };
                          
                          const formData = new FormData();
                          formData.append("name", templateResult.template.name);
                          formData.append("program_type", templateResult.template.program_type);
                          formData.append("description", templateResult.template.description || "");
                          formData.append("status", templateResult.template.status);
                          formData.append("template_data", JSON.stringify(updatedTemplateData));
                          
                          const result = await updateCampTemplateAction(templateId, formData);
                          if (!result.success) {
                            throw new Error(result.error || "템플릿 업데이트에 실패했습니다.");
                          }
                          
                          toast.showSuccess("블록 세트가 템플릿에 연결되었습니다.");
                          router.refresh();
                        } catch (error: any) {
                          toast.showError(error.message || "블록 세트 연결에 실패했습니다.");
                        }
                      }}
                      className="flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                      선택하기
                    </button>
                  )}
                  <a
                    href={`/admin/camp-templates/${templateId}/time-management/${set.id}`}
                    className={`${selectedBlockSetId === set.id ? 'flex-1 ' : ''}block text-center px-4 py-2 text-sm font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors`}
                  >
                    상세 보기
                  </a>
                </div>
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div className="flex flex-col gap-6 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
          <div className="mx-auto max-w-md">
            <div className="text-6xl">⏰</div>
            <h3 className="text-lg font-semibold text-gray-900">
              등록된 블록 세트가 없습니다
            </h3>
            <p className="text-sm text-gray-500">
              위의 버튼을 사용하여 블록 세트를 추가하세요.
            </p>
            <button
              type="button"
              onClick={() => setCreating(true)}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
            >
              + 새 세트 추가하기
            </button>
          </div>
        </div>
      )}
    </>
  );
}

// TemplateBlockSetCreateForm 컴포넌트
function TemplateBlockSetCreateForm({
  templateId,
  onSuccess,
  onCancel,
  existingCount,
}: {
  templateId: string;
  onSuccess: (newSetId?: string) => void | Promise<void>;
  onCancel: () => void;
  existingCount: number;
}) {
  const router = useRouter();
  const toast = useToast();
  const [selectedWeekdays, setSelectedWeekdays] = useState<number[]>([]);
  const [startTime, setStartTime] = useState<string>("");
  const [endTime, setEndTime] = useState<string>("");
  
  const [state, formAction, isPending] = useActionState(
    async (_prev: { error: string | null }, formData: FormData) => {
      try {
        // 세트 생성
        const validation = validateFormData(formData, blockSetSchema);
        if (!validation.success) {
          const firstError = validation.errors.issues[0];
          return { error: firstError?.message || "입력값이 올바르지 않습니다." };
        }

        // template_id는 더 이상 필요 없음 (tenant_id만 사용)
        const result = await createTenantBlockSet(formData);
        
        // 시간 블록이 입력된 경우 추가
        if (selectedWeekdays.length > 0 && startTime && endTime) {
          const { addTenantBlock } = await import("@/app/(admin)/actions/tenantBlockSets");
          for (const day of selectedWeekdays) {
            const blockFormData = new FormData();
            blockFormData.append("day", String(day));
            blockFormData.append("start_time", startTime);
            blockFormData.append("end_time", endTime);
            blockFormData.append("block_set_id", result.blockSetId);
            
            try {
              await addTenantBlock(blockFormData);
            } catch (blockError: any) {
              console.warn("블록 추가 실패:", blockError);
            }
          }
        }
        
        router.refresh();
        onSuccess(result.blockSetId);
        return { error: null };
      } catch (err: any) {
        return { error: err.message || "세트 생성에 실패했습니다." };
      }
    },
    { error: null }
  );

  const toggleWeekday = (day: number) => {
    setSelectedWeekdays((prev) =>
      prev.includes(day) ? prev.filter((d) => d !== day) : [...prev, day]
    );
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="flex flex-col gap-4 bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-900">새 블록 세트 추가</h3>
          <button
            type="button"
            onClick={onCancel}
            className="text-gray-400 hover:text-gray-600 transition-colors"
            disabled={isPending}
          >
            <span className="text-2xl">×</span>
          </button>
        </div>
        
        <form action={formAction} className="flex flex-col gap-4">
          {state.error && (
            <p className="text-sm text-red-600 bg-red-50 p-2 rounded">{state.error}</p>
          )}

          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-gray-700">세트 이름</label>
            <input
              type="text"
              name="name"
              placeholder="예: 기본 시간표"
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
              required
              maxLength={100}
            />
          </div>

          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-gray-700">설명 (선택)</label>
            <textarea
              name="description"
              placeholder="세트에 대한 설명을 입력하세요"
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
              rows={2}
              maxLength={500}
            />
          </div>

          <div className="flex flex-col gap-3 border-t border-gray-200 pt-4">
            <h4 className="text-sm font-medium text-gray-700">시간 블록 추가 (선택)</h4>
            
            <div className="flex flex-col gap-2">
              <label className="text-sm font-medium text-gray-700">추가할 요일 선택</label>
              <div className="flex flex-wrap gap-2">
                {[
                  { value: 0, label: "일" },
                  { value: 1, label: "월" },
                  { value: 2, label: "화" },
                  { value: 3, label: "수" },
                  { value: 4, label: "목" },
                  { value: 5, label: "금" },
                  { value: 6, label: "토" },
                ].map((day) => (
                  <button
                    key={day.value}
                    type="button"
                    onClick={() => toggleWeekday(day.value)}
                    className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                      selectedWeekdays.includes(day.value)
                        ? "bg-indigo-600 text-white"
                        : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                    }`}
                  >
                    {day.label}요일
                  </button>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">시작 시간</label>
                <input
                  type="time"
                  value={startTime}
                  onChange={(e) => setStartTime(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>

              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">종료 시간</label>
                <input
                  type="time"
                  value={endTime}
                  onChange={(e) => setEndTime(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
            </div>
          </div>

          <div className="flex gap-2">
            <button
              type="submit"
              disabled={isPending}
              className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50"
            >
              {isPending ? "생성 중..." : "생성"}
            </button>
            <button
              type="button"
              onClick={onCancel}
              disabled={isPending}
              className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors disabled:opacity-50"
            >
              취소
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/time-management/[setId]/_components/TemplateBlockSetDetail.tsx">
"use client";

import { useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import TemplateBlockForm from "../../_components/TemplateBlockForm";
import { useToast } from "@/components/ui/ToastProvider";

type TemplateBlockSetDetailProps = {
  templateId: string;
  blockSet: {
    id: string;
    name: string;
    description?: string | null;
  };
  blocks: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  isSelected: boolean;
};

const weekdayLabels = ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"];

export default function TemplateBlockSetDetail({
  templateId,
  blockSet,
  blocks,
  isSelected,
}: TemplateBlockSetDetailProps) {
  const router = useRouter();
  const toast = useToast();
  const [showBlockForm, setShowBlockForm] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);

  const handleBlockChange = useCallback(async () => {
    router.refresh();
  }, [router]);

  const handleDelete = async () => {
    if (!confirm(`"${blockSet.name}" 세트를 삭제하시겠습니까? 포함된 모든 블록도 함께 삭제됩니다.`)) {
      return;
    }

    setIsDeleting(true);
    try {
      const { deleteTenantBlockSet } = await import("@/app/(admin)/actions/tenantBlockSets");
      const formData = new FormData();
      formData.append("id", blockSet.id);
      await deleteTenantBlockSet(formData);
      toast.showSuccess("블록 세트가 삭제되었습니다.");
      router.push(`/admin/camp-templates/${templateId}/time-management`);
    } catch (error: any) {
      toast.showError(error.message || "블록 세트 삭제에 실패했습니다.");
      setIsDeleting(false);
    }
  };

  const handleBlockDelete = async (blockId: string) => {
    if (!confirm("이 블록을 삭제하시겠습니까?")) {
      return;
    }

    try {
      const { deleteTenantBlock } = await import("@/app/(admin)/actions/tenantBlockSets");
      const formData = new FormData();
      formData.append("id", blockId);
      await deleteTenantBlock(formData);
      toast.showSuccess("블록이 삭제되었습니다.");
      router.refresh();
    } catch (error: any) {
      toast.showError(error.message || "블록 삭제에 실패했습니다.");
    }
  };

  return (
    <div className="space-y-6">
      {/* 블록 세트 정보 */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              <h2 className="text-xl font-semibold text-gray-900">{blockSet.name}</h2>
              {isSelected && (
                <span className="inline-block px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 rounded">
                  선택됨
                </span>
              )}
            </div>
            {blockSet.description && (
              <p className="text-sm text-gray-600">{blockSet.description}</p>
            )}
          </div>
          <button
            type="button"
            onClick={handleDelete}
            disabled={isDeleting}
            className="px-4 py-2 text-sm font-medium text-red-700 bg-red-50 rounded-lg hover:bg-red-100 transition-colors disabled:opacity-50"
          >
            {isDeleting ? "삭제 중..." : "세트 삭제"}
          </button>
        </div>

        {/* 블록 목록 */}
        <div className="mt-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-medium text-gray-900">시간 블록</h3>
            <button
              type="button"
              onClick={() => setShowBlockForm(true)}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
            >
              + 블록 추가
            </button>
          </div>

          {blocks.length > 0 ? (
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {blocks.map((block) => (
                <div
                  key={block.id}
                  className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-4 py-3"
                >
                  <div>
                    <div className="text-sm font-medium text-gray-900">
                      {weekdayLabels[block.day_of_week]}
                    </div>
                    <div className="text-xs text-gray-600">
                      {block.start_time} ~ {block.end_time}
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => handleBlockDelete(block.id)}
                    className="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                    title="블록 삭제"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      className="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              ))}
            </div>
          ) : (
            <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
              <p className="text-sm text-gray-500">등록된 시간 블록이 없습니다.</p>
            </div>
          )}
        </div>
      </div>

      {/* 블록 추가 폼 */}
      {showBlockForm && (
        <TemplateBlockForm
          blockSetId={blockSet.id}
          onClose={() => setShowBlockForm(false)}
          onBlockChange={handleBlockChange}
        />
      )}
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/time-management/[setId]/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";

type PageProps = {
  params: Promise<{ id: string; setId: string }>;
};

// 기존 경로를 새 경로로 리다이렉트
export default async function TemplateBlockSetDetailPage({ params }: PageProps) {
  const { id, setId } = await params;
  redirect(`/admin/time-management/${id}/${setId}`);
}
</file>

<file path="admin/camp-templates/[id]/time-management/page.tsx">
import { redirect } from "next/navigation";

type TimeManagementPageProps = {
  params: Promise<{ id: string }>;
};

// 기존 경로를 새 경로로 리다이렉트
export default async function TimeManagementPage({
  params,
}: TimeManagementPageProps) {
  const { id } = await params;
  redirect(`/admin/time-management/${id}`);
}
</file>

<file path="admin/camp-templates/[id]/CampInvitationList.tsx">
"use client";

import { useState, useTransition } from "react";
import { CampInvitation } from "@/lib/types/plan";
import { deleteCampInvitationAction, deleteCampInvitationsAction, resendCampInvitationsAction } from "@/app/(admin)/actions/campTemplateActions";
import { useToast } from "@/components/ui/ToastProvider";

type CampInvitationListProps = {
  invitations: Array<CampInvitation & { student_name?: string | null; student_grade?: string | null; student_class?: string | null }>;
  loading: boolean;
  templateId: string;
  onRefresh?: () => void;
};

export function CampInvitationList({ invitations, loading, templateId, onRefresh }: CampInvitationListProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  if (loading) {
    return <div className="text-sm text-gray-700">초대 목록을 불러오는 중...</div>;
  }

  if (invitations.length === 0) {
    return (
      <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
        <p className="text-sm text-gray-700">발송된 초대가 없습니다.</p>
      </div>
    );
  }

  // 상태별 통계
  const stats = {
    pending: invitations.filter((inv) => inv.status === "pending").length,
    accepted: invitations.filter((inv) => inv.status === "accepted").length,
    declined: invitations.filter((inv) => inv.status === "declined").length,
  };

  const handleToggleSelect = (invitationId: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(invitationId)) {
        next.delete(invitationId);
      } else {
        next.add(invitationId);
      }
      return next;
    });
  };

  const handleSelectAll = () => {
    if (selectedIds.size === invitations.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(invitations.map((inv) => inv.id)));
    }
  };

  const handleDelete = (invitationId: string) => {
    const invitation = invitations.find((inv) => inv.id === invitationId);
    const warningMessage =
      invitation?.status === "accepted"
        ? "이미 수락된 초대입니다. 정말 삭제하시겠습니까?"
        : "정말 이 초대를 삭제하시겠습니까?";

    if (!confirm(warningMessage)) {
      return;
    }

    startTransition(async () => {
      try {
        const result = await deleteCampInvitationAction(invitationId);
        if (result.success) {
          toast.showSuccess("초대가 삭제되었습니다.");
          onRefresh?.();
        } else {
          toast.showError(result.error || "초대 삭제에 실패했습니다.");
        }
      } catch (error) {
        console.error("초대 삭제 실패:", error);
        toast.showError("초대 삭제에 실패했습니다.");
      }
    });
  };

  const handleBulkDelete = () => {
    if (selectedIds.size === 0) {
      toast.showError("삭제할 초대를 선택해주세요.");
      return;
    }

    const selectedInvitations = invitations.filter((inv) => selectedIds.has(inv.id));
    const hasAccepted = selectedInvitations.some((inv) => inv.status === "accepted");
    const warningMessage = hasAccepted
      ? `${selectedIds.size}개의 초대를 삭제합니다. 이미 수락된 초대가 포함되어 있습니다. 계속하시겠습니까?`
      : `${selectedIds.size}개의 초대를 삭제합니다. 계속하시겠습니까?`;

    if (!confirm(warningMessage)) {
      return;
    }

    startTransition(async () => {
      try {
        const result = await deleteCampInvitationsAction(Array.from(selectedIds));
        if (result.success) {
          toast.showSuccess(`${result.count || selectedIds.size}개의 초대가 삭제되었습니다.`);
          setSelectedIds(new Set());
          onRefresh?.();
        } else {
          toast.showError(result.error || "초대 삭제에 실패했습니다.");
        }
      } catch (error) {
        console.error("초대 일괄 삭제 실패:", error);
        toast.showError("초대 삭제에 실패했습니다.");
      }
    });
  };

  const handleResend = () => {
    if (selectedIds.size === 0) {
      toast.showError("재발송할 초대를 선택해주세요.");
      return;
    }

    if (!confirm(`${selectedIds.size}개의 초대를 재발송합니다. 계속하시겠습니까?`)) {
      return;
    }

    startTransition(async () => {
      try {
        const result = await resendCampInvitationsAction(templateId, Array.from(selectedIds));
        if (result.success) {
          toast.showSuccess(`${result.count || selectedIds.size}개의 초대가 재발송되었습니다.`);
          setSelectedIds(new Set());
          onRefresh?.();
        } else {
          toast.showError(result.error || "초대 재발송에 실패했습니다.");
        }
      } catch (error) {
        console.error("초대 재발송 실패:", error);
        toast.showError("초대 재발송에 실패했습니다.");
      }
    });
  };

  return (
    <div className="flex flex-col gap-4">
      {/* 통계 */}
      <div className="grid grid-cols-3 gap-4">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-800">대기중</div>
          <div className="mt-1 text-2xl font-semibold text-yellow-600">{stats.pending}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-800">수락</div>
          <div className="mt-1 text-2xl font-semibold text-green-600">{stats.accepted}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-800">거절</div>
          <div className="mt-1 text-2xl font-semibold text-red-600">{stats.declined}</div>
        </div>
      </div>

      {/* 액션 버튼 */}
      {invitations.length > 0 && (
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <button
              type="button"
              onClick={handleSelectAll}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              {selectedIds.size === invitations.length ? "전체 해제" : "전체 선택"}
            </button>
            {selectedIds.size > 0 && (
              <>
                <button
                  type="button"
                  onClick={handleResend}
                  disabled={isPending}
                  className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:bg-indigo-400"
                >
                  {isPending ? "처리 중..." : `재발송 (${selectedIds.size})`}
                </button>
                <button
                  type="button"
                  onClick={handleBulkDelete}
                  disabled={isPending}
                  className="rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-semibold text-red-600 transition hover:bg-red-50 disabled:bg-gray-100"
                >
                  {isPending ? "삭제 중..." : `삭제 (${selectedIds.size})`}
                </button>
              </>
            )}
          </div>
          {selectedIds.size > 0 && (
            <div className="text-sm text-gray-800">
              {selectedIds.size}개 선택됨
            </div>
          )}
        </div>
      )}

      {/* 초대 목록 */}
      <div className="overflow-x-auto">
        <table className="w-full border-collapse rounded-lg border border-gray-200 bg-white">
          <thead className="bg-gray-50">
            <tr>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                <input
                  type="checkbox"
                  checked={selectedIds.size === invitations.length && invitations.length > 0}
                  onChange={handleSelectAll}
                  className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                />
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                학생명
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                학년/반
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                상태
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                초대일
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                처리일
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                작업
              </th>
            </tr>
          </thead>
          <tbody>
            {invitations.map((invitation) => (
              <tr key={invitation.id} className="hover:bg-gray-50">
                <td className="border-b border-gray-100 px-4 py-3">
                  <input
                    type="checkbox"
                    checked={selectedIds.has(invitation.id)}
                    onChange={() => handleToggleSelect(invitation.id)}
                    className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                  />
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm font-medium text-gray-900">
                  {invitation.student_name || "이름 없음"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-800">
                  {invitation.student_grade && invitation.student_class
                    ? `${invitation.student_grade}학년 ${invitation.student_class}반`
                    : "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm">
                  {invitation.status === "pending" && (
                    <span className="inline-flex items-center rounded-full bg-yellow-100 px-3 py-1 text-xs font-medium text-yellow-800">
                      대기중
                    </span>
                  )}
                  {invitation.status === "accepted" && (
                    <span className="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800">
                      수락
                    </span>
                  )}
                  {invitation.status === "declined" && (
                    <span className="inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-xs font-medium text-red-800">
                      거절
                    </span>
                  )}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-800">
                  {invitation.invited_at
                    ? new Date(invitation.invited_at).toLocaleDateString("ko-KR")
                    : "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-800">
                  {invitation.accepted_at
                    ? new Date(invitation.accepted_at).toLocaleDateString("ko-KR")
                    : invitation.declined_at
                    ? new Date(invitation.declined_at).toLocaleDateString("ko-KR")
                    : "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm">
                  <button
                    type="button"
                    onClick={() => handleDelete(invitation.id)}
                    disabled={isPending}
                    className="text-red-600 hover:text-red-800 disabled:text-gray-400"
                  >
                    삭제
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/[id]/CampTemplateDetail.tsx">
"use client";

import { useState, useTransition, useEffect, useCallback } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { CampTemplate } from "@/lib/types/plan";
import {
  getCampInvitationsForTemplate,
  deleteCampTemplateAction,
  updateCampTemplateStatusAction,
} from "@/app/(admin)/actions/campTemplateActions";
import { useToast } from "@/components/ui/ToastProvider";
import { StudentInvitationForm } from "./StudentInvitationForm";
import { CampInvitationList } from "./CampInvitationList";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";
import { Trash2 } from "lucide-react";
import {
  planPurposeLabels,
  schedulerTypeLabels,
} from "@/lib/constants/planLabels";

type CampTemplateDetailProps = {
  template: CampTemplate;
  templateBlockSet?: {
    id: string;
    name: string;
    blocks: Array<{
      id: string;
      day_of_week: number;
      start_time: string;
      end_time: string;
    }>;
  } | null;
};

const weekdayLabels = [
  "일요일",
  "월요일",
  "화요일",
  "수요일",
  "목요일",
  "금요일",
  "토요일",
];

export function CampTemplateDetail({
  template,
  templateBlockSet,
}: CampTemplateDetailProps) {
  const router = useRouter();
  // 템플릿 데이터를 변수로 추출하여 반복 접근 최적화 및 타입 안전성 확보
  const templateData = template.template_data;
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  const [invitations, setInvitations] = useState<any[]>([]);
  const [loadingInvitations, setLoadingInvitations] = useState(true);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [currentStatus, setCurrentStatus] = useState<
    "draft" | "active" | "archived"
  >(template.status);
  const [isChangingStatus, setIsChangingStatus] = useState(false);

  // 초대 목록 로드 (useCallback으로 메모이제이션)
  // toast는 Context에서 제공되는 안정적인 객체이므로 의존성에서 제외
  const loadInvitations = useCallback(async () => {
    // 삭제 중이면 실행하지 않음
    if (isDeleting) {
      return;
    }

    try {
      setLoadingInvitations(true);
      const result = await getCampInvitationsForTemplate(template.id);
      if (result.success) {
        setInvitations(result.invitations || []);
      } else {
        // 에러가 발생한 경우 빈 배열로 처리
        setInvitations([]);
        toast.showError("초대 목록을 불러오는데 실패했습니다.");
      }
    } catch (error) {
      console.error("초대 목록 로드 실패:", error);
      const errorMessage =
        error instanceof Error
          ? error.message
          : "초대 목록을 불러오는데 실패했습니다.";
      // 템플릿이 없는 경우는 조용히 처리
      if (errorMessage.includes("템플릿을 찾을 수 없습니다")) {
        setInvitations([]);
      } else {
        toast.showError(errorMessage);
      }
    } finally {
      setLoadingInvitations(false);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [template.id, isDeleting]);

  // 초기 로드 (template.id와 isDeleting만 의존하여 불필요한 재호출 방지)
  useEffect(() => {
    if (!isDeleting) {
      loadInvitations();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [template.id, isDeleting]);

  // 초대 발송 후 목록 새로고침 (useCallback으로 메모이제이션)
  const handleInvitationSent = useCallback(() => {
    loadInvitations();
  }, [loadInvitations]);

  const handleStatusChange = async (
    newStatus: "draft" | "active" | "archived"
  ) => {
    if (currentStatus === newStatus) return;

    setIsChangingStatus(true);
    try {
      const result = await updateCampTemplateStatusAction(
        template.id,
        newStatus
      );
      if (result.success) {
        setCurrentStatus(newStatus);
        toast.showSuccess(
          newStatus === "active"
            ? "템플릿이 활성화되었습니다."
            : newStatus === "draft"
            ? "템플릿이 비활성화되었습니다."
            : "템플릿이 보관되었습니다."
        );
        router.refresh();
      } else {
        toast.showError(result.error || "상태 변경에 실패했습니다.");
      }
    } catch (error) {
      console.error("상태 변경 실패:", error);
      const errorMessage =
        error instanceof Error ? error.message : "상태 변경에 실패했습니다.";
      toast.showError(errorMessage);
    } finally {
      setIsChangingStatus(false);
    }
  };

  const handleDelete = async () => {
    setIsDeleting(true);
    try {
      const result = await deleteCampTemplateAction(template.id);
      if (result.success) {
        toast.showSuccess("템플릿이 삭제되었습니다.");
        setShowDeleteDialog(false); // 다이얼로그 닫기
        // 삭제 후 목록 페이지로 리다이렉트 (replace 사용하여 히스토리 교체)
        router.replace("/admin/camp-templates");
      } else {
        toast.showError(result.error || "템플릿 삭제에 실패했습니다.");
        setIsDeleting(false);
      }
    } catch (error) {
      console.error("템플릿 삭제 실패:", error);
      const errorMessage =
        error instanceof Error ? error.message : "템플릿 삭제에 실패했습니다.";
      toast.showError(errorMessage);
      setIsDeleting(false);
    }
  };

  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-6">
          <div>
            <p className="text-sm font-medium text-gray-500">캠프 관리</p>
            <h1 className="text-3xl font-semibold text-gray-900">
              캠프 템플릿 관리
            </h1>
            <p className="text-sm text-gray-500">
              캠프 템플릿을 확인하고 관리하세요.
            </p>
          </div>

          {/* 버튼 영역 */}
          <div className="flex flex-wrap items-center justify-between gap-3">
            {/* 좌측: 목록으로 버튼 */}
            <Link
              href="/admin/camp-templates"
              className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              목록으로
            </Link>

            {/* 우측: 나머지 버튼들 */}
            <div className="flex flex-wrap items-center gap-3">
              {/* 상태 변경 드롭다운 */}
              <div className="flex items-center gap-2">
                <label htmlFor="status-select" className="text-sm font-medium text-gray-700">
                  상태:
                </label>
                <select
                  id="status-select"
                  value={currentStatus}
                  onChange={(e) => {
                    const newStatus = e.target.value as "draft" | "active" | "archived";
                    handleStatusChange(newStatus);
                  }}
                  disabled={isChangingStatus}
                  className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  <option value="active">활성</option>
                  <option value="draft">비활성</option>
                  <option value="archived">보관</option>
                </select>
              </div>
              <Link
                href={`/admin/camp-templates/${template.id}/participants`}
                className="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                참여자 목록
              </Link>
              {currentStatus !== "active" && (
                <Link
                  href={`/admin/camp-templates/${template.id}/edit`}
                  className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  수정하기
                </Link>
              )}
              {currentStatus === "active" && (
                <button
                  disabled
                  className="inline-flex items-center justify-center rounded-lg bg-gray-300 px-4 py-2 text-sm font-semibold text-gray-500 cursor-not-allowed"
                  title="활성 상태의 템플릿은 수정할 수 없습니다"
                >
                  수정하기
                </button>
              )}
              <button
                onClick={() => setShowDeleteDialog(true)}
                className="inline-flex items-center justify-center gap-2 rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-semibold text-red-700 transition hover:bg-red-50"
              >
                <Trash2 className="h-4 w-4" />
                삭제
              </button>
            </div>
          </div>
        </div>

        {/* 템플릿 정보 */}
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <h2 className="text-lg font-semibold text-gray-900">
            템플릿 정보
          </h2>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-700">
                템플릿 이름
              </label>
              <p className="text-sm text-gray-700">{template.name}</p>
            </div>
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-700">
                프로그램 유형
              </label>
              <p className="text-sm text-gray-700">{template.program_type}</p>
            </div>
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-700">
                상태
              </label>
              <p>
                {currentStatus === "draft" && (
                  <span className="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-800">
                    비활성
                  </span>
                )}
                {currentStatus === "active" && (
                  <span className="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800">
                    활성
                  </span>
                )}
                {currentStatus === "archived" && (
                  <span className="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-800">
                    보관
                  </span>
                )}
              </p>
            </div>
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-700">
                생성일
              </label>
              <p className="text-sm text-gray-700">
                {new Date(template.created_at).toLocaleDateString("ko-KR")}
              </p>
            </div>
            {template.description && (
              <div className="flex flex-col gap-1 md:col-span-2">
                <label className="text-sm font-medium text-gray-700">
                  설명
                </label>
                <p className="text-sm text-gray-700">
                  {template.description}
                </p>
              </div>
            )}
            {template.camp_start_date && (
              <div className="flex flex-col gap-1">
                <label className="text-sm font-medium text-gray-700">
                  캠프 시작일
                </label>
                <p className="text-sm text-gray-700">
                  {new Date(template.camp_start_date).toLocaleDateString(
                    "ko-KR"
                  )}
                </p>
              </div>
            )}
            {template.camp_end_date && (
              <div className="flex flex-col gap-1">
                <label className="text-sm font-medium text-gray-700">
                  캠프 종료일
                </label>
                <p className="text-sm text-gray-700">
                  {new Date(template.camp_end_date).toLocaleDateString("ko-KR")}
                </p>
              </div>
            )}
            {template.camp_location && (
              <div className="flex flex-col gap-1 md:col-span-2">
                <label className="text-sm font-medium text-gray-700">
                  캠프 장소
                </label>
                <p className="text-sm text-gray-700">
                  {template.camp_location}
                </p>
              </div>
            )}
          </div>
        </div>

        {/* 템플릿 데이터 상세 정보 */}
        {templateData && (
          <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
            <h2 className="text-lg font-semibold text-gray-900">
              템플릿 설정 정보
            </h2>
            <div className="grid gap-4 md:grid-cols-2">
              {/* 학습 기간 */}
              {templateData?.period_start && templateData?.period_end && (
                <div className="flex flex-col gap-1 md:col-span-2">
                  <label className="text-sm font-medium text-gray-700">
                    학습 기간
                  </label>
                  <p className="text-sm text-gray-700">
                    {new Date(
                      templateData.period_start
                    ).toLocaleDateString("ko-KR")}{" "}
                    ~{" "}
                    {new Date(
                      templateData.period_end
                    ).toLocaleDateString("ko-KR")}
                  </p>
                </div>
              )}

              {/* 스케줄러 유형 */}
              {templateData?.scheduler_type && (
                <div className="flex flex-col gap-1">
                  <label className="text-sm font-medium text-gray-700">
                    스케줄러 유형
                  </label>
                  <p className="text-sm text-gray-700">
                    {schedulerTypeLabels[
                      templateData.scheduler_type
                    ] || templateData.scheduler_type}
                  </p>
                </div>
              )}

              {/* 플랜 목적 */}
              {templateData?.plan_purpose && (
                <div className="flex flex-col gap-1">
                  <label className="text-sm font-medium text-gray-700">
                    플랜 목적
                  </label>
                  <p className="text-sm text-gray-700">
                    {planPurposeLabels[
                      templateData.plan_purpose
                    ] || templateData.plan_purpose}
                  </p>
                </div>
              )}

              {/* 학습일/복습일 주기 */}
              {templateData?.study_review_cycle && (
                <div className="flex flex-col gap-1">
                  <label className="text-sm font-medium text-gray-700">
                    학습일/복습일 주기
                  </label>
                  <p className="text-sm text-gray-700">
                    학습일{" "}
                    {templateData.study_review_cycle.study_days || 0}
                    일 / 복습일{" "}
                    {templateData.study_review_cycle.review_days || 0}
                    일
                  </p>
                </div>
              )}

              {/* 목표 날짜 */}
              {templateData?.target_date && (
                <div className="flex flex-col gap-1">
                  <label className="text-sm font-medium text-gray-700">
                    목표 날짜
                  </label>
                  <p className="text-sm text-gray-700">
                    {new Date(
                      templateData.target_date
                    ).toLocaleDateString("ko-KR")}
                  </p>
                </div>
              )}

              {/* 학생 입력 허용 필드 */}
              {templateData?.templateLockedFields?.step1 && (
                <div className="flex flex-col gap-2 md:col-span-2">
                  <label className="text-sm font-medium text-gray-700">
                    학생 입력 허용 필드
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {templateData.templateLockedFields.step1
                      .allow_student_name && (
                      <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                        이름
                      </span>
                    )}
                    {templateData.templateLockedFields.step1
                      .allow_student_plan_purpose && (
                      <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                        플랜 목적
                      </span>
                    )}
                    {templateData.templateLockedFields.step1
                      .allow_student_scheduler_type && (
                      <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                        스케줄러 유형
                      </span>
                    )}
                    {templateData.templateLockedFields.step1
                      .allow_student_period && (
                      <span className="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-800">
                        학습 기간
                      </span>
                    )}
                    {!(
                      templateData.templateLockedFields.step1
                        .allow_student_name ||
                      templateData.templateLockedFields.step1
                        .allow_student_plan_purpose ||
                      templateData.templateLockedFields.step1
                        .allow_student_scheduler_type ||
                      templateData.templateLockedFields.step1
                        .allow_student_period
                    ) && (
                      <span className="text-xs text-gray-700">
                        학생 입력 허용 필드 없음
                      </span>
                    )}
                  </div>
                </div>
              )}

              {/* 블록 세트 정보 */}
              {templateBlockSet && (
                <div className="flex flex-col gap-2 md:col-span-2">
                  <label className="text-sm font-medium text-gray-700">
                    블록 세트
                  </label>
                  <div className="flex flex-col gap-3">
                    <div>
                      <p className="text-sm font-semibold text-gray-900">
                        {templateBlockSet.name}
                      </p>
                    </div>
                    {templateBlockSet.blocks.length > 0 ? (
                      <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                        {templateBlockSet.blocks.map((block) => (
                          <div
                            key={block.id}
                            className="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"
                          >
                            <div className="text-sm font-medium text-gray-900">
                              {weekdayLabels[block.day_of_week]}
                            </div>
                            <div className="text-xs text-gray-700">
                              {block.start_time} ~ {block.end_time}
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-sm text-gray-700">
                        등록된 시간 블록이 없습니다.
                      </p>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* 발송된 초대 목록 */}
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold text-gray-900">발송된 초대</h2>
            <Link
              href={`/admin/camp-templates/${template.id}/participants`}
              className="text-sm font-medium text-indigo-600 hover:text-indigo-800"
            >
              참여자 관리 →
            </Link>
          </div>
          <CampInvitationList
            invitations={invitations}
            loading={loadingInvitations}
            templateId={template.id}
            onRefresh={handleInvitationSent}
          />
        </div>

        {/* 학생 초대 */}
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <h2 className="text-lg font-semibold text-gray-900">
            학생 초대
          </h2>
          <StudentInvitationForm
            templateId={template.id}
            templateStatus={template.status}
            onInvitationSent={handleInvitationSent}
          />
        </div>
      </div>

      {/* 삭제 확인 다이얼로그 */}
      <Dialog
        open={showDeleteDialog}
        onOpenChange={setShowDeleteDialog}
        title="템플릿 삭제 확인"
        description={`정말로 "${template.name}" 템플릿을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`}
        variant="destructive"
        maxWidth="md"
      >
        <div className="py-4">
          <p className="text-sm text-gray-700">
            이 템플릿을 삭제하면 관련된 모든 데이터가 함께 삭제됩니다. 삭제된
            템플릿은 복구할 수 없습니다.
          </p>
          {invitations.length > 0 && (
            <div className="rounded-lg bg-yellow-50 p-3">
              <p className="text-sm font-medium text-yellow-800">
                ⚠️ 이 템플릿에 {invitations.length}개의 초대가 연결되어
                있습니다.
              </p>
            </div>
          )}
        </div>
        <DialogFooter>
          <button
            onClick={() => setShowDeleteDialog(false)}
            disabled={isDeleting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
          <button
            onClick={handleDelete}
            disabled={isDeleting}
            className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
          >
            {isDeleting ? "삭제 중..." : "삭제"}
          </button>
        </DialogFooter>
      </Dialog>
    </section>
  );
}
</file>

<file path="admin/camp-templates/[id]/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getCampTemplateById } from "@/app/(admin)/actions/campTemplateActions";
import { CampTemplateDetail } from "./CampTemplateDetail";
import { getTemplateBlockSet } from "@/app/(admin)/actions/campTemplateBlockSets";

export default async function CampTemplateDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { id } = await params;
  const result = await getCampTemplateById(id);

  if (!result.success || !result.template) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">템플릿을 찾을 수 없습니다.</p>
        </div>
      </section>
    );
  }

  // 템플릿 블록 세트 정보 조회 (camp_template_block_sets 테이블을 통해 조회)
  const templateBlockSet = await getTemplateBlockSet(id);

  return (
    <CampTemplateDetail
      template={result.template}
      templateBlockSet={templateBlockSet}
    />
  );
}
</file>

<file path="admin/camp-templates/[id]/StudentInvitationForm.tsx">
"use client";

import { useState, useTransition, useEffect, useCallback } from "react";
import { createSupabaseBrowserClient } from "@/lib/supabase/client";
import { sendCampInvitationsAction } from "@/app/(admin)/actions/campTemplateActions";
import { useToast } from "@/components/ui/ToastProvider";

type StudentInvitationFormProps = {
  templateId: string;
  templateStatus?: "draft" | "active" | "archived";
  onInvitationSent?: () => void;
};

type Student = {
  id: string;
  name: string;
  grade: string;
  class: string;
};

export function StudentInvitationForm({ templateId, templateStatus, onInvitationSent }: StudentInvitationFormProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();
  const [students, setStudents] = useState<Student[]>([]);
  const [selectedStudentIds, setSelectedStudentIds] = useState<Set<string>>(new Set());
  const [searchQuery, setSearchQuery] = useState("");
  const [loading, setLoading] = useState(true);

  // 학생 목록 로드 (useCallback으로 메모이제이션)
  const loadStudents = useCallback(async () => {
    try {
      const supabase = createSupabaseBrowserClient();
      
      // 1. 모든 학생 목록 조회
      const { data: allStudents, error: studentsError } = await supabase
        .from("students")
        .select("id, name, grade, class")
        .order("name", { ascending: true })
        .limit(100);

      if (studentsError) {
        console.error("학생 목록 조회 실패:", studentsError);
        toast.showError("학생 목록을 불러오는데 실패했습니다.");
        return;
      }

      // 2. 이미 초대된 학생 ID 조회
      const { data: invitations, error: invitationsError } = await supabase
        .from("camp_invitations")
        .select("student_id")
        .eq("camp_template_id", templateId);

      if (invitationsError) {
        console.error("초대 목록 조회 실패:", invitationsError);
        // 초대 목록 조회 실패해도 학생 목록은 표시
      }

      // 3. 이미 초대된 학생 ID Set 생성
      const invitedStudentIds = new Set(
        (invitations || []).map((inv) => inv.student_id)
      );

      // 4. 이미 초대되지 않은 학생만 필터링
      const availableStudents = (allStudents || []).filter(
        (student) => !invitedStudentIds.has(student.id)
      );

      setStudents(availableStudents);
    } catch (error) {
      console.error("학생 목록 로드 실패:", error);
      toast.showError("학생 목록을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }, [templateId, toast]);

  // 초기 로드
  useEffect(() => {
    loadStudents();
  }, [loadStudents]);

  // 검색 필터링
  const filteredStudents = students.filter((student) =>
    student.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const handleToggleStudent = (studentId: string) => {
    setSelectedStudentIds((prev) => {
      const next = new Set(prev);
      if (next.has(studentId)) {
        next.delete(studentId);
      } else {
        next.add(studentId);
      }
      return next;
    });
  };

  const handleSelectAll = () => {
    if (selectedStudentIds.size === filteredStudents.length) {
      setSelectedStudentIds(new Set());
    } else {
      setSelectedStudentIds(new Set(filteredStudents.map((s) => s.id)));
    }
  };

  const handleSendInvitations = () => {
    // 활성 상태가 아니면 초대 발송 불가
    if (templateStatus !== "active") {
      const statusMessage = 
        templateStatus === "archived" 
          ? "보관된 템플릿에는 초대를 발송할 수 없습니다."
          : templateStatus === "draft"
          ? "초안 상태의 템플릿에는 초대를 발송할 수 없습니다. 템플릿을 활성화한 후 초대를 발송해주세요."
          : "활성 상태의 템플릿만 초대를 발송할 수 있습니다.";
      toast.showError(statusMessage);
      return;
    }
    
    if (selectedStudentIds.size === 0) {
      toast.showError("최소 1명 이상의 학생을 선택해주세요.");
      return;
    }

    // 선택된 학생 ID를 미리 저장 (비동기 처리 중 값이 변경될 수 있음)
    const sentStudentIds = Array.from(selectedStudentIds);

    startTransition(async () => {
      try {
        const result = await sendCampInvitationsAction(
          templateId,
          sentStudentIds
        );

        if (result.success) {
          toast.showSuccess(
            `${result.count || sentStudentIds.length}명의 학생에게 초대를 발송했습니다.`
          );
          
          // 선택 초기화
          setSelectedStudentIds(new Set());
          
          // 초대된 학생을 목록에서 즉시 제거 (UI 반응성 향상, 추가 로딩 없음)
          setStudents((prevStudents) =>
            prevStudents.filter((student) => !sentStudentIds.includes(student.id))
          );
          
          // 상위 컴포넌트에 알림 (초대 목록 새로고침은 상위 컴포넌트에서 처리)
          onInvitationSent?.();
        } else {
          toast.showError(result.error || "초대 발송에 실패했습니다.");
        }
      } catch (error) {
        console.error("초대 발송 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "초대 발송에 실패했습니다."
        );
      }
    });
  };

  const isActive = templateStatus === "active";
  const isDisabled = !isActive;

  if (loading) {
    return <div className="text-sm text-gray-700">학생 목록을 불러오는 중...</div>;
  }

  return (
    <div className="flex flex-col gap-4">
      {/* 활성 상태가 아닐 때 안내 메시지 */}
      {!isActive && (
        <div className="rounded-lg border border-amber-200 bg-amber-50 p-4">
          <p className="text-sm font-medium text-amber-800">
            {templateStatus === "draft" 
              ? "⚠️ 초안 상태의 템플릿입니다. 템플릿을 활성화한 후 초대를 발송할 수 있습니다."
              : templateStatus === "archived"
              ? "⚠️ 보관된 템플릿입니다. 활성화된 템플릿만 초대를 발송할 수 있습니다."
              : "⚠️ 활성 상태의 템플릿만 초대를 발송할 수 있습니다."}
          </p>
        </div>
      )}

      {/* 검색 및 선택 */}
      <div className="flex flex-col gap-3">
        <div className="flex items-center gap-3">
          <input
            type="text"
            placeholder="학생명 검색..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            disabled={isDisabled}
            className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-500"
          />
          <button
            type="button"
            onClick={handleSelectAll}
            disabled={isDisabled}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-500"
          >
            {selectedStudentIds.size === filteredStudents.length ? "전체 해제" : "전체 선택"}
          </button>
        </div>

        {/* 선택된 학생 수 */}
        {selectedStudentIds.size > 0 && (
          <div className="text-sm text-gray-800">
            {selectedStudentIds.size}명 선택됨
          </div>
        )}
      </div>

      {/* 학생 목록 */}
      <div className="max-h-96 overflow-y-auto rounded-lg border border-gray-200">
        {filteredStudents.length === 0 ? (
          <div className="p-8 text-center text-sm text-gray-700">
            {searchQuery ? "검색 결과가 없습니다." : "학생이 없습니다."}
          </div>
        ) : (
          <div className="divide-y divide-gray-200">
            {filteredStudents.map((student) => (
              <label
                key={student.id}
                className="flex cursor-pointer items-center gap-3 p-3 hover:bg-gray-50"
              >
                <input
                  type="checkbox"
                  checked={selectedStudentIds.has(student.id)}
                  onChange={() => handleToggleStudent(student.id)}
                  disabled={isDisabled}
                  className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-50"
                />
                <div className="flex-1">
                  <div className="text-sm font-medium text-gray-900">{student.name}</div>
                  <div className="text-xs text-gray-700">
                    {student.grade}학년 {student.class}반
                  </div>
                </div>
              </label>
            ))}
          </div>
        )}
      </div>

      {/* 발송 버튼 */}
      <div className="flex justify-end">
        <button
          type="button"
          onClick={handleSendInvitations}
          disabled={isPending || selectedStudentIds.size === 0 || isDisabled}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
        >
          {isPending ? "발송 중..." : `초대 발송 (${selectedStudentIds.size}명)`}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="admin/camp-templates/new/CampTemplateForm.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { createCampTemplateAction } from "@/app/(admin)/actions/campTemplateActions";
import { PlanGroupWizard, WizardData } from "@/app/(student)/plan/new-group/_components/PlanGroupWizard";
import { BlockSetWithBlocks } from "@/lib/data/blockSets";
import { CampProgramType } from "@/lib/types/plan";
import { TemplateFormChecklist } from "../_components/TemplateFormChecklist";
import { useToast } from "@/components/ui/ToastProvider";

type CampTemplateFormProps = {
  initialBlockSets: BlockSetWithBlocks[];
};

const programTypes: Array<{ value: CampProgramType; label: string }> = [
  { value: "윈터캠프", label: "윈터캠프" },
  { value: "썸머캠프", label: "썸머캠프" },
  { value: "파이널캠프", label: "파이널캠프" },
  { value: "기타", label: "기타" },
];

const statuses: Array<{ value: "draft" | "active" | "archived"; label: string }> = [
  { value: "draft", label: "초안" },
  { value: "active", label: "활성" },
  { value: "archived", label: "보관" },
];

export function CampTemplateForm({ initialBlockSets }: CampTemplateFormProps) {
  const router = useRouter();
  const toast = useToast();
  const [programType, setProgramType] = useState<CampProgramType>("기타");
  const [description, setDescription] = useState("");
  const [templateName, setTemplateName] = useState("");
  const [campStartDate, setCampStartDate] = useState("");
  const [campEndDate, setCampEndDate] = useState("");
  const [campLocation, setCampLocation] = useState("");

  const handleTemplateSave = async (wizardData: WizardData) => {
    // 디버깅: wizardData 확인
    console.log("[CampTemplateForm] handleTemplateSave 호출:", {
      has_block_set_id: !!wizardData.block_set_id,
      block_set_id: wizardData.block_set_id,
      wizardDataKeys: Object.keys(wizardData),
    });

    const finalWizardData: WizardData = {
      ...wizardData,
      name: templateName || wizardData.name, // templateName을 우선 사용
    };

    // 디버깅: finalWizardData 확인
    console.log("[CampTemplateForm] finalWizardData:", {
      has_block_set_id: !!finalWizardData.block_set_id,
      block_set_id: finalWizardData.block_set_id,
      template_data_string: JSON.stringify(finalWizardData).substring(0, 200),
    });

    const formData = new FormData();
    formData.append("name", templateName || finalWizardData.name); // templateName을 명시적으로 사용
    formData.append("program_type", programType);
    formData.append("description", description);
    formData.append("status", "draft"); // 템플릿 생성 시 기본값은 draft
    formData.append("template_data", JSON.stringify(finalWizardData));
    
    // 디버깅: FormData 확인
    const templateDataFromForm = formData.get("template_data");
    if (templateDataFromForm) {
      try {
        const parsed = JSON.parse(templateDataFromForm as string);
        console.log("[CampTemplateForm] FormData의 template_data:", {
          has_block_set_id: !!parsed.block_set_id,
          block_set_id: parsed.block_set_id,
        });
      } catch (e) {
        console.error("[CampTemplateForm] FormData 파싱 에러:", e);
      }
    }
    if (campStartDate) {
      formData.append("camp_start_date", campStartDate);
    }
    if (campEndDate) {
      formData.append("camp_end_date", campEndDate);
    }
    if (campLocation) {
      formData.append("camp_location", campLocation);
    }

    const result = await createCampTemplateAction(formData);
    if (!result.success) {
      throw new Error(result.error || "템플릿 저장에 실패했습니다.");
    }

    // 템플릿 저장 성공 후 템플릿 상세 페이지로 리다이렉트
    if (result.templateId) {
      toast.showSuccess("템플릿이 성공적으로 생성되었습니다.");
      router.push(`/admin/camp-templates/${result.templateId}`);
    }
  };


  return (
    <div className="flex flex-col gap-6">
      {/* 기본 정보 체크리스트 */}
      <TemplateFormChecklist name={templateName} programType={programType} />

      {/* 템플릿 메타 정보 입력 섹션 */}
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="mb-4 text-lg font-semibold text-gray-900">템플릿 기본 정보</h2>
        <div className="grid gap-4 md:grid-cols-2">
          {/* 템플릿 이름 */}
          <div className="md:col-span-2">
            <label htmlFor="template_name" className="mb-2 block text-sm font-medium text-gray-700">
              템플릿 이름 <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="template_name"
              value={templateName}
              onChange={(e) => {
                setTemplateName(e.target.value);
              }}
              placeholder="템플릿 이름을 입력하세요"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
              required
            />
          </div>

          {/* 프로그램 유형 */}
          <div>
            <label htmlFor="program_type" className="mb-2 block text-sm font-medium text-gray-700">
              프로그램 유형 <span className="text-red-500">*</span>
            </label>
            <select
              id="program_type"
              value={programType}
              onChange={(e) => setProgramType(e.target.value as CampProgramType)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
              required
            >
              {programTypes.map((type) => (
                <option key={type.value} value={type.value}>
                  {type.label}
                </option>
              ))}
            </select>
          </div>


          {/* 설명 */}
          <div className="md:col-span-2">
            <label htmlFor="description" className="mb-2 block text-sm font-medium text-gray-700">
              설명
            </label>
            <textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="템플릿에 대한 설명을 입력하세요. (선택사항)"
              rows={3}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
            />
          </div>

          {/* 캠프 기간 */}
          <div>
            <label htmlFor="camp_start_date" className="mb-2 block text-sm font-medium text-gray-700">
              캠프 시작일
            </label>
            <input
              type="date"
              id="camp_start_date"
              value={campStartDate}
              onChange={(e) => setCampStartDate(e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
            />
          </div>

          <div>
            <label htmlFor="camp_end_date" className="mb-2 block text-sm font-medium text-gray-700">
              캠프 종료일
            </label>
            <input
              type="date"
              id="camp_end_date"
              value={campEndDate}
              onChange={(e) => setCampEndDate(e.target.value)}
              min={campStartDate || undefined}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
            />
          </div>

          {/* 캠프 장소 */}
          <div className="md:col-span-2">
            <label htmlFor="camp_location" className="mb-2 block text-sm font-medium text-gray-700">
              캠프 장소
            </label>
            <input
              type="text"
              id="camp_location"
              value={campLocation}
              onChange={(e) => setCampLocation(e.target.value)}
              placeholder="캠프 장소를 입력하세요. (선택사항)"
              maxLength={200}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none"
            />
          </div>
        </div>
      </div>

      {/* 플랜 그룹 위저드 */}
      <PlanGroupWizard
        initialBlockSets={initialBlockSets}
        initialContents={{ books: [], lectures: [], custom: [] }}
        initialData={{
          name: templateName,
        }}
        isTemplateMode={true}
        onTemplateSave={handleTemplateSave}
      />
    </div>
  );
}
</file>

<file path="admin/camp-templates/new/NewCampTemplateForm.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { createCampTemplateDraftAction } from "@/app/(admin)/actions/campTemplateActions";
import { CampProgramType } from "@/lib/types/plan";
import { useToast } from "@/components/ui/ToastProvider";

const programTypes: Array<{ value: CampProgramType; label: string }> = [
  { value: "윈터캠프", label: "윈터캠프" },
  { value: "썸머캠프", label: "썸머캠프" },
  { value: "파이널캠프", label: "파이널캠프" },
  { value: "기타", label: "기타" },
];

export function NewCampTemplateForm() {
  const router = useRouter();
  const toast = useToast();
  const [templateName, setTemplateName] = useState("");
  const [programType, setProgramType] = useState<CampProgramType>("기타");
  const [description, setDescription] = useState("");
  const [campStartDate, setCampStartDate] = useState("");
  const [campEndDate, setCampEndDate] = useState("");
  const [campLocation, setCampLocation] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!templateName.trim()) {
      toast.showError("템플릿 이름을 입력해주세요.");
      return;
    }

    if (!programType) {
      toast.showError("프로그램 유형을 선택해주세요.");
      return;
    }

    // 날짜 검증: 종료일이 시작일보다 이후인지 확인
    if (campStartDate && campEndDate && campEndDate < campStartDate) {
      toast.showError("캠프 종료일은 시작일보다 이후여야 합니다.");
      return;
    }

    setIsSubmitting(true);

    try {
      const formData = new FormData();
      formData.append("name", templateName.trim());
      formData.append("program_type", programType);
      if (description.trim()) {
        formData.append("description", description.trim());
      }
      if (campStartDate) {
        formData.append("camp_start_date", campStartDate);
      }
      if (campEndDate) {
        formData.append("camp_end_date", campEndDate);
      }
      if (campLocation.trim()) {
        formData.append("camp_location", campLocation.trim());
      }

      const result = await createCampTemplateDraftAction(formData);

      if (!result.success) {
        throw new Error(result.error || "템플릿 생성에 실패했습니다.");
      }

      if (result.templateId) {
        toast.showSuccess("템플릿이 생성되었습니다. 이제 상세 정보를 입력하세요.");
        router.push(`/admin/camp-templates/${result.templateId}/edit`);
      }
    } catch (error) {
      console.error("[NewCampTemplateForm] 템플릿 생성 실패:", error);
      toast.showError(
        error instanceof Error
          ? error.message
          : "템플릿 생성에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <form onSubmit={handleSubmit} className="flex flex-col gap-6">
        <h2 className="text-lg font-semibold text-gray-900">템플릿 기본 정보</h2>
        <div className="grid gap-4 md:grid-cols-2">
          {/* 템플릿 이름 */}
          <div className="flex flex-col gap-2 md:col-span-2">
            <label
              htmlFor="template_name"
              className="block text-sm font-medium text-gray-700"
            >
              템플릿 이름 <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="template_name"
              value={templateName}
              onChange={(e) => setTemplateName(e.target.value)}
              placeholder="템플릿 이름을 입력하세요"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
              required
              disabled={isSubmitting}
            />
          </div>

          {/* 프로그램 유형 */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="program_type"
              className="block text-sm font-medium text-gray-700"
            >
              프로그램 유형 <span className="text-red-500">*</span>
            </label>
            <select
              id="program_type"
              value={programType}
              onChange={(e) => setProgramType(e.target.value as CampProgramType)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
              required
              disabled={isSubmitting}
            >
              {programTypes.map((type) => (
                <option key={type.value} value={type.value}>
                  {type.label}
                </option>
              ))}
            </select>
          </div>

          {/* 설명 */}
          <div className="flex flex-col gap-2 md:col-span-2">
            <label
              htmlFor="description"
              className="block text-sm font-medium text-gray-700"
            >
              설명
            </label>
            <textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="템플릿에 대한 설명을 입력하세요. (선택사항)"
              rows={3}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
              disabled={isSubmitting}
            />
          </div>

          {/* 캠프 기간 */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="camp_start_date"
              className="block text-sm font-medium text-gray-700"
            >
              캠프 시작일
            </label>
            <input
              type="date"
              id="camp_start_date"
              value={campStartDate}
              onChange={(e) => setCampStartDate(e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
              disabled={isSubmitting}
            />
          </div>

          <div className="flex flex-col gap-2">
            <label
              htmlFor="camp_end_date"
              className="block text-sm font-medium text-gray-700"
            >
              캠프 종료일
            </label>
            <input
              type="date"
              id="camp_end_date"
              value={campEndDate}
              onChange={(e) => setCampEndDate(e.target.value)}
              min={campStartDate || undefined}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-gray-900 focus:outline-none"
              disabled={isSubmitting}
            />
          </div>

          {/* 캠프 장소 */}
          <div className="flex flex-col gap-2 md:col-span-2">
            <label
              htmlFor="camp_location"
              className="block text-sm font-medium text-gray-700"
            >
              캠프 장소
            </label>
            <input
              type="text"
              id="camp_location"
              value={campLocation}
              onChange={(e) => setCampLocation(e.target.value)}
              placeholder="캠프 장소를 입력하세요. (선택사항)"
              maxLength={200}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-600 focus:border-gray-900 focus:outline-none"
              disabled={isSubmitting}
            />
          </div>
        </div>

        {/* 안내 메시지 */}
        <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
          <p className="text-sm text-blue-800">
            템플릿 생성 후 상세 정보(블록 세트, 학습 기간, 콘텐츠 등)를 입력할 수 있습니다.
          </p>
        </div>

        {/* 제출 버튼 */}
        <div className="flex justify-end gap-3">
          <button
            type="button"
            onClick={() => router.back()}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
            disabled={isSubmitting}
          >
            취소
          </button>
          <button
            type="submit"
            className="rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50"
            disabled={isSubmitting}
          >
            {isSubmitting ? "생성 중..." : "템플릿 생성 시작"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="admin/camp-templates/new/page.tsx">
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { NewCampTemplateForm } from "./NewCampTemplateForm";

export default async function NewCampTemplatePage() {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  return (
    <section className="mx-auto w-full max-w-4xl px-4 py-10">
      <div className="flex flex-col gap-6">
        <div>
          <h1 className="text-3xl font-semibold text-gray-900">캠프 템플릿 생성</h1>
          <p className="text-sm text-gray-700">
            템플릿 기본 정보를 입력하고 템플릿 생성을 시작하세요.
          </p>
        </div>

        <NewCampTemplateForm />
      </div>
    </section>
  );
}
</file>

<file path="admin/camp-templates/page.tsx">
import Link from "next/link";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { redirect } from "next/navigation";
import { getCampTemplatesForTenant } from "@/lib/data/campTemplates";
import { TemplateCard } from "./_components/TemplateCard";

export default async function CampTemplatesPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">기관 정보를 찾을 수 없습니다.</p>
        </div>
      </section>
    );
  }

  const params = await searchParams;
  const searchQuery = params.search || "";
  const statusFilter = params.status || "";
  const programTypeFilter = params.program_type || "";

  let templates: Awaited<ReturnType<typeof getCampTemplatesForTenant>> = [];
  try {
    templates = await getCampTemplatesForTenant(tenantContext.tenantId);
  } catch (error) {
    console.error("[CampTemplatesPage] 템플릿 목록 조회 실패", error);
    // 에러 발생 시 빈 배열로 처리
    templates = [];
  }

  // 필터링
  let filteredTemplates = templates;
  if (searchQuery.trim()) {
    filteredTemplates = filteredTemplates.filter(
      (t) =>
        t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        (t.description &&
          t.description.toLowerCase().includes(searchQuery.toLowerCase()))
    );
  }
  if (statusFilter) {
    filteredTemplates = filteredTemplates.filter(
      (t) => t.status === statusFilter
    );
  }
  if (programTypeFilter) {
    filteredTemplates = filteredTemplates.filter(
      (t) => t.program_type === programTypeFilter
    );
  }

  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p className="text-sm font-medium text-gray-500">캠프 관리</p>
            <h1 className="text-3xl font-semibold text-gray-900">
              캠프 템플릿
            </h1>
            <p className="text-sm text-gray-500">
              캠프 프로그램 템플릿을 생성하고 관리하세요.
            </p>
          </div>
          <Link
            href="/admin/camp-templates/new"
            className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            + 템플릿 생성
          </Link>
        </div>

        {/* 검색 필터 */}
        <div className="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
          <form
            action="/admin/camp-templates"
            method="get"
            className="flex flex-wrap items-end gap-4"
          >
            {/* 프로그램 유형 필터 */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                프로그램 유형
              </label>
              <select
                name="program_type"
                defaultValue={programTypeFilter || ""}
                className="rounded-md border border-gray-300 px-3 py-2 text-sm"
              >
                <option value="">전체</option>
                <option value="윈터캠프">윈터캠프</option>
                <option value="썸머캠프">썸머캠프</option>
                <option value="파이널캠프">파이널캠프</option>
                <option value="기타">기타</option>
              </select>
            </div>

            {/* 상태 필터 */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">상태</label>
              <select
                name="status"
                defaultValue={statusFilter || ""}
                className="rounded-md border border-gray-300 px-3 py-2 text-sm"
              >
                <option value="">전체</option>
                <option value="draft">초안</option>
                <option value="active">활성</option>
                <option value="archived">보관</option>
              </select>
            </div>

            {/* 검색어 */}
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">검색</label>
              <input
                type="text"
                name="search"
                defaultValue={searchQuery || ""}
                placeholder="템플릿명 또는 설명 검색"
                className="rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>

            {/* 검색 버튼 */}
            <button
              type="submit"
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
            >
              검색
            </button>

            {/* 초기화 버튼 */}
            <Link
              href="/admin/camp-templates"
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </Link>
          </form>
        </div>

        {/* 결과 개수 */}
        <div className="text-sm text-gray-600">
          총 <span className="font-semibold">{filteredTemplates.length}</span>
          개의 템플릿이 검색되었습니다.
        </div>

        {/* 템플릿 목록 */}
        <div>
          {filteredTemplates.length === 0 ? (
            <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
              <div className="mx-auto flex max-w-md flex-col gap-6">
                <div className="text-6xl">🏕️</div>
                <div className="flex flex-col gap-2">
                  <h3 className="text-lg font-semibold text-gray-900">
                    템플릿이 없습니다
                  </h3>
                  <p className="text-sm text-gray-500">
                    새로운 캠프 템플릿을 생성해보세요.
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <div className="flex flex-col gap-4">
              {filteredTemplates.map((template) => (
                <TemplateCard key={template.id} template={template} />
              ))}
            </div>
          )}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="admin/compare/_components/ComparePageClient.tsx">
"use client";

import { useState } from "react";
import Link from "next/link";
import {
  useRecharts,
  ChartLoadingSkeleton,
} from "@/components/charts/LazyRecharts";
import { getChartColor } from "@/lib/constants/colors";

type Student = {
  id: string;
  name: string;
  grade: string | null;
  studyTimeMinutes: number;
  planCompletionRate: number;
};

type ComparePageClientProps = {
  students: Student[];
};

export function ComparePageClient({ students }: ComparePageClientProps) {
  const { recharts, loading } = useRecharts();
  const [selectedStudents, setSelectedStudents] = useState<string[]>([]);

  const toggleStudent = (studentId: string) => {
    setSelectedStudents((prev) =>
      prev.includes(studentId)
        ? prev.filter((id) => id !== studentId)
        : [...prev, studentId]
    );
  };

  const selectedData = students.filter((s) => selectedStudents.includes(s.id));

  const chartData = selectedData.map((student) => ({
    name: student.name,
    학습시간: student.studyTimeMinutes,
    플랜실행률: student.planCompletionRate,
  }));

  return (
    <div className="p-6 md:p-10">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-gray-100">학생 비교 분석</h1>
        <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
          여러 학생의 학습 데이터를 비교하여 분석할 수 있습니다.
        </p>
      </div>

      {/* 학생 선택 */}
      <div className="mb-8 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
        <h2 className="mb-4 text-xl font-semibold text-gray-900 dark:text-gray-100">학생 선택</h2>
        {students.length === 0 ? (
          <p className="text-sm text-gray-500 dark:text-gray-400">비교할 학생이 없습니다.</p>
        ) : (
          <div className="flex flex-wrap gap-3">
            {students.map((student) => (
              <button
                key={student.id}
                onClick={() => toggleStudent(student.id)}
                className={`rounded-lg border px-4 py-2 text-sm font-medium transition ${
                  selectedStudents.includes(student.id)
                    ? "border-indigo-600 dark:border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300"
                    : "border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700"
                }`}
              >
                {student.name}
                {student.grade && ` (${student.grade}학년)`}
              </button>
            ))}
          </div>
        )}
        {selectedStudents.length > 0 && (
          <div className="mt-4">
            <button
              onClick={() => setSelectedStudents([])}
              className="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
            >
              전체 해제
            </button>
          </div>
        )}
      </div>

      {/* 비교 차트 */}
      {selectedData.length > 0 ? (
        <div className="space-y-6">
          {loading || !recharts ? (
            <>
              <ChartLoadingSkeleton height={300} />
              <ChartLoadingSkeleton height={300} />
            </>
          ) : (
            <>
              {(() => {
                const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = recharts;
                return (
                  <>
                    {/* 학습시간 비교 */}
                    <div className="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                      <h2 className="mb-4 text-xl font-semibold text-gray-900 dark:text-gray-100">이번주 학습시간 비교</h2>
                      <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={chartData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="name" />
                          <YAxis />
                          <Tooltip />
                          <Legend />
                          <Bar dataKey="학습시간" fill={getChartColor(0)} />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>

                    {/* 플랜 실행률 비교 */}
                    <div className="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
                      <h2 className="mb-4 text-xl font-semibold text-gray-900 dark:text-gray-100">이번주 플랜 실행률 비교</h2>
                      <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={chartData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="name" />
                          <YAxis />
                          <Tooltip />
                          <Legend />
                          <Bar dataKey="플랜실행률" fill={getChartColor(4)} />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </>
                );
              })()}
            </>
          )}

          {/* 비교 테이블 */}
          <div className="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6 shadow-sm">
            <h2 className="mb-4 text-xl font-semibold text-gray-900 dark:text-gray-100">상세 비교</h2>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 dark:bg-gray-900">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                      이름
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                      학습시간 (분)
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                      플랜 실행률 (%)
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                      작업
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                  {selectedData.map((student) => (
                    <tr key={student.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td className="whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                        {student.name}
                      </td>
                      <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
                        {student.studyTimeMinutes}분
                      </td>
                      <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
                        {student.planCompletionRate}%
                      </td>
                      <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
                        <Link
                          href={`/admin/students/${student.id}`}
                          className="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300"
                        >
                          상세 보기
                        </Link>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      ) : (
        <div className="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-12 text-center">
          <p className="text-gray-500 dark:text-gray-400">비교할 학생을 선택해주세요.</p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/compare/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ComparePageClient } from "./_components/ComparePageClient";
import { getWeekRange } from "@/lib/date/weekRange";

type StudentRow = {
  id: string;
  name?: string | null;
  grade?: string | null;
};

// 이번주 학습시간 조회
async function getStudentWeeklyStudyTime(
  supabase: Awaited<ReturnType<typeof createSupabaseServerClient>>,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<number> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const { data: sessions, error } = await supabase
      .from("student_study_sessions")
      .select("duration_seconds")
      .eq("student_id", studentId)
      .gte("started_at", weekStartStr)
      .lte("started_at", weekEndStr);

    if (error && error.code === "42703") {
      return 0;
    }

    if (error) throw error;

    const totalSeconds = (sessions ?? []).reduce(
      (sum: number, s: { duration_seconds?: number | null }) =>
        sum + (s.duration_seconds ?? 0),
      0
    );

    return Math.floor(totalSeconds / 60);
  } catch (error) {
    console.error(`[compare] 학생 ${studentId} 학습시간 조회 실패`, error);
    return 0;
  }
}

// 이번주 플랜 실행률 조회
async function getStudentWeeklyPlanCompletion(
  supabase: Awaited<ReturnType<typeof createSupabaseServerClient>>,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<number> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const { data: plans, error } = await supabase
      .from("student_plan")
      .select("completed_amount")
      .eq("student_id", studentId)
      .gte("plan_date", weekStartStr)
      .lte("plan_date", weekEndStr);

    if (error && error.code === "42703") {
      return 0;
    }

    if (error) throw error;

    const planRows = plans ?? [];
    if (planRows.length === 0) return 0;

    const completed = planRows.filter(
      (p: { completed_amount?: number | null }) =>
        p.completed_amount !== null && p.completed_amount !== undefined && p.completed_amount > 0
    ).length;

    return Math.round((completed / planRows.length) * 100);
  } catch (error) {
    console.error(`[compare] 학생 ${studentId} 플랜 실행률 조회 실패`, error);
    return 0;
  }
}

export default async function AdminComparePage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const { weekStart, weekEnd } = getWeekRange();

  // 학생 목록 조회
  const { data: students, error } = await supabase
    .from("students")
    .select("id,name,grade")
    .order("name", { ascending: true })
    .limit(50);

  if (error) {
    console.error("[compare] 학생 목록 조회 실패", error);
  }

  const studentRows = (students as StudentRow[] | null) ?? [];

  // 각 학생의 통계 조회
  const studentsWithStats = await Promise.allSettled(
    studentRows.map(async (student) => {
      const [studyTimeResult, planCompletionResult] = await Promise.allSettled([
        getStudentWeeklyStudyTime(supabase, student.id, weekStart, weekEnd),
        getStudentWeeklyPlanCompletion(supabase, student.id, weekStart, weekEnd),
      ]);

      return {
        id: student.id,
        name: student.name ?? "이름 없음",
        grade: student.grade ?? null,
        studyTimeMinutes:
          studyTimeResult.status === "fulfilled" ? studyTimeResult.value : 0,
        planCompletionRate:
          planCompletionResult.status === "fulfilled" ? planCompletionResult.value : 0,
      };
    })
  );

  const validStudents = studentsWithStats
    .filter((r) => r.status === "fulfilled")
    .map((r) => (r.status === "fulfilled" ? r.value : null))
    .filter((v): v is NonNullable<typeof v> => v !== null);

  return <ComparePageClient students={validStudents} />;
}
</file>

<file path="admin/consulting/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import Link from "next/link";
import { EmptyState } from "@/components/ui/EmptyState";

type ConsultingNoteRow = {
  id: string;
  student_id?: string | null;
  consultant_id?: string | null;
  note?: string | null;
  created_at?: string | null;
};

type StudentRow = {
  id: string;
  name?: string | null;
};

export default async function AdminConsultingPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const params = await searchParams;
  const searchQuery = params.search?.trim() ?? "";
  const studentIdFilter = params.student_id?.trim() ?? "";

  // 상담노트 조회
  const selectNotes = () =>
    supabase
      .from("student_consulting_notes")
      .select("id,student_id,consultant_id,note,created_at")
      .order("created_at", { ascending: false });

  let query = selectNotes();

  // 본인이 작성한 노트만 조회 (admin은 모든 노트 조회 가능)
  if (role !== "admin") {
    query = query.eq("consultant_id", userId);
  }

  if (studentIdFilter) {
    query = query.eq("student_id", studentIdFilter);
  }

  let { data: notes, error } = await query.limit(100);

  if (error && error.code === "42703") {
    ({ data: notes, error } = await selectNotes().limit(100));
  }

  if (error) {
    console.error("[admin/consulting] 상담노트 조회 실패", error);
  }

  const noteRows = (notes as ConsultingNoteRow[] | null) ?? [];

  // 학생 정보 조회
  const studentIds = [...new Set(noteRows.map((n) => n.student_id).filter(Boolean))] as string[];
  const { data: students } = await supabase
    .from("students")
    .select("id,name")
    .in("id", studentIds.length > 0 ? studentIds : [""]);

  const studentMap = new Map(
    (students ?? []).map((s: StudentRow) => [s.id, s.name ?? "이름 없음"])
  );

  // 검색 필터링 (학생 이름으로)
  let filteredNotes = noteRows;
  if (searchQuery) {
    filteredNotes = noteRows.filter((note) => {
      const studentName = studentMap.get(note.student_id ?? "") ?? "";
      return studentName.includes(searchQuery) || (note.note ?? "").includes(searchQuery);
    });
  }

  return (
    <div className="p-6 md:p-10 flex flex-col gap-8">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold text-gray-900">상담 노트</h1>
      </div>

      {/* 검색 바 */}
      <div>
        <form method="get" className="flex flex-col gap-4 md:flex-row">
          <input
            type="text"
            name="search"
            placeholder="학생 이름 또는 상담 내용으로 검색..."
            defaultValue={searchQuery}
            className="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          />
          <button
            type="submit"
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            검색
          </button>
          {searchQuery && (
            <Link
              href="/admin/consulting"
              className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </Link>
          )}
        </form>
      </div>

      {/* 상담노트 목록 */}
      {filteredNotes.length === 0 ? (
        <EmptyState
          title="상담노트가 없습니다"
          description="아직 작성된 상담노트가 없습니다."
        />
      ) : (
        <div className="flex flex-col gap-4">
          {filteredNotes.map((note) => {
            const studentName = studentMap.get(note.student_id ?? "") ?? "이름 없음";
            return (
              <Link
                key={note.id}
                href={`/admin/students/${note.student_id}`}
                className="block rounded-lg border border-gray-200 bg-white p-6 shadow-sm transition hover:shadow-md flex flex-col gap-3"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="font-semibold text-gray-900">{studentName}</span>
                    <span className="text-xs text-gray-500">
                      {note.created_at
                        ? new Date(note.created_at).toLocaleString("ko-KR")
                        : "-"}
                    </span>
                  </div>
                </div>
                <p className="line-clamp-3 text-sm text-gray-700">{note.note ?? ""}</p>
              </Link>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/CareerFieldsManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getAllCareerFieldsAction,
  createCareerFieldAction,
  updateCareerFieldAction,
  deleteCareerFieldAction,
} from "@/app/(admin)/actions/careerFieldActions";
import type { CareerField } from "@/lib/data/careerFields";
import { Badge } from "@/components/atoms";

export function CareerFieldsManager() {
  const [items, setItems] = useState<CareerField[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [formData, setFormData] = useState({ name: "", display_order: 0 });

  useEffect(() => {
    loadItems();
  }, []);

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getAllCareerFieldsAction();
      setItems(data);
    } catch (error) {
      console.error("진로 계열 조회 실패:", error);
      alert("진로 계열을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await createCareerFieldAction(formData.name, formData.display_order);
      setFormData({ name: "", display_order: 0 });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("진로 계열 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await updateCareerFieldAction(id, {
        name: formData.name,
        display_order: formData.display_order,
      });
      setEditingId(null);
      setFormData({ name: "", display_order: 0 });
      loadItems();
    } catch (error) {
      console.error("진로 계열 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deleteCareerFieldAction(id);
      loadItems();
    } catch (error) {
      console.error("진로 계열 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: CareerField) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0 });
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0 });
  }

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">진로 계열 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            const maxOrder = items.length > 0
              ? Math.max(...items.map(f => f.display_order))
              : 0;
            setFormData({ name: "", display_order: maxOrder + 1 });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-3">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 인문계열"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
              <input
                type="number"
                value={formData.display_order}
                onChange={(e) =>
                  setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <button
                onClick={handleCreate}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                저장
              </button>
              <button
                onClick={cancelEdit}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {items.length === 0 ? (
              <tr>
                <td colSpan={4} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              items.map((item) =>
                editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={item.is_active}
                          onChange={(e) =>
                            updateCareerFieldAction(item.id, { is_active: e.target.checked }).then(() =>
                              loadItems()
                            )
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {item.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <Badge
                        variant={item.is_active ? "success" : "gray"}
                        size="xs"
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </Badge>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                )
              )
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/ContentMetadataTabs.tsx">
"use client";

import { useState } from "react";
import { CurriculumHierarchyManager } from "./CurriculumHierarchyManager";
import { PlatformsManager } from "./PlatformsManager";
import { PublishersManager } from "./PublishersManager";
import { CareerFieldsManager } from "./CareerFieldsManager";

type TabKey = "hierarchy" | "platforms" | "publishers" | "career-fields";

export function ContentMetadataTabs() {
  const [activeTab, setActiveTab] = useState<TabKey>("hierarchy");

  const tabs = [
    { key: "hierarchy" as TabKey, label: "교육과정 계층" },
    { key: "platforms" as TabKey, label: "플랫폼" },
    { key: "publishers" as TabKey, label: "출판사" },
    { key: "career-fields" as TabKey, label: "진로 계열" },
  ];

  return (
    <div>
      {/* 탭 네비게이션 */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex gap-8 overflow-x-auto">
          {tabs.map((tab) => (
            <button
              key={tab.key}
              onClick={() => setActiveTab(tab.key)}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition ${
                activeTab === tab.key
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              {tab.label}
            </button>
          ))}
        </nav>
      </div>

      {/* 탭 컨텐츠 */}
      <div className="mt-6">
        {activeTab === "hierarchy" && <CurriculumHierarchyManager />}
        {activeTab === "platforms" && <PlatformsManager />}
        {activeTab === "publishers" && <PublishersManager />}
        {activeTab === "career-fields" && <CareerFieldsManager />}
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/CurriculumHierarchyManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getCurriculumRevisionsAction,
  createCurriculumRevisionAction,
  updateCurriculumRevisionAction,
  deleteCurriculumRevisionAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import {
  getSubjectGroupsAction,
  createSubjectGroup,
  updateSubjectGroup,
  deleteSubjectGroup,
  getSubjectsByGroupAction,
  createSubject,
  updateSubject,
  deleteSubject,
  getSubjectTypesAction,
  createSubjectType,
  updateSubjectType,
  deleteSubjectType,
} from "@/app/(admin)/actions/subjectActions";
import { useToast } from "@/components/ui/ToastProvider";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";

export function CurriculumHierarchyManager() {
  const toast = useToast();
  const [revisions, setRevisions] = useState<CurriculumRevision[]>([]);
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>("");
  const [subjectGroups, setSubjectGroups] = useState<SubjectGroup[]>([]);
  const [subjectsMap, setSubjectsMap] = useState<Map<string, Subject[]>>(new Map());
  const [subjectTypes, setSubjectTypes] = useState<SubjectType[]>([]);
  const [loading, setLoading] = useState(true);

  // 편집 상태
  const [editingRevisionId, setEditingRevisionId] = useState<string | null>(null);
  const [editingGroupId, setEditingGroupId] = useState<string | null>(null);
  const [editingSubjectId, setEditingSubjectId] = useState<string | null>(null);
  const [editingTypeId, setEditingTypeId] = useState<string | null>(null);

  // 생성 모드
  const [isCreatingRevision, setIsCreatingRevision] = useState(false);
  const [isCreatingGroup, setIsCreatingGroup] = useState(false);
  const [isCreatingSubject, setIsCreatingSubject] = useState<string | null>(null); // groupId
  const [isCreatingType, setIsCreatingType] = useState(false);

  // 폼 데이터
  const [revisionFormData, setRevisionFormData] = useState({ name: "", display_order: 0 });
  const [groupFormData, setGroupFormData] = useState({ name: "", display_order: 0 });
  const [subjectFormData, setSubjectFormData] = useState({
    name: "",
    display_order: 0,
    subject_type_id: "",
  });
  const [typeFormData, setTypeFormData] = useState({
    name: "",
    display_order: 0,
    is_active: true,
  });

  useEffect(() => {
    loadRevisions();
  }, []);

  useEffect(() => {
    if (selectedRevisionId) {
      loadHierarchy();
    } else {
      setSubjectGroups([]);
      setSubjectsMap(new Map());
      setSubjectTypes([]);
    }
  }, [selectedRevisionId]);

  async function loadRevisions() {
    try {
      const data = await getCurriculumRevisionsAction();
      console.log("[CurriculumHierarchyManager] 개정교육과정 조회 결과:", data);
      setRevisions(data || []);
      if (data && data.length > 0 && !selectedRevisionId) {
        const firstRevision = data[0];
        if (firstRevision?.id) {
          setSelectedRevisionId(firstRevision.id);
        }
      }
    } catch (error) {
      console.error("개정교육과정 조회 실패:", error);
      toast.showError("개정교육과정을 불러오는데 실패했습니다.");
      setRevisions([]);
    } finally {
      setLoading(false);
    }
  }

  async function loadHierarchy() {
    if (!selectedRevisionId) return;

    setLoading(true);
    try {
      const [groups, types] = await Promise.all([
        getSubjectGroupsAction(selectedRevisionId),
        getSubjectTypesAction(selectedRevisionId),
      ]);

      console.log("[CurriculumHierarchyManager] 교과 조회 결과:", groups);
      console.log("[CurriculumHierarchyManager] 과목구분 조회 결과:", types);

      setSubjectGroups(groups || []);
      setSubjectTypes(types || []);

      // 각 교과별 과목 조회 (병렬 처리)
      const subjectsPromises = groups.map(async (group) => {
        try {
          const subjects = await getSubjectsByGroupAction(group.id);
          console.log(`[CurriculumHierarchyManager] 교과 "${group.name}"의 과목 조회 결과:`, subjects);
          return [group.id, subjects] as [string, Subject[]];
        } catch (error) {
          console.error(`[CurriculumHierarchyManager] 교과 "${group.name}"의 과목 조회 실패:`, error);
          return [group.id, []] as [string, Subject[]];
        }
      });

      const subjectsResults = await Promise.all(subjectsPromises);
      const newSubjectsMap = new Map(subjectsResults);
      setSubjectsMap(newSubjectsMap);
    } catch (error) {
      console.error("계층 데이터 조회 실패:", error);
      toast.showError("데이터를 불러오는데 실패했습니다.");
      setSubjectGroups([]);
      setSubjectTypes([]);
      setSubjectsMap(new Map());
    } finally {
      setLoading(false);
    }
  }

  // 개정교육과정 CRUD
  async function handleCreateRevision() {
    if (!revisionFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    try {
      await createCurriculumRevisionAction(
        revisionFormData.name,
        revisionFormData.display_order
      );
      setRevisionFormData({ name: "", display_order: 0 });
      setIsCreatingRevision(false);
      toast.showSuccess("개정교육과정이 생성되었습니다.");
      await loadRevisions();
    } catch (error) {
      console.error("개정교육과정 생성 실패:", error);
      toast.showError(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdateRevision(id: string) {
    if (!revisionFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    try {
      await updateCurriculumRevisionAction(id, {
        name: revisionFormData.name,
        display_order: revisionFormData.display_order,
      });
      setEditingRevisionId(null);
      setRevisionFormData({ name: "", display_order: 0 });
      toast.showSuccess("개정교육과정이 수정되었습니다.");
      await loadRevisions();
    } catch (error) {
      console.error("개정교육과정 수정 실패:", error);
      toast.showError(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDeleteRevision(id: string) {
    if (!confirm("정말 삭제하시겠습니까? 관련된 교과, 과목, 과목구분도 함께 삭제됩니다."))
      return;

    try {
      await deleteCurriculumRevisionAction(id);
      if (selectedRevisionId === id) {
        setSelectedRevisionId("");
      }
      toast.showSuccess("개정교육과정이 삭제되었습니다.");
      await loadRevisions();
    } catch (error) {
      console.error("개정교육과정 삭제 실패:", error);
      toast.showError(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  // 교과 CRUD
  async function handleCreateGroup() {
    if (!groupFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }
    if (!selectedRevisionId) {
      toast.showError("개정교육과정을 선택해주세요.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", selectedRevisionId);
      formData.append("name", groupFormData.name);
      formData.append("display_order", groupFormData.display_order.toString());

      await createSubjectGroup(formData);
      setGroupFormData({ name: "", display_order: 0 });
      setIsCreatingGroup(false);
      toast.showSuccess("교과가 생성되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("교과 생성 실패:", error);
      toast.showError(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdateGroup(id: string) {
    if (!groupFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", selectedRevisionId);
      formData.append("name", groupFormData.name);
      formData.append("display_order", groupFormData.display_order.toString());

      await updateSubjectGroup(id, formData);
      setEditingGroupId(null);
      setGroupFormData({ name: "", display_order: 0 });
      toast.showSuccess("교과가 수정되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("교과 수정 실패:", error);
      toast.showError(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDeleteGroup(id: string) {
    if (!confirm("정말 삭제하시겠습니까? 관련된 과목도 함께 삭제됩니다.")) return;

    try {
      await deleteSubjectGroup(id);
      setEditingGroupId(null);
      toast.showSuccess("교과가 삭제되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("교과 삭제 실패:", error);
      toast.showError(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  // 과목 CRUD
  async function handleCreateSubject(groupId: string) {
    if (!subjectFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("subject_group_id", groupId);
      formData.append("name", subjectFormData.name);
      formData.append("display_order", subjectFormData.display_order.toString());
      if (subjectFormData.subject_type_id) {
        formData.append("subject_type_id", subjectFormData.subject_type_id);
      }

      await createSubject(formData);
      setSubjectFormData({ name: "", display_order: 0, subject_type_id: "" });
      setIsCreatingSubject(null);
      toast.showSuccess("과목이 생성되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("과목 생성 실패:", error);
      toast.showError(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdateSubject(id: string, groupId: string) {
    if (!subjectFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("subject_group_id", groupId);
      formData.append("name", subjectFormData.name);
      formData.append("display_order", subjectFormData.display_order.toString());
      if (subjectFormData.subject_type_id) {
        formData.append("subject_type_id", subjectFormData.subject_type_id);
      }

      await updateSubject(id, formData);
      setEditingSubjectId(null);
      setSubjectFormData({ name: "", display_order: 0, subject_type_id: "" });
      toast.showSuccess("과목이 수정되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("과목 수정 실패:", error);
      toast.showError(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDeleteSubject(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deleteSubject(id);
      setEditingSubjectId(null);
      toast.showSuccess("과목이 삭제되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("과목 삭제 실패:", error);
      toast.showError(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  // 과목구분 CRUD
  async function handleCreateType() {
    if (!typeFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }
    if (!selectedRevisionId) {
      toast.showError("개정교육과정을 선택해주세요.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", selectedRevisionId);
      formData.append("name", typeFormData.name);
      formData.append("display_order", typeFormData.display_order.toString());
      formData.append("is_active", typeFormData.is_active ? "true" : "false");

      await createSubjectType(formData);
      setTypeFormData({ name: "", display_order: 0, is_active: true });
      setIsCreatingType(false);
      toast.showSuccess("과목구분이 생성되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("과목구분 생성 실패:", error);
      toast.showError(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdateType(id: string) {
    if (!typeFormData.name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", selectedRevisionId);
      formData.append("name", typeFormData.name);
      formData.append("display_order", typeFormData.display_order.toString());
      formData.append("is_active", typeFormData.is_active ? "true" : "false");

      await updateSubjectType(id, formData);
      setEditingTypeId(null);
      setTypeFormData({ name: "", display_order: 0, is_active: true });
      toast.showSuccess("과목구분이 수정되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("과목구분 수정 실패:", error);
      toast.showError(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDeleteType(id: string) {
    if (!confirm("정말 삭제하시겠습니까? 사용 중인 과목이 있으면 삭제할 수 없습니다."))
      return;

    try {
      await deleteSubjectType(id);
      setEditingTypeId(null);
      toast.showSuccess("과목구분이 삭제되었습니다.");
      await loadHierarchy();
    } catch (error) {
      console.error("과목구분 삭제 실패:", error);
      toast.showError(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  // 편집 시작 함수들
  function startEditRevision(revision: CurriculumRevision) {
    setEditingRevisionId(revision.id);
    setRevisionFormData({ name: revision.name, display_order: revision.display_order ?? 0 });
    setIsCreatingRevision(false);
  }

  function startEditGroup(group: SubjectGroup) {
    setEditingGroupId(group.id);
    setGroupFormData({ name: group.name, display_order: group.display_order ?? 0 });
    setIsCreatingGroup(false);
  }

  function startEditSubject(subject: Subject) {
    setEditingSubjectId(subject.id);
    setSubjectFormData({
      name: subject.name,
      display_order: subject.display_order ?? 0,
      subject_type_id: subject.subject_type_id || "",
    });
    setIsCreatingSubject(null);
  }

  function startEditType(type: SubjectType) {
    setEditingTypeId(type.id);
    setTypeFormData({
      name: type.name,
      display_order: type.display_order ?? 0,
      is_active: type.is_active,
    });
    setIsCreatingType(false);
  }

  // 취소 함수들
  function cancelEditRevision() {
    setEditingRevisionId(null);
    setIsCreatingRevision(false);
    setRevisionFormData({ name: "", display_order: 0 });
  }

  function cancelEditGroup() {
    setEditingGroupId(null);
    setIsCreatingGroup(false);
    setGroupFormData({ name: "", display_order: 0 });
  }

  function cancelEditSubject() {
    setEditingSubjectId(null);
    setIsCreatingSubject(null);
    setSubjectFormData({ name: "", display_order: 0, subject_type_id: "" });
  }

  function cancelEditType() {
    setEditingTypeId(null);
    setIsCreatingType(false);
    setTypeFormData({ name: "", display_order: 0, is_active: true });
  }

  const selectedRevision = revisions.find((r) => r.id === selectedRevisionId);

  if (loading && revisions.length === 0) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="flex flex-col gap-6">
      {/* 개정교육과정 선택 및 관리 */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-semibold text-gray-900">개정교육과정</h2>
          <button
            onClick={() => {
              setIsCreatingRevision(true);
              setEditingRevisionId(null);
              setRevisionFormData({
                name: "",
                display_order: revisions.length + 1,
              });
            }}
            className="rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            + 추가
          </button>
        </div>

        {/* 개정교육과정 선택 */}
        <div className="flex flex-col gap-2">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정 선택
          </label>
          {loading && revisions.length === 0 ? (
            <div className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-700">
              로딩 중...
            </div>
          ) : (
            <select
              value={selectedRevisionId}
              onChange={(e) => setSelectedRevisionId(e.target.value)}
              className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              disabled={loading}
            >
              <option value="">선택하세요</option>
              {revisions.map((rev) => (
                <option key={rev.id} value={rev.id}>
                  {rev.name} {rev.is_active ? "(활성)" : "(비활성)"}
                </option>
              ))}
            </select>
          )}
          {!loading && revisions.length === 0 && (
            <p className="text-sm text-gray-700">
              개정교육과정이 없습니다. 위의 "+ 추가" 버튼을 클릭하여 생성해주세요.
            </p>
          )}
        </div>

        {/* 개정교육과정 생성 폼 */}
        {isCreatingRevision && (
          <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-gray-50 p-4">
            <div className="grid gap-4 md:grid-cols-3">
              <div className="flex flex-col gap-1">
                <label className="block text-sm font-medium text-gray-700">이름</label>
                <input
                  type="text"
                  value={revisionFormData.name}
                  onChange={(e) =>
                    setRevisionFormData({ ...revisionFormData, name: e.target.value })
                  }
                  placeholder="예: 2022개정"
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                />
              </div>
              <div className="flex flex-col gap-1">
                <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
                <input
                  type="number"
                  value={revisionFormData.display_order}
                  onChange={(e) =>
                    setRevisionFormData({
                      ...revisionFormData,
                      display_order: parseInt(e.target.value) || 0,
                    })
                  }
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                />
              </div>
              <div className="flex items-end gap-2">
                <button
                  onClick={handleCreateRevision}
                  className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  저장
                </button>
                <button
                  onClick={cancelEditRevision}
                  className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
                >
                  취소
                </button>
              </div>
            </div>
          </div>
        )}

        {/* 개정교육과정 목록 */}
        <div className="flex flex-col gap-2">
          {revisions.map((revision) =>
            editingRevisionId === revision.id ? (
              <div
                key={revision.id}
                className="flex items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3"
              >
                <input
                  type="text"
                  value={revisionFormData.name}
                  onChange={(e) =>
                    setRevisionFormData({ ...revisionFormData, name: e.target.value })
                  }
                  className="flex-1 rounded-md border border-gray-300 px-3 py-1.5 text-sm"
                />
                <input
                  type="number"
                  value={revisionFormData.display_order}
                  onChange={(e) =>
                    setRevisionFormData({
                      ...revisionFormData,
                      display_order: parseInt(e.target.value) || 0,
                    })
                  }
                  className="w-24 rounded-md border border-gray-300 px-3 py-1.5 text-sm"
                />
                <button
                  onClick={() => handleUpdateRevision(revision.id)}
                  className="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
                >
                  저장
                </button>
                <button
                  onClick={cancelEditRevision}
                  className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                >
                  취소
                </button>
              </div>
            ) : (
              <div
                key={revision.id}
                className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-3"
              >
                <div className="flex items-center gap-3">
                  <span className="text-sm font-medium text-gray-900">{revision.name}</span>
                  <span className="text-xs text-gray-600">순서: {revision.display_order}</span>
                  <span
                    className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
                      revision.is_active
                        ? "bg-green-100 text-green-800"
                        : "bg-gray-100 text-gray-800"
                    }`}
                  >
                    {revision.is_active ? "활성" : "비활성"}
                  </span>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => startEditRevision(revision)}
                    className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                  >
                    수정
                  </button>
                  <button
                    onClick={() => handleDeleteRevision(revision.id)}
                    className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                  >
                    삭제
                  </button>
                </div>
              </div>
            )
          )}
        </div>
      </div>

      {/* 선택된 개정교육과정의 계층 구조 */}
      {selectedRevisionId && (
        <div className="flex flex-col gap-6">
          {/* 교과 및 과목 */}
          <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold text-gray-900">교과 및 과목</h2>
              <button
                onClick={() => {
                  setIsCreatingGroup(true);
                  setEditingGroupId(null);
                  setGroupFormData({
                    name: "",
                    display_order: subjectGroups.length + 1,
                  });
                }}
                className="rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white transition hover:bg-indigo-700"
                disabled={!selectedRevisionId}
              >
                + 교과 추가
              </button>
            </div>

            {/* 교과 생성 폼 */}
            {isCreatingGroup && (
              <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-gray-50 p-4">
                <div className="grid gap-4 md:grid-cols-3">
                  <div className="flex flex-col gap-1">
                    <label className="block text-sm font-medium text-gray-700">이름</label>
                    <input
                      type="text"
                      value={groupFormData.name}
                      onChange={(e) =>
                        setGroupFormData({ ...groupFormData, name: e.target.value })
                      }
                      placeholder="예: 국어"
                      className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                    />
                  </div>
                  <div className="flex flex-col gap-1">
                    <label className="block text-sm font-medium text-gray-700">
                      정렬 순서
                    </label>
                    <input
                      type="number"
                      value={groupFormData.display_order}
                      onChange={(e) =>
                        setGroupFormData({
                          ...groupFormData,
                          display_order: parseInt(e.target.value) || 0,
                        })
                      }
                      className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                    />
                  </div>
                  <div className="flex items-end gap-2">
                    <button
                      onClick={handleCreateGroup}
                      className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                    >
                      저장
                    </button>
                    <button
                      onClick={cancelEditGroup}
                      className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
                    >
                      취소
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* 교과 목록 */}
            <div className="flex flex-col gap-4">
              {subjectGroups.length === 0 ? (
                <div className="text-center py-8 text-sm text-gray-700">
                  교과가 없습니다. 교과를 추가해주세요.
                </div>
              ) : (
                subjectGroups.map((group) => {
                  const subjects = subjectsMap.get(group.id) || [];
                  return (
                    <div
                      key={group.id}
                      className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4"
                    >
                      {/* 교과 헤더 */}
                      <div className="flex items-center justify-between">
                        {editingGroupId === group.id ? (
                          <div className="flex flex-1 items-center gap-2">
                            <input
                              type="text"
                              value={groupFormData.name}
                              onChange={(e) =>
                                setGroupFormData({ ...groupFormData, name: e.target.value })
                              }
                              className="flex-1 rounded-md border border-gray-300 px-3 py-1.5 text-sm"
                            />
                            <input
                              type="number"
                              value={groupFormData.display_order}
                              onChange={(e) =>
                                setGroupFormData({
                                  ...groupFormData,
                                  display_order: parseInt(e.target.value) || 0,
                                })
                              }
                              className="w-24 rounded-md border border-gray-300 px-3 py-1.5 text-sm"
                            />
                            <button
                              onClick={() => handleUpdateGroup(group.id)}
                              className="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
                            >
                              저장
                            </button>
                            <button
                              onClick={cancelEditGroup}
                              className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                            >
                              취소
                            </button>
                          </div>
                        ) : (
                          <>
                            <div className="flex items-center gap-3">
                              <h3 className="text-base font-semibold text-gray-900">
                                {group.name}
                              </h3>
                              <span className="text-xs text-gray-600">
                                순서: {group.display_order}
                              </span>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => {
                                  setIsCreatingSubject(group.id);
                                  setSubjectFormData({
                                    name: "",
                                    display_order: subjects.length + 1,
                                    subject_type_id: "",
                                  });
                                }}
                                className="rounded-lg bg-green-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-green-700"
                              >
                                + 과목 추가
                              </button>
                              <button
                                onClick={() => startEditGroup(group)}
                                className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                              >
                                수정
                              </button>
                              <button
                                onClick={() => handleDeleteGroup(group.id)}
                                className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                              >
                                삭제
                              </button>
                            </div>
                          </>
                        )}
                      </div>

                      {/* 과목 목록 */}
                      <div className="flex flex-col gap-2 pl-4">
                        {/* 과목 생성 폼 */}
                        {isCreatingSubject === group.id && (
                          <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-3">
                            <div className="grid gap-3 md:grid-cols-4">
                              <div className="flex flex-col gap-1">
                                <label className="block text-xs font-medium text-gray-700">
                                  과목명
                                </label>
                                <input
                                  type="text"
                                  value={subjectFormData.name}
                                  onChange={(e) =>
                                    setSubjectFormData({
                                      ...subjectFormData,
                                      name: e.target.value,
                                    })
                                  }
                                  placeholder="예: 국어"
                                  className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-sm"
                                />
                              </div>
                              <div className="flex flex-col gap-1">
                                <label className="block text-xs font-medium text-gray-700">
                                  과목구분
                                </label>
                                <select
                                  value={subjectFormData.subject_type_id}
                                  onChange={(e) =>
                                    setSubjectFormData({
                                      ...subjectFormData,
                                      subject_type_id: e.target.value,
                                    })
                                  }
                                  className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-sm"
                                >
                                  <option value="">선택 안 함</option>
                                  {subjectTypes.map((type) => (
                                    <option key={type.id} value={type.id}>
                                      {type.name}
                                    </option>
                                  ))}
                                </select>
                              </div>
                              <div className="flex flex-col gap-1">
                                <label className="block text-xs font-medium text-gray-700">
                                  정렬 순서
                                </label>
                                <input
                                  type="number"
                                  value={subjectFormData.display_order}
                                  onChange={(e) =>
                                    setSubjectFormData({
                                      ...subjectFormData,
                                      display_order: parseInt(e.target.value) || 0,
                                    })
                                  }
                                  className="w-full rounded-md border border-gray-300 px-2 py-1.5 text-sm"
                                />
                              </div>
                              <div className="flex items-end gap-2">
                                <button
                                  onClick={() => handleCreateSubject(group.id)}
                                  className="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
                                >
                                  저장
                                </button>
                                <button
                                  onClick={cancelEditSubject}
                                  className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                                >
                                  취소
                                </button>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* 과목 항목들 */}
                        {subjects.length === 0 ? (
                          <div className="text-sm text-gray-700">과목이 없습니다.</div>
                        ) : (
                          subjects.map((subject) => {
                            const subjectType = subjectTypes.find(
                              (t) => t.id === subject.subject_type_id
                            );
                            return editingSubjectId === subject.id ? (
                              <div
                                key={subject.id}
                                className="flex items-center gap-2 rounded-lg border border-gray-200 bg-white p-2"
                              >
                                <input
                                  type="text"
                                  value={subjectFormData.name}
                                  onChange={(e) =>
                                    setSubjectFormData({
                                      ...subjectFormData,
                                      name: e.target.value,
                                    })
                                  }
                                  className="flex-1 rounded-md border border-gray-300 px-2 py-1 text-sm"
                                />
                                <select
                                  value={subjectFormData.subject_type_id}
                                  onChange={(e) =>
                                    setSubjectFormData({
                                      ...subjectFormData,
                                      subject_type_id: e.target.value,
                                    })
                                  }
                                  className="w-32 rounded-md border border-gray-300 px-2 py-1 text-sm"
                                >
                                  <option value="">선택 안 함</option>
                                  {subjectTypes.map((type) => (
                                    <option key={type.id} value={type.id}>
                                      {type.name}
                                    </option>
                                  ))}
                                </select>
                                <input
                                  type="number"
                                  value={subjectFormData.display_order}
                                  onChange={(e) =>
                                    setSubjectFormData({
                                      ...subjectFormData,
                                      display_order: parseInt(e.target.value) || 0,
                                    })
                                  }
                                  className="w-20 rounded-md border border-gray-300 px-2 py-1 text-sm"
                                />
                                <button
                                  onClick={() => handleUpdateSubject(subject.id, group.id)}
                                  className="rounded-lg bg-indigo-600 px-2 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                                >
                                  저장
                                </button>
                                <button
                                  onClick={cancelEditSubject}
                                  className="rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                                >
                                  취소
                                </button>
                              </div>
                            ) : (
                              <div
                                key={subject.id}
                                className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-2"
                              >
                                <div className="flex items-center gap-3">
                                  <span className="text-sm font-medium text-gray-900">
                                    {subject.name}
                                  </span>
                                  {subjectType && (
                                    <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                                      {subjectType.name}
                                    </span>
                                  )}
                                  <span className="text-xs text-gray-600">
                                    순서: {subject.display_order}
                                  </span>
                                </div>
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => startEditSubject(subject)}
                                    className="rounded-lg bg-indigo-600 px-2 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                                  >
                                    수정
                                  </button>
                                  <button
                                    onClick={() => handleDeleteSubject(subject.id)}
                                    className="rounded-lg bg-red-600 px-2 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                                  >
                                    삭제
                                  </button>
                                </div>
                              </div>
                            );
                          })
                        )}
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>

          {/* 과목구분 */}
          <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold text-gray-900">과목구분</h2>
              <button
                onClick={() => {
                  setIsCreatingType(true);
                  setEditingTypeId(null);
                  setTypeFormData({
                    name: "",
                    display_order: subjectTypes.length + 1,
                    is_active: true,
                  });
                }}
                className="rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                + 추가
              </button>
            </div>

            {/* 과목구분 생성 폼 */}
            {isCreatingType && (
              <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-gray-50 p-4">
                <div className="grid gap-4 md:grid-cols-4">
                  <div className="flex flex-col gap-1">
                    <label className="block text-sm font-medium text-gray-700">이름</label>
                    <input
                      type="text"
                      value={typeFormData.name}
                      onChange={(e) =>
                        setTypeFormData({ ...typeFormData, name: e.target.value })
                      }
                      placeholder="예: 공통"
                      className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                    />
                  </div>
                  <div className="flex flex-col gap-1">
                    <label className="block text-sm font-medium text-gray-700">
                      정렬 순서
                    </label>
                    <input
                      type="number"
                      value={typeFormData.display_order}
                      onChange={(e) =>
                        setTypeFormData({
                          ...typeFormData,
                          display_order: parseInt(e.target.value) || 0,
                        })
                      }
                      className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                    />
                  </div>
                  <div className="flex items-center">
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={typeFormData.is_active}
                        onChange={(e) =>
                          setTypeFormData({ ...typeFormData, is_active: e.target.checked })
                        }
                        className="rounded border-gray-300"
                      />
                      <span className="text-sm text-gray-700">활성</span>
                    </label>
                  </div>
                  <div className="flex items-end gap-2">
                    <button
                      onClick={handleCreateType}
                      className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                    >
                      저장
                    </button>
                    <button
                      onClick={cancelEditType}
                      className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
                    >
                      취소
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* 과목구분 목록 */}
            <div className="flex flex-col gap-2">
              {subjectTypes.length === 0 ? (
                <div className="text-center py-8 text-sm text-gray-700">
                  과목구분이 없습니다. 과목구분을 추가해주세요.
                </div>
              ) : (
                subjectTypes.map((type) =>
                  editingTypeId === type.id ? (
                    <div
                      key={type.id}
                      className="flex items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3"
                    >
                      <input
                        type="text"
                        value={typeFormData.name}
                        onChange={(e) =>
                          setTypeFormData({ ...typeFormData, name: e.target.value })
                        }
                        className="flex-1 rounded-md border border-gray-300 px-3 py-1.5 text-sm"
                      />
                      <input
                        type="number"
                        value={typeFormData.display_order}
                        onChange={(e) =>
                          setTypeFormData({
                            ...typeFormData,
                            display_order: parseInt(e.target.value) || 0,
                          })
                        }
                        className="w-24 rounded-md border border-gray-300 px-3 py-1.5 text-sm"
                      />
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={typeFormData.is_active}
                          onChange={(e) =>
                            setTypeFormData({ ...typeFormData, is_active: e.target.checked })
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">활성</span>
                      </label>
                      <button
                        onClick={() => handleUpdateType(type.id)}
                        className="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
                      >
                        저장
                      </button>
                      <button
                        onClick={cancelEditType}
                        className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                      >
                        취소
                      </button>
                    </div>
                  ) : (
                    <div
                      key={type.id}
                      className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-3"
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-sm font-medium text-gray-900">{type.name}</span>
                        <span className="text-xs text-gray-600">순서: {type.display_order}</span>
                        <span
                          className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
                            type.is_active
                              ? "bg-green-100 text-green-800"
                              : "bg-gray-100 text-gray-800"
                          }`}
                        >
                          {type.is_active ? "활성" : "비활성"}
                        </span>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => startEditType(type)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDeleteType(type.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </div>
                  )
                )
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/CurriculumRevisionsManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getCurriculumRevisionsAction,
  createCurriculumRevisionAction,
  updateCurriculumRevisionAction,
  deleteCurriculumRevisionAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import { Badge } from "@/components/atoms";

export function CurriculumRevisionsManager() {
  const [items, setItems] = useState<CurriculumRevision[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [formData, setFormData] = useState({ name: "", display_order: 0 });

  useEffect(() => {
    loadItems();
  }, []);

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getCurriculumRevisionsAction();
      setItems(data);
    } catch (error) {
      console.error("개정교육과정 조회 실패:", error);
      alert("개정교육과정을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await createCurriculumRevisionAction(formData.name, formData.display_order);
      setFormData({ name: "", display_order: 0 });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("개정교육과정 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await updateCurriculumRevisionAction(id, {
        name: formData.name,
        display_order: formData.display_order,
      });
      setEditingId(null);
      setFormData({ name: "", display_order: 0 });
      loadItems();
    } catch (error) {
      console.error("개정교육과정 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deleteCurriculumRevisionAction(id);
      loadItems();
    } catch (error) {
      console.error("개정교육과정 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: CurriculumRevision) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0 });
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0 });
  }

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">개정교육과정 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            setFormData({ name: "", display_order: items.length + 1 });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {/* 생성 폼 */}
      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-3">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 2015개정"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
              <input
                type="number"
                value={formData.display_order}
                onChange={(e) =>
                  setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <button
                onClick={handleCreate}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                저장
              </button>
              <button
                onClick={cancelEdit}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {items.length === 0 ? (
              <tr>
                <td colSpan={4} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              items.map((item) =>
                editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={item.is_active}
                          onChange={(e) =>
                            updateCurriculumRevisionAction(item.id, { is_active: e.target.checked }).then(
                              () => loadItems()
                            )
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {item.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <Badge
                        variant={item.is_active ? "success" : "gray"}
                        size="xs"
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </Badge>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                )
              )
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/PlatformsManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getPlatformsAction,
  createPlatformAction,
  updatePlatformAction,
  deletePlatformAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { Platform } from "@/lib/data/contentMetadata";
import { Badge } from "@/components/atoms";

export function PlatformsManager() {
  const [items, setItems] = useState<Platform[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [formData, setFormData] = useState({ name: "", display_order: 0 });

  useEffect(() => {
    loadItems();
  }, []);

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getPlatformsAction();
      setItems(data);
    } catch (error) {
      console.error("플랫폼 조회 실패:", error);
      alert("플랫폼을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await createPlatformAction(formData.name, formData.display_order);
      setFormData({ name: "", display_order: 0 });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("플랫폼 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await updatePlatformAction(id, {
        name: formData.name,
        display_order: formData.display_order,
      });
      setEditingId(null);
      setFormData({ name: "", display_order: 0 });
      loadItems();
    } catch (error) {
      console.error("플랫폼 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deletePlatformAction(id);
      loadItems();
    } catch (error) {
      console.error("플랫폼 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: Platform) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0 });
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0 });
  }

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">플랫폼 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            setFormData({ name: "", display_order: items.length + 1 });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-3">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 메가스터디"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
              <input
                type="number"
                value={formData.display_order}
                onChange={(e) =>
                  setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <button
                onClick={handleCreate}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                저장
              </button>
              <button
                onClick={cancelEdit}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {items.length === 0 ? (
              <tr>
                <td colSpan={4} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              items.map((item) =>
                editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={item.is_active}
                          onChange={(e) =>
                            updatePlatformAction(item.id, { is_active: e.target.checked }).then(() =>
                              loadItems()
                            )
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {item.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <Badge
                        variant={item.is_active ? "success" : "gray"}
                        size="xs"
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </Badge>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                )
              )
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/PublishersManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getPublishersAction,
  createPublisherAction,
  updatePublisherAction,
  deletePublisherAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { Publisher } from "@/lib/data/contentMetadata";

export function PublishersManager() {
  const [items, setItems] = useState<Publisher[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [formData, setFormData] = useState({ name: "", display_order: 0 });

  useEffect(() => {
    loadItems();
  }, []);

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getPublishersAction();
      setItems(data);
    } catch (error) {
      console.error("출판사 조회 실패:", error);
      alert("출판사를 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await createPublisherAction(formData.name, formData.display_order);
      setFormData({ name: "", display_order: 0 });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("출판사 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await updatePublisherAction(id, {
        name: formData.name,
        display_order: formData.display_order,
      });
      setEditingId(null);
      setFormData({ name: "", display_order: 0 });
      loadItems();
    } catch (error) {
      console.error("출판사 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deletePublisherAction(id);
      loadItems();
    } catch (error) {
      console.error("출판사 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: Publisher) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0 });
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0 });
  }

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">출판사 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            setFormData({ name: "", display_order: items.length + 1 });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-3">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 비상교육"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
              <input
                type="number"
                value={formData.display_order}
                onChange={(e) =>
                  setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <button
                onClick={handleCreate}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                저장
              </button>
              <button
                onClick={cancelEdit}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {items.length === 0 ? (
              <tr>
                <td colSpan={4} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              items.map((item) =>
                editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={item.is_active}
                          onChange={(e) =>
                            updatePublisherAction(item.id, { is_active: e.target.checked }).then(() =>
                              loadItems()
                            )
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {item.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex rounded-full px-2 py-1 text-xs font-medium ${
                          item.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }`}
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                )
              )
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/SubjectCategoriesManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getSubjectCategoriesAction,
  createSubjectCategoryAction,
  updateSubjectCategoryAction,
  deleteSubjectCategoryAction,
  getCurriculumRevisionsAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { SubjectCategory, CurriculumRevision } from "@/lib/data/contentMetadata";

export function SubjectCategoriesManager() {
  const [items, setItems] = useState<SubjectCategory[]>([]);
  const [revisions, setRevisions] = useState<CurriculumRevision[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>("");
  const [formData, setFormData] = useState({ name: "", display_order: 0 });

  useEffect(() => {
    loadRevisions();
    loadItems();
  }, []);

  async function loadRevisions() {
    try {
      const data = await getCurriculumRevisionsAction();
      setRevisions(data);
      if (data.length > 0 && !selectedRevisionId) {
        const firstRevision = data[0];
        if (firstRevision?.id) {
          setSelectedRevisionId(firstRevision.id);
        }
      }
    } catch (error) {
      console.error("개정교육과정 조회 실패:", error);
    }
  }

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getSubjectCategoriesAction();
      setItems(data);
    } catch (error) {
      console.error("교과 조회 실패:", error);
      alert("교과를 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }
    if (!selectedRevisionId) {
      alert("개정교육과정을 선택해주세요.");
      return;
    }

    try {
      await createSubjectCategoryAction(selectedRevisionId, formData.name, formData.display_order);
      setFormData({ name: "", display_order: 0 });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("교과 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await updateSubjectCategoryAction(id, {
        name: formData.name,
        display_order: formData.display_order,
      });
      setEditingId(null);
      setFormData({ name: "", display_order: 0 });
      loadItems();
    } catch (error) {
      console.error("교과 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deleteSubjectCategoryAction(id);
      loadItems();
    } catch (error) {
      console.error("교과 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: SubjectCategory) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0 });
    // revision_id는 SubjectCategory에 없으므로 현재 선택된 revision 사용
    // setSelectedRevisionId(item.revision_id);
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0 });
  }

  // SubjectCategory에는 revision_id가 없으므로 모든 항목 표시
  // TODO: 데이터베이스 스키마에 revision_id 관계가 추가되면 필터링 로직 구현
  const filteredItems = items;

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="space-y-4">
      {/* 경고 메시지 */}
      <div className="rounded-lg border border-yellow-300 bg-yellow-50 p-4">
        <div className="flex items-start gap-3">
          <div className="text-yellow-600">⚠️</div>
          <div className="flex flex-1 flex-col gap-1">
            <h3 className="text-sm font-semibold text-yellow-800">주의</h3>
            <p className="text-sm text-yellow-700">
              이 페이지는 deprecated된 테이블을 사용합니다. 교과 관리는{" "}
              <a
                href="/admin/subjects"
                className="font-semibold text-yellow-800 underline hover:text-yellow-900"
              >
                교과/과목 관리 페이지
              </a>
              에서 진행해주세요.
            </p>
          </div>
        </div>
      </div>

      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">교과 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            setFormData({ name: "", display_order: 0 });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {/* 개정교육과정 필터 */}
      <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
        <label className="block text-sm font-medium text-gray-700">
          개정교육과정 필터
        </label>
        <select
          value={selectedRevisionId}
          onChange={(e) => setSelectedRevisionId(e.target.value)}
          className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
        >
          <option value="">전체</option>
          {revisions.map((rev) => (
            <option key={rev.id} value={rev.id}>
              {rev.name}
            </option>
          ))}
        </select>
      </div>

      {/* 생성 폼 */}
      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-4">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                개정교육과정 <span className="text-red-500">*</span>
              </label>
              <select
                value={selectedRevisionId}
                onChange={(e) => setSelectedRevisionId(e.target.value)}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              >
                <option value="">선택하세요</option>
                {revisions.map((rev) => (
                  <option key={rev.id} value={rev.id}>
                    {rev.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 국어"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
              <input
                type="number"
                value={formData.display_order}
                onChange={(e) =>
                  setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <button
                onClick={handleCreate}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                저장
              </button>
              <button
                onClick={cancelEdit}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                개정교육과정
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {filteredItems.length === 0 ? (
              <tr>
                <td colSpan={5} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              filteredItems.map((item) =>
                editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      -
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={item.is_active}
                          onChange={(e) =>
                            updateSubjectCategoryAction(item.id, { is_active: e.target.checked }).then(
                              () => loadItems()
                            )
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {item.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      -
                    </td>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex rounded-full px-2 py-1 text-xs font-medium ${
                          item.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }`}
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                )
              )
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/SubjectsManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getSubjectsAction,
  createSubjectAction,
  updateSubjectAction,
  deleteSubjectAction,
  getSubjectCategoriesAction,
  getCurriculumRevisionsAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { Subject, SubjectCategory, CurriculumRevision } from "@/lib/data/contentMetadata";

export function SubjectsManager() {
  const [items, setItems] = useState<Subject[]>([]);
  const [subjectCategories, setSubjectCategories] = useState<SubjectCategory[]>([]);
  const [revisions, setRevisions] = useState<CurriculumRevision[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>("");
  const [selectedCategoryId, setSelectedCategoryId] = useState<string>("");
  const [formData, setFormData] = useState({ name: "", display_order: 0 });

  useEffect(() => {
    loadRevisions();
    loadItems();
  }, []);

  useEffect(() => {
    if (selectedRevisionId) {
      loadSubjectCategories(selectedRevisionId);
    } else {
      setSubjectCategories([]);
    }
  }, [selectedRevisionId]);

  async function loadRevisions() {
    try {
      const data = await getCurriculumRevisionsAction();
      setRevisions(data);
      if (data.length > 0 && !selectedRevisionId) {
        const firstRevision = data[0];
        if (firstRevision?.id) {
          setSelectedRevisionId(firstRevision.id);
        }
      }
    } catch (error) {
      console.error("개정교육과정 조회 실패:", error);
    }
  }

  async function loadSubjectCategories(revisionId: string) {
    try {
      const data = await getSubjectCategoriesAction(revisionId);
      setSubjectCategories(data);
      if (data.length > 0 && !selectedCategoryId) {
        const firstCategory = data[0];
        if (firstCategory?.id) {
          setSelectedCategoryId(firstCategory.id);
        }
      }
    } catch (error) {
      console.error("교과 조회 실패:", error);
    }
  }

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getSubjectsAction();
      setItems(data);
    } catch (error) {
      console.error("과목 조회 실패:", error);
      alert("과목을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }
    if (!selectedCategoryId) {
      alert("교과를 선택해주세요.");
      return;
    }

    try {
      await createSubjectAction(selectedCategoryId, formData.name, formData.display_order);
      setFormData({ name: "", display_order: 0 });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("과목 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      await updateSubjectAction(id, {
        name: formData.name,
        display_order: formData.display_order,
      });
      setEditingId(null);
      setFormData({ name: "", display_order: 0 });
      loadItems();
    } catch (error) {
      console.error("과목 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deleteSubjectAction(id);
      loadItems();
    } catch (error) {
      console.error("과목 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: Subject) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0 });
    if (item.subject_category_id) {
      setSelectedCategoryId(item.subject_category_id);
    }
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0 });
  }

  // Subject에는 subject_category_id만 있으므로 category로만 필터링
  // TODO: revision_id 관계가 추가되면 revision 필터링 로직 구현
  const filteredItems = selectedCategoryId
    ? items.filter((item) => item.subject_category_id === selectedCategoryId)
    : items;

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="space-y-4">
      {/* 경고 메시지 */}
      <div className="rounded-lg border border-yellow-300 bg-yellow-50 p-4">
        <div className="flex items-start gap-3">
          <div className="text-yellow-600">⚠️</div>
          <div className="flex flex-1 flex-col gap-1">
            <h3 className="text-sm font-semibold text-yellow-800">주의</h3>
            <p className="text-sm text-yellow-700">
              이 페이지는 deprecated된 테이블을 사용합니다. 과목 관리는{" "}
              <a
                href="/admin/subjects"
                className="font-semibold text-yellow-800 underline hover:text-yellow-900"
              >
                교과/과목 관리 페이지
              </a>
              에서 진행해주세요.
            </p>
          </div>
        </div>
      </div>

      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">과목 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            setFormData({ name: "", display_order: 0 });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {/* 필터 */}
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="grid gap-4 md:grid-cols-2">
          <div className="flex flex-col gap-2">
            <label className="block text-sm font-medium text-gray-700">
              개정교육과정 필터
            </label>
            <select
              value={selectedRevisionId}
              onChange={(e) => {
                setSelectedRevisionId(e.target.value);
                setSelectedCategoryId("");
              }}
              className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            >
              <option value="">전체</option>
              {revisions.map((rev) => (
                <option key={rev.id} value={rev.id}>
                  {rev.name}
                </option>
              ))}
            </select>
          </div>
          <div className="flex flex-col gap-2">
            <label className="block text-sm font-medium text-gray-700">교과 필터</label>
            <select
              value={selectedCategoryId}
              onChange={(e) => setSelectedCategoryId(e.target.value)}
              className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              disabled={!selectedRevisionId}
            >
              <option value="">전체</option>
              {subjectCategories.map((cat) => (
                <option key={cat.id} value={cat.id}>
                  {cat.name}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* 생성 폼 */}
      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-4">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                개정교육과정 <span className="text-red-500">*</span>
              </label>
              <select
                value={selectedRevisionId}
                onChange={(e) => {
                  setSelectedRevisionId(e.target.value);
                  setSelectedCategoryId("");
                }}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              >
                <option value="">선택하세요</option>
                {revisions.map((rev) => (
                  <option key={rev.id} value={rev.id}>
                    {rev.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                교과 <span className="text-red-500">*</span>
              </label>
              <select
                value={selectedCategoryId}
                onChange={(e) => setSelectedCategoryId(e.target.value)}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                disabled={!selectedRevisionId}
              >
                <option value="">선택하세요</option>
                {subjectCategories.map((cat) => (
                  <option key={cat.id} value={cat.id}>
                    {cat.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 화법과 작문"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <div className="flex flex-1 flex-col gap-1">
                <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
                <input
                  type="number"
                  value={formData.display_order}
                  onChange={(e) =>
                    setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                  }
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                />
              </div>
              <div className="flex gap-2">
                <button
                  onClick={handleCreate}
                  className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  저장
                </button>
                <button
                  onClick={cancelEdit}
                  className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
                >
                  취소
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                개정교육과정
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                교과
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {filteredItems.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              filteredItems.map((item) =>
                editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      -
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      -
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={item.is_active}
                          onChange={(e) =>
                            updateSubjectAction(item.id, { is_active: e.target.checked }).then(() =>
                              loadItems()
                            )
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {item.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      -
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      -
                    </td>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex rounded-full px-2 py-1 text-xs font-medium ${
                          item.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }`}
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                )
              )
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/_components/SubjectTypesManager.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getSubjectTypesAction,
  createSubjectType,
  updateSubjectType,
  deleteSubjectType,
} from "@/app/(admin)/actions/subjectActions";
import { getCurriculumRevisionsAction } from "@/app/(admin)/actions/contentMetadataActions";
import type { SubjectType } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

export function SubjectTypesManager() {
  const [items, setItems] = useState<SubjectType[]>([]);
  const [revisions, setRevisions] = useState<CurriculumRevision[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>("");
  const [formData, setFormData] = useState({ name: "", display_order: 0, is_active: true });

  useEffect(() => {
    loadRevisions();
    loadItems();
  }, []);

  useEffect(() => {
    if (selectedRevisionId) {
      loadItems();
    }
  }, [selectedRevisionId]);

  async function loadRevisions() {
    try {
      const data = await getCurriculumRevisionsAction();
      setRevisions(data);
      if (data.length > 0 && !selectedRevisionId) {
        const firstRevision = data[0];
        if (firstRevision?.id) {
          setSelectedRevisionId(firstRevision.id);
        }
      }
    } catch (error) {
      console.error("개정교육과정 조회 실패:", error);
    }
  }

  async function loadItems() {
    setLoading(true);
    try {
      const data = await getSubjectTypesAction(selectedRevisionId || undefined);
      setItems(data);
    } catch (error) {
      console.error("과목구분 조회 실패:", error);
      alert("과목구분을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }
    if (!selectedRevisionId) {
      alert("개정교육과정을 선택해주세요.");
      return;
    }

    try {
      const formDataObj = new FormData();
      formDataObj.append("curriculum_revision_id", selectedRevisionId);
      formDataObj.append("name", formData.name);
      formDataObj.append("display_order", formData.display_order.toString());
      formDataObj.append("is_active", formData.is_active ? "true" : "false");

      await createSubjectType(formDataObj);
      setFormData({ name: "", display_order: 0, is_active: true });
      setIsCreating(false);
      loadItems();
    } catch (error) {
      console.error("과목구분 생성 실패:", error);
      alert(error instanceof Error ? error.message : "생성에 실패했습니다.");
    }
  }

  async function handleUpdate(id: string) {
    if (!formData.name.trim()) {
      alert("이름을 입력해주세요.");
      return;
    }

    try {
      const formDataObj = new FormData();
      formDataObj.append("curriculum_revision_id", selectedRevisionId);
      formDataObj.append("name", formData.name);
      formDataObj.append("display_order", formData.display_order.toString());
      formDataObj.append("is_active", formData.is_active ? "true" : "false");

      await updateSubjectType(id, formDataObj);
      setEditingId(null);
      setFormData({ name: "", display_order: 0, is_active: true });
      loadItems();
    } catch (error) {
      console.error("과목구분 수정 실패:", error);
      alert(error instanceof Error ? error.message : "수정에 실패했습니다.");
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      await deleteSubjectType(id);
      loadItems();
    } catch (error) {
      console.error("과목구분 삭제 실패:", error);
      alert(error instanceof Error ? error.message : "삭제에 실패했습니다.");
    }
  }

  function startEdit(item: SubjectType) {
    setEditingId(item.id);
    setFormData({ name: item.name, display_order: item.display_order ?? 0, is_active: item.is_active });
    setSelectedRevisionId(item.curriculum_revision_id);
    setIsCreating(false);
  }

  function cancelEdit() {
    setEditingId(null);
    setIsCreating(false);
    setFormData({ name: "", display_order: 0, is_active: true });
  }

  const filteredItems = selectedRevisionId
    ? items.filter((item) => item.curriculum_revision_id === selectedRevisionId)
    : items;

  if (loading) {
    return <div className="text-center py-8 text-gray-700">로딩 중...</div>;
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">과목구분 관리</h2>
        <button
          onClick={() => {
            setIsCreating(true);
            setEditingId(null);
            setFormData({ name: "", display_order: items.length + 1, is_active: true });
          }}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          + 추가
        </button>
      </div>

      {/* 개정교육과정 필터 */}
      <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white p-4">
        <label className="block text-sm font-medium text-gray-700">
          개정교육과정 필터
        </label>
        <select
          value={selectedRevisionId}
          onChange={(e) => setSelectedRevisionId(e.target.value)}
          className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
        >
          <option value="">전체</option>
          {revisions.map((rev) => (
            <option key={rev.id} value={rev.id}>
              {rev.name}
            </option>
          ))}
        </select>
      </div>

      {/* 생성 폼 */}
      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="grid gap-4 md:grid-cols-4">
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                개정교육과정 <span className="text-red-500">*</span>
              </label>
              <select
                value={selectedRevisionId}
                onChange={(e) => setSelectedRevisionId(e.target.value)}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              >
                <option value="">선택하세요</option>
                {revisions.map((rev) => (
                  <option key={rev.id} value={rev.id}>
                    {rev.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="예: 공통"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">정렬 순서</label>
              <input
                type="number"
                value={formData.display_order}
                onChange={(e) =>
                  setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
              />
            </div>
            <div className="flex items-end gap-2">
              <button
                onClick={handleCreate}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                저장
              </button>
              <button
                onClick={cancelEdit}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                개정교육과정
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                이름
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                정렬 순서
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600">
                상태
              </th>
              <th className="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600">
                작업
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 bg-white">
            {filteredItems.length === 0 ? (
              <tr>
                <td colSpan={5} className="px-6 py-8 text-center text-sm text-gray-700">
                  데이터가 없습니다.
                </td>
              </tr>
            ) : (
              filteredItems.map((item) => {
                const revision = revisions.find((r) => r.id === item.curriculum_revision_id);
                return editingId === item.id ? (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      <select
                        value={selectedRevisionId}
                        onChange={(e) => setSelectedRevisionId(e.target.value)}
                        className="w-full rounded-md border border-gray-300 px-2 py-1 text-sm"
                      >
                        {revisions.map((rev) => (
                          <option key={rev.id} value={rev.id}>
                            {rev.name}
                          </option>
                        ))}
                      </select>
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="text"
                        value={formData.name}
                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        type="number"
                        value={formData.display_order}
                        onChange={(e) =>
                          setFormData({ ...formData, display_order: parseInt(e.target.value) || 0 })
                        }
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={formData.is_active}
                          onChange={(e) =>
                            setFormData({ ...formData, is_active: e.target.checked })
                          }
                          className="rounded border-gray-300"
                        />
                        <span className="text-sm text-gray-700">
                          {formData.is_active ? "활성" : "비활성"}
                        </span>
                      </label>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => handleUpdate(item.id)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          저장
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="rounded-lg border border-gray-300 bg-white px-3 py-1 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                        >
                          취소
                        </button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  <tr key={item.id}>
                    <td className="px-6 py-4 text-sm text-gray-700">
                      {revision?.name || "-"}
                    </td>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{item.name}</td>
                    <td className="px-6 py-4 text-sm text-gray-600">{item.display_order}</td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex rounded-full px-2 py-1 text-xs font-medium ${
                          item.is_active
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-100 text-gray-800"
                        }`}
                      >
                        {item.is_active ? "활성" : "비활성"}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          onClick={() => startEdit(item)}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          수정
                        </button>
                        <button
                          onClick={() => handleDelete(item.id)}
                          className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                        >
                          삭제
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="admin/content-metadata/page.tsx">
import { redirect } from "next/navigation";
import PageContainer from "@/components/layout/PageContainer";
import { PageHeader } from "@/components/layout/PageHeader";
import { ContentMetadataTabs } from "./_components/ContentMetadataTabs";

export default function ContentMetadataPage() {
  return (
    <PageContainer widthType="LIST">
      <div className="flex flex-col gap-6">
        <PageHeader
          title="콘텐츠 메타데이터 관리"
          description="개정교육과정, 학년, 학기, 교과, 과목, 플랫폼, 출판사를 관리합니다."
        />

        {/* Deprecated 경고 */}
        <div className="rounded-lg border border-yellow-300 bg-yellow-50 p-4">
          <div className="flex items-start gap-3">
            <div className="text-yellow-600 text-xl">⚠️</div>
            <div className="flex-1 flex flex-col gap-2">
              <h3 className="text-sm font-semibold text-yellow-800">이 페이지는 Deprecated되었습니다</h3>
              <p className="text-sm text-yellow-700">
                일부 기능은 새로운 페이지로 이동되었습니다. 과목 관리는{" "}
                <a
                  href="/admin/subjects"
                  className="font-semibold text-yellow-800 underline hover:text-yellow-900"
                >
                  교과/과목 관리 페이지
                </a>
                에서 진행해주세요.
              </p>
            </div>
          </div>
        </div>

        <ContentMetadataTabs />
      </div>
    </PageContainer>
  );
}
</file>

<file path="admin/dashboard/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import Link from "next/link";
import { getWeeklyStudyTimeSummary } from "@/lib/reports/weekly";
import { getWeeklyPlanSummary } from "@/lib/reports/weekly";
import { getStudentRiskScore } from "@/lib/risk/engine";
import {
  getCachedStudentStatistics,
  getCachedTopStudents,
  getCachedAtRiskStudents,
  getCachedConsultingNotes,
} from "@/lib/cache/dashboard";
import { PageHeader } from "@/components/layout/PageHeader";
import { StatCard } from "@/components/molecules/StatCard";
import { getWeekRange } from "@/lib/date/weekRange";
import { riskLevelColors, textPrimary, textSecondary, textMuted, bgSurface, borderDefault } from "@/lib/utils/darkMode";
import { cn } from "@/lib/cn";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

// 전체 학생 통계 조회
async function getStudentStatistics(
  supabase: SupabaseServerClient,
  weekStart: Date,
  weekEnd: Date
) {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    // 전체 학생 수
    const { count: totalCount, error: countError } = await supabase
      .from("students")
      .select("*", { count: "exact", head: true });

    if (countError && countError.code === "42703") {
      const { count: retryCount } = await supabase
        .from("students")
        .select("*", { count: "exact", head: true });
      return {
        total: retryCount ?? 0,
        activeThisWeek: 0,
        withScores: 0,
        withPlans: 0,
      };
    }

    const total = totalCount ?? 0;

    // 이번주 학습한 학생 수
    const { data: activeStudents } = await supabase
      .from("student_study_sessions")
      .select("student_id", { count: "exact" })
      .gte("started_at", weekStartStr)
      .lte("started_at", weekEndStr);

    const activeStudentIds = new Set(
      (activeStudents ?? []).map((s: { student_id?: string }) => s.student_id).filter(Boolean)
    );
    const activeThisWeek = activeStudentIds.size;

    // 성적 입력한 학생 수 (두 테이블에서 각각 조회 후 합치기)
    const [schoolScores, mockScores] = await Promise.all([
      supabase.from("student_school_scores").select("student_id"),
      supabase.from("student_mock_scores").select("student_id"),
    ]);

    const studentIdsWithScores = new Set<string>();
    (schoolScores.data ?? []).forEach((s: { student_id?: string }) => {
      if (s.student_id) studentIdsWithScores.add(s.student_id);
    });
    (mockScores.data ?? []).forEach((s: { student_id?: string }) => {
      if (s.student_id) studentIdsWithScores.add(s.student_id);
    });
    const withScores = studentIdsWithScores.size;

    // 이번주 플랜이 있는 학생 수
    const { data: plansData } = await supabase
      .from("student_plan")
      .select("student_id")
      .gte("plan_date", weekStartStr)
      .lte("plan_date", weekEndStr);

    const studentIdsWithPlans = new Set(
      (plansData ?? []).map((p: { student_id?: string }) => p.student_id).filter(Boolean)
    );
    const withPlans = studentIdsWithPlans.size;

    return {
      total,
      activeThisWeek,
      withScores,
      withPlans,
    };
  } catch (error) {
    console.error("[admin/dashboard] 학생 통계 조회 실패", error);
    return {
      total: 0,
      activeThisWeek: 0,
      withScores: 0,
      withPlans: 0,
    };
  }
}

// 이번주 학습시간 Top5
async function getTopStudyTimeStudents(
  supabase: SupabaseServerClient,
  weekStart: Date,
  weekEnd: Date
) {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const { data: sessions, error } = await supabase
      .from("student_study_sessions")
      .select("student_id,duration_seconds")
      .gte("started_at", weekStartStr)
      .lte("started_at", weekEndStr);

    if (error && error.code === "42703") {
      return [];
    }

    if (error) throw error;

    // 학생별 학습시간 집계
    const studentTimeMap = new Map<string, number>();
    (sessions ?? []).forEach((s: { student_id?: string; duration_seconds?: number | null }) => {
      if (!s.student_id || !s.duration_seconds) return;
      const current = studentTimeMap.get(s.student_id) ?? 0;
      studentTimeMap.set(s.student_id, current + s.duration_seconds);
    });

    // Top5 추출
    const topStudents = Array.from(studentTimeMap.entries())
      .map(([studentId, seconds]) => ({ studentId, minutes: Math.floor(seconds / 60) }))
      .sort((a, b) => b.minutes - a.minutes)
      .slice(0, 5);

    // 학생 이름 배치 조회 (N+1 문제 해결)
    if (topStudents.length === 0) return [];

    const studentIds = topStudents.map((s) => s.studentId);
    const { data: students } = await supabase
      .from("students")
      .select("id,name")
      .in("id", studentIds);

    const studentMap = new Map(
      (students ?? []).map((s: { id: string; name?: string | null }) => [
        s.id,
        s.name ?? "이름 없음",
      ])
    );

    return topStudents.map((s) => ({
      studentId: s.studentId,
      name: studentMap.get(s.studentId) ?? "이름 없음",
      minutes: s.minutes,
    }));
  } catch (error) {
    console.error("[admin/dashboard] 학습시간 Top5 조회 실패", error);
    return [];
  }
}

// 이번주 플랜 실행률 Top5
async function getTopPlanCompletionStudents(
  supabase: SupabaseServerClient,
  weekStart: Date,
  weekEnd: Date
) {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const { data: plans, error } = await supabase
      .from("student_plan")
      .select("student_id,completed_amount")
      .gte("plan_date", weekStartStr)
      .lte("plan_date", weekEndStr);

    if (error && error.code === "42703") {
      return [];
    }

    if (error) throw error;

    // 학생별 플랜 집계
    const studentPlanMap = new Map<
      string,
      { total: number; completed: number }
    >();
    (plans ?? []).forEach(
      (p: { student_id?: string; completed_amount?: number | null }) => {
        if (!p.student_id) return;
        const current = studentPlanMap.get(p.student_id) ?? { total: 0, completed: 0 };
        current.total++;
        if (p.completed_amount !== null && p.completed_amount !== undefined && p.completed_amount > 0) {
          current.completed++;
        }
        studentPlanMap.set(p.student_id, current);
      }
    );

    // 실행률 계산 및 Top5 추출
    const topStudents = Array.from(studentPlanMap.entries())
      .map(([studentId, data]) => ({
        studentId,
        completionRate:
          data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0,
      }))
      .sort((a, b) => b.completionRate - a.completionRate)
      .slice(0, 5);

    // 학생 이름 배치 조회 (N+1 문제 해결)
    if (topStudents.length === 0) return [];

    const studentIds = topStudents.map((s) => s.studentId);
    const { data: students } = await supabase
      .from("students")
      .select("id,name")
      .in("id", studentIds);

    const studentMap = new Map(
      (students ?? []).map((s: { id: string; name?: string | null }) => [
        s.id,
        s.name ?? "이름 없음",
      ])
    );

    return topStudents.map((s) => ({
      studentId: s.studentId,
      name: studentMap.get(s.studentId) ?? "이름 없음",
      completionRate: s.completionRate,
    }));
  } catch (error) {
    console.error("[admin/dashboard] 플랜 실행률 Top5 조회 실패", error);
    return [];
  }
}

// 최근 목표 달성 학생 Top3
async function getTopGoalAchievementStudents(supabase: SupabaseServerClient) {
  try {
    const { data: history, error } = await supabase
      .from("student_history")
      .select("student_id,created_at")
      .eq("event_type", "goal_completed")
      .order("created_at", { ascending: false })
      .limit(10);

    if (error && error.code === "42703") {
      return [];
    }

    if (error) throw error;

    // 학생별 달성 횟수 집계
    const studentCountMap = new Map<string, number>();
    (history ?? []).forEach((h: { student_id?: string }) => {
      if (!h.student_id) return;
      const current = studentCountMap.get(h.student_id) ?? 0;
      studentCountMap.set(h.student_id, current + 1);
    });

    // Top3 추출
    const topStudents = Array.from(studentCountMap.entries())
      .map(([studentId, count]) => ({ studentId, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 3);

    // 학생 이름 배치 조회 (N+1 문제 해결)
    if (topStudents.length === 0) return [];

    const studentIds = topStudents.map((s) => s.studentId);
    const { data: students } = await supabase
      .from("students")
      .select("id,name")
      .in("id", studentIds);

    const studentMap = new Map(
      (students ?? []).map((s: { id: string; name?: string | null }) => [
        s.id,
        s.name ?? "이름 없음",
      ])
    );

    return topStudents.map((s) => ({
      studentId: s.studentId,
      name: studentMap.get(s.studentId) ?? "이름 없음",
      count: s.count,
    }));
  } catch (error) {
    console.error("[admin/dashboard] 목표 달성 Top3 조회 실패", error);
    return [];
  }
}

// 위험 학생 조회 (Risk Engine 사용)
async function getAtRiskStudents(supabase: SupabaseServerClient) {
  try {
    // 모든 학생 조회
    const { data: students, error } = await supabase
      .from("students")
      .select("id,name");

    if (error && error.code === "42703") {
      const { data: retryStudents } = await supabase.from("students").select("id,name");
      if (!retryStudents) return [];
      const studentRows = retryStudents as Array<{ id: string; name?: string | null }>;
      const riskResults = await Promise.all(
        studentRows.map(async (student) => {
          try {
            const risk = await getStudentRiskScore(supabase, student.id);
            return {
              studentId: student.id,
              name: student.name ?? "이름 없음",
              riskScore: risk.riskScore,
              level: risk.level,
              reasons: risk.reasons,
            };
          } catch (err) {
            console.error(`[admin/dashboard] 학생 ${student.id} 위험 점수 계산 실패`, err);
            return null;
          }
        })
      );
      return riskResults.filter((r): r is NonNullable<typeof r> => r !== null);
    }

    if (error) throw error;

    const studentRows = (students as Array<{ id: string; name?: string | null }> | null) ?? [];

    // 각 학생의 위험 점수 계산 (병렬 처리)
    const riskResults = await Promise.all(
      studentRows.map(async (student) => {
        try {
          const risk = await getStudentRiskScore(supabase, student.id);
          return {
            studentId: student.id,
            name: student.name ?? "이름 없음",
            riskScore: risk.riskScore,
            level: risk.level,
            reasons: risk.reasons,
          };
        } catch (err) {
          console.error(`[admin/dashboard] 학생 ${student.id} 위험 점수 계산 실패`, err);
          return null;
        }
      })
    );

    // null 제거 및 위험 점수 순으로 정렬 (높은 순)
    return riskResults
      .filter((r): r is NonNullable<typeof riskResults[0]> => r !== null)
      .sort((a, b) => b.riskScore - a.riskScore)
      .slice(0, 5); // 상위 5명만 반환
  } catch (error) {
    console.error("[admin/dashboard] 위험 학생 조회 실패", error);
    return [];
  }
}

// 최근 상담노트 조회
async function getRecentConsultingNotes(supabase: SupabaseServerClient) {
  try {
    const { data: notes, error } = await supabase
      .from("student_consulting_notes")
      .select("id,student_id,note,created_at")
      .order("created_at", { ascending: false })
      .limit(5);

    if (error && error.code === "42703") {
      return [];
    }

    if (error) throw error;

    // 학생 이름 배치 조회 (N+1 문제 해결)
    const studentIds = (notes ?? []).map(
      (n: { student_id?: string }) => n.student_id
    ).filter(Boolean) as string[];
    
    if (studentIds.length === 0) {
      return (notes ?? []).map((n: {
        id: string;
        student_id?: string;
        note?: string | null;
        created_at?: string | null;
      }) => ({
        id: n.id,
        studentId: n.student_id ?? "",
        studentName: "이름 없음",
        note: n.note ?? "",
        createdAt: n.created_at ?? "",
      }));
    }

    const { data: students } = await supabase
      .from("students")
      .select("id,name")
      .in("id", studentIds);

    const studentMap = new Map(
      (students ?? []).map((s: { id: string; name?: string | null }) => [
        s.id,
        s.name ?? "이름 없음",
      ])
    );

    return (notes ?? []).map((n: {
      id: string;
      student_id?: string;
      note?: string | null;
      created_at?: string | null;
    }) => ({
      id: n.id,
      studentId: n.student_id ?? "",
      studentName: studentMap.get(n.student_id ?? "") ?? "이름 없음",
      note: n.note ?? "",
      createdAt: n.created_at ?? "",
    }));
  } catch (error) {
    console.error("[admin/dashboard] 최근 상담노트 조회 실패", error);
    return [];
  }
}

export default async function AdminDashboardPage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const { weekStart, weekEnd } = getWeekRange();

  // 캐싱을 적용한 데이터 조회
  const [
    studentStats,
    topStudyTime,
    topPlanCompletion,
    topGoalAchievement,
    atRiskStudents,
    recentNotes,
  ] = await Promise.all([
    getCachedStudentStatistics(
      supabase,
      weekStart,
      weekEnd,
      getStudentStatistics
    ),
    getCachedTopStudents(
      `dashboard-top-study-time-${weekStart.toISOString()}-${weekEnd.toISOString()}`,
      () => getTopStudyTimeStudents(supabase, weekStart, weekEnd)
    ),
    getCachedTopStudents(
      `dashboard-top-plan-completion-${weekStart.toISOString()}-${weekEnd.toISOString()}`,
      () => getTopPlanCompletionStudents(supabase, weekStart, weekEnd)
    ),
    getCachedTopStudents(
      "dashboard-top-goal-achievement",
      () => getTopGoalAchievementStudents(supabase)
    ),
    getCachedAtRiskStudents(() => getAtRiskStudents(supabase)),
    getCachedConsultingNotes(() => getRecentConsultingNotes(supabase)),
  ]);

  return (
    <div className="p-6 md:p-8 lg:p-10">
      <div className="flex flex-col gap-6 md:gap-8">
        <PageHeader
          title="관리자 대시보드"
          description="전체 학생 현황과 주요 지표를 확인하세요"
        />

        {/* KPI 카드 */}
        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div className="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 md:p-6 shadow-sm hover:shadow-md transition-shadow">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-gray-500 dark:text-gray-400">전체 학생 수</div>
              <div className="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100">{studentStats.total}</div>
            </div>
          </div>
          <div className="rounded-xl border border-indigo-200 dark:border-indigo-800 bg-gradient-to-br from-indigo-50 to-indigo-100/50 dark:from-indigo-900/30 dark:to-indigo-800/20 p-5 md:p-6 shadow-sm hover:shadow-md transition-shadow">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-indigo-700 dark:text-indigo-300">이번주 학습한 학생</div>
              <div className="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400">
                {studentStats.activeThisWeek}
              </div>
              <div className="text-xs font-medium text-indigo-600 dark:text-indigo-400">
                {studentStats.total > 0
                  ? Math.round((studentStats.activeThisWeek / studentStats.total) * 100)
                  : 0}
                % 활성
              </div>
            </div>
          </div>
          <div className="rounded-xl border border-green-200 dark:border-green-800 bg-gradient-to-br from-green-50 to-green-100/50 dark:from-green-900/30 dark:to-green-800/20 p-5 md:p-6 shadow-sm hover:shadow-md transition-shadow">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-green-700 dark:text-green-300">성적 입력 학생</div>
              <div className="text-3xl md:text-4xl font-bold text-green-600 dark:text-green-400">{studentStats.withScores}</div>
              <div className="text-xs font-medium text-green-600 dark:text-green-400">
                {studentStats.total > 0
                  ? Math.round((studentStats.withScores / studentStats.total) * 100)
                  : 0}
                % 입력
              </div>
            </div>
          </div>
          <div className="rounded-xl border border-purple-200 dark:border-purple-800 bg-gradient-to-br from-purple-50 to-purple-100/50 dark:from-purple-900/30 dark:to-purple-800/20 p-5 md:p-6 shadow-sm hover:shadow-md transition-shadow">
            <div className="flex flex-col gap-1">
              <div className="text-sm font-medium text-purple-700 dark:text-purple-300">이번주 플랜 학생</div>
              <div className="text-3xl md:text-4xl font-bold text-purple-600 dark:text-purple-400">{studentStats.withPlans}</div>
              <div className="text-xs font-medium text-purple-600 dark:text-purple-400">
                {studentStats.total > 0
                  ? Math.round((studentStats.withPlans / studentStats.total) * 100)
                  : 0}
                % 계획
              </div>
            </div>
          </div>
        </div>

        {/* 이번주 학습시간 Top5 */}
        <div className="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 md:p-6 shadow-sm">
          <div className="flex flex-col gap-4">
            <h2 className="text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100">이번주 학습시간 Top5</h2>
            {topStudyTime.length === 0 ? (
              <p className="text-sm text-gray-500 dark:text-gray-400">데이터가 없습니다.</p>
            ) : (
              <div className="flex flex-col gap-2">
                {topStudyTime.map((student, index) => (
                  <Link
                    key={student.studentId}
                    href={`/admin/students/${student.studentId}`}
                    className="flex items-center justify-between rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 transition hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-sm"
                  >
                    <div className="flex items-center gap-3">
                      <span className="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-sm font-semibold text-indigo-700 dark:text-indigo-300">
                        {index + 1}
                      </span>
                      <span className="font-medium text-gray-900 dark:text-gray-100">{student.name}</span>
                    </div>
                    <span className="text-sm text-gray-600 dark:text-gray-400">{student.minutes}분</span>
                  </Link>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* 이번주 플랜 실행률 Top5 */}
        <div className="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 md:p-6 shadow-sm">
          <div className="flex flex-col gap-4">
            <h2 className="text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100">이번주 플랜 실행률 Top5</h2>
            {topPlanCompletion.length === 0 ? (
              <p className="text-sm text-gray-500 dark:text-gray-400">데이터가 없습니다.</p>
            ) : (
              <div className="flex flex-col gap-2">
                {topPlanCompletion.map((student, index) => (
                  <Link
                    key={student.studentId}
                    href={`/admin/students/${student.studentId}`}
                    className="flex items-center justify-between rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 transition hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-sm"
                  >
                    <div className="flex items-center gap-3">
                      <span className="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-sm font-semibold text-indigo-700 dark:text-indigo-300">
                        {index + 1}
                      </span>
                      <span className="font-medium text-gray-900 dark:text-gray-100">{student.name}</span>
                    </div>
                    <span className="text-sm font-semibold text-gray-900 dark:text-gray-100">
                      {student.completionRate}%
                    </span>
                  </Link>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* 최근 목표 달성 Top3 */}
        <div className="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 md:p-6 shadow-sm">
          <div className="flex flex-col gap-4">
            <h2 className="text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100">최근 목표 달성 Top3</h2>
            {topGoalAchievement.length === 0 ? (
              <p className="text-sm text-gray-500 dark:text-gray-400">데이터가 없습니다.</p>
            ) : (
              <div className="flex flex-col gap-2">
                {topGoalAchievement.map((student, index) => (
                  <Link
                    key={student.studentId}
                    href={`/admin/students/${student.studentId}`}
                    className="flex items-center justify-between rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-3 transition hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-sm"
                  >
                    <div className="flex items-center gap-3">
                      <span className="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30 text-sm font-semibold text-green-700 dark:text-green-300">
                        {index + 1}
                      </span>
                      <span className="font-medium text-gray-900 dark:text-gray-100">{student.name}</span>
                    </div>
                    <span className="text-sm text-gray-600 dark:text-gray-400">{student.count}개 달성</span>
                  </Link>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* 위험 학생 리스트 */}
        <div className={cn(
          "rounded-xl border p-5 md:p-6 shadow-sm",
          "border-red-200 dark:border-red-800",
          "bg-gradient-to-br from-red-50 to-red-100/50",
          "dark:from-red-900/30 dark:to-red-800/20"
        )}>
          <div className="flex flex-col gap-4">
            <h2 className={cn("text-lg md:text-xl font-semibold", "text-red-900 dark:text-red-300")}>🚨 위험 학생 리스트</h2>
            {atRiskStudents.length === 0 ? (
              <p className={cn("text-sm", "text-red-600 dark:text-red-400")}>위험 학생이 없습니다.</p>
            ) : (
              <div className="flex flex-col gap-2">
                {atRiskStudents.map((student) => {
                  const levelLabels = {
                    high: "높음",
                    medium: "보통",
                    low: "낮음",
                  };
                  return (
                    <Link
                      key={student.studentId}
                      href={`/admin/students/${student.studentId}`}
                      className={cn(
                        "flex items-center gap-4 rounded-lg border p-3 transition",
                        "border-red-200 dark:border-red-800",
                        bgSurface,
                        "hover:bg-red-50 dark:hover:bg-red-900/30"
                      )}
                    >
                      <div className="flex items-center gap-3">
                        <span
                          className={cn("rounded-full px-2 py-1 text-xs font-semibold", riskLevelColors[student.level])}
                        >
                          {levelLabels[student.level]}
                        </span>
                        <span className={cn("font-medium", textPrimary)}>{student.name}</span>
                        <span className={cn("text-xs", textMuted)}>({student.riskScore}점)</span>
                      </div>
                      <div className="flex-1">
                        <p className={cn("text-sm line-clamp-2", "text-red-600 dark:text-red-400")}>
                          {student.reasons.length > 0
                            ? student.reasons[0]
                            : "위험 요인 없음"}
                        </p>
                      </div>
                    </Link>
                  );
                })}
              </div>
            )}
          </div>
        </div>

        {/* 최근 상담노트 */}
        <div className="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-5 md:p-6 shadow-sm">
          <div className="flex flex-col gap-4">
            <h2 className="text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100">최근 상담노트</h2>
            {recentNotes.length === 0 ? (
              <p className="text-sm text-gray-500 dark:text-gray-400">상담노트가 없습니다.</p>
            ) : (
              <div className="flex flex-col gap-3">
                {recentNotes.map((note) => (
                  <Link
                    key={note.id}
                    href={`/admin/students/${note.studentId}`}
                    className="block rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 transition hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-sm"
                  >
                    <div className="flex items-center justify-between gap-2">
                      <span className="font-medium text-gray-900 dark:text-gray-100">{note.studentName}</span>
                      <span className="text-xs text-gray-500 dark:text-gray-400">
                        {new Date(note.createdAt).toLocaleDateString("ko-KR")}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">{note.note}</p>
                  </Link>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/master-books/_components/ExcelActions.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { exportMasterBooksToExcel, downloadMasterBooksTemplate } from "@/app/(admin)/actions/masterBooks/export";
import { importMasterBooksFromExcel } from "@/app/(admin)/actions/masterBooks/import";
import ExcelImportDialog from "@/components/admin/ExcelImportDialog";
import Button from "@/components/atoms/Button";

export default function ExcelActions() {
  const toast = useToast();
  const [showImportDialog, setShowImportDialog] = useState(false);
  const [isExporting, setIsExporting] = useState(false);

  async function handleExport() {
    setIsExporting(true);
    try {
      const buffer = await exportMasterBooksToExcel();
      const blob = new Blob([buffer as any], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `교재관리_${new Date().toISOString().split("T")[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.showSuccess("Excel 파일을 다운로드했습니다.");
    } catch (error) {
      console.error("Excel 다운로드 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "Excel 파일 다운로드에 실패했습니다."
      );
    } finally {
      setIsExporting(false);
    }
  }

  async function handleDownloadTemplate() {
    setIsExporting(true);
    try {
      const buffer = await downloadMasterBooksTemplate();
      const blob = new Blob([buffer as any], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "교재관리_양식.xlsx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.showSuccess("양식 파일을 다운로드했습니다.");
    } catch (error) {
      console.error("양식 다운로드 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "양식 파일 다운로드에 실패했습니다."
      );
    } finally {
      setIsExporting(false);
    }
  }

  async function handleImport(file: File): Promise<{ success: boolean; message: string; errors?: string[] }> {
    const arrayBuffer = await file.arrayBuffer();
    const uint8Array = new Uint8Array(arrayBuffer);
    return importMasterBooksFromExcel(uint8Array as any);
  }

  return (
    <>
      <div className="flex gap-2">
        <Button
          variant="outline"
          size="sm"
          onClick={handleDownloadTemplate}
          isLoading={isExporting}
        >
          양식 다운로드
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={handleExport}
          isLoading={isExporting}
        >
          Excel 다운로드
        </Button>
        <Button
          variant="primary"
          size="sm"
          onClick={() => setShowImportDialog(true)}
        >
          Excel 업로드
        </Button>
      </div>

      <ExcelImportDialog
        open={showImportDialog}
        onOpenChange={setShowImportDialog}
        onImport={handleImport}
        title="교재 관리 Excel 업로드"
        description="Excel 파일을 선택하여 교재 데이터를 업로드하세요. 기존 데이터는 모두 삭제되고 새 데이터로 교체됩니다."
      />
    </>
  );
}
</file>

<file path="admin/master-books/[id]/edit/MasterBookEditForm.tsx">
"use client";

import Link from "next/link";
import Image from "next/image";
import { useTransition, useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { updateMasterBookAction } from "@/app/(student)/actions/masterContentActions";
import { getSubjectGroupsWithSubjectsAction } from "@/app/(admin)/actions/subjectActions";
import { MasterBook, BookDetail } from "@/lib/types/plan";
import { BookDetailsManager } from "@/app/(student)/contents/_components/BookDetailsManager";
import type { Subject, SubjectGroup } from "@/lib/data/subjects";
import type { Publisher, CurriculumRevision } from "@/lib/data/contentMetadata";

type MasterBookEditFormProps = {
  book: MasterBook;
  details: BookDetail[];
  curriculumRevisions: CurriculumRevision[];
  publishers: Publisher[];
  currentSubject: (Subject & { subjectGroup: SubjectGroup }) | null;
};

export function MasterBookEditForm({
  book,
  details,
  curriculumRevisions,
  publishers,
  currentSubject,
}: MasterBookEditFormProps) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>(
    book.curriculum_revision_id || ""
  );
  const [selectedGroupId, setSelectedGroupId] = useState<string>(
    currentSubject?.subjectGroup.id || ""
  );
  const [selectedSubjectId, setSelectedSubjectId] = useState<string>(
    book.subject_id || ""
  );
  const [selectedSubjects, setSelectedSubjects] = useState<Subject[]>([]);
  const [subjectGroups, setSubjectGroups] = useState<(SubjectGroup & { subjects: Subject[] })[]>([]);
  const [loadingGroups, setLoadingGroups] = useState(false);

  // 초기 교과 그룹 목록 로드
  useEffect(() => {
    async function loadInitialGroups() {
      if (book.curriculum_revision_id) {
        setLoadingGroups(true);
        try {
          const groups = await getSubjectGroupsWithSubjectsAction(book.curriculum_revision_id);
          setSubjectGroups(groups);
          
          // book.subject_id로 교과 그룹과 과목 찾기
          if (book.subject_id) {
            for (const group of groups) {
              const foundSubject = group.subjects.find(s => s.id === book.subject_id);
              if (foundSubject) {
                setSelectedGroupId(group.id);
                setSelectedSubjects(group.subjects || []);
                setSelectedSubjectId(book.subject_id);
                break;
              }
            }
          }
          // currentSubject가 있으면 우선 사용 (fallback)
          else if (currentSubject) {
            const group = groups.find(g => g.id === currentSubject.subjectGroup.id);
            if (group) {
              setSelectedGroupId(group.id);
              setSelectedSubjects(group.subjects || []);
              setSelectedSubjectId(currentSubject.id);
            }
          }
        } catch (error) {
          console.error("교과 그룹 조회 실패:", error);
          setSubjectGroups([]);
        } finally {
          setLoadingGroups(false);
        }
      }
    }
    loadInitialGroups();
  }, [book.curriculum_revision_id, book.subject_id, currentSubject]);

  // 개정교육과정 선택 시 해당 개정교육과정의 교과 그룹 목록 조회
  async function handleCurriculumRevisionChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const revisionName = e.target.value;
    const selectedRevision = curriculumRevisions.find(r => r.name === revisionName);
    
    // 교과 그룹과 과목 선택 초기화 (기존 과목은 유지하지 않음)
    setSelectedGroupId("");
    setSelectedSubjectId("");
    setSelectedSubjects([]);
    
    if (selectedRevision) {
      setSelectedRevisionId(selectedRevision.id);
      setLoadingGroups(true);
      
      try {
        const groups = await getSubjectGroupsWithSubjectsAction(selectedRevision.id);
        setSubjectGroups(groups);
      } catch (error) {
        console.error("교과 그룹 조회 실패:", error);
        setSubjectGroups([]);
      } finally {
        setLoadingGroups(false);
      }
    } else {
      setSelectedRevisionId("");
      setSubjectGroups([]);
    }
  }

  // 교과 그룹 선택 시 해당 그룹의 과목 목록 업데이트
  function handleSubjectGroupChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const groupId = e.target.value;
    setSelectedGroupId(groupId);
    setSelectedSubjectId(""); // 과목 선택 초기화
    
    if (groupId) {
      const group = subjectGroups.find(g => g.id === groupId);
      setSelectedSubjects(group?.subjects || []);
    } else {
      setSelectedSubjects([]);
    }
  }

  // 과목 선택 시 처리 (개정교육과정 패턴과 동일)
  function handleSubjectChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const subjectName = e.target.value;
    const selectedSubject = selectedSubjects.find(s => s.name === subjectName);
    setSelectedSubjectId(selectedSubject?.id || "");
  }

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    // 교과 그룹 정보 추가 (denormalize)
    if (selectedGroupId) {
      const selectedGroup = subjectGroups.find(g => g.id === selectedGroupId);
      if (selectedGroup) {
        formData.set("subject_group_id", selectedGroup.id);
        formData.set("subject_category", selectedGroup.name);
      }
    }

    // 과목 정보 추가 (denormalize)
    if (selectedSubjectId) {
      const selectedSubject = selectedSubjects.find(s => s.id === selectedSubjectId);
      if (selectedSubject) {
        formData.set("subject", selectedSubject.name);
      }
    }

    startTransition(async () => {
      try {
        await updateMasterBookAction(book.id, formData);
      } catch (error) {
        console.error("교재 수정 실패:", error);
        alert(
          error instanceof Error ? error.message : "교재 수정에 실패했습니다."
        );
      }
    });
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm"
    >
      <div className="grid gap-4 md:grid-cols-2">
        {/* 교재명 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-900">
            교재명 <span className="text-red-500">*</span>
          </label>
          <input
            name="title"
            required
            defaultValue={book.title}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 개정교육과정 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            개정교육과정
          </label>
          <select
            name="revision"
            value={curriculumRevisions.find(r => r.id === selectedRevisionId)?.name || book.revision || ""}
            onChange={handleCurriculumRevisionChange}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.name}>
                {revision.name}
              </option>
            ))}
          </select>
          {/* curriculum_revision_id를 hidden input으로 전송 */}
          <input type="hidden" name="curriculum_revision_id" value={selectedRevisionId} />
        </div>

        {/* 교과 그룹 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            교과 그룹
          </label>
          <select
            value={selectedGroupId}
            onChange={handleSubjectGroupChange}
            disabled={!selectedRevisionId || loadingGroups}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed disabled:text-gray-600"
          >
            <option value="">
              {loadingGroups
                ? "로딩 중..."
                : !selectedRevisionId
                ? "개정교육과정을 먼저 선택하세요"
                : "선택하세요"}
            </option>
            {subjectGroups.map((group) => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
          {!selectedRevisionId && (
            <p className="text-xs text-gray-900">
              개정교육과정을 먼저 선택하세요
            </p>
          )}
        </div>

        {/* 과목 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            과목
          </label>
          <select
            value={selectedSubjects.find(s => s.id === selectedSubjectId)?.name || ""}
            onChange={handleSubjectChange}
            disabled={!selectedGroupId || loadingGroups}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100 disabled:text-gray-600"
          >
            <option value="">선택하세요</option>
            {selectedSubjects.map((subject) => (
              <option key={subject.id} value={subject.name}>
                {subject.name}
              </option>
            ))}
          </select>
          {/* subject_id를 hidden input으로 전송 */}
          <input type="hidden" name="subject_id" value={selectedSubjectId} />
          <p className="text-xs text-gray-900">
            {!selectedRevisionId
              ? "개정교육과정과 교과 그룹을 먼저 선택하세요"
              : !selectedGroupId
              ? "교과 그룹을 먼저 선택하세요"
              : ""}
          </p>
        </div>

        {/* 출판사 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            출판사
          </label>
          <select
            name="publisher_id"
            defaultValue={book.publisher_id || ""}
            onChange={(e) => {
              // publisher_id 변경 시 publisher_name도 자동 설정
              const selectedPublisher = publishers.find(p => p.id === e.target.value);
              const publisherNameInput = document.querySelector('input[name="publisher_name"]') as HTMLInputElement;
              if (publisherNameInput && selectedPublisher) {
                publisherNameInput.value = selectedPublisher.name;
              }
            }}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {publishers.map((publisher) => (
              <option key={publisher.id} value={publisher.id}>
                {publisher.name}
              </option>
            ))}
          </select>
        </div>

        {/* 출판사명 (숨김 필드, 자동 설정됨) */}
        <input type="hidden" name="publisher_name" defaultValue={book.publisher_name || ""} />

        {/* 저자 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            저자
          </label>
          <input
            name="author"
            defaultValue={book.author || ""}
            placeholder="저자명을 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 학교 유형 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            학교 유형
          </label>
          <select
            name="school_type"
            defaultValue={book.school_type || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="MIDDLE">중학교</option>
            <option value="HIGH">고등학교</option>
            <option value="OTHER">기타</option>
          </select>
        </div>

        {/* 최소 학년 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            최소 학년
          </label>
          <select
            name="grade_min"
            defaultValue={book.grade_min || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="1">1학년</option>
            <option value="2">2학년</option>
            <option value="3">3학년</option>
          </select>
        </div>

        {/* 최대 학년 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            최대 학년
          </label>
          <select
            name="grade_max"
            defaultValue={book.grade_max || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="1">1학년</option>
            <option value="2">2학년</option>
            <option value="3">3학년</option>
          </select>
        </div>

        {/* 총 페이지 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            총 페이지
          </label>
          <input
            name="total_pages"
            type="number"
            min="1"
            defaultValue={book.total_pages || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 난이도 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-900">
            난이도
          </label>
          <select
            name="difficulty_level"
            defaultValue={book.difficulty_level || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="개념">개념</option>
            <option value="기본">기본</option>
            <option value="심화">심화</option>
          </select>
        </div>

        {/* 대상 시험 유형 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-900">
            대상 시험 유형
          </label>
          <div className="flex flex-wrap gap-3">
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="수능"
                defaultChecked={book.target_exam_type?.includes("수능")}
                className="rounded border-gray-300"
              />
              <span className="text-sm text-gray-900">수능</span>
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="내신"
                defaultChecked={book.target_exam_type?.includes("내신")}
                className="rounded border-gray-300"
              />
              <span className="text-sm text-gray-900">내신</span>
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="모의고사"
                defaultChecked={book.target_exam_type?.includes("모의고사")}
                className="rounded border-gray-300"
              />
              <span className="text-sm text-gray-900">모의고사</span>
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="특목고입시"
                defaultChecked={book.target_exam_type?.includes("특목고입시")}
                className="rounded border-gray-300"
              />
              <span className="text-sm text-gray-900">특목고입시</span>
            </label>
          </div>
          <p className="text-xs text-gray-900">
            해당하는 시험 유형을 모두 선택하세요
          </p>
        </div>

        {/* 태그 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-900">
            태그
          </label>
          <input
            name="tags"
            defaultValue={book.tags?.join(", ") || ""}
            placeholder="태그를 쉼표로 구분하여 입력하세요 (예: 기출문제, 실전모의고사, 핵심개념)"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
          <p className="text-xs text-gray-900">
            쉼표(,)로 구분하여 여러 태그를 입력할 수 있습니다
          </p>
        </div>

        {/* 표지 이미지 URL */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-900">
            표지 이미지 URL
          </label>
          <input
            name="cover_image_url"
            type="url"
            defaultValue={book.cover_image_url || ""}
            placeholder="https://example.com/image.jpg"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
          {book.cover_image_url && (
            <div className="flex flex-col gap-2 pt-3">
              <p className="text-xs text-gray-900">현재 이미지 미리보기:</p>
              <div className="relative h-48 w-32 overflow-hidden rounded-lg border border-gray-200 bg-gray-100">
                <Image
                  src={book.cover_image_url}
                  alt={`${book.title} 표지`}
                  fill
                  className="object-cover"
                  sizes="128px"
                />
              </div>
            </div>
          )}
          <p className="text-xs text-gray-900">
            교재 표지 이미지의 URL을 입력하세요
          </p>
        </div>

        {/* 메모 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-900">
            메모
          </label>
          <textarea
            name="notes"
            rows={3}
            defaultValue={book.notes || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>
      </div>

      {/* 교재 상세 정보 */}
      <BookDetailsManager initialDetails={details.map(d => ({ ...d, book_id: book.id }))} />

      {/* 버튼 */}
      <div className="flex gap-3">
        <button
          type="submit"
          disabled={isPending}
          className="flex-1 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
        >
          {isPending ? "수정 중..." : "변경사항 저장"}
        </button>
        <Link
          href={`/admin/master-books/${book.id}`}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-900 transition hover:bg-gray-50"
        >
          취소
        </Link>
      </div>
    </form>
  );
}
</file>

<file path="admin/master-books/[id]/edit/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getMasterBookById } from "@/lib/data/contentMasters";
import { getSubjectById } from "@/lib/data/subjects";
import { getPublishers, getCurriculumRevisions } from "@/lib/data/contentMetadata";
import { MasterBookEditForm } from "./MasterBookEditForm";

export default async function EditMasterBookPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { book, details } = await getMasterBookById(id);

  if (!book) notFound();

  // 데이터 조회
  const [curriculumRevisions, publishers, currentSubject] = await Promise.all([
    getCurriculumRevisions().catch(() => []),
    getPublishers().catch(() => []),
    book.subject_id ? getSubjectById(book.subject_id).catch(() => null) : Promise.resolve(null),
  ]);

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-900">서비스 마스터</p>
            <h1 className="text-h1 text-gray-900">교재 수정</h1>
          </div>
          <Link
            href={`/admin/master-books/${id}`}
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-900 transition hover:bg-gray-50"
          >
            취소
          </Link>
        </div>

        <MasterBookEditForm 
          book={book} 
          details={details}
          curriculumRevisions={curriculumRevisions}
          publishers={publishers}
          currentSubject={currentSubject}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/master-books/[id]/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getMasterBookById, deleteMasterBook } from "@/lib/data/contentMasters";
import { ContentHeader } from "@/app/(student)/contents/_components/ContentHeader";
import { ContentDetailTable } from "@/app/(student)/contents/_components/ContentDetailTable";
import { ContentActionButtons } from "@/app/(student)/contents/_components/ContentActionButtons";
import { BookDetailsDisplay } from "@/app/(student)/contents/_components/BookDetailsDisplay";

export default async function MasterBookDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const { role } = await getCurrentUserRole();

  // 교재 조회
  const { book, details } = await getMasterBookById(id);

  if (!book) notFound();

  // 삭제 액션
  const deleteAction = async () => {
    "use server";
    await deleteMasterBook(id);
    redirect("/admin/master-books");
  };

  return (
    <section className="mx-auto w-full max-w-3xl px-4 py-10">
      <div className="rounded-2xl border bg-white p-8 shadow-sm">
        <ContentHeader
          title={book.title}
          subtitle={book.publisher || ""}
          icon="📚 교재"
          createdAt={book.created_at}
          coverImageUrl={book.cover_image_url}
        />

        <ContentDetailTable
          rows={[
            { label: "개정교육과정", value: book.revision },
            { label: "교과", value: book.subject_category ?? null },
            { label: "과목", value: book.subject ?? null },
            { label: "출판사", value: book.publisher ?? null },
            { label: "저자", value: book.author ?? null },
            { label: "총 페이지", value: book.total_pages ? `${book.total_pages}p` : null },
            { label: "난이도", value: book.difficulty_level },
            { label: "메모", value: book.notes },
            { label: "출처 URL", value: book.source_url, isUrl: true },
          ]}
        />

        {/* 교재 목차 (계층적 표시) */}
        {details.length > 0 && <BookDetailsDisplay details={details} />}

        {/* 액션 버튼 (관리자/컨설턴트만 표시) */}
        {(role === "admin" || role === "consultant") && (
          <div className="flex flex-col gap-4 border-t pt-8">
            <ContentActionButtons
              editHref={`/admin/master-books/${book.id}/edit`}
              deleteAction={deleteAction}
              listHref="/admin/master-books"
            />
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="admin/master-books/new/MasterBookForm.tsx">
"use client";

import { useTransition, useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { addMasterBook } from "@/app/(student)/actions/masterContentActions";
import { getSubjectGroupsWithSubjectsAction } from "@/app/(admin)/actions/subjectActions";
import { BookDetailsManager } from "@/app/(student)/contents/_components/BookDetailsManager";
import type { Subject, SubjectGroup } from "@/lib/data/subjects";
import type { Publisher, CurriculumRevision } from "@/lib/data/contentMetadata";

type MasterBookFormProps = {
  curriculumRevisions: CurriculumRevision[];
  publishers: Publisher[];
};

export function MasterBookForm({ curriculumRevisions, publishers }: MasterBookFormProps) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>("");
  const [selectedGroupId, setSelectedGroupId] = useState<string>("");
  const [selectedSubjectId, setSelectedSubjectId] = useState<string>("");
  const [selectedSubjects, setSelectedSubjects] = useState<Subject[]>([]);
  const [subjectGroups, setSubjectGroups] = useState<(SubjectGroup & { subjects: Subject[] })[]>([]);
  const [loadingGroups, setLoadingGroups] = useState(false);

  // 개정교육과정 선택 시 해당 개정교육과정의 교과 그룹 목록 조회
  async function handleCurriculumRevisionChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const revisionName = e.target.value;
    const selectedRevision = curriculumRevisions.find(r => r.name === revisionName);
    
    // 교과 그룹과 과목 선택 초기화
    setSelectedGroupId("");
    setSelectedSubjectId("");
    setSelectedSubjects([]);
    
    if (selectedRevision) {
      setSelectedRevisionId(selectedRevision.id);
      setLoadingGroups(true);
      
      try {
        const groups = await getSubjectGroupsWithSubjectsAction(selectedRevision.id);
        setSubjectGroups(groups);
      } catch (error) {
        console.error("교과 그룹 조회 실패:", error);
        setSubjectGroups([]);
      } finally {
        setLoadingGroups(false);
      }
    } else {
      setSelectedRevisionId("");
      setSubjectGroups([]);
    }
  }

  // 교과 그룹 선택 시 해당 그룹의 과목 목록 업데이트
  function handleSubjectGroupChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const groupId = e.target.value;
    setSelectedGroupId(groupId);
    setSelectedSubjectId(""); // 과목 선택 초기화
    
    if (groupId) {
      const group = subjectGroups.find(g => g.id === groupId);
      setSelectedSubjects(group?.subjects || []);
    } else {
      setSelectedSubjects([]);
    }
  }

  // 과목 선택 시 처리 (개정교육과정 패턴과 동일)
  function handleSubjectChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const subjectName = e.target.value;
    const selectedSubject = selectedSubjects.find(s => s.name === subjectName);
    setSelectedSubjectId(selectedSubject?.id || "");
  }

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    // 교과 그룹 정보 추가 (denormalize)
    if (selectedGroupId) {
      const selectedGroup = subjectGroups.find(g => g.id === selectedGroupId);
      if (selectedGroup) {
        formData.set("subject_group_id", selectedGroup.id);
        formData.set("subject_category", selectedGroup.name);
      }
    }

    // 과목 정보 추가 (denormalize)
    if (selectedSubjectId) {
      const selectedSubject = selectedSubjects.find(s => s.id === selectedSubjectId);
      if (selectedSubject) {
        formData.set("subject", selectedSubject.name);
      }
    }

    startTransition(async () => {
      try {
        await addMasterBook(formData);
      } catch (error) {
        console.error("교재 등록 실패:", error);
        alert(
          error instanceof Error ? error.message : "교재 등록에 실패했습니다."
        );
      }
    });
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm">
      <div className="grid gap-4 md:grid-cols-2">
        {/* 교재명 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            교재명 <span className="text-red-500">*</span>
          </label>
          <input
            name="title"
            required
            placeholder="교재명을 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 개정교육과정 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정
          </label>
          <select
            name="revision"
            value={curriculumRevisions.find(r => r.id === selectedRevisionId)?.name || ""}
            onChange={handleCurriculumRevisionChange}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.name}>
                {revision.name}
              </option>
            ))}
          </select>
          {/* curriculum_revision_id를 hidden input으로 전송 */}
          <input type="hidden" name="curriculum_revision_id" value={selectedRevisionId} />
        </div>

        {/* 교과 그룹 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            교과 그룹
          </label>
          <select
            value={selectedGroupId}
            onChange={handleSubjectGroupChange}
            disabled={!selectedRevisionId || loadingGroups}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
          >
            <option value="">
              {loadingGroups
                ? "로딩 중..."
                : !selectedRevisionId
                ? "개정교육과정을 먼저 선택하세요"
                : "선택하세요"}
            </option>
            {subjectGroups.map((group) => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
          {!selectedRevisionId && (
            <p className="text-xs text-gray-700">
              개정교육과정을 먼저 선택하세요
            </p>
          )}
        </div>

        {/* 과목 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목
          </label>
          <select
            value={selectedSubjects.find(s => s.id === selectedSubjectId)?.name || ""}
            onChange={handleSubjectChange}
            disabled={!selectedGroupId}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100"
          >
            <option value="">선택하세요</option>
            {selectedSubjects.map((subject) => (
              <option key={subject.id} value={subject.name}>
                {subject.name}
              </option>
            ))}
          </select>
          {/* subject_id를 hidden input으로 전송 */}
          <input type="hidden" name="subject_id" value={selectedSubjectId} />
          <p className="text-xs text-gray-500">
            {!selectedRevisionId
              ? "개정교육과정과 교과 그룹을 먼저 선택하세요"
              : !selectedGroupId
              ? "교과 그룹을 먼저 선택하세요"
              : ""}
          </p>
        </div>

        {/* 출판사 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            출판사
          </label>
          <select
            name="publisher_id"
            onChange={(e) => {
              // publisher_id 변경 시 publisher_name도 자동 설정
              const selectedPublisher = publishers.find(p => p.id === e.target.value);
              const publisherNameInput = document.querySelector('input[name="publisher_name"]') as HTMLInputElement;
              if (publisherNameInput && selectedPublisher) {
                publisherNameInput.value = selectedPublisher.name;
              }
            }}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {publishers.map((publisher) => (
              <option key={publisher.id} value={publisher.id}>
                {publisher.name}
              </option>
            ))}
          </select>
        </div>

        {/* 출판사명 (숨김 필드, 자동 설정됨) */}
        <input type="hidden" name="publisher_name" />

        {/* 저자 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            저자
          </label>
          <input
            name="author"
            placeholder="저자명을 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 학교 유형 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            학교 유형
          </label>
          <select
            name="school_type"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="MIDDLE">중학교</option>
            <option value="HIGH">고등학교</option>
            <option value="OTHER">기타</option>
          </select>
        </div>

        {/* 최소 학년 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            최소 학년
          </label>
          <select
            name="grade_min"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="1">1학년</option>
            <option value="2">2학년</option>
            <option value="3">3학년</option>
          </select>
        </div>

        {/* 최대 학년 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            최대 학년
          </label>
          <select
            name="grade_max"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="1">1학년</option>
            <option value="2">2학년</option>
            <option value="3">3학년</option>
          </select>
        </div>

        {/* 총 페이지 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 페이지
          </label>
          <input
            name="total_pages"
            type="number"
            min="1"
            placeholder="예: 255"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 난이도 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            난이도
          </label>
          <select
            name="difficulty_level"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="개념">개념</option>
            <option value="기본">기본</option>
            <option value="심화">심화</option>
          </select>
        </div>

        {/* 대상 시험 유형 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            대상 시험 유형
          </label>
          <div className="flex flex-wrap gap-3">
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="수능"
                className="rounded border-gray-300"
              />
              <span className="text-sm">수능</span>
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="내신"
                className="rounded border-gray-300"
              />
              <span className="text-sm">내신</span>
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="모의고사"
                className="rounded border-gray-300"
              />
              <span className="text-sm">모의고사</span>
            </label>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                name="target_exam_type"
                value="특목고입시"
                className="rounded border-gray-300"
              />
              <span className="text-sm">특목고입시</span>
            </label>
          </div>
          <p className="text-xs text-gray-500">
            해당하는 시험 유형을 모두 선택하세요
          </p>
        </div>

        {/* 태그 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            태그
          </label>
          <input
            name="tags"
            placeholder="태그를 쉼표로 구분하여 입력하세요 (예: 기출문제, 실전모의고사, 핵심개념)"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
          <p className="text-xs text-gray-500">
            쉼표(,)로 구분하여 여러 태그를 입력할 수 있습니다
          </p>
        </div>

        {/* 메모 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            메모
          </label>
          <textarea
            name="notes"
            rows={3}
            placeholder="메모를 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>
      </div>

      {/* 교재 상세 정보 */}
      <BookDetailsManager />

      {/* 버튼 */}
      <div className="flex gap-3">
        <button
          type="submit"
          disabled={isPending}
          className="flex-1 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
        >
          {isPending ? "등록 중..." : "등록하기"}
        </button>
        <Link
          href="/admin/master-books"
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </Link>
      </div>
    </form>
  );
}
</file>

<file path="admin/master-books/new/page.tsx">
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getPublishers, getCurriculumRevisions } from "@/lib/data/contentMetadata";
import { MasterBookForm } from "./MasterBookForm";

export default async function NewMasterBookPage() {
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  // 데이터 조회
  const [curriculumRevisions, publishers] = await Promise.all([
    getCurriculumRevisions().catch(() => []),
    getPublishers().catch(() => []),
  ]);

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">교재 등록</h1>
          </div>
          <Link
            href="/admin/master-books"
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
          >
            목록으로
          </Link>
        </div>

        <MasterBookForm 
          curriculumRevisions={curriculumRevisions}
          publishers={publishers}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/master-books/page.tsx">
import Link from "next/link";
import Image from "next/image";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { searchMasterBooks, getCurriculumRevisions, getPublishersForFilter, getDifficultiesForMasterBooks } from "@/lib/data/contentMasters";
import { MasterBookFilters } from "@/lib/data/contentMasters";
import ExcelActions from "./_components/ExcelActions";
import { UnifiedContentFilter } from "@/components/filters/UnifiedContentFilter";

export default async function MasterBooksPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const params = await searchParams;
  const { role } = await getCurrentUserRole();
  const tenantContext = await getTenantContext();

  const supabase = await createSupabaseServerClient();

  // 관리자/컨설턴트의 경우 자신의 테넌트 교재도 조회할 수 있도록 tenantId 전달
  // Super Admin의 경우 tenantId가 null이므로 모든 교재 조회 가능
  const tenantId = tenantContext?.tenantId || undefined;

  // 검색 필터 구성
  const filters: MasterBookFilters = {
    curriculum_revision_id: params.curriculum_revision_id,
    subject_group_id: params.subject_group_id,
    subject_id: params.subject_id,
    publisher_id: params.publisher_id,
    search: params.search,
    difficulty: params.difficulty,
    sort: params.sort || "updated_at_desc",
    tenantId, // 테넌트 ID 추가
    limit: 50,
  };

  const { data: books, total } = await searchMasterBooks(filters);

  // 필터 옵션 조회 (드롭다운용)
  const [curriculumRevisions, publishers, difficulties] = await Promise.all([
    getCurriculumRevisions(),
    getPublishersForFilter(tenantId),
    getDifficultiesForMasterBooks(tenantId),
  ]);

  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">교재 목록</h1>
            <p className="text-sm text-gray-700">
              서비스에서 제공하는 교재를 검색하고 확인하세요.
            </p>
          </div>
          <div className="flex items-center gap-2">
            {(role === "admin" || role === "consultant") && (
              <>
                <ExcelActions />
                <Link
                  href="/admin/master-books/new"
                  className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  + 교재 등록
                </Link>
              </>
            )}
          </div>
        </div>

        {/* 검색 필터 */}
        <div className="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
          <UnifiedContentFilter
            context="admin"
            contentType="book"
            basePath="/admin/master-books"
            initialValues={{
              curriculum_revision_id: params.curriculum_revision_id,
              subject_group_id: params.subject_group_id,
              subject_id: params.subject_id,
              publisher_id: params.publisher_id,
              search: params.search,
              difficulty: params.difficulty,
              sort: params.sort,
            }}
            filterOptions={{
              curriculumRevisions,
              publishers,
              difficulties,
            }}
            showDifficulty={true}
            showSort={true}
            defaultSort="updated_at_desc"
          />
        </div>

        {/* 결과 개수 */}
        <div className="text-sm text-gray-600">
          총 <span className="font-semibold">{total}</span>개의 교재가
          검색되었습니다.
        </div>

        {/* 교재 목록 */}
        <div>
          {books.length === 0 ? (
            <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
              <div className="mx-auto flex max-w-md flex-col gap-6">
                <div className="text-6xl">📚</div>
                <div className="flex flex-col gap-2">
                  <h3 className="text-lg font-semibold text-gray-900">
                    검색 결과가 없습니다
                  </h3>
                  <p className="text-sm text-gray-700">
                    다른 검색 조건으로 시도해보세요.
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <ul className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {books.map((book) => (
                <li
                  key={book.id}
                  className="rounded-lg border bg-white p-4 shadow-sm"
                >
                  <div className="flex flex-col gap-3">
                    {book.cover_image_url && (
                      <div className="relative h-40 w-full overflow-hidden rounded-lg border border-gray-200 bg-gray-100">
                        <Image
                          src={book.cover_image_url}
                          alt={`${book.title} 표지`}
                          fill
                          className="object-cover"
                          sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw"
                        />
                      </div>
                    )}
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">
                        {book.title}
                      </h3>
                      <p className="text-sm text-gray-700">
                        {book.publisher_name || "출판사 정보 없음"}
                      </p>
                    </div>

                    <dl className="grid gap-y-1 text-sm text-gray-600">
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">개정</dt>
                        <dd>{book.revision || "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">과목 ID</dt>
                        <dd className="truncate max-w-[150px]">{book.subject_id || "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">총 페이지</dt>
                        <dd>{book.total_pages ? `${book.total_pages}p` : "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">난이도</dt>
                        <dd>{book.difficulty_level || "—"}</dd>
                      </div>
                    </dl>

                    <Link
                      href={`/admin/master-books/${book.id}`}
                      className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                    >
                      상세보기
                    </Link>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="admin/master-custom-contents/[id]/edit/MasterCustomContentEditForm.tsx">
"use client";

import { useTransition, useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { updateMasterCustomContentAction } from "@/app/(admin)/actions/masterCustomContentActions";
import { getSubjectGroupsWithSubjectsAction } from "@/app/(admin)/actions/subjectActions";
import type { Subject, SubjectGroup } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import type { MasterCustomContent } from "@/lib/types/plan";

type MasterCustomContentEditFormProps = {
  content: MasterCustomContent;
  curriculumRevisions: CurriculumRevision[];
  currentSubject: Subject | null;
};

export function MasterCustomContentEditForm({ 
  content, 
  curriculumRevisions,
  currentSubject 
}: MasterCustomContentEditFormProps) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>(content.curriculum_revision_id || "");
  const [selectedGroupId, setSelectedGroupId] = useState<string>(content.subject_group_id || "");
  const [selectedSubjectId, setSelectedSubjectId] = useState<string>(content.subject_id || "");
  const [selectedSubjects, setSelectedSubjects] = useState<Subject[]>([]);
  const [subjectGroups, setSubjectGroups] = useState<(SubjectGroup & { subjects: Subject[] })[]>([]);
  const [loadingGroups, setLoadingGroups] = useState(false);

  // 초기 데이터 로드
  useEffect(() => {
    if (content.curriculum_revision_id) {
      loadSubjectGroups(content.curriculum_revision_id);
    }
  }, []);

  // 교과 그룹 로드
  async function loadSubjectGroups(revisionId: string) {
    setLoadingGroups(true);
    try {
      const groups = await getSubjectGroupsWithSubjectsAction(revisionId);
      setSubjectGroups(groups);
      
      // 현재 subject_group_id에 맞는 그룹 찾기
      if (content.subject_group_id) {
        const currentGroup = groups.find(g => g.id === content.subject_group_id);
        if (currentGroup) {
          setSelectedSubjects(currentGroup.subjects || []);
        }
      }
    } catch (error) {
      console.error("교과 그룹 조회 실패:", error);
      setSubjectGroups([]);
    } finally {
      setLoadingGroups(false);
    }
  }

  // 개정교육과정 선택 시 해당 개정교육과정의 교과 그룹 목록 조회
  async function handleCurriculumRevisionChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const revisionName = e.target.value;
    const selectedRevision = curriculumRevisions.find(r => r.name === revisionName);
    
    // 교과 그룹과 과목 선택 초기화
    setSelectedGroupId("");
    setSelectedSubjectId("");
    setSelectedSubjects([]);
    
    if (selectedRevision) {
      setSelectedRevisionId(selectedRevision.id);
      await loadSubjectGroups(selectedRevision.id);
    } else {
      setSelectedRevisionId("");
      setSubjectGroups([]);
    }
  }

  // 교과 그룹 선택 시 해당 그룹의 과목 목록 업데이트
  function handleSubjectGroupChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const groupId = e.target.value;
    setSelectedGroupId(groupId);
    setSelectedSubjectId(""); // 과목 선택 초기화
    
    if (groupId) {
      const group = subjectGroups.find(g => g.id === groupId);
      setSelectedSubjects(group?.subjects || []);
    } else {
      setSelectedSubjects([]);
    }
  }

  // 과목 선택 시 처리
  function handleSubjectChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const subjectName = e.target.value;
    const selectedSubject = selectedSubjects.find(s => s.name === subjectName);
    setSelectedSubjectId(selectedSubject?.id || "");
  }

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    // 교과 그룹 정보 추가 (denormalize)
    if (selectedGroupId) {
      const selectedGroup = subjectGroups.find(g => g.id === selectedGroupId);
      if (selectedGroup) {
        formData.set("subject_group_id", selectedGroup.id);
        formData.set("subject_category", selectedGroup.name);
      }
    }

    // 과목 정보 추가 (denormalize)
    if (selectedSubjectId) {
      const selectedSubject = selectedSubjects.find(s => s.id === selectedSubjectId);
      if (selectedSubject) {
        formData.set("subject", selectedSubject.name);
      }
    }

    startTransition(async () => {
      try {
        await updateMasterCustomContentAction(content.id, formData);
      } catch (error) {
        console.error("커스텀 콘텐츠 수정 실패:", error);
        alert(
          error instanceof Error ? error.message : "커스텀 콘텐츠 수정에 실패했습니다."
        );
      }
    });
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm">
      <div className="grid gap-4 md:grid-cols-2">
        {/* 제목 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            제목 <span className="text-red-500">*</span>
          </label>
          <input
            name="title"
            required
            defaultValue={content.title}
            placeholder="커스텀 콘텐츠 제목을 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 콘텐츠 유형 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            콘텐츠 유형
          </label>
          <select
            name="content_type"
            defaultValue={content.content_type || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="book">책</option>
            <option value="lecture">강의</option>
            <option value="worksheet">문제집</option>
            <option value="other">기타</option>
          </select>
        </div>

        {/* 총 페이지/시간 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 페이지/시간
          </label>
          <input
            type="number"
            name="total_page_or_time"
            defaultValue={content.total_page_or_time || ""}
            placeholder="페이지 수 또는 시간(분)"
            min="0"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 개정교육과정 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정
          </label>
          <select
            name="revision"
            value={curriculumRevisions.find(r => r.id === selectedRevisionId)?.name || ""}
            onChange={handleCurriculumRevisionChange}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.name}>
                {revision.name}
              </option>
            ))}
          </select>
          {/* curriculum_revision_id를 hidden input으로 전송 */}
          <input type="hidden" name="curriculum_revision_id" value={selectedRevisionId} />
        </div>

        {/* 교과 그룹 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            교과 그룹
          </label>
          <select
            value={selectedGroupId}
            onChange={handleSubjectGroupChange}
            disabled={!selectedRevisionId || loadingGroups}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
          >
            <option value="">
              {loadingGroups
                ? "로딩 중..."
                : !selectedRevisionId
                ? "개정교육과정을 먼저 선택하세요"
                : "선택하세요"}
            </option>
            {subjectGroups.map((group) => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
        </div>

        {/* 과목 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목
          </label>
          <select
            value={selectedSubjects.find(s => s.id === selectedSubjectId)?.name || ""}
            onChange={handleSubjectChange}
            disabled={!selectedGroupId}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100"
          >
            <option value="">선택하세요</option>
            {selectedSubjects.map((subject) => (
              <option key={subject.id} value={subject.name}>
                {subject.name}
              </option>
            ))}
          </select>
          {/* subject_id를 hidden input으로 전송 */}
          <input type="hidden" name="subject_id" value={selectedSubjectId} />
        </div>

        {/* 난이도 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            난이도
          </label>
          <select
            name="difficulty_level"
            defaultValue={content.difficulty_level || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="상">상</option>
            <option value="중">중</option>
            <option value="하">하</option>
          </select>
        </div>

        {/* 콘텐츠 카테고리 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            콘텐츠 카테고리
          </label>
          <input
            name="content_category"
            defaultValue={content.content_category || ""}
            placeholder="예: 개념서, 문제집 등"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 메모 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            메모
          </label>
          <textarea
            name="notes"
            rows={3}
            defaultValue={content.notes || ""}
            placeholder="추가 정보나 메모를 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>
      </div>

      {/* 제출 버튼 */}
      <div className="flex justify-end gap-3">
        <button
          type="button"
          onClick={() => router.back()}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </button>
        <button
          type="submit"
          disabled={isPending}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
        >
          {isPending ? "수정 중..." : "수정하기"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="admin/master-custom-contents/[id]/edit/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getMasterCustomContentById } from "@/lib/data/contentMasters";
import { getSubjectById } from "@/lib/data/subjects";
import { getCurriculumRevisions } from "@/lib/data/contentMetadata";
import { MasterCustomContentEditForm } from "./MasterCustomContentEditForm";

export default async function EditMasterCustomContentPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { content } = await getMasterCustomContentById(id);

  if (!content) notFound();

  // 데이터 조회
  const [curriculumRevisions, currentSubject] = await Promise.all([
    getCurriculumRevisions().catch(() => []),
    content.subject_id ? getSubjectById(content.subject_id).catch(() => null) : Promise.resolve(null),
  ]);

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-900">서비스 마스터</p>
            <h1 className="text-h1 text-gray-900">커스텀 콘텐츠 수정</h1>
          </div>
          <Link
            href={`/admin/master-custom-contents/${id}`}
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-900 transition hover:bg-gray-50"
          >
            취소
          </Link>
        </div>

        <MasterCustomContentEditForm 
          content={content} 
          curriculumRevisions={curriculumRevisions}
          currentSubject={currentSubject}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/master-custom-contents/[id]/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getMasterCustomContentById, deleteMasterCustomContent } from "@/lib/data/contentMasters";
import { ContentHeader } from "@/app/(student)/contents/_components/ContentHeader";
import { ContentDetailTable } from "@/app/(student)/contents/_components/ContentDetailTable";
import { ContentActionButtons } from "@/app/(student)/contents/_components/ContentActionButtons";

export default async function MasterCustomContentDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const { role } = await getCurrentUserRole();

  // 커스텀 콘텐츠 조회
  const { content } = await getMasterCustomContentById(id);

  if (!content) notFound();

  // 삭제 액션
  const deleteAction = async () => {
    "use server";
    await deleteMasterCustomContent(id);
    redirect("/admin/master-custom-contents");
  };

  return (
    <section className="mx-auto w-full max-w-3xl px-4 py-10">
      <div className="rounded-2xl border bg-white p-8 shadow-sm">
        <ContentHeader
          title={content.title}
          subtitle={content.content_type || ""}
          icon="📝 커스텀 콘텐츠"
          createdAt={content.created_at}
        />

        <ContentDetailTable
          rows={[
            { label: "개정교육과정", value: content.revision },
            { label: "교과", value: content.subject_category ?? null },
            { label: "과목", value: content.subject ?? null },
            { label: "콘텐츠 유형", value: content.content_type },
            {
              label: content.content_type === "book" ? "총 페이지" : "총 시간",
              value: content.total_page_or_time
                ? content.content_type === "book"
                  ? `${content.total_page_or_time}p`
                  : `${content.total_page_or_time}분`
                : null,
            },
            { label: "난이도", value: content.difficulty_level },
            { label: "콘텐츠 카테고리", value: content.content_category },
            { label: "메모", value: content.notes },
          ]}
        />

        {/* 액션 버튼 (관리자/컨설턴트만 표시) */}
        {(role === "admin" || role === "consultant") && (
          <div className="flex flex-col gap-4 border-t pt-8">
            <ContentActionButtons
              editHref={`/admin/master-custom-contents/${content.id}/edit`}
              deleteAction={deleteAction}
              listHref="/admin/master-custom-contents"
            />
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="admin/master-custom-contents/new/MasterCustomContentForm.tsx">
"use client";

import { useTransition, useState } from "react";
import { useRouter } from "next/navigation";
import { addMasterCustomContent } from "@/app/(admin)/actions/masterCustomContentActions";
import { getSubjectGroupsWithSubjectsAction } from "@/app/(admin)/actions/subjectActions";
import type { Subject, SubjectGroup } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

type MasterCustomContentFormProps = {
  curriculumRevisions: CurriculumRevision[];
};

export function MasterCustomContentForm({ curriculumRevisions }: MasterCustomContentFormProps) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>("");
  const [selectedGroupId, setSelectedGroupId] = useState<string>("");
  const [selectedSubjectId, setSelectedSubjectId] = useState<string>("");
  const [selectedSubjects, setSelectedSubjects] = useState<Subject[]>([]);
  const [subjectGroups, setSubjectGroups] = useState<(SubjectGroup & { subjects: Subject[] })[]>([]);
  const [loadingGroups, setLoadingGroups] = useState(false);

  // 개정교육과정 선택 시 해당 개정교육과정의 교과 그룹 목록 조회
  async function handleCurriculumRevisionChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const revisionName = e.target.value;
    const selectedRevision = curriculumRevisions.find(r => r.name === revisionName);
    
    // 교과 그룹과 과목 선택 초기화
    setSelectedGroupId("");
    setSelectedSubjectId("");
    setSelectedSubjects([]);
    
    if (selectedRevision) {
      setSelectedRevisionId(selectedRevision.id);
      setLoadingGroups(true);
      
      try {
        const groups = await getSubjectGroupsWithSubjectsAction(selectedRevision.id);
        setSubjectGroups(groups);
      } catch (error) {
        console.error("교과 그룹 조회 실패:", error);
        setSubjectGroups([]);
      } finally {
        setLoadingGroups(false);
      }
    } else {
      setSelectedRevisionId("");
      setSubjectGroups([]);
    }
  }

  // 교과 그룹 선택 시 해당 그룹의 과목 목록 업데이트
  function handleSubjectGroupChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const groupId = e.target.value;
    setSelectedGroupId(groupId);
    setSelectedSubjectId(""); // 과목 선택 초기화
    
    if (groupId) {
      const group = subjectGroups.find(g => g.id === groupId);
      setSelectedSubjects(group?.subjects || []);
    } else {
      setSelectedSubjects([]);
    }
  }

  // 과목 선택 시 처리
  function handleSubjectChange(e: React.ChangeEvent<HTMLSelectElement>) {
    const subjectName = e.target.value;
    const selectedSubject = selectedSubjects.find(s => s.name === subjectName);
    setSelectedSubjectId(selectedSubject?.id || "");
  }

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    // 교과 그룹 정보 추가 (denormalize)
    if (selectedGroupId) {
      const selectedGroup = subjectGroups.find(g => g.id === selectedGroupId);
      if (selectedGroup) {
        formData.set("subject_group_id", selectedGroup.id);
        formData.set("subject_category", selectedGroup.name);
      }
    }

    // 과목 정보 추가 (denormalize)
    if (selectedSubjectId) {
      const selectedSubject = selectedSubjects.find(s => s.id === selectedSubjectId);
      if (selectedSubject) {
        formData.set("subject", selectedSubject.name);
      }
    }

    startTransition(async () => {
      try {
        await addMasterCustomContent(formData);
      } catch (error) {
        console.error("커스텀 콘텐츠 등록 실패:", error);
        alert(
          error instanceof Error ? error.message : "커스텀 콘텐츠 등록에 실패했습니다."
        );
      }
    });
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm">
      <div className="grid gap-4 md:grid-cols-2">
        {/* 제목 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            제목 <span className="text-red-500">*</span>
          </label>
          <input
            name="title"
            required
            placeholder="커스텀 콘텐츠 제목을 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 콘텐츠 유형 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            콘텐츠 유형
          </label>
          <select
            name="content_type"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="book">책</option>
            <option value="lecture">강의</option>
            <option value="worksheet">문제집</option>
            <option value="other">기타</option>
          </select>
        </div>

        {/* 총 페이지/시간 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 페이지/시간
          </label>
          <input
            type="number"
            name="total_page_or_time"
            placeholder="페이지 수 또는 시간(분)"
            min="0"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 개정교육과정 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정
          </label>
          <select
            name="revision"
            value={curriculumRevisions.find(r => r.id === selectedRevisionId)?.name || ""}
            onChange={handleCurriculumRevisionChange}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.name}>
                {revision.name}
              </option>
            ))}
          </select>
          {/* curriculum_revision_id를 hidden input으로 전송 */}
          <input type="hidden" name="curriculum_revision_id" value={selectedRevisionId} />
        </div>

        {/* 교과 그룹 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            교과 그룹
          </label>
          <select
            value={selectedGroupId}
            onChange={handleSubjectGroupChange}
            disabled={!selectedRevisionId || loadingGroups}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
          >
            <option value="">
              {loadingGroups
                ? "로딩 중..."
                : !selectedRevisionId
                ? "개정교육과정을 먼저 선택하세요"
                : "선택하세요"}
            </option>
            {subjectGroups.map((group) => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
        </div>

        {/* 과목 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목
          </label>
          <select
            value={selectedSubjects.find(s => s.id === selectedSubjectId)?.name || ""}
            onChange={handleSubjectChange}
            disabled={!selectedGroupId}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100"
          >
            <option value="">선택하세요</option>
            {selectedSubjects.map((subject) => (
              <option key={subject.id} value={subject.name}>
                {subject.name}
              </option>
            ))}
          </select>
          {/* subject_id를 hidden input으로 전송 */}
          <input type="hidden" name="subject_id" value={selectedSubjectId} />
        </div>

        {/* 난이도 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            난이도
          </label>
          <select
            name="difficulty_level"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="상">상</option>
            <option value="중">중</option>
            <option value="하">하</option>
          </select>
        </div>

        {/* 콘텐츠 카테고리 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            콘텐츠 카테고리
          </label>
          <input
            name="content_category"
            placeholder="예: 개념서, 문제집 등"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 메모 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            메모
          </label>
          <textarea
            name="notes"
            rows={3}
            placeholder="추가 정보나 메모를 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>
      </div>

      {/* 제출 버튼 */}
      <div className="flex justify-end gap-3">
        <button
          type="button"
          onClick={() => router.back()}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </button>
        <button
          type="submit"
          disabled={isPending}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-indigo-400"
        >
          {isPending ? "등록 중..." : "등록하기"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="admin/master-custom-contents/new/page.tsx">
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getCurriculumRevisions } from "@/lib/data/contentMetadata";
import { MasterCustomContentForm } from "./MasterCustomContentForm";

export default async function NewMasterCustomContentPage() {
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  // 데이터 조회
  const curriculumRevisions = await getCurriculumRevisions().catch(() => []);

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">커스텀 콘텐츠 등록</h1>
          </div>
          <Link
            href="/admin/master-custom-contents"
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
          >
            목록으로
          </Link>
        </div>

        <MasterCustomContentForm 
          curriculumRevisions={curriculumRevisions}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/master-custom-contents/page.tsx">
import Link from "next/link";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { searchMasterCustomContents, getCurriculumRevisions } from "@/lib/data/contentMasters";
import { MasterCustomContentFilters } from "@/lib/data/contentMasters";
import { UnifiedContentFilter } from "@/components/filters/UnifiedContentFilter";

export default async function MasterCustomContentsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const params = await searchParams;
  const { role } = await getCurrentUserRole();
  const tenantContext = await getTenantContext();

  const supabase = await createSupabaseServerClient();

  // 관리자/컨설턴트의 경우 자신의 테넌트 커스텀 콘텐츠도 조회할 수 있도록 tenantId 전달
  // Super Admin의 경우 tenantId가 null이므로 모든 커스텀 콘텐츠 조회 가능
  const tenantId = tenantContext?.tenantId || undefined;

  // 검색 필터 구성
  const filters: MasterCustomContentFilters = {
    curriculum_revision_id: params.curriculum_revision_id,
    subject_group_id: params.subject_group_id,
    subject_id: params.subject_id,
    content_type: params.content_type,
    search: params.search,
    difficulty: params.difficulty,
    sort: params.sort || "updated_at_desc",
    tenantId, // 테넌트 ID 추가
    limit: 50,
  };

  const { data: contents, total } = await searchMasterCustomContents(filters);

  // 필터 옵션 조회 (드롭다운용)
  const curriculumRevisions = await getCurriculumRevisions().catch(() => []);

  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">커스텀 콘텐츠 목록</h1>
            <p className="text-sm text-gray-700">
              서비스에서 제공하는 커스텀 콘텐츠를 검색하고 확인하세요.
            </p>
          </div>
          <div className="flex items-center gap-2">
            {(role === "admin" || role === "consultant") && (
              <Link
                href="/admin/master-custom-contents/new"
                className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
              >
                + 커스텀 콘텐츠 등록
              </Link>
            )}
          </div>
        </div>

        {/* 검색 필터 */}
        <div className="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
          <UnifiedContentFilter
            context="admin"
            contentType="custom"
            basePath="/admin/master-custom-contents"
            initialValues={{
              curriculum_revision_id: params.curriculum_revision_id,
              subject_group_id: params.subject_group_id,
              subject_id: params.subject_id,
              content_type: params.content_type,
              search: params.search,
              difficulty: params.difficulty,
              sort: params.sort,
            }}
            filterOptions={{
              curriculumRevisions,
            }}
            showDifficulty={true}
            showSort={true}
            defaultSort="updated_at_desc"
          />
        </div>

        {/* 결과 개수 */}
        <div className="text-sm text-gray-600">
          총 <span className="font-semibold">{total}</span>개의 커스텀 콘텐츠가
          검색되었습니다.
        </div>

        {/* 커스텀 콘텐츠 목록 */}
        <div>
          {contents.length === 0 ? (
            <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
              <div className="mx-auto flex max-w-md flex-col gap-6">
                <div className="text-6xl">📝</div>
                <div className="flex flex-col gap-2">
                  <h3 className="text-lg font-semibold text-gray-900">
                    검색 결과가 없습니다
                  </h3>
                  <p className="text-sm text-gray-700">
                    다른 검색 조건으로 시도해보세요.
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <ul className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {contents.map((content) => (
                <li
                  key={content.id}
                  className="rounded-lg border bg-white p-4 shadow-sm"
                >
                  <div className="flex flex-col gap-3">
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">
                        {content.title}
                      </h3>
                      <p className="text-sm text-gray-700">
                        {content.content_type || "유형 정보 없음"}
                      </p>
                    </div>

                    <dl className="grid gap-y-1 text-sm text-gray-600">
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">개정</dt>
                        <dd>{content.revision || "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">과목</dt>
                        <dd>{content.subject || "—"}</dd>
                      </div>
                      {content.total_page_or_time && (
                        <div className="flex justify-between">
                          <dt className="font-medium text-gray-700">
                            {content.content_type === "book" ? "총 페이지" : "총 시간"}
                          </dt>
                          <dd>
                            {content.content_type === "book"
                              ? `${content.total_page_or_time}p`
                              : `${content.total_page_or_time}분`}
                          </dd>
                        </div>
                      )}
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">난이도</dt>
                        <dd>{content.difficulty_level || "—"}</dd>
                      </div>
                    </dl>

                    <Link
                      href={`/admin/master-custom-contents/${content.id}`}
                      className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                    >
                      상세보기
                    </Link>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="admin/master-lectures/_components/ExcelActions.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { exportMasterLecturesToExcel, downloadMasterLecturesTemplate } from "@/app/(admin)/actions/masterLectures/export";
import { importMasterLecturesFromExcel } from "@/app/(admin)/actions/masterLectures/import";
import ExcelImportDialog from "@/components/admin/ExcelImportDialog";
import Button from "@/components/atoms/Button";

export default function ExcelActions() {
  const toast = useToast();
  const [showImportDialog, setShowImportDialog] = useState(false);
  const [isExporting, setIsExporting] = useState(false);

  async function handleExport() {
    setIsExporting(true);
    try {
      const buffer = await exportMasterLecturesToExcel();
      const blob = new Blob([new Uint8Array(buffer)], {  // 변경: Buffer → Uint8Array
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `강의관리_${new Date().toISOString().split("T")[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.showSuccess("Excel 파일을 다운로드했습니다.");
    } catch (error) {
      console.error("Excel 다운로드 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "Excel 파일 다운로드에 실패했습니다."
      );
    } finally {
      setIsExporting(false);
    }
  }

  async function handleDownloadTemplate() {
    setIsExporting(true);
    try {
      const buffer = await downloadMasterLecturesTemplate();
      const blob = new Blob([new Uint8Array(buffer)], {  // 변경: Buffer → Uint8Array
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "강의관리_양식.xlsx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.showSuccess("양식 파일을 다운로드했습니다.");
    } catch (error) {
      console.error("양식 다운로드 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "양식 파일 다운로드에 실패했습니다."
      );
    } finally {
      setIsExporting(false);
    }
  }

  async function handleImport(file: File): Promise<{ success: boolean; message: string; errors?: string[] }> {
    const arrayBuffer = await file.arrayBuffer();
    const uint8Array = new Uint8Array(arrayBuffer);
    return importMasterLecturesFromExcel(uint8Array as any);
  }

  return (
    <>
      <div className="flex gap-2">
        <Button
          variant="outline"
          size="sm"
          onClick={handleDownloadTemplate}
          isLoading={isExporting}
        >
          양식 다운로드
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={handleExport}
          isLoading={isExporting}
        >
          Excel 다운로드
        </Button>
        <Button
          variant="primary"
          size="sm"
          onClick={() => setShowImportDialog(true)}
        >
          Excel 업로드
        </Button>
      </div>

      <ExcelImportDialog
        open={showImportDialog}
        onOpenChange={setShowImportDialog}
        onImport={handleImport}
        title="강의 관리 Excel 업로드"
        description="Excel 파일을 선택하여 강의 데이터를 업로드하세요. 기존 데이터는 모두 삭제되고 새 데이터로 교체됩니다."
      />
    </>
  );
}
</file>

<file path="admin/master-lectures/[id]/edit/MasterLectureEditForm.tsx">
"use client";

import Link from "next/link";
import { useTransition } from "react";
import { useRouter } from "next/navigation";
import { updateMasterLectureAction } from "@/app/(student)/actions/masterContentActions";
import { MasterLecture, LectureEpisode } from "@/lib/types/plan";
import { LectureEpisodesManager } from "@/app/(student)/contents/_components/LectureEpisodesManager";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import { secondsToMinutes } from "@/lib/utils/duration";

export function MasterLectureEditForm({
  lecture,
  episodes = [],
  masterBooks = [],
  curriculumRevisions = [],
}: {
  lecture: MasterLecture;
  episodes?: LectureEpisode[];
  masterBooks?: Array<{ id: string; title: string }>;
  curriculumRevisions?: CurriculumRevision[];
}) {
  const [isPending, startTransition] = useTransition();
  const router = useRouter();

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    startTransition(async () => {
      try {
        await updateMasterLectureAction(lecture.id, formData);
      } catch (error) {
        console.error("강의 수정 실패:", error);
        alert(
          error instanceof Error ? error.message : "강의 수정에 실패했습니다."
        );
      }
    });
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm"
    >
      <div className="grid gap-4 md:grid-cols-2">
        {/* 강의명 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            강의명 <span className="text-red-500">*</span>
          </label>
          <input
            name="title"
            required
            defaultValue={lecture.title}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 개정교육과정 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정
          </label>
          <select
            name="revision"
            defaultValue={lecture.revision || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.name}>
                {revision.name}
              </option>
            ))}
          </select>
        </div>

        {/* 교과 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            교과
          </label>
          <select
            name="subject_category"
            defaultValue={lecture.subject_category || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="국어">국어</option>
            <option value="수학">수학</option>
            <option value="영어">영어</option>
            <option value="사회">사회</option>
            <option value="과학">과학</option>
          </select>
        </div>

        {/* 과목 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목
          </label>
          <input
            name="subject"
            defaultValue={lecture.subject || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 플랫폼 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            플랫폼
          </label>
          <input
            name="platform"
            defaultValue={lecture.platform || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 총 회차 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 회차 <span className="text-red-500">*</span>
          </label>
          <input
            name="total_episodes"
            type="number"
            required
            min="1"
            defaultValue={lecture.total_episodes}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 총 강의시간 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 강의시간 (분)
          </label>
          <input
            name="total_duration"
            type="number"
            min="0"
            defaultValue={lecture.total_duration ? secondsToMinutes(lecture.total_duration) || "" : ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 난이도 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            난이도
          </label>
          <select
            name="difficulty_level"
            defaultValue={lecture.difficulty_level || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="개념">개념</option>
            <option value="기본">기본</option>
            <option value="심화">심화</option>
          </select>
        </div>

        {/* 연결된 교재 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            연결된 교재 (선택사항)
          </label>
          <select
            name="linked_book_id"
            defaultValue={lecture.linked_book_id || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">연결된 교재 없음</option>
            {masterBooks.map((book) => (
              <option key={book.id} value={book.id}>
                {book.title}
              </option>
            ))}
          </select>
          <p className="text-xs text-gray-700">
            이 강의가 특정 교재를 기반으로 하는 경우 교재를 연결할 수
            있습니다.
          </p>
        </div>

        {/* 메모 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            메모
          </label>
          <textarea
            name="notes"
            rows={3}
            defaultValue={lecture.notes || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>
      </div>

      {/* 강의 회차 정보 */}
      <LectureEpisodesManager
        initialEpisodes={episodes.map((e) => ({ ...e, lecture_id: lecture.id }))}
      />

      {/* 버튼 */}
      <div className="flex gap-3">
        <button
          type="submit"
          disabled={isPending}
          className="flex-1 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
        >
          {isPending ? "수정 중..." : "변경사항 저장"}
        </button>
        <Link
          href={`/admin/master-lectures/${lecture.id}`}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </Link>
      </div>
    </form>
  );
}
</file>

<file path="admin/master-lectures/[id]/edit/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getMasterLectureById, getMasterBooksList } from "@/lib/data/contentMasters";
import { getCurriculumRevisions } from "@/lib/data/contentMetadata";
import { MasterLectureEditForm } from "./MasterLectureEditForm";

export default async function EditMasterLecturePage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { lecture, episodes } = await getMasterLectureById(id);

  if (!lecture) notFound();

  // 데이터 조회
  const [curriculumRevisions, masterBooks] = await Promise.all([
    getCurriculumRevisions().catch(() => []),
    getMasterBooksList(),
  ]);

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">강의 수정</h1>
          </div>
          <Link
            href={`/admin/master-lectures/${id}`}
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
          >
            취소
          </Link>
        </div>

        <MasterLectureEditForm 
          lecture={lecture} 
          episodes={episodes} 
          masterBooks={masterBooks}
          curriculumRevisions={curriculumRevisions}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/master-lectures/[id]/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import {
  getMasterLectureById,
  deleteMasterLecture,
} from "@/lib/data/contentMasters";
import { ContentHeader } from "@/app/(student)/contents/_components/ContentHeader";
import { ContentDetailTable } from "@/app/(student)/contents/_components/ContentDetailTable";
import { ContentActionButtons } from "@/app/(student)/contents/_components/ContentActionButtons";
import { LectureEpisodesDisplay } from "@/app/(student)/contents/_components/LectureEpisodesDisplay";
import { secondsToMinutes } from "@/lib/utils/duration";

export default async function MasterLectureDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const { role } = await getCurrentUserRole();

  const supabase = await createSupabaseServerClient();

  // 강의 조회
  const { lecture, episodes } = await getMasterLectureById(id);

  if (!lecture) notFound();

  // 연결된 교재 조회 (있는 경우)
  let linkedBook = null;
  if (lecture.linked_book_id) {
    const { data: book } = await supabase
      .from("master_books")
      .select("id, title")
      .eq("id", lecture.linked_book_id)
      .maybeSingle();
    linkedBook = book;
  }

  // 삭제 액션
  const deleteAction = async () => {
    "use server";
    await deleteMasterLecture(id);
    redirect("/admin/master-lectures");
  };

  return (
    <section className="mx-auto w-full max-w-3xl px-4 py-10">
      <div className="rounded-2xl border bg-white p-8 shadow-sm">
        <ContentHeader
          title={lecture.title}
          subtitle={lecture.platform || ""}
          icon="🎧 강의"
          createdAt={lecture.created_at}
        />

        <ContentDetailTable
          rows={[
            { label: "개정교육과정", value: lecture.revision },
            { label: "교과", value: lecture.subject_category },
            { label: "과목", value: lecture.subject },
            { label: "플랫폼", value: lecture.platform_name || lecture.platform },
            { label: "강의 유형", value: (lecture as any).lecture_type },
            { label: "콘텐츠 카테고리", value: lecture.content_category },
            { label: "강사명", value: (lecture as any).instructor_name },
            { label: "대상 학년", value: (lecture as any).grade_level },
            { label: "총 회차", value: lecture.total_episodes ? `${lecture.total_episodes}회` : null },
            {
              label: "총 강의시간",
              value: lecture.total_duration
                ? `${secondsToMinutes(lecture.total_duration)}분`
                : null,
            },
            { label: "난이도", value: lecture.difficulty_level },
            {
              label: "연결된 교재",
              value: linkedBook ? linkedBook.title : null,
            },
            {
              label: "출처 URL",
              value: (lecture as any).lecture_source_url,
              isUrl: !!(lecture as any).lecture_source_url,
            },
            { label: "부제목", value: (lecture as any).subtitle },
            { label: "시리즈명", value: (lecture as any).series_name },
            { label: "설명", value: (lecture as any).description },
            { label: "메모", value: lecture.notes },
          ]}
        />

        {/* 강의 회차 정보 */}
        {episodes.length > 0 && <LectureEpisodesDisplay episodes={episodes} />}

        {/* 액션 버튼 (관리자/컨설턴트만 표시) */}
        {(role === "admin" || role === "consultant") && (
          <div className="flex flex-col gap-4 border-t pt-8">
            <ContentActionButtons
              editHref={`/admin/master-lectures/${lecture.id}/edit`}
              deleteAction={deleteAction}
              listHref="/admin/master-lectures"
            />
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="admin/master-lectures/new/MasterLectureForm.tsx">
"use client";

import { useState } from "react";
import { useTransition } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { addMasterLecture } from "@/app/(student)/actions/masterContentActions";
import { LectureEpisodesManager } from "@/app/(student)/contents/_components/LectureEpisodesManager";
import { BookDetailsManager } from "@/app/(student)/contents/_components/BookDetailsManager";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

type MasterLectureFormProps = {
  curriculumRevisions: CurriculumRevision[];
};

export function MasterLectureForm({ curriculumRevisions }: MasterLectureFormProps) {
  const [isPending, startTransition] = useTransition();
  const [linkBook, setLinkBook] = useState(false);
  const router = useRouter();

  // 강의 입력값을 추적하여 교재 필드에 자동 채우기
  const [lectureValues, setLectureValues] = useState({
    revision: "",
    subject_category: "",
    subject: "",
  });

  function handleLectureFieldChange(field: string, value: string) {
    setLectureValues((prev) => ({ ...prev, [field]: value }));
  }

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    // 공통 필드를 교재 입력 필드에 자동 채우기
    if (linkBook) {
      formData.set("book_revision", lectureValues.revision);
      formData.set("book_subject_category", lectureValues.subject_category);
      formData.set("book_subject", lectureValues.subject);
    }

    startTransition(async () => {
      try {
        await addMasterLecture(formData);
      } catch (error) {
        console.error("강의 등록 실패:", error);
        alert(
          error instanceof Error ? error.message : "강의 등록에 실패했습니다."
        );
      }
    });
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm"
    >
      <div className="grid gap-4 md:grid-cols-2">
        {/* 강의명 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            강의명 <span className="text-red-500">*</span>
          </label>
          <input
            name="title"
            required
            placeholder="강의명을 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 개정교육과정 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정
          </label>
          <select
            name="revision"
            value={lectureValues.revision}
            onChange={(e) => handleLectureFieldChange("revision", e.target.value)}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.name}>
                {revision.name}
              </option>
            ))}
          </select>
        </div>

        {/* 교과 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            교과
          </label>
          <select
            name="subject_category"
            value={lectureValues.subject_category}
            onChange={(e) => handleLectureFieldChange("subject_category", e.target.value)}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="국어">국어</option>
            <option value="수학">수학</option>
            <option value="영어">영어</option>
            <option value="사회">사회</option>
            <option value="과학">과학</option>
          </select>
        </div>

        {/* 과목 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목
          </label>
          <input
            name="subject"
            placeholder="예: 화법과 작문"
            value={lectureValues.subject}
            onChange={(e) => handleLectureFieldChange("subject", e.target.value)}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 플랫폼 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            플랫폼
          </label>
          <input
            name="platform"
            placeholder="예: 메가스터디, EBSi"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 총 회차 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 회차 <span className="text-red-500">*</span>
          </label>
          <input
            name="total_episodes"
            type="number"
            required
            min="1"
            placeholder="예: 30"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 총 강의시간 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            총 강의시간 (분)
          </label>
          <input
            name="total_duration"
            type="number"
            min="0"
            placeholder="예: 1800"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 난이도 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            난이도
          </label>
          <select
            name="difficulty_level"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="개념">개념</option>
            <option value="기본">기본</option>
            <option value="심화">심화</option>
          </select>
        </div>

        {/* 연결된 교재 등록 여부 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={linkBook}
              onChange={(e) => setLinkBook(e.target.checked)}
              className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
            />
            <span className="text-sm font-medium text-gray-700">
              연결된 교재 함께 등록하기
            </span>
          </label>
          <p className="text-xs text-gray-700">
            이 강의가 특정 교재를 기반으로 하는 경우, 교재를 함께 등록할 수
            있습니다.
          </p>
        </div>

        {/* 메모 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            메모
          </label>
          <textarea
            name="notes"
            rows={3}
            placeholder="메모를 입력하세요"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>
      </div>

      {/* 강의 회차 정보 */}
      <LectureEpisodesManager />

      {/* 연결된 교재 등록 섹션 */}
      {linkBook && (
        <div className="flex flex-col gap-4 rounded-lg border-2 border-indigo-200 bg-indigo-50 p-6">
          <div className="flex flex-col gap-2">
            <h3 className="text-lg font-semibold text-gray-900">
              연결된 교재 등록
            </h3>
            <p className="text-sm text-gray-600">
              공통 정보(개정교육과정, 교과, 과목)는 강의 입력값을 참고합니다.
            </p>
          </div>
          <div className="grid gap-4 md:grid-cols-2">
            {/* 교재명 */}
            <div className="flex flex-col gap-1 md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">
                교재명 <span className="text-red-500">*</span>
              </label>
              <input
                name="book_title"
                required={linkBook}
                placeholder="교재명을 입력하세요"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>

            {/* 개정교육과정 - 강의 입력값 참고 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                개정교육과정
              </label>
              <input
                name="book_revision"
                id="book_revision"
                value={lectureValues.revision}
                placeholder="강의 입력값 참고"
                readOnly
                className="w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-600"
              />
              <p className="text-xs text-gray-700">
                강의 입력값을 참고합니다
              </p>
            </div>

            {/* 교과 - 강의 입력값 참고 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                교과
              </label>
              <input
                name="book_subject_category"
                id="book_subject_category"
                value={lectureValues.subject_category}
                placeholder="강의 입력값 참고"
                readOnly
                className="w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-600"
              />
              <p className="text-xs text-gray-700">
                강의 입력값을 참고합니다
              </p>
            </div>

            {/* 과목 - 강의 입력값 참고 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                과목
              </label>
              <input
                name="book_subject"
                id="book_subject"
                value={lectureValues.subject}
                placeholder="강의 입력값 참고"
                readOnly
                className="w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-600"
              />
              <p className="text-xs text-gray-700">
                강의 입력값을 참고합니다
              </p>
            </div>

            {/* 출판사 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                출판사
              </label>
              <input
                name="book_publisher"
                placeholder="출판사명을 입력하세요"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>

            {/* 총 페이지 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                총 페이지 <span className="text-red-500">*</span>
              </label>
              <input
                name="book_total_pages"
                type="number"
                required={linkBook}
                min="1"
                placeholder="예: 255"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>

            {/* 난이도 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                난이도
              </label>
              <select
                name="book_difficulty_level"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">선택하세요</option>
                <option value="개념">개념</option>
                <option value="기본">기본</option>
                <option value="심화">심화</option>
              </select>
            </div>

            {/* 교재 메모 */}
            <div className="flex flex-col gap-1 md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">
                교재 메모
              </label>
              <textarea
                name="book_notes"
                rows={3}
                placeholder="교재 메모를 입력하세요"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>
          </div>

          {/* 교재 상세 정보 */}
          <div className="pt-4">
            <BookDetailsManager />
          </div>
        </div>
      )}

      {/* 버튼 */}
      <div className="flex gap-3">
        <button
          type="submit"
          disabled={isPending}
          className="flex-1 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
        >
          {isPending ? "등록 중..." : "등록하기"}
        </button>
        <Link
          href="/admin/master-lectures"
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </Link>
      </div>
    </form>
  );
}
</file>

<file path="admin/master-lectures/new/page.tsx">
import Link from "next/link";
import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getCurriculumRevisions } from "@/lib/data/contentMetadata";
import { MasterLectureForm } from "./MasterLectureForm";

export default async function NewMasterLecturePage() {
  const { role } = await getCurrentUserRole();

  // 관리자 권한 확인
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  // 데이터 조회
  const curriculumRevisions = await getCurriculumRevisions().catch(() => []);

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-8">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">강의 등록</h1>
          </div>
          <Link
            href="/admin/master-lectures"
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
          >
            목록으로
          </Link>
        </div>

        <MasterLectureForm curriculumRevisions={curriculumRevisions} />
      </div>
    </section>
  );
}
</file>

<file path="admin/master-lectures/page.tsx">
import Link from "next/link";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { searchMasterLectures, getCurriculumRevisions, getPlatformsForFilter, getDifficultiesForMasterLectures } from "@/lib/data/contentMasters";
import { MasterLectureFilters } from "@/lib/data/contentMasters";
import ExcelActions from "./_components/ExcelActions";
import { secondsToMinutes } from "@/lib/utils/duration";
import { UnifiedContentFilter } from "@/components/filters/UnifiedContentFilter";

export default async function MasterLecturesPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const params = await searchParams;
  const { role } = await getCurrentUserRole();
  const tenantContext = await getTenantContext();

  const supabase = await createSupabaseServerClient();

  // 관리자/컨설턴트의 경우 자신의 테넌트 강의도 조회할 수 있도록 tenantId 전달
  // Super Admin의 경우 tenantId가 null이므로 모든 강의 조회 가능
  const tenantId = tenantContext?.tenantId || undefined;

  // 검색 필터 구성
  const filters: MasterLectureFilters = {
    curriculum_revision_id: params.curriculum_revision_id,
    subject_group_id: params.subject_group_id,
    subject_id: params.subject_id,
    platform_id: params.platform_id,
    search: params.search,
    difficulty: params.difficulty,
    sort: params.sort || "updated_at_desc",
    tenantId, // 테넌트 ID 추가
    limit: 50,
  };

  const { data: lectures, total } = await searchMasterLectures(filters);

  // 필터 옵션 조회 (드롭다운용)
  const [curriculumRevisions, platforms, difficulties] = await Promise.all([
    getCurriculumRevisions(),
    getPlatformsForFilter(tenantId),
    getDifficultiesForMasterLectures(tenantId),
  ]);

  return (
    <section className="mx-auto w-full max-w-6xl px-4 py-10">
      <div className="flex flex-col gap-8">
        {/* Header */}
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p className="text-sm font-medium text-gray-700">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">강의 목록</h1>
            <p className="text-sm text-gray-700">
              서비스에서 제공하는 강의를 검색하고 확인하세요.
            </p>
          </div>
          <div className="flex items-center gap-2">
            {(role === "admin" || role === "consultant") && (
              <>
                <ExcelActions />
                <Link
                  href="/admin/master-lectures/new"
                  className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  + 강의 등록
                </Link>
              </>
            )}
          </div>
        </div>

        {/* 검색 필터 */}
        <div className="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
          <UnifiedContentFilter
            context="admin"
            contentType="lecture"
            basePath="/admin/master-lectures"
            initialValues={{
              curriculum_revision_id: params.curriculum_revision_id,
              subject_group_id: params.subject_group_id,
              subject_id: params.subject_id,
              platform_id: params.platform_id,
              search: params.search,
              difficulty: params.difficulty,
              sort: params.sort,
            }}
            filterOptions={{
              curriculumRevisions,
              platforms,
              difficulties,
            }}
            showDifficulty={true}
            showSort={true}
            defaultSort="updated_at_desc"
          />
        </div>

        {/* 결과 개수 */}
        <div className="text-sm text-gray-600">
          총 <span className="font-semibold">{total}</span>개의 강의가
          검색되었습니다.
        </div>

        {/* 강의 목록 */}
        <div>
          {lectures.length === 0 ? (
            <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
              <div className="mx-auto flex max-w-md flex-col gap-6">
                <div className="text-6xl">🎧</div>
                <div className="flex flex-col gap-2">
                  <h3 className="text-lg font-semibold text-gray-900">
                    검색 결과가 없습니다
                  </h3>
                  <p className="text-sm text-gray-700">
                    다른 검색 조건으로 시도해보세요.
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <ul className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {lectures.map((lecture) => (
                <li
                  key={lecture.id}
                  className="rounded-lg border bg-white p-4 shadow-sm"
                >
                  <div className="flex flex-col gap-3">
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">
                        {lecture.title}
                      </h3>
                      <p className="text-sm text-gray-700">
                        {lecture.platform || "플랫폼 정보 없음"}
                      </p>
                    </div>

                    <dl className="grid gap-y-1 text-sm text-gray-600">
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">개정</dt>
                        <dd>{lecture.revision || "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">교과</dt>
                        <dd>{lecture.subject_category || "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">과목</dt>
                        <dd>{lecture.subject || "—"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">총 회차</dt>
                        <dd>{lecture.total_episodes}회</dd>
                      </div>
                      {lecture.total_duration && (
                        <div className="flex justify-between">
                          <dt className="font-medium text-gray-700">
                            총 강의시간
                          </dt>
                          <dd>{secondsToMinutes(lecture.total_duration)}분</dd>
                        </div>
                      )}
                      <div className="flex justify-between">
                        <dt className="font-medium text-gray-700">난이도</dt>
                        <dd>{lecture.difficulty_level || "—"}</dd>
                      </div>
                    </dl>

                    <Link
                      href={`/admin/master-lectures/${lecture.id}`}
                      className="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                    >
                      상세보기
                    </Link>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </section>
  );
}
</file>

<file path="admin/parent-links/_components/PendingLinkRequestCard.tsx">
"use client";

import { useState, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  approveLinkRequest,
  rejectLinkRequest,
  type PendingLinkRequest,
} from "@/app/(admin)/actions/parentStudentLinkActions";
import { ConfirmDialog } from "@/components/organisms/Dialog";

type PendingLinkRequestCardProps = {
  request: PendingLinkRequest;
  onRefresh: () => void;
  isSelectMode?: boolean;
  isSelected?: boolean;
  onToggleSelect?: () => void;
};

export function PendingLinkRequestCard({
  request,
  onRefresh,
  isSelectMode = false,
  isSelected = false,
  onToggleSelect,
}: PendingLinkRequestCardProps) {
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [isRejectDialogOpen, setIsRejectDialogOpen] = useState(false);

  function handleApprove() {
    startTransition(async () => {
      const result = await approveLinkRequest(request.id);

      if (result.success) {
        showSuccess("연결 요청이 승인되었습니다.");
        onRefresh();
      } else {
        showError(result.error || "요청 승인에 실패했습니다.");
      }
    });
  }

  function handleReject() {
    setIsRejectDialogOpen(true);
  }

  function handleConfirmReject() {
    startTransition(async () => {
      const result = await rejectLinkRequest(request.id);

      if (result.success) {
        showSuccess("연결 요청이 거부되었습니다.");
        onRefresh();
        setIsRejectDialogOpen(false);
      } else {
        showError(result.error || "요청 거부에 실패했습니다.");
      }
    });
  }

  function getRelationText(relation: string) {
    switch (relation) {
      case "father":
        return "아버지";
      case "mother":
        return "어머니";
      case "guardian":
        return "보호자";
      case "other":
        return "기타";
      default:
        return relation;
    }
  }

  return (
    <div
      className={`flex items-center justify-between rounded-lg border p-4 transition ${
        isSelected
          ? "border-indigo-500 bg-indigo-50 hover:bg-indigo-100"
          : "border-gray-200 bg-gray-50 hover:bg-gray-100"
      }`}
    >
      {isSelectMode && (
        <div>
          <input
            type="checkbox"
            checked={isSelected}
            onChange={onToggleSelect}
            className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
          />
        </div>
      )}
      <div className="flex flex-col gap-1 flex-1">
        <div className="flex items-center gap-3">
          <div className="text-base font-semibold text-gray-900">
            {request.studentName || "이름 없음"}
          </div>
          {request.studentGrade && request.studentClass && (
            <div className="text-sm text-gray-500">
              {request.studentGrade}학년 {request.studentClass}반
            </div>
          )}
        </div>
        <div className="text-sm text-gray-600">
          <span className="font-medium">학부모:</span> {request.parentName || "이름 없음"}
          {request.parentEmail && (
            <span className="text-gray-500">{" "}({request.parentEmail})</span>
          )}
        </div>
        <div className="flex items-center gap-4 text-xs text-gray-500">
          <span>관계: {getRelationText(request.relation)}</span>
          <span>
            요청일: {new Date(request.created_at).toLocaleDateString("ko-KR")}
          </span>
        </div>
      </div>
      <div className="flex gap-2">
        <button
          onClick={handleApprove}
          disabled={isPending}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
        >
          승인
        </button>
        <button
          onClick={handleReject}
          disabled={isPending}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
        >
          거부
        </button>
      </div>

      <ConfirmDialog
        open={isRejectDialogOpen}
        onOpenChange={setIsRejectDialogOpen}
        title="연결 요청 거부 확인"
        description="연결 요청을 거부하시겠습니까? 이 작업은 되돌릴 수 없습니다."
        confirmLabel="거부"
        cancelLabel="취소"
        onConfirm={handleConfirmReject}
        variant="destructive"
        isLoading={isPending}
      />
    </div>
  );
}
</file>

<file path="admin/parent-links/_components/PendingLinkRequestsList.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getPendingLinkRequests,
  approveLinkRequests,
  rejectLinkRequests,
  type PendingLinkRequest,
} from "@/app/(admin)/actions/parentStudentLinkActions";
import { PendingLinkRequestCard } from "./PendingLinkRequestCard";
import { ConfirmDialog } from "@/components/organisms/Dialog";

type PendingLinkRequestsListProps = {
  initialRequests?: PendingLinkRequest[];
  tenantId?: string | null;
};

export function PendingLinkRequestsList({
  initialRequests,
  tenantId,
}: PendingLinkRequestsListProps) {
  const { showError, showSuccess } = useToast();
  const [requests, setRequests] = useState<PendingLinkRequest[]>(
    initialRequests || []
  );
  const [isLoading, setIsLoading] = useState(!initialRequests);
  const [isPending, startTransition] = useTransition();
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [isSelectMode, setIsSelectMode] = useState(false);
  const [isApproveDialogOpen, setIsApproveDialogOpen] = useState(false);
  const [isRejectDialogOpen, setIsRejectDialogOpen] = useState(false);
  const [pendingAction, setPendingAction] = useState<"approve" | "reject" | null>(null);

  // 초기 데이터가 없으면 로드
  useEffect(() => {
    if (!initialRequests) {
      loadRequests();
    }
  }, [initialRequests]);

  async function loadRequests() {
    setIsLoading(true);
    const result = await getPendingLinkRequests(tenantId || undefined);

    if (result.success && result.data) {
      setRequests(result.data);
    } else {
      if (result.error) {
        showError(result.error);
      }
      setRequests([]);
    }
    setIsLoading(false);
  }

  function handleRefresh() {
    startTransition(async () => {
      const result = await getPendingLinkRequests(tenantId || undefined);

      if (result.success && result.data) {
        setRequests(result.data);
        setSelectedIds(new Set()); // 선택 초기화
      } else {
        if (result.error) {
          showError(result.error);
        }
      }
    });
  }

  function handleToggleSelect(id: string) {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
  }

  function handleSelectAll() {
    if (selectedIds.size === requests.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(requests.map((r) => r.id)));
    }
  }

  function handleBatchApprove() {
    if (selectedIds.size === 0) return;
    setPendingAction("approve");
    setIsApproveDialogOpen(true);
  }

  function handleConfirmBatchApprove() {
    startTransition(async () => {
      const linkIds = Array.from(selectedIds);
      const result = await approveLinkRequests(linkIds);

      if (result.success) {
        showSuccess(
          `${result.approvedCount || 0}개의 연결 요청이 승인되었습니다.`
        );
        setSelectedIds(new Set());
        handleRefresh();
        setIsApproveDialogOpen(false);
      } else {
        if (result.errors && result.errors.length > 0) {
          const errorMessages = result.errors
            .map((e) => `${e.linkId}: ${e.error}`)
            .join("\n");
          showError(
            `${result.approvedCount || 0}개 승인 완료. 일부 실패:\n${errorMessages}`
          );
        } else {
          showError("일괄 승인에 실패했습니다.");
        }
        // 부분 성공 시에도 새로고침
        if (result.approvedCount && result.approvedCount > 0) {
          handleRefresh();
        }
      }
      setPendingAction(null);
    });
  }

  function handleBatchReject() {
    if (selectedIds.size === 0) return;
    setPendingAction("reject");
    setIsRejectDialogOpen(true);
  }

  function handleConfirmBatchReject() {
    startTransition(async () => {
      const linkIds = Array.from(selectedIds);
      const result = await rejectLinkRequests(linkIds);

      if (result.success) {
        showSuccess(
          `${result.rejectedCount || 0}개의 연결 요청이 거부되었습니다.`
        );
        setSelectedIds(new Set());
        handleRefresh();
        setIsRejectDialogOpen(false);
      } else {
        if (result.errors && result.errors.length > 0) {
          const errorMessages = result.errors
            .map((e) => `${e.linkId}: ${e.error}`)
            .join("\n");
          showError(
            `${result.rejectedCount || 0}개 거부 완료. 일부 실패:\n${errorMessages}`
          );
        } else {
          showError("일괄 거부에 실패했습니다.");
        }
        // 부분 성공 시에도 새로고침
        if (result.rejectedCount && result.rejectedCount > 0) {
          handleRefresh();
        }
      }
      setPendingAction(null);
    });
  }

  if (isLoading) {
    return (
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div className="flex items-center justify-between">
          <div className="h-7 w-48 animate-pulse rounded bg-gray-200" />
        </div>
        <div className="text-center text-sm text-gray-500">로딩 중...</div>
      </div>
    );
  }

  if (requests.length === 0) {
    return (
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="text-xl font-semibold text-gray-900">
          승인 대기 중인 연결 요청
        </h2>
        <div className="py-8 text-center text-sm text-gray-500">
          승인 대기 중인 연결 요청이 없습니다.
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-semibold text-gray-900">
            승인 대기 중인 연결 요청 ({requests.length}건)
          </h2>
          {isSelectMode && selectedIds.size > 0 && (
            <span className="text-sm text-gray-600">
              {selectedIds.size}개 선택됨
            </span>
          )}
        </div>
        <div className="flex items-center gap-2">
          {isSelectMode ? (
            <>
              <button
                onClick={handleSelectAll}
                disabled={isPending}
                className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
              >
                {selectedIds.size === requests.length ? "전체 해제" : "전체 선택"}
              </button>
              <button
                onClick={handleBatchApprove}
                disabled={isPending || selectedIds.size === 0}
                className="rounded-lg bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50"
              >
                선택 항목 승인 ({selectedIds.size})
              </button>
              <button
                onClick={handleBatchReject}
                disabled={isPending || selectedIds.size === 0}
                className="rounded-lg border border-red-300 bg-white px-3 py-1.5 text-sm font-medium text-red-700 transition hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"
              >
                선택 항목 거부 ({selectedIds.size})
              </button>
              <button
                onClick={() => {
                  setIsSelectMode(false);
                  setSelectedIds(new Set());
                }}
                disabled={isPending}
                className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
              >
                선택 모드 종료
              </button>
            </>
          ) : (
            <>
              <button
                onClick={() => setIsSelectMode(true)}
                disabled={isPending}
                className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
              >
                선택 모드
              </button>
              <button
                onClick={handleRefresh}
                disabled={isPending}
                className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
              >
                새로고침
              </button>
            </>
          )}
        </div>
      </div>
      <div className="flex flex-col gap-3">
        {requests.map((request) => (
          <PendingLinkRequestCard
            key={request.id}
            request={request}
            onRefresh={handleRefresh}
            isSelectMode={isSelectMode}
            isSelected={selectedIds.has(request.id)}
            onToggleSelect={() => handleToggleSelect(request.id)}
          />
        ))}
      </div>

      <ConfirmDialog
        open={isApproveDialogOpen}
        onOpenChange={setIsApproveDialogOpen}
        title="일괄 승인 확인"
        description={`선택한 ${selectedIds.size}개의 연결 요청을 승인하시겠습니까?`}
        confirmLabel="승인"
        cancelLabel="취소"
        onConfirm={handleConfirmBatchApprove}
        variant="default"
        isLoading={isPending}
      />

      <ConfirmDialog
        open={isRejectDialogOpen}
        onOpenChange={setIsRejectDialogOpen}
        title="일괄 거부 확인"
        description={`선택한 ${selectedIds.size}개의 연결 요청을 거부하시겠습니까? 이 작업은 되돌릴 수 없습니다.`}
        confirmLabel="거부"
        cancelLabel="취소"
        onConfirm={handleConfirmBatchReject}
        variant="destructive"
        isLoading={isPending}
      />
    </div>
  );
}
</file>

<file path="admin/parent-links/_components/PendingLinkRequestsSkeleton.tsx">
export function PendingLinkRequestsSkeleton() {
  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="h-7 w-48 animate-pulse rounded bg-gray-200" />
      </div>
      <div className="space-y-3">
        {[1, 2, 3].map((i) => (
          <div
            key={i}
            className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-4"
          >
            <div className="flex-1 space-y-2">
              <div className="h-5 w-32 animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-24 animate-pulse rounded bg-gray-200" />
              <div className="h-3 w-40 animate-pulse rounded bg-gray-200" />
            </div>
            <div className="flex gap-2">
              <div className="h-9 w-16 animate-pulse rounded bg-gray-200" />
              <div className="h-9 w-16 animate-pulse rounded bg-gray-200" />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin/parent-links/page.tsx">
export const dynamic = 'force-dynamic';

import { Suspense } from "react";
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { PendingLinkRequestsList } from "./_components/PendingLinkRequestsList";
import { PendingLinkRequestsSkeleton } from "./_components/PendingLinkRequestsSkeleton";

export default async function ParentLinksPage() {
  const { userId, role, tenantId } = await getCurrentUserRole();

  // 권한 확인
  if (!userId || (role !== "admin" && role !== "consultant")) {
    redirect("/admin/dashboard");
  }

  return (
    <div className="p-6 md:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-h1 text-gray-900">학부모 연결 관리</h1>
        <p className="text-sm text-gray-600">
          학부모가 요청한 학생 연결을 승인하거나 거부할 수 있습니다.
        </p>
      </div>

      <Suspense fallback={<PendingLinkRequestsSkeleton />}>
        <PendingLinkRequestsList tenantId={tenantId} />
      </Suspense>
    </div>
  );
}
</file>

<file path="admin/plan-groups/[id]/page.tsx">
import Link from "next/link";
import { redirect, notFound } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getPlanGroupWithDetailsForAdmin } from "@/lib/data/planGroups";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { PlanGroupDetailView } from "@/app/(student)/plan/group/[id]/_components/PlanGroupDetailView";
import { classifyPlanContents } from "@/lib/data/planContents";
import {
  planPurposeLabels,
  schedulerTypeLabels,
  statusLabels,
  statusColors,
} from "@/lib/constants/planLabels";
import { getCampTemplateImpactSummary } from "@/lib/data/campTemplates";

type AdminPlanGroupDetailPageProps = {
  params: Promise<{ id: string }>;
};

export default async function AdminPlanGroupDetailPage({
  params,
}: AdminPlanGroupDetailPageProps) {
  const { id } = await params;

  // 권한 확인
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  // tenantId 조회
  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  // 플랜 그룹 및 관련 데이터 조회 (관리자용 함수 사용)
  const { group, contents, exclusions, academySchedules } =
    await getPlanGroupWithDetailsForAdmin(id, tenantContext.tenantId);

  if (!group) {
    notFound();
  }

  // 콘텐츠 정보 조회 및 학생/추천 구분
  // 관리자/컨설턴트가 다른 학생의 콘텐츠를 조회할 때는 역할 정보 전달 (RLS 우회)
  const { userId } = await getCurrentUserRole();
  const { studentContents, recommendedContents } = await classifyPlanContents(
    contents,
    group.student_id,
    {
      currentUserRole: role,
      currentUserId: userId || undefined,
    }
  );

  // 상세 페이지 형식으로 변환
  const allContents = [...studentContents, ...recommendedContents];
  const contentsMap = new Map(allContents.map((c) => [c.content_id, c]));

  const contentsWithDetails = contents.map((content) => {
    const detail = contentsMap.get(content.content_id);
    if (!detail) {
      return {
        ...content,
        contentTitle: "알 수 없음",
        contentSubtitle: null,
        isRecommended: false,
      };
    }

    return {
      ...content,
      contentTitle: detail.title || "알 수 없음",
      contentSubtitle: detail.subject_category || null,
      isRecommended: detail.isRecommended,
    };
  });

  const supabase = await createSupabaseServerClient();

  // 플랜 데이터 조회
  const { data: plans } = await supabase
    .from("student_plan")
    .select("id,planned_end_page_or_time,completed_amount")
    .eq("plan_group_id", id)
    .not("plan_group_id", "is", null);

  const planCount = plans?.length || 0;
  const hasPlans = planCount > 0;

  // 완료 여부 및 완료 개수 계산
  let isCompleted = false;
  let completedCount = 0;

  if (plans && plans.length > 0) {
    const completedPlans = plans.filter((plan) => {
      if (!plan.planned_end_page_or_time) return false;
      return (
        plan.completed_amount !== null &&
        plan.completed_amount >= plan.planned_end_page_or_time
      );
    });
    completedCount = completedPlans.length;
    isCompleted = completedPlans.length === plans.length;
  }

  // 표시할 상태 결정
  const getDisplayStatus = () => {
    if (isCompleted || group.status === "completed") {
      return { label: "완료", color: statusColors.completed };
    }

    if (statusLabels[group.status]) {
      return {
        label: statusLabels[group.status],
        color: statusColors[group.status],
      };
    }

    return null;
  };

  const displayStatus = getDisplayStatus();

  // 캠프 모드 확인
  const isCampMode = group.plan_type === "camp";

  // 캠프 모드일 때 템플릿 블록 세트 정보 조회
  let templateBlocks: Array<{
    id: string;
    day_of_week: number;
    start_time: string;
    end_time: string;
  }> = [];
  let templateBlockSetName: string | null = null;
  let templateBlockSetId: string | null = null;

  if (isCampMode && group.camp_template_id) {
    try {
      // block_set_id 찾기: camp_template_id로 직접 조회 (가장 간단하고 명확한 방법)
      let blockSetId: string | null = null;

      // 1. 연결 테이블에서 직접 조회 (가장 직접적인 방법)
      if (group.camp_template_id) {
        const { data: templateBlockSetLink, error: linkError } = await supabase
          .from("camp_template_block_sets")
          .select("tenant_block_set_id")
          .eq("camp_template_id", group.camp_template_id)
          .maybeSingle();

        if (linkError) {
          console.error(
            "[AdminPlanGroupDetailPage] 템플릿 블록 세트 연결 조회 에러:",
            linkError
          );
        } else if (templateBlockSetLink) {
          blockSetId = templateBlockSetLink.tenant_block_set_id;
          console.log(
            "[AdminPlanGroupDetailPage] 연결 테이블에서 block_set_id 발견:",
            blockSetId
          );
        }
      }

      // 2. scheduler_options에서 template_block_set_id 확인 (Fallback)
      if (!blockSetId && group.scheduler_options) {
        let schedulerOptions: any = null;
        if (typeof group.scheduler_options === "string") {
          try {
            schedulerOptions = JSON.parse(group.scheduler_options);
          } catch (parseError) {
            console.error(
              "[AdminPlanGroupDetailPage] scheduler_options 파싱 에러:",
              parseError
            );
          }
        } else {
          schedulerOptions = group.scheduler_options;
        }

        if (schedulerOptions?.template_block_set_id) {
          blockSetId = schedulerOptions.template_block_set_id;
          console.log(
            "[AdminPlanGroupDetailPage] scheduler_options에서 template_block_set_id 발견 (Fallback):",
            blockSetId
          );
        }
      }

      // 3. template_data에서 block_set_id 확인 (하위 호환성, 마이그레이션 전 데이터용)
      if (!blockSetId) {
        const { data: template, error: templateError } = await supabase
          .from("camp_templates")
          .select("template_data")
          .eq("id", group.camp_template_id)
          .maybeSingle();

        if (!templateError && template?.template_data) {
          try {
            let templateData: any = null;
            if (typeof template.template_data === "string") {
              templateData = JSON.parse(template.template_data);
            } else {
              templateData = template.template_data;
            }

            if (templateData?.block_set_id) {
              blockSetId = templateData.block_set_id;
              console.log(
                "[AdminPlanGroupDetailPage] template_data에서 block_set_id 발견 (하위 호환성):",
                blockSetId
              );
            }
          } catch (parseError) {
            console.error(
              "[AdminPlanGroupDetailPage] template_data 파싱 에러:",
              parseError
            );
          }
        }
      }

      console.log("[AdminPlanGroupDetailPage] 최종 blockSetId:", blockSetId);

      if (blockSetId) {
        // tenant_block_sets에서 블록 세트 조회 (올바른 테이블 사용)
        const { data: templateBlockSet, error: blockSetError } = await supabase
          .from("tenant_block_sets")
          .select("id, name")
          .eq("id", blockSetId)
          .eq("tenant_id", tenantContext.tenantId)
          .maybeSingle();

        if (blockSetError) {
          console.error(
            "[AdminPlanGroupDetailPage] 템플릿 블록 세트 조회 에러:",
            blockSetError
          );
        } else if (templateBlockSet) {
          templateBlockSetName = templateBlockSet.name;
          templateBlockSetId = templateBlockSet.id;

          // tenant_blocks 테이블에서 블록 조회 (올바른 테이블 사용)
          const { data: blocks, error: blocksError } = await supabase
            .from("tenant_blocks")
            .select("id, day_of_week, start_time, end_time")
            .eq("tenant_block_set_id", templateBlockSet.id)
            .order("day_of_week", { ascending: true })
            .order("start_time", { ascending: true });

          if (blocksError) {
            console.error(
              "[AdminPlanGroupDetailPage] 템플릿 블록 조회 에러:",
              blocksError
            );
          } else if (blocks && blocks.length > 0) {
            templateBlocks = blocks.map((b) => ({
              id: b.id,
              day_of_week: b.day_of_week,
              start_time: b.start_time,
              end_time: b.end_time,
            }));

            console.log(
              "[AdminPlanGroupDetailPage] 템플릿 블록 조회 성공:",
              {
                blockSetName: templateBlockSetName,
                blockCount: templateBlocks.length,
              }
            );
          } else {
            console.warn(
              "[AdminPlanGroupDetailPage] 템플릿 블록이 없음:",
              {
                blockSetId: templateBlockSet.id,
                blockSetName: templateBlockSetName,
              }
            );
          }
        }
      }
    } catch (error) {
      console.error("[AdminPlanGroupDetailPage] 템플릿 블록 조회 중 에러:", error);
    }
  }

  // 학생 정보 조회
  const { data: studentInfo } = await supabase
    .from("students")
    .select("name, grade, class")
    .eq("id", group.student_id)
    .maybeSingle();

  // 캠프 템플릿 통계 조회 (camp_template_id가 있을 때만)
  let templateImpactSummary = null;
  if (isCampMode && group.camp_template_id) {
    try {
      templateImpactSummary = await getCampTemplateImpactSummary(
        group.camp_template_id,
        tenantContext.tenantId
      );
    } catch (error) {
      console.error(
        "[AdminPlanGroupDetailPage] 템플릿 통계 조회 실패:",
        error
      );
    }
  }

  return (
    <section className="mx-auto w-full max-w-5xl px-4 py-6 md:py-10">
      <div className="flex flex-col gap-6">
        {/* 상단 액션 바 */}
        <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
          <Link
            href={
              isCampMode && group.camp_template_id
                ? `/admin/camp-templates/${group.camp_template_id}/participants`
                : "/admin/dashboard"
            }
            className="inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-100"
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            {isCampMode && group.camp_template_id
              ? "참여자 목록으로"
              : "대시보드로"}
          </Link>
        </div>

        {/* 학생 정보 카드 */}
        {studentInfo && (
          <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
            <div className="flex items-center gap-3">
              <div>
                <p className="text-sm font-semibold text-blue-900">
                  {studentInfo.name || "이름 없음"}
                </p>
                <p className="text-xs text-blue-700">
                  {studentInfo.grade && studentInfo.class
                    ? `${studentInfo.grade}학년 ${studentInfo.class}반`
                    : studentInfo.grade
                    ? `${studentInfo.grade}학년`
                    : ""}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 헤더 정보 카드 */}
        <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
          <div className="flex flex-col gap-4">
            {/* 상태 뱃지들 */}
            <div className="flex flex-wrap items-center gap-2">
              {hasPlans && (
                <span className="inline-block rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-semibold text-blue-800">
                  플랜 생성 완료
                </span>
              )}
              {displayStatus && (
                <span
                  className={`inline-block rounded-full px-2.5 py-0.5 text-xs font-semibold ${displayStatus.color}`}
                >
                  {displayStatus.label}
                </span>
              )}
            </div>

            {/* 플랜 그룹 이름 */}
            <div>
              <h1 className="text-3xl font-semibold text-gray-900">
                {group.name || "플랜 그룹"}
              </h1>
            </div>

            {/* 핵심 정보 */}
            <div className="grid gap-4 border-t border-gray-100 pt-4 sm:grid-cols-2 lg:grid-cols-3">
              <div className="flex flex-col gap-1">
                <dt className="text-xs font-medium text-gray-500">플랜 목적</dt>
                <dd className="text-sm font-semibold text-gray-900">
                  {group.plan_purpose
                    ? planPurposeLabels[group.plan_purpose] ||
                      group.plan_purpose
                    : "—"}
                </dd>
              </div>
              <div className="flex flex-col gap-1">
                <dt className="text-xs font-medium text-gray-500">
                  스케줄러 유형
                </dt>
                <dd className="text-sm font-semibold text-gray-900">
                  {group.scheduler_type
                    ? schedulerTypeLabels[group.scheduler_type] ||
                      group.scheduler_type
                    : "—"}
                </dd>
              </div>
              <div className="flex flex-col gap-1">
                <dt className="text-xs font-medium text-gray-500">학습 기간</dt>
                <dd className="text-sm font-semibold text-gray-900">
                  {group.period_start && group.period_end
                    ? `${new Date(group.period_start).toLocaleDateString(
                        "ko-KR",
                        {
                          month: "short",
                          day: "numeric",
                        }
                      )} ~ ${new Date(group.period_end).toLocaleDateString(
                        "ko-KR",
                        {
                          month: "short",
                          day: "numeric",
                        }
                      )}`
                    : "—"}
                </dd>
              </div>
              {group.target_date && (
                <div className="flex flex-col gap-1">
                  <dt className="text-xs font-medium text-gray-500">
                    목표 날짜
                  </dt>
                  <dd className="text-sm font-semibold text-gray-900">
                    {new Date(group.target_date).toLocaleDateString("ko-KR")}
                  </dd>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* 템플릿 통계 (캠프 모드일 때만 표시) */}
        {isCampMode && group.camp_template_id && templateImpactSummary && (
          <div className="rounded-lg border border-amber-200 bg-amber-50 p-5 text-sm text-amber-900">
            <div className="flex flex-wrap items-center gap-4">
              <div>
                <p className="text-xs uppercase tracking-wide text-amber-700">
                  초대 현황
                </p>
                <p className="text-base font-semibold">
                  대기 {templateImpactSummary.invitationStats.pending} · 참여{" "}
                  {templateImpactSummary.invitationStats.accepted} · 거절{" "}
                  {templateImpactSummary.invitationStats.declined}
                </p>
              </div>
              <div className="h-6 w-px bg-amber-200" aria-hidden="true" />
              <div>
                <p className="text-xs uppercase tracking-wide text-amber-700">
                  플랜 진행
                </p>
                <p className="text-base font-semibold">
                  작성 중 {templateImpactSummary.planGroupStats.draft} · 검토 중{" "}
                  {templateImpactSummary.planGroupStats.saved} · 활성{" "}
                  {templateImpactSummary.planGroupStats.active}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 진행 상황 카드 */}
        {hasPlans && (
          <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <p className="text-sm font-medium text-gray-500">진행 상황</p>
                <p className="text-2xl font-semibold text-gray-900">
                  {completedCount} / {planCount}
                </p>
              </div>
              <div className="flex flex-col gap-1 text-right">
                <p className="text-sm font-medium text-gray-500">완료율</p>
                <p className="text-2xl font-semibold text-gray-900">
                  {planCount > 0
                    ? Math.round((completedCount / planCount) * 100)
                    : 0}
                  %
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 탭 컨텐츠 영역 */}
        <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
          <PlanGroupDetailView
            group={group}
            contents={contents}
            exclusions={exclusions}
            academySchedules={academySchedules}
            contentsWithDetails={contentsWithDetails}
            canEdit={false}
            groupId={id}
            hasPlans={hasPlans}
            templateBlocks={templateBlocks}
            templateBlockSetName={templateBlockSetName}
            templateBlockSetId={templateBlockSetId}
            campTemplateId={group.camp_template_id}
          />
        </div>
      </div>
    </section>
  );
}
</file>

<file path="admin/recommendation-settings/_components/RangeRecommendationSettings.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getRangeRecommendationSettingsAction,
  updateRangeRecommendationSettingsAction,
  resetRangeRecommendationSettingsAction,
} from "@/app/(admin)/actions/recommendationSettings";
import type { RangeRecommendationConfig } from "@/lib/recommendations/config/types";
import { defaultRangeRecommendationConfig } from "@/lib/recommendations/config/defaultConfig";
import { Spinner } from "@/components/atoms/Spinner";
import Button from "@/components/atoms/Button";
import Input from "@/components/atoms/Input";
import Label from "@/components/atoms/Label";

export function RangeRecommendationSettings() {
  const { showSuccess, showError } = useToast();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [config, setConfig] = useState<RangeRecommendationConfig>(
    defaultRangeRecommendationConfig
  );

  useEffect(() => {
    const loadSettings = async () => {
      try {
        const result = await getRangeRecommendationSettingsAction();
        if (result.success && result.config) {
          setConfig(result.config);
        } else if (result.error) {
          showError(result.error);
        }
      } catch (error) {
        console.error("Failed to load range recommendation settings:", error);
        showError("설정을 불러오는데 실패했습니다.");
      } finally {
        setLoading(false);
      }
    };

    loadSettings();
  }, [showError]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);

    try {
      const result = await updateRangeRecommendationSettingsAction(config);

      if (result.success) {
        showSuccess("설정이 저장되었습니다.");
      } else {
        showError(result.error || "설정 저장에 실패했습니다.");
      }
    } catch (error) {
      console.error("Failed to save range recommendation settings:", error);
      showError("설정 저장 중 오류가 발생했습니다.");
    } finally {
      setSaving(false);
    }
  };

  const handleReset = async () => {
    if (!confirm("설정을 기본값으로 재설정하시겠습니까?")) {
      return;
    }

    setSaving(true);

    try {
      const result = await resetRangeRecommendationSettingsAction();

      if (result.success) {
        setConfig(defaultRangeRecommendationConfig);
        showSuccess("설정이 기본값으로 재설정되었습니다.");
      } else {
        showError(result.error || "설정 재설정에 실패했습니다.");
      }
    } catch (error) {
      console.error("Failed to reset range recommendation settings:", error);
      showError("설정 재설정 중 오류가 발생했습니다.");
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Spinner />
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6">
      <div className="flex flex-col gap-6 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
        <div className="flex flex-col gap-2">
          <h2 className="text-h2 text-gray-900 dark:text-gray-100">
            범위 추천 설정
          </h2>
          <p className="text-sm text-gray-600 dark:text-gray-400">
            학습 범위 추천 알고리즘의 파라미터를 조정합니다. 이 설정은 학습 범위
            추천 계산에 사용됩니다.
          </p>
        </div>

        <div className="flex flex-col gap-6">
          <div className="flex flex-col gap-1">
            <Label
              htmlFor="pagesPerHour"
              className="block text-body-2-bold text-gray-800 dark:text-gray-200"
            >
              교재: 시간당 페이지 수
            </Label>
            <Input
              id="pagesPerHour"
              type="number"
              min="1"
              max="100"
              step="0.1"
              value={config.pagesPerHour}
              onChange={(e) =>
                setConfig({
                  ...config,
                  pagesPerHour: parseFloat(e.target.value) || 10,
                })
              }
              className="w-full max-w-xs"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400">
              1시간에 몇 페이지를 학습할 것으로 예상하는지 설정합니다. 현재
              값: {config.pagesPerHour}페이지/시간
            </p>
          </div>

          <div className="flex flex-col gap-1">
            <Label
              htmlFor="episodesPerHour"
              className="block text-body-2-bold text-gray-800 dark:text-gray-200"
            >
              강의: 시간당 회차 수
            </Label>
            <Input
              id="episodesPerHour"
              type="number"
              min="0.1"
              max="10"
              step="0.1"
              value={config.episodesPerHour}
              onChange={(e) =>
                setConfig({
                  ...config,
                  episodesPerHour: parseFloat(e.target.value) || 1,
                })
              }
              className="w-full max-w-xs"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400">
              1시간에 몇 회차를 학습할 것으로 예상하는지 설정합니다. 현재 값:{" "}
              {config.episodesPerHour}회차/시간
            </p>
          </div>
        </div>
      </div>

      <div className="flex gap-4">
        <Button type="submit" disabled={saving}>
          {saving ? "저장 중..." : "저장"}
        </Button>
        <Button
          type="button"
          variant="outline"
          onClick={handleReset}
          disabled={saving}
        >
          기본값으로 재설정
        </Button>
      </div>
    </form>
  );
}
</file>

<file path="admin/recommendation-settings/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { RangeRecommendationSettings } from "./_components/RangeRecommendationSettings";

export default async function RecommendationSettingsPage() {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-h1 text-gray-900">추천 시스템 설정</h1>
        <p className="text-body-2 text-gray-600">
          추천 알고리즘의 파라미터를 조정합니다.
        </p>
      </div>

      <RangeRecommendationSettings />
    </div>
  );
}
</file>

<file path="admin/reports/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import Link from "next/link";
import { EmptyState } from "@/components/ui/EmptyState";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

type StudentRow = {
  id: string;
  name?: string | null;
};

export default async function AdminReportsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const params = await searchParams;
  const searchQuery = params.search?.trim() ?? "";
  const period = (params.period as "weekly" | "monthly") || "weekly";

  // 학생 목록 조회
  const selectStudents = () =>
    supabase.from("students").select("id,name,grade").order("name", { ascending: true });

  let query = selectStudents();

  if (searchQuery) {
    query = query.ilike("name", `%${searchQuery}%`);
  }

  let { data: students, error } = await query;

  if (error && error.code === "42703") {
    ({ data: students, error } = await selectStudents());
  }

  if (error) {
    console.error("[admin/reports] 학생 목록 조회 실패", error);
  }

  const studentRows = (students as (StudentRow & { grade?: string | null })[] | null) ?? [];

  // 날짜 범위 계산
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  let periodLabel = "";
  if (period === "weekly") {
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() + mondayOffset);
    const year = weekStart.getFullYear();
    const month = weekStart.getMonth() + 1;
    const weekNumber = Math.ceil((weekStart.getDate() + (7 - weekStart.getDay())) / 7);
    periodLabel = `${year}년 ${month}월 ${weekNumber}주차`;
  } else {
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    periodLabel = `${year}년 ${month}월`;
  }

  return (
    <div className="flex flex-col gap-6 p-6 md:p-10">
      <div className="flex items-center justify-between">
        <div className="flex flex-col gap-2">
          <h1 className="text-h1 text-gray-900">리포트 관리</h1>
          <p className="text-body-2 text-gray-600">
            학생별 주간/월간 리포트를 생성하고 조회할 수 있습니다.
          </p>
        </div>
        <div className="flex gap-2">
          <Link
            href="/admin/reports?period=weekly"
            className={`rounded-lg px-4 py-2 text-sm font-semibold transition ${
              period === "weekly"
                ? "bg-indigo-600 text-white"
                : "border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
            }`}
          >
            주간 리포트
          </Link>
          <Link
            href="/admin/reports?period=monthly"
            className={`rounded-lg px-4 py-2 text-sm font-semibold transition ${
              period === "monthly"
                ? "bg-indigo-600 text-white"
                : "border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
            }`}
          >
            월간 리포트
          </Link>
        </div>
      </div>

      {/* 검색 바 */}
      <div>
        <form method="get" className="flex gap-2">
          <input type="hidden" name="period" value={period} />
          <input
            type="text"
            name="search"
            placeholder="학생 이름으로 검색..."
            defaultValue={searchQuery}
            className="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          />
          <button
            type="submit"
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            검색
          </button>
          {searchQuery && (
            <Link
              href={`/admin/reports?period=${period}`}
              className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </Link>
          )}
        </form>
      </div>

      {studentRows.length === 0 ? (
        <EmptyState
          title="등록된 학생이 없습니다"
          description="리포트를 생성할 학생이 없습니다."
        />
      ) : (
        <div className="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div className="border-b border-gray-200 bg-gray-50 px-6 py-3">
            <h2 className="text-sm font-semibold text-gray-900">
              {period === "weekly" ? "주간" : "월간"} 리포트 ({periodLabel})
            </h2>
          </div>
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  이름
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  학년
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  작업
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 bg-white">
              {studentRows.map((student) => (
                <tr key={student.id} className="hover:bg-gray-50">
                  <td className="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">
                    {student.name ?? "이름 없음"}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.grade ? `${student.grade}학년` : "-"}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    <div className="flex gap-3">
                      <Link
                        href={`/admin/students/${student.id}?tab=analysis`}
                        className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                      >
                        상세 분석
                      </Link>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/reschedule-logs/_components/RescheduleLogDetail.tsx">
/**
 * 재조정 로그 상세 컴포넌트
 * 
 * 재조정 로그의 상세 정보를 표시합니다.
 */

"use client";

import { useState, useEffect } from "react";
import { createSupabaseBrowserClient } from "@/lib/supabase/client";

type RescheduleLogDetailProps = {
  logId: string;
};

export function RescheduleLogDetail({ logId }: RescheduleLogDetailProps) {
  const [loading, setLoading] = useState(true);
  const [log, setLog] = useState<any>(null);
  const [histories, setHistories] = useState<any[]>([]);

  useEffect(() => {
    loadDetail();
  }, [logId]);

  const loadDetail = async () => {
    setLoading(true);
    const supabase = createSupabaseBrowserClient();

    try {
      // 로그 상세 조회
      const { data: logData, error: logError } = await supabase
        .from("reschedule_log")
        .select("*")
        .eq("id", logId)
        .single();

      if (logError) throw logError;

      // 관련 히스토리 조회
      const { data: historyData, error: historyError } = await supabase
        .from("plan_history")
        .select("*")
        .eq("reschedule_log_id", logId)
        .order("created_at", { ascending: false });

      if (historyError) {
        console.error("[RescheduleLogDetail] 히스토리 조회 실패:", historyError);
      }

      setLog(logData);
      setHistories(historyData || []);
    } catch (error) {
      console.error("[RescheduleLogDetail] 조회 실패:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-8">
        <div className="flex flex-col items-center gap-2">
          <div className="inline-block h-6 w-6 animate-spin rounded-full border-2 border-solid border-blue-600 border-r-transparent"></div>
          <p className="text-sm text-gray-600">로딩 중...</p>
        </div>
      </div>
    );
  }

  if (!log) {
    return (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center">
        <p className="text-sm text-gray-600">로그를 불러올 수 없습니다.</p>
      </div>
    );
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-gray-50 p-4">
      <div className="flex flex-col gap-4">
        {/* 조정된 콘텐츠 */}
        <div className="flex flex-col gap-2">
          <h4 className="text-sm font-semibold text-gray-900">
            조정된 콘텐츠
          </h4>
          <div className="rounded-lg border border-gray-200 bg-white p-3">
            <pre className="overflow-auto text-xs text-gray-700">
              {JSON.stringify(log.adjusted_contents, null, 2)}
            </pre>
          </div>
        </div>

        {/* 관련 히스토리 */}
        <div className="flex flex-col gap-2">
          <h4 className="text-sm font-semibold text-gray-900">
            관련 플랜 히스토리 ({histories.length}개)
          </h4>
          {histories.length === 0 ? (
            <p className="text-sm text-gray-500">히스토리가 없습니다.</p>
          ) : (
            <div className="space-y-2">
              {histories.map((history) => (
                <div
                  key={history.id}
                  className="rounded-lg border border-gray-200 bg-white p-3"
                >
                  <div className="flex items-center gap-2 text-xs text-gray-600">
                    <span>플랜 ID: {history.plan_id}</span>
                    {history.adjustment_type && (
                      <>
                        <span>•</span>
                        <span>조정 유형: {history.adjustment_type}</span>
                      </>
                    )}
                    <span>•</span>
                    <span>{new Date(history.created_at).toLocaleString("ko-KR")}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/reschedule-logs/_components/RescheduleLogsList.tsx">
/**
 * 재조정 로그 목록 컴포넌트
 * 
 * 재조정 로그를 표시하고 필터링할 수 있는 컴포넌트입니다.
 */

"use client";

import { useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import { RescheduleLogDetail } from "./RescheduleLogDetail";

type RescheduleLog = {
  id: string;
  plan_group_id: string;
  student_id: string;
  adjusted_contents: any;
  plans_before_count: number;
  plans_after_count: number;
  reason: string | null;
  status: string;
  rolled_back_at: string | null;
  created_at: string;
  plan_groups: {
    id: string;
    name: string | null;
    student_id: string;
  };
  students: {
    id: string;
    name: string | null;
  };
};

type RescheduleLogsListProps = {
  logs: RescheduleLog[];
  initialFilters: {
    planGroupId: string;
    studentId: string;
    startDate: string;
    endDate: string;
  };
};

export function RescheduleLogsList({
  logs,
  initialFilters,
}: RescheduleLogsListProps) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [selectedLogId, setSelectedLogId] = useState<string | null>(null);
  const [filters, setFilters] = useState(initialFilters);

  const handleFilterChange = (key: string, value: string) => {
    const newFilters = { ...filters, [key]: value };
    setFilters(newFilters);

    // URL 파라미터 업데이트
    const params = new URLSearchParams(searchParams.toString());
    if (value) {
      params.set(key, value);
    } else {
      params.delete(key);
    }
    router.push(`?${params.toString()}`);
  };

  const getStatusLabel = (status: string) => {
    switch (status) {
      case "pending":
        return "대기 중";
      case "completed":
        return "완료";
      case "failed":
        return "실패";
      case "rolled_back":
        return "롤백됨";
      default:
        return status;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "pending":
        return "bg-gray-100 text-gray-700";
      case "completed":
        return "bg-green-100 text-green-700";
      case "failed":
        return "bg-red-100 text-red-700";
      case "rolled_back":
        return "bg-yellow-100 text-yellow-700";
      default:
        return "bg-gray-100 text-gray-700";
    }
  };

  return (
    <div className="flex flex-col gap-6">
      {/* 필터 */}
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="grid grid-cols-1 gap-4 md:grid-cols-4">
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              플랜 그룹 ID
            </label>
            <input
              type="text"
              value={filters.planGroupId}
              onChange={(e) => handleFilterChange("planGroupId", e.target.value)}
              placeholder="플랜 그룹 ID"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              학생 ID
            </label>
            <input
              type="text"
              value={filters.studentId}
              onChange={(e) => handleFilterChange("studentId", e.target.value)}
              placeholder="학생 ID"
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              시작 날짜
            </label>
            <input
              type="date"
              value={filters.startDate}
              onChange={(e) => handleFilterChange("startDate", e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              종료 날짜
            </label>
            <input
              type="date"
              value={filters.endDate}
              onChange={(e) => handleFilterChange("endDate", e.target.value)}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>
        </div>
      </div>

      {/* 로그 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white">
        <div className="border-b border-gray-200 px-6 py-4">
          <h2 className="text-lg font-semibold text-gray-900">
            재조정 로그 ({logs.length}개)
          </h2>
        </div>
        <div className="divide-y divide-gray-200">
          {logs.length === 0 ? (
            <div className="px-6 py-12 text-center">
              <p className="text-sm text-gray-500">재조정 로그가 없습니다.</p>
            </div>
          ) : (
            logs.map((log) => (
              <div
                key={log.id}
                className="px-6 py-4 hover:bg-gray-50 transition"
              >
                <div className="flex items-center justify-between">
                  <div className="flex flex-1 flex-col gap-2">
                    <div className="flex items-center gap-3">
                      <span
                        className={`rounded px-2 py-1 text-xs font-medium ${getStatusColor(
                          log.status
                        )}`}
                      >
                        {getStatusLabel(log.status)}
                      </span>
                      <Link
                        href={`/plan/group/${log.plan_group_id}`}
                        className="text-sm font-medium text-blue-600 hover:text-blue-800"
                      >
                        {log.plan_groups?.name || "이름 없음"}
                      </Link>
                    </div>
                    <div className="flex items-center gap-2 text-sm text-gray-600">
                      <span>학생: {log.students?.name || "이름 없음"}</span>
                      <span>•</span>
                      <span>
                        플랜: {log.plans_before_count}개 → {log.plans_after_count}개
                      </span>
                      <span>•</span>
                      <span>
                        {new Date(log.created_at).toLocaleString("ko-KR")}
                      </span>
                    </div>
                    {log.reason && (
                      <div className="text-xs text-gray-500">
                        사유: {log.reason}
                      </div>
                    )}
                  </div>
                  <button
                    onClick={() =>
                      setSelectedLogId(selectedLogId === log.id ? null : log.id)
                    }
                    className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
                  >
                    {selectedLogId === log.id ? "접기" : "상세 보기"}
                  </button>
                </div>
                {selectedLogId === log.id && (
                  <div className="flex flex-col gap-4">
                    <RescheduleLogDetail logId={log.id} />
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/reschedule-logs/page.tsx">
/**
 * 관리자용 재조정 로그 조회 페이지
 * 
 * 재조정 이력을 조회하고 관리할 수 있는 페이지입니다.
 */

export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { RescheduleLogsList } from "./_components/RescheduleLogsList";

export default async function RescheduleLogsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const tenantContext = await getTenantContext();
  const supabase = await createSupabaseServerClient();

  const params = await searchParams;
  const planGroupId = params.groupId;
  const studentId = params.studentId;
  const startDate = params.startDate;
  const endDate = params.endDate;

  // 재조정 로그 조회
  let query = supabase
    .from("reschedule_log")
    .select(
      `
      *,
      plan_groups!inner(id, name, student_id),
      students!inner(id, name)
    `
    )
    .eq("tenant_id", tenantContext?.tenantId || "")
    .order("created_at", { ascending: false })
    .limit(100);

  if (planGroupId) {
    query = query.eq("plan_group_id", planGroupId);
  }

  if (studentId) {
    query = query.eq("student_id", studentId);
  }

  if (startDate) {
    query = query.gte("created_at", startDate);
  }

  if (endDate) {
    query = query.lte("created_at", endDate);
  }

  const { data: logs, error } = await query;

  if (error) {
    console.error("[reschedule-logs] 조회 실패:", error);
  }

  return (
    <div className="flex flex-col gap-6 md:gap-8 p-6 md:p-8 lg:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-2xl md:text-3xl font-bold text-gray-900">
          재조정 로그
        </h1>
        <p className="text-sm text-gray-600">
          플랜 그룹 재조정 이력을 조회하고 관리할 수 있습니다.
        </p>
      </div>

      <RescheduleLogsList
        logs={logs || []}
        initialFilters={{
          planGroupId: planGroupId || "",
          studentId: studentId || "",
          startDate: startDate || "",
          endDate: endDate || "",
        }}
      />
    </div>
  );
}
</file>

<file path="admin/schools/_components/RegionFilter.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getRegionsByLevelAction,
  getRegionsByParentAction,
} from "@/app/(admin)/actions/schoolActions";
import type { Region } from "@/lib/data/schools";

type RegionFilterProps = {
  value?: string | null;
  onChange: (regionId: string | null) => void;
  className?: string;
};

export default function RegionFilter({
  value,
  onChange,
  className,
}: RegionFilterProps) {
  const [level1Regions, setLevel1Regions] = useState<Region[]>([]);
  const [level2Regions, setLevel2Regions] = useState<Region[]>([]);
  const [level3Regions, setLevel3Regions] = useState<Region[]>([]);
  const [selectedLevel1, setSelectedLevel1] = useState<string>("");
  const [selectedLevel2, setSelectedLevel2] = useState<string>("");
  const [selectedLevel3, setSelectedLevel3] = useState<string>("");
  const [loading, setLoading] = useState(false);

  // 초기 레벨 1 지역 로드
  useEffect(() => {
    async function loadLevel1() {
      setLoading(true);
      try {
        const regions = await getRegionsByLevelAction(1);
        setLevel1Regions(regions);
      } catch (error) {
        console.error("시/도 조회 실패:", error);
      } finally {
        setLoading(false);
      }
    }
    loadLevel1();
  }, []);

  // 레벨 1 선택 시 레벨 2 로드
  useEffect(() => {
    if (!selectedLevel1) {
      setLevel2Regions([]);
      setLevel3Regions([]);
      setSelectedLevel2("");
      setSelectedLevel3("");
      onChange(null);
      return;
    }

    async function loadLevel2() {
      setLoading(true);
      try {
        const regions = await getRegionsByParentAction(selectedLevel1);
        setLevel2Regions(regions);
        setLevel3Regions([]);
        setSelectedLevel2("");
        setSelectedLevel3("");
        // 레벨 2가 없으면 레벨 1 ID 전달, 있으면 null (레벨 2 선택 대기)
        onChange(regions.length === 0 ? selectedLevel1 : null);
      } catch (error) {
        console.error("시/군/구 조회 실패:", error);
        onChange(null);
      } finally {
        setLoading(false);
      }
    }
    loadLevel2();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedLevel1]);

  // 레벨 2 선택 시 레벨 3 로드
  useEffect(() => {
    if (!selectedLevel2) {
      setLevel3Regions([]);
      setSelectedLevel3("");
      // 레벨 2가 선택 해제되면, 레벨 1이 있고 레벨 2가 없으면 레벨 1 ID 전달
      if (selectedLevel1) {
        onChange(level2Regions.length === 0 ? selectedLevel1 : null);
      } else {
        onChange(null);
      }
      return;
    }

    async function loadLevel3() {
      setLoading(true);
      try {
        const regions = await getRegionsByParentAction(selectedLevel2);
        setLevel3Regions(regions);
        setSelectedLevel3("");
        // 레벨 3가 없으면 레벨 2 ID 전달, 있으면 null (레벨 3 선택 대기)
        onChange(regions.length === 0 ? selectedLevel2 : null);
      } catch (error) {
        console.error("읍/면/동 조회 실패:", error);
        onChange(null);
      } finally {
        setLoading(false);
      }
    }
    loadLevel3();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedLevel2]);

  // 레벨 3 선택 시 최종 ID 전달
  useEffect(() => {
    if (selectedLevel3) {
      onChange(selectedLevel3);
    } else if (selectedLevel2 && level3Regions.length > 0) {
      // 레벨 3가 선택 해제되고 레벨 3 목록이 있으면 레벨 2 ID 전달
      onChange(selectedLevel2);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedLevel3]);

  return (
    <div className={`flex flex-col gap-2 ${className || ""}`}>
      <label className="text-xs font-medium text-gray-700">지역</label>
      <div className="flex gap-2">
        {/* 시/도 */}
        <select
          value={selectedLevel1}
          onChange={(e) => setSelectedLevel1(e.target.value)}
          disabled={loading}
          className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100"
        >
          <option value="">시/도 선택</option>
          {level1Regions.map((region) => (
            <option key={region.id} value={region.id}>
              {region.name}
            </option>
          ))}
        </select>

        {/* 시/군/구 */}
        {selectedLevel1 && (
          <select
            value={selectedLevel2}
            onChange={(e) => setSelectedLevel2(e.target.value)}
            disabled={loading || !selectedLevel1}
            className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100"
          >
            <option value="">시/군/구 선택</option>
            {level2Regions.map((region) => (
              <option key={region.id} value={region.id}>
                {region.name}
              </option>
            ))}
          </select>
        )}

        {/* 읍/면/동 */}
        {selectedLevel2 && level3Regions.length > 0 && (
          <select
            value={selectedLevel3}
            onChange={(e) => setSelectedLevel3(e.target.value)}
            disabled={loading || !selectedLevel2}
            className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 disabled:bg-gray-100"
          >
            <option value="">읍/면/동 선택</option>
            {level3Regions.map((region) => (
              <option key={region.id} value={region.id}>
                {region.name}
              </option>
            ))}
          </select>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/schools/_components/SchoolFilterPanel.tsx">
"use client";

import { useState } from "react";
import RegionFilter from "./RegionFilter";

type SchoolFilterPanelProps = {
  searchQuery: string;
  onSearchChange: (query: string) => void;
  regionId: string | null;
  onRegionChange: (regionId: string | null) => void;
  category?: string | null;
  onCategoryChange?: (category: string | null) => void;
  universityType?: string | null;
  onUniversityTypeChange?: (type: string | null) => void;
  universityOwnership?: string | null;
  onUniversityOwnershipChange?: (ownership: string | null) => void;
  schoolType: "중학교" | "고등학교" | "대학교";
  onReset: () => void;
};

export default function SchoolFilterPanel({
  searchQuery,
  onSearchChange,
  regionId,
  onRegionChange,
  category,
  onCategoryChange,
  universityType,
  onUniversityTypeChange,
  universityOwnership,
  onUniversityOwnershipChange,
  schoolType,
  onReset,
}: SchoolFilterPanelProps) {
  const hasActiveFilters =
    searchQuery ||
    regionId ||
    category ||
    universityType ||
    universityOwnership;

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
      <div className="flex flex-col gap-4">
        {/* 검색 및 필터 행 */}
        <div className="flex flex-wrap items-end gap-4">
          {/* 학교명 검색 */}
          <div className="flex flex-col gap-1">
            <label className="text-xs font-medium text-gray-700">
              학교명 검색
            </label>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => onSearchChange(e.target.value)}
              placeholder="학교명 입력"
              className="w-48 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          {/* 지역 필터 */}
          <RegionFilter value={regionId} onChange={onRegionChange} />

          {/* 고등학교 유형 필터 */}
          {schoolType === "고등학교" && onCategoryChange && (
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                고등학교 유형
              </label>
              <select
                value={category || ""}
                onChange={(e) =>
                  onCategoryChange(e.target.value || null)
                }
                className="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">전체</option>
                <option value="일반고">일반고</option>
                <option value="특목고">특목고</option>
                <option value="자사고">자사고</option>
                <option value="특성화고">특성화고</option>
              </select>
            </div>
          )}

          {/* 대학교 유형 필터 */}
          {schoolType === "대학교" && onUniversityTypeChange && (
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                대학교 유형
              </label>
              <select
                value={universityType || ""}
                onChange={(e) =>
                  onUniversityTypeChange(e.target.value || null)
                }
                className="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">전체</option>
                <option value="4년제">4년제</option>
                <option value="2년제">2년제</option>
              </select>
            </div>
          )}

          {/* 대학교 설립 유형 필터 */}
          {schoolType === "대학교" && onUniversityOwnershipChange && (
            <div className="flex flex-col gap-1">
              <label className="text-xs font-medium text-gray-700">
                설립 유형
              </label>
              <select
                value={universityOwnership || ""}
                onChange={(e) =>
                  onUniversityOwnershipChange(e.target.value || null)
                }
                className="rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">전체</option>
                <option value="국립">국립</option>
                <option value="사립">사립</option>
              </select>
            </div>
          )}

          {/* 초기화 버튼 */}
          {hasActiveFilters && (
            <button
              type="button"
              onClick={onReset}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </button>
          )}
        </div>

        {/* 활성 필터 배지 */}
        {hasActiveFilters && (
          <div className="flex flex-wrap gap-2">
            {searchQuery && (
              <span className="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-800">
                검색: {searchQuery}
                <button
                  type="button"
                  onClick={() => onSearchChange("")}
                  className="ml-1 text-indigo-600 hover:text-indigo-800"
                >
                  ×
                </button>
              </span>
            )}
            {category && (
              <span className="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-800">
                유형: {category}
                <button
                  type="button"
                  onClick={() => onCategoryChange?.(null)}
                  className="ml-1 text-indigo-600 hover:text-indigo-800"
                >
                  ×
                </button>
              </span>
            )}
            {universityType && (
              <span className="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-800">
                유형: {universityType}
                <button
                  type="button"
                  onClick={() => onUniversityTypeChange?.(null)}
                  className="ml-1 text-indigo-600 hover:text-indigo-800"
                >
                  ×
                </button>
              </span>
            )}
            {universityOwnership && (
              <span className="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-800">
                설립: {universityOwnership}
                <button
                  type="button"
                  onClick={() => onUniversityOwnershipChange?.(null)}
                  className="ml-1 text-indigo-600 hover:text-indigo-800"
                >
                  ×
                </button>
              </span>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/schools/_components/SchoolFormModal.tsx">
"use client";

import { useState, useEffect } from "react";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import { createSchool, updateSchool } from "@/app/(admin)/actions/schoolActions";
import { getRegionsAction } from "@/app/(admin)/actions/schoolActions";
import RegionFilter from "./RegionFilter";
import type { School, Region } from "@/lib/data/schools";

type SchoolFormModalProps = {
  school?: School;
  defaultType?: "중학교" | "고등학교" | "대학교";
  onSuccess: () => void;
  onCancel: () => void;
};

export default function SchoolFormModal({
  school,
  defaultType,
  onSuccess,
  onCancel,
}: SchoolFormModalProps) {
  const toast = useToast();
  const [schoolType, setSchoolType] = useState<
    "중학교" | "고등학교" | "대학교"
  >(school?.type || defaultType || "중학교");
  const [name, setName] = useState(school?.name || "");
  const [regionId, setRegionId] = useState<string | null>(
    school?.region_id || null
  );
  const [address, setAddress] = useState(school?.address || "");
  const [postalCode, setPostalCode] = useState(school?.postal_code || "");
  const [addressDetail, setAddressDetail] = useState(
    school?.address_detail || ""
  );
  const [city, setCity] = useState(school?.city || "");
  const [district, setDistrict] = useState(school?.district || "");
  const [phone, setPhone] = useState(school?.phone || "");

  // 고등학교 속성
  const [category, setCategory] = useState<
    "일반고" | "특목고" | "자사고" | "특성화고" | ""
  >((school?.category as "일반고" | "특목고" | "자사고" | "특성화고" | "" | null | undefined) || "");

  // 대학교 속성
  const [universityType, setUniversityType] = useState<"4년제" | "2년제" | "">(
    (school?.university_type as "4년제" | "2년제" | "" | null | undefined) || ""
  );
  const [universityOwnership, setUniversityOwnership] = useState<
    "국립" | "사립" | ""
  >((school?.university_ownership as "국립" | "사립" | "" | null | undefined) || "");
  const [campusName, setCampusName] = useState(school?.campus_name || "");

  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("학교명을 입력해주세요.");
      return;
    }

    if (!schoolType) {
      toast.showError("학교 타입을 선택해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      if (school) {
        formData.append("id", school.id);
      }
      formData.append("name", name.trim());
      formData.append("type", schoolType);
      if (regionId) formData.append("region_id", regionId);
      if (address) formData.append("address", address.trim());
      if (postalCode) formData.append("postal_code", postalCode.trim());
      if (addressDetail) formData.append("address_detail", addressDetail.trim());
      if (city) formData.append("city", city.trim());
      if (district) formData.append("district", district.trim());
      if (phone) formData.append("phone", phone.trim());

      if (schoolType === "고등학교" && category) {
        formData.append("category", category);
      }

      if (schoolType === "대학교") {
        if (universityType) formData.append("university_type", universityType);
        if (universityOwnership)
          formData.append("university_ownership", universityOwnership);
        if (campusName) formData.append("campus_name", campusName.trim());
      }

      const result = school
        ? await updateSchool(formData)
        : await createSchool(formData);

      if (result.success) {
        toast.showSuccess(
          school ? "학교 정보가 수정되었습니다." : "학교가 등록되었습니다."
        );
        onSuccess();
      } else {
        toast.showError(result.error || "저장에 실패했습니다.");
      }
    } catch (error) {
      console.error("학교 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog
      open={true}
      onOpenChange={() => onCancel()}
      title={school ? "학교 수정" : "학교 등록"}
      maxWidth="2xl"
    >
      <DialogContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-6">
          <div className="grid gap-4 md:grid-cols-2">
            {/* 학교명 */}
            <div className="flex flex-col gap-1 md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">
                학교명 <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="예: 서울대학교"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                required
                disabled={isSubmitting}
                autoFocus
              />
            </div>

            {/* 학교 타입 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                학교 타입 <span className="text-red-500">*</span>
              </label>
              <select
                value={schoolType}
                onChange={(e) =>
                  setSchoolType(
                    e.target.value as "중학교" | "고등학교" | "대학교"
                  )
                }
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                required
                disabled={isSubmitting || !!school}
              >
                <option value="중학교">중학교</option>
                <option value="고등학교">고등학교</option>
                <option value="대학교">대학교</option>
              </select>
            </div>

            {/* 지역 */}
            <div className="md:col-span-2">
              <RegionFilter value={regionId} onChange={setRegionId} />
            </div>

            {/* 중복 확인 안내 */}
            <div className="md:col-span-2 rounded-lg border border-blue-200 bg-blue-50 p-4">
              <div className="flex flex-col gap-2">
                <h4 className="text-sm font-semibold text-blue-900">
                  중복 확인 안내
                </h4>
                <ul className="list-inside list-disc space-y-1 text-xs text-blue-800">
                  <li>같은 학교명, 타입, 지역의 학교는 등록할 수 없습니다.</li>
                  <li>
                    대학교의 경우, 캠퍼스명이 다르면 같은 이름의 학교도 등록
                    가능합니다.
                  </li>
                  <li>
                    지역이 선택되지 않은 경우, 전역적으로 중복을 확인합니다.
                  </li>
                </ul>
              </div>
            </div>

            {/* 기본주소 */}
            <div className="flex flex-col gap-1 md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">
                기본주소
              </label>
              <input
                type="text"
                value={address}
                onChange={(e) => setAddress(e.target.value)}
                placeholder="예: 서울특별시 관악구 관악로 1"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                disabled={isSubmitting}
              />
            </div>

            {/* 우편번호 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                우편번호
              </label>
              <input
                type="text"
                value={postalCode}
                onChange={(e) => setPostalCode(e.target.value)}
                placeholder="예: 08826"
                maxLength={6}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                disabled={isSubmitting}
              />
            </div>

            {/* 시/군/구 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                시/군/구
              </label>
              <input
                type="text"
                value={city}
                onChange={(e) => setCity(e.target.value)}
                placeholder="예: 관악구"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                disabled={isSubmitting}
              />
            </div>

            {/* 상세주소 */}
            <div className="flex flex-col gap-1 md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">
                상세주소
              </label>
              <input
                type="text"
                value={addressDetail}
                onChange={(e) => setAddressDetail(e.target.value)}
                placeholder="예: 서울대학교 1동 101호"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                disabled={isSubmitting}
              />
            </div>

            {/* 읍/면/동 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                읍/면/동
              </label>
              <input
                type="text"
                value={district}
                onChange={(e) => setDistrict(e.target.value)}
                placeholder="예: 관악동"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                disabled={isSubmitting}
              />
            </div>

            {/* 전화번호 */}
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                전화번호
              </label>
              <input
                type="text"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
                placeholder="예: 02-880-5114"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                disabled={isSubmitting}
              />
            </div>

            {/* 고등학교 유형 */}
            {schoolType === "고등학교" && (
              <div className="flex flex-col gap-1">
                <label className="block text-sm font-medium text-gray-700">
                  고등학교 유형
                </label>
                <select
                  value={category}
                  onChange={(e) =>
                    setCategory(
                      e.target.value as
                        | "일반고"
                        | "특목고"
                        | "자사고"
                        | "특성화고"
                        | ""
                    )
                  }
                  className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                  disabled={isSubmitting}
                >
                  <option value="">선택하세요</option>
                  <option value="일반고">일반고</option>
                  <option value="특목고">특목고</option>
                  <option value="자사고">자사고</option>
                  <option value="특성화고">특성화고</option>
                </select>
              </div>
            )}

            {/* 대학교 유형 */}
            {schoolType === "대학교" && (
              <>
                <div className="flex flex-col gap-1">
                  <label className="block text-sm font-medium text-gray-700">
                    대학교 유형
                  </label>
                  <select
                    value={universityType}
                    onChange={(e) =>
                      setUniversityType(e.target.value as "4년제" | "2년제" | "")
                    }
                    className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    disabled={isSubmitting}
                  >
                    <option value="">선택하세요</option>
                    <option value="4년제">4년제</option>
                    <option value="2년제">2년제</option>
                  </select>
                </div>
                <div className="flex flex-col gap-1">
                  <label className="block text-sm font-medium text-gray-700">
                    설립 유형
                  </label>
                  <select
                    value={universityOwnership}
                    onChange={(e) =>
                      setUniversityOwnership(
                        e.target.value as "국립" | "사립" | ""
                      )
                    }
                    className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    disabled={isSubmitting}
                  >
                    <option value="">선택하세요</option>
                    <option value="국립">국립</option>
                    <option value="사립">사립</option>
                  </select>
                </div>
                <div className="flex flex-col gap-1 md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700">
                    캠퍼스명
                  </label>
                  <input
                    type="text"
                    value={campusName}
                    onChange={(e) => setCampusName(e.target.value)}
                    placeholder="예: 서울캠퍼스"
                    className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    disabled={isSubmitting}
                  />
                </div>
              </>
            )}
          </div>

          <DialogFooter>
            <button
              type="button"
              onClick={onCancel}
              disabled={isSubmitting}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
            >
              취소
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
            >
              {isSubmitting ? "저장 중..." : "저장하기"}
            </button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="admin/schools/_components/SchoolStats.tsx">
"use client";

import type { School } from "@/lib/data/schools";

type SchoolStatsProps = {
  schools: School[];
};

export default function SchoolStats({ schools }: SchoolStatsProps) {
  const stats = {
    total: schools.length,
    byType: {
      중학교: schools.filter((s) => s.type === "중학교").length,
      고등학교: schools.filter((s) => s.type === "고등학교").length,
      대학교: schools.filter((s) => s.type === "대학교").length,
    },
  };

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <h2 className="mb-4 text-lg font-semibold text-gray-900">통계</h2>
      <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
        <div className="flex flex-col gap-1">
          <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
          <div className="text-sm text-gray-600">전체 학교</div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-2xl font-bold text-indigo-600">
            {stats.byType.중학교}
          </div>
          <div className="text-sm text-gray-600">중학교</div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-2xl font-bold text-indigo-600">
            {stats.byType.고등학교}
          </div>
          <div className="text-sm text-gray-600">고등학교</div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-2xl font-bold text-indigo-600">
            {stats.byType.대학교}
          </div>
          <div className="text-sm text-gray-600">대학교</div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/schools/_components/SchoolTable.tsx">
"use client";

import { useState } from "react";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import { deleteSchool } from "@/app/(admin)/actions/schoolActions";
import type { School } from "@/lib/data/schools";

type SchoolTableProps = {
  schools: School[];
  onEdit: (school: School) => void;
  onRefresh: () => void;
};

export default function SchoolTable({
  schools,
  onEdit,
  onRefresh,
}: SchoolTableProps) {
  const toast = useToast();
  const [deletingId, setDeletingId] = useState<string | null>(null);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [schoolToDelete, setSchoolToDelete] = useState<School | null>(null);

  function handleDeleteClick(school: School) {
    setSchoolToDelete(school);
    setShowDeleteDialog(true);
  }

  function handleDeleteConfirm() {
    if (!schoolToDelete) return;

    setShowDeleteDialog(false);
    setDeletingId(schoolToDelete.id);

    deleteSchool(schoolToDelete.id)
      .then((result) => {
        if (result.success) {
          toast.showSuccess("학교가 삭제되었습니다.");
          onRefresh();
        } else {
          toast.showError(result.error || "학교 삭제에 실패했습니다.");
        }
      })
      .catch((error) => {
        console.error("학교 삭제 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "학교 삭제에 실패했습니다."
        );
      })
      .finally(() => {
        setDeletingId(null);
        setSchoolToDelete(null);
      });
  }

  // 타입별 속성 표시 텍스트 생성
  function getTypeAttribute(school: School): string {
    if (school.type === "고등학교" && school.category) {
      return school.category;
    } else if (school.type === "대학교") {
      const parts: string[] = [];
      if (school.university_type) parts.push(school.university_type);
      if (school.university_ownership) parts.push(school.university_ownership);
      return parts.length > 0 ? parts.join("/") : "—";
    }
    return "—";
  }

  if (schools.length === 0) {
    return (
      <div className="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
        <div className="mx-auto flex max-w-md flex-col gap-6">
          <div className="text-6xl">🏫</div>
          <div className="flex flex-col gap-2">
            <h3 className="text-lg font-semibold text-gray-900">
              검색 결과가 없습니다
            </h3>
            <p className="text-sm text-gray-500">
              다른 검색 조건으로 시도해보세요.
            </p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <>
      <div className="overflow-x-auto">
        <table className="w-full border-collapse rounded-lg border border-gray-200 bg-white">
          <thead className="bg-gray-50">
            <tr>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                순서
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                학교명
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                타입
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                유형
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                지역
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                주소
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                전화번호
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                등록일
              </th>
              <th className="border-b border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-900">
                작업
              </th>
            </tr>
          </thead>
          <tbody>
            {schools.map((school, index) => (
              <tr key={school.id} className="hover:bg-gray-50">
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {index + 1}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm font-medium text-gray-900">
                  {school.name}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {school.type}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {getTypeAttribute(school)}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {school.region || "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {school.address || "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {school.phone || "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm text-gray-600">
                  {school.created_at
                    ? new Date(school.created_at).toLocaleDateString("ko-KR")
                    : "—"}
                </td>
                <td className="border-b border-gray-100 px-4 py-3 text-sm">
                  <div className="flex gap-2">
                    <button
                      type="button"
                      onClick={() => onEdit(school)}
                      className="text-indigo-600 hover:text-indigo-800"
                    >
                      수정
                    </button>
                    <button
                      type="button"
                      onClick={() => handleDeleteClick(school)}
                      disabled={deletingId === school.id}
                      className="text-red-600 hover:text-red-800 disabled:opacity-50"
                    >
                      삭제
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 삭제 확인 다이얼로그 */}
      {showDeleteDialog && schoolToDelete && (
        <Dialog
          open={showDeleteDialog}
          onOpenChange={setShowDeleteDialog}
          title="학교 삭제 확인"
          description={`정말로 "${schoolToDelete.name}" 학교를 삭제하시겠습니까?`}
          variant="destructive"
          maxWidth="md"
        >
          <div className="py-4">
            <p className="text-sm text-gray-600">
              이 작업은 되돌릴 수 없으며, 학교의 모든 정보가 삭제됩니다.
            </p>
          </div>
          <DialogFooter>
            <button
              type="button"
              onClick={() => setShowDeleteDialog(false)}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              취소
            </button>
            <button
              type="button"
              onClick={handleDeleteConfirm}
              disabled={deletingId === schoolToDelete.id}
              className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:bg-red-400"
            >
              {deletingId === schoolToDelete.id ? "삭제 중..." : "삭제하기"}
            </button>
          </DialogFooter>
        </Dialog>
      )}
    </>
  );
}
</file>

<file path="admin/schools/_components/SchoolTypeTabs.tsx">
"use client";

import { Plus } from "lucide-react";

type SchoolTypeTabsProps = {
  selectedType: "중학교" | "고등학교" | "대학교";
  onTypeChange: (type: "중학교" | "고등학교" | "대학교") => void;
  onCreateClick: () => void;
};

export default function SchoolTypeTabs({
  selectedType,
  onTypeChange,
  onCreateClick,
}: SchoolTypeTabsProps) {
  const types: Array<"중학교" | "고등학교" | "대학교"> = [
    "중학교",
    "고등학교",
    "대학교",
  ];

  return (
    <div className="border-b border-gray-200">
      <nav className="-mb-px flex space-x-8 overflow-x-auto">
        {types.map((type) => (
          <button
            key={type}
            onClick={() => onTypeChange(type)}
            className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition ${
              selectedType === type
                ? "border-indigo-500 text-indigo-600"
                : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
            }`}
          >
            {type}
          </button>
        ))}
        <button
          onClick={onCreateClick}
          className="ml-auto flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 transition hover:border-gray-300 hover:text-gray-700"
        >
          <Plus className="h-4 w-4" />
          학교 등록
        </button>
      </nav>
    </div>
  );
}
</file>

<file path="admin/schools/[id]/edit/page.tsx">
import { redirect } from "next/navigation";
import { SchoolEditForm } from "./SchoolEditForm";
import { getSchoolById, getRegions } from "@/lib/data/schools";

export default async function EditSchoolPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const school = await getSchoolById(id);

  if (!school) {
    redirect("/admin/schools");
  }

  const regions = await getRegions();

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-6">
        <div>
          <h1 className="text-3xl font-semibold text-gray-900">학교 수정</h1>
          <p className="text-sm text-gray-500">학교 정보를 수정하세요.</p>
        </div>

        <SchoolEditForm
          school={school}
          regions={regions.map((r) => ({ id: r.id, name: r.name }))}
        />
      </div>
    </section>
  );
}
</file>

<file path="admin/schools/[id]/edit/SchoolEditForm.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { updateSchool, deleteSchool } from "@/app/(admin)/actions/schoolActions";
import { useToast } from "@/components/ui/ToastProvider";
import { Dialog, DialogFooter } from "@/components/ui/Dialog";

type School = {
  id: string;
  name: string;
  type: "중학교" | "고등학교" | "대학교";
  school_code?: string | null;
  region_id?: string | null;
  region: string | null;
  address?: string | null;
  postal_code?: string | null;
  address_detail?: string | null;
  city?: string | null;
  district?: string | null;
  phone?: string | null;
  category?: string | null;
  university_type?: string | null;
  university_ownership?: string | null;
  campus_name?: string | null;
};

type SchoolEditFormProps = {
  school: School;
  regions: Array<{ id: string; name: string }>;
};

export function SchoolEditForm({ school, regions }: SchoolEditFormProps) {
  const [isPending, startTransition] = useTransition();
  const [schoolType, setSchoolType] = useState<"중학교" | "고등학교" | "대학교">(school.type);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const router = useRouter();
  const toast = useToast();

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);
    formData.append("id", school.id);

    startTransition(async () => {
      try {
        const result = await updateSchool(formData);
        if (result.success) {
          toast.showSuccess("학교 정보가 수정되었습니다.");
          router.push("/admin/schools");
        } else {
          toast.showError(result.error || "학교 수정에 실패했습니다.");
        }
      } catch (error) {
        console.error("학교 수정 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "학교 수정에 실패했습니다."
        );
      }
    });
  }

  function handleDeleteClick() {
    setShowDeleteDialog(true);
  }

  function handleDeleteConfirm() {
    setShowDeleteDialog(false);
    startTransition(async () => {
      try {
        const result = await deleteSchool(school.id);
        if (result.success) {
          toast.showSuccess("학교가 삭제되었습니다.");
          router.push("/admin/schools");
        } else {
          toast.showError(result.error || "학교 삭제에 실패했습니다.");
        }
      } catch (error) {
        console.error("학교 삭제 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "학교 삭제에 실패했습니다."
        );
      }
    });
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm"
    >
      <div className="grid gap-4 md:grid-cols-2">
        {/* 학교명 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            학교명 <span className="text-red-500">*</span>
          </label>
          <input
            name="name"
            required
            defaultValue={school.name}
            placeholder="예: 서울대학교"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 학교 타입 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            학교 타입 <span className="text-red-500">*</span>
          </label>
          <select
            name="type"
            required
            value={schoolType}
            onChange={(e) => setSchoolType(e.target.value as "중학교" | "고등학교" | "대학교")}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="중학교">중학교</option>
            <option value="고등학교">고등학교</option>
            <option value="대학교">대학교</option>
          </select>
        </div>

        {/* 지역 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            지역
          </label>
          <select
            name="region_id"
            defaultValue={school.region_id || ""}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {regions.map((region) => (
              <option key={region.id} value={region.id}>
                {region.name}
              </option>
            ))}
          </select>
        </div>

        {/* 중복 확인 안내 */}
        <div className="md:col-span-2 rounded-lg border border-blue-200 bg-blue-50 p-4">
          <div className="flex flex-col gap-2">
            <h4 className="text-sm font-semibold text-blue-900">
              중복 확인 안내
            </h4>
            <ul className="list-inside list-disc space-y-1 text-xs text-blue-800">
              <li>같은 학교명, 타입, 지역의 학교는 등록할 수 없습니다.</li>
              <li>
                대학교의 경우, 캠퍼스명이 다르면 같은 이름의 학교도 등록
                가능합니다.
              </li>
              <li>
                지역이 선택되지 않은 경우, 전역적으로 중복을 확인합니다.
              </li>
            </ul>
          </div>
        </div>

        {/* 기본주소 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            기본주소
          </label>
          <input
            name="address"
            defaultValue={school.address || ""}
            placeholder="예: 서울특별시 관악구 관악로 1"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 우편번호 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            우편번호
          </label>
          <input
            name="postal_code"
            defaultValue={school.postal_code || ""}
            placeholder="예: 08826"
            maxLength={6}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 시/군/구 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            시/군/구
          </label>
          <input
            name="city"
            defaultValue={school.city || ""}
            placeholder="예: 관악구"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 상세주소 */}
        <div className="flex flex-col gap-1 md:col-span-2">
          <label className="block text-sm font-medium text-gray-700">
            상세주소
          </label>
          <input
            name="address_detail"
            defaultValue={school.address_detail || ""}
            placeholder="예: 서울대학교 1동 101호"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 읍/면/동 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            읍/면/동
          </label>
          <input
            name="district"
            defaultValue={school.district || ""}
            placeholder="예: 관악동"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 전화번호 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            전화번호
          </label>
          <input
            name="phone"
            defaultValue={school.phone || ""}
            placeholder="예: 02-880-5114"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 고등학교 유형 */}
        {schoolType === "고등학교" && (
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              고등학교 유형
            </label>
            <select
              name="category"
              defaultValue={school.category || ""}
              className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="">선택하세요</option>
              <option value="일반고">일반고</option>
              <option value="특목고">특목고</option>
              <option value="자사고">자사고</option>
              <option value="특성화고">특성화고</option>
            </select>
          </div>
        )}

        {/* 대학교 유형 */}
        {schoolType === "대학교" && (
          <>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                대학교 유형
              </label>
              <select
                name="university_type"
                defaultValue={school.university_type || ""}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">선택하세요</option>
                <option value="4년제">4년제</option>
                <option value="2년제">2년제</option>
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="block text-sm font-medium text-gray-700">
                설립 유형
              </label>
              <select
                name="university_ownership"
                defaultValue={school.university_ownership || ""}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">선택하세요</option>
                <option value="국립">국립</option>
                <option value="사립">사립</option>
              </select>
            </div>
            <div className="flex flex-col gap-1 md:col-span-2">
              <label className="block text-sm font-medium text-gray-700">
                캠퍼스명
              </label>
              <input
                name="campus_name"
                defaultValue={school.campus_name || ""}
                placeholder="예: 서울캠퍼스"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>
          </>
        )}
      </div>

      {/* 버튼 */}
      <div className="flex justify-between">
        <button
          type="button"
          onClick={handleDeleteClick}
          disabled={isPending}
          className="rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-semibold text-red-600 transition hover:bg-red-50 disabled:bg-gray-100"
        >
          삭제
        </button>
        <div className="flex gap-3">
          <Link
            href="/admin/schools"
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
          >
            취소
          </Link>
          <button
            type="submit"
            disabled={isPending}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:bg-indigo-400"
          >
            {isPending ? "저장 중..." : "저장하기"}
          </button>
        </div>
      </div>

      {/* 삭제 확인 다이얼로그 */}
      <Dialog
        open={showDeleteDialog}
        onOpenChange={setShowDeleteDialog}
        title="학교 삭제 확인"
        description={`정말로 "${school.name}" 학교를 삭제하시겠습니까?`}
        variant="destructive"
        maxWidth="md"
      >
        <div className="py-4">
          <p className="text-sm text-gray-600">
            이 작업은 되돌릴 수 없으며, 학교의 모든 정보가 삭제됩니다.
          </p>
        </div>
        <DialogFooter>
          <button
            type="button"
            onClick={() => setShowDeleteDialog(false)}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
          >
            취소
          </button>
          <button
            type="button"
            onClick={handleDeleteConfirm}
            disabled={isPending}
            className="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:bg-red-400"
          >
            {isPending ? "삭제 중..." : "삭제하기"}
          </button>
        </DialogFooter>
      </Dialog>
    </form>
  );
}
</file>

<file path="admin/schools/new/page.tsx">
import { SchoolForm } from "./SchoolForm";
import { getRegions } from "@/lib/data/schools";

export default async function NewSchoolPage() {
  const regions = await getRegions();

  return (
    <section className="mx-auto w-full max-w-2xl px-4 py-10">
      <div className="flex flex-col gap-6">
        <div>
          <h1 className="text-3xl font-semibold text-gray-900">학교 등록</h1>
          <p className="text-sm text-gray-500">
            새로운 학교 정보를 등록하세요.
          </p>
        </div>

        <SchoolForm regions={regions.map((r) => ({ id: r.id, name: r.name }))} />
      </div>
    </section>
  );
}
</file>

<file path="admin/schools/new/SchoolForm.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { createSchool } from "@/app/(admin)/actions/schoolActions";
import { getRegions } from "@/lib/data/schools";
import { useToast } from "@/components/ui/ToastProvider";

type SchoolFormProps = {
  regions: Array<{ id: string; name: string }>;
};

export function SchoolForm({ regions }: SchoolFormProps) {
  const [isPending, startTransition] = useTransition();
  const [schoolType, setSchoolType] = useState<"중학교" | "고등학교" | "대학교" | "">("");
  const router = useRouter();
  const toast = useToast();

  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    startTransition(async () => {
      try {
        const result = await createSchool(formData);
        if (result.success) {
          toast.showSuccess("학교가 등록되었습니다.");
          router.push("/admin/schools");
        } else {
          toast.showError(result.error || "학교 등록에 실패했습니다.");
        }
      } catch (error) {
        console.error("학교 등록 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "학교 등록에 실패했습니다."
        );
      }
    });
  }

  return (
    <form
      onSubmit={handleSubmit}
      className="flex flex-col gap-6 rounded-lg border bg-white p-6 shadow-sm"
    >
      <div className="grid gap-4 md:grid-cols-2">
        {/* 학교명 */}
        <div className="md:col-span-2">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            학교명 <span className="text-red-500">*</span>
          </label>
          <input
            name="name"
            required
            placeholder="예: 서울대학교"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 학교 타입 */}
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            학교 타입 <span className="text-red-500">*</span>
          </label>
          <select
            name="type"
            required
            value={schoolType}
            onChange={(e) => setSchoolType(e.target.value as "중학교" | "고등학교" | "대학교" | "")}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            <option value="중학교">중학교</option>
            <option value="고등학교">고등학교</option>
            <option value="대학교">대학교</option>
          </select>
        </div>

        {/* 지역 */}
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            지역
          </label>
          <select
            name="region_id"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="">선택하세요</option>
            {regions.map((region) => (
              <option key={region.id} value={region.id}>
                {region.name}
              </option>
            ))}
          </select>
        </div>

        {/* 중복 확인 안내 */}
        <div className="md:col-span-2 rounded-lg border border-blue-200 bg-blue-50 p-4">
          <div className="flex flex-col gap-2">
            <h4 className="text-sm font-semibold text-blue-900">
              중복 확인 안내
            </h4>
            <ul className="list-inside list-disc space-y-1 text-xs text-blue-800">
              <li>같은 학교명, 타입, 지역의 학교는 등록할 수 없습니다.</li>
              <li>
                대학교의 경우, 캠퍼스명이 다르면 같은 이름의 학교도 등록
                가능합니다.
              </li>
              <li>
                지역이 선택되지 않은 경우, 전역적으로 중복을 확인합니다.
              </li>
            </ul>
          </div>
        </div>

        {/* 기본주소 */}
        <div className="md:col-span-2">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            기본주소
          </label>
          <input
            name="address"
            placeholder="예: 서울특별시 관악구 관악로 1"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 우편번호 */}
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            우편번호
          </label>
          <input
            name="postal_code"
            placeholder="예: 08826"
            maxLength={6}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 시/군/구 */}
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            시/군/구
          </label>
          <input
            name="city"
            placeholder="예: 관악구"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 상세주소 */}
        <div className="md:col-span-2">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            상세주소
          </label>
          <input
            name="address_detail"
            placeholder="예: 서울대학교 1동 101호"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 읍/면/동 */}
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            읍/면/동
          </label>
          <input
            name="district"
            placeholder="예: 관악동"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 전화번호 */}
        <div>
          <label className="mb-1 block text-sm font-medium text-gray-700">
            전화번호
          </label>
          <input
            name="phone"
            placeholder="예: 02-880-5114"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        {/* 고등학교 유형 */}
        {schoolType === "고등학교" && (
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">
              고등학교 유형
            </label>
            <select
              name="category"
              className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="">선택하세요</option>
              <option value="일반고">일반고</option>
              <option value="특목고">특목고</option>
              <option value="자사고">자사고</option>
              <option value="특성화고">특성화고</option>
            </select>
          </div>
        )}

        {/* 대학교 유형 */}
        {schoolType === "대학교" && (
          <>
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                대학교 유형
              </label>
              <select
                name="university_type"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">선택하세요</option>
                <option value="4년제">4년제</option>
                <option value="2년제">2년제</option>
              </select>
            </div>
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                설립 유형
              </label>
              <select
                name="university_ownership"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="">선택하세요</option>
                <option value="국립">국립</option>
                <option value="사립">사립</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="mb-1 block text-sm font-medium text-gray-700">
                캠퍼스명
              </label>
              <input
                name="campus_name"
                placeholder="예: 서울캠퍼스"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              />
            </div>
          </>
        )}
      </div>

      {/* 버튼 */}
      <div className="flex justify-end gap-3">
        <Link
          href="/admin/schools"
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          취소
        </Link>
        <button
          type="submit"
          disabled={isPending}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:bg-indigo-400"
        >
          {isPending ? "등록 중..." : "등록하기"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="admin/schools/page.tsx">
"use client";

/**
 * 학교 관리 페이지 (읽기 전용)
 *
 * 새 테이블 구조:
 * - school_info: 중·고등학교 (나이스 데이터)
 * - universities: 대학교
 * - university_campuses: 대학교 캠퍼스
 *
 * 주의: 학교 데이터는 외부 데이터 기반으로 읽기 전용입니다.
 */

import { useState, useEffect, useMemo } from "react";
import {
  getAllSchoolsAction,
  getSchoolInfoListAction,
  getUniversityCampusesAction,
  searchSchoolsAction,
} from "@/app/(admin)/actions/schoolActions";
import Button from "@/components/atoms/Button";
import { useToast } from "@/components/ui/ToastProvider";
import type { AllSchoolsView, SchoolInfo, UniversityWithCampus } from "@/lib/data/schools";
import type { SchoolType } from "@/lib/domains/school/types";

type TabType = "ALL" | "MIDDLE" | "HIGH" | "UNIVERSITY";

const TAB_LABELS: Record<TabType, string> = {
  ALL: "전체",
  MIDDLE: "중학교",
  HIGH: "고등학교",
  UNIVERSITY: "대학교",
};

export default function SchoolsPage() {
  const toast = useToast();
  const [schools, setSchools] = useState<AllSchoolsView[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedTab, setSelectedTab] = useState<TabType>("ALL");
  const [searchQuery, setSearchQuery] = useState("");
  const [regionFilter, setRegionFilter] = useState("");

  // 통계
  const stats = useMemo(() => {
    const middleCount = schools.filter((s) => s.school_type === "MIDDLE").length;
    const highCount = schools.filter((s) => s.school_type === "HIGH").length;
    const universityCount = schools.filter((s) => s.school_type === "UNIVERSITY").length;
    return { middleCount, highCount, universityCount, total: schools.length };
  }, [schools]);

  // 학교 목록 로드
  async function loadSchools() {
    setLoading(true);
    try {
      const schoolType: SchoolType | undefined =
        selectedTab === "ALL" ? undefined : selectedTab;
      
      const data = await getAllSchoolsAction({
        schoolType,
        region: regionFilter || undefined,
        limit: 500,
      });
      setSchools(data);
    } catch (error) {
      console.error("학교 목록 조회 실패:", error);
      toast.showError("학교 목록을 불러오는데 실패했습니다.");
      setSchools([]);
    } finally {
      setLoading(false);
    }
  }

  // 탭 변경 시 다시 로드
  useEffect(() => {
    loadSchools();
  }, [selectedTab, regionFilter]);

  // 검색 필터링 (클라이언트 사이드)
  const filteredSchools = useMemo(() => {
    if (!searchQuery.trim()) return schools;
    
    const query = searchQuery.toLowerCase();
    return schools.filter(
      (school) =>
        school.name.toLowerCase().includes(query) ||
        school.region?.toLowerCase().includes(query)
    );
  }, [schools, searchQuery]);

  // 고유 지역 목록 추출
  const uniqueRegions = useMemo(() => {
    const regions = new Set<string>();
    schools.forEach((school) => {
      if (school.region) {
        // 시/도 단위만 추출 (첫 번째 단어)
        const province = school.region.split(" ")[0];
        regions.add(province);
      }
    });
    return Array.from(regions).sort();
  }, [schools]);

  return (
    <section className="mx-auto w-full max-w-7xl px-4 py-8">
      {/* 헤더 */}
      <div className="mb-6">
        <div className="flex items-start justify-between">
          <div>
            <p className="text-sm font-medium text-gray-500">서비스 마스터</p>
            <h1 className="text-3xl font-semibold text-gray-900">학교 관리</h1>
            <p className="mt-2 text-sm text-gray-500">
              중학교, 고등학교, 대학교 정보를 조회합니다.
              <span className="ml-2 inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                읽기 전용
              </span>
            </p>
          </div>
        </div>
      </div>

      {/* 탭 네비게이션 */}
      <div className="mb-6 border-b border-gray-200">
        <nav className="-mb-px flex gap-4">
          {(Object.keys(TAB_LABELS) as TabType[]).map((tab) => (
            <button
              key={tab}
              onClick={() => setSelectedTab(tab)}
              className={`whitespace-nowrap border-b-2 px-1 pb-3 text-sm font-medium transition-colors ${
                selectedTab === tab
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              {TAB_LABELS[tab]}
              {tab !== "ALL" && (
                <span className="ml-2 rounded-full bg-gray-100 px-2 py-0.5 text-xs">
                  {tab === "MIDDLE"
                    ? stats.middleCount
                    : tab === "HIGH"
                    ? stats.highCount
                    : stats.universityCount}
                </span>
              )}
            </button>
          ))}
        </nav>
      </div>

      {/* 통계 */}
      <div className="mb-6 grid grid-cols-4 gap-4">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">전체 학교</p>
          <p className="text-2xl font-semibold text-gray-900">{stats.total.toLocaleString()}</p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">중학교</p>
          <p className="text-2xl font-semibold text-blue-600">{stats.middleCount.toLocaleString()}</p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">고등학교</p>
          <p className="text-2xl font-semibold text-green-600">{stats.highCount.toLocaleString()}</p>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <p className="text-sm text-gray-500">대학교</p>
          <p className="text-2xl font-semibold text-purple-600">{stats.universityCount.toLocaleString()}</p>
        </div>
      </div>

      {/* 검색 및 필터 */}
      <div className="mb-6 flex gap-4">
        <div className="flex-1">
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="학교명 또는 지역으로 검색..."
            className="w-full rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          />
        </div>
        <select
          value={regionFilter}
          onChange={(e) => setRegionFilter(e.target.value)}
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
        >
          <option value="">전체 지역</option>
          {uniqueRegions.map((region) => (
            <option key={region} value={region}>
              {region}
            </option>
          ))}
        </select>
        <Button
          variant="outline"
          size="sm"
          onClick={() => {
            setSearchQuery("");
            setRegionFilter("");
          }}
        >
          초기화
        </Button>
      </div>

      {/* 결과 개수 */}
      <div className="mb-4 text-sm text-gray-600">
        총 <span className="font-semibold">{filteredSchools.length.toLocaleString()}</span>개의
        학교가 검색되었습니다.
      </div>

      {/* 학교 목록 테이블 */}
      <div className="mb-6 overflow-hidden rounded-lg border border-gray-200 bg-white">
        {loading ? (
          <div className="p-12 text-center">
            <div className="text-sm text-gray-500">로딩 중...</div>
          </div>
        ) : filteredSchools.length === 0 ? (
          <div className="p-12 text-center">
            <div className="text-sm text-gray-500">검색 결과가 없습니다.</div>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    학교명
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    구분
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    지역
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    설립유형
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    연락처
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200 bg-white">
                {filteredSchools.slice(0, 100).map((school) => (
                  <tr key={school.id} className="hover:bg-gray-50">
                    <td className="whitespace-nowrap px-4 py-3">
                      <div className="flex flex-col">
                        <span className="font-medium text-gray-900">{school.name}</span>
                        {school.campus_name && school.campus_name !== school.name && (
                          <span className="text-xs text-gray-500">{school.campus_name}</span>
                        )}
                      </div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2 py-1 text-xs font-semibold ${
                          school.school_type === "MIDDLE"
                            ? "bg-blue-100 text-blue-800"
                            : school.school_type === "HIGH"
                            ? "bg-green-100 text-green-800"
                            : "bg-purple-100 text-purple-800"
                        }`}
                      >
                        {school.school_type === "MIDDLE"
                          ? "중학교"
                          : school.school_type === "HIGH"
                          ? "고등학교"
                          : "대학교"}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {school.region || "-"}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {school.establishment_type || "-"}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {school.phone || "-"}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {filteredSchools.length > 100 && (
              <div className="border-t border-gray-200 bg-gray-50 px-4 py-3 text-center text-sm text-gray-500">
                상위 100개만 표시됩니다. 검색어를 입력하여 결과를 좁혀주세요.
              </div>
            )}
          </div>
        )}
      </div>

      {/* 안내 메시지 */}
      <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
        <div className="flex">
          <div className="flex-shrink-0">
            <svg className="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
              <path
                fillRule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clipRule="evenodd"
              />
            </svg>
          </div>
          <div className="ml-3">
            <h3 className="text-sm font-medium text-blue-800">안내</h3>
            <div className="mt-2 text-sm text-blue-700">
              <p>
                학교 데이터는 나이스(NEIS) 및 교육부 공식 데이터를 기반으로 관리됩니다.
                학교 정보 추가/수정이 필요한 경우 시스템 관리자에게 문의해주세요.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="admin/settings/scheduler/_components/SchedulerSettingsForm.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getTenantSchedulerSettingsAction,
  saveTenantSchedulerSettingsAction,
} from "@/app/(admin)/actions/schedulerSettings";
import type { TenantSchedulerSettings } from "@/lib/types/schedulerSettings";
import { Spinner } from "@/components/atoms/Spinner";

export function SchedulerSettingsForm() {
  const { showSuccess, showError } = useToast();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  const [settings, setSettings] = useState<
    Partial<TenantSchedulerSettings>
  >({
    default_study_days: 6,
    default_review_days: 1,
    default_weak_subject_focus: "medium",
    default_review_scope: "full",
    default_lunch_time: { start: "12:00", end: "13:00" },
    default_study_hours: { start: "09:00", end: "18:00" },
  });

  useEffect(() => {
    const loadSettings = async () => {
      try {
        const data = await getTenantSchedulerSettingsAction();
        if (data) {
          setSettings(data);
        }
      } catch (error) {
        console.error("Failed to load scheduler settings:", error);
        showError("설정을 불러오는데 실패했습니다.");
      } finally {
        setLoading(false);
      }
    };

    loadSettings();
  }, [showError]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);

    try {
      const result = await saveTenantSchedulerSettingsAction({
        default_study_days: settings.default_study_days,
        default_review_days: settings.default_review_days,
        default_weak_subject_focus: settings.default_weak_subject_focus,
        default_review_scope: settings.default_review_scope,
        default_lunch_time: settings.default_lunch_time,
        default_study_hours: settings.default_study_hours,
        default_self_study_hours: settings.default_self_study_hours,
      });

      if (result.success) {
        showSuccess("설정이 저장되었습니다.");
      } else {
        showError(result.error || "설정 저장에 실패했습니다.");
      }
    } catch (error) {
      console.error("Failed to save scheduler settings:", error);
      showError("설정 저장 중 오류가 발생했습니다.");
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Spinner />
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-6">
      {/* 학습일/복습일 비율 */}
      <div className="flex flex-col gap-4 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
        <h2 className="text-h2 text-gray-900 dark:text-gray-100">학습일/복습일 비율</h2>
        <div className="flex flex-col gap-4">
          <div className="flex flex-col gap-1">
            <label className="block text-body-2-bold text-gray-800 dark:text-gray-200">
              주당 학습일 수
            </label>
            <input
              type="number"
              min="1"
              max="7"
              value={settings.default_study_days}
              onChange={(e) =>
                setSettings({
                  ...settings,
                  default_study_days: parseInt(e.target.value, 10),
                })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
            />
            <p className="text-sm text-gray-600 dark:text-gray-400">
              1-7일 사이의 값을 입력하세요.
            </p>
          </div>

          <div className="flex flex-col gap-1">
            <label className="block text-body-2-bold text-gray-800 dark:text-gray-200">
              주당 복습일 수
            </label>
            <input
              type="number"
              min="0"
              max="7"
              value={settings.default_review_days}
              onChange={(e) =>
                setSettings({
                  ...settings,
                  default_review_days: parseInt(e.target.value, 10),
                })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
            />
            <p className="text-sm text-gray-600 dark:text-gray-400">
              0-7일 사이의 값을 입력하세요.
            </p>
          </div>
        </div>
      </div>

      {/* 기타 옵션 */}
      <div className="flex flex-col gap-4 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
        <h2 className="text-h2 text-gray-900 dark:text-gray-100">기타 옵션</h2>
        <div className="flex flex-col gap-4">
          <div className="flex flex-col gap-1">
            <label className="block text-body-2-bold text-gray-800 dark:text-gray-200">
              취약과목 집중 모드
            </label>
            <select
              value={settings.default_weak_subject_focus}
              onChange={(e) =>
                setSettings({
                  ...settings,
                  default_weak_subject_focus: e.target.value as
                    | "low"
                    | "medium"
                    | "high",
                })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
            >
              <option value="low">낮음</option>
              <option value="medium">중간</option>
              <option value="high">높음</option>
            </select>
          </div>

          <div className="flex flex-col gap-1">
            <label className="block text-body-2-bold text-gray-800 dark:text-gray-200">
              복습 범위
            </label>
            <select
              value={settings.default_review_scope}
              onChange={(e) =>
                setSettings({
                  ...settings,
                  default_review_scope: e.target.value as "full" | "partial",
                })
              }
              className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
            >
              <option value="full">전체 복습</option>
              <option value="partial">축소 복습</option>
            </select>
          </div>
        </div>
      </div>

      {/* 시간 설정 */}
      <div className="flex flex-col gap-4 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
        <h2 className="text-h2 text-gray-900 dark:text-gray-100">시간 설정</h2>
        <div className="flex flex-col gap-4">
          <div className="flex flex-col gap-1">
            <label className="block text-body-2-bold text-gray-800 dark:text-gray-200">
              점심시간
            </label>
            <div className="flex gap-2 items-center">
              <input
                type="time"
                value={settings.default_lunch_time?.start || "12:00"}
                onChange={(e) =>
                  setSettings({
                    ...settings,
                    default_lunch_time: {
                      ...settings.default_lunch_time!,
                      start: e.target.value,
                    },
                  })
                }
                className="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
              />
              <span className="text-gray-600 dark:text-gray-400">~</span>
              <input
                type="time"
                value={settings.default_lunch_time?.end || "13:00"}
                onChange={(e) =>
                  setSettings({
                    ...settings,
                    default_lunch_time: {
                      ...settings.default_lunch_time!,
                      end: e.target.value,
                    },
                  })
                }
                className="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
              />
            </div>
          </div>

          <div className="flex flex-col gap-1">
            <label className="block text-body-2-bold text-gray-800 dark:text-gray-200">
              학습시간
            </label>
            <div className="flex gap-2 items-center">
              <input
                type="time"
                value={settings.default_study_hours?.start || "09:00"}
                onChange={(e) =>
                  setSettings({
                    ...settings,
                    default_study_hours: {
                      ...settings.default_study_hours!,
                      start: e.target.value,
                    },
                  })
                }
                className="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
              />
              <span className="text-gray-600 dark:text-gray-400">~</span>
              <input
                type="time"
                value={settings.default_study_hours?.end || "18:00"}
                onChange={(e) =>
                  setSettings({
                    ...settings,
                    default_study_hours: {
                      ...settings.default_study_hours!,
                      end: e.target.value,
                    },
                  })
                }
                className="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2 text-body-2 text-gray-900 dark:text-gray-100"
              />
            </div>
          </div>
        </div>
      </div>

      {/* 저장 버튼 */}
      <div className="flex justify-end">
        <button
          type="submit"
          disabled={saving}
          className="rounded-lg bg-gray-900 dark:bg-gray-100 px-6 py-3 text-body-2-bold text-white dark:text-gray-900 hover:bg-gray-800 dark:hover:bg-gray-200 disabled:cursor-not-allowed disabled:bg-gray-400 dark:disabled:bg-gray-600"
        >
          {saving ? "저장 중..." : "설정 저장"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="admin/settings/scheduler/page.tsx">
export const dynamic = 'force-dynamic';

import { Metadata } from "next";
import { SchedulerSettingsForm } from "./_components/SchedulerSettingsForm";

export const metadata: Metadata = {
  title: "스케줄러 설정 - TimeLevelUp",
  description: "기관 전체의 기본 스케줄러 설정을 관리합니다.",
};

export default function SchedulerSettingsPage() {
  return (
    <div className="p-6 md:p-8">
      <div className="mx-auto flex max-w-4xl flex-col gap-6">
        <div className="flex flex-col gap-2">
          <h1 className="text-h1 text-gray-900 dark:text-gray-100">스케줄러 설정</h1>
          <p className="text-body-2 text-gray-600 dark:text-gray-400">
            기관 전체의 기본 스케줄러 설정을 관리합니다. 이 설정은 모든 플랜
            그룹에 기본값으로 적용됩니다.
          </p>
        </div>

        <SchedulerSettingsForm />
      </div>
    </div>
  );
}
</file>

<file path="admin/settings/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import Link from "next/link";
import { getAdminById, listAdminsByTenant } from "@/lib/data/admins";

export default async function AdminSettingsPage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();

  // 현재 관리자 정보 조회
  const currentAdmin = await getAdminById(userId, null);

  // 기관 관리자 목록 조회 (admin만)
  let allAdmins: Array<{ id: string; role: string }> = [];
  if (role === "admin" && currentAdmin?.tenant_id) {
    const admins = await listAdminsByTenant(currentAdmin.tenant_id);
    allAdmins = admins.map((a) => ({ id: a.id, role: a.role }));
  }

  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-h1 text-gray-900">설정</h1>
        <p className="text-body-2 text-gray-600">기관 및 계정 관리 설정</p>
      </div>

      <div className="flex flex-col gap-6">
        {/* 현재 계정 정보 */}
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 p-6 shadow-sm">
          <h2 className="text-h2 text-gray-900 dark:text-gray-100">현재 계정 정보</h2>
          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div className="flex flex-col gap-1">
              <div className="text-sm text-gray-500 dark:text-gray-400">역할</div>
              <div className="text-lg font-medium text-gray-900 dark:text-gray-100">
                {currentAdmin?.role === "admin" ? "관리자" : "상담사"}
              </div>
            </div>
            <div className="flex flex-col gap-1">
              <div className="text-sm text-gray-500 dark:text-gray-400">계정 ID</div>
              <div className="text-lg font-medium text-gray-900 dark:text-gray-100">{userId}</div>
            </div>
          </div>
        </div>

        {/* 기관 설정 */}
        {role === "admin" && (
          <>
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <div className="flex items-center justify-between">
                <h2 className="text-h2 text-gray-900 dark:text-gray-100">기관 설정</h2>
                <Link
                  href="/admin/tenant/settings"
                  className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  기관 설정 관리
                </Link>
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400">기관 정보 및 설정을 관리할 수 있습니다.</p>
            </div>

            {/* 스케줄러 설정 */}
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <div className="flex items-center justify-between">
                <h2 className="text-h2 text-gray-900 dark:text-gray-100">스케줄러 설정</h2>
                <Link
                  href="/admin/settings/scheduler"
                  className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  스케줄러 설정 관리
                </Link>
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                기관 전체의 기본 스케줄러 설정을 관리합니다. 학습일/복습일 비율, 취약과목 집중 모드 등을 설정할 수 있습니다.
              </p>
            </div>

            {/* 추천 시스템 설정 */}
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 p-6 shadow-sm">
              <div className="flex items-center justify-between">
                <h2 className="text-h2 text-gray-900 dark:text-gray-100">추천 시스템 설정</h2>
                <Link
                  href="/admin/recommendation-settings"
                  className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
                >
                  추천 시스템 설정 관리
                </Link>
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                추천 알고리즘의 파라미터를 조정합니다. 학습 범위 추천, 콘텐츠 추천 등의 설정을 관리할 수 있습니다.
              </p>
            </div>
          </>
        )}

        {/* 코치 계정 관리 */}
        {role === "admin" && (
          <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 p-6 shadow-sm">
            <h2 className="text-h2 text-gray-900 dark:text-gray-100">코치 계정 관리</h2>
            {allAdmins.length === 0 ? (
              <p className="text-sm text-gray-500 dark:text-gray-400">등록된 코치 계정이 없습니다.</p>
            ) : (
              <div className="space-y-2">
                {allAdmins.map((admin) => (
                  <div
                    key={admin.id}
                    className="flex items-center justify-between rounded-lg border border-gray-200 dark:border-gray-700 p-4"
                  >
                    <div>
                      <div className="font-medium text-gray-900 dark:text-gray-100">
                        {admin.role === "admin" ? "관리자" : "상담사"}
                      </div>
                      <div className="text-xs text-gray-500 dark:text-gray-400">{admin.id}</div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* 기타 설정 */}
        <div className="flex flex-col gap-4 rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 p-6 shadow-sm">
          <h2 className="text-h2 text-gray-900 dark:text-gray-100">기타 설정</h2>
          <div className="flex flex-col gap-3">
            <Link
              href="/admin/tools"
              className="block rounded-lg border border-gray-200 dark:border-gray-700 p-4 transition hover:bg-gray-50 dark:hover:bg-gray-700"
            >
              <div className="font-medium text-gray-900 dark:text-gray-100">도구</div>
              <div className="text-sm text-gray-600 dark:text-gray-400">관리자 도구 및 유틸리티</div>
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/sms/_components/SingleRecipientSearch.tsx">
"use client";

import { useState, useMemo } from "react";
import Input from "@/components/atoms/Input";
import Label from "@/components/atoms/Label";
import Button from "@/components/atoms/Button";
import Select from "@/components/atoms/Select";
import type { RecipientType } from "./SMSSendForm";

type Student = {
  id: string;
  name: string | null;
  grade?: string | null;
  class?: string | null;
  phone: string | null;
  mother_phone: string | null;
  father_phone: string | null;
  is_active?: boolean | null;
};

type SingleRecipientSearchProps = {
  students: Student[];
  onSelect: (
    phone: string,
    studentName?: string,
    recipientType?: RecipientType
  ) => void;
  selectedPhone?: string;
  recipientType?: RecipientType;
  onRecipientTypeChange?: (type: RecipientType) => void;
};

export function SingleRecipientSearch({
  students,
  onSelect,
  selectedPhone,
  recipientType = "mother",
  onRecipientTypeChange,
}: SingleRecipientSearchProps) {
  // 검색어 입력 상태
  const [searchQuery, setSearchQuery] = useState("");
  // 실제 검색 실행된 검색어
  const [executedSearchQuery, setExecutedSearchQuery] = useState("");

  // 검색 실행 함수
  const handleSearch = () => {
    setExecutedSearchQuery(searchQuery.trim());
  };

  // Enter 키 처리
  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleSearch();
    }
  };

  // 전송 대상자에 따라 전화번호 선택
  const getPhoneByRecipientType = (
    student: Student,
    type: RecipientType
  ): string | null => {
    switch (type) {
      case "student":
        return student.phone;
      case "mother":
        return student.mother_phone;
      case "father":
        return student.father_phone;
      default:
        return student.mother_phone ?? student.father_phone ?? student.phone;
    }
  };

  // 검색 필터링된 학생 목록 (연락처 필터 제거 - 모든 학생 조회 가능)
  // executedSearchQuery 기반으로 필터링
  const filteredStudents = useMemo(() => {
    if (!executedSearchQuery) {
      return [];
    }

    const query = executedSearchQuery.toLowerCase().trim();

    // 디버깅: 검색 전 학생 데이터 확인
    if (process.env.NODE_ENV === "development") {
      console.log("[SingleRecipientSearch] 검색 실행:", {
        query,
        totalStudents: students.length,
        recipientType: recipientType || "mother",
      });
    }

    const results = students
      .filter((student) => {
        // 연락처 필터 제거 - 모든 학생 검색 가능
        const nameMatch = student.name?.toLowerCase().includes(query);
        const phoneMatch = student.phone?.includes(query);
        const motherPhoneMatch = student.mother_phone?.includes(query);
        const fatherPhoneMatch = student.father_phone?.includes(query);
        // grade와 class는 문자열이 아닐 수 있으므로 String()으로 변환
        const gradeMatch = student.grade
          ? String(student.grade).toLowerCase().includes(query)
          : false;
        const classMatch = student.class
          ? String(student.class).toLowerCase().includes(query)
          : false;

        return (
          nameMatch ||
          phoneMatch ||
          motherPhoneMatch ||
          fatherPhoneMatch ||
          gradeMatch ||
          classMatch
        );
      })
      .slice(0, 10); // 최대 10개만 표시

    // 디버깅: 검색 결과 확인
    if (process.env.NODE_ENV === "development") {
      console.log("[SingleRecipientSearch] 검색 결과:", {
        query,
        resultCount: results.length,
        recipientType: recipientType || "mother",
        results: results.map((s) => ({
          name: s.name,
          phone: s.phone,
          mother_phone: s.mother_phone,
          father_phone: s.father_phone,
          grade: s.grade,
          class: s.class,
        })),
      });
    }

    return results;
  }, [students, executedSearchQuery, recipientType]);

  const handleSelect = (student: Student) => {
    const phone = getPhoneByRecipientType(student, recipientType);
    if (phone) {
      onSelect(phone, student.name || undefined, recipientType);
      setSearchQuery(""); // 검색어 초기화
      setExecutedSearchQuery(""); // 검색 결과도 초기화
    }
  };

  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <Label htmlFor="recipient-search">수신자 검색</Label>
        {onRecipientTypeChange && (
          <div className="flex items-center gap-2">
            <Label htmlFor="recipient-type" className="text-xs text-gray-600">
              전송 대상:
            </Label>
            <Select
              id="recipient-type"
              value={recipientType}
              onChange={(e) =>
                onRecipientTypeChange(e.target.value as RecipientType)
              }
              className="text-xs"
            >
              <option value="student">학생</option>
              <option value="mother">어머니</option>
              <option value="father">아버지</option>
            </Select>
          </div>
        )}
      </div>
      <div className="flex gap-2">
        <Input
          id="recipient-search"
          type="text"
          placeholder="학생 이름, 전화번호, 학년, 반으로 검색..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          onKeyDown={handleKeyDown}
          className="flex-1"
        />
        <Button
          type="button"
          variant="primary"
          onClick={handleSearch}
          disabled={!searchQuery.trim()}
        >
          검색
        </Button>
      </div>

      {/* 검색 결과 목록 */}
      {executedSearchQuery && filteredStudents.length > 0 && (
        <div className="rounded-lg border border-gray-200 bg-white shadow-lg">
          <div className="max-h-64 overflow-y-auto">
            <div className="divide-y divide-gray-200">
              {filteredStudents.map((student) => {
                const phone = getPhoneByRecipientType(student, recipientType);
                const isSelected = selectedPhone === phone;
                const recipientTypeLabel =
                  recipientType === "student"
                    ? "학생"
                    : recipientType === "mother"
                    ? "어머니"
                    : "아버지";

                return (
                  <div
                    key={student.id}
                    className={`p-3 hover:bg-gray-50 ${
                      isSelected ? "bg-indigo-50" : ""
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <div className="text-sm font-medium text-gray-900">
                          {student.name || "이름 없음"}
                        </div>
                        <div className="text-xs text-gray-500">
                          {student.grade && student.class
                            ? `${student.grade}학년 ${student.class}반`
                            : student.grade
                            ? `${student.grade}학년`
                            : ""}
                          {phone && (
                            <span>
                              ({recipientTypeLabel}) {phone}
                            </span>
                          )}
                          {!phone && (
                            <span className="text-red-500">
                              ({recipientTypeLabel} 연락처 없음)
                            </span>
                          )}
                        </div>
                      </div>
                      <Button
                        type="button"
                        variant={isSelected ? "primary" : "outline"}
                        size="sm"
                        onClick={() => handleSelect(student)}
                        disabled={!phone}
                      >
                        {isSelected ? "선택됨" : "선택"}
                      </Button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {/* 검색 결과 없음 */}
      {executedSearchQuery && filteredStudents.length === 0 && (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-4 text-center text-sm text-gray-500">
          검색 결과가 없습니다.
        </div>
      )}

      {/* 검색 안내 */}
      {!executedSearchQuery && (
        <div className="space-y-1">
          <p className="text-xs text-gray-500">
            학생 이름, 전화번호, 학년, 반으로 검색하여 선택할 수 있습니다. 검색
            버튼을 클릭하거나 Enter 키를 눌러 검색하세요.
          </p>
          {process.env.NODE_ENV === "development" && (
            <p className="text-xs text-gray-400">
              디버깅: 전체 학생 {students.length}명
            </p>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/sms/_components/SMSPreviewModal.tsx">
"use client";

import { useMemo } from "react";
import Button from "@/components/atoms/Button";
import { formatSMSTemplate, type SMSTemplateType } from "@/lib/services/smsTemplates";

type Student = {
  id: string;
  name: string | null;
  phone?: string | null;
  mother_phone?: string | null;
  father_phone?: string | null;
};

type SMSPreviewModalProps = {
  open: boolean;
  onClose: () => void;
  onConfirm: () => void;
  selectedStudents: Student[];
  message: string;
  templateType?: SMSTemplateType | "";
  templateVariables?: Record<string, string>;
  academyName?: string;
  isSending?: boolean;
};

export function SMSPreviewModal({
  open,
  onClose,
  onConfirm,
  selectedStudents,
  message,
  templateType,
  templateVariables = {},
  academyName = "학원",
  isSending = false,
}: SMSPreviewModalProps) {
  if (!open) return null;

  const recipientCount = selectedStudents.length;

  // 각 학생별 메시지 생성 (템플릿 사용 시)
  const studentMessages = useMemo(() => {
    if (!templateType || !message) {
      return selectedStudents.map((s) => ({
        student: s,
        message: message,
      }));
    }

    return selectedStudents.map((student) => {
      try {
        const variables = {
          ...templateVariables,
          학원명: academyName,
          학생명: student.name || "학생",
        };
        const formattedMessage = formatSMSTemplate(templateType, variables);
        return {
          student,
          message: formattedMessage,
        };
      } catch {
        // 템플릿 포맷팅 실패 시 원본 메시지 사용
        let finalMessage = message;
        finalMessage = finalMessage.replace(
          /\{학생명\}/g,
          student.name || "학생"
        );
        finalMessage = finalMessage.replace(/\{학원명\}/g, academyName);
        return {
          student,
          message: finalMessage,
        };
      }
    });
  }, [selectedStudents, message, templateType, templateVariables, academyName]);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="flex flex-col gap-4 w-full max-w-2xl rounded-lg bg-white p-6 shadow-xl">
        <h2 className="text-xl font-semibold text-gray-900">
          SMS 발송 미리보기
        </h2>

        {/* 발송 요약 */}
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <div className="text-sm text-gray-600">발송 대상자</div>
              <div className="text-lg font-semibold text-gray-900">
                {recipientCount}명
              </div>
            </div>
            <div>
              <div className="text-sm text-gray-600">메시지 길이</div>
              <div className="text-lg font-semibold text-gray-900">
                {message.length}자
              </div>
            </div>
          </div>
        </div>

        {/* 발송 대상자 목록 및 메시지 미리보기 */}
        <div className="max-h-96 overflow-y-auto rounded-lg border border-gray-200">
          <div className="divide-y divide-gray-200">
            {studentMessages.map(({ student, message: studentMessage }) => (
              <div key={student.id} className="flex flex-col gap-2 p-4">
                <div className="flex items-center justify-between">
                  <div className="flex flex-col gap-1">
                    <div className="text-sm font-medium text-gray-900">
                      {student.name || "이름 없음"}
                    </div>
                    <div className="text-xs text-gray-500">
                      {student.mother_phone || student.father_phone || student.phone || "연락처 없음"}
                    </div>
                  </div>
                </div>
                <div className="flex flex-col gap-1 rounded-lg border border-gray-200 bg-gray-50 p-3">
                  <div className="text-xs text-gray-600">발송 메시지:</div>
                  <div className="text-sm text-gray-900 whitespace-pre-wrap">
                    {studentMessage}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* 액션 버튼 */}
        <div className="flex justify-end gap-2">
          <Button
            type="button"
            variant="outline"
            onClick={onClose}
            disabled={isSending}
          >
            취소
          </Button>
          <Button
            type="button"
            variant="primary"
            onClick={onConfirm}
            isLoading={isSending}
            disabled={isSending}
          >
            {isSending ? "발송 중..." : "발송하기"}
          </Button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/sms/_components/SMSRecipientSelector.tsx">
"use client";

import { useState, useMemo } from "react";
import Label from "@/components/atoms/Label";
import Input from "@/components/atoms/Input";
import Select from "@/components/atoms/Select";
import Button from "@/components/atoms/Button";

import type { RecipientType } from "./SMSSendForm";

type Student = {
  id: string;
  name: string | null;
  grade?: string | null;
  class?: string | null;
  phone: string | null;
  mother_phone: string | null;
  father_phone: string | null;
  is_active?: boolean | null;
};

type SMSRecipientSelectorProps = {
  students: Student[];
  selectedStudentIds: Set<string>;
  onSelectionChange: (selectedIds: Set<string>) => void;
  recipientType?: RecipientType;
  onRecipientTypeChange?: (type: RecipientType) => void;
};

type StudentFilter = {
  search: string;
  grade: string;
  class: string;
  isActive: string; // "all" | "active" | "inactive"
  hasParentContact: string; // "all" | "yes" | "no"
};

export function SMSRecipientSelector({
  students,
  selectedStudentIds,
  onSelectionChange,
  recipientType = "mother",
  onRecipientTypeChange,
}: SMSRecipientSelectorProps) {
  const [filter, setFilter] = useState<StudentFilter>({
    search: "",
    grade: "",
    class: "",
    isActive: "all",
    hasParentContact: "all", // 모든 학생 조회 가능하도록 변경
  });

  // 고유 학년 목록 추출
  const uniqueGrades = useMemo(() => {
    const grades = new Set<string>();
    students.forEach((s) => {
      if (s.grade) grades.add(s.grade);
    });
    return Array.from(grades).sort();
  }, [students]);

  // 고유 반 목록 추출
  const uniqueClasses = useMemo(() => {
    const classes = new Set<string>();
    students.forEach((s) => {
      if (s.class) classes.add(s.class);
    });
    return Array.from(classes).sort();
  }, [students]);

  // 필터링된 학생 목록
  const filteredStudents = useMemo(() => {
    return students.filter((student) => {
      // 검색 필터
      if (filter.search) {
        const searchLower = filter.search.toLowerCase();
        const nameMatch = student.name?.toLowerCase().includes(searchLower);
        const phoneMatch = student.phone?.includes(filter.search);
        const motherPhoneMatch = student.mother_phone?.includes(filter.search);
        const fatherPhoneMatch = student.father_phone?.includes(filter.search);
        if (!nameMatch && !phoneMatch && !motherPhoneMatch && !fatherPhoneMatch) return false;
      }

      // 학년 필터
      if (filter.grade && student.grade !== filter.grade) {
        return false;
      }

      // 반 필터
      if (filter.class && student.class !== filter.class) {
        return false;
      }

      // 활성 상태 필터
      if (filter.isActive === "active" && student.is_active !== true) {
        return false;
      }
      if (filter.isActive === "inactive" && student.is_active !== false) {
        return false;
      }

      // 학부모 연락처 필터 (모든 학생 조회 가능하도록 변경)
      // hasParentContact 필터는 더 이상 사용하지 않음 (모든 학생 조회)

      return true;
    });
  }, [students, filter]);

  // 전송 대상자에 따라 전화번호 선택
  const getPhoneByRecipientType = (student: Student, type: RecipientType): string | null => {
    switch (type) {
      case "student":
        return student.phone;
      case "mother":
        return student.mother_phone;
      case "father":
        return student.father_phone;
      default:
        return student.mother_phone ?? student.father_phone ?? student.phone;
    }
  };

  // 필터링된 학생 중 선택 가능한 학생 (선택한 대상자 타입에 따라)
  const selectableStudents = useMemo(() => {
    return filteredStudents.filter((s) => {
      const phone = getPhoneByRecipientType(s, recipientType);
      return !!phone;
    });
  }, [filteredStudents, recipientType]);

  const handleToggleStudent = (studentId: string) => {
    const next = new Set(selectedStudentIds);
    if (next.has(studentId)) {
      next.delete(studentId);
    } else {
      next.add(studentId);
    }
    onSelectionChange(next);
  };

  const handleSelectAll = () => {
    if (selectedStudentIds.size === selectableStudents.length) {
      onSelectionChange(new Set());
    } else {
      onSelectionChange(new Set(selectableStudents.map((s) => s.id)));
    }
  };

  const selectedCount = selectedStudentIds.size;
  const selectableCount = selectableStudents.length;

  return (
    <div className="flex flex-col gap-4">
      {/* 필터 섹션 */}
      <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-semibold text-gray-900">발송 대상자 필터</h3>
          {onRecipientTypeChange && (
            <div className="flex items-center gap-2">
              <Label htmlFor="bulk-recipient-type" className="text-xs text-gray-600">
                전송 대상:
              </Label>
              <Select
                id="bulk-recipient-type"
                value={recipientType}
                onChange={(e) => onRecipientTypeChange(e.target.value as RecipientType)}
                className="text-xs"
              >
                <option value="student">학생</option>
                <option value="mother">어머니</option>
                <option value="father">아버지</option>
              </Select>
            </div>
          )}
        </div>
        <div className="grid grid-cols-1 gap-3 md:grid-cols-4">
          <div>
            <Label htmlFor="filter-search">이름/전화번호 검색</Label>
            <Input
              id="filter-search"
              type="text"
              placeholder="검색..."
              value={filter.search}
              onChange={(e) =>
                setFilter((prev) => ({ ...prev, search: e.target.value }))
              }
            />
          </div>

          <div>
            <Label htmlFor="filter-grade">학년</Label>
            <Select
              id="filter-grade"
              value={filter.grade}
              onChange={(e) =>
                setFilter((prev) => ({ ...prev, grade: e.target.value }))
              }
            >
              <option value="">전체</option>
              {uniqueGrades.map((grade) => (
                <option key={grade} value={grade}>
                  {grade}학년
                </option>
              ))}
            </Select>
          </div>

          <div>
            <Label htmlFor="filter-class">반</Label>
            <Select
              id="filter-class"
              value={filter.class}
              onChange={(e) =>
                setFilter((prev) => ({ ...prev, class: e.target.value }))
              }
            >
              <option value="">전체</option>
              {uniqueClasses.map((cls) => (
                <option key={cls} value={cls}>
                  {cls}반
                </option>
              ))}
            </Select>
          </div>

          <div>
            <Label htmlFor="filter-active">활성 상태</Label>
            <Select
              id="filter-active"
              value={filter.isActive}
              onChange={(e) =>
                setFilter((prev) => ({ ...prev, isActive: e.target.value }))
              }
            >
              <option value="all">전체</option>
              <option value="active">활성</option>
              <option value="inactive">비활성</option>
            </Select>
          </div>

        </div>
      </div>

      {/* 선택 정보 및 전체 선택 버튼 */}
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-700">
          <span className="font-medium text-gray-900">
            {selectedCount}명 선택됨
          </span>
          <span className="pl-2 text-gray-500">
            (선택 가능: {selectableCount}명)
          </span>
        </div>
        <div className="flex gap-2">
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={handleSelectAll}
            disabled={selectableCount === 0}
          >
            {selectedCount === selectableCount ? "전체 해제" : "전체 선택"}
          </Button>
        </div>
      </div>

      {/* 학생 목록 */}
      <div className="max-h-96 overflow-y-auto rounded-lg border border-gray-200">
        {selectableStudents.length === 0 ? (
          <div className="p-8 text-center text-sm text-gray-500">
            {filteredStudents.length === 0
              ? "필터 조건에 맞는 학생이 없습니다."
              : "학부모 연락처가 있는 학생이 없습니다."}
          </div>
        ) : (
          <div className="divide-y divide-gray-200">
            {selectableStudents.map((student) => (
              <label
                key={student.id}
                className="flex cursor-pointer items-center gap-3 p-3 hover:bg-gray-50"
              >
                <input
                  type="checkbox"
                  checked={selectedStudentIds.has(student.id)}
                  onChange={() => handleToggleStudent(student.id)}
                  className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                />
                <div className="flex-1">
                  <div className="text-sm font-medium text-gray-900">
                    {student.name || "이름 없음"}
                  </div>
                  <div className="text-xs text-gray-500">
                    {student.grade && student.class
                      ? `${student.grade}학년 ${student.class}반`
                      : student.grade
                      ? `${student.grade}학년`
                      : ""}
                    {(() => {
                      const phone = getPhoneByRecipientType(student, recipientType);
                      const recipientTypeLabel = 
                        recipientType === "student" ? "학생" :
                        recipientType === "mother" ? "어머니" : "아버지";
                      return phone ? (
                        <span className="pl-2">({recipientTypeLabel}) {phone}</span>
                      ) : (
                        <span className="pl-2 text-red-500">({recipientTypeLabel} 연락처 없음)</span>
                      );
                    })()}
                  </div>
                </div>
              </label>
            ))}
          </div>
        )}
      </div>

      {/* 필터링된 학생 중 선택한 대상자 타입의 연락처가 없는 학생 안내 */}
      {filteredStudents.length > selectableStudents.length && (
        <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-3 text-xs text-yellow-800">
          {(() => {
            const recipientTypeLabel = 
              recipientType === "student" ? "학생 본인" :
              recipientType === "mother" ? "어머니" : "아버지";
            return `${recipientTypeLabel} 연락처가 없는 학생 ${filteredStudents.length - selectableStudents.length}명은 선택할 수 없습니다.`;
          })()}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/sms/_components/SMSSendForm.tsx">
"use client";

import { useState, useTransition, useMemo, useCallback } from "react";
import { useRouter } from "next/navigation";
import {
  getAllSMSTemplates,
  formatSMSTemplate,
  type SMSTemplateType,
} from "@/lib/services/smsTemplates";
import Button from "@/components/atoms/Button";
import Input from "@/components/atoms/Input";
import Label from "@/components/atoms/Label";
import Select from "@/components/atoms/Select";
import { useToast } from "@/components/ui/ToastProvider";
import { SMSRecipientSelector } from "./SMSRecipientSelector";
import { SMSPreviewModal } from "./SMSPreviewModal";
import { SMSSendSummary } from "./SMSSendSummary";
import { SingleRecipientSearch } from "./SingleRecipientSearch";

// 전송 대상자 타입
export type RecipientType = "student" | "mother" | "father";

type Student = {
  id: string;
  name: string | null;
  grade?: string | null;
  class?: string | null;
  phone: string | null; // 학생 본인 연락처
  mother_phone: string | null;
  father_phone: string | null;
  is_active?: boolean | null;
};

type SMSSendFormProps = {
  students: Student[];
  academyName?: string;
};

export function SMSSendForm({
  students,
  academyName = "학원",
}: SMSSendFormProps) {
  const router = useRouter();
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [selectedStudentIds, setSelectedStudentIds] = useState<Set<string>>(
    new Set()
  );
  const [selectedTemplate, setSelectedTemplate] = useState<SMSTemplateType | "">(
    ""
  );
  const [message, setMessage] = useState("");
  const [customPhone, setCustomPhone] = useState("");
  const [selectedStudentName, setSelectedStudentName] = useState<string>("");
  const [templateVariables, setTemplateVariables] = useState<
    Record<string, string>
  >({});
  const [showPreview, setShowPreview] = useState(false);
  const [sendMode, setSendMode] = useState<"single" | "bulk">("bulk");
  // 전송 대상자 선택 (단일/일괄 발송 모두)
  const [recipientType, setRecipientType] = useState<RecipientType>("mother");

  // 클라이언트 컴포넌트에 전달할 콜백 함수들 (useCallback으로 감싸기)
  const handleSelectionChange = useCallback((selectedIds: Set<string>) => {
    setSelectedStudentIds(selectedIds);
  }, []);

  const handleRecipientTypeChange = useCallback((type: RecipientType) => {
    setRecipientType(type);
  }, []);

  const handleSingleRecipientSelect = useCallback((phone: string, studentName?: string) => {
    setCustomPhone(phone);
    setSelectedStudentName(studentName || "");
  }, []);

  const templates = getAllSMSTemplates();

  // 선택된 학생 목록
  const selectedStudents = useMemo(() => {
    return students.filter((s) => selectedStudentIds.has(s.id));
  }, [students, selectedStudentIds]);

  // 템플릿 선택 시 메시지 자동 채우기
  const handleTemplateChange = (templateType: SMSTemplateType) => {
    const template = templates.find((t) => t.id === templateType);
    if (template) {
      // 템플릿 변수를 기본값으로 채우기
      const defaultVariables: Record<string, string> = {
        학원명: academyName,
      };

      // 템플릿 변수가 있으면 변수 입력 폼을 위해 저장 (학원명, 학생명 제외)
      const variablesToInput = template.variables.filter(
        (v) => v !== "학원명" && v !== "학생명"
      );
      if (variablesToInput.length > 0) {
        // 기존 변수는 유지하고 새로운 변수만 추가
        setTemplateVariables((prev) => {
          const next = { ...prev };
          variablesToInput.forEach((v) => {
            if (!next[v]) {
              next[v] = "";
            }
          });
          return next;
        });
      } else {
        setTemplateVariables({});
      }

      // 기본 변수로 메시지 생성 (학생명은 예시로 표시)
      try {
        const exampleVariables = {
          ...defaultVariables,
          학생명: "학생명", // 예시
        };
        const formattedMessage = formatSMSTemplate(
          templateType,
          exampleVariables
        );
        setMessage(formattedMessage);
      } catch {
        // 변수가 부족하면 예시로 표시
        let exampleMessage = template.content;
        template.variables.forEach((variable) => {
          if (variable === "학원명") {
            exampleMessage = exampleMessage.replace(
              /\{학원명\}/g,
              academyName
            );
          } else if (variable === "학생명") {
            exampleMessage = exampleMessage.replace(/\{학생명\}/g, "학생명");
          } else {
            exampleMessage = exampleMessage.replace(
              new RegExp(`\\{${variable}\\}`, "g"),
              `[${variable}]`
            );
          }
        });
        setMessage(exampleMessage);
      }
    }
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (sendMode === "single") {
      // 단일 발송 모드
      if (!customPhone.trim()) {
        showError("수신자 전화번호를 입력해주세요.");
        return;
      }
    } else {
      // 일괄 발송 모드
      if (selectedStudentIds.size === 0) {
        showError("최소 1명 이상의 학생을 선택해주세요.");
        return;
      }
    }

    if (!message.trim()) {
      showError("메시지 내용을 입력해주세요.");
      return;
    }

    // 미리보기 표시
    if (sendMode === "bulk" && selectedStudentIds.size > 0) {
      setShowPreview(true);
      return;
    }

    // 단일 발송은 바로 발송
    handleSend();
  };

  const handleSend = useCallback(() => {
    setShowPreview(false);

    startTransition(async () => {
      try {
        if (sendMode === "single") {
          // 단일 발송 - API Route 호출
          const response = await fetch("/api/purio/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              type: "single",
              phone: customPhone.trim(),
              message: message.trim(),
            }),
          });

          const result = await response.json();

          if (!response.ok || !result.success) {
            showError(result.error || "SMS 발송에 실패했습니다.");
            return;
          }

          showSuccess("SMS가 성공적으로 발송되었습니다.");
          // 결과 페이지로 이동
          setTimeout(() => {
            router.push("/admin/sms/results");
          }, 1000);
        } else {
          // 일괄 발송 - API Route 호출
          const response = await fetch("/api/purio/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              type: "bulk",
              studentIds: Array.from(selectedStudentIds),
              message: message.trim(),
              templateVariables: {
                ...templateVariables,
                학원명: academyName,
              },
              recipientType,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            showError(result.error || "SMS 발송에 실패했습니다.");
            return;
          }

          if (result.success > 0) {
            showSuccess(
              `${result.success}명에게 SMS가 성공적으로 발송되었습니다.${
                result.failed > 0
                  ? ` (${result.failed}명 실패)`
                  : ""
              }`
            );
            // 결과 페이지로 이동
            setTimeout(() => {
              router.push("/admin/sms/results");
            }, 1000);
          } else {
            showError(
              result.errors && result.errors.length > 0
                ? result.errors[0].error
                : "SMS 발송에 실패했습니다."
            );
          }
        }
      } catch (error: any) {
        console.error("[SMS] 발송 실패:", error);
        showError(error.message || "SMS 발송 중 오류가 발생했습니다.");
      }
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    sendMode,
    customPhone,
    message,
    selectedStudentIds,
    templateVariables,
    recipientType,
    academyName,
    startTransition,
    // showSuccess와 showError는 useToast에서 가져온 안정적인 함수이므로
    // dependency에 포함하지 않아도 됩니다 (클로저로 캡처됨)
  ]);

  // 선택된 템플릿
  const selectedTemplateObj = useMemo(() => {
    if (!selectedTemplate) return null;
    return templates.find((t) => t.id === selectedTemplate);
  }, [selectedTemplate, templates]);

  return (
    <>
      <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="text-lg font-semibold text-gray-900">SMS 발송</h2>
        <form onSubmit={handleSubmit} className="flex flex-col gap-6">
          {/* 발송 모드 선택 */}
          <div className="flex flex-col gap-2">
            <Label>발송 모드</Label>
            <div className="flex gap-4">
              <label className="flex cursor-pointer items-center gap-2">
                <input
                  type="radio"
                  name="sendMode"
                  value="bulk"
                  checked={sendMode === "bulk"}
                  onChange={() => {
                    setSendMode("bulk");
                    setCustomPhone("");
                  }}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500"
                />
                <span className="text-sm text-gray-700">일괄 발송</span>
              </label>
              <label className="flex cursor-pointer items-center gap-2">
                <input
                  type="radio"
                  name="sendMode"
                  value="single"
                  checked={sendMode === "single"}
                  onChange={() => {
                    setSendMode("single");
                    setSelectedStudentIds(new Set());
                    setCustomPhone("");
                    setSelectedStudentName("");
                  }}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500"
                />
                <span className="text-sm text-gray-700">단일 발송</span>
              </label>
            </div>
          </div>

          {/* 발송 대상자 선택 (일괄 발송 모드) */}
          {sendMode === "bulk" && (
              <div className="flex flex-col gap-2">
                <Label>발송 대상자 선택</Label>
                <div>
                  <SMSRecipientSelector
                    students={students}
                    selectedStudentIds={selectedStudentIds}
                    onSelectionChange={handleSelectionChange}
                    recipientType={recipientType}
                    onRecipientTypeChange={handleRecipientTypeChange}
                  />
                </div>
              </div>
          )}

          {/* 전송 대상자 선택 (단일/일괄 발송 모두) */}
          <div className="flex flex-col gap-2">
            <Label>전송 대상자</Label>
            <div className="flex gap-4">
              <label className="flex cursor-pointer items-center gap-2">
                <input
                  type="radio"
                  name="recipientType"
                  value="student"
                  checked={recipientType === "student"}
                  onChange={() => setRecipientType("student")}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500"
                />
                <span className="text-sm text-gray-700">학생 본인</span>
              </label>
              <label className="flex cursor-pointer items-center gap-2">
                <input
                  type="radio"
                  name="recipientType"
                  value="mother"
                  checked={recipientType === "mother"}
                  onChange={() => setRecipientType("mother")}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500"
                />
                <span className="text-sm text-gray-700">어머니</span>
              </label>
              <label className="flex cursor-pointer items-center gap-2">
                <input
                  type="radio"
                  name="recipientType"
                  value="father"
                  checked={recipientType === "father"}
                  onChange={() => setRecipientType("father")}
                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500"
                />
                <span className="text-sm text-gray-700">아버지</span>
              </label>
            </div>
          </div>

          {/* 수신자 검색 및 입력 (단일 발송 모드) */}
          {sendMode === "single" && (
            <div className="space-y-4">
              {/* 학생 검색 */}
              <SingleRecipientSearch
                students={students}
                onSelect={handleSingleRecipientSelect}
                selectedPhone={customPhone}
                recipientType={recipientType}
                onRecipientTypeChange={handleRecipientTypeChange}
              />

              {/* 수신자 전화번호 입력 */}
              <div className="flex flex-col gap-2">
                <Label htmlFor="phone">수신자 전화번호 *</Label>
                <div className="flex gap-2">
                  <Input
                    id="phone"
                    type="tel"
                    placeholder="010-1234-5678 또는 검색으로 선택"
                    value={customPhone}
                    onChange={(e) => {
                      setCustomPhone(e.target.value);
                      if (!e.target.value) {
                        setSelectedStudentName("");
                      }
                    }}
                    className="flex-1"
                    required
                  />
                  {customPhone && (
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        setCustomPhone("");
                        setSelectedStudentName("");
                      }}
                    >
                      초기화
                    </Button>
                  )}
                </div>
                {selectedStudentName && (
                  <p className="text-xs text-gray-600">
                    선택된 학생: {selectedStudentName}
                  </p>
                )}
              </div>
            </div>
          )}

          {/* 템플릿 선택 */}
          <div>
            <Label htmlFor="template">템플릿 선택 (선택사항)</Label>
            <Select
              id="template"
              value={selectedTemplate}
              onChange={(e) => {
                const templateType = e.target.value as SMSTemplateType | "";
                setSelectedTemplate(templateType);
                if (templateType) {
                  handleTemplateChange(templateType);
                } else {
                  setTemplateVariables({});
                }
              }}
            >
              <option value="">템플릿 선택 안 함</option>
              {templates.map((template) => (
                <option key={template.id} value={template.id}>
                  {template.title}
                </option>
              ))}
            </Select>
          </div>

          {/* 템플릿 변수 입력 (템플릿 선택 시) */}
          {selectedTemplateObj &&
            selectedTemplateObj.variables.length > 0 &&
            selectedTemplateObj.variables.filter(
              (v) => v !== "학원명" && v !== "학생명"
            ).length > 0 && (
              <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-4">
                <Label className="block text-sm font-medium text-gray-700">
                  템플릿 변수 입력
                </Label>
                <div className="flex flex-col gap-2">
                  {selectedTemplateObj.variables
                    .filter((v) => v !== "학원명" && v !== "학생명")
                    .map((variable) => (
                      <div key={variable}>
                        <Label htmlFor={`var-${variable}`} className="text-xs">
                          {variable}
                        </Label>
                        <Input
                          id={`var-${variable}`}
                          type="text"
                          value={templateVariables[variable] || ""}
                          onChange={(e) =>
                            setTemplateVariables((prev) => ({
                              ...prev,
                              [variable]: e.target.value,
                            }))
                          }
                          placeholder={`${variable} 입력`}
                        />
                      </div>
                    ))}
                </div>
                <p className="text-xs text-gray-500">
                  * 학원명과 학생명은 자동으로 채워집니다.
                </p>
              </div>
            )}

          {/* 메시지 내용 */}
          <div className="flex flex-col gap-1">
            <Label htmlFor="message">메시지 내용 *</Label>
            <textarea
              id="message"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="메시지 내용을 입력하세요..."
              className="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              rows={4}
              required
            />
            <p className="text-xs text-gray-500">
              {message.length}자 / SMS는 90자, LMS는 2000자까지 가능합니다.
            </p>
          </div>

          {/* 발송 요약 (일괄 발송 모드) */}
          {sendMode === "bulk" && selectedStudentIds.size > 0 && (
            <SMSSendSummary
              recipientCount={selectedStudentIds.size}
              messageLength={message.length}
            />
          )}

          {/* 발송 버튼 */}
          <div className="flex justify-end gap-2">
            {sendMode === "bulk" && selectedStudentIds.size > 0 && (
              <Button
                type="button"
                variant="outline"
                onClick={() => setShowPreview(true)}
                disabled={isPending || !message.trim()}
              >
                미리보기
              </Button>
            )}
            <Button type="submit" disabled={isPending || !message.trim()}>
              {isPending ? "발송 중..." : "SMS 발송"}
            </Button>
          </div>
        </form>
      </div>

      {/* 미리보기 모달 */}
      <SMSPreviewModal
        open={showPreview}
        onClose={() => setShowPreview(false)}
        onConfirm={handleSend}
        selectedStudents={selectedStudents}
        message={message}
        templateType={selectedTemplate || undefined}
        templateVariables={templateVariables}
        academyName={academyName}
        isSending={isPending}
      />
    </>
  );
}
</file>

<file path="admin/sms/_components/SMSSendSummary.tsx">
"use client";

type SMSSendSummaryProps = {
  recipientCount: number;
  messageLength: number;
};

export function SMSSendSummary({
  recipientCount,
  messageLength,
}: SMSSendSummaryProps) {
  // SMS/LMS 구분 (90자 이하: SMS, 90자 초과: LMS)
  const messageType = messageLength <= 90 ? "SMS" : "LMS";

  // 예상 비용 계산 (SMS: 10원, LMS: 30원 - 대략적인 가격)
  const estimatedCost =
    messageType === "SMS" ? recipientCount * 10 : recipientCount * 30;

  return (
    <div className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4">
      <h3 className="text-sm font-semibold text-gray-900">발송 요약</h3>
      <div className="grid grid-cols-3 gap-4">
        <div className="flex flex-col gap-1">
          <div className="text-xs text-gray-600">발송 대상자</div>
          <div className="text-lg font-semibold text-gray-900">
            {recipientCount}명
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-xs text-gray-600">메시지 유형</div>
          <div className="text-lg font-semibold text-gray-900">
            {messageType}
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-xs text-gray-600">예상 비용</div>
          <div className="text-lg font-semibold text-gray-900">
            약 {estimatedCost.toLocaleString()}원
          </div>
        </div>
      </div>
      <p className="text-xs text-gray-500">
        * 예상 비용은 대략적인 금액이며, 실제 발송 비용은 다를 수 있습니다.
      </p>
    </div>
  );
}
</file>

<file path="admin/sms/results/_components/SMSResultsClient.tsx">
"use client";

import { useState, useEffect, useMemo } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { EmptyState } from "@/components/ui/EmptyState";

type SMSLog = {
  id: string;
  tenant_id?: string | null;
  recipient_id?: string | null;
  recipient_phone?: string | null;
  message_content?: string | null;
  template_id?: string | null;
  status?: "pending" | "sent" | "delivered" | "failed" | null;
  sent_at?: string | null;
  delivered_at?: string | null;
  error_message?: string | null;
  created_at?: string | null;
};

type SMSResultsClientProps = {
  initialLogs: SMSLog[];
  studentMap: Record<string, string>;
  stats: {
    total: number;
    pending: number;
    sent: number;
    delivered: number;
    failed: number;
  };
  searchQuery: string;
  statusFilter: string;
  currentPage: number;
  totalPages: number;
  totalCount: number;
};

export function SMSResultsClient({
  initialLogs,
  studentMap,
  stats,
  searchQuery,
  statusFilter,
  currentPage,
  totalPages,
  totalCount,
}: SMSResultsClientProps) {
  const router = useRouter();
  const [logs, setLogs] = useState(initialLogs);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [expandedLogId, setExpandedLogId] = useState<string | null>(null);
  const [searchInput, setSearchInput] = useState(searchQuery);
  const [statusInput, setStatusInput] = useState(statusFilter);

  // initialLogs가 변경되면 상태 업데이트 (서버에서 새로고침된 경우)
  useEffect(() => {
    setLogs(initialLogs);
  }, [initialLogs]);

  // 자동 새로고침 (30초마다)
  useEffect(() => {
    const interval = setInterval(() => {
      refreshData();
    }, 30000); // 30초

    return () => clearInterval(interval);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const refreshData = async () => {
    setIsRefreshing(true);
    try {
      router.refresh();
    } catch (error) {
      console.error("[SMS Results] 새로고침 실패:", error);
    } finally {
      setIsRefreshing(false);
    }
  };

  const handleSearch = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    const params = new URLSearchParams();
    if (searchInput.trim()) params.set("search", searchInput.trim());
    if (statusInput) params.set("status", statusInput);
    router.push(`/admin/sms/results?${params.toString()}`);
  };

  const handleStatusChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const newStatus = e.target.value;
    setStatusInput(newStatus);
    const params = new URLSearchParams();
    if (searchInput.trim()) params.set("search", searchInput.trim());
    if (newStatus) params.set("status", newStatus);
    router.push(`/admin/sms/results?${params.toString()}`);
  };

  const handlePageChange = (newPage: number) => {
    const params = new URLSearchParams();
    if (searchQuery) params.set("search", searchQuery);
    if (statusFilter) params.set("status", statusFilter);
    if (newPage > 1) params.set("page", newPage.toString());
    router.push(`/admin/sms/results?${params.toString()}`);
  };

  const getStatusBadgeClass = (status: string | null | undefined) => {
    switch (status) {
      case "sent":
      case "delivered":
        return "bg-green-100 text-green-800";
      case "pending":
        return "bg-yellow-100 text-yellow-800";
      case "failed":
        return "bg-red-100 text-red-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  const getStatusLabel = (status: string | null | undefined) => {
    switch (status) {
      case "sent":
        return "발송 완료";
      case "delivered":
        return "전달 완료";
      case "pending":
        return "대기 중";
      case "failed":
        return "실패";
      default:
        return "알 수 없음";
    }
  };

  return (
    <div className="flex flex-col gap-6">
      {/* 통계 */}
      <div className="grid grid-cols-2 gap-4 md:grid-cols-5">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">전체</div>
          <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">대기 중</div>
          <div className="text-2xl font-bold text-yellow-600">{stats.pending}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">발송 완료</div>
          <div className="text-2xl font-bold text-green-600">{stats.sent}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">전달 완료</div>
          <div className="text-2xl font-bold text-blue-600">{stats.delivered}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">실패</div>
          <div className="text-2xl font-bold text-red-600">{stats.failed}</div>
        </div>
      </div>

      {/* 필터 및 검색 */}
      <div className="flex flex-col gap-4 md:flex-row md:items-center">
        <form onSubmit={handleSearch} className="flex flex-1 gap-2">
          <input
            type="text"
            placeholder="학생 이름, 전화번호, 메시지 내용으로 검색..."
            value={searchInput}
            onChange={(e) => setSearchInput(e.target.value)}
            className="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          />
          <select
            value={statusInput}
            onChange={handleStatusChange}
            className="rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          >
            <option value="">전체 상태</option>
            <option value="pending">대기 중</option>
            <option value="sent">발송 완료</option>
            <option value="delivered">전달 완료</option>
            <option value="failed">실패</option>
          </select>
          <button
            type="submit"
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            검색
          </button>
          {(searchQuery || statusFilter) && (
            <Link
              href="/admin/sms/results"
              className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </Link>
          )}
        </form>
        <div className="flex items-center gap-2">
          {isRefreshing && (
            <span className="text-xs text-gray-500">새로고침 중...</span>
          )}
          <button
            onClick={refreshData}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
          >
            새로고침
          </button>
        </div>
      </div>

      {/* SMS 로그 목록 */}
      {logs.length === 0 ? (
        <EmptyState
          title="SMS 발송 이력이 없습니다"
          description="아직 발송된 SMS가 없습니다."
        />
      ) : (
        <>
          <div className="space-y-4">
            {logs.map((log) => {
              const studentName = studentMap[log.recipient_id ?? ""] ?? "-";
              const isExpanded = expandedLogId === log.id;

              return (
                <div
                  key={log.id}
                  className="rounded-lg border border-gray-200 bg-white shadow-sm"
                >
                  <div
                    className="p-6 cursor-pointer"
                    onClick={() =>
                      setExpandedLogId(isExpanded ? null : log.id)
                    }
                  >
                    <div className="flex items-center justify-between gap-3">
                      <div className="flex items-center gap-3">
                        {log.recipient_id && (
                          <Link
                            href={`/admin/students/${log.recipient_id}`}
                            onClick={(e) => e.stopPropagation()}
                            className="font-semibold text-indigo-600 hover:text-indigo-800"
                          >
                            {studentName}
                          </Link>
                        )}
                        {!log.recipient_id && (
                          <span className="font-semibold text-gray-900">-</span>
                        )}
                        <span className="text-sm text-gray-500">
                          {log.recipient_phone ?? "-"}
                        </span>
                        <span
                          className={`rounded-full px-2 py-1 text-xs font-medium ${getStatusBadgeClass(log.status)}`}
                        >
                          {getStatusLabel(log.status)}
                        </span>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className="text-xs text-gray-500">
                          {log.created_at
                            ? new Date(log.created_at).toLocaleString("ko-KR")
                            : "-"}
                        </span>
                        <span className="text-xs text-gray-400">
                          {isExpanded ? "▼" : "▶"}
                        </span>
                      </div>
                    </div>
                    <p className="text-sm text-gray-700 line-clamp-2">
                      {log.message_content ?? "-"}
                    </p>
                  </div>

                  {/* 상세 정보 (확장 시 표시) */}
                  {isExpanded && (
                    <div className="border-t border-gray-200 bg-gray-50 p-6">
                      <div className="space-y-3">
                        <div>
                          <span className="text-xs font-medium text-gray-600">
                            메시지 내용:
                          </span>
                          <p className="text-sm text-gray-900">
                            {log.message_content ?? "-"}
                          </p>
                        </div>
                        {log.sent_at && (
                          <div className="flex flex-col gap-1">
                            <span className="text-xs font-medium text-gray-600">
                              발송 시간:
                            </span>
                            <p className="text-sm text-gray-900">
                              {new Date(log.sent_at).toLocaleString("ko-KR")}
                            </p>
                          </div>
                        )}
                        {log.delivered_at && (
                          <div className="flex flex-col gap-1">
                            <span className="text-xs font-medium text-gray-600">
                              전달 시간:
                            </span>
                            <p className="text-sm text-gray-900">
                              {new Date(log.delivered_at).toLocaleString("ko-KR")}
                            </p>
                          </div>
                        )}
                        {log.error_message && (
                          <div className="flex flex-col gap-1">
                            <span className="text-xs font-medium text-red-600">
                              오류 메시지:
                            </span>
                            <p className="text-sm text-red-700">
                              {log.error_message}
                            </p>
                          </div>
                        )}
                        <div className="grid grid-cols-2 gap-4 text-xs">
                          <div className="flex flex-col gap-1">
                            <span className="font-medium text-gray-600">로그 ID:</span>
                            <p className="text-gray-900 font-mono">{log.id}</p>
                          </div>
                          {log.template_id && (
                            <div className="flex flex-col gap-1">
                              <span className="font-medium text-gray-600">
                                템플릿 ID:
                              </span>
                              <p className="text-gray-900 font-mono">
                                {log.template_id}
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* 페이지네이션 */}
          {totalPages > 1 && (
            <div className="flex items-center justify-center gap-2 pt-6">
              <button
                onClick={() => handlePageChange(currentPage - 1)}
                disabled={currentPage === 1}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                이전
              </button>
              <span className="text-sm text-gray-600">
                {currentPage} / {totalPages} (총 {totalCount}개)
              </span>
              <button
                onClick={() => handlePageChange(currentPage + 1)}
                disabled={currentPage === totalPages}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                다음
              </button>
            </div>
          )}
        </>
      )}
    </div>
  );
}
</file>

<file path="admin/sms/results/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import Link from "next/link";
import { EmptyState } from "@/components/ui/EmptyState";
import { SMSResultsClient } from "./_components/SMSResultsClient";

type SMSLogRow = {
  id: string;
  tenant_id?: string | null;
  recipient_id?: string | null;
  recipient_phone?: string | null;
  message_content?: string | null;
  template_id?: string | null;
  status?: "pending" | "sent" | "delivered" | "failed" | null;
  sent_at?: string | null;
  delivered_at?: string | null;
  error_message?: string | null;
  created_at?: string | null;
};

type StudentRow = {
  id: string;
  name?: string | null;
};

const ITEMS_PER_PAGE = 20;

export default async function SMSResultsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();
  const params = await searchParams;
  const searchQuery = params.search?.trim() ?? "";
  const statusFilter = params.status?.trim() ?? "";
  const page = parseInt(params.page || "1", 10);
  const offset = (page - 1) * ITEMS_PER_PAGE;

  // SMS 로그 조회 (페이지네이션 적용)
  // 검색 쿼리가 있으면 먼저 모든 로그를 가져와서 필터링 (Supabase의 텍스트 검색 제한으로 인해)
  const selectLogs = () =>
    supabase
      .from("sms_logs")
      .select(
        "id,tenant_id,recipient_id,recipient_phone,message_content,template_id,status,sent_at,delivered_at,error_message,created_at",
        { count: "exact" }
      )
      .order("created_at", { ascending: false });

  let query = selectLogs();

  // 상태 필터링
  if (statusFilter && ["pending", "sent", "delivered", "failed"].includes(statusFilter)) {
    query = query.eq("status", statusFilter);
  }

  let { data: allLogs, error, count } = await query;

  if (error && error.code === "42703") {
    const retryQuery = selectLogs();
    if (statusFilter && ["pending", "sent", "delivered", "failed"].includes(statusFilter)) {
      retryQuery.eq("status", statusFilter);
    }
    ({ data: allLogs, error, count } = await retryQuery);
  }

  if (error) {
    console.error("[admin/sms/results] SMS 로그 조회 실패:", error);
  }

  // 테이블이 없는 경우 에러 메시지 표시
  const errorCode = error?.code;
  const errorMessage = error?.message || "";
  if (
    error &&
    (errorCode === "PGRST205" ||
      errorCode === "42P01" ||
      errorMessage.includes("Could not find the table") ||
      errorMessage.includes("테이블"))
  ) {
    return (
      <div className="flex flex-col gap-8 p-6 md:p-10">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">SMS 발송 이력</h1>
        </div>
        <div className="flex flex-col gap-2 rounded-xl border border-yellow-200 bg-yellow-50 p-8 text-center">
          <p className="text-sm font-medium text-yellow-800">
            SMS 로그 테이블이 아직 생성되지 않았습니다.
          </p>
          <p className="text-xs text-yellow-700">
            데이터베이스 마이그레이션을 실행해주세요.
          </p>
        </div>
      </div>
    );
  }

  let logRows = (allLogs as SMSLogRow[] | null) ?? [];

  // 학생 정보 조회 (로그에 표시하기 위해, 검색에도 사용)
  const allRecipientIds = [
    ...new Set(logRows.map((l) => l.recipient_id).filter(Boolean)),
  ] as string[];
  const { data: students } = await supabase
    .from("students")
    .select("id,name")
    .in("id", allRecipientIds.length > 0 ? allRecipientIds : [""]);

  const studentMap = new Map(
    (students ?? []).map((s: StudentRow) => [s.id, s.name ?? "이름 없음"])
  );

  // 검색 필터링 (학생 이름, 전화번호, 메시지 내용으로)
  if (searchQuery) {
    logRows = logRows.filter((log) => {
      const studentName = studentMap.get(log.recipient_id ?? "") ?? "";
      const phone = log.recipient_phone ?? "";
      const message = log.message_content ?? "";
      return (
        studentName.includes(searchQuery) ||
        phone.includes(searchQuery) ||
        message.includes(searchQuery)
      );
    });
  }

  // 페이지네이션 적용 (검색 필터링 후)
  const totalCount = searchQuery ? logRows.length : (count ?? 0);
  const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
  const paginatedLogs = logRows.slice(offset, offset + ITEMS_PER_PAGE);

  // 전체 통계를 위한 별도 쿼리 (필터 적용 전)
  const { count: totalStats } = await supabase
    .from("sms_logs")
    .select("*", { count: "exact", head: true });

  const { count: pendingStats } = await supabase
    .from("sms_logs")
    .select("*", { count: "exact", head: true })
    .eq("status", "pending");

  const { count: sentStats } = await supabase
    .from("sms_logs")
    .select("*", { count: "exact", head: true })
    .eq("status", "sent");

  const { count: deliveredStats } = await supabase
    .from("sms_logs")
    .select("*", { count: "exact", head: true })
    .eq("status", "delivered");

  const { count: failedStats } = await supabase
    .from("sms_logs")
    .select("*", { count: "exact", head: true })
    .eq("status", "failed");


  // 필터링된 통계
  const stats = {
    total: totalStats ?? 0,
    pending: pendingStats ?? 0,
    sent: sentStats ?? 0,
    delivered: deliveredStats ?? 0,
    failed: failedStats ?? 0,
  };

  return (
    <div className="flex flex-col gap-8 p-6 md:p-10">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold text-gray-900">SMS 발송 이력</h1>
        <Link
          href="/admin/sms/send"
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          SMS 발송하기
        </Link>
      </div>

      <SMSResultsClient
        initialLogs={paginatedLogs}
        studentMap={Object.fromEntries(studentMap)}
        stats={stats}
        searchQuery={searchQuery}
        statusFilter={statusFilter}
        currentPage={page}
        totalPages={totalPages}
        totalCount={totalCount}
      />
    </div>
  );
}
</file>

<file path="admin/sms/send/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import Link from "next/link";
import { SMSSendForm } from "../_components/SMSSendForm";

export default async function SMSSendPage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();

  // SMS 발송 폼용 학생 목록 조회 (모든 학생, 연락처 포함)
  // RLS 정책이 자동으로 tenant_id 필터링을 처리합니다
  let studentsSelectFields = "id, name, grade, class";

  // 학부모 연락처 컬럼 확인 (mother_phone, father_phone 사용)
  try {
    const testQuery = supabase.from("students").select("mother_phone, father_phone").limit(1);
    const { error: testError } = await testQuery;
    if (!testError) {
      studentsSelectFields += ",mother_phone,father_phone";
    }
  } catch (e) {
    // 컬럼이 없으면 무시
  }

  try {
    // is_active 컬럼이 있는지 테스트
    const testQuery = supabase.from("students").select("is_active").limit(1);
    const { error: testError } = await testQuery;
    if (!testError) {
      studentsSelectFields += ",is_active";
    }
  } catch (e) {
    // 컬럼이 없으면 무시
  }

  const { data: studentsForSMS, error: studentsError } = await supabase
    .from("students")
    .select(studentsSelectFields)
    .order("name", { ascending: true });

  // student_profiles 테이블에서 phone 정보 조회 (학생 본인 연락처)
  const studentIds = (studentsForSMS ?? []).map((s: any) => s.id);
  let profiles: Array<{
    id: string;
    phone?: string | null;
    mother_phone?: string | null;
    father_phone?: string | null;
  }> = [];

  if (studentIds.length > 0) {
    try {
      const { data: profilesData, error: profilesError } = await supabase
        .from("student_profiles")
        .select("id, phone, mother_phone, father_phone")
        .in("id", studentIds);

      if (!profilesError && profilesData) {
        profiles = profilesData;
      }
    } catch (e) {
      // student_profiles 테이블이 없으면 무시
    }
  }

  // 프로필 정보를 학생 정보와 병합 (student_profiles 우선, 없으면 students 테이블 사용)
  const studentsWithPhones = (studentsForSMS ?? []).map((s: any) => {
    const profile = profiles.find((p: any) => p.id === s.id);
    return {
      ...s,
      phone: profile?.phone ?? null, // student_profiles 우선
      mother_phone: profile?.mother_phone ?? s.mother_phone ?? null,
      father_phone: profile?.father_phone ?? s.father_phone ?? null,
    };
  });

  // 에러 처리 및 디버깅
  if (studentsError) {
    const errorInfo: Record<string, unknown> = {
      message:
        studentsError?.message ||
        studentsError?.toString() ||
        String(studentsError) ||
        "알 수 없는 에러",
      code: studentsError?.code || "UNKNOWN",
    };

    if (studentsError && typeof studentsError === "object") {
      if ("details" in studentsError) {
        errorInfo.details = (studentsError as { details?: unknown }).details;
      }
      if ("hint" in studentsError) {
        errorInfo.hint = (studentsError as { hint?: unknown }).hint;
      }
      if ("statusCode" in studentsError) {
        errorInfo.statusCode = (studentsError as { statusCode?: unknown }).statusCode;
      }
    }

    console.error("[admin/sms/send] 학생 목록 조회 실패:", errorInfo);
  }

  // 학원명 조회
  let academyName = "학원";
  if (tenantContext?.tenantId) {
    const { data: tenant } = await supabase
      .from("tenants")
      .select("name")
      .eq("id", tenantContext.tenantId)
      .single();
    if (tenant?.name) {
      academyName = tenant.name;
    }
  }

  return (
    <div className="flex flex-col gap-6 p-6 md:p-10">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold text-gray-900">SMS 발송</h1>
        <Link
          href="/admin/sms/results"
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
        >
          발송 이력 보기
        </Link>
      </div>

      {/* 학생 목록 조회 에러 안내 */}
      {studentsError && (
        <div className="flex flex-col gap-1 rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-sm font-medium text-red-800">
            학생 목록을 불러오는 중 오류가 발생했습니다.
          </p>
          <p className="text-xs text-red-700">
            에러 코드: {studentsError.code || "알 수 없음"}
          </p>
          <p className="text-xs text-red-600">
            {studentsError.message || "알 수 없는 오류"}
          </p>
          {studentsError.hint && (
            <p className="text-xs text-red-600">힌트: {studentsError.hint}</p>
          )}
        </div>
      )}

      {/* 학생이 없는 경우 안내 */}
      {!studentsError && (!studentsForSMS || studentsForSMS.length === 0) && (
        <div className="flex flex-col gap-1 rounded-lg border border-yellow-200 bg-yellow-50 p-4">
          <p className="text-sm font-medium text-yellow-800">
            등록된 학생이 없습니다.
          </p>
          <p className="text-xs text-yellow-700">
            학생 관리 페이지에서 학생을 등록한 후 SMS 발송을 이용할 수 있습니다.
          </p>
        </div>
      )}

      {/* SMS 발송 폼 */}
      <SMSSendForm
        students={studentsWithPhones.map((s: any) => ({
          id: s.id,
          name: s.name ?? null,
          grade: s.grade ?? null,
          class: s.class ?? null,
          phone: s.phone ?? null,
          mother_phone: s.mother_phone ?? null,
          father_phone: s.father_phone ?? null,
          is_active: s.is_active ?? null,
        }))}
        academyName={academyName}
      />
    </div>
  );
}
</file>

<file path="admin/sms/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import Link from "next/link";
import type { PostgrestError } from "@supabase/supabase-js";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { EmptyState } from "@/components/ui/EmptyState";
import { SMSSendForm } from "./_components/SMSSendForm";

type SMSLogRow = {
  id: string;
  tenant_id: string;
  recipient_id: string | null;
  recipient_phone: string | null;
  message_content: string | null;
  template_id: string | null;
  status: string | null;
  sent_at: string | null;
  delivered_at: string | null;
  error_message: string | null;
  created_at: string;
};

type StudentRow = {
  id: string;
  name?: string | null;
  grade?: string | null;
  class?: string | null;
  phone?: string | null;
  mother_phone?: string | null;
  father_phone?: string | null;
  is_active?: boolean | null;
};

type AdminSMSPageProps = {
  searchParams: Promise<Record<string, string | undefined>>;
};

export default async function AdminSMSPage({
  searchParams,
}: AdminSMSPageProps) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  // 발송 폼 페이지로 리다이렉트
  redirect("/admin/sms/send");

  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();
  const params = await searchParams;
  const searchQuery = params.search?.trim() ?? "";
  const statusFilter = params.status?.trim() ?? "";

  // SMS 로그 조회
  const selectLogs = () =>
    supabase
      .from("sms_logs")
      .select(
        "id,tenant_id,recipient_id,recipient_phone,message_content,template_id,status,sent_at,delivered_at,error_message,created_at"
      )
      .order("created_at", { ascending: false })
      .limit(100);

  let query = selectLogs();

  // 상태 필터링
  if (
    statusFilter &&
    ["pending", "sent", "delivered", "failed"].includes(statusFilter)
  ) {
    query = query.eq("status", statusFilter);
  }

  let { data: logs, error } = await query;

  if (error && error?.code === "42703") {
    ({ data: logs, error } = await selectLogs());
  }

  if (error) {
    // error는 이 블록에서 non-null이므로 타입 단언 사용
    const logsError = error as PostgrestError;
    // 에러 객체 전체를 먼저 로깅
    console.error("[admin/sms] SMS 로그 조회 실패 - 원본 에러:", logsError);
    console.error("[admin/sms] 에러 타입:", typeof logsError);
    console.error("[admin/sms] 에러 constructor:", logsError.constructor?.name);

    // Supabase 에러 객체의 주요 속성 추출
    const errorInfo: Record<string, unknown> = {
      message: logsError.message || logsError.toString() || String(logsError) || "알 수 없는 에러",
      code: logsError.code || "UNKNOWN",
      name: logsError.name,
    };

    // Supabase PostgrestError 속성 확인
    if (logsError.details) {
      errorInfo.details = logsError.details;
    }
    if (logsError.hint) {
      errorInfo.hint = logsError.hint;
    }

    console.error("[admin/sms] SMS 로그 조회 실패 - 상세 정보:", errorInfo);
  }

  // 테이블이 없는 경우 에러 메시지 표시 (에러가 있으면 먼저 처리)
  const errorCode = error?.code;
  const errorMessage = error?.message || "";
  if (
    error &&
    (errorCode === "PGRST205" ||
      errorCode === "42P01" ||
      errorMessage.includes("Could not find the table") ||
      errorMessage.includes("테이블"))
  ) {
    return (
      <div className="flex flex-col gap-8 p-6 md:p-10">
        <h1 className="text-3xl font-bold text-gray-900">SMS 발송 이력</h1>
        <div className="flex flex-col gap-2 rounded-xl border border-yellow-200 bg-yellow-50 p-8 text-center">
          <p className="text-sm font-medium text-yellow-800">
            SMS 로그 테이블이 아직 생성되지 않았습니다.
          </p>
          <p className="text-xs text-yellow-700">
            데이터베이스 마이그레이션을 실행해주세요.
          </p>
          <p className="text-xs text-yellow-600">
            sms_logs 테이블은 ERD 스키마에 정의되어 있습니다.
          </p>
          <p className="text-xs text-yellow-600">
            Supabase CLI:{" "}
            <code className="bg-yellow-100 px-1 rounded">
              supabase migration up
            </code>
          </p>
        </div>
      </div>
    );
  }

  const logRows = (logs as SMSLogRow[] | null) ?? [];

  // 학생 정보 조회
  const recipientIds = [
    ...new Set(logRows.map((l) => l.recipient_id).filter(Boolean)),
  ] as string[];
  const { data: students } = await supabase
    .from("students")
    .select("id,name")
    .in("id", recipientIds.length > 0 ? recipientIds : [""]);

  const studentMap = new Map(
    (students ?? []).map((s: StudentRow) => [s.id, s.name ?? "이름 없음"])
  );

  // SMS 발송 폼용 학생 목록 조회 (모든 학생, 연락처 포함)
  // RLS 정책이 자동으로 tenant_id 필터링을 처리합니다
  let studentsSelectFields = "id, name, grade, class";

  // 학부모 연락처 컬럼 확인 (mother_phone, father_phone 사용)
  try {
    const testQuery = supabase
      .from("students")
      .select("mother_phone, father_phone")
      .limit(1);
    const { error: testError } = await testQuery;
    if (!testError) {
      studentsSelectFields += ",mother_phone,father_phone";
    }
  } catch (e) {
    // 컬럼이 없으면 무시
  }

  try {
    // is_active 컬럼이 있는지 테스트
    const testQuery = supabase.from("students").select("is_active").limit(1);
    const { error: testError } = await testQuery;
    if (!testError) {
      studentsSelectFields += ",is_active";
    }
  } catch (e) {
    // 컬럼이 없으면 무시
  }

  const { data: studentsForSMSRaw, error: studentsError } = await supabase
    .from("students")
    .select(studentsSelectFields)
    .order("name", { ascending: true });

  // 타입 단언으로 StudentRow[]로 변환
  const studentsForSMS: StudentRow[] | null = studentsForSMSRaw as StudentRow[] | null;

  // student_profiles 테이블에서 phone 정보 조회 (학생 본인 연락처)
  type ProfileData = {
    id: string;
    phone?: string | null;
    mother_phone?: string | null;
    father_phone?: string | null;
  };
  const studentIdList = (studentsForSMS ?? []).map((s) => s.id);
  let profiles: ProfileData[] = [];

  if (studentIdList.length > 0) {
    try {
      const { data: profilesData, error: profilesError } = await supabase
        .from("student_profiles")
        .select("id, phone, mother_phone, father_phone")
        .in("id", studentIdList);

      if (!profilesError && profilesData) {
        profiles = profilesData as ProfileData[];
      }
    } catch {
      // student_profiles 테이블이 없으면 무시
    }
  }

  // 프로필 정보를 학생 정보와 병합 (student_profiles 우선, 없으면 students 테이블 사용)
  const studentsWithPhones = (studentsForSMS ?? []).map((s) => {
    const profile = profiles.find((p) => p.id === s.id);
    return {
      ...s,
      phone: profile?.phone ?? null, // student_profiles 우선
      mother_phone: profile?.mother_phone ?? s.mother_phone ?? null,
      father_phone: profile?.father_phone ?? s.father_phone ?? null,
    };
  });

  // 에러 처리 및 디버깅
  if (studentsError) {
    // studentsError는 이 블록에서 non-null이므로 타입 단언 사용
    const studentsFetchError = studentsError as PostgrestError;
    // 에러 객체의 속성을 안전하게 추출
    const errorInfo: Record<string, unknown> = {
      message: studentsFetchError.message || studentsFetchError.toString() || String(studentsFetchError) || "알 수 없는 에러",
      code: studentsFetchError.code || "UNKNOWN",
    };

    if (studentsFetchError.details) {
      errorInfo.details = studentsFetchError.details;
    }
    if (studentsFetchError.hint) {
      errorInfo.hint = studentsFetchError.hint;
    }

    console.error("[admin/sms] 학생 목록 조회 실패:", errorInfo);
  }

  // 디버깅: 학생 목록 조회 결과 확인
  if (process.env.NODE_ENV === "development") {
    const studentsWithAnyPhone = studentsWithPhones.filter(
      (s) => s.phone || s.mother_phone || s.father_phone
    );
    console.log("[admin/sms] 학생 목록 조회 결과:", {
      count: studentsWithPhones.length,
      withPhone: studentsWithAnyPhone.length,
      withoutPhone: studentsWithPhones.length - studentsWithAnyPhone.length,
      profilesCount: profiles.length,
      tenantId: tenantContext?.tenantId,
      hasError: !!studentsError,
      errorCode: studentsError?.code ?? null,
      sampleStudent: studentsWithPhones[0]
        ? {
            id: studentsWithPhones[0].id,
            name: studentsWithPhones[0].name,
            phone: studentsWithPhones[0].phone,
            mother_phone: studentsWithPhones[0].mother_phone,
            father_phone: studentsWithPhones[0].father_phone,
          }
        : null,
    });
  }

  // 학원명 조회
  let academyName = "학원";
  const currentTenantId = tenantContext?.tenantId;
  if (currentTenantId) {
    const { data: tenantData } = await supabase
      .from("tenants")
      .select("name")
      .eq("id", currentTenantId)
      .single();
    const tenantName = tenantData?.name;
    if (tenantName) {
      academyName = tenantName;
    }
  }

  // 검색 필터링 (학생 이름, 전화번호, 메시지 내용으로)
  let filteredLogs = logRows;
  if (searchQuery) {
    filteredLogs = logRows.filter((log) => {
      const studentName = (studentMap.get(log.recipient_id ?? "") ??
        "") as string;
      const phone = log.recipient_phone ?? "";
      const message = log.message_content ?? "";
      return (
        studentName.includes(searchQuery) ||
        phone.includes(searchQuery) ||
        message.includes(searchQuery)
      );
    });
  }

  // 상태별 통계
  const stats = {
    total: filteredLogs.length,
    pending: filteredLogs.filter((l) => l.status === "pending").length,
    sent: filteredLogs.filter((l) => l.status === "sent").length,
    delivered: filteredLogs.filter((l) => l.status === "delivered").length,
    failed: filteredLogs.filter((l) => l.status === "failed").length,
  };

  const getStatusBadgeClass = (status: string | null | undefined) => {
    switch (status) {
      case "sent":
      case "delivered":
        return "bg-green-100 text-green-800";
      case "pending":
        return "bg-yellow-100 text-yellow-800";
      case "failed":
        return "bg-red-100 text-red-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  const getStatusLabel = (status: string | null | undefined) => {
    switch (status) {
      case "sent":
        return "발송 완료";
      case "delivered":
        return "전달 완료";
      case "pending":
        return "대기 중";
      case "failed":
        return "실패";
      default:
        return "알 수 없음";
    }
  };

  return (
    <div className="flex flex-col gap-6 p-6 md:p-10">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold text-gray-900">SMS 발송 이력</h1>
      </div>

      {/* 학생 목록 조회 에러 안내 */}
      {studentsError && (
        <div className="flex flex-col gap-1 rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-sm font-medium text-red-800">
            학생 목록을 불러오는 중 오류가 발생했습니다.
          </p>
          <p className="text-xs text-red-700">
            에러 코드: {studentsError?.code ?? "알 수 없음"}
          </p>
          <p className="text-xs text-red-600">
            {studentsError?.message ?? "알 수 없는 오류"}
          </p>
          {studentsError?.hint && (
            <p className="text-xs text-red-600">
              힌트: {studentsError?.hint}
            </p>
          )}
        </div>
      )}

      {/* 학생이 없는 경우 안내 */}
      {!studentsError && (!studentsForSMS?.length) && (
        <div className="flex flex-col gap-1 rounded-lg border border-yellow-200 bg-yellow-50 p-4">
          <p className="text-sm font-medium text-yellow-800">
            등록된 학생이 없습니다.
          </p>
          <p className="text-xs text-yellow-700">
            학생 관리 페이지에서 학생을 등록한 후 SMS 발송을 이용할 수 있습니다.
          </p>
        </div>
      )}

      {/* SMS 발송 폼 - 항상 표시 */}
      <SMSSendForm
        students={studentsWithPhones.map((s) => ({
          id: s.id,
          name: s.name ?? null,
          grade: s.grade ?? null,
          class: s.class ?? null,
          phone: s.phone ?? null,
          mother_phone: s.mother_phone ?? null,
          father_phone: s.father_phone ?? null,
          is_active: s.is_active ?? null,
        }))}
        academyName={academyName}
      />

      {/* 통계 */}
      <div className="grid grid-cols-2 gap-4 md:grid-cols-5">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">전체</div>
          <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">대기 중</div>
          <div className="text-2xl font-bold text-yellow-600">
            {stats.pending}
          </div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">발송 완료</div>
          <div className="text-2xl font-bold text-green-600">{stats.sent}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">전달 완료</div>
          <div className="text-2xl font-bold text-blue-600">
            {stats.delivered}
          </div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">실패</div>
          <div className="text-2xl font-bold text-red-600">{stats.failed}</div>
        </div>
      </div>

      {/* 필터 및 검색 */}
      <div className="flex flex-col gap-4 md:flex-row">
        <form method="get" className="flex flex-1 gap-2">
          <input
            type="text"
            name="search"
            placeholder="학생 이름, 전화번호, 메시지 내용으로 검색..."
            defaultValue={searchQuery}
            className="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          />
          <select
            name="status"
            defaultValue={statusFilter}
            className="rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          >
            <option value="">전체 상태</option>
            <option value="pending">대기 중</option>
            <option value="sent">발송 완료</option>
            <option value="delivered">전달 완료</option>
            <option value="failed">실패</option>
          </select>
          <button
            type="submit"
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            검색
          </button>
          {(searchQuery || statusFilter) && (
            <Link
              href="/admin/sms"
              className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </Link>
          )}
        </form>
      </div>

      {/* SMS 로그 목록 */}
      {filteredLogs.length === 0 ? (
        <EmptyState
          title="SMS 발송 이력이 없습니다"
          description="아직 발송된 SMS가 없습니다."
        />
      ) : (
        <div className="space-y-4">
          {filteredLogs.map((log) => {
            const studentName = studentMap.get(log.recipient_id ?? "") ?? "-";
            return (
              <div
                key={log.id}
                className="flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-6 shadow-sm"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    {log.recipient_id && (
                      <Link
                        href={`/admin/students/${log.recipient_id}`}
                        className="font-semibold text-indigo-600 hover:text-indigo-800"
                      >
                        {studentName}
                      </Link>
                    )}
                    {!log.recipient_id && (
                      <span className="font-semibold text-gray-900">-</span>
                    )}
                    <span className="text-sm text-gray-500">
                      {log.recipient_phone ?? "-"}
                    </span>
                    <span
                      className={`rounded-full px-2 py-1 text-xs font-medium ${getStatusBadgeClass(
                        log.status
                      )}`}
                    >
                      {getStatusLabel(log.status)}
                    </span>
                  </div>
                  <span className="text-xs text-gray-500">
                    {log.created_at
                      ? new Date(log.created_at).toLocaleString("ko-KR")
                      : "-"}
                  </span>
                </div>
                <p className="text-sm text-gray-700">
                  {log.message_content ?? "-"}
                </p>
                {log.sent_at && (
                  <div className="text-xs text-gray-500">
                    발송 시간: {new Date(log.sent_at).toLocaleString("ko-KR")}
                  </div>
                )}
                {log.delivered_at && (
                  <div className="text-xs text-gray-500">
                    전달 시간:{" "}
                    {new Date(log.delivered_at).toLocaleString("ko-KR")}
                  </div>
                )}
                {log.error_message && (
                  <div className="text-xs text-red-600">
                    오류: {log.error_message}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/students/_components/StudentActions.tsx">
"use client";

import { useState, useTransition } from "react";
import { toggleStudentStatus, deleteStudent } from "@/app/(admin)/actions/studentManagementActions";
import { useRouter } from "next/navigation";

type StudentActionsProps = {
  studentId: string;
  studentName: string;
  isActive: boolean;
  isAdmin: boolean;
};

export function StudentActions({
  studentId,
  studentName,
  isActive,
  isAdmin,
}: StudentActionsProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

  const handleToggleStatus = () => {
    if (!confirm(`${studentName} 학생을 ${isActive ? "비활성화" : "활성화"}하시겠습니까?`)) {
      return;
    }

    startTransition(async () => {
      const result = await toggleStudentStatus(studentId, !isActive);
      if (result.success) {
        router.refresh();
      } else {
        alert(result.error || "상태 변경에 실패했습니다.");
      }
    });
  };

  const handleDelete = () => {
    if (!confirm(`정말 ${studentName} 학생을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 학생의 모든 데이터가 삭제됩니다.`)) {
      return;
    }

    startTransition(async () => {
      const result = await deleteStudent(studentId);
      if (result.success) {
        router.push("/admin/students");
      } else {
        alert(result.error || "학생 삭제에 실패했습니다.");
      }
    });
  };

  return (
    <div className="flex items-center gap-2">
      <button
        onClick={handleToggleStatus}
        disabled={isPending}
        className={`rounded-lg px-3 py-1.5 text-xs font-semibold transition ${
          isActive
            ? "bg-yellow-100 text-yellow-800 hover:bg-yellow-200"
            : "bg-green-100 text-green-800 hover:bg-green-200"
        } disabled:opacity-50`}
      >
        {isActive ? "비활성화" : "활성화"}
      </button>
      {isAdmin && (
        <button
          onClick={handleDelete}
          disabled={isPending}
          className="rounded-lg bg-red-100 px-3 py-1.5 text-xs font-semibold text-red-800 transition hover:bg-red-200 disabled:opacity-50"
        >
          삭제
        </button>
      )}
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/AnalysisReportSection.tsx">
import { getStudentAnalysisForAdmin } from "@/lib/data/admin/studentData";

export async function AnalysisReportSection({
  studentId,
}: {
  studentId: string;
}) {
  try {
    const analysis = await getStudentAnalysisForAdmin(studentId);

    return (
      <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="text-xl font-semibold text-gray-900">
          분석 리포트
        </h2>

        {/* 주간 요약 */}
        {analysis.weeklyPlanSummary && (
          <div className="flex flex-col gap-2 rounded-lg bg-indigo-50 p-4">
            <h3 className="text-sm font-medium text-indigo-700">
              이번 주 플랜 실행률
            </h3>
            <div className="text-3xl font-bold text-indigo-700">
              {analysis.weeklyPlanSummary.completionRate}%
            </div>
            <div className="text-xs text-indigo-600">
              완료: {analysis.weeklyPlanSummary.completedPlans} /{" "}
              {analysis.weeklyPlanSummary.totalPlans}
            </div>
          </div>
        )}

        {/* 주간 학습시간 */}
        {analysis.weeklyStudyTime && (
          <div className="flex flex-col gap-2 rounded-lg bg-purple-50 p-4">
            <h3 className="text-sm font-medium text-purple-700">
              이번 주 학습시간
            </h3>
            <div className="text-3xl font-bold text-purple-700">
              {analysis.weeklyStudyTime.totalHours}시간{" "}
              {analysis.weeklyStudyTime.totalMinutes % 60}분
            </div>
          </div>
        )}

        {/* 월간 리포트 */}
        {analysis.monthlyReport && (
          <div className="flex flex-col gap-2 rounded-lg bg-emerald-50 p-4">
            <h3 className="text-sm font-medium text-emerald-700">
              이번 달 요약
            </h3>
            <div className="grid grid-cols-3 gap-4">
              <div className="flex flex-col gap-1">
                <div className="text-xs text-emerald-600">총 학습시간</div>
                <div className="text-lg font-bold text-emerald-700">
                  {Math.floor(analysis.monthlyReport.totals.studyMinutes / 60)}
                  시간
                </div>
              </div>
              <div className="flex flex-col gap-1">
                <div className="text-xs text-emerald-600">플랜 실행률</div>
                <div className="text-lg font-bold text-emerald-700">
                  {analysis.monthlyReport.totals.completionRate}%
                </div>
              </div>
              <div className="flex flex-col gap-1">
                <div className="text-xs text-emerald-600">목표 달성률</div>
                <div className="text-lg font-bold text-emerald-700">
                  {analysis.monthlyReport.totals.goalRate}%
                </div>
              </div>
            </div>
          </div>
        )}

        {/* 위험 분석 */}
        {analysis.riskAnalysis.length > 0 && (
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-medium text-gray-700">
              과목별 위험 분석
            </h3>
            <div className="space-y-2">
              {analysis.riskAnalysis
                .slice(0, 5)
                .map((risk: any, index: number) => {
                  const riskLevel =
                    risk.risk_score >= 70
                      ? "high"
                      : risk.risk_score >= 40
                      ? "medium"
                      : "low";
                  const riskColors = {
                    high: "bg-red-100 text-red-800 border-red-200",
                    medium: "bg-yellow-100 text-yellow-800 border-yellow-200",
                    low: "bg-green-100 text-green-800 border-green-200",
                  };
                  const riskLabels = {
                    high: "높음",
                    medium: "보통",
                    low: "낮음",
                  };

                  return (
                    <div
                      key={index}
                      className={`flex flex-col gap-2 rounded-lg border p-3 ${riskColors[riskLevel]}`}
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-medium">
                          {risk.subject ?? "미분류"}
                        </span>
                        <span className="text-xs font-semibold">
                          {riskLabels[riskLevel]} ({risk.risk_score}점)
                        </span>
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-xs">
                        <div>
                          <div className="text-gray-600">최근 성적 추이</div>
                          <div className="font-semibold">
                            {risk.recent_grade_trend ?? 0}
                          </div>
                        </div>
                        <div>
                          <div className="text-gray-600">일관성 점수</div>
                          <div className="font-semibold">
                            {risk.consistency_score ?? 100}
                          </div>
                        </div>
                        <div>
                          <div className="text-gray-600">숙련도 추정</div>
                          <div className="font-semibold">
                            {risk.mastery_estimate ?? 0}%
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
            </div>
          </div>
        )}

        {!analysis.weeklyPlanSummary &&
          !analysis.weeklyStudyTime &&
          !analysis.monthlyReport &&
          analysis.riskAnalysis.length === 0 && (
            <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
              <p className="text-sm font-medium text-gray-700">
                분석 데이터가 없습니다.
              </p>
              <p className="text-xs text-gray-500">
                학습 활동 데이터가 쌓이면 분석 리포트가 생성됩니다.
              </p>
            </div>
          )}
      </div>
    );
  } catch (error) {
    console.error("[AnalysisReportSection] 분석 리포트 조회 실패", error);
    const errorMessage =
      error instanceof Error
        ? error.message
        : "알 수 없는 오류가 발생했습니다.";
    return (
      <div className="rounded-lg border border-dashed border-red-300 bg-red-50 p-6">
        <p className="text-sm font-medium text-red-700">
          분석 리포트를 불러오는 중 오류가 발생했습니다.
        </p>
        <p className="text-xs text-red-600">{errorMessage}</p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/AnalysisReportSectionSkeleton.tsx">
export function AnalysisReportSectionSkeleton() {
  return (
    <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="h-7 w-32 animate-pulse rounded bg-gray-200"></div>
      <div className="flex flex-col gap-6">
        {Array.from({ length: 3 }).map((_, i) => (
          <div key={i} className="flex flex-col gap-2 rounded-lg bg-gray-50 p-4">
            <div className="h-4 w-32 animate-pulse rounded bg-gray-200"></div>
            <div className="h-8 w-24 animate-pulse rounded bg-gray-200"></div>
            <div className="h-3 w-40 animate-pulse rounded bg-gray-200"></div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/AttendanceSection.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import {
  getAttendanceByStudent,
  calculateAttendanceStats,
} from "@/lib/domains/attendance/service";
import { AttendanceRecordForm } from "@/app/(admin)/admin/attendance/_components/AttendanceRecordForm";
import { AttendanceList } from "@/app/(admin)/admin/attendance/_components/AttendanceList";
import { AttendanceStatistics } from "@/app/(admin)/admin/attendance/_components/AttendanceStatistics";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export async function AttendanceSection({
  studentId,
  studentName,
}: {
  studentId: string;
  studentName: string | null;
}) {
  const supabase = await createSupabaseServerClient();

  // 이번 달 날짜 범위
  const today = new Date();
  const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
  const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

  const startDate = monthStart.toISOString().slice(0, 10);
  const endDate = monthEnd.toISOString().slice(0, 10);

  // 출석 기록 조회
  const records = await getAttendanceByStudent(studentId, startDate, endDate);

  // 출석 통계 계산
  const stats = await calculateAttendanceStats(studentId, startDate, endDate);

  // 학생 정보 (맵 생성용)
  const studentMap = new Map([[studentId, studentName ?? "이름 없음"]]);

  return (
    <div className="space-y-6">
      {/* 출석 통계 */}
      <Card>
        <CardHeader title="이번 달 출석 통계" />
        <CardContent>
          <AttendanceStatistics statistics={stats} />
        </CardContent>
      </Card>

      {/* 출석 기록 입력 폼 */}
      <Card>
        <CardHeader title="출석 기록 입력" />
        <CardContent>
          <AttendanceRecordForm
            studentId={studentId}
            studentName={studentName ?? ""}
          />
        </CardContent>
      </Card>

      {/* 출석 기록 목록 */}
      <Card>
        <CardHeader title="출석 기록" />
        <CardContent>
          {records.length === 0 ? (
            <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
              <p className="text-sm font-medium text-gray-700">
                출석 기록이 없습니다.
              </p>
              <p className="text-xs text-gray-500">
                위 폼에서 출석 기록을 입력하면 여기에 표시됩니다.
              </p>
            </div>
          ) : (
            <AttendanceList records={records} studentMap={studentMap} />
          )}
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/BasicInfoSection.tsx">
"use client";

import { useState, useTransition, useEffect, useRef } from "react";
import { StudentActions } from "../../_components/StudentActions";
import { updateStudentClass } from "@/app/(admin)/actions/studentManagementActions";
import { useRouter } from "next/navigation";
import { useToast } from "@/components/ui/ToastProvider";
import { Pencil } from "lucide-react";

type Student = {
  id: string;
  name?: string | null;
  grade?: string | null;
  class?: string | null;
  birth_date?: string | null;
  is_active?: boolean | null;
};

type BasicInfoSectionProps = {
  student: Student;
  isAdmin: boolean;
};

export function BasicInfoSection({
  student: initialStudent,
  isAdmin,
}: BasicInfoSectionProps) {
  const router = useRouter();
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [editingClass, setEditingClass] = useState(false);
  const [classValue, setClassValue] = useState(initialStudent.class || "");
  const [student, setStudent] = useState(initialStudent);
  const inputRef = useRef<HTMLInputElement>(null);

  // 학생 정보가 업데이트되면 로컬 상태도 업데이트
  useEffect(() => {
    setStudent(initialStudent);
    if (!editingClass) {
      setClassValue(initialStudent.class || "");
    }
  }, [initialStudent.id, initialStudent.class, editingClass]);

  // 편집 모드 진입 시 자동 포커스
  useEffect(() => {
    if (editingClass && inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, [editingClass]);

  async function handleUpdateClass() {
    // 값이 변경되지 않았으면 저장하지 않음
    if (classValue === (student.class || "")) {
      setEditingClass(false);
      return;
    }

    startTransition(async () => {
      const result = await updateStudentClass(student.id, classValue || null);

      if (result.success) {
        setEditingClass(false);
        showSuccess("반 정보가 변경되었습니다.");
        // 서버 상태 새로고침
        router.refresh();
      } else {
        showError(result.error || "반 정보 변경에 실패했습니다.");
      }
    });
  }

  function handleCancelEdit() {
    setEditingClass(false);
    setClassValue(student.class || "");
  }

  function handleStartEdit() {
    if (!isAdmin) return;
    setEditingClass(true);
  }

  function handleKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      if (!isPending) {
        handleUpdateClass();
      }
    }
    if (e.key === "Escape") {
      e.preventDefault();
      if (!isPending) {
        handleCancelEdit();
      }
    }
  }

  // 값이 변경되었는지 확인
  const hasChanges = classValue !== (student.class || "");

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-semibold text-gray-900">기본 정보</h2>
        <StudentActions
          studentId={student.id}
          studentName={student.name ?? "이름 없음"}
          isActive={student.is_active !== false}
          isAdmin={isAdmin}
        />
      </div>
      <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div className="flex flex-col gap-1">
          <div className="text-sm text-gray-500">이름</div>
          <div className="text-lg font-medium text-gray-900">
            {student.name ?? "-"}
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-sm text-gray-500">학년</div>
          <div className="text-lg font-medium text-gray-900">
            {student.grade ?? "-"}
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="flex items-center justify-between">
            <div className="text-sm text-gray-500">반</div>
            {isAdmin && !editingClass && (
              <button
                onClick={handleStartEdit}
                className="flex items-center gap-1 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-medium text-gray-700 transition hover:bg-gray-50"
                title="반 정보 수정"
              >
                <Pencil className="h-3 w-3" />
                수정
              </button>
            )}
          </div>
          {editingClass ? (
            <div className="flex flex-wrap items-center gap-2">
              <input
                ref={inputRef}
                type="text"
                value={classValue}
                onChange={(e) => setClassValue(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="반 번호"
                disabled={isPending}
                className="w-24 rounded-lg border border-indigo-300 bg-indigo-50 px-3 py-1.5 text-lg font-medium text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200 disabled:bg-gray-100 disabled:border-gray-300"
              />
              <div className="flex items-center gap-2">
                <button
                  onClick={handleUpdateClass}
                  disabled={isPending || !hasChanges}
                  className="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed"
                >
                  {isPending ? "저장 중..." : "저장"}
                </button>
                <button
                  onClick={handleCancelEdit}
                  disabled={isPending}
                  className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  취소
                </button>
              </div>
              <div className="text-xs text-gray-500">
                Enter: 저장, Esc: 취소
              </div>
            </div>
          ) : (
            <div className="text-lg font-medium text-gray-900">
              {student.class ?? "-"}
            </div>
          )}
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-sm text-gray-500">생년월일</div>
          <div className="text-lg font-medium text-gray-900">
            {student.birth_date
              ? new Date(student.birth_date).toLocaleDateString("ko-KR")
              : "-"}
          </div>
        </div>
        <div className="flex flex-col gap-1">
          <div className="text-sm text-gray-500">계정 상태</div>
          <div>
            {student.is_active === false ? (
              <span className="inline-flex rounded-full bg-red-100 px-3 py-1 text-sm font-semibold text-red-800">
                비활성화
              </span>
            ) : (
              <span className="inline-flex rounded-full bg-green-100 px-3 py-1 text-sm font-semibold text-green-800">
                활성
              </span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ConsultingNoteDeleteButton.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { deleteConsultingNote } from "@/app/(admin)/actions/consultingNoteActions";

export function ConsultingNoteDeleteButton({
  noteId,
  studentId,
}: {
  noteId: string;
  studentId: string;
}) {
  const router = useRouter();
  const [isDeleting, setIsDeleting] = useState(false);
  const [showConfirm, setShowConfirm] = useState(false);

  const handleDelete = async () => {
    if (!showConfirm) {
      setShowConfirm(true);
      return;
    }

    setIsDeleting(true);
    try {
      const result = await deleteConsultingNote(noteId, studentId);
      if (result.success) {
        router.refresh();
      } else {
        alert(result.error || "삭제에 실패했습니다.");
        setIsDeleting(false);
        setShowConfirm(false);
      }
    } catch (error) {
      console.error("[ConsultingNoteDeleteButton] 삭제 실패", error);
      alert("삭제 중 오류가 발생했습니다.");
      setIsDeleting(false);
      setShowConfirm(false);
    }
  };

  if (showConfirm) {
    return (
      <div className="flex items-center gap-2">
        <button
          onClick={() => setShowConfirm(false)}
          disabled={isDeleting}
          className="rounded px-2 py-1 text-xs text-gray-600 hover:bg-gray-200 disabled:opacity-50"
        >
          취소
        </button>
        <button
          onClick={handleDelete}
          disabled={isDeleting}
          className="rounded bg-red-600 px-2 py-1 text-xs text-white hover:bg-red-700 disabled:opacity-50"
        >
          {isDeleting ? "삭제 중..." : "삭제"}
        </button>
      </div>
    );
  }

  return (
    <button
      onClick={handleDelete}
      disabled={isDeleting}
      className="rounded px-2 py-1 text-xs text-gray-500 hover:bg-gray-200 hover:text-red-600 disabled:opacity-50"
      title="삭제"
    >
      🗑️
    </button>
  );
}
</file>

<file path="admin/students/[id]/_components/ConsultingNotesForm.tsx">
"use client";

import { useActionState } from "react";
import { addConsultingNote } from "@/app/actions/consultingNotes";

type FormState = {
  success?: boolean;
  error?: string;
} | null;

export function ConsultingNotesForm({
  studentId,
  consultantId,
}: {
  studentId: string;
  consultantId: string;
}) {
  const [state, formAction] = useActionState<FormState, FormData>(
    async (prevState: FormState, formData: FormData) => {
      return await addConsultingNote(studentId, consultantId, formData);
    },
    null
  );

  return (
    <form action={formAction} className="space-y-3">
      <textarea
        name="note"
        placeholder="상담 내용을 입력하세요..."
        required
        rows={4}
        className="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
      />
      {state?.error && (
        <div className="text-sm text-red-600">{state.error}</div>
      )}
      {state?.success && (
        <div className="text-sm text-green-600">상담노트가 저장되었습니다.</div>
      )}
      <button
        type="submit"
        className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
      >
        저장
      </button>
    </form>
  );
}
</file>

<file path="admin/students/[id]/_components/ConsultingNotesSection.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ConsultingNotesForm } from "./ConsultingNotesForm";
import { ConsultingNoteDeleteButton } from "./ConsultingNoteDeleteButton";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

type ConsultingNoteRow = {
  id: string;
  note?: string | null;
  created_at?: string | null;
  consultant_id?: string | null;
};

export async function ConsultingNotesSection({
  studentId,
  consultantId,
}: {
  studentId: string;
  consultantId: string;
}) {
  const supabase = await createSupabaseServerClient();

  try {
    const selectNotes = () =>
      supabase
        .from("student_consulting_notes")
        .select("id,note,created_at,consultant_id")
        .eq("student_id", studentId)
        .order("created_at", { ascending: false })
        .limit(10);

    let { data: notes, error } = await selectNotes();

    // 컬럼이 없으면 재시도 (하위 호환성)
    if (error && error.code === "42703") {
      console.warn(
        "[ConsultingNotesSection] 컬럼 오류, 재시도:",
        error.message
      );
      ({ data: notes, error } = await selectNotes());
    }

    if (error) {
      console.error("[ConsultingNotesSection] 상담노트 조회 실패", {
        error,
        errorCode: error.code,
        errorMessage: error.message,
        errorDetails: error.details,
        errorHint: error.hint,
        studentId,
      });
    }

    const noteRows = (notes as ConsultingNoteRow[] | null) ?? [];

    // 디버깅 로그
    console.log("[ConsultingNotesSection] 상담노트 조회 결과", {
      studentId,
      notesCount: noteRows.length,
      hasError: !!error,
      errorCode: error?.code,
      errorMessage: error?.message,
    });

    return (
      <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="text-xl font-semibold text-gray-900">상담노트</h2>

        {/* 상담노트 작성 폼 */}
        <div>
          <ConsultingNotesForm
            studentId={studentId}
            consultantId={consultantId}
          />
        </div>

        {/* 에러 메시지 */}
        {error && (
          <div className="flex flex-col gap-1 rounded-lg border border-red-300 bg-red-50 p-4">
            <p className="text-sm font-medium text-red-700">
              상담노트를 불러오는 중 오류가 발생했습니다.
            </p>
            <p className="text-xs text-red-600">
              {error.message || `에러 코드: ${error.code || "알 수 없음"}`}
            </p>
            {error.code === "42P01" && (
              <p className="text-xs text-red-600">
                테이블이 존재하지 않습니다. 데이터베이스 마이그레이션이 필요할
                수 있습니다.
              </p>
            )}
          </div>
        )}

        {/* 상담노트 목록 */}
        {!error && noteRows.length === 0 ? (
          <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
            <p className="text-sm font-medium text-gray-700">
              상담노트가 없습니다.
            </p>
            <p className="text-xs text-gray-500">
              위 폼에서 상담 내용을 작성하면 여기에 표시됩니다.
            </p>
          </div>
        ) : !error ? (
          <div className="flex flex-col gap-3">
            {noteRows.map((note) => (
              <div
                key={note.id}
                className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-4 transition hover:bg-gray-100"
              >
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-500">
                    {note.created_at
                      ? new Date(note.created_at).toLocaleString("ko-KR")
                      : "-"}
                  </span>
                  <ConsultingNoteDeleteButton
                    noteId={note.id}
                    studentId={studentId}
                  />
                </div>
                <p className="whitespace-pre-wrap text-sm text-gray-900">
                  {note.note ?? ""}
                </p>
              </div>
            ))}
          </div>
        ) : null}
      </div>
    );
  } catch (error) {
    console.error("[ConsultingNotesSection] 예상치 못한 오류", error);
    const errorMessage =
      error instanceof Error
        ? error.message
        : "알 수 없는 오류가 발생했습니다.";
    return (
      <div className="flex flex-col gap-6 rounded-lg border border-red-300 bg-red-50 p-6">
        <h2 className="text-xl font-semibold text-gray-900">상담노트</h2>
        <div>
          <ConsultingNotesForm
            studentId={studentId}
            consultantId={consultantId}
          />
        </div>
        <div className="flex flex-col gap-1 rounded-lg border border-red-300 bg-red-50 p-4">
          <p className="text-sm font-medium text-red-700">
            상담노트를 불러오는 중 예상치 못한 오류가 발생했습니다.
          </p>
          <p className="text-xs text-red-600">{errorMessage}</p>
        </div>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/ConsultingNotesSectionSkeleton.tsx">
import { CardSkeleton } from "@/components/ui/LoadingSkeleton";

export function ConsultingNotesSectionSkeleton() {
  return (
    <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="h-7 w-32 animate-pulse rounded bg-gray-200"></div>
      <div>
        <div className="h-24 w-full animate-pulse rounded-lg bg-gray-100"></div>
      </div>
      <div className="space-y-3">
        {Array.from({ length: 2 }).map((_, i) => (
          <CardSkeleton key={i} />
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ContentListSection.tsx">
import {
  getBooks,
  getLectures,
  getCustomContents,
} from "@/lib/data/studentContents";

export async function ContentListSection({ studentId }: { studentId: string }) {
  try {
    const [booksResult, lecturesResult, customResult] =
      await Promise.allSettled([
        getBooks(studentId, null),
        getLectures(studentId, null),
        getCustomContents(studentId, null),
      ]);

    const books = booksResult.status === "fulfilled" ? booksResult.value : [];
    const lectures =
      lecturesResult.status === "fulfilled" ? lecturesResult.value : [];
    const customContents =
      customResult.status === "fulfilled" ? customResult.value : [];

    const totalCount = books.length + lectures.length + customContents.length;
    const hasErrors =
      booksResult.status === "rejected" ||
      lecturesResult.status === "rejected" ||
      customResult.status === "rejected";

    return (
      <div className="space-y-6">
        {hasErrors && (
          <div className="rounded-lg border border-yellow-300 bg-yellow-50 p-4">
            <p className="text-sm font-medium text-yellow-700">
              일부 콘텐츠 정보를 불러오는 중 오류가 발생했습니다.
            </p>
            {booksResult.status === "rejected" && (
              <p className="text-xs text-yellow-600">
                책 정보:{" "}
                {booksResult.reason instanceof Error
                  ? booksResult.reason.message
                  : "조회 실패"}
              </p>
            )}
            {lecturesResult.status === "rejected" && (
              <p className="text-xs text-yellow-600">
                강의 정보:{" "}
                {lecturesResult.reason instanceof Error
                  ? lecturesResult.reason.message
                  : "조회 실패"}
              </p>
            )}
            {customResult.status === "rejected" && (
              <p className="text-xs text-yellow-600">
                커스텀 콘텐츠 정보:{" "}
                {customResult.reason instanceof Error
                  ? customResult.reason.message
                  : "조회 실패"}
              </p>
            )}
          </div>
        )}

        {totalCount === 0 && !hasErrors ? (
          <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
            <p className="text-sm font-medium text-gray-700">
              등록된 콘텐츠가 없습니다.
            </p>
            <p className="text-xs text-gray-500">
              학생이 콘텐츠를 등록하면 여기에 표시됩니다.
            </p>
          </div>
        ) : (
          <>
            {/* 책 */}
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
              <h3 className="text-lg font-semibold text-gray-900">
                📚 책 ({books.length}개)
              </h3>
              {books.length === 0 ? (
                <p className="text-sm text-gray-500">등록된 책이 없습니다.</p>
              ) : (
                <div className="space-y-2">
                  {books.slice(0, 10).map((book) => (
                    <div
                      key={book.id}
                      className="rounded-lg border border-gray-200 p-4 transition hover:bg-gray-50"
                    >
                      <div className="font-medium text-gray-900">
                        {book.title}
                      </div>
                      <div className="flex items-center gap-2 text-xs text-gray-500">
                        {book.subject && <span>과목: {book.subject}</span>}
                        {book.total_pages && (
                          <>
                            <span>·</span>
                            <span>총 {book.total_pages}페이지</span>
                          </>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* 강의 */}
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
              <h3 className="text-lg font-semibold text-gray-900">
                🎧 강의 ({lectures.length}개)
              </h3>
              {lectures.length === 0 ? (
                <p className="text-sm text-gray-500">등록된 강의가 없습니다.</p>
              ) : (
                <div className="space-y-2">
                  {lectures.slice(0, 10).map((lecture) => (
                    <div
                      key={lecture.id}
                      className="rounded-lg border border-gray-200 p-4 transition hover:bg-gray-50"
                    >
                      <div className="font-medium text-gray-900">
                        {lecture.title}
                      </div>
                      <div className="flex items-center gap-2 text-xs text-gray-500">
                        {lecture.subject && (
                          <span>과목: {lecture.subject}</span>
                        )}
                        {lecture.duration && (
                          <>
                            <span>·</span>
                            <span>
                              총 {Math.round(lecture.duration / 60)}분
                            </span>
                          </>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* 커스텀 콘텐츠 */}
            <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
              <h3 className="text-lg font-semibold text-gray-900">
                📝 커스텀 콘텐츠 ({customContents.length}개)
              </h3>
              {customContents.length === 0 ? (
                <p className="text-sm text-gray-500">
                  등록된 커스텀 콘텐츠가 없습니다.
                </p>
              ) : (
                <div className="space-y-2">
                  {customContents.slice(0, 10).map((content) => (
                    <div
                      key={content.id}
                      className="rounded-lg border border-gray-200 p-4 transition hover:bg-gray-50"
                    >
                      <div className="flex flex-col gap-1">
                        <div className="font-medium text-gray-900">
                          {content.title}
                        </div>
                        <div className="flex items-center gap-2 text-xs text-gray-500">
                          {content.subject && (
                            <span>과목: {content.subject}</span>
                          )}
                          {content.total_page_or_time && (
                            <>
                              <span>·</span>
                              <span>총 {content.total_page_or_time}</span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </>
        )}
      </div>
    );
  } catch (error) {
    console.error("[ContentListSection] 콘텐츠 조회 실패", error);
    const errorMessage =
      error instanceof Error
        ? error.message
        : "알 수 없는 오류가 발생했습니다.";
    return (
      <div className="rounded-lg border border-dashed border-red-300 bg-red-50 p-6">
        <p className="text-sm font-medium text-red-700">
          콘텐츠 정보를 불러오는 중 오류가 발생했습니다.
        </p>
        <p className="text-xs text-red-600">{errorMessage}</p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/ContentListSectionSkeleton.tsx">
import { CardSkeleton } from "@/components/ui/LoadingSkeleton";

export function ContentListSectionSkeleton() {
  return (
    <div className="space-y-6">
      {Array.from({ length: 3 }).map((_, i) => (
        <CardSkeleton key={i} />
      ))}
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ContentProgressSection.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ProgressBar } from "@/components/atoms/ProgressBar";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

type ProgressRow = {
  content_type?: string | null;
  content_id?: string | null;
  progress?: number | null;
};

export async function ContentProgressSection({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();

  // 진행률 조회
  const selectProgress = () =>
    supabase
      .from("student_content_progress")
      .select("content_type,content_id,progress")
      .order("progress", { ascending: false })
      .limit(10);

  let { data: progressData, error } = await selectProgress().eq("student_id", studentId);

  if (error && error.code === "42703") {
    ({ data: progressData, error } = await selectProgress());
  }

  const progressRows = (progressData as ProgressRow[] | null) ?? [];

  // 콘텐츠 정보 조회
  const contentMap = new Map<string, { title: string; subject: string | null }>();

  for (const progress of progressRows) {
    if (!progress.content_type || !progress.content_id) continue;
    const key = `${progress.content_type}:${progress.content_id}`;

    try {
      const tableName =
        progress.content_type === "book"
          ? "books"
          : progress.content_type === "lecture"
          ? "lectures"
          : "student_custom_contents";

      const { data: content } = await supabase
        .from(tableName)
        .select("title,subject")
        .eq("id", progress.content_id)
        .eq("student_id", studentId)
        .maybeSingle();

      if (content) {
        contentMap.set(key, {
          title: (content as { title?: string | null }).title ?? "제목 없음",
          subject: (content as { subject?: string | null }).subject ?? null,
        });
      }
    } catch (error) {
      console.error(`[admin/students] 콘텐츠 정보 조회 실패 (${key})`, error);
    }
  }

  const contentTypeLabels: Record<string, string> = {
    book: "책",
    lecture: "강의",
    custom: "커스텀",
  };

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <h2 className="text-xl font-semibold text-gray-900">콘텐츠 진행 요약</h2>
      {progressRows.length === 0 ? (
        <p className="text-sm text-gray-500">진행 중인 콘텐츠가 없습니다.</p>
      ) : (
        <div className="flex flex-col gap-3">
          {progressRows.map((progress, index) => {
            if (!progress.content_type || !progress.content_id) return null;
            const key = `${progress.content_type}:${progress.content_id}`;
            const contentInfo = contentMap.get(key) ?? { title: "제목 없음", subject: null };

            return (
              <div key={index} className="flex flex-col gap-2 rounded-lg border border-gray-200 p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium text-gray-900">{contentInfo.title}</div>
                    <div className="text-xs text-gray-500">
                      {contentTypeLabels[progress.content_type] ?? progress.content_type}
                      {contentInfo.subject ? ` · ${contentInfo.subject}` : ""}
                    </div>
                  </div>
                  <div className="text-sm font-semibold text-gray-900">
                    {progress.progress ?? 0}%
                  </div>
                </div>
                <ProgressBar
                  value={progress.progress ?? 0}
                  max={100}
                  color="indigo"
                  size="sm"
                />
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ContentUsageSection.tsx">
import { getStudentContentUsageForAdmin } from "@/lib/data/admin/studentData";
import { StatCard } from "@/components/molecules/StatCard";
import ProgressBar from "@/components/atoms/ProgressBar";

const contentTypeLabels: Record<string, string> = {
  book: "책",
  lecture: "강의",
  custom: "커스텀",
};

export async function ContentUsageSection({ studentId }: { studentId: string }) {
  try {
    const contentUsage = await getStudentContentUsageForAdmin(studentId);

    const allContents = [
      ...contentUsage.books.map((b) => ({
        ...b,
        type: "book" as const,
        key: `book:${b.id}`,
      })),
      ...contentUsage.lectures.map((l) => ({
        ...l,
        type: "lecture" as const,
        key: `lecture:${l.id}`,
      })),
      ...contentUsage.customContents.map((c) => ({
        ...c,
        type: "custom" as const,
        key: `custom:${c.id}`,
      })),
    ];

    // 진행률이 있는 콘텐츠만 필터링
    const contentsWithProgress = allContents
      .map((content) => {
        const progress = contentUsage.progressMap.get(content.key);
        return {
          ...content,
          progress: progress?.progress ?? 0,
          completedAmount: progress?.completedAmount ?? 0,
        };
      })
      .filter((c) => c.progress > 0)
      .sort((a, b) => b.progress - a.progress)
      .slice(0, 10);

    return (
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div className="flex flex-col gap-6">
          <h2 className="text-xl font-semibold text-gray-900">콘텐츠 사용 현황</h2>

          {/* 통계 */}
          <div className="grid grid-cols-3 gap-4">
            <StatCard
              label="책"
              value={`${contentUsage.books.length}개`}
              color="blue"
            />
            <StatCard
              label="강의"
              value={`${contentUsage.lectures.length}개`}
              color="purple"
            />
            <StatCard
              label="커스텀"
              value={`${contentUsage.customContents.length}개`}
              color="emerald"
            />
          </div>

          {/* 진행 중인 콘텐츠 */}
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-medium text-gray-700">진행 중인 콘텐츠 (상위 10개)</h3>
            {contentsWithProgress.length === 0 ? (
              <p className="text-sm text-gray-500">진행 중인 콘텐츠가 없습니다.</p>
            ) : (
              <div className="flex flex-col gap-3">
                {contentsWithProgress.map((content) => (
                  <div
                    key={content.key}
                    className="rounded-lg border border-gray-200 p-4 transition hover:bg-gray-50"
                  >
                    <div className="flex flex-col gap-2">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <span className="rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-semibold text-indigo-700">
                            {contentTypeLabels[content.type] ?? content.type}
                          </span>
                          <span className="font-medium text-gray-900">{content.title}</span>
                          {content.subject && (
                            <span className="text-xs text-gray-500">· {content.subject}</span>
                          )}
                        </div>
                        <span className="text-sm font-semibold text-gray-900">
                          {content.progress}%
                        </span>
                      </div>
                      <ProgressBar
                        value={Math.min(100, content.progress)}
                        max={100}
                        color="indigo"
                        height="sm"
                      />
                      {content.completedAmount > 0 && (
                        <div className="text-xs text-gray-500">
                          완료량: {content.completedAmount}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  } catch (error) {
    console.error("[ContentUsageSection] 콘텐츠 사용 현황 조회 실패", error);
    return (
      <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6">
        <p className="text-sm text-gray-500">
          콘텐츠 사용 현황 정보를 불러오는 중 오류가 발생했습니다.
        </p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/GoalsSummarySection.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getAllGoals } from "@/lib/goals/queries";
import { calculateGoalProgress } from "@/lib/goals/calc";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import { SectionCard } from "@/components/ui/SectionCard";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export async function GoalsSummarySection({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();

  const goals = await getAllGoals(supabase, studentId);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // 진행 중인 목표만 필터링 (최대 3개)
  const { getGoalProgress } = await import("@/lib/goals/queries");
  const goalsWithProgress = await Promise.all(
    goals.map(async (goal) => {
      const progressRows = await getGoalProgress(supabase, studentId, goal.id);
      const progress = calculateGoalProgress(goal, progressRows, today);
      return { goal, progress };
    })
  );

  const activeGoals = goalsWithProgress
    .filter((g) => g.progress.status === "in_progress")
    .slice(0, 3);

  return (
    <SectionCard title="목표 요약">
      {activeGoals.length === 0 ? (
        <p className="text-sm text-gray-500">진행 중인 목표가 없습니다.</p>
      ) : (
        <div className="flex flex-col gap-3">
          {activeGoals.map(({ goal, progress }) => (
            <div key={goal.id} className="flex flex-col gap-2 rounded-lg border border-gray-200 p-4">
              <div className="flex items-center justify-between">
                <div className="font-medium text-gray-900">{goal.title}</div>
                <div className="text-sm font-semibold text-gray-900">
                  {progress.progressPercentage}%
                </div>
              </div>
              <ProgressBar
                value={progress.progressPercentage}
                max={100}
                color="indigo"
                size="sm"
              />
              {progress.daysRemaining !== null && (
                <div className="text-xs text-gray-500">
                  {progress.daysRemaining}일 남음
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </SectionCard>
  );
}
</file>

<file path="admin/students/[id]/_components/HistorySection.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

type HistoryRow = {
  id: string;
  event_type?: string | null;
  detail?: any;
  created_at?: string | null;
};

const eventTypeLabels: Record<string, string> = {
  plan_completed: "플랜 완료",
  study_session: "학습 세션",
  goal_progress: "목표 진행",
  goal_created: "목표 생성",
  goal_completed: "목표 달성",
  score_added: "성적 추가",
  score_updated: "성적 수정",
  content_progress: "콘텐츠 진행",
  auto_schedule_generated: "학습 플랜 생성",
};

export async function HistorySection({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();

  const selectHistory = () =>
    supabase
      .from("student_history")
      .select("id,event_type,detail,created_at")
      .eq("student_id", studentId)
      .order("created_at", { ascending: false })
      .limit(10);

  let { data: history, error } = await selectHistory();

  if (error && error.code === "42703") {
    ({ data: history, error } = await selectHistory());
  }

  if (error) {
    console.error("[admin/students] 히스토리 조회 실패", error);
  }

  const historyRows = (history as HistoryRow[] | null) ?? [];

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <h2 className="mb-4 text-xl font-semibold text-gray-900">최근 히스토리</h2>
      {historyRows.length === 0 ? (
        <p className="text-sm text-gray-500">히스토리가 없습니다.</p>
      ) : (
        <div className="space-y-2">
          {historyRows.map((record) => (
            <div
              key={record.id}
              className="flex items-center justify-between rounded-lg border border-gray-200 p-3"
            >
              <div>
                <div className="text-sm font-medium text-gray-900">
                  {eventTypeLabels[record.event_type ?? ""] ?? record.event_type ?? "알 수 없음"}
                </div>
                {record.detail && typeof record.detail === "object" && (
                  <div className="mt-1 text-xs text-gray-500">
                    {JSON.stringify(record.detail).slice(0, 100)}
                  </div>
                )}
              </div>
              {record.created_at && (
                <div className="text-xs text-gray-500">
                  {new Date(record.created_at).toLocaleString("ko-KR")}
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ParentCard.tsx">
"use client";

import { useState, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  updateLinkRelation,
  deleteParentStudentLink,
  type StudentParent,
  type ParentRelation,
} from "@/app/(admin)/actions/parentStudentLinkActions";
import { ConfirmDialog } from "@/components/organisms/Dialog";

type ParentCardProps = {
  parent: StudentParent;
  onRefresh?: () => void;
};

const relationLabels: Record<ParentRelation, string> = {
  father: "아버지",
  mother: "어머니",
  guardian: "보호자",
  other: "기타",
};

export function ParentCard({ parent, onRefresh }: ParentCardProps) {
  const { showSuccess, showError } = useToast();
  const [isPending, startTransition] = useTransition();
  const [relation, setRelation] = useState<ParentRelation>(
    (parent.relation as ParentRelation) || "other"
  );
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);

  function handleUpdateRelation(newRelation: ParentRelation) {
    if (newRelation === relation) return;

    const previousRelation = relation; // 이전 값 저장
    setRelation(newRelation);
    startTransition(async () => {
      const result = await updateLinkRelation(parent.linkId, newRelation);

      if (result.success) {
        showSuccess("관계가 수정되었습니다.");
        onRefresh?.();
      } else {
        setRelation(previousRelation); // 이전 값으로 롤백
        showError(result.error || "관계 수정에 실패했습니다.");
      }
    });
  }

  function handleDeleteLink() {
    setIsDeleteDialogOpen(true);
  }

  function handleConfirmDelete() {
    startTransition(async () => {
      const result = await deleteParentStudentLink(parent.linkId);

      if (result.success) {
        showSuccess("연결이 해제되었습니다.");
        onRefresh?.();
        setIsDeleteDialogOpen(false);
      } else {
        showError(result.error || "연결 해제에 실패했습니다.");
      }
    });
  }

  return (
    <div className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-4">
      <div className="flex-1">
        <div className="text-base font-semibold text-gray-900">
          {parent.parentName || "이름 없음"}
        </div>
        <div className="text-sm text-gray-500">{parent.parentEmail || "-"}</div>
      </div>

      <div className="flex items-center gap-3">
        <select
          value={relation}
          onChange={(e) =>
            handleUpdateRelation(e.target.value as ParentRelation)
          }
          disabled={isPending}
          className="rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed"
        >
          <option value="father">아버지</option>
          <option value="mother">어머니</option>
          <option value="guardian">보호자</option>
          <option value="other">기타</option>
        </select>

        <button
          onClick={handleDeleteLink}
          disabled={isPending}
          className="rounded-lg border border-red-300 bg-white px-3 py-1.5 text-sm font-medium text-red-600 transition hover:bg-red-50 disabled:bg-gray-100 disabled:cursor-not-allowed disabled:text-gray-400"
        >
          {isPending ? "처리 중..." : "연결 해제"}
        </button>
      </div>

      <ConfirmDialog
        open={isDeleteDialogOpen}
        onOpenChange={setIsDeleteDialogOpen}
        title="연결 해제 확인"
        description="정말 연결을 해제하시겠습니까? 이 작업은 되돌릴 수 없습니다."
        confirmLabel="연결 해제"
        cancelLabel="취소"
        onConfirm={handleConfirmDelete}
        variant="destructive"
        isLoading={isPending}
      />
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ParentLinksSection.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getStudentParents,
  type StudentParent,
} from "@/app/(admin)/actions/parentStudentLinkActions";
import { ParentCard } from "./ParentCard";
import { ParentSearchModal } from "./ParentSearchModal";

type ParentLinksSectionProps = {
  studentId: string;
};

export function ParentLinksSection({ studentId }: ParentLinksSectionProps) {
  const { showError } = useToast();
  const [parents, setParents] = useState<StudentParent[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
  const [isPending, startTransition] = useTransition();

  // 데이터 로드
  useEffect(() => {
    async function loadParents() {
      setIsLoading(true);
      const result = await getStudentParents(studentId);

      if (result.success && result.data) {
        setParents(result.data);
      } else {
        if (result.error) {
          showError(result.error);
        }
        setParents([]);
      }
      setIsLoading(false);
    }

    loadParents();
  }, [studentId, showError]);

  // 연결 생성/삭제/수정 후 새로고침
  function handleRefresh() {
    startTransition(async () => {
      const result = await getStudentParents(studentId);

      if (result.success && result.data) {
        setParents(result.data);
      } else {
        if (result.error) {
          showError(result.error);
        }
      }
    });
  }

  if (isLoading) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <div className="h-7 w-32 animate-pulse rounded bg-gray-200" />
            <div className="h-9 w-24 animate-pulse rounded bg-gray-200" />
          </div>
          <div className="text-center text-sm text-gray-500">로딩 중...</div>
        </div>
      </div>
    );
  }

  return (
    <>
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-semibold text-gray-900">연결된 학부모</h2>
            <button
              onClick={() => setIsSearchModalOpen(true)}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-indigo-700"
            >
              학부모 추가
            </button>
          </div>

          {parents.length === 0 ? (
            <div className="py-8 text-center text-sm text-gray-500">
              연결된 학부모가 없습니다.
            </div>
          ) : (
            <div className="flex flex-col gap-3">
              {parents.map((parent) => (
                <ParentCard
                  key={parent.linkId}
                  parent={parent}
                  onRefresh={handleRefresh}
                />
              ))}
            </div>
          )}
        </div>
      </div>

      <ParentSearchModal
        isOpen={isSearchModalOpen}
        onClose={() => setIsSearchModalOpen(false)}
        studentId={studentId}
        existingParents={parents}
        onSuccess={handleRefresh}
      />
    </>
  );
}
</file>

<file path="admin/students/[id]/_components/ParentLinksSectionSkeleton.tsx">
export function ParentLinksSectionSkeleton() {
  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="h-7 w-32 animate-pulse rounded bg-gray-200" />
        <div className="h-9 w-24 animate-pulse rounded bg-gray-200" />
      </div>
      <div className="space-y-3">
        {[1, 2].map((i) => (
          <div
            key={i}
            className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-4"
          >
            <div className="flex-1 space-y-2">
              <div className="h-5 w-32 animate-pulse rounded bg-gray-200" />
              <div className="h-4 w-48 animate-pulse rounded bg-gray-200" />
            </div>
            <div className="flex items-center gap-3">
              <div className="h-9 w-24 animate-pulse rounded bg-gray-200" />
              <div className="h-9 w-20 animate-pulse rounded bg-gray-200" />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ParentSearchModal.tsx">
"use client";

import { useState, useEffect, useCallback, useRef } from "react";
import { useTransition } from "react";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import {
  searchParents,
  createParentStudentLink,
  type SearchableParent,
  type StudentParent,
  type ParentRelation,
} from "@/app/(admin)/actions/parentStudentLinkActions";

type ParentSearchModalProps = {
  isOpen: boolean;
  onClose: () => void;
  studentId: string;
  existingParents: StudentParent[];
  onSuccess?: () => void;
};

export function ParentSearchModal({
  isOpen,
  onClose,
  studentId,
  existingParents,
  onSuccess,
}: ParentSearchModalProps) {
  const { showSuccess, showError } = useToast();
  const [searchQuery, setSearchQuery] = useState("");
  const [searchResults, setSearchResults] = useState<SearchableParent[]>([]);
  const [selectedRelation, setSelectedRelation] = useState<ParentRelation>("mother");
  const [isSearching, setIsSearching] = useState(false);
  const [isPending, startTransition] = useTransition();
  const debounceTimerRef = useRef<NodeJS.Timeout | null>(null);

  // 이미 연결된 학부모 ID 목록
  const existingParentIds = new Set(existingParents.map((p) => p.parentId));

  // 검색 실행
  const performSearch = useCallback(
    async (query: string) => {
      if (!query || query.trim().length < 2) {
        setSearchResults([]);
        setIsSearching(false);
        return;
      }

      setIsSearching(true);
      const result = await searchParents(query.trim());

      if (result.success && result.data) {
        // 이미 연결된 학부모 필터링
        const filtered = result.data.filter(
          (parent) => !existingParentIds.has(parent.id)
        );
        setSearchResults(filtered);
      } else {
        setSearchResults([]);
        if (result.error) {
          showError(result.error);
        }
      }
      setIsSearching(false);
    },
    [existingParentIds, showError]
  );

  // Debounce 검색
  useEffect(() => {
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }

    const timer = setTimeout(() => {
      performSearch(searchQuery);
    }, 300);

    debounceTimerRef.current = timer;

    return () => {
      if (debounceTimerRef.current) {
        clearTimeout(debounceTimerRef.current);
      }
    };
  }, [searchQuery, performSearch]);

  // 모달 닫을 때 초기화
  useEffect(() => {
    if (!isOpen) {
      setSearchQuery("");
      setSearchResults([]);
      setSelectedRelation("mother");
      setIsSearching(false);
      if (debounceTimerRef.current) {
        clearTimeout(debounceTimerRef.current);
        debounceTimerRef.current = null;
      }
    }
  }, [isOpen]);

  function handleLink(parentId: string) {
    startTransition(async () => {
      const result = await createParentStudentLink(
        studentId,
        parentId,
        selectedRelation
      );

      if (result.success) {
        showSuccess("학부모가 연결되었습니다.");
        onSuccess?.();
        onClose();
      } else {
        showError(result.error || "연결에 실패했습니다.");
      }
    });
  }

  return (
    <Dialog
      open={isOpen}
      onOpenChange={onClose}
      title="학부모 검색 및 연결"
      maxWidth="lg"
    >
      <DialogContent>
        <div className="space-y-4">
          {/* 검색 입력 */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="parent-search"
              className="text-sm font-medium text-gray-700"
            >
              이름 또는 이메일로 검색
            </label>
            <input
              id="parent-search"
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="최소 2글자 이상 입력하세요..."
              className="w-full rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            />
            {searchQuery.length > 0 && searchQuery.length < 2 && (
              <p className="text-xs text-gray-500">
                최소 2글자 이상 입력해주세요.
              </p>
            )}
          </div>

          {/* 관계 선택 */}
          <div className="flex flex-col gap-2">
            <label
              htmlFor="relation-select"
              className="text-sm font-medium text-gray-700"
            >
              관계
            </label>
            <select
              id="relation-select"
              value={selectedRelation}
              onChange={(e) =>
                setSelectedRelation(e.target.value as ParentRelation)
              }
              disabled={isPending}
              className="w-full rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200 disabled:bg-gray-100"
            >
              <option value="father">아버지</option>
              <option value="mother">어머니</option>
              <option value="guardian">보호자</option>
              <option value="other">기타</option>
            </select>
          </div>

          {/* 검색 결과 */}
          {isSearching && (
            <div className="py-8 text-center text-sm text-gray-500">
              검색 중...
            </div>
          )}

          {!isSearching && searchQuery.length >= 2 && searchResults.length === 0 && (
            <div className="py-8 text-center text-sm text-gray-500">
              검색 결과가 없습니다.
            </div>
          )}

          {!isSearching && searchResults.length > 0 && (
            <div className="space-y-2">
              <div className="text-sm font-medium text-gray-700">
                검색 결과 ({searchResults.length}개)
              </div>
              <div className="max-h-64 space-y-2 overflow-y-auto">
                {searchResults.map((parent) => (
                  <div
                    key={parent.id}
                    className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-3 transition hover:bg-gray-50"
                  >
                    <div className="flex-1">
                      <div className="font-medium text-gray-900">
                        {parent.name || "이름 없음"}
                      </div>
                      <div className="text-sm text-gray-500">
                        {parent.email || "-"}
                      </div>
                    </div>
                    <button
                      onClick={() => handleLink(parent.id)}
                      disabled={isPending}
                      className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed"
                    >
                      {isPending ? "연결 중..." : "연결"}
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </DialogContent>
      <DialogFooter>
        <button
          onClick={onClose}
          disabled={isPending}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
        >
          닫기
        </button>
      </DialogFooter>
    </Dialog>
  );
}
</file>

<file path="admin/students/[id]/_components/PlanListSection.tsx">
import { getStudentPlansForAdmin } from "@/lib/data/admin/studentData";
import Link from "next/link";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import { SectionCard } from "@/components/ui/SectionCard";

type Plan = {
  id: string;
  plan_date: string;
  block_index: number;
  content_type: "book" | "lecture" | "custom";
  content_id: string;
  chapter?: string | null;
  planned_start_page_or_time?: number | null;
  planned_end_page_or_time?: number | null;
  completed_amount?: number | null;
  progress?: number | null;
  is_reschedulable: boolean;
};

const contentTypeLabels: Record<string, string> = {
  book: "책",
  lecture: "강의",
  custom: "커스텀",
};

export async function PlanListSection({
  studentId,
  dateRange,
}: {
  studentId: string;
  dateRange?: { start: string; end: string };
}) {
  try {
    const plans = await getStudentPlansForAdmin(studentId, dateRange);

    // 최근 10개만 표시
    const recentPlans = plans.slice(0, 10);

    return (
      <SectionCard
        title="학습 플랜"
        headerAction={
          <Link
            href={`/plan?student=${studentId}`}
            className="text-sm font-medium text-indigo-600 hover:text-indigo-700"
          >
            전체 보기 →
          </Link>
        }
      >
        {recentPlans.length === 0 ? (
          <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
            <p className="text-sm font-medium text-gray-700">
              등록된 학습 플랜이 없습니다.
            </p>
            <p className="text-xs text-gray-500">
              학생에게 학습 플랜을 생성하면 여기에 표시됩니다.
            </p>
          </div>
        ) : (
          <div className="flex flex-col gap-3">
            {recentPlans.map((plan: Plan) => (
              <div
                key={plan.id}
                className="flex flex-col gap-2 rounded-lg border border-gray-200 p-4 transition hover:bg-gray-50"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <span className="rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-semibold text-indigo-700">
                      {contentTypeLabels[plan.content_type] ??
                        plan.content_type}
                    </span>
                    <span className="text-sm text-gray-600">
                      {new Date(plan.plan_date).toLocaleDateString("ko-KR")}
                    </span>
                    <span className="text-sm text-gray-500">
                      블록 #{plan.block_index}
                    </span>
                  </div>
                  {plan.progress !== null && plan.progress !== undefined ? (
                    <span className="text-sm font-semibold text-gray-900">
                      {plan.progress}%
                    </span>
                  ) : (
                    <span className="text-xs text-gray-400">진행률 없음</span>
                  )}
                </div>
                {plan.chapter && (
                  <div className="text-sm text-gray-600">
                    챕터: {plan.chapter}
                  </div>
                )}
                {(plan.planned_start_page_or_time !== null ||
                  plan.planned_end_page_or_time !== null) && (
                  <div className="text-xs text-gray-500">
                    범위: {plan.planned_start_page_or_time ?? "시작"} →{" "}
                    {plan.planned_end_page_or_time ?? "끝"}
                  </div>
                )}
                {plan.progress !== null && plan.progress !== undefined && (
                  <ProgressBar
                    value={Math.min(100, plan.progress)}
                    max={100}
                    color="indigo"
                    size="sm"
                  />
                )}
              </div>
            ))}
          </div>
        )}
      </SectionCard>
    );
  } catch (error) {
    console.error("[PlanListSection] 플랜 조회 실패", error);
    const errorMessage =
      error instanceof Error
        ? error.message
        : "알 수 없는 오류가 발생했습니다.";
    return (
      <div className="flex flex-col gap-1 rounded-lg border border-dashed border-red-300 bg-red-50 p-6">
        <p className="text-sm font-medium text-red-700">
          플랜 정보를 불러오는 중 오류가 발생했습니다.
        </p>
        <p className="text-xs text-red-600">{errorMessage}</p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/PlanListSectionSkeleton.tsx">
import { CardSkeleton } from "@/components/ui/LoadingSkeleton";

export function PlanListSectionSkeleton() {
  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="h-7 w-24 animate-pulse rounded bg-gray-200"></div>
        <div className="h-5 w-20 animate-pulse rounded bg-gray-200"></div>
      </div>
      <div className="space-y-3">
        {Array.from({ length: 3 }).map((_, i) => (
          <CardSkeleton key={i} />
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/RecommendationPanel.tsx">
import { getRecommendations, getAllRecommendations } from "@/lib/recommendations/engine";
import { createSupabaseServerClient } from "@/lib/supabase/server";

export async function RecommendationPanel({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();
  const recommendations = await getRecommendations(supabase, studentId);
  const allRecommendations = getAllRecommendations(recommendations);

  if (allRecommendations.length === 0) {
    return null;
  }

  // 상위 10개만 표시
  const topRecommendations = allRecommendations.slice(0, 10);

  return (
    <div className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 className="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <span className="text-2xl">💡</span>
        Recommendation Panel
      </h2>
      <p className="text-sm text-gray-500 mb-6">
        학생 데이터 기반 자동 생성 추천 (총 {allRecommendations.length}개)
      </p>

      <div className="space-y-4">
        {/* 과목별 추천 */}
        {recommendations.subjects.length > 0 && (
          <div>
            <h3 className="text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
              <span>📚</span>
              과목별 집중 추천 ({recommendations.subjects.length}개)
            </h3>
            <ul className="space-y-2 ml-6">
              {recommendations.subjects.slice(0, 3).map((rec, index) => (
                <li key={index} className="text-sm text-gray-700 leading-relaxed">
                  • {rec}
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* 목표 기반 추천 */}
        {recommendations.goals.length > 0 && (
          <div>
            <h3 className="text-sm font-semibold text-green-700 mb-2 flex items-center gap-2">
              <span>🎯</span>
              목표 기반 행동 추천 ({recommendations.goals.length}개)
            </h3>
            <ul className="space-y-2 ml-6">
              {recommendations.goals.slice(0, 3).map((rec, index) => (
                <li key={index} className="text-sm text-gray-700 leading-relaxed">
                  • {rec}
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* 학습 플랜 추천 */}
        {recommendations.studyPlan.length > 0 && (
          <div>
            <h3 className="text-sm font-semibold text-purple-700 mb-2 flex items-center gap-2">
              <span>📅</span>
              다음주 학습시간/플랜 추천 ({recommendations.studyPlan.length}개)
            </h3>
            <ul className="space-y-2 ml-6">
              {recommendations.studyPlan.slice(0, 3).map((rec, index) => (
                <li key={index} className="text-sm text-gray-700 leading-relaxed">
                  • {rec}
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* 콘텐츠 추천 */}
        {recommendations.contents.length > 0 && (
          <div>
            <h3 className="text-sm font-semibold text-orange-700 mb-2 flex items-center gap-2">
              <span>📖</span>
              콘텐츠 추천 ({recommendations.contents.length}개)
            </h3>
            <ul className="space-y-2 ml-6">
              {recommendations.contents.slice(0, 3).map((rec, index) => (
                <li key={index} className="text-sm text-gray-700 leading-relaxed">
                  • {rec}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/RiskCard.tsx">
import { getStudentRiskScore } from "@/lib/risk/engine";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import { riskLevelColors, textPrimary, textSecondary, textTertiary, textMuted, bgSurface } from "@/lib/utils/darkMode";
import { cn } from "@/lib/cn";

type RiskCardProps = {
  studentId: string;
};

export async function RiskCard({ studentId }: RiskCardProps) {
  const supabase = await createSupabaseServerClient();
  const risk = await getStudentRiskScore(supabase, studentId);

  const levelColors = {
    high: "border-red-500 dark:border-red-600 bg-red-50 dark:bg-red-900/30",
    medium: "border-yellow-500 dark:border-yellow-600 bg-yellow-50 dark:bg-yellow-900/30",
    low: "border-green-500 dark:border-green-600 bg-green-50 dark:bg-green-900/30",
  };

  const levelLabels = {
    high: "높음",
    medium: "보통",
    low: "낮음",
  };

  const { thisWeekMinutes, lastWeekMinutes, changePercent, changeMinutes } = risk.metrics.studyTime;
  const studyTimeChange = changeMinutes > 0 ? `+${changeMinutes}` : `${changeMinutes}`;
  const studyTimeChangePercent = changePercent > 0 ? `+${changePercent}` : `${changePercent}`;

  return (
    <div className={cn("flex flex-col gap-4 rounded-lg border-2 p-6 shadow-sm", levelColors[risk.level])}>
      <div className="flex items-center justify-between">
        <h2 className={cn("text-xl font-semibold", textPrimary)}>위험도 평가</h2>
        <span
          className={cn("rounded-full px-3 py-1 text-sm font-semibold", riskLevelColors[risk.level])}
        >
          {levelLabels[risk.level]}
        </span>
      </div>

      <div className="flex flex-col gap-2">
        <div className="flex items-center justify-between">
          <span className={cn("text-sm font-medium", textSecondary)}>위험 점수</span>
          <span className={cn("text-2xl font-bold", textPrimary)}>{risk.riskScore}</span>
        </div>
        <ProgressBar
          value={risk.riskScore}
          max={100}
          variant={
            risk.level === "high"
              ? "error"
              : risk.level === "medium"
              ? "warning"
              : "success"
          }
          size="sm"
        />
      </div>

      {risk.reasons.length > 0 && (
        <div className="flex flex-col gap-2">
          <h3 className={cn("text-sm font-semibold", textSecondary)}>위험 요인</h3>
          <ul className="flex flex-col gap-1">
            {risk.reasons.map((reason, index) => (
              <li key={index} className={cn("flex items-start gap-2 text-sm", textTertiary)}>
                <span className="text-red-500 dark:text-red-400">•</span>
                <span>{reason}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      <div className={cn("flex flex-col gap-2 rounded-lg p-3", bgSurface)}>
        <h3 className={cn("text-sm font-semibold", textSecondary)}>지난주 대비 학습 변화</h3>
        <div className="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span className={textMuted}>이번주</span>
            <p className={cn("font-semibold", textPrimary)}>{Math.floor(thisWeekMinutes / 60)}시간</p>
          </div>
          <div>
            <span className={textMuted}>지난주</span>
            <p className={cn("font-semibold", textPrimary)}>{Math.floor(lastWeekMinutes / 60)}시간</p>
          </div>
          <div className="col-span-2">
            <span className={textMuted}>변화</span>
            <p
              className={cn(
                "font-semibold",
                changeMinutes > 0
                  ? "text-green-600 dark:text-green-400"
                  : changeMinutes < 0
                  ? "text-red-600 dark:text-red-400"
                  : textTertiary
              )}
            >
              {studyTimeChange}분 ({studyTimeChangePercent}%)
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/ScoreSummarySection.tsx">
/**
 * 성적 요약 섹션 (관리자 영역)
 * 
 * 새로운 통합 대시보드 API(/api/students/[id]/score-dashboard)를 사용합니다.
 */
import { cookies } from "next/headers";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { fetchScoreDashboard } from "@/lib/api/scoreDashboard";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  getStudentWithTenant,
  getEffectiveTenantId,
  validateTenantIdMismatch,
  handleScoreDashboardError,
} from "@/lib/api/scoreDashboardUtils";

export async function ScoreSummarySection({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();

  // 학생 정보 조회 - 공통 유틸리티 사용
  const student = await getStudentWithTenant(supabase, studentId);

  // effectiveTenantId 결정 - 공통 유틸리티 사용
  const effectiveTenantId = getEffectiveTenantId(
    tenantContext,
    student?.tenant_id || null
  );

  if (!effectiveTenantId) {
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <p className="text-sm text-gray-500">기관 정보를 찾을 수 없습니다.</p>
      </div>
    );
  }

  // tenantId 불일치 검증 - 공통 유틸리티 사용
  if (student) {
    validateTenantIdMismatch(
      tenantContext,
      student.tenant_id,
      studentId,
      "ScoreSummarySection"
    );
  }

  try {
    // 새로운 통합 대시보드 API 사용 (쿠키 전달)
    const cookieStore = await cookies();
    const dashboardData = await fetchScoreDashboard(
      {
        studentId,
        tenantId: effectiveTenantId,
      },
      {
        cookies: cookieStore,
      }
    );

    const { internalAnalysis, mockAnalysis } = dashboardData;

    return (
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="mb-4 text-xl font-semibold text-gray-900">성적 요약</h2>
        <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
          {/* 내신 분석 */}
          <div>
            <h3 className="mb-3 text-sm font-medium text-gray-700">내신 분석</h3>
            {internalAnalysis.totalGpa === null ? (
              <p className="text-sm text-gray-500">내신 성적이 없습니다.</p>
            ) : (
              <div className="space-y-2">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-700">전체 GPA</span>
                  <span className="font-semibold text-gray-900">
                    {internalAnalysis.totalGpa.toFixed(2)}
                  </span>
                </div>
                {internalAnalysis.zIndex !== null && (
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-700">Z-Index</span>
                    <span className="font-semibold text-gray-900">
                      {internalAnalysis.zIndex.toFixed(2)}
                    </span>
                  </div>
                )}
                {Object.keys(internalAnalysis.subjectStrength).length > 0 && (
                  <div className="mt-3 space-y-1">
                    <p className="text-xs font-medium text-gray-600">교과군별 평점</p>
                    {Object.entries(internalAnalysis.subjectStrength).map(([subject, gpa]) => (
                      <div key={subject} className="flex items-center justify-between text-xs">
                        <span className="text-gray-600">{subject}</span>
                        <span className="font-medium text-gray-900">{gpa.toFixed(2)}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* 모의고사 분석 */}
          <div>
            <h3 className="mb-3 text-sm font-medium text-gray-700">모의고사 분석</h3>
            {mockAnalysis.recentExam === null && mockAnalysis.avgPercentile === null ? (
              <p className="text-sm text-gray-500">모의고사 성적이 없습니다.</p>
            ) : (
              <div className="space-y-2">
                {mockAnalysis.recentExam && (
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-700">최근 시험</span>
                    <div className="flex flex-col items-end gap-1">
                      <span className="font-semibold text-gray-900">
                        {mockAnalysis.recentExam.examTitle}
                      </span>
                      <span className="text-xs text-gray-500">
                        {new Date(mockAnalysis.recentExam.examDate).toLocaleDateString("ko-KR")}
                      </span>
                    </div>
                  </div>
                )}
                {mockAnalysis.avgPercentile !== null && (
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-700">평균 백분위</span>
                    <span className="font-semibold text-gray-900">
                      {mockAnalysis.avgPercentile.toFixed(1)}%
                    </span>
                  </div>
                )}
                {mockAnalysis.totalStdScore !== null && (
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-700">표준점수 합</span>
                    <span className="font-semibold text-gray-900">
                      {mockAnalysis.totalStdScore}
                    </span>
                  </div>
                )}
                {mockAnalysis.best3GradeSum !== null && (
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-700">상위 3개 등급 합</span>
                    <span className="font-semibold text-gray-900">
                      {mockAnalysis.best3GradeSum}
                    </span>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  } catch (error) {
    const errorMessage = handleScoreDashboardError(error, "ScoreSummarySection");
    return (
      <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <p className="text-sm text-gray-500">
          성적 정보를 불러오는 중 오류가 발생했습니다: {errorMessage}
        </p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/ScoreTrendSection.tsx">
/**
 * 성적 변화 조회 섹션 (관리자 영역)
 *
 * 새로운 통합 대시보드 API(/api/students/[id]/score-dashboard)를 사용합니다.
 */
import { cookies } from "next/headers";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { fetchScoreDashboard } from "@/lib/api/scoreDashboard";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import {
  getStudentWithTenant,
  getEffectiveTenantId,
  validateTenantIdMismatch,
  handleScoreDashboardError,
  hasScoreDashboardData,
} from "@/lib/api/scoreDashboardUtils";

export async function ScoreTrendSection({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();

  // 학생 정보 조회 - 공통 유틸리티 사용
  const student = await getStudentWithTenant(supabase, studentId);

  // effectiveTenantId 결정 - 공통 유틸리티 사용
  const effectiveTenantId = getEffectiveTenantId(
    tenantContext,
    student?.tenant_id || null
  );

  if (!effectiveTenantId) {
    return (
      <div className="flex flex-col gap-1 rounded-lg border border-dashed border-yellow-300 bg-yellow-50 p-6">
        <p className="text-sm font-medium text-yellow-700">
          기관 정보를 찾을 수 없습니다.
        </p>
        <p className="text-xs text-yellow-600">
          성적 분석을 보려면 학생이 속한 기관 정보가 필요합니다.
        </p>
      </div>
    );
  }

  // tenantId 불일치 검증 - 공통 유틸리티 사용
  if (student) {
    validateTenantIdMismatch(
      tenantContext,
      student.tenant_id,
      studentId,
      "ScoreTrendSection"
    );
  }

  try {
    // 새로운 통합 대시보드 API 사용 (쿠키 전달)
    const cookieStore = await cookies();
    const dashboardData = await fetchScoreDashboard(
      {
        studentId,
        tenantId: effectiveTenantId,
      },
      {
        cookies: cookieStore,
      }
    );

    const { internalAnalysis, mockAnalysis, strategyResult } = dashboardData;

    const hasData = hasScoreDashboardData(internalAnalysis, mockAnalysis);

    return (
      <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="text-xl font-semibold text-gray-900">성적 분석</h2>

        {!hasData && (
          <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
            <p className="text-sm font-medium text-gray-700">
              성적 데이터가 없습니다.
            </p>
            <p className="text-xs text-gray-500">
              학생의 내신 또는 모의고사 성적을 입력하면 분석 결과가 표시됩니다.
            </p>
          </div>
        )}

        {/* 통계 */}
        <div className="grid grid-cols-2 gap-4">
          <div className="flex flex-col gap-1 rounded-lg bg-indigo-50 p-4">
            <div className="text-sm text-indigo-600">내신 GPA</div>
            <div className="text-2xl font-bold text-indigo-700">
              {internalAnalysis.totalGpa !== null
                ? internalAnalysis.totalGpa.toFixed(2)
                : "-"}
            </div>
            {internalAnalysis.zIndex !== null && (
              <div className="text-xs text-indigo-500">
                Z-Index: {internalAnalysis.zIndex.toFixed(2)}
              </div>
            )}
          </div>
          <div className="flex flex-col gap-1 rounded-lg bg-purple-50 p-4">
            <div className="text-sm text-purple-600">모의고사 평균 백분위</div>
            <div className="text-2xl font-bold text-purple-700">
              {mockAnalysis.avgPercentile !== null
                ? `${mockAnalysis.avgPercentile.toFixed(1)}%`
                : "-"}
            </div>
            {mockAnalysis.best3GradeSum !== null && (
              <div className="text-xs text-purple-500">
                상위 3개 등급 합: {mockAnalysis.best3GradeSum}
              </div>
            )}
          </div>
        </div>

        {/* 전략 분석 */}
        {strategyResult && (
          <div className="flex flex-col gap-2 rounded-lg border border-gray-200 bg-gray-50 p-4">
            <h3 className="text-sm font-medium text-gray-700">
              입시 전략
            </h3>
            <div className="flex items-center gap-2">
              <span
                className={`rounded-full px-2 py-1 text-xs font-medium ${
                  strategyResult.type === "BALANCED"
                    ? "bg-blue-100 text-blue-800"
                    : strategyResult.type === "MOCK_ADVANTAGE"
                    ? "bg-purple-100 text-purple-800"
                    : "bg-indigo-100 text-indigo-800"
                }`}
              >
                {strategyResult.type === "BALANCED"
                  ? "균형형"
                  : strategyResult.type === "MOCK_ADVANTAGE"
                  ? "모의고사 우위"
                  : "내신 우위"}
              </span>
              <p className="text-sm text-gray-700">{strategyResult.message}</p>
            </div>
            {strategyResult.data.diff !== null && (
              <div className="text-xs text-gray-600">
                내신 {strategyResult.data.internalPct?.toFixed(1) ?? "-"}% vs
                모의고사 {strategyResult.data.mockPct?.toFixed(1) ?? "-"}%
                (차이: {Math.abs(strategyResult.data.diff).toFixed(1)}%)
              </div>
            )}
          </div>
        )}

        {/* 교과군별 평점 */}
        {Object.keys(internalAnalysis.subjectStrength).length > 0 && (
          <div className="flex flex-col gap-2">
            <h3 className="text-sm font-medium text-gray-700">
              교과군별 평점
            </h3>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(internalAnalysis.subjectStrength).map(
                ([subject, gpa]) => (
                  <div
                    key={subject}
                    className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-2"
                  >
                    <span className="text-sm text-gray-700">{subject}</span>
                    <span className="text-sm font-semibold text-gray-900">
                      {gpa.toFixed(2)}
                    </span>
                  </div>
                )
              )}
            </div>
          </div>
        )}
      </div>
    );
  } catch (error) {
    const errorMessage = handleScoreDashboardError(error, "ScoreTrendSection");
    return (
      <div className="rounded-lg border border-dashed border-red-300 bg-red-50 p-6">
        <p className="text-sm font-medium text-red-700">
          성적 정보를 불러오는 중 오류가 발생했습니다.
        </p>
        <p className="text-xs text-red-600">{errorMessage}</p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/ScoreTrendSectionSkeleton.tsx">
export function ScoreTrendSectionSkeleton() {
  return (
    <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="h-7 w-32 animate-pulse rounded bg-gray-200"></div>
      <div className="grid grid-cols-2 gap-4">
        {Array.from({ length: 2 }).map((_, i) => (
          <div key={i} className="flex flex-col gap-1 rounded-lg bg-gray-50 p-4">
            <div className="h-4 w-24 animate-pulse rounded bg-gray-200"></div>
            <div className="h-8 w-16 animate-pulse rounded bg-gray-200"></div>
            <div className="h-3 w-20 animate-pulse rounded bg-gray-200"></div>
          </div>
        ))}
      </div>
      <div className="space-y-2">
        {Array.from({ length: 3 }).map((_, i) => (
          <div
            key={i}
            className="h-4 w-full animate-pulse rounded bg-gray-200"
          ></div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/SessionListSection.tsx">
import { getSessionsInRange } from "@/lib/data/studentSessions";

// 최근 30일 날짜 범위
function getRecentDateRange() {
  const today = new Date();
  today.setHours(23, 59, 59, 999);
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);
  thirtyDaysAgo.setHours(0, 0, 0, 0);
  return {
    start: thirtyDaysAgo.toISOString(),
    end: today.toISOString(),
  };
}

export async function SessionListSection({ studentId }: { studentId: string }) {
  try {
    const dateRange = getRecentDateRange();
    const sessions = await getSessionsInRange({
      studentId,
      tenantId: null,
      dateRange,
    });

    // 최근 20개만 표시
    const recentSessions = sessions.slice(0, 20);

    const formatDuration = (seconds: number | null | undefined): string => {
      if (!seconds) return "-";
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      if (hours > 0) {
        return `${hours}시간 ${minutes}분`;
      }
      return `${minutes}분`;
    };

    const startDate = new Date(dateRange.start);
    const endDate = new Date(dateRange.end);

    return (
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div className="flex items-center justify-between">
          <h2 className="text-xl font-semibold text-gray-900">학습 기록</h2>
          <span className="text-xs text-gray-500">
            {startDate.toLocaleDateString("ko-KR")} ~{" "}
            {endDate.toLocaleDateString("ko-KR")}
          </span>
        </div>
        {recentSessions.length === 0 ? (
          <div className="flex flex-col gap-1 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
            <p className="text-sm font-medium text-gray-700">
              최근 30일간 학습 기록이 없습니다.
            </p>
            <p className="text-xs text-gray-500">
              학생이 학습을 시작하면 여기에 표시됩니다.
            </p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    시작 시간
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    종료 시간
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    학습 시간
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    콘텐츠 타입
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                    상태
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200 bg-white">
                {recentSessions.map((session) => (
                  <tr key={session.id} className="hover:bg-gray-50">
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-900">
                      {new Date(session.started_at).toLocaleString("ko-KR")}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {session.ended_at
                        ? new Date(session.ended_at).toLocaleString("ko-KR")
                        : "진행 중"}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {formatDuration(session.duration_seconds)}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-500">
                      {session.content_type ?? "-"}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm">
                      {session.ended_at ? (
                        <span className="rounded-full bg-green-100 px-2 py-1 text-xs font-semibold text-green-700">
                          완료
                        </span>
                      ) : (
                        <span className="rounded-full bg-yellow-100 px-2 py-1 text-xs font-semibold text-yellow-700">
                          진행 중
                        </span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    );
  } catch (error) {
    console.error("[SessionListSection] 학습 기록 조회 실패", error);
    const errorMessage =
      error instanceof Error
        ? error.message
        : "알 수 없는 오류가 발생했습니다.";
    return (
      <div className="rounded-lg border border-dashed border-red-300 bg-red-50 p-6">
        <p className="text-sm font-medium text-red-700">
          학습 기록 정보를 불러오는 중 오류가 발생했습니다.
        </p>
        <p className="text-xs text-red-600">{errorMessage}</p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/SessionListSectionSkeleton.tsx">
import { TableSkeleton } from "@/components/ui/LoadingSkeleton";

export function SessionListSectionSkeleton() {
  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="h-7 w-32 animate-pulse rounded bg-gray-200"></div>
      <TableSkeleton rows={5} />
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/StudentDetailTabs.tsx">
"use client";

import React, { useState, useEffect } from "react";
import { useSearchParams, useRouter } from "next/navigation";

type TabKey =
  | "basic"
  | "plan"
  | "content"
  | "score"
  | "session"
  | "analysis"
  | "consulting"
  | "attendance";

type Tab = {
  key: TabKey;
  label: string;
  icon: string;
};

const tabs: Tab[] = [
  { key: "basic", label: "기본정보", icon: "👤" },
  { key: "plan", label: "학습계획", icon: "📅" },
  { key: "content", label: "콘텐츠", icon: "📚" },
  { key: "score", label: "성적", icon: "📊" },
  { key: "session", label: "학습기록", icon: "⏱️" },
  { key: "analysis", label: "분석 리포트", icon: "📈" },
  { key: "consulting", label: "상담노트", icon: "📝" },
  { key: "attendance", label: "출석", icon: "✓" },
];

export function StudentDetailTabs({
  defaultTab = "basic",
  children,
}: {
  defaultTab?: TabKey;
  children: React.ReactNode;
}) {
  const searchParams = useSearchParams();
  const router = useRouter();
  const tabFromUrl = (searchParams.get("tab") as TabKey) || defaultTab;
  const [activeTab, setActiveTab] = useState<TabKey>(tabFromUrl);

  useEffect(() => {
    const tab = (searchParams.get("tab") as TabKey) || defaultTab;
    setActiveTab(tab);
  }, [searchParams, defaultTab]);

  const handleTabChange = (tab: TabKey) => {
    setActiveTab(tab);
    const params = new URLSearchParams(searchParams.toString());
    params.set("tab", tab);
    router.push(`?${params.toString()}`, { scroll: false });
  };

  return (
    <div className="flex flex-col gap-6">
      {/* 탭 네비게이션 */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex gap-8 overflow-x-auto">
          {tabs.map((tab) => (
            <button
              key={tab.key}
              onClick={() => handleTabChange(tab.key)}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition ${
                activeTab === tab.key
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              <span className="pr-2">{tab.icon}</span>
              {tab.label}
            </button>
          ))}
        </nav>
      </div>

      {/* 탭 컨텐츠 */}
      <div>
        {React.Children.map(children, (child) => {
          if (
            React.isValidElement(child) &&
            typeof child.props === "object" &&
            child.props !== null &&
            "tab" in child.props &&
            (child.props as { tab?: TabKey }).tab === activeTab
          ) {
            return child;
          }
          return null;
        })}
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/StudentDetailWrapper.tsx">
"use client";

import { ReactNode } from "react";
import { BreadcrumbProvider } from "@/lib/components/BreadcrumbContext";

type StudentDetailWrapperProps = {
  children: ReactNode;
  studentId: string;
  studentName: string | null;
};

export function StudentDetailWrapper({
  children,
  studentId,
  studentName,
}: StudentDetailWrapperProps) {
  const breadcrumbLabels = {
    [`/admin/students/${studentId}`]: studentName ? `${studentName} 학생` : "학생 상세",
  };

  return (
    <BreadcrumbProvider labels={breadcrumbLabels}>
      {children}
    </BreadcrumbProvider>
  );
}
</file>

<file path="admin/students/[id]/_components/StudyTimeSection.tsx">
import { getStudentStudyTimeForAdmin } from "@/lib/data/admin/studentData";
import { ProgressBar } from "@/components/atoms/ProgressBar";

// 이번 주 날짜 범위 계산
function getWeekRange() {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() + mondayOffset);
  weekStart.setHours(0, 0, 0, 0);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999);
  return { weekStart, weekEnd };
}

export async function StudyTimeSection({ studentId }: { studentId: string }) {
  try {
    const { weekStart, weekEnd } = getWeekRange();
    const studyTime = await getStudentStudyTimeForAdmin(studentId, {
      start: weekStart,
      end: weekEnd,
    });

    const weekdayLabels = ["일", "월", "화", "수", "목", "금", "토"];

    return (
      <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <h2 className="text-xl font-semibold text-gray-900">학습시간</h2>

        {/* 총 학습시간 */}
        <div className="flex flex-col gap-1 rounded-lg bg-indigo-50 p-4">
          <div className="text-sm text-gray-600">이번 주 총 학습시간</div>
          <div className="text-3xl font-bold text-indigo-700">
            {studyTime.totalHours}시간 {studyTime.totalMinutes % 60}분
          </div>
        </div>

        {/* 요일별 학습시간 */}
        <div className="flex flex-col gap-3">
          <h3 className="text-sm font-medium text-gray-700">요일별 학습시간</h3>
          <div className="flex flex-col gap-2">
            {studyTime.byDay.map((day, index) => {
              const date = new Date(day.date);
              const dayOfWeek = weekdayLabels[date.getDay()];
              return (
                <div key={index} className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">
                    {day.date} ({dayOfWeek})
                  </span>
                  <span className="text-sm font-semibold text-gray-900">
                    {day.minutes}분
                  </span>
                </div>
              );
            })}
            {studyTime.byDay.length === 0 && (
              <p className="text-sm text-gray-500">학습 시간 데이터가 없습니다.</p>
            )}
          </div>
        </div>

        {/* 과목별 학습시간 */}
        {studyTime.bySubject.length > 0 && (
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-medium text-gray-700">과목별 학습시간</h3>
            <div className="flex flex-col gap-2">
              {studyTime.bySubject.slice(0, 5).map((subject, index) => (
                <div key={index} className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">{subject.subject}</span>
                  <div className="flex items-center gap-2">
                    <ProgressBar
                      value={subject.percentage}
                      max={100}
                      color="purple"
                      size="sm"
                      className="w-24"
                    />
                    <span className="text-sm font-semibold text-gray-900">
                      {subject.minutes}분 ({subject.percentage}%)
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* 콘텐츠 타입별 학습시간 */}
        {studyTime.byContentType.length > 0 && (
          <div className="flex flex-col gap-3">
            <h3 className="text-sm font-medium text-gray-700">콘텐츠 타입별 학습시간</h3>
            <div className="flex flex-col gap-2">
              {studyTime.byContentType.map((contentType, index) => {
                const typeLabels: Record<string, string> = {
                  book: "책",
                  lecture: "강의",
                  custom: "커스텀",
                };
                return (
                  <div key={index} className="flex items-center justify-between">
                    <span className="text-sm text-gray-600">
                      {typeLabels[contentType.contentType] ?? contentType.contentType}
                    </span>
                    <div className="flex items-center gap-2">
                      <ProgressBar
                        value={contentType.percentage}
                        max={100}
                        color="green"
                        size="sm"
                        className="w-24"
                      />
                      <span className="text-sm font-semibold text-gray-900">
                        {contentType.minutes}분 ({contentType.percentage}%)
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    );
  } catch (error) {
    console.error("[StudyTimeSection] 학습시간 조회 실패", error);
    return (
      <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6">
        <p className="text-sm text-gray-500">학습시간 정보를 불러오는 중 오류가 발생했습니다.</p>
      </div>
    );
  }
}
</file>

<file path="admin/students/[id]/_components/TabContent.tsx">
"use client";

import { ReactNode } from "react";

type TabKey =
  | "basic"
  | "plan"
  | "content"
  | "score"
  | "session"
  | "analysis"
  | "consulting"
  | "attendance";

export function TabContent({
  tab,
  children,
}: {
  tab: TabKey;
  children: ReactNode;
}) {
  return <div>{children}</div>;
}
</file>

<file path="admin/students/[id]/_components/WeeklyCoachingSection.tsx">
import { getWeeklyCoaching } from "@/app/(student)/report/weekly/coachingAction";
import type { WeeklyCoaching } from "@/lib/coaching/engine";

type WeeklyCoachingSectionProps = {
  studentId: string;
};

export async function WeeklyCoachingSection({ studentId }: WeeklyCoachingSectionProps) {
  const coachingResult = await getWeeklyCoaching(studentId);

  if (!coachingResult.success || !coachingResult.data) {
    return null;
  }

  const coaching = coachingResult.data;

  return (
    <div className="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <h2 className="mb-4 text-xl font-semibold text-gray-900">주간 코칭 요약</h2>

      {/* Summary */}
      <div className="mb-6 rounded-lg bg-indigo-50 p-4">
        <p className="text-lg font-medium text-indigo-900">{coaching.summary}</p>
      </div>

      <div className="grid gap-6 md:grid-cols-3">
        {/* Highlights */}
        <div>
          <h3 className="mb-3 text-sm font-semibold text-gray-700">잘한 점</h3>
          {coaching.highlights.length > 0 ? (
            <ul className="space-y-2">
              {coaching.highlights.map((highlight, index) => (
                <li key={index} className="flex items-start gap-2">
                  <span className="mt-1 text-green-600">✓</span>
                  <span className="text-sm text-gray-700">{highlight}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-sm text-gray-500">이번주 잘한 점이 없습니다.</p>
          )}
        </div>

        {/* Warnings */}
        <div>
          <h3 className="mb-3 text-sm font-semibold text-gray-700">주의할 점</h3>
          {coaching.warnings.length > 0 ? (
            <ul className="space-y-2">
              {coaching.warnings.map((warning, index) => (
                <li key={index} className="flex items-start gap-2">
                  <span className="mt-1 text-red-600">⚠</span>
                  <span className="text-sm text-red-700">{warning}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-sm text-gray-500">특별히 주의할 점이 없습니다.</p>
          )}
        </div>

        {/* Next Week Guide */}
        <div>
          <h3 className="mb-3 text-sm font-semibold text-gray-700">다음주 가이드</h3>
          {coaching.nextWeekGuide.length > 0 ? (
            <ul className="space-y-2">
              {coaching.nextWeekGuide.map((guide, index) => (
                <li key={index} className="flex items-start gap-2">
                  <span className="mt-1 text-yellow-600">→</span>
                  <span className="text-sm text-yellow-800">{guide}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-sm text-gray-500">다음주 가이드가 없습니다.</p>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/_components/WeeklySummarySection.tsx">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getWeeklyStudyTimeSummary } from "@/lib/reports/weekly";
import { getWeeklyPlanSummary } from "@/lib/reports/weekly";
import { getWeeklyGoalProgress } from "@/lib/reports/weekly";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

// 이번 주 날짜 범위 계산
function getWeekRange() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dayOfWeek = today.getDay();
  const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() + mondayOffset);
  weekStart.setHours(0, 0, 0, 0);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999);
  return { weekStart, weekEnd };
}

export async function WeeklySummarySection({ studentId }: { studentId: string }) {
  const supabase = await createSupabaseServerClient();
  const { weekStart, weekEnd } = getWeekRange();

  const [studyTime, planSummary, goalProgress] = await Promise.all([
    getWeeklyStudyTimeSummary(supabase, studentId, weekStart, weekEnd),
    getWeeklyPlanSummary(supabase, studentId, weekStart, weekEnd),
    getWeeklyGoalProgress(supabase, studentId, weekStart, weekEnd),
  ]);

  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <h2 className="mb-4 text-xl font-semibold text-gray-900">이번주 요약</h2>
      <div className="grid grid-cols-1 gap-6 md:grid-cols-3">
        <div>
          <div className="text-sm text-gray-500">학습시간</div>
          <div className="mt-2 text-2xl font-bold text-gray-900">
            {studyTime.totalHours}시간 {studyTime.totalMinutes % 60}분
          </div>
        </div>
        <div>
          <div className="text-sm text-gray-500">플랜 실행률</div>
          <div className="mt-2 text-2xl font-bold text-gray-900">
            {planSummary.completionRate}%
          </div>
          <div className="mt-2 text-xs text-gray-500">
            {planSummary.completedPlans} / {planSummary.totalPlans} 완료
          </div>
        </div>
        <div>
          <div className="text-sm text-gray-500">목표 달성률</div>
          <div className="mt-2 text-2xl font-bold text-gray-900">
            {goalProgress.averageProgress}%
          </div>
          <div className="mt-2 text-xs text-gray-500">
            {goalProgress.activeGoals}개 진행 중
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/students/[id]/attendance-settings/_components/StudentAttendanceSettingsForm.tsx">
"use client";

import { useState, useTransition } from "react";
import { useRouter } from "next/navigation";
import { updateStudentAttendanceSettings } from "@/app/(admin)/actions/attendanceSettingsActions";
import { Card, CardContent, CardHeader } from "@/components/molecules/Card";
import Button from "@/components/atoms/Button";
import { cn } from "@/lib/cn";

type StudentAttendanceSettings = {
  attendance_check_in_enabled?: boolean | null;
  attendance_check_out_enabled?: boolean | null;
  attendance_absent_enabled?: boolean | null;
  attendance_late_enabled?: boolean | null;
};

type StudentAttendanceSettingsFormProps = {
  studentId: string;
  initialSettings?: StudentAttendanceSettings;
};

export function StudentAttendanceSettingsForm({
  studentId,
  initialSettings,
}: StudentAttendanceSettingsFormProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const [settings, setSettings] = useState<StudentAttendanceSettings>({
    attendance_check_in_enabled: initialSettings?.attendance_check_in_enabled ?? null,
    attendance_check_out_enabled: initialSettings?.attendance_check_out_enabled ?? null,
    attendance_absent_enabled: initialSettings?.attendance_absent_enabled ?? null,
    attendance_late_enabled: initialSettings?.attendance_late_enabled ?? null,
  });
  
  const handleToggle = (key: keyof StudentAttendanceSettings) => {
    const currentValue = settings[key];
    const newValue = currentValue === true ? false : currentValue === false ? null : true;
    setSettings((prev) => ({ ...prev, [key]: newValue }));
    setSuccess(false);
    setError(null);
  };
  
  const handleSave = () => {
    startTransition(async () => {
      try {
        const result = await updateStudentAttendanceSettings(studentId, settings);
        if (result.success) {
          setSuccess(true);
          setError(null);
          setTimeout(() => {
            setSuccess(false);
            router.refresh();
          }, 2000);
        } else {
          setError(result.error || "저장에 실패했습니다.");
        }
      } catch (err: any) {
        setError(err.message || "저장 중 오류가 발생했습니다.");
      }
    });
  };
  
  const hasChanges =
    JSON.stringify(settings) !== JSON.stringify(initialSettings || {});
  
  const getToggleState = (value: boolean | null | undefined): "on" | "off" | "default" => {
    if (value === true) return "on";
    if (value === false) return "off";
    return "default";
  };
  
  const getToggleClass = (state: "on" | "off" | "default") => {
    switch (state) {
      case "on":
        return "bg-indigo-600";
      case "off":
        return "bg-gray-200";
      default:
        return "bg-gray-100";
    }
  };
  
  const getTogglePosition = (state: "on" | "off" | "default") => {
    switch (state) {
      case "on":
        return "translate-x-6";
      case "off":
      case "default":
        return "translate-x-1";
    }
  };
  
  return (
    <Card>
      <CardHeader title="출석 알림 설정" />
      <CardContent>
        <div className="space-y-6">
          {/* 저장 성공/에러 메시지 */}
          {success && (
            <div className="rounded-lg border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 p-4 text-sm text-green-800 dark:text-green-200">
              설정이 저장되었습니다.
            </div>
          )}
          {error && (
            <div className="rounded-lg border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 p-4 text-sm text-red-800 dark:text-red-200">
              {error}
            </div>
          )}
          
          <p className="text-sm text-gray-600 dark:text-gray-400">
            학생별 출석 SMS 알림을 설정할 수 있습니다. 설정하지 않으면 학원 기본 설정을 따릅니다.
          </p>
          
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <div className="font-medium text-gray-900 dark:text-gray-100">입실 알림</div>
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  입실 시 SMS 알림을 받습니다
                </div>
              </div>
              <button
                type="button"
                onClick={() => handleToggle("attendance_check_in_enabled")}
                className={cn(
                  "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",
                  getToggleClass(getToggleState(settings.attendance_check_in_enabled))
                )}
              >
                <span
                  className={cn(
                    "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                    getTogglePosition(getToggleState(settings.attendance_check_in_enabled))
                  )}
                />
              </button>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <div className="font-medium text-gray-900 dark:text-gray-100">퇴실 알림</div>
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  퇴실 시 SMS 알림을 받습니다
                </div>
              </div>
              <button
                type="button"
                onClick={() => handleToggle("attendance_check_out_enabled")}
                className={cn(
                  "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",
                  getToggleClass(getToggleState(settings.attendance_check_out_enabled))
                )}
              >
                <span
                  className={cn(
                    "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                    getTogglePosition(getToggleState(settings.attendance_check_out_enabled))
                  )}
                />
              </button>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <div className="font-medium text-gray-900 dark:text-gray-100">결석 알림</div>
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  결석 시 SMS 알림을 받습니다
                </div>
              </div>
              <button
                type="button"
                onClick={() => handleToggle("attendance_absent_enabled")}
                className={cn(
                  "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",
                  getToggleClass(getToggleState(settings.attendance_absent_enabled))
                )}
              >
                <span
                  className={cn(
                    "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                    getTogglePosition(getToggleState(settings.attendance_absent_enabled))
                  )}
                />
              </button>
            </div>

            <div className="flex items-center justify-between">
              <div className="flex flex-col gap-1">
                <div className="font-medium text-gray-900 dark:text-gray-100">지각 알림</div>
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  지각 시 SMS 알림을 받습니다
                </div>
              </div>
              <button
                type="button"
                onClick={() => handleToggle("attendance_late_enabled")}
                className={cn(
                  "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",
                  getToggleClass(getToggleState(settings.attendance_late_enabled))
                )}
              >
                <span
                  className={cn(
                    "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                    getTogglePosition(getToggleState(settings.attendance_late_enabled))
                  )}
                />
              </button>
            </div>
          </div>
          
          <div className="rounded-lg border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20 p-4">
            <div className="flex flex-col gap-2">
              <p className="text-sm text-blue-800 dark:text-blue-200">
                <strong>설정 상태:</strong>
              </p>
              <ul className="flex flex-col gap-1 text-sm text-blue-700 dark:text-blue-300">
                <li>• 켜짐 (파란색): 항상 알림을 받습니다</li>
                <li>• 꺼짐 (회색): 알림을 받지 않습니다</li>
                <li>• 기본값 (연한 회색): 학원 기본 설정을 따릅니다</li>
              </ul>
            </div>
          </div>
          
          {/* 저장 버튼 */}
          <div className="flex items-center justify-end gap-3 border-t border-gray-200 dark:border-gray-700 pt-6">
            {hasChanges && (
              <p className="flex-1 text-sm text-gray-500 dark:text-gray-400">
                변경사항이 있습니다. 저장하지 않으면 변경사항이 사라집니다.
              </p>
            )}
            <Button
              type="button"
              onClick={handleSave}
              disabled={isPending || !hasChanges}
              isLoading={isPending}
            >
              {isPending ? "저장 중..." : "저장하기"}
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="admin/students/[id]/attendance-settings/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { StudentAttendanceSettingsForm } from "./_components/StudentAttendanceSettingsForm";
import PageContainer from "@/components/layout/PageContainer";
import { PageHeader } from "@/components/layout/PageHeader";

export default async function StudentAttendanceSettingsPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { userId, role } = await getCurrentUserRole();
  
  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }
  
  const { id } = await params;
  const supabase = await createSupabaseServerClient();
  const tenantContext = await getTenantContext();
  
  if (!tenantContext?.tenantId) {
    redirect("/admin/students");
  }
  
  // 학생 정보 조회
  const { data: student } = await supabase
    .from("students")
    .select("id, name")
    .eq("id", id)
    .eq("tenant_id", tenantContext.tenantId)
    .single();
  
  if (!student) {
    redirect("/admin/students");
  }
  
  // 학생 알림 설정 조회
  const { data: settings } = await supabase
    .from("student_notification_preferences")
    .select("attendance_check_in_enabled, attendance_check_out_enabled, attendance_absent_enabled, attendance_late_enabled")
    .eq("student_id", id)
    .single();
  
  return (
    <PageContainer widthType="FORM">
      <div className="flex flex-col gap-6 md:gap-8">
        <PageHeader
          title={`${student.name} 출석 알림 설정`}
          description="학생별 출석 SMS 알림을 개별적으로 설정할 수 있습니다."
        />
        
        <StudentAttendanceSettingsForm
          studentId={id}
          initialSettings={settings || undefined}
        />
      </div>
    </PageContainer>
  );
}
</file>

<file path="admin/students/[id]/page.tsx">
import Link from "next/link";
import { notFound, redirect } from "next/navigation";
import { Suspense } from "react";
import PageContainer from "@/components/layout/PageContainer";
import { PageHeader } from "@/components/layout/PageHeader";
import { DashboardSubTabs } from "@/app/(student)/scores/dashboard/_components/DashboardSubTabs";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { StudentDetailWrapper } from "./_components/StudentDetailWrapper";
import { StudentDetailTabs } from "./_components/StudentDetailTabs";
import { TabContent } from "./_components/TabContent";
import { BasicInfoSection } from "./_components/BasicInfoSection";
import { PlanListSection } from "./_components/PlanListSection";
import { ContentListSection } from "./_components/ContentListSection";
import { ScoreTrendSection } from "./_components/ScoreTrendSection";
import { SessionListSection } from "./_components/SessionListSection";
import { AnalysisReportSection } from "./_components/AnalysisReportSection";
import { ConsultingNotesSection } from "./_components/ConsultingNotesSection";
import { AttendanceSection } from "./_components/AttendanceSection";
import { RiskCard } from "./_components/RiskCard";
import { RecommendationPanel } from "./_components/RecommendationPanel";
import { PlanListSectionSkeleton } from "./_components/PlanListSectionSkeleton";
import { ContentListSectionSkeleton } from "./_components/ContentListSectionSkeleton";
import { ScoreTrendSectionSkeleton } from "./_components/ScoreTrendSectionSkeleton";
import { SessionListSectionSkeleton } from "./_components/SessionListSectionSkeleton";
import { AnalysisReportSectionSkeleton } from "./_components/AnalysisReportSectionSkeleton";
import { ConsultingNotesSectionSkeleton } from "./_components/ConsultingNotesSectionSkeleton";
import { ParentLinksSection } from "./_components/ParentLinksSection";
import { ParentLinksSectionSkeleton } from "./_components/ParentLinksSectionSkeleton";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

export default async function AdminStudentDetailPage({
  params,
  searchParams,
}: {
  params: Promise<{ id: string }>;
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const { id: studentId } = await params;
  const paramsObj = await searchParams;
  const defaultTab = (paramsObj.tab as any) || "basic";

  const supabase = await createSupabaseServerClient();

  // 학생 정보 조회
  const { data: student, error: studentError } = await supabase
    .from("students")
    .select("id,name,grade,class,birth_date,is_active")
    .eq("id", studentId)
    .maybeSingle();

  if (studentError || !student) {
    notFound();
  }

  return (
    <StudentDetailWrapper studentId={studentId} studentName={student.name}>
      <PageContainer widthType="LIST">
        <div className="flex flex-col gap-6 md:gap-8">
          <PageHeader title={`${student.name ?? "이름 없음"} 학생 상세`} />

          {/* 위험 분석 및 추천 (항상 표시) */}
          <div className="grid gap-6 md:grid-cols-2">
            <RiskCard studentId={studentId} />
            <RecommendationPanel studentId={studentId} />
          </div>

          {/* 탭 구조 */}
          <StudentDetailTabs defaultTab={defaultTab}>
          {/* 기본정보 탭 */}
          <TabContent tab="basic">
            <div className="space-y-6">
              <BasicInfoSection student={student} isAdmin={role === "admin"} />
              <Suspense fallback={<ParentLinksSectionSkeleton />}>
                <ParentLinksSection studentId={studentId} />
              </Suspense>
            </div>
          </TabContent>

          {/* 학습계획 탭 */}
          <TabContent tab="plan">
            <Suspense fallback={<PlanListSectionSkeleton />}>
              <PlanListSection studentId={studentId} />
            </Suspense>
          </TabContent>

          {/* 콘텐츠 탭 */}
          <TabContent tab="content">
            <Suspense fallback={<ContentListSectionSkeleton />}>
              <ContentListSection studentId={studentId} />
            </Suspense>
          </TabContent>

          {/* 성적 탭 */}
          <TabContent tab="score">
            <Suspense fallback={<ScoreTrendSectionSkeleton />}>
              <ScoreTrendSection studentId={studentId} />
            </Suspense>
          </TabContent>

          {/* 학습기록 탭 */}
          <TabContent tab="session">
            <Suspense fallback={<SessionListSectionSkeleton />}>
              <SessionListSection studentId={studentId} />
            </Suspense>
          </TabContent>

          {/* 분석 리포트 탭 */}
          <TabContent tab="analysis">
            <Suspense fallback={<AnalysisReportSectionSkeleton />}>
              <AnalysisReportSection studentId={studentId} />
            </Suspense>
          </TabContent>

          {/* 상담노트 탭 */}
          <TabContent tab="consulting">
            <Suspense fallback={<ConsultingNotesSectionSkeleton />}>
              <ConsultingNotesSection
                studentId={studentId}
                consultantId={userId}
              />
            </Suspense>
          </TabContent>

          {/* 출석 탭 */}
          <TabContent tab="attendance">
            <Suspense
              fallback={
                <div className="rounded-lg border border-gray-200 bg-white p-6">
                  <div className="text-sm text-gray-500">로딩 중...</div>
                </div>
              }
            >
              <AttendanceSection
                studentId={studentId}
                studentName={student.name}
              />
            </Suspense>
          </TabContent>
        </StudentDetailTabs>
        </div>
      </PageContainer>
    </StudentDetailWrapper>
  );
}
</file>

<file path="admin/students/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import Link from "next/link";
import { EmptyState } from "@/components/ui/EmptyState";
import { getWeeklyStudyTimeSummary } from "@/lib/reports/weekly";
import { getWeeklyPlanSummary } from "@/lib/reports/weekly";
import { getStudentsStatsBatch } from "@/lib/data/studentStats";
import { StudentActions } from "./_components/StudentActions";
import { PageHeader } from "@/components/layout/PageHeader";
import { ProgressBar } from "@/components/atoms/ProgressBar";
import { getWeekRange } from "@/lib/date/weekRange";

type SupabaseServerClient = Awaited<
  ReturnType<typeof createSupabaseServerClient>
>;

type StudentRow = {
  id: string;
  name?: string | null;
  grade?: string | null;
  class?: string | null;
  created_at?: string | null;
  is_active?: boolean | null;
};


// 학생별 이번주 학습시간 조회
async function getStudentWeeklyStudyTime(
  supabase: SupabaseServerClient,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<number> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const { data: sessions, error } = await supabase
      .from("student_study_sessions")
      .select("duration_seconds")
      .eq("student_id", studentId)
      .gte("started_at", weekStartStr)
      .lte("started_at", weekEndStr);

    if (error && error.code === "42703") {
      return 0;
    }

    if (error) throw error;

    const totalSeconds = (sessions ?? []).reduce(
      (sum: number, s: { duration_seconds?: number | null }) =>
        sum + (s.duration_seconds ?? 0),
      0
    );

    return Math.floor(totalSeconds / 60); // 분 단위로 반환
  } catch (error) {
    console.error(`[admin/students] 학습시간 조회 실패 (${studentId})`, error);
    return 0;
  }
}

// 학생별 이번주 플랜 실행률 조회
async function getStudentWeeklyPlanCompletion(
  supabase: SupabaseServerClient,
  studentId: string,
  weekStart: Date,
  weekEnd: Date
): Promise<number> {
  try {
    const weekStartStr = weekStart.toISOString().slice(0, 10);
    const weekEndStr = weekEnd.toISOString().slice(0, 10);

    const { data: plans, error } = await supabase
      .from("student_plan")
      .select("completed_amount")
      .eq("student_id", studentId)
      .gte("plan_date", weekStartStr)
      .lte("plan_date", weekEndStr);

    if (error && error.code === "42703") {
      return 0;
    }

    if (error) throw error;

    const planRows = plans ?? [];
    if (planRows.length === 0) return 0;

    const completed = planRows.filter(
      (p: { completed_amount?: number | null }) =>
        p.completed_amount !== null &&
        p.completed_amount !== undefined &&
        p.completed_amount > 0
    ).length;

    return Math.round((completed / planRows.length) * 100);
  } catch (error) {
    console.error(
      `[admin/students] 플랜 실행률 조회 실패 (${studentId})`,
      error
    );
    return 0;
  }
}

// 학생별 최근 학습일 조회
async function getStudentLastActivity(
  supabase: SupabaseServerClient,
  studentId: string
): Promise<string | null> {
  try {
    const { data: session, error } = await supabase
      .from("student_study_sessions")
      .select("started_at")
      .eq("student_id", studentId)
      .order("started_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    if (error && error.code === "42703") {
      return null;
    }

    if (error) throw error;

    return session?.started_at ?? null;
  } catch (error) {
    console.error(
      `[admin/students] 최근 학습일 조회 실패 (${studentId})`,
      error
    );
    return null;
  }
}

export default async function AdminStudentsPage({
  searchParams,
}: {
  searchParams: Promise<Record<string, string | undefined>>;
}) {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();
  const params = await searchParams;
  const searchQuery = params.search?.trim() ?? "";
  const gradeFilter = params.grade?.trim() ?? "";
  const classFilter = params.class?.trim() ?? "";
  const hasScoreFilter = params.has_score === "true";
  const showInactiveFilter = params.show_inactive === "true";
  const sortBy = params.sort || "name"; // name, created_at, grade
  const page = parseInt(params.page || "1", 10);
  const pageSize = 20;

  // 학생 목록 조회 (페이지네이션)
  // is_active 컬럼이 없을 수 있으므로 안전하게 처리
  let selectFields = "id,name,grade,class,created_at";
  try {
    // is_active 컬럼이 있는지 테스트
    const testQuery = supabase.from("students").select("is_active").limit(1);
    const { error: testError } = await testQuery;
    if (!testError) {
      selectFields += ",is_active";
    }
  } catch (e) {
    // 컬럼이 없으면 무시
  }

  const selectStudents = () =>
    supabase
      .from("students")
      .select(selectFields, { count: "exact" })
      .order(
        sortBy === "created_at"
          ? "created_at"
          : sortBy === "grade"
          ? "grade"
          : "name",
        {
          ascending: sortBy === "created_at" ? false : true,
        }
      );

  let query = selectStudents();

  if (searchQuery) {
    query = query.ilike("name", `%${searchQuery}%`);
  }

  if (gradeFilter) {
    query = query.eq("grade", gradeFilter);
  }

  if (classFilter) {
    query = query.eq("class", classFilter);
  }

  // is_active 필터링 (컬럼이 있을 때만)
  if (selectFields.includes("is_active") && !showInactiveFilter) {
    query = query.eq("is_active", true);
  }

  // 페이지네이션 적용
  const from = (page - 1) * pageSize;
  const to = from + pageSize - 1;
  query = query.range(from, to);

  let { data: students, error, count } = await query;

  if (error) {
    console.error("[admin/students] 학생 목록 조회 실패", {
      message: error.message,
      code: error.code,
      details: error.details,
      hint: error.hint,
    });
    // 에러가 있어도 빈 배열로 처리하여 페이지가 계속 작동하도록
  }

  const studentRows = (students as StudentRow[] | null) ?? [];

  // 성적 입력 여부 필터링
  let filteredStudents = studentRows;
  if (hasScoreFilter) {
    // 성적이 있는 학생만 필터링 (두 테이블에서 각각 조회 후 합치기)
    // ⚠️ student_school_scores는 student_internal_scores로 변경되었습니다.
    const [schoolScores, mockScores] = await Promise.all([
      supabase.from("student_internal_scores").select("student_id"),
      supabase.from("student_mock_scores").select("student_id"),
    ]);

    const studentIdsWithScores = new Set<string>();
    (schoolScores.data ?? []).forEach((s: { student_id?: string }) => {
      if (s.student_id) studentIdsWithScores.add(s.student_id);
    });
    (mockScores.data ?? []).forEach((s: { student_id?: string }) => {
      if (s.student_id) studentIdsWithScores.add(s.student_id);
    });

    filteredStudents = studentRows.filter((s) =>
      studentIdsWithScores.has(s.id)
    );
  }

  // 이번 주 날짜 범위
  const { weekStart, weekEnd } = getWeekRange();

  // 배치 쿼리로 모든 학생 통계를 한 번에 조회 (N+1 문제 해결)
  const studentIds = filteredStudents.map((s) => s.id);
  const statsMap = await getStudentsStatsBatch(
    supabase,
    studentIds,
    weekStart,
    weekEnd
  );

  // 통계 데이터를 학생 정보와 결합
  const studentsWithStats = filteredStudents.map((student) => {
    const stats = statsMap.get(student.id);
    return {
      ...student,
      studyTimeMinutes: stats?.studyTimeMinutes ?? 0,
      planCompletionRate: stats?.planCompletionRate ?? 0,
      lastActivity: stats?.lastActivity ?? null,
      hasScore: stats?.hasScore ?? false,
    };
  });

  const totalPages = count ? Math.ceil(count / pageSize) : 1;

  return (
    <div className="p-6 md:p-10">
      <div className="flex flex-col gap-6">
        <PageHeader title="학생 관리" />

        {/* 검색 및 필터 바 */}
        <div className="flex flex-col gap-4">
          <form
            method="get"
            className="flex flex-col gap-4 md:flex-row md:items-end"
          >
            {/* 검색 */}
            <div className="flex flex-col gap-1 flex-1">
              <label className="text-sm font-medium text-gray-700">
                이름 검색
              </label>
              <input
                type="text"
                name="search"
                placeholder="이름으로 검색..."
                defaultValue={searchQuery}
                className="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              />
            </div>

            {/* 학년 필터 */}
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-700">
                학년
              </label>
              <input
                type="text"
                name="grade"
                placeholder="전체"
                defaultValue={gradeFilter}
                className="w-24 rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              />
            </div>

            {/* 반 필터 */}
            <div className="flex flex-col gap-1">
              <label className="text-sm font-medium text-gray-700">
                반
              </label>
              <input
                type="text"
                name="class"
                placeholder="전체"
                defaultValue={classFilter}
                className="w-24 rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
              />
            </div>

          {/* 성적 입력 여부 필터 */}
          <div className="flex items-end">
            <label className="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 hover:bg-gray-50">
              <input
                type="checkbox"
                name="has_score"
                value="true"
                defaultChecked={hasScoreFilter}
                className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
              />
              <span className="text-sm text-gray-700">성적 입력 학생만</span>
            </label>
          </div>

          {/* 비활성화 학생 표시 필터 */}
          <div className="flex items-end">
            <label className="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 hover:bg-gray-50">
              <input
                type="checkbox"
                name="show_inactive"
                value="true"
                defaultChecked={showInactiveFilter}
                className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
              />
              <span className="text-sm text-gray-700">비활성화 포함</span>
            </label>
          </div>

          {/* 정렬 */}
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-gray-700">
              정렬
            </label>
            <select
              name="sort"
              defaultValue={sortBy}
              className="rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            >
              <option value="name">이름순</option>
              <option value="created_at">최근 생성일</option>
              <option value="grade">학년순</option>
            </select>
          </div>

          {/* 검색 버튼 */}
          <button
            type="submit"
            className="rounded-lg bg-indigo-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
          >
            검색
          </button>

          {/* 초기화 */}
          {(searchQuery ||
            gradeFilter ||
            hasScoreFilter ||
            showInactiveFilter ||
            sortBy !== "name") && (
            <Link
              href="/admin/students"
              className="rounded-lg border border-gray-300 bg-white px-6 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
            >
              초기화
            </Link>
          )}
        </form>
      </div>

        {/* 학생 리스트 */}
        {studentsWithStats.length === 0 ? (
          <EmptyState
            title="등록된 학생이 없습니다"
            description="아직 등록된 학생이 없습니다."
          />
        ) : (
          <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  이름
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  학년
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  반
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  이번주 학습시간
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  이번주 플랜 실행률
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  최근 학습일
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  성적 입력
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  상태
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                  작업
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 bg-white">
              {studentsWithStats.map((student) => (
                <tr key={student.id} className="hover:bg-gray-50">
                  <td className="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">
                    {student.name ?? "이름 없음"}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.grade ?? "-"}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.class ?? "-"}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.studyTimeMinutes}분
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    <div className="flex items-center gap-2">
                      <ProgressBar
                        value={student.planCompletionRate}
                        max={100}
                        color="indigo"
                        height="sm"
                        className="w-24"
                      />
                      <span>{student.planCompletionRate}%</span>
                    </div>
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.lastActivity
                      ? new Date(student.lastActivity).toLocaleDateString(
                          "ko-KR"
                        )
                      : "-"}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.hasScore ? (
                      <span className="rounded-full bg-green-100 px-2 py-1 text-xs font-semibold text-green-700">
                        입력됨
                      </span>
                    ) : (
                      <span className="rounded-full bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-600">
                        미입력
                      </span>
                    )}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    {student.is_active === false ? (
                      <span className="rounded-full bg-red-100 px-2 py-1 text-xs font-semibold text-red-700">
                        비활성화
                      </span>
                    ) : (
                      <span className="rounded-full bg-green-100 px-2 py-1 text-xs font-semibold text-green-700">
                        활성
                      </span>
                    )}
                  </td>
                  <td className="whitespace-nowrap px-6 py-4 text-sm text-gray-500">
                    <div className="flex items-center gap-3">
                      <Link
                        href={`/admin/students/${student.id}`}
                        className="text-indigo-600 hover:text-indigo-900"
                      >
                        상세 보기
                      </Link>
                      <StudentActions
                        studentId={student.id}
                        studentName={student.name ?? "이름 없음"}
                        isActive={student.is_active !== false}
                        isAdmin={role === "admin"}
                      />
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

        {/* 페이지네이션 */}
        {totalPages > 1 && (
          <div className="flex items-center justify-center gap-2">
            {page > 1 && (
              <Link
                href={`/admin/students?${new URLSearchParams({
                  ...params,
                  page: String(page - 1),
                }).toString()}`}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                이전
              </Link>
            )}
            <span className="text-sm text-gray-600">
              {page} / {totalPages}
            </span>
            {page < totalPages && (
              <Link
                href={`/admin/students?${new URLSearchParams({
                  ...params,
                  page: String(page + 1),
                }).toString()}`}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                다음
              </Link>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/subjects/_components/CurriculumRevisionAccordion.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getSubjectGroupsAction,
  getSubjectTypesAction,
  deleteSubjectGroup,
} from "@/app/(admin)/actions/subjectActions";
import {
  deleteCurriculumRevisionAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import SubjectGroupAccordion from "./SubjectGroupAccordion";
import SubjectTypeList from "./SubjectTypeList";
import RevisionForm from "./RevisionForm";
import GroupForm from "./GroupForm";
import UnifiedSubjectForm from "./UnifiedSubjectForm";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import type { SubjectGroup, SubjectType } from "@/lib/data/subjects";
import { ChevronDown, ChevronRight } from "lucide-react";

type CurriculumRevisionAccordionProps = {
  revision: CurriculumRevision;
  curriculumRevisions: CurriculumRevision[];
  isOpen: boolean;
  onToggle: () => void;
  onRefresh: () => void;
};

export default function CurriculumRevisionAccordion({
  revision,
  curriculumRevisions,
  isOpen,
  onToggle,
  onRefresh,
}: CurriculumRevisionAccordionProps) {
  const toast = useToast();
  const [subjectGroups, setSubjectGroups] = useState<SubjectGroup[]>([]);
  const [subjectTypes, setSubjectTypes] = useState<SubjectType[]>([]);
  const [loading, setLoading] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [isCreatingSubject, setIsCreatingSubject] = useState(false);
  const [openGroups, setOpenGroups] = useState<Set<string>>(new Set());

  useEffect(() => {
    if (isOpen) {
      loadHierarchy();
    }
  }, [isOpen, revision.id]);

  async function loadHierarchy() {
    setLoading(true);
    try {
      const [groups, types] = await Promise.all([
        getSubjectGroupsAction(revision.id),
        getSubjectTypesAction(revision.id),
      ]);
      setSubjectGroups(groups || []);
      setSubjectTypes(types || []);
    } catch (error) {
      console.error("계층 데이터 조회 실패:", error);
      toast.showError("데이터를 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete() {
    if (
      !confirm(
        `정말 "${revision.name}" 개정교육과정을 삭제하시겠습니까? 관련된 교과, 과목, 과목구분도 함께 삭제됩니다.`
      )
    ) {
      return;
    }

    try {
      await deleteCurriculumRevisionAction(revision.id);
      toast.showSuccess("개정교육과정이 삭제되었습니다.");
      onRefresh();
    } catch (error) {
      console.error("개정교육과정 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit() {
    setEditingId(revision.id);
    setIsCreating(false);
  }

  function handleCreate() {
    setIsCreating(true);
    setEditingId(null);
  }

  function handleCancel() {
    setIsCreating(false);
    setEditingId(null);
  }

  function handleSuccess() {
    setIsCreating(false);
    setEditingId(null);
    onRefresh();
    loadHierarchy();
  }

  function handleCreateSubject() {
    setIsCreatingSubject(true);
  }

  function handleCancelSubject() {
    setIsCreatingSubject(false);
  }

  function handleSubjectSuccess() {
    setIsCreatingSubject(false);
    onRefresh();
    loadHierarchy();
  }

  function toggleGroup(groupId: string) {
    setOpenGroups((prev) => {
      const next = new Set(prev);
      if (next.has(groupId)) {
        next.delete(groupId);
      } else {
        next.add(groupId);
      }
      return next;
    });
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white">
      {/* 헤더 */}
      <div className="flex items-center justify-between p-4">
        <button
          type="button"
          onClick={onToggle}
          className="flex flex-1 items-center gap-2 text-left"
          aria-expanded={isOpen}
          aria-controls={`revision-content-${revision.id}`}
        >
          {isOpen ? (
            <ChevronDown className="h-5 w-5 text-gray-500" />
          ) : (
            <ChevronRight className="h-5 w-5 text-gray-500" />
          )}
          <h2 className="text-lg font-semibold text-gray-900">
            {revision.name}
          </h2>
          <span
            className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
              revision.is_active
                ? "bg-green-100 text-green-800"
                : "bg-gray-100 text-gray-800"
            }`}
          >
            {revision.is_active ? "활성" : "비활성"}
          </span>
        </button>
        <div className="flex gap-2">
          {editingId !== revision.id && !isCreating && (
            <>
              <button
                onClick={handleEdit}
                className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
              >
                수정
              </button>
              <button
                onClick={handleDelete}
                className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
              >
                삭제
              </button>
            </>
          )}
        </div>
      </div>

      {/* 내용 */}
      {isOpen && (
        <div
          id={`revision-content-${revision.id}`}
          className="border-t border-gray-200 bg-gray-50 p-4"
        >
          {/* 편집 폼 */}
          {editingId === revision.id && (
            <div className="mb-6">
              <RevisionForm
                revision={revision}
                onSuccess={handleSuccess}
                onCancel={handleCancel}
              />
            </div>
          )}

          {/* 계층 구조 */}
          {editingId !== revision.id && (
            <div className="flex flex-col gap-6">
              {/* 통합 과목 생성 폼 */}
              {isCreatingSubject && (
                <div className="mb-6 rounded-lg border border-indigo-200 bg-indigo-50 p-4">
                  <UnifiedSubjectForm
                    curriculumRevisions={curriculumRevisions}
                    defaultRevisionId={revision.id}
                    onSuccess={handleSubjectSuccess}
                    onCancel={handleCancelSubject}
                  />
                </div>
              )}

              {/* 교과 및 과목 */}
              <div>
                <div className="mb-4 flex items-center justify-between">
                  <h3 className="text-base font-semibold text-gray-900">
                    교과 및 과목
                  </h3>
                  <div className="flex gap-2">
                    {!isCreating && !isCreatingSubject && (
                      <>
                        <button
                          onClick={handleCreateSubject}
                          className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                        >
                          + 과목 추가 (통합 폼)
                        </button>
                        <button
                          onClick={handleCreate}
                          className="rounded-lg bg-green-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-green-700"
                        >
                          + 교과 추가
                        </button>
                      </>
                    )}
                  </div>
                </div>
                {/* 교과 생성 폼 */}
                {isCreating && (
                  <div className="mb-4 rounded-lg border border-gray-200 bg-gray-50 p-4">
                    <GroupForm
                      curriculumRevisionId={revision.id}
                      onSuccess={handleSuccess}
                      onCancel={handleCancel}
                    />
                  </div>
                )}
                {loading ? (
                  <div className="py-4 text-center text-sm text-gray-500">
                    로딩 중...
                  </div>
                ) : subjectGroups.length === 0 ? (
                  <div className="py-4 text-center text-sm text-gray-500">
                    교과가 없습니다.
                  </div>
                ) : (
                  <div className="flex flex-col gap-3">
                    {subjectGroups.map((group) => (
                      <SubjectGroupAccordion
                        key={group.id}
                        group={group}
                        subjectTypes={subjectTypes}
                        isOpen={openGroups.has(group.id)}
                        onToggle={() => toggleGroup(group.id)}
                        onRefresh={loadHierarchy}
                      />
                    ))}
                  </div>
                )}
              </div>

              {/* 과목구분 */}
              <div>
                <div className="mb-4">
                  <h3 className="text-base font-semibold text-gray-900">
                    과목구분
                  </h3>
                </div>
                {loading ? (
                  <div className="py-4 text-center text-sm text-gray-500">
                    로딩 중...
                  </div>
                ) : (
                  <SubjectTypeList
                    subjectTypes={subjectTypes}
                    curriculumRevisionId={revision.id}
                    onRefresh={loadHierarchy}
                  />
                )}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/CurriculumRevisionTabs.tsx">
"use client";

import { useState } from "react";
import SubjectGroupSidebar from "./SubjectGroupSidebar";
import SubjectManagementPanel from "./SubjectManagementPanel";
import RevisionFormModal from "./RevisionFormModal";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import { Plus } from "lucide-react";

type CurriculumRevisionTabsProps = {
  revisions: CurriculumRevision[];
  selectedRevisionId: string | null;
  onRevisionChange: (revisionId: string) => void;
  onRefresh: () => void;
};

export default function CurriculumRevisionTabs({
  revisions,
  selectedRevisionId,
  onRevisionChange,
  onRefresh,
}: CurriculumRevisionTabsProps) {
  const [isCreatingRevision, setIsCreatingRevision] = useState(false);
  const [selectedGroupId, setSelectedGroupId] = useState<string | null>(null);

  function handleCreateRevision() {
    setIsCreatingRevision(true);
  }

  function handleRevisionSuccess() {
    setIsCreatingRevision(false);
    onRefresh();
  }

  function handleRevisionCancel() {
    setIsCreatingRevision(false);
  }

  function handleGroupSelect(groupId: string | null) {
    setSelectedGroupId(groupId);
  }

  const selectedRevision = revisions.find((r) => r.id === selectedRevisionId);

  return (
    <div className="flex flex-col gap-4">
      {/* 탭 네비게이션 */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8 overflow-x-auto">
          {revisions.map((revision) => (
            <button
              key={revision.id}
              onClick={() => onRevisionChange(revision.id)}
              className={`whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition ${
                selectedRevisionId === revision.id
                  ? "border-indigo-500 text-indigo-600"
                  : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
              }`}
            >
              {revision.name}
              {!revision.is_active && (
                <span className="ml-2 text-xs text-gray-400">(비활성)</span>
              )}
            </button>
          ))}
          <button
            onClick={handleCreateRevision}
            className="ml-auto flex items-center gap-2 whitespace-nowrap border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 transition hover:border-gray-300 hover:text-gray-700"
          >
            <Plus className="h-4 w-4" />
            추가
          </button>
        </nav>
      </div>

      {/* 좌우 분할 레이아웃 (모바일에서는 세로 스택) */}
      {selectedRevision && (
        <div className="flex flex-col gap-6 lg:flex-row">
          {/* 왼쪽: 교과 목록 사이드바 */}
          <div className="w-full lg:w-80 lg:flex-shrink-0">
            <SubjectGroupSidebar
              curriculumRevisionId={selectedRevision.id}
              selectedGroupId={selectedGroupId}
              onGroupSelect={handleGroupSelect}
            />
          </div>

          {/* 오른쪽: 메인 컨텐츠 영역 */}
          <div className="flex-1">
            <SubjectManagementPanel
              curriculumRevisionId={selectedRevision.id}
              selectedGroupId={selectedGroupId}
            />
          </div>
        </div>
      )}

      {/* 개정교육과정 생성 모달 */}
      {isCreatingRevision && (
        <RevisionFormModal
          onSuccess={handleRevisionSuccess}
          onCancel={handleRevisionCancel}
        />
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/GroupForm.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { createSubjectGroup, updateSubjectGroup } from "@/app/(admin)/actions/subjectActions";
import type { SubjectGroup } from "@/lib/data/subjects";

type GroupFormProps = {
  group?: SubjectGroup;
  curriculumRevisionId: string;
  onSuccess: () => void;
  onCancel: () => void;
};

export default function GroupForm({
  group,
  curriculumRevisionId,
  onSuccess,
  onCancel,
}: GroupFormProps) {
  const toast = useToast();
  const [name, setName] = useState(group?.name || "");
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", curriculumRevisionId);
      formData.append("name", name.trim());

      if (group) {
        await updateSubjectGroup(group.id, formData);
        toast.showSuccess("교과가 수정되었습니다.");
      } else {
        await createSubjectGroup(formData);
        toast.showSuccess("교과가 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("교과 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-4">
      <div className="flex flex-col gap-4 md:flex-row md:items-end">
        <div className="flex-1">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            이름
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="예: 국어"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            required
            disabled={isSubmitting}
          />
        </div>
        <div className="flex gap-2">
          <button
            type="submit"
            disabled={isSubmitting}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
          >
            {isSubmitting ? "저장 중..." : "저장"}
          </button>
          <button
            type="button"
            onClick={onCancel}
            disabled={isSubmitting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
        </div>
      </div>
    </form>
  );
}
</file>

<file path="admin/subjects/_components/GroupFormModal.tsx">
"use client";

import { useState } from "react";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import { createSubjectGroup, updateSubjectGroup } from "@/app/(admin)/actions/subjectActions";
import type { SubjectGroup } from "@/lib/data/subjects";

type GroupFormModalProps = {
  group?: SubjectGroup;
  curriculumRevisionId: string;
  onSuccess: () => void;
  onCancel: () => void;
};

export default function GroupFormModal({
  group,
  curriculumRevisionId,
  onSuccess,
  onCancel,
}: GroupFormModalProps) {
  const toast = useToast();
  const [name, setName] = useState(group?.name || "");
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", curriculumRevisionId);
      formData.append("name", name.trim());

      if (group) {
        await updateSubjectGroup(group.id, formData);
        toast.showSuccess("교과가 수정되었습니다.");
      } else {
        await createSubjectGroup(formData);
        toast.showSuccess("교과가 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("교과 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog
      open={true}
      onOpenChange={() => onCancel()}
      title={group ? "교과 수정" : "교과 추가"}
    >
      <DialogContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <div className="flex flex-col gap-4">
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                이름
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="예: 국어"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                required
                disabled={isSubmitting}
                autoFocus
              />
            </div>
          </div>
          <DialogFooter>
            <button
              type="button"
              onClick={onCancel}
              disabled={isSubmitting}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
            >
              취소
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
            >
              {isSubmitting ? "저장 중..." : "저장"}
            </button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="admin/subjects/_components/RevisionForm.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  createCurriculumRevisionAction,
  updateCurriculumRevisionAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

type RevisionFormProps = {
  revision?: CurriculumRevision;
  onSuccess: () => void;
  onCancel: () => void;
};

export default function RevisionForm({
  revision,
  onSuccess,
  onCancel,
}: RevisionFormProps) {
  const toast = useToast();
  const [name, setName] = useState(revision?.name || "");
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      if (revision) {
        await updateCurriculumRevisionAction(revision.id, {
          name: name.trim(),
        });
        toast.showSuccess("개정교육과정이 수정되었습니다.");
      } else {
        await createCurriculumRevisionAction(name.trim());
        toast.showSuccess("개정교육과정이 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("개정교육과정 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-4">
      <div className="flex flex-col gap-4 md:flex-row md:items-end">
        <div className="flex-1">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            이름
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="예: 2022개정"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            required
            disabled={isSubmitting}
          />
        </div>
        <div className="flex gap-2">
          <button
            type="submit"
            disabled={isSubmitting}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
          >
            {isSubmitting ? "저장 중..." : "저장"}
          </button>
          <button
            type="button"
            onClick={onCancel}
            disabled={isSubmitting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
        </div>
      </div>
    </form>
  );
}
</file>

<file path="admin/subjects/_components/RevisionFormModal.tsx">
"use client";

import { useState } from "react";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import {
  createCurriculumRevisionAction,
  updateCurriculumRevisionAction,
} from "@/app/(admin)/actions/contentMetadataActions";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

type RevisionFormModalProps = {
  revision?: CurriculumRevision;
  onSuccess: () => void;
  onCancel: () => void;
};

export default function RevisionFormModal({
  revision,
  onSuccess,
  onCancel,
}: RevisionFormModalProps) {
  const toast = useToast();
  const [name, setName] = useState(revision?.name || "");
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      if (revision) {
        await updateCurriculumRevisionAction(revision.id, {
          name: name.trim(),
        });
        toast.showSuccess("개정교육과정이 수정되었습니다.");
      } else {
        await createCurriculumRevisionAction(name.trim());
        toast.showSuccess("개정교육과정이 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("개정교육과정 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog
      open={true}
      onOpenChange={() => onCancel()}
      title={revision ? "개정교육과정 수정" : "개정교육과정 추가"}
    >
      <DialogContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <div className="flex flex-col gap-4">
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                이름
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="예: 2022개정"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                required
                disabled={isSubmitting}
                autoFocus
              />
            </div>
          </div>
          <DialogFooter>
            <button
              type="button"
              onClick={onCancel}
              disabled={isSubmitting}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
            >
              취소
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
            >
              {isSubmitting ? "저장 중..." : "저장"}
            </button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="admin/subjects/_components/SubjectForm.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { createSubject, updateSubject } from "@/app/(admin)/actions/subjectActions";
import type { Subject, SubjectType } from "@/lib/data/subjects";

type SubjectFormProps = {
  subject?: Subject;
  subjectGroupId: string;
  subjectTypes: SubjectType[];
  onSuccess: () => void;
  onCancel: () => void;
};

export default function SubjectForm({
  subject,
  subjectGroupId,
  subjectTypes,
  onSuccess,
  onCancel,
}: SubjectFormProps) {
  const toast = useToast();
  const [name, setName] = useState(subject?.name || "");
  const [subjectTypeId, setSubjectTypeId] = useState(
    subject?.subject_type_id || ""
  );
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      formData.append("subject_group_id", subjectGroupId);
      formData.append("name", name.trim());
      if (subjectTypeId) {
        formData.append("subject_type_id", subjectTypeId);
      }

      if (subject) {
        await updateSubject(subject.id, formData);
        toast.showSuccess("과목이 수정되었습니다.");
      } else {
        await createSubject(formData);
        toast.showSuccess("과목이 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("과목 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-4">
      <div className="flex flex-col gap-4 md:flex-row md:items-end">
        <div className="flex-1">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            과목명
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="예: 국어"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            required
            disabled={isSubmitting}
          />
        </div>
        <div className="w-full md:w-40">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            과목구분
          </label>
          <select
            value={subjectTypeId}
            onChange={(e) => setSubjectTypeId(e.target.value)}
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            disabled={isSubmitting}
          >
            <option value="">선택 안 함</option>
            {subjectTypes.map((type) => (
              <option key={type.id} value={type.id}>
                {type.name}
              </option>
            ))}
          </select>
        </div>
        <div className="flex gap-2">
          <button
            type="submit"
            disabled={isSubmitting}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
          >
            {isSubmitting ? "저장 중..." : "저장"}
          </button>
          <button
            type="button"
            onClick={onCancel}
            disabled={isSubmitting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
        </div>
      </div>
    </form>
  );
}
</file>

<file path="admin/subjects/_components/SubjectFormModal.tsx">
"use client";

import { useState } from "react";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import { createSubject, updateSubject } from "@/app/(admin)/actions/subjectActions";
import type { Subject, SubjectType } from "@/lib/data/subjects";

type SubjectFormModalProps = {
  subject?: Subject;
  subjectGroupId: string;
  curriculumRevisionId: string;
  subjectTypes: SubjectType[];
  onSuccess: () => void;
  onCancel: () => void;
};

export default function SubjectFormModal({
  subject,
  subjectGroupId,
  curriculumRevisionId,
  subjectTypes,
  onSuccess,
  onCancel,
}: SubjectFormModalProps) {
  const toast = useToast();
  const [name, setName] = useState(subject?.name || "");
  const [subjectTypeId, setSubjectTypeId] = useState(
    subject?.subject_type_id || ""
  );
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      formData.append("subject_group_id", subjectGroupId);
      formData.append("name", name.trim());
      if (subjectTypeId) {
        formData.append("subject_type_id", subjectTypeId);
      }

      if (subject) {
        await updateSubject(subject.id, formData);
        toast.showSuccess("과목이 수정되었습니다.");
      } else {
        await createSubject(formData);
        toast.showSuccess("과목이 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("과목 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog
      open={true}
      onOpenChange={() => onCancel()}
      title={subject ? "과목 수정" : "과목 추가"}
    >
      <DialogContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <div className="flex flex-col gap-4">
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                과목명
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="예: 국어"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                required
                disabled={isSubmitting}
                autoFocus
              />
            </div>
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                과목구분
              </label>
              <select
                value={subjectTypeId}
                onChange={(e) => setSubjectTypeId(e.target.value)}
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                disabled={isSubmitting}
              >
                <option value="">선택 안 함</option>
                {subjectTypes.map((type) => (
                  <option key={type.id} value={type.id}>
                    {type.name}
                  </option>
                ))}
              </select>
            </div>
          </div>
          <DialogFooter>
            <button
              type="button"
              onClick={onCancel}
              disabled={isSubmitting}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
            >
              취소
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
            >
              {isSubmitting ? "저장 중..." : "저장"}
            </button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="admin/subjects/_components/SubjectGroupAccordion.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getSubjectsByGroupAction,
  deleteSubjectGroup,
} from "@/app/(admin)/actions/subjectActions";
import SubjectList from "./SubjectList";
import GroupForm from "./GroupForm";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import { ChevronDown, ChevronRight } from "lucide-react";

type SubjectGroupAccordionProps = {
  group: SubjectGroup;
  subjectTypes: SubjectType[];
  isOpen: boolean;
  onToggle: () => void;
  onRefresh: () => void;
};

export default function SubjectGroupAccordion({
  group,
  subjectTypes,
  isOpen,
  onToggle,
  onRefresh,
}: SubjectGroupAccordionProps) {
  const toast = useToast();
  const [subjects, setSubjects] = useState<Subject[]>([]);
  const [loading, setLoading] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  useEffect(() => {
    if (isOpen && subjects.length === 0) {
      loadSubjects();
    }
  }, [isOpen]);

  async function loadSubjects() {
    setLoading(true);
    try {
      const data = await getSubjectsByGroupAction(group.id);
      setSubjects(data || []);
    } catch (error) {
      console.error("과목 조회 실패:", error);
      toast.showError("과목을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete() {
    if (!confirm(`정말 "${group.name}" 교과를 삭제하시겠습니까? 관련된 과목도 함께 삭제됩니다.`)) {
      return;
    }

    try {
      await deleteSubjectGroup(group.id);
      toast.showSuccess("교과가 삭제되었습니다.");
      onRefresh();
    } catch (error) {
      console.error("교과 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit() {
    setEditingId(group.id);
  }

  function handleCancel() {
    setEditingId(null);
  }

  function handleSuccess() {
    setEditingId(null);
    onRefresh();
    loadSubjects();
  }

  function handleSubjectRefresh() {
    loadSubjects();
  }

  return (
    <div className="rounded-lg border border-gray-200 bg-white">
      {/* 헤더 */}
      <div className="flex items-center justify-between p-4">
        <button
          type="button"
          onClick={onToggle}
          className="flex flex-1 items-center gap-2 text-left"
          aria-expanded={isOpen}
          aria-controls={`group-content-${group.id}`}
        >
          {isOpen ? (
            <ChevronDown className="h-4 w-4 text-gray-500" />
          ) : (
            <ChevronRight className="h-4 w-4 text-gray-500" />
          )}
          <h3 className="text-base font-semibold text-gray-900">
            {group.name}
          </h3>
        </button>
        <div className="flex gap-2">
          {editingId !== group.id && (
            <>
              <button
                onClick={handleEdit}
                className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
              >
                수정
              </button>
              <button
                onClick={handleDelete}
                className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
              >
                삭제
              </button>
            </>
          )}
        </div>
      </div>

      {/* 내용 */}
      {isOpen && (
        <div
          id={`group-content-${group.id}`}
          className="border-t border-gray-200 bg-gray-50 p-4"
        >
          {/* 편집 폼 */}
          {editingId === group.id && (
            <div className="mb-4">
              <GroupForm
                group={group}
                curriculumRevisionId={group.curriculum_revision_id}
                onSuccess={handleSuccess}
                onCancel={handleCancel}
              />
            </div>
          )}

          {/* 과목 목록 */}
          {editingId !== group.id && (
            <div>
              {loading ? (
                <div className="py-4 text-center text-sm text-gray-500">
                  로딩 중...
                </div>
              ) : (
                <SubjectList
                  subjects={subjects}
                  subjectGroupId={group.id}
                  subjectTypes={subjectTypes}
                  onRefresh={handleSubjectRefresh}
                />
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectGroupManagement.tsx">
"use client";

import React, { useState, useTransition, useEffect } from "react";
import { useRouter } from "next/navigation";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import {
  getSubjectGroupsAction,
  getSubjectsByGroupAction,
  getSubjectTypesAction,
  createSubjectGroup,
  updateSubjectGroup,
  deleteSubjectGroup,
  createSubject,
  updateSubject,
  deleteSubject,
} from "@/app/(admin)/actions/subjectActions";
import { getCurriculumRevisionsAction } from "@/app/(admin)/actions/contentMetadataActions";
import { Card } from "@/components/molecules/Card";

type SubjectGroupWithSubjects = SubjectGroup & { subjects: Subject[] };

type SubjectGroupManagementProps = {
  initialData: SubjectGroupWithSubjects[];
  curriculumRevisions: CurriculumRevision[];
  defaultRevisionId?: string;
};

export function SubjectGroupManagement({
  initialData,
  curriculumRevisions,
  defaultRevisionId,
}: SubjectGroupManagementProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [selectedRevisionId, setSelectedRevisionId] = useState<string | undefined>(defaultRevisionId);
  const [data, setData] = useState<SubjectGroupWithSubjects[]>(initialData);
  const [subjectTypes, setSubjectTypes] = useState<SubjectType[]>([]);
  const [editingGroup, setEditingGroup] = useState<string | null>(null);
  const [editingSubject, setEditingSubject] = useState<string | null>(null);
  const [newGroupForm, setNewGroupForm] = useState(false);
  const [newSubjectForm, setNewSubjectForm] = useState<{ groupId: string } | null>(null);

  // 초기 과목구분 로드
  useEffect(() => {
    async function loadInitialTypes() {
      if (defaultRevisionId) {
        try {
          const types = await getSubjectTypesAction(defaultRevisionId);
          setSubjectTypes(types);
        } catch (error) {
          console.error("과목구분 조회 실패:", error);
        }
      }
    }
    loadInitialTypes();
  }, [defaultRevisionId]);

  // 개정교육과정 변경 시 데이터 다시 로드
  useEffect(() => {
    async function loadData() {
      if (!selectedRevisionId) {
        setData([]);
        setSubjectTypes([]);
        return;
      }
      
      try {
        const [groups, types] = await Promise.all([
          getSubjectGroupsAction(selectedRevisionId),
          getSubjectTypesAction(selectedRevisionId),
        ]);
        
        setSubjectTypes(types);
        
        const groupsWithSubjects = await Promise.all(
          groups.map(async (group) => {
            const subjects = await getSubjectsByGroupAction(group.id);
            return { ...group, subjects };
          })
        );
        setData(groupsWithSubjects);
      } catch (error) {
        console.error("교과/과목 조회 실패:", error);
        alert("교과/과목을 불러오는데 실패했습니다.");
      }
    }
    
    loadData();
  }, [selectedRevisionId]);

  // 교과 그룹 추가
  const handleAddGroup = async (formData: FormData) => {
    startTransition(async () => {
      try {
        await createSubjectGroup(formData);
        setNewGroupForm(false);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "교과 그룹 추가에 실패했습니다.");
      }
    });
  };

  // 교과 그룹 수정
  const handleUpdateGroup = async (id: string, formData: FormData) => {
    startTransition(async () => {
      try {
        await updateSubjectGroup(id, formData);
        setEditingGroup(null);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "교과 그룹 수정에 실패했습니다.");
      }
    });
  };

  // 교과 그룹 삭제
  const handleDeleteGroup = async (id: string) => {
    if (!confirm("정말로 이 교과 그룹을 삭제하시겠습니까? 관련된 모든 과목도 삭제됩니다.")) {
      return;
    }

    startTransition(async () => {
      try {
        await deleteSubjectGroup(id);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "교과 그룹 삭제에 실패했습니다.");
      }
    });
  };

  // 과목 추가
  const handleAddSubject = async (formData: FormData) => {
    startTransition(async () => {
      try {
        await createSubject(formData);
        setNewSubjectForm(null);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "과목 추가에 실패했습니다.");
      }
    });
  };

  // 과목 수정
  const handleUpdateSubject = async (id: string, formData: FormData) => {
    startTransition(async () => {
      try {
        await updateSubject(id, formData);
        setEditingSubject(null);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "과목 수정에 실패했습니다.");
      }
    });
  };

  // 과목 삭제
  const handleDeleteSubject = async (id: string) => {
    if (!confirm("정말로 이 과목을 삭제하시겠습니까?")) {
      return;
    }

    startTransition(async () => {
      try {
        await deleteSubject(id);
        router.refresh();
      } catch (error) {
        alert(error instanceof Error ? error.message : "과목 삭제에 실패했습니다.");
      }
    });
  };

  return (
    <div className="flex flex-col gap-6">
      {/* 개정교육과정 선택 */}
      <div className="flex items-center gap-4">
        <label className="text-sm font-medium text-gray-700">
          개정교육과정:
        </label>
        <select
          value={selectedRevisionId || ""}
          onChange={(e) => setSelectedRevisionId(e.target.value || undefined)}
          className="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
        >
          <option value="">전체</option>
          {curriculumRevisions.map((revision) => (
            <option key={revision.id} value={revision.id}>
              {revision.name}
            </option>
          ))}
        </select>
      </div>

      {/* 교과 그룹 추가 버튼 */}
      <div className="flex items-center justify-end gap-2">
        {!selectedRevisionId && curriculumRevisions.length > 0 && (
          <span className="text-sm text-gray-500">
            교과 그룹을 추가하려면 개정교육과정을 선택해주세요.
          </span>
        )}
        {curriculumRevisions.length === 0 && (
          <span className="text-sm text-amber-600">
            먼저 개정교육과정을 생성해주세요.
          </span>
        )}
        <button
          type="button"
          onClick={() => setNewGroupForm(true)}
          disabled={isPending || newGroupForm || !selectedRevisionId}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
          title={
            !selectedRevisionId
              ? curriculumRevisions.length === 0
                ? "개정교육과정을 먼저 생성해주세요"
                : "개정교육과정을 선택해주세요"
              : newGroupForm
              ? "이미 추가 폼이 열려있습니다"
              : undefined
          }
        >
          + 교과 그룹 추가
        </button>
      </div>

      {/* 새 교과 그룹 폼 */}
      {newGroupForm && (
        <Card className="p-6">
          <form
            action={(formData) => {
              handleAddGroup(formData);
            }}
            className="flex flex-col gap-4"
          >
            <h3 className="text-lg font-semibold text-gray-900">새 교과 그룹 추가</h3>
            <input
              type="hidden"
              name="curriculum_revision_id"
              value={selectedRevisionId || ""}
            />
            <div className="grid gap-4 sm:grid-cols-2">
              <div className="flex flex-col gap-1">
                <label className="block text-sm font-medium text-gray-700">
                  교과 그룹명 <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="name"
                  required
                  placeholder="예: 국어"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                />
              </div>
              <div className="flex flex-col gap-1">
                <label className="block text-sm font-medium text-gray-700">
                  표시 순서
                </label>
                <input
                  type="number"
                  name="display_order"
                  defaultValue="0"
                  min="0"
                  className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                />
              </div>
            </div>
            <div className="flex gap-2">
              <button
                type="submit"
                disabled={isPending}
                className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
              >
                추가
              </button>
              <button
                type="button"
                onClick={() => setNewGroupForm(false)}
                disabled={isPending}
                className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50"
              >
                취소
              </button>
            </div>
          </form>
        </Card>
      )}

      {/* 교과 그룹 목록 */}
      {data.map((group) => (
        <Card key={group.id} className="p-6">
          <div className="flex flex-col gap-4">
            {/* 교과 그룹 헤더 */}
            <div className="flex items-center justify-between">
              {editingGroup === group.id ? (
                <form
                  action={(formData) => {
                    handleUpdateGroup(group.id, formData);
                  }}
                  className="flex flex-1 items-center gap-2"
                >
                  <input
                    type="hidden"
                    name="curriculum_revision_id"
                    value={group.curriculum_revision_id}
                  />
                  <input
                    type="text"
                    name="name"
                    defaultValue={group.name}
                    required
                    className="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                  />
                  <input
                    type="number"
                    name="display_order"
                    defaultValue={group.display_order}
                    min="0"
                    className="w-20 rounded-lg border border-gray-300 px-2 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                  />
                  <button
                    type="submit"
                    disabled={isPending}
                    className="rounded-lg bg-indigo-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
                  >
                    저장
                  </button>
                  <button
                    type="button"
                    onClick={() => setEditingGroup(null)}
                    disabled={isPending}
                    className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                  >
                    취소
                  </button>
                </form>
              ) : (
                <>
                  <div>
                    <h2 className="text-xl font-semibold text-gray-900">{group.name}</h2>
                    <div className="flex gap-4 text-sm text-gray-500">
                      <span>표시 순서: {group.display_order}</span>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button
                      type="button"
                      onClick={() => setEditingGroup(group.id)}
                      disabled={isPending}
                      className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                    >
                      수정
                    </button>
                    <button
                      type="button"
                      onClick={() => handleDeleteGroup(group.id)}
                      disabled={isPending}
                      className="rounded-lg bg-red-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
                    >
                      삭제
                    </button>
                    <button
                      type="button"
                      onClick={() => setNewSubjectForm({ groupId: group.id })}
                      disabled={isPending || newSubjectForm !== null}
                      className="rounded-lg bg-indigo-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
                    >
                      + 과목 추가
                    </button>
                  </div>
                </>
              )}
            </div>

            {/* 새 과목 폼 */}
            {newSubjectForm?.groupId === group.id && (
              <form
                action={(formData) => {
                  handleAddSubject(formData);
                }}
                className="rounded-lg border border-gray-200 bg-gray-50 p-4"
              >
                <input type="hidden" name="subject_group_id" value={group.id} />
                <div className="flex flex-col gap-4 sm:flex-row sm:items-end">
                  <div className="flex flex-col gap-1 flex-1">
                    <label className="block text-sm font-medium text-gray-700">
                      과목명 <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      name="name"
                      required
                      placeholder="예: 수학Ⅰ"
                      className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div className="flex flex-col gap-1 w-32">
                    <label className="block text-sm font-medium text-gray-700">
                      과목구분
                    </label>
                    <select
                      name="subject_type_id"
                      className="w-full rounded-lg border border-gray-300 px-2 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    >
                      <option value="">선택 안 함</option>
                      {subjectTypes.map((type) => (
                        <option key={type.id} value={type.id}>
                          {type.name}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="flex flex-col gap-1 w-24">
                    <label className="block text-sm font-medium text-gray-700">
                      순서
                    </label>
                    <input
                      type="number"
                      name="display_order"
                      defaultValue="0"
                      min="0"
                      className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    />
                  </div>
                  <div className="flex gap-2">
                    <button
                      type="submit"
                      disabled={isPending}
                      className="rounded-lg bg-indigo-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
                    >
                      추가
                    </button>
                    <button
                      type="button"
                      onClick={() => setNewSubjectForm(null)}
                      disabled={isPending}
                      className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                    >
                      취소
                    </button>
                  </div>
                </div>
              </form>
            )}

            {/* 과목 목록 */}
            {group.subjects.length === 0 ? (
              <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-4 text-center text-sm text-gray-500">
                등록된 과목이 없습니다.
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b border-gray-200">
                      <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">
                        과목명
                      </th>
                      <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">
                        표시 순서
                      </th>
                      <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">
                        액션
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {group.subjects.map((subject) => (
                      <tr key={subject.id} className="border-b border-gray-100">
                        {editingSubject === subject.id ? (
                          <>
                            <td colSpan={3}>
                              <form
                                action={(formData) => {
                                  handleUpdateSubject(subject.id, formData);
                                }}
                                className="flex items-center gap-4"
                              >
                                <input
                                  type="hidden"
                                  name="subject_group_id"
                                  value={group.id}
                                />
                                <input
                                  type="text"
                                  name="name"
                                  defaultValue={subject.name}
                                  required
                                  className="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                />
                                <select
                                  name="subject_type_id"
                                  defaultValue={subject.subject_type_id || ""}
                                  className="w-32 rounded-lg border border-gray-300 px-2 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                >
                                  <option value="">선택 안 함</option>
                                  {subjectTypes.map((type) => (
                                    <option key={type.id} value={type.id}>
                                      {type.name}
                                    </option>
                                  ))}
                                </select>
                                <input
                                  type="number"
                                  name="display_order"
                                  defaultValue={subject.display_order}
                                  min="0"
                                  className="w-20 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                />
                                <button
                                  type="submit"
                                  disabled={isPending}
                                  className="rounded-lg bg-indigo-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
                                >
                                  저장
                                </button>
                                <button
                                  type="button"
                                  onClick={() => setEditingSubject(null)}
                                  disabled={isPending}
                                  className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                                >
                                  취소
                                </button>
                              </form>
                            </td>
                          </>
                        ) : (
                          <>
                            <td className="px-4 py-2 text-sm text-gray-900">
                              {subject.name}
                              {subject.subject_type && (
                                <span className="text-xs text-gray-500">
                                  {" "}({subject.subject_type})
                                </span>
                              )}
                            </td>
                            <td className="px-4 py-2 text-sm text-gray-600">
                              {subject.display_order}
                            </td>
                            <td className="px-4 py-2">
                              <div className="flex gap-2">
                                <button
                                  type="button"
                                  onClick={() => setEditingSubject(subject.id)}
                                  disabled={isPending}
                                  className="rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-semibold text-gray-700 transition hover:bg-gray-50"
                                >
                                  수정
                                </button>
                                <button
                                  type="button"
                                  onClick={() => handleDeleteSubject(subject.id)}
                                  disabled={isPending}
                                  className="rounded-lg bg-red-600 px-3 py-2 text-xs font-semibold text-white transition hover:bg-red-700 disabled:opacity-50"
                                >
                                  삭제
                                </button>
                              </div>
                            </td>
                          </>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </Card>
      ))}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectGroupSidebar.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getSubjectGroupsAction,
  deleteSubjectGroup,
} from "@/app/(admin)/actions/subjectActions";
import GroupFormModal from "./GroupFormModal";
import type { SubjectGroup } from "@/lib/data/subjects";
import { Plus, Trash2, Edit2 } from "lucide-react";

type SubjectGroupSidebarProps = {
  curriculumRevisionId: string;
  selectedGroupId: string | null;
  onGroupSelect: (groupId: string | null) => void;
};

export default function SubjectGroupSidebar({
  curriculumRevisionId,
  selectedGroupId,
  onGroupSelect,
}: SubjectGroupSidebarProps) {
  const toast = useToast();
  const [groups, setGroups] = useState<SubjectGroup[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  useEffect(() => {
    loadGroups();
  }, [curriculumRevisionId]);

  async function loadGroups() {
    setLoading(true);
    try {
      const data = await getSubjectGroupsAction(curriculumRevisionId);
      setGroups(data || []);
      // 첫 번째 교과를 기본으로 선택
      if (data && data.length > 0 && !selectedGroupId) {
        const firstGroup = data[0];
        if (firstGroup?.id) {
          onGroupSelect(firstGroup.id);
        }
      }
    } catch (error) {
      console.error("교과 조회 실패:", error);
      toast.showError("교과를 불러오는데 실패했습니다.");
      setGroups([]);
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete(id: string, name: string) {
    if (
      !confirm(
        `정말 "${name}" 교과를 삭제하시겠습니까? 관련된 과목도 함께 삭제됩니다.`
      )
    ) {
      return;
    }

    try {
      await deleteSubjectGroup(id);
      toast.showSuccess("교과가 삭제되었습니다.");
      if (selectedGroupId === id) {
        onGroupSelect(null);
      }
      loadGroups();
    } catch (error) {
      console.error("교과 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit(id: string) {
    setEditingId(id);
    setIsCreating(false);
  }

  function handleCreate() {
    setIsCreating(true);
    setEditingId(null);
  }

  function handleSuccess() {
    setIsCreating(false);
    setEditingId(null);
    loadGroups();
  }

  function handleCancel() {
    setIsCreating(false);
    setEditingId(null);
  }

  const sortedGroups = [...groups].sort(
    (a, b) => (a.display_order ?? 0) - (b.display_order ?? 0) || a.name.localeCompare(b.name)
  );

  return (
    <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-4">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold text-gray-900">교과</h2>
        <button
          onClick={handleCreate}
          className="flex items-center gap-1 rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-indigo-700"
        >
          <Plus className="h-3 w-3" />
          추가
        </button>
      </div>

      {loading ? (
        <div className="py-8 text-center text-sm text-gray-500">
          로딩 중...
        </div>
      ) : sortedGroups.length === 0 ? (
        <div className="py-8 text-center text-sm text-gray-500">
          교과가 없습니다.
        </div>
      ) : (
        <div className="flex flex-col gap-2">
          {sortedGroups.map((group) => (
            <div
              key={group.id}
              className={`flex items-center justify-between rounded-lg border p-3 transition ${
                selectedGroupId === group.id
                  ? "border-indigo-500 bg-indigo-50"
                  : "border-gray-200 bg-white hover:bg-gray-50"
              }`}
            >
              <button
                onClick={() => onGroupSelect(group.id)}
                className="flex-1 text-left"
              >
                <div className="font-medium text-gray-900">{group.name}</div>
              </button>
              <div className="flex gap-1">
                <button
                  onClick={() => handleEdit(group.id)}
                  className="rounded p-1 text-gray-500 transition hover:bg-gray-100 hover:text-indigo-600"
                  title="수정"
                >
                  <Edit2 className="h-4 w-4" />
                </button>
                <button
                  onClick={() => handleDelete(group.id, group.name)}
                  className="rounded p-1 text-gray-500 transition hover:bg-gray-100 hover:text-red-600"
                  title="삭제"
                >
                  <Trash2 className="h-4 w-4" />
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* 교과 생성/수정 모달 */}
      {(isCreating || editingId) && (
        <GroupFormModal
          group={editingId ? groups.find((g) => g.id === editingId) : undefined}
          curriculumRevisionId={curriculumRevisionId}
          onSuccess={handleSuccess}
          onCancel={handleCancel}
        />
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectList.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { deleteSubject } from "@/app/(admin)/actions/subjectActions";
import SubjectForm from "./SubjectForm";
import type { Subject, SubjectType } from "@/lib/data/subjects";

type SubjectListProps = {
  subjects: Subject[];
  subjectGroupId: string;
  subjectTypes: SubjectType[];
  onRefresh: () => void;
};

export default function SubjectList({
  subjects,
  subjectGroupId,
  subjectTypes,
  onRefresh,
}: SubjectListProps) {
  const toast = useToast();
  const [editingId, setEditingId] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  async function handleDelete(id: string, name: string) {
    if (!confirm(`정말 "${name}" 과목을 삭제하시겠습니까?`)) {
      return;
    }

    try {
      await deleteSubject(id);
      toast.showSuccess("과목이 삭제되었습니다.");
      onRefresh();
    } catch (error) {
      console.error("과목 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit(subject: Subject) {
    setEditingId(subject.id);
    setIsCreating(false);
  }

  function handleCreate() {
    setIsCreating(true);
    setEditingId(null);
  }

  function handleCancel() {
    setIsCreating(false);
    setEditingId(null);
  }

  function handleSuccess() {
    setIsCreating(false);
    setEditingId(null);
    onRefresh();
  }

  const sortedSubjects = [...subjects].sort(
    (a, b) => (a.display_order ?? 0) - (b.display_order ?? 0) || a.name.localeCompare(b.name)
  );

  return (
    <div className="flex flex-col gap-2">
      {/* 생성 폼 */}
      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-3">
          <SubjectForm
            subjectGroupId={subjectGroupId}
            subjectTypes={subjectTypes}
            onSuccess={handleSuccess}
            onCancel={handleCancel}
          />
        </div>
      )}

      {/* 과목 목록 */}
      {sortedSubjects.length === 0 ? (
        <div className="py-4 text-center text-sm text-gray-500">
          과목이 없습니다.
        </div>
      ) : (
        <div className="flex flex-col gap-2">
          {sortedSubjects.map((subject) => {
            const subjectType = subjectTypes.find(
              (t) => t.id === subject.subject_type_id
            );

            if (editingId === subject.id) {
              return (
                <div
                  key={subject.id}
                  className="rounded-lg border border-gray-200 bg-gray-50 p-3"
                >
                  <SubjectForm
                    subject={subject}
                    subjectGroupId={subjectGroupId}
                    subjectTypes={subjectTypes}
                    onSuccess={handleSuccess}
                    onCancel={handleCancel}
                  />
                </div>
              );
            }

            return (
              <div
                key={subject.id}
                className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-3"
              >
                <div className="flex items-center gap-3">
                  <span className="text-sm font-medium text-gray-900">
                    {subject.name}
                  </span>
                  {subjectType && (
                    <span className="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                      {subjectType.name}
                    </span>
                  )}
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => handleEdit(subject)}
                    className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                  >
                    수정
                  </button>
                  <button
                    onClick={() => handleDelete(subject.id, subject.name)}
                    className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                  >
                    삭제
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* 추가 버튼 */}
      {!isCreating && (
        <button
          onClick={handleCreate}
          className="rounded-lg border border-dashed border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          + 과목 추가
        </button>
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectManagementPanel.tsx">
"use client";

import { useState } from "react";
import SubjectTable from "./SubjectTable";
import SubjectTypeTable from "./SubjectTypeTable";

type SubjectManagementPanelProps = {
  curriculumRevisionId: string;
  selectedGroupId: string | null;
};

export default function SubjectManagementPanel({
  curriculumRevisionId,
  selectedGroupId,
}: SubjectManagementPanelProps) {
  return (
    <div className="flex flex-col gap-6">
      {/* 과목 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="mb-4 text-lg font-semibold text-gray-900">과목</h2>
        {selectedGroupId ? (
          <SubjectTable
            subjectGroupId={selectedGroupId}
            curriculumRevisionId={curriculumRevisionId}
          />
        ) : (
          <div className="py-8 text-center text-sm text-gray-500">
            왼쪽에서 교과를 선택해주세요.
          </div>
        )}
      </div>

      {/* 과목구분 목록 */}
      <div className="rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="mb-4 text-lg font-semibold text-gray-900">과목구분</h2>
        <SubjectTypeTable curriculumRevisionId={curriculumRevisionId} />
      </div>
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectTable.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getSubjectsByGroupAction,
  deleteSubject,
} from "@/app/(admin)/actions/subjectActions";
import { getSubjectTypesAction } from "@/app/(admin)/actions/subjectActions";
import SubjectFormModal from "./SubjectFormModal";
import type { Subject, SubjectType } from "@/lib/data/subjects";
import { Plus, Trash2, Edit2 } from "lucide-react";

type SubjectTableProps = {
  subjectGroupId: string;
  curriculumRevisionId: string;
};

export default function SubjectTable({
  subjectGroupId,
  curriculumRevisionId,
}: SubjectTableProps) {
  const toast = useToast();
  const [subjects, setSubjects] = useState<Subject[]>([]);
  const [subjectTypes, setSubjectTypes] = useState<SubjectType[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  useEffect(() => {
    loadData();
  }, [subjectGroupId, curriculumRevisionId]);

  async function loadData() {
    setLoading(true);
    try {
      const [subjectsData, typesData] = await Promise.all([
        getSubjectsByGroupAction(subjectGroupId),
        getSubjectTypesAction(curriculumRevisionId),
      ]);
      setSubjects(subjectsData || []);
      setSubjectTypes(typesData || []);
    } catch (error) {
      console.error("데이터 조회 실패:", error);
      toast.showError("데이터를 불러오는데 실패했습니다.");
      setSubjects([]);
      setSubjectTypes([]);
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete(id: string, name: string) {
    if (!confirm(`정말 "${name}" 과목을 삭제하시겠습니까?`)) {
      return;
    }

    try {
      await deleteSubject(id);
      toast.showSuccess("과목이 삭제되었습니다.");
      loadData();
    } catch (error) {
      console.error("과목 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit(subject: Subject) {
    setEditingId(subject.id);
    setIsCreating(false);
  }

  function handleCreate() {
    setIsCreating(true);
    setEditingId(null);
  }

  function handleSuccess() {
    setIsCreating(false);
    setEditingId(null);
    loadData();
  }

  function handleCancel() {
    setIsCreating(false);
    setEditingId(null);
  }

  const sortedSubjects = [...subjects].sort(
    (a, b) => (a.display_order ?? 0) - (b.display_order ?? 0) || a.name.localeCompare(b.name)
  );

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-end">
        <button
          onClick={handleCreate}
          className="flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          <Plus className="h-4 w-4" />
          과목 추가
        </button>
      </div>

      {loading ? (
        <div className="py-8 text-center text-sm text-gray-500">
          로딩 중...
        </div>
      ) : sortedSubjects.length === 0 ? (
        <div className="py-8 text-center text-sm text-gray-500">
          과목이 없습니다.
        </div>
      ) : (
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-gray-200">
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  과목명
                </th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  과목구분
                </th>
                <th className="px-4 py-3 text-right text-sm font-semibold text-gray-900">
                  작업
                </th>
              </tr>
            </thead>
            <tbody>
              {sortedSubjects.map((subject) => {
                const subjectType = subjectTypes.find(
                  (t) => t.id === subject.subject_type_id
                );

                return (
                  <tr
                    key={subject.id}
                    className="border-b border-gray-100 transition hover:bg-gray-50"
                  >
                    <td className="px-4 py-3 text-sm font-medium text-gray-900">
                      {subject.name}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600">
                      {subjectType ? (
                        <span className="inline-flex rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800">
                          {subjectType.name}
                        </span>
                      ) : (
                        <span className="text-gray-400">-</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-right">
                      <div className="flex items-center justify-end gap-2">
                        <button
                          onClick={() => handleEdit(subject)}
                          className="rounded p-1.5 text-gray-500 transition hover:bg-gray-100 hover:text-indigo-600"
                          title="수정"
                        >
                          <Edit2 className="h-4 w-4" />
                        </button>
                        <button
                          onClick={() => handleDelete(subject.id, subject.name)}
                          className="rounded p-1.5 text-gray-500 transition hover:bg-gray-100 hover:text-red-600"
                          title="삭제"
                        >
                          <Trash2 className="h-4 w-4" />
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {/* 과목 생성/수정 모달 */}
      {(isCreating || editingId) && (
        <SubjectFormModal
          subject={
            editingId ? subjects.find((s) => s.id === editingId) : undefined
          }
          subjectGroupId={subjectGroupId}
          curriculumRevisionId={curriculumRevisionId}
          subjectTypes={subjectTypes}
          onSuccess={handleSuccess}
          onCancel={handleCancel}
        />
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectTypeForm.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  createSubjectType,
  updateSubjectType,
} from "@/app/(admin)/actions/subjectActions";
import type { SubjectType } from "@/lib/data/subjects";

type SubjectTypeFormProps = {
  subjectType?: SubjectType;
  curriculumRevisionId: string;
  onSuccess: () => void;
  onCancel: () => void;
};

export default function SubjectTypeForm({
  subjectType,
  curriculumRevisionId,
  onSuccess,
  onCancel,
}: SubjectTypeFormProps) {
  const toast = useToast();
  const [name, setName] = useState(subjectType?.name || "");
  const [isActive, setIsActive] = useState(
    subjectType?.is_active ?? true
  );
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", curriculumRevisionId);
      formData.append("name", name.trim());
      formData.append("is_active", isActive ? "true" : "false");

      if (subjectType) {
        await updateSubjectType(subjectType.id, formData);
        toast.showSuccess("과목구분이 수정되었습니다.");
      } else {
        await createSubjectType(formData);
        toast.showSuccess("과목구분이 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("과목구분 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-4">
      <div className="flex flex-col gap-4 md:flex-row md:items-end">
        <div className="flex-1">
          <label className="mb-1 block text-sm font-medium text-gray-700">
            이름
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="예: 공통"
            className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
            required
            disabled={isSubmitting}
          />
        </div>
        <div className="flex items-center gap-2">
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={isActive}
              onChange={(e) => setIsActive(e.target.checked)}
              className="rounded border-gray-300"
              disabled={isSubmitting}
            />
            <span className="text-sm text-gray-700">활성</span>
          </label>
        </div>
        <div className="flex gap-2">
          <button
            type="submit"
            disabled={isSubmitting}
            className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
          >
            {isSubmitting ? "저장 중..." : "저장"}
          </button>
          <button
            type="button"
            onClick={onCancel}
            disabled={isSubmitting}
            className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
          >
            취소
          </button>
        </div>
      </div>
    </form>
  );
}
</file>

<file path="admin/subjects/_components/SubjectTypeFormModal.tsx">
"use client";

import { useState } from "react";
import { Dialog, DialogContent, DialogFooter } from "@/components/ui/Dialog";
import { useToast } from "@/components/ui/ToastProvider";
import {
  createSubjectType,
  updateSubjectType,
} from "@/app/(admin)/actions/subjectActions";
import type { SubjectType } from "@/lib/data/subjects";

type SubjectTypeFormModalProps = {
  subjectType?: SubjectType;
  curriculumRevisionId: string;
  onSuccess: () => void;
  onCancel: () => void;
};

export default function SubjectTypeFormModal({
  subjectType,
  curriculumRevisionId,
  onSuccess,
  onCancel,
}: SubjectTypeFormModalProps) {
  const toast = useToast();
  const [name, setName] = useState(subjectType?.name || "");
  const [isActive, setIsActive] = useState(
    subjectType?.is_active ?? true
  );
  const [isSubmitting, setIsSubmitting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!name.trim()) {
      toast.showError("이름을 입력해주세요.");
      return;
    }

    setIsSubmitting(true);
    try {
      const formData = new FormData();
      formData.append("curriculum_revision_id", curriculumRevisionId);
      formData.append("name", name.trim());
      formData.append("is_active", isActive ? "true" : "false");

      if (subjectType) {
        await updateSubjectType(subjectType.id, formData);
        toast.showSuccess("과목구분이 수정되었습니다.");
      } else {
        await createSubjectType(formData);
        toast.showSuccess("과목구분이 생성되었습니다.");
      }
      onSuccess();
    } catch (error) {
      console.error("과목구분 저장 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "저장에 실패했습니다."
      );
    } finally {
      setIsSubmitting(false);
    }
  }

  return (
    <Dialog
      open={true}
      onOpenChange={() => onCancel()}
      title={subjectType ? "과목구분 수정" : "과목구분 추가"}
    >
      <DialogContent>
        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <div className="flex flex-col gap-4">
            <div>
              <label className="mb-1 block text-sm font-medium text-gray-700">
                이름
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="예: 공통"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm"
                required
                disabled={isSubmitting}
                autoFocus
              />
            </div>
            <div className="flex items-center gap-2">
              <label className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={isActive}
                  onChange={(e) => setIsActive(e.target.checked)}
                  className="rounded border-gray-300"
                  disabled={isSubmitting}
                />
                <span className="text-sm text-gray-700">활성</span>
              </label>
            </div>
          </div>
          <DialogFooter>
            <button
              type="button"
              onClick={onCancel}
              disabled={isSubmitting}
              className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
            >
              취소
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
            >
              {isSubmitting ? "저장 중..." : "저장"}
            </button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="admin/subjects/_components/SubjectTypeList.tsx">
"use client";

import { useState } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { deleteSubjectType } from "@/app/(admin)/actions/subjectActions";
import SubjectTypeForm from "./SubjectTypeForm";
import type { SubjectType } from "@/lib/data/subjects";

type SubjectTypeListProps = {
  subjectTypes: SubjectType[];
  curriculumRevisionId: string;
  onRefresh: () => void;
};

export default function SubjectTypeList({
  subjectTypes,
  curriculumRevisionId,
  onRefresh,
}: SubjectTypeListProps) {
  const toast = useToast();
  const [editingId, setEditingId] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  async function handleDelete(id: string, name: string) {
    if (
      !confirm(
        `정말 "${name}" 과목구분을 삭제하시겠습니까? 사용 중인 과목이 있으면 삭제할 수 없습니다.`
      )
    ) {
      return;
    }

    try {
      await deleteSubjectType(id);
      toast.showSuccess("과목구분이 삭제되었습니다.");
      onRefresh();
    } catch (error) {
      console.error("과목구분 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit(subjectType: SubjectType) {
    setEditingId(subjectType.id);
    setIsCreating(false);
  }

  function handleCreate() {
    setIsCreating(true);
    setEditingId(null);
  }

  function handleCancel() {
    setIsCreating(false);
    setEditingId(null);
  }

  function handleSuccess() {
    setIsCreating(false);
    setEditingId(null);
    onRefresh();
  }

  const sortedTypes = [...subjectTypes].sort(
    (a, b) =>
      (a.display_order ?? 0) - (b.display_order ?? 0) || a.name.localeCompare(b.name)
  );

  return (
    <div className="flex flex-col gap-2">
      {/* 생성 폼 */}
      {isCreating && (
        <div className="rounded-lg border border-gray-200 bg-gray-50 p-3">
          <SubjectTypeForm
            curriculumRevisionId={curriculumRevisionId}
            onSuccess={handleSuccess}
            onCancel={handleCancel}
          />
        </div>
      )}

      {/* 과목구분 목록 */}
      {sortedTypes.length === 0 ? (
        <div className="py-4 text-center text-sm text-gray-500">
          과목구분이 없습니다.
        </div>
      ) : (
        <div className="flex flex-col gap-2">
          {sortedTypes.map((subjectType) => {
            if (editingId === subjectType.id) {
              return (
                <div
                  key={subjectType.id}
                  className="rounded-lg border border-gray-200 bg-gray-50 p-3"
                >
                  <SubjectTypeForm
                    subjectType={subjectType}
                    curriculumRevisionId={curriculumRevisionId}
                    onSuccess={handleSuccess}
                    onCancel={handleCancel}
                  />
                </div>
              );
            }

            return (
              <div
                key={subjectType.id}
                className="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-3"
              >
                <div className="flex items-center gap-3">
                  <span className="text-sm font-medium text-gray-900">
                    {subjectType.name}
                  </span>
                  <span
                    className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
                      subjectType.is_active
                        ? "bg-green-100 text-green-800"
                        : "bg-gray-100 text-gray-800"
                    }`}
                  >
                    {subjectType.is_active ? "활성" : "비활성"}
                  </span>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => handleEdit(subjectType)}
                    className="rounded-lg bg-indigo-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-indigo-700"
                  >
                    수정
                  </button>
                  <button
                    onClick={() => handleDelete(subjectType.id, subjectType.name)}
                    className="rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-red-700"
                  >
                    삭제
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* 추가 버튼 */}
      {!isCreating && (
        <button
          onClick={handleCreate}
          className="rounded-lg border border-dashed border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50"
        >
          + 과목구분 추가
        </button>
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/SubjectTypeTable.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getSubjectTypesAction,
  deleteSubjectType,
} from "@/app/(admin)/actions/subjectActions";
import SubjectTypeFormModal from "./SubjectTypeFormModal";
import type { SubjectType } from "@/lib/data/subjects";
import { Plus, Trash2, Edit2 } from "lucide-react";

type SubjectTypeTableProps = {
  curriculumRevisionId: string;
};

export default function SubjectTypeTable({
  curriculumRevisionId,
}: SubjectTypeTableProps) {
  const toast = useToast();
  const [subjectTypes, setSubjectTypes] = useState<SubjectType[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  useEffect(() => {
    loadSubjectTypes();
  }, [curriculumRevisionId]);

  async function loadSubjectTypes() {
    setLoading(true);
    try {
      const data = await getSubjectTypesAction(curriculumRevisionId);
      setSubjectTypes(data || []);
    } catch (error) {
      console.error("과목구분 조회 실패:", error);
      toast.showError("과목구분을 불러오는데 실패했습니다.");
      setSubjectTypes([]);
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete(id: string, name: string) {
    if (
      !confirm(
        `정말 "${name}" 과목구분을 삭제하시겠습니까? 사용 중인 과목이 있으면 삭제할 수 없습니다.`
      )
    ) {
      return;
    }

    try {
      await deleteSubjectType(id);
      toast.showSuccess("과목구분이 삭제되었습니다.");
      loadSubjectTypes();
    } catch (error) {
      console.error("과목구분 삭제 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "삭제에 실패했습니다."
      );
    }
  }

  function handleEdit(subjectType: SubjectType) {
    setEditingId(subjectType.id);
    setIsCreating(false);
  }

  function handleCreate() {
    setIsCreating(true);
    setEditingId(null);
  }

  function handleSuccess() {
    setIsCreating(false);
    setEditingId(null);
    loadSubjectTypes();
  }

  function handleCancel() {
    setIsCreating(false);
    setEditingId(null);
  }

  const sortedTypes = [...subjectTypes].sort(
    (a, b) =>
      (a.display_order ?? 0) - (b.display_order ?? 0) || a.name.localeCompare(b.name)
  );

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-end">
        <button
          onClick={handleCreate}
          className="flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700"
        >
          <Plus className="h-4 w-4" />
          과목구분 추가
        </button>
      </div>

      {loading ? (
        <div className="py-8 text-center text-sm text-gray-500">
          로딩 중...
        </div>
      ) : sortedTypes.length === 0 ? (
        <div className="py-8 text-center text-sm text-gray-500">
          과목구분이 없습니다.
        </div>
      ) : (
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-gray-200">
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  과목구분명
                </th>
                <th className="px-4 py-3 text-left text-sm font-semibold text-gray-900">
                  상태
                </th>
                <th className="px-4 py-3 text-right text-sm font-semibold text-gray-900">
                  작업
                </th>
              </tr>
            </thead>
            <tbody>
              {sortedTypes.map((subjectType) => (
                <tr
                  key={subjectType.id}
                  className="border-b border-gray-100 transition hover:bg-gray-50"
                >
                  <td className="px-4 py-3 text-sm font-medium text-gray-900">
                    {subjectType.name}
                  </td>
                  <td className="px-4 py-3 text-sm">
                    <span
                      className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium ${
                        subjectType.is_active
                          ? "bg-green-100 text-green-800"
                          : "bg-gray-100 text-gray-800"
                      }`}
                    >
                      {subjectType.is_active ? "활성" : "비활성"}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-right">
                    <div className="flex items-center justify-end gap-2">
                      <button
                        onClick={() => handleEdit(subjectType)}
                        className="rounded p-1.5 text-gray-500 transition hover:bg-gray-100 hover:text-indigo-600"
                        title="수정"
                      >
                        <Edit2 className="h-4 w-4" />
                      </button>
                      <button
                        onClick={() =>
                          handleDelete(subjectType.id, subjectType.name)
                        }
                        className="rounded p-1.5 text-gray-500 transition hover:bg-gray-100 hover:text-red-600"
                        title="삭제"
                      >
                        <Trash2 className="h-4 w-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* 과목구분 생성/수정 모달 */}
      {(isCreating || editingId) && (
        <SubjectTypeFormModal
          subjectType={
            editingId
              ? subjectTypes.find((t) => t.id === editingId)
              : undefined
          }
          curriculumRevisionId={curriculumRevisionId}
          onSuccess={handleSuccess}
          onCancel={handleCancel}
        />
      )}
    </div>
  );
}
</file>

<file path="admin/subjects/_components/UnifiedSubjectForm.tsx">
"use client";

import { useState, useEffect, useTransition } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import {
  getSubjectGroupsAction,
  getSubjectsByGroupAction,
  getSubjectTypesAction,
  createSubject,
  updateSubject,
} from "@/app/(admin)/actions/subjectActions";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";
import type { SubjectGroup, Subject, SubjectType } from "@/lib/data/subjects";

type UnifiedSubjectFormProps = {
  curriculumRevisions: CurriculumRevision[];
  defaultRevisionId?: string;
  defaultGroupId?: string;
  defaultSubjectId?: string; // 수정 모드
  onSuccess: () => void;
  onCancel: () => void;
};

export default function UnifiedSubjectForm({
  curriculumRevisions,
  defaultRevisionId,
  defaultGroupId,
  defaultSubjectId,
  onSuccess,
  onCancel,
}: UnifiedSubjectFormProps) {
  const toast = useToast();
  const [isPending, startTransition] = useTransition();

  // 선택 상태
  const [selectedRevisionId, setSelectedRevisionId] = useState<string>(
    defaultRevisionId || ""
  );
  const [selectedGroupId, setSelectedGroupId] = useState<string>(
    defaultGroupId || ""
  );
  const [selectedSubjectId, setSelectedSubjectId] = useState<string>(
    defaultSubjectId || ""
  );
  const [selectedSubjectTypeId, setSelectedSubjectTypeId] = useState<string>("");

  // 입력 필드
  const [subjectName, setSubjectName] = useState<string>("");
  const [displayOrder, setDisplayOrder] = useState<number>(0);

  // 데이터
  const [subjectGroups, setSubjectGroups] = useState<SubjectGroup[]>([]);
  const [subjects, setSubjects] = useState<Subject[]>([]);
  const [subjectTypes, setSubjectTypes] = useState<SubjectType[]>([]);
  const [loadingGroups, setLoadingGroups] = useState(false);
  const [loadingSubjects, setLoadingSubjects] = useState(false);
  const [loadingTypes, setLoadingTypes] = useState(false);

  const isEditMode = !!defaultSubjectId;

  // 개정교육과정 선택 시 교과 및 과목구분 로드
  useEffect(() => {
    if (!selectedRevisionId) {
      setSubjectGroups([]);
      setSubjects([]);
      setSubjectTypes([]);
      setSelectedGroupId("");
      setSelectedSubjectId("");
      return;
    }

    setLoadingGroups(true);
    setLoadingTypes(true);

    Promise.all([
      getSubjectGroupsAction(selectedRevisionId),
      getSubjectTypesAction(selectedRevisionId),
    ])
      .then(([groups, types]) => {
        setSubjectGroups(groups || []);
        setSubjectTypes(types || []);

        // 기본 교과가 있으면 선택
        if (defaultGroupId && groups?.some((g) => g.id === defaultGroupId)) {
          setSelectedGroupId(defaultGroupId);
        }
      })
      .catch((error) => {
        console.error("데이터 로드 실패:", error);
        toast.showError("데이터를 불러오는데 실패했습니다.");
      })
      .finally(() => {
        setLoadingGroups(false);
        setLoadingTypes(false);
      });
  }, [selectedRevisionId, defaultGroupId, toast]);

  // 교과 선택 시 과목 목록 로드
  useEffect(() => {
    if (!selectedGroupId) {
      setSubjects([]);
      setSelectedSubjectId("");
      return;
    }

    setLoadingSubjects(true);

    getSubjectsByGroupAction(selectedGroupId)
      .then((data) => {
        setSubjects(data || []);

        // 수정 모드이고 기본 과목이 있으면 선택 및 정보 로드
        if (defaultSubjectId && data?.some((s) => s.id === defaultSubjectId)) {
          setSelectedSubjectId(defaultSubjectId);
          const subject = data.find((s) => s.id === defaultSubjectId);
          if (subject) {
            setSubjectName(subject.name);
            setDisplayOrder(subject.display_order ?? 0);
            setSelectedSubjectTypeId(subject.subject_type_id || "");
          }
        } else {
          // 생성 모드: 과목 선택 초기화
          setSelectedSubjectId("");
          setSubjectName("");
          setDisplayOrder(0);
          setSelectedSubjectTypeId("");
        }
      })
      .catch((error) => {
        console.error("과목 목록 로드 실패:", error);
        toast.showError("과목 목록을 불러오는데 실패했습니다.");
      })
      .finally(() => {
        setLoadingSubjects(false);
      });
  }, [selectedGroupId, defaultSubjectId, toast]);

  // 초기 로드 (수정 모드)
  useEffect(() => {
    if (defaultRevisionId) {
      setSelectedRevisionId(defaultRevisionId);
    }
  }, [defaultRevisionId]);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    if (!selectedRevisionId) {
      toast.showError("개정교육과정을 선택해주세요.");
      return;
    }

    if (!selectedGroupId) {
      toast.showError("교과를 선택해주세요.");
      return;
    }

    if (!subjectName.trim()) {
      toast.showError("과목명을 입력해주세요.");
      return;
    }

    startTransition(async () => {
      try {
        const formData = new FormData();
        formData.append("subject_group_id", selectedGroupId);
        formData.append("name", subjectName.trim());
        formData.append("display_order", displayOrder.toString());
        if (selectedSubjectTypeId) {
          formData.append("subject_type_id", selectedSubjectTypeId);
        }

        if (isEditMode && selectedSubjectId) {
          await updateSubject(selectedSubjectId, formData);
          toast.showSuccess("과목이 수정되었습니다.");
        } else {
          await createSubject(formData);
          toast.showSuccess("과목이 생성되었습니다.");
        }

        onSuccess();
      } catch (error) {
        console.error("과목 저장 실패:", error);
        toast.showError(
          error instanceof Error ? error.message : "저장에 실패했습니다."
        );
      }
    });
  }

  return (
    <form onSubmit={handleSubmit} className="flex flex-col gap-4">
      <h3 className="text-lg font-semibold text-gray-900">
        {isEditMode ? "과목 수정" : "과목 생성"}
      </h3>

      <div className="grid gap-4 md:grid-cols-2">
        {/* 개정교육과정 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            개정교육과정 <span className="text-red-500">*</span>
          </label>
          <select
            value={selectedRevisionId}
            onChange={(e) => {
              setSelectedRevisionId(e.target.value);
              setSelectedGroupId("");
              setSelectedSubjectId("");
              setSubjectName("");
              setDisplayOrder(0);
              setSelectedSubjectTypeId("");
            }}
            disabled={isPending || isEditMode}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
            required
          >
            <option value="">선택하세요</option>
            {curriculumRevisions.map((revision) => (
              <option key={revision.id} value={revision.id}>
                {revision.name}
              </option>
            ))}
          </select>
        </div>

        {/* 교과 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            교과 <span className="text-red-500">*</span>
          </label>
          <select
            value={selectedGroupId}
            onChange={(e) => {
              setSelectedGroupId(e.target.value);
              setSelectedSubjectId("");
              setSubjectName("");
              setDisplayOrder(0);
              setSelectedSubjectTypeId("");
            }}
            disabled={
              isPending ||
              !selectedRevisionId ||
              loadingGroups ||
              isEditMode
            }
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
            required
          >
            <option value="">
              {loadingGroups
                ? "로딩 중..."
                : !selectedRevisionId
                ? "개정교육과정을 먼저 선택하세요"
                : "선택하세요"}
            </option>
            {subjectGroups.map((group) => (
              <option key={group.id} value={group.id}>
                {group.name}
              </option>
            ))}
          </select>
        </div>

        {/* 과목 선택 (수정 모드만) */}
        {isEditMode && (
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium text-gray-700">
              과목 <span className="text-red-500">*</span>
            </label>
            <select
              value={selectedSubjectId}
              onChange={(e) => {
                const subjectId = e.target.value;
                setSelectedSubjectId(subjectId);
                const subject = subjects.find((s) => s.id === subjectId);
                if (subject) {
                  setSubjectName(subject.name);
                  setDisplayOrder(subject.display_order ?? 0);
                  setSelectedSubjectTypeId(subject.subject_type_id || "");
                } else {
                  setSubjectName("");
                  setDisplayOrder(0);
                  setSelectedSubjectTypeId("");
                }
              }}
              disabled={isPending || !selectedGroupId || loadingSubjects}
              className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
              required
            >
              <option value="">
                {loadingSubjects
                  ? "로딩 중..."
                  : !selectedGroupId
                  ? "교과를 먼저 선택하세요"
                  : "선택하세요"}
              </option>
              {subjects.map((subject) => (
                <option key={subject.id} value={subject.id}>
                  {subject.name}
                </option>
              ))}
            </select>
          </div>
        )}

        {/* 과목구분 선택 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목구분
          </label>
          <select
            value={selectedSubjectTypeId}
            onChange={(e) => setSelectedSubjectTypeId(e.target.value)}
            disabled={
              isPending || !selectedRevisionId || loadingTypes
            }
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
          >
            <option value="">
              {loadingTypes
                ? "로딩 중..."
                : !selectedRevisionId
                ? "개정교육과정을 먼저 선택하세요"
                : "선택 안 함"}
            </option>
            {subjectTypes.map((type) => (
              <option key={type.id} value={type.id}>
                {type.name}
              </option>
            ))}
          </select>
        </div>

        {/* 과목명 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            과목명 <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={subjectName}
            onChange={(e) => setSubjectName(e.target.value)}
            placeholder="예: 수학Ⅰ"
            disabled={isPending}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
            required
          />
        </div>

        {/* 표시 순서 */}
        <div className="flex flex-col gap-1">
          <label className="block text-sm font-medium text-gray-700">
            표시 순서
          </label>
          <input
            type="number"
            value={displayOrder}
            onChange={(e) => setDisplayOrder(Number(e.target.value) || 0)}
            min="0"
            disabled={isPending}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
          />
        </div>
      </div>

      {/* 버튼 */}
      <div className="flex gap-2 justify-end">
        <button
          type="button"
          onClick={onCancel}
          disabled={isPending}
          className="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50"
        >
          취소
        </button>
        <button
          type="submit"
          disabled={isPending}
          className="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-indigo-700 disabled:opacity-50"
        >
          {isPending
            ? isEditMode
              ? "수정 중..."
              : "생성 중..."
            : isEditMode
            ? "수정"
            : "생성"}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="admin/subjects/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { getCurriculumRevisionsAction } from "@/app/(admin)/actions/contentMetadataActions";
import { exportSubjectsToExcel, downloadSubjectsTemplate } from "@/app/(admin)/actions/subjects/export";
import { importSubjectsFromExcel } from "@/app/(admin)/actions/subjects/import";
import CurriculumRevisionTabs from "./_components/CurriculumRevisionTabs";
import ExcelImportDialog from "@/components/admin/ExcelImportDialog";
import Button from "@/components/atoms/Button";
import type { CurriculumRevision } from "@/lib/data/contentMetadata";

export default function SubjectsPage() {
  const toast = useToast();
  const [revisions, setRevisions] = useState<CurriculumRevision[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedRevisionId, setSelectedRevisionId] = useState<string | null>(null);
  const [showImportDialog, setShowImportDialog] = useState(false);
  const [isExporting, setIsExporting] = useState(false);

  useEffect(() => {
    loadRevisions();
  }, []);

  async function loadRevisions() {
    setLoading(true);
    try {
      const data = await getCurriculumRevisionsAction();
      setRevisions(data || []);
      // 첫 번째 개정교육과정을 기본으로 선택
      if (data && data.length > 0 && !selectedRevisionId) {
        const firstRevision = data[0];
        if (firstRevision?.id) {
          setSelectedRevisionId(firstRevision.id);
        }
      }
    } catch (error) {
      console.error("개정교육과정 조회 실패:", error);
      toast.showError("개정교육과정을 불러오는데 실패했습니다.");
      setRevisions([]);
    } finally {
      setLoading(false);
    }
  }

  function handleRevisionChange(revisionId: string) {
    setSelectedRevisionId(revisionId);
  }

  function handleRefresh() {
    loadRevisions();
  }

  async function handleExport() {
    setIsExporting(true);
    try {
      const buffer = await exportSubjectsToExcel();
      // Buffer를 Uint8Array로 변환하여 Blob 생성
      const uint8Array = new Uint8Array(buffer);
      const blob = new Blob([uint8Array], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `교과과목관리_${new Date().toISOString().split("T")[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.showSuccess("Excel 파일을 다운로드했습니다.");
    } catch (error) {
      console.error("Excel 다운로드 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "Excel 파일 다운로드에 실패했습니다."
      );
    } finally {
      setIsExporting(false);
    }
  }

  async function handleDownloadTemplate() {
    setIsExporting(true);
    try {
      const buffer = await downloadSubjectsTemplate();
      // Buffer를 Uint8Array로 변환하여 Blob 생성
      const uint8Array = new Uint8Array(buffer);
      const blob = new Blob([uint8Array], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "교과과목관리_양식.xlsx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      toast.showSuccess("양식 파일을 다운로드했습니다.");
    } catch (error) {
      console.error("양식 다운로드 실패:", error);
      toast.showError(
        error instanceof Error ? error.message : "양식 파일 다운로드에 실패했습니다."
      );
    } finally {
      setIsExporting(false);
    }
  }

  async function handleImport(file: File): Promise<{ success: boolean; message: string; errors?: string[] }> {
    const arrayBuffer = await file.arrayBuffer();
    // Server Action에서 Buffer로 변환하기 위해 Uint8Array로 전달
    const uint8Array = new Uint8Array(arrayBuffer);
    return importSubjectsFromExcel(uint8Array as any);
  }

  const sortedRevisions = [...revisions].sort(
    (a, b) => {
      const orderA = a.display_order ?? 0;
      const orderB = b.display_order ?? 0;
      const orderDiff = orderA - orderB;
      return orderDiff !== 0 ? orderDiff : a.name.localeCompare(b.name);
    }
  );

  return (
    <section className="mx-auto w-full max-w-7xl px-4 py-8">
      <div className="flex items-start justify-between">
        <div className="flex flex-col gap-2">
          <h1 className="text-3xl font-semibold text-gray-900">교과/과목 관리</h1>
          <p className="text-sm text-gray-500">
            개정교육과정, 교과, 과목, 과목구분을 통합 관리합니다.
          </p>
        </div>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={handleDownloadTemplate}
              isLoading={isExporting}
            >
              양식 다운로드
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={handleExport}
              isLoading={isExporting}
            >
              Excel 다운로드
            </Button>
            <Button
              variant="primary"
              size="sm"
              onClick={() => setShowImportDialog(true)}
            >
              Excel 업로드
            </Button>
          </div>
        </div>

      {loading ? (
        <div className="py-8 text-center text-sm text-gray-500">
          로딩 중...
        </div>
      ) : sortedRevisions.length === 0 ? (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center">
          <p className="text-sm text-gray-500">
            개정교육과정이 없습니다. 개정교육과정을 생성해주세요.
          </p>
        </div>
      ) : (
        <CurriculumRevisionTabs
          revisions={sortedRevisions}
          selectedRevisionId={selectedRevisionId}
          onRevisionChange={handleRevisionChange}
          onRefresh={handleRefresh}
        />
      )}

      <ExcelImportDialog
        open={showImportDialog}
        onOpenChange={setShowImportDialog}
        onImport={handleImport}
        title="교과/과목 관리 Excel 업로드"
        description="Excel 파일을 선택하여 교과/과목 데이터를 업로드하세요. 기존 데이터는 모두 삭제되고 새 데이터로 교체됩니다."
      />
    </section>
  );
}
</file>

<file path="admin/tenant/settings/_components/TenantSettingsForm.tsx">
"use client";

import { useState, useEffect } from "react";
import {
  getAutoApproveSettings,
  updateAutoApproveSettings,
  type AutoApproveSettings,
  type ParentRelation,
} from "@/app/(admin)/actions/tenantSettingsActions";

type Tenant = {
  id: string;
  name: string;
  type: string;
};

type TenantSettingsFormProps = {
  tenant: Tenant;
  stats: {
    students: number;
    parents: number;
    admins: number;
  };
};

export function TenantSettingsForm({ tenant, stats }: TenantSettingsFormProps) {
  const [name, setName] = useState(tenant.name);
  const [type, setType] = useState(tenant.type);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);

  // 자동 승인 설정 상태
  const [autoApproveSettings, setAutoApproveSettings] = useState<AutoApproveSettings>({
    enabled: false,
    conditions: {
      sameTenantOnly: true,
      allowedRelations: ["father", "mother"],
    },
  });
  const [isLoadingAutoApprove, setIsLoadingAutoApprove] = useState(true);
  const [isSavingAutoApprove, setIsSavingAutoApprove] = useState(false);
  const [autoApproveMessage, setAutoApproveMessage] = useState<{
    type: "success" | "error";
    text: string;
  } | null>(null);

  // 자동 승인 설정 로드
  useEffect(() => {
    async function loadAutoApproveSettings() {
      setIsLoadingAutoApprove(true);
      const result = await getAutoApproveSettings(tenant.id);

      if (result.success && result.data) {
        setAutoApproveSettings(result.data);
      } else {
        setAutoApproveMessage({
          type: "error",
          text: result.error || "자동 승인 설정을 불러올 수 없습니다.",
        });
      }
      setIsLoadingAutoApprove(false);
    }

    loadAutoApproveSettings();
  }, [tenant.id]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setMessage(null);

    try {
      const response = await fetch(`/api/tenants/${tenant.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, type }),
      });

      if (!response.ok) {
        throw new Error("저장 실패");
      }

      setMessage({ type: "success", text: "기관 정보가 저장되었습니다." });
    } catch (error) {
      console.error("[tenant] 저장 실패", error);
      setMessage({ type: "error", text: "기관 정보 저장에 실패했습니다." });
    } finally {
      setIsSubmitting(false);
    }
  };

  // 자동 승인 설정 저장
  const handleSaveAutoApprove = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSavingAutoApprove(true);
    setAutoApproveMessage(null);

    try {
      const result = await updateAutoApproveSettings(
        autoApproveSettings,
        tenant.id
      );

      if (result.success) {
        setAutoApproveMessage({
          type: "success",
          text: "자동 승인 설정이 저장되었습니다.",
        });
      } else {
        setAutoApproveMessage({
          type: "error",
          text: result.error || "자동 승인 설정 저장에 실패했습니다.",
        });
      }
    } catch (error) {
      console.error("[tenant] 자동 승인 설정 저장 실패", error);
      setAutoApproveMessage({
        type: "error",
        text: "자동 승인 설정 저장 중 오류가 발생했습니다.",
      });
    } finally {
      setIsSavingAutoApprove(false);
    }
  };

  // 관계 선택 토글
  const toggleRelation = (relation: ParentRelation) => {
    setAutoApproveSettings((prev) => {
      const relations = prev.conditions.allowedRelations;
      const newRelations = relations.includes(relation)
        ? relations.filter((r) => r !== relation)
        : [...relations, relation];

      return {
        ...prev,
        conditions: {
          ...prev.conditions,
          allowedRelations: newRelations,
        },
      };
    });
  };

  const relationLabels: Record<ParentRelation, string> = {
    father: "아버지",
    mother: "어머니",
    guardian: "보호자",
    other: "기타",
  };

  return (
    <div className="space-y-6">
      {/* 통계 카드 */}
      <div className="grid gap-4 md:grid-cols-3">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-500">학생 수</div>
          <div className="text-2xl font-semibold">{stats.students}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-500">학부모 수</div>
          <div className="text-2xl font-semibold">{stats.parents}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-500">관리자 수</div>
          <div className="text-2xl font-semibold">{stats.admins}</div>
        </div>
      </div>

      {/* 기관 정보 수정 폼 */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="text-xl font-semibold">기관 정보</h2>

        {message && (
          <div
            className={`rounded-lg p-3 ${
              message.type === "success"
                ? "bg-green-50 text-green-700"
                : "bg-red-50 text-red-700"
            }`}
          >
            {message.text}
          </div>
        )}

        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium">기관명</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
              className="w-full rounded border px-3 py-2"
              placeholder="예: 서울학원"
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="block text-sm font-medium">유형</label>
            <select
              value={type}
              onChange={(e) => setType(e.target.value)}
              className="w-full rounded border px-3 py-2"
            >
              <option value="academy">학원</option>
              <option value="school">학교</option>
              <option value="enterprise">기업</option>
              <option value="other">기타</option>
            </select>
          </div>

          <div className="flex justify-end">
            <button
              type="submit"
              disabled={isSubmitting}
              className="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50"
            >
              {isSubmitting ? "저장 중..." : "저장"}
            </button>
          </div>
        </form>
      </div>

      {/* 자동 승인 설정 */}
      <div className="flex flex-col gap-4 rounded-lg border border-gray-200 bg-white p-6">
        <div className="flex flex-col gap-4">
          <h2 className="text-xl font-semibold">학부모 연결 자동 승인</h2>
          <p className="text-sm text-gray-600">
            조건을 만족하는 연결 요청을 자동으로 승인할 수 있습니다.
          </p>
        </div>

        {autoApproveMessage && (
          <div
            className={`rounded-lg p-3 ${
              autoApproveMessage.type === "success"
                ? "bg-green-50 text-green-700"
                : "bg-red-50 text-red-700"
            }`}
          >
            {autoApproveMessage.text}
          </div>
        )}

        {isLoadingAutoApprove ? (
          <div className="py-4 text-center text-sm text-gray-500">
            설정을 불러오는 중...
          </div>
        ) : (
          <form onSubmit={handleSaveAutoApprove} className="space-y-4">
            {/* 자동 승인 활성화 토글 */}
            <div className="flex items-center gap-3">
              <input
                type="checkbox"
                id="autoApproveEnabled"
                checked={autoApproveSettings.enabled}
                onChange={(e) =>
                  setAutoApproveSettings((prev) => ({
                    ...prev,
                    enabled: e.target.checked,
                  }))
                }
                className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
              />
              <label
                htmlFor="autoApproveEnabled"
                className="text-sm font-medium text-gray-900"
              >
                자동 승인 활성화
              </label>
            </div>

            {/* 조건 설정 (활성화 시에만 표시) */}
            {autoApproveSettings.enabled && (
              <div className="space-y-4 rounded-lg border border-gray-200 bg-gray-50 p-4">
                {/* 같은 테넌트만 체크박스 */}
                <div className="flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="sameTenantOnly"
                    checked={autoApproveSettings.conditions.sameTenantOnly}
                    onChange={(e) =>
                      setAutoApproveSettings((prev) => ({
                        ...prev,
                        conditions: {
                          ...prev.conditions,
                          sameTenantOnly: e.target.checked,
                        },
                      }))
                    }
                    className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                  />
                  <label
                    htmlFor="sameTenantOnly"
                    className="text-sm font-medium text-gray-900"
                  >
                    같은 테넌트 내에서만 자동 승인
                  </label>
                </div>

                {/* 관계 선택 다중 선택 */}
                <div className="flex flex-col gap-2">
                  <label className="block text-sm font-medium text-gray-900">
                    자동 승인할 관계 선택
                  </label>
                  <div className="flex flex-wrap gap-3">
                    {(
                      ["father", "mother", "guardian", "other"] as ParentRelation[]
                    ).map((relation) => (
                      <label
                        key={relation}
                        className="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 transition hover:bg-gray-50"
                      >
                        <input
                          type="checkbox"
                          checked={autoApproveSettings.conditions.allowedRelations.includes(
                            relation
                          )}
                          onChange={() => toggleRelation(relation)}
                          className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                        />
                        <span className="text-sm text-gray-700">
                          {relationLabels[relation]}
                        </span>
                      </label>
                    ))}
                  </div>
                  {autoApproveSettings.conditions.allowedRelations.length ===
                    0 && (
                    <p className="text-xs text-red-600">
                      최소 하나 이상의 관계를 선택해야 합니다.
                    </p>
                  )}
                </div>
              </div>
            )}

            <div className="flex justify-end">
              <button
                type="submit"
                disabled={
                  isSavingAutoApprove ||
                  autoApproveSettings.conditions.allowedRelations.length === 0
                }
                className="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50"
              >
                {isSavingAutoApprove ? "저장 중..." : "설정 저장"}
              </button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
</file>

<file path="admin/tenant/settings/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { TenantSettingsForm } from "./_components/TenantSettingsForm";

export default async function TenantSettingsPage() {
  const tenantContext = await getTenantContext();

  // Admin/Consultant만 접근 가능
  if (
    tenantContext?.role !== "admin" &&
    tenantContext?.role !== "consultant"
  ) {
    redirect("/admin/dashboard");
  }

  if (!tenantContext.tenantId) {
    return (
      <div className="mx-auto max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-6 text-center text-red-700">
          기관 정보를 찾을 수 없습니다.
        </div>
      </div>
    );
  }

  const supabase = await createSupabaseServerClient();
  const { data: tenant, error } = await supabase
    .from("tenants")
    .select("id, name, type")
    .eq("id", tenantContext.tenantId)
    .single();

  if (error) {
    console.error("[tenant] 기관 정보 조회 실패", error);
  }

  // 소속 사용자 수 조회
  const { count: studentCount } = await supabase
    .from("students")
    .select("*", { count: "exact", head: true })
    .eq("tenant_id", tenantContext.tenantId);

  const { count: parentCount } = await supabase
    .from("parent_users")
    .select("*", { count: "exact", head: true })
    .eq("tenant_id", tenantContext.tenantId);

  const { count: adminCount } = await supabase
    .from("admin_users")
    .select("*", { count: "exact", head: true })
    .eq("tenant_id", tenantContext.tenantId);

  return (
    <div className="mx-auto max-w-4xl px-4 py-10">
      <div className="mb-8">
        <h1 className="text-3xl font-semibold">기관 설정</h1>
        <p className="mt-2 text-sm text-gray-500">
          기관 정보를 관리하고 소속 멤버를 확인할 수 있습니다.
        </p>
      </div>

      {tenant ? (
        <TenantSettingsForm
          tenant={tenant}
          stats={{
            students: studentCount ?? 0,
            parents: parentCount ?? 0,
            admins: adminCount ?? 0,
          }}
        />
      ) : (
        <div className="rounded-lg border border-gray-200 bg-white p-6">
          <p className="text-gray-500">기관 정보를 불러올 수 없습니다.</p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="admin/tenant/users/_components/TenantUsersManagement.tsx">
"use client";

import { useState, useEffect } from "react";
import { useToast } from "@/components/ui/ToastProvider";
import { Spinner } from "@/components/atoms/Spinner";
import {
  getTenantUsersAction,
  assignUserToTenantAction,
} from "@/app/(admin)/actions/tenantUsers";
import type { TenantUser } from "@/app/(admin)/actions/tenantUsers";

type TenantUsersManagementProps = {
  tenantId: string;
};

export function TenantUsersManagement({
  tenantId,
}: TenantUsersManagementProps) {
  const { showSuccess, showError } = useToast();
  const [loading, setLoading] = useState(true);
  const [users, setUsers] = useState<TenantUser[]>([]);
  const [filter, setFilter] = useState<"all" | "students" | "parents">("all");
  const [searchQuery, setSearchQuery] = useState("");

  useEffect(() => {
    loadUsers();
  }, [tenantId]);

  const loadUsers = async () => {
    setLoading(true);
    try {
      const data = await getTenantUsersAction(tenantId);
      setUsers(data);
    } catch (error) {
      console.error("Failed to load users:", error);
      showError("사용자 목록을 불러오는데 실패했습니다.");
    } finally {
      setLoading(false);
    }
  };

  const handleAssignToTenant = async (
    userId: string,
    userType: "student" | "parent"
  ) => {
    try {
      const result = await assignUserToTenantAction(userId, tenantId, userType);
      if (result.success) {
        showSuccess("사용자가 기관에 할당되었습니다.");
        loadUsers();
      } else {
        showError(result.error || "사용자 할당에 실패했습니다.");
      }
    } catch (error) {
      console.error("Failed to assign user:", error);
      showError("사용자 할당 중 오류가 발생했습니다.");
    }
  };

  const filteredUsers = users.filter((user) => {
    // 필터 적용
    if (filter === "students" && user.type !== "student") return false;
    if (filter === "parents" && user.type !== "parent") return false;

    // 검색어 적용
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const isStudent = user.type === "student";
      return (
        user.name?.toLowerCase().includes(query) ||
        user.email?.toLowerCase().includes(query) ||
        (isStudent && user.grade?.toLowerCase().includes(query))
      );
    }

    return true;
  });

  const stats = {
    total: users.length,
    students: users.filter((u) => u.type === "student").length,
    parents: users.filter((u) => u.type === "parent").length,
    unassigned: users.filter((u) => !u.tenant_id).length,
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Spinner />
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      {/* 통계 카드 */}
      <div className="grid grid-cols-1 gap-4 md:grid-cols-4">
        <div className="flex flex-col gap-2 rounded-xl border border-gray-300 bg-white p-6">
          <div className="text-body-2 text-gray-600">전체 사용자</div>
          <div className="text-h2 text-gray-900">{stats.total}</div>
        </div>
        <div className="flex flex-col gap-2 rounded-xl border border-gray-300 bg-white p-6">
          <div className="text-body-2 text-gray-600">학생</div>
          <div className="text-h2 text-gray-900">{stats.students}</div>
        </div>
        <div className="flex flex-col gap-2 rounded-xl border border-gray-300 bg-white p-6">
          <div className="text-body-2 text-gray-600">학부모</div>
          <div className="text-h2 text-gray-900">{stats.parents}</div>
        </div>
        <div className="flex flex-col gap-2 rounded-xl border border-gray-300 bg-white p-6">
          <div className="text-body-2 text-gray-600">미할당</div>
          <div className="text-h2 text-gray-900">{stats.unassigned}</div>
        </div>
      </div>

      {/* 필터 및 검색 */}
      <div className="flex flex-col gap-4 rounded-xl border border-gray-300 bg-white p-6 md:flex-row md:items-center md:justify-between">
        <div className="flex gap-2">
          <button
            onClick={() => setFilter("all")}
            className={`rounded-lg px-4 py-2 text-body-2 font-semibold transition ${
              filter === "all"
                ? "bg-gray-900 text-white"
                : "bg-gray-100 text-gray-700 hover:bg-gray-200"
            }`}
          >
            전체
          </button>
          <button
            onClick={() => setFilter("students")}
            className={`rounded-lg px-4 py-2 text-body-2 font-semibold transition ${
              filter === "students"
                ? "bg-gray-900 text-white"
                : "bg-gray-100 text-gray-700 hover:bg-gray-200"
            }`}
          >
            학생
          </button>
          <button
            onClick={() => setFilter("parents")}
            className={`rounded-lg px-4 py-2 text-body-2 font-semibold transition ${
              filter === "parents"
                ? "bg-gray-900 text-white"
                : "bg-gray-100 text-gray-700 hover:bg-gray-200"
            }`}
          >
            학부모
          </button>
        </div>

        <input
          type="text"
          placeholder="이름, 이메일, 학년으로 검색..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="w-full rounded-lg border border-gray-300 px-4 py-2 text-body-2 text-gray-900 md:w-64"
        />
      </div>

      {/* 사용자 목록 */}
      <div className="rounded-xl border border-gray-300 bg-white">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="border-b border-gray-300 bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-body-2-bold text-gray-800">
                  이름
                </th>
                <th className="px-6 py-3 text-left text-body-2-bold text-gray-800">
                  이메일
                </th>
                <th className="px-6 py-3 text-left text-body-2-bold text-gray-800">
                  유형
                </th>
                <th className="px-6 py-3 text-left text-body-2-bold text-gray-800">
                  정보
                </th>
                <th className="px-6 py-3 text-left text-body-2-bold text-gray-800">
                  기관
                </th>
                <th className="px-6 py-3 text-left text-body-2-bold text-gray-800">
                  작업
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-300">
              {filteredUsers.length === 0 ? (
                <tr>
                  <td
                    colSpan={6}
                    className="px-6 py-8 text-center text-body-2 text-gray-600"
                  >
                    {searchQuery
                      ? "검색 결과가 없습니다."
                      : "사용자가 없습니다."}
                  </td>
                </tr>
              ) : (
                filteredUsers.map((user) => (
                  <tr key={user.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 text-body-2 text-gray-900">
                      {user.name || "-"}
                    </td>
                    <td className="px-6 py-4 text-body-2 text-gray-900">
                      {user.email || "-"}
                    </td>
                    <td className="px-6 py-4">
                      <span
                        className={`inline-flex rounded-full px-3 py-1 text-xs font-semibold ${
                          user.type === "student"
                            ? "bg-blue-100 text-blue-800"
                            : "bg-green-100 text-green-800"
                        }`}
                      >
                        {user.type === "student" ? "학생" : "학부모"}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-body-2 text-gray-900">
                      {user.type === "student" ? (
                        <span>
                          {user.grade || "-"} 학년
                        </span>
                      ) : (
                        <span>
                          {user.relationship || "-"}
                        </span>
                      )}
                    </td>
                    <td className="px-6 py-4 text-body-2 text-gray-900">
                      {user.tenant_id ? (
                        <span className="text-green-600">할당됨</span>
                      ) : (
                        <span className="text-red-600">미할당</span>
                      )}
                    </td>
                    <td className="px-6 py-4">
                      {!user.tenant_id || user.tenant_id !== tenantId ? (
                        <button
                          onClick={() =>
                            handleAssignToTenant(user.id, user.type)
                          }
                          className="rounded-lg bg-indigo-600 px-4 py-2 text-body-2 font-semibold text-white hover:bg-indigo-700"
                        >
                          {user.tenant_id ? "이동" : "할당"}
                        </button>
                      ) : (
                        <span className="text-body-2 text-gray-600">
                          현재 기관
                        </span>
                      )}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="admin/tenant/users/page.tsx">
export const dynamic = "force-dynamic";

import { redirect } from "next/navigation";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { TenantUsersManagement } from "./_components/TenantUsersManagement";

export default async function TenantUsersPage() {
  const tenantContext = await getTenantContext();

  // Admin만 접근 가능
  if (tenantContext?.role !== "admin") {
    redirect("/admin/dashboard");
  }

  if (!tenantContext.tenantId) {
    return (
      <div className="mx-auto max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-6 text-center text-red-700">
          기관 정보를 찾을 수 없습니다.
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto flex max-w-6xl flex-col gap-8 px-4 py-10">
      <div className="flex flex-col gap-2">
        <h1 className="text-h1 text-gray-900">기관별 사용자 관리</h1>
        <p className="text-body-2 text-gray-600">
          기관별 학생 및 학부모를 조회하고 관리할 수 있습니다.
        </p>
      </div>

      <TenantUsersManagement tenantId={tenantContext.tenantId} />
    </div>
  );
}
</file>

<file path="admin/time-management/_components/TemplateBlockSetManagement.tsx">
"use client";

import { useEffect, useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import TemplateBlocksViewer from "../[templateId]/_components/TemplateBlocksViewer";
import { getTenantBlockSets } from "@/app/(admin)/actions/tenantBlockSets";

type BlockSet = {
  id: string;
  name: string;
  description?: string | null;
  blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
};

type TemplateBlockSetManagementProps = {
  initialBlockSets?: Array<{ 
    id: string; 
    name: string; 
    description?: string | null;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }> 
  }>;
};

export default function TemplateBlockSetManagement({
  initialBlockSets = [],
}: TemplateBlockSetManagementProps) {
  const router = useRouter();
  const [blockSets, setBlockSets] = useState<BlockSet[]>(initialBlockSets.map(set => ({
    id: set.id,
    name: set.name,
    description: set.description ?? null,
    blocks: set.blocks ?? [],
  })));
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // 특정 세트의 블록만 업데이트
  const updateSetBlocks = useCallback(async (setId: string) => {
    try {
      const data = await getTenantBlockSets();
      
      const updatedSet = data.find(s => s.id === setId);
      if (updatedSet) {
        setBlockSets((prevSets) =>
          prevSets.map((set) =>
            set.id === setId
              ? { ...set, blocks: updatedSet.blocks ?? [] }
              : set
          )
        );
      }
    } catch (error) {
      console.error(`세트 ${setId}의 블록 조회 실패:`, error);
    }
  }, []);

  // 전체 데이터 로드
  const loadData = useCallback(async (skipLoadingState = false) => {
    try {
      if (!skipLoadingState) {
        setIsLoading(true);
        setError(null);
      }

      const data = await getTenantBlockSets();

      const updatedSets = (data || []).map(set => ({
        id: set.id,
        name: set.name,
        description: null,
        blocks: set.blocks ?? [],
      }));

      setBlockSets(updatedSets);
      setError(null);
    } catch (error: any) {
      console.error("블록 데이터 로드 실패:", error);
      const errorMessage = error?.message || "블록 데이터를 불러오는 중 오류가 발생했습니다.";
      setError(errorMessage);
    } finally {
      if (!skipLoadingState) {
        setIsLoading(false);
      }
    }
  }, []);

  // 초기 마운트 시 서버 데이터 사용
  useEffect(() => {
    if (initialBlockSets.length === 0) {
      loadData(true);
    }
  }, [loadData, initialBlockSets.length]);

  return (
    <div>
      {/* 에러 메시지 */}
      {error && (
        <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0">
              <span className="text-2xl">⚠️</span>
            </div>
            <div className="flex flex-col gap-3 flex-1">
              <h3 className="text-sm font-semibold text-red-800">
                데이터 로드 실패
              </h3>
              <p className="text-sm text-red-700">{error}</p>
              <button
                type="button"
                onClick={() => loadData()}
                className="text-sm text-red-700 hover:text-red-900 underline font-medium"
              >
                다시 시도
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 블록 뷰어 */}
      <TemplateBlocksViewer 
        templateId={null} // 템플릿 ID 없이 사용
        blocks={[]} 
        blockSets={blockSets} 
        selectedBlockSetId={null}
        isLoading={isLoading}
        onCreateSetSuccess={async () => {
          router.refresh();
        }}
        onBlockChange={updateSetBlocks}
        existingSetCount={blockSets.length}
      />
    </div>
  );
}
</file>

<file path="admin/time-management/[templateId]/_components/TemplateBlockForm.tsx">
"use client";

import { useState, useActionState, useEffect } from "react";
import { addTenantBlock } from "@/app/(admin)/actions/tenantBlockSets";
import { useToast } from "@/components/ui/ToastProvider";

type TemplateBlockFormState = {
  error: string | null;
  success: boolean;
};

const initialState: TemplateBlockFormState = {
  error: null,
  success: false,
};

type TemplateBlockFormProps = {
  onClose?: () => void;
  blockSetId?: string | null;
  onBlockChange?: (setId: string) => void | Promise<void>;
};

export default function TemplateBlockForm({ 
  onClose, 
  blockSetId, 
  onBlockChange 
}: TemplateBlockFormProps) {
  const toast = useToast();
  const [selectedWeekdays, setSelectedWeekdays] = useState<number[]>([]);
  const [startTime, setStartTime] = useState<string>("");
  const [endTime, setEndTime] = useState<string>("");

  const [state, formAction, isPending] = useActionState(
    async (
      _prev: TemplateBlockFormState,
      formData: FormData
    ): Promise<TemplateBlockFormState> => {
      try {
        if (!blockSetId) {
          return { error: "블록 세트 ID가 필요합니다.", success: false };
        }

        if (selectedWeekdays.length === 0) {
          return { error: "최소 1개 이상의 요일을 선택해주세요.", success: false };
        }

        // 각 요일별로 블록 추가
        const errors: string[] = [];
        let successCount = 0;

        for (const day of selectedWeekdays) {
          const blockFormData = new FormData();
          blockFormData.append("day", String(day));
          blockFormData.append("start_time", formData.get("start_time") as string);
          blockFormData.append("end_time", formData.get("end_time") as string);
          blockFormData.append("block_set_id", blockSetId);
          
          try {
            await addTenantBlock(blockFormData);
            successCount++;
          } catch (blockError: any) {
            const dayLabel = ["일", "월", "화", "수", "목", "금", "토"][day];
            errors.push(`${dayLabel}요일: ${blockError.message || "추가 실패"}`);
          }
        }

        if (successCount === 0) {
          return { 
            error: `모든 블록 추가에 실패했습니다:\n${errors.join("\n")}`, 
            success: false 
          };
        }

        if (errors.length > 0) {
          return { 
            error: `${successCount}개 블록이 추가되었습니다. 일부 실패:\n${errors.join("\n")}`, 
            success: true 
          };
        }

        return { error: null, success: true };
      } catch (err: any) {
        return { error: err.message || "블록 추가에 실패했습니다.", success: false };
      }
    },
    initialState
  );

  const toggleWeekday = (day: number) => {
    setSelectedWeekdays((prev) =>
      prev.includes(day) ? prev.filter((d) => d !== day) : [...prev, day]
    );
  };

  // 성공 시 폼 리셋 및 닫기
  useEffect(() => {
    if (state.success) {
      setSelectedWeekdays([]);
      setStartTime("");
      setEndTime("");
      
      if (blockSetId && onBlockChange) {
        onBlockChange(blockSetId);
      }
      
      if (state.error) {
        toast.showInfo(state.error);
      } else {
        toast.showSuccess("블록이 성공적으로 추가되었습니다.");
      }
      
      const timer = setTimeout(() => {
        if (onClose) {
          onClose();
        }
      }, 1500);
      return () => clearTimeout(timer);
    }
  }, [state.success, onClose, blockSetId, onBlockChange, state.error, toast]);

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="flex flex-col gap-4 bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-semibold text-gray-900">
            새 시간 블록 추가
          </h2>
          {onClose && (
            <button
              type="button"
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 transition-colors"
              disabled={isPending}
            >
              <span className="text-2xl">×</span>
            </button>
          )}
        </div>

        {state.error && !state.success && (
          <div className="p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded">
            {state.error}
          </div>
        )}

        {state.success && (
          <div className="p-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded">
            {state.error || "블록이 성공적으로 추가되었습니다."}
          </div>
        )}

        <form action={formAction} className="flex flex-col gap-4">
          <div className="flex flex-col gap-2">
            <label className="block text-sm font-medium text-gray-700">
              추가할 요일 선택
            </label>
            <div className="flex flex-wrap gap-2">
              {[
                { value: 0, label: "일" },
                { value: 1, label: "월" },
                { value: 2, label: "화" },
                { value: 3, label: "수" },
                { value: 4, label: "목" },
                { value: 5, label: "금" },
                { value: 6, label: "토" },
              ].map((day) => (
                <button
                  key={day.value}
                  type="button"
                  onClick={() => toggleWeekday(day.value)}
                  className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                    selectedWeekdays.includes(day.value)
                      ? "bg-indigo-600 text-white"
                      : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                  }`}
                >
                  {day.label}요일
                </button>
              ))}
            </div>
            {selectedWeekdays.length === 0 && (
              <p className="text-xs text-amber-600">
                추가할 요일을 최소 1개 이상 선택해주세요.
              </p>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                시작 시간
              </label>
              <input
                type="time"
                name="start_time"
                value={startTime}
                onChange={(e) => setStartTime(e.target.value)}
                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                required
              />
            </div>

            <div className="flex flex-col gap-2">
              <label className="block text-sm font-medium text-gray-700">
                종료 시간
              </label>
              <input
                type="time"
                name="end_time"
                value={endTime}
                onChange={(e) => setEndTime(e.target.value)}
                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                required
              />
            </div>
          </div>

          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-800">
              💡 <strong>팁:</strong> 선택한 요일들에 동일한 시간 블록이 일괄 추가됩니다.
            </p>
          </div>

          <div className="flex gap-2">
            <button
              type="submit"
              disabled={
                isPending ||
                selectedWeekdays.length === 0 ||
                !startTime ||
                !endTime
              }
              className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isPending ? "저장 중..." : "블록 추가하기"}
            </button>
            {onClose && (
              <button
                type="button"
                onClick={onClose}
                disabled={isPending}
                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50"
              >
                취소
              </button>
            )}
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="admin/time-management/[templateId]/_components/TemplateBlockSetManagement.tsx">
"use client";

import { useEffect, useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import TemplateBlocksViewer from "./TemplateBlocksViewer";

type BlockSet = {
  id: string;
  name: string;
  description?: string | null;
  blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
};

type TemplateBlockSetManagementProps = {
  templateId: string;
  initialBlockSets?: Array<{ 
    id: string; 
    name: string; 
    description?: string | null;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }> 
  }>;
  selectedBlockSetId?: string | null;
};

export default function TemplateBlockSetManagement({
  templateId,
  initialBlockSets = [],
  selectedBlockSetId = null,
}: TemplateBlockSetManagementProps) {
  const router = useRouter();
  const [blockSets, setBlockSets] = useState<BlockSet[]>(initialBlockSets.map(set => ({
    id: set.id,
    name: set.name,
    description: set.description ?? null,
    blocks: set.blocks ?? [],
  })));
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // 특정 세트의 블록만 업데이트
  const updateSetBlocks = useCallback(async (setId: string) => {
    try {
      const { getTenantBlockSets } = await import("@/app/(admin)/actions/tenantBlockSets");
      const data = await getTenantBlockSets();
      
      const updatedSet = data.find(s => s.id === setId);
      if (updatedSet) {
        setBlockSets((prevSets) =>
          prevSets.map((set) =>
            set.id === setId
              ? { ...set, blocks: updatedSet.blocks ?? [] }
              : set
          )
        );
      }
    } catch (error) {
      console.error(`세트 ${setId}의 블록 조회 실패:`, error);
    }
  }, []);

  // 전체 데이터 로드
  const loadData = useCallback(async (skipLoadingState = false) => {
    try {
      if (!skipLoadingState) {
        setIsLoading(true);
        setError(null);
      }

      const { getTenantBlockSets } = await import("@/app/(admin)/actions/tenantBlockSets");
      const { getTemplateBlockSet } = await import("@/app/(admin)/actions/campTemplateBlockSets");
      
      // 모든 테넌트 블록 세트 조회
      const data = await getTenantBlockSets();
      
      // 템플릿에 연결된 블록 세트 조회
      const linkedBlockSet = await getTemplateBlockSet(templateId);
      let allBlockSets = data;
      
      if (linkedBlockSet) {
        // 연결된 블록 세트가 목록에 없으면 추가
        const hasBlockSet = data.some(set => set.id === linkedBlockSet.id);
        if (!hasBlockSet) {
          allBlockSets = [linkedBlockSet, ...data];
        }
      }

      const updatedSets = (allBlockSets || []).map(set => ({
        id: set.id,
        name: set.name,
        description: null,
        blocks: set.blocks ?? [],
      }));

      setBlockSets(updatedSets);
      setError(null);
    } catch (error: any) {
      console.error("블록 데이터 로드 실패:", error);
      const errorMessage = error?.message || "블록 데이터를 불러오는 중 오류가 발생했습니다.";
      setError(errorMessage);
    } finally {
      if (!skipLoadingState) {
        setIsLoading(false);
      }
    }
  }, [templateId]);

  // 초기 마운트 시 서버 데이터 사용
  useEffect(() => {
    if (initialBlockSets.length === 0) {
      loadData(true);
    }
  }, [loadData, initialBlockSets.length]);

  return (
    <div>
      {/* 에러 메시지 */}
      {error && (
        <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0">
              <span className="text-2xl">⚠️</span>
            </div>
            <div className="flex flex-col gap-3 flex-1">
              <h3 className="text-sm font-semibold text-red-800">
                데이터 로드 실패
              </h3>
              <p className="text-sm text-red-700">{error}</p>
              <button
                type="button"
                onClick={() => loadData()}
                className="text-sm text-red-700 hover:text-red-900 underline font-medium"
              >
                다시 시도
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 블록 뷰어 */}
      <TemplateBlocksViewer 
        templateId={templateId}
        blocks={[]} 
        blockSets={blockSets} 
        selectedBlockSetId={selectedBlockSetId}
        isLoading={isLoading}
        onCreateSetSuccess={async () => {
          router.refresh();
        }}
        onBlockChange={updateSetBlocks}
        existingSetCount={blockSets.length}
      />
    </div>
  );
}
</file>

<file path="admin/time-management/[templateId]/_components/TemplateBlocksViewer.tsx">
"use client";

import { useMemo, useState, useActionState } from "react";
import { useRouter } from "next/navigation";
import TemplateBlockForm from "./TemplateBlockForm";
import { createTenantBlockSet } from "@/app/(admin)/actions/tenantBlockSets";
import { validateFormData, blockSetSchema } from "@/lib/validation/schemas";
import { useToast } from "@/components/ui/ToastProvider";

type BlockSet = {
  id: string;
  name: string;
  description?: string | null;
  blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
};

type TemplateBlocksViewerProps = {
  templateId: string | null; // null이면 템플릿에 연결되지 않은 블록 세트
  blocks: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  blockSets: BlockSet[];
  selectedBlockSetId: string | null;
  isLoading?: boolean;
  onCreateSetSuccess?: () => void;
  onBlockChange?: (setId: string) => Promise<void>;
  existingSetCount?: number;
};

const DAYS = ["일", "월", "화", "수", "목", "금", "토"];

export default function TemplateBlocksViewer({
  templateId,
  blocks,
  blockSets,
  selectedBlockSetId,
  isLoading = false,
  onCreateSetSuccess,
  onBlockChange,
  existingSetCount = 0,
}: TemplateBlocksViewerProps) {
  const router = useRouter();
  const toast = useToast();
  const [creating, setCreating] = useState(false);
  
  // 각 블록 세트별 총 시간 계산
  const blockSetsWithStats = useMemo(() => {
    return blockSets.map((set) => {
      const setBlocks = set.blocks ?? [];
      const totalMinutes = setBlocks.reduce((acc, block) => {
        const [startH, startM] = (block.start_time ?? "00:00").split(":").map(Number);
        const [endH, endM] = (block.end_time ?? "00:00").split(":").map(Number);
        const start = startH * 60 + startM;
        const end = endH * 60 + endM;
        const duration = end - start;
        return acc + (duration > 0 ? duration : 0);
      }, 0);

      const totalHours = Math.floor(totalMinutes / 60);
      const remainingMinutes = Math.max(0, totalMinutes % 60);

      // 요일별 블록 개수 계산
      const dayDistribution = setBlocks.reduce((acc, block) => {
        const day = DAYS[block.day_of_week] ?? "";
        acc[day] = (acc[day] || 0) + 1;
        return acc;
      }, {} as Record<string, number>);

      return {
        ...set,
        blockCount: setBlocks.length,
        totalHours,
        remainingMinutes,
        dayDistribution,
      };
    });
  }, [blockSets]);

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {[1, 2, 3].map((i) => (
          <div key={i} className="flex flex-col gap-4 bg-white border border-gray-200 rounded-lg p-6 animate-pulse">
            <div className="h-6 bg-gray-200 rounded w-3/4"></div>
            <div className="flex flex-col gap-2">
              <div className="h-4 bg-gray-200 rounded w-1/2"></div>
              <div className="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  return (
    <>
      {/* 새 세트 추가 폼 (모달) */}
      {creating && (
        <TemplateBlockSetCreateForm
          templateId={templateId}
          onSuccess={async (newSetId?: string) => {
            setCreating(false);
            if (newSetId && onBlockChange) {
              await onBlockChange(newSetId);
            }
            if (onCreateSetSuccess) {
              await onCreateSetSuccess();
            }
            router.refresh();
          }}
          onCancel={() => setCreating(false)}
          existingCount={existingSetCount}
        />
      )}

      {/* 블록 세트 목록 */}
      {blockSetsWithStats.length > 0 ? (
        <div className="flex flex-col gap-8">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-medium text-gray-900">등록된 블록 세트</h2>
            <button
              type="button"
              onClick={() => setCreating(true)}
              disabled={creating}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              + 새 세트 추가하기
            </button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {blockSetsWithStats.map((set) => (
              <div
                key={set.id}
                className={`bg-white border-2 rounded-lg p-6 transition-all hover:shadow-md flex flex-col ${
                  selectedBlockSetId === set.id
                    ? "border-indigo-500 bg-indigo-50"
                    : "border-gray-200 hover:border-gray-300"
                }`}
              >
                {/* 헤더 */}
                <div className="flex items-start justify-between">
                  <div className="flex flex-col gap-1 flex-1">
                    <h3 className="text-lg font-semibold text-gray-900">{set.name}</h3>
                    {selectedBlockSetId === set.id && (
                      <span className="inline-block px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 rounded">
                        선택됨
                      </span>
                    )}
                  </div>
                  <button
                    type="button"
                    onClick={async (e) => {
                      e.stopPropagation();
                      if (!confirm(`"${set.name}" 세트를 삭제하시겠습니까? 포함된 모든 블록도 함께 삭제됩니다.`)) {
                        return;
                      }
                      try {
                        const { deleteTenantBlockSet } = await import("@/app/(admin)/actions/tenantBlockSets");
                        const formData = new FormData();
                        formData.append("id", set.id);
                        await deleteTenantBlockSet(formData);
                        if (onCreateSetSuccess) {
                          await onCreateSetSuccess();
                        }
                        router.refresh();
                      } catch (error: any) {
                        toast.showError(error.message || "세트 삭제에 실패했습니다.");
                      }
                    }}
                    className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    title="세트 삭제"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      className="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      />
                    </svg>
                  </button>
                </div>

                {/* 설명 */}
                {set.description && (
                  <p className="text-sm text-gray-600">{set.description}</p>
                )}

                {/* 통계 정보 */}
                <div className="flex flex-col gap-2 flex-1">
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">블록 개수</span>
                    <span className="font-medium text-gray-900">{set.blockCount}개</span>
                  </div>
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-gray-600">주간 총 시간</span>
                    <span className="font-medium text-gray-900">
                      {set.totalHours}시간 {set.remainingMinutes}분
                    </span>
                  </div>
                  {set.blockCount > 0 && (
                    <div className="flex flex-col gap-1 pt-2 border-t border-gray-200">
                      <div className="text-xs text-gray-500">요일별 블록</div>
                      <div className="flex flex-wrap gap-1">
                        {Object.entries(set.dayDistribution).map(([day, count]) => (
                          <span
                            key={day}
                            className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded"
                          >
                            {day} {count}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* 액션 버튼들 - 하단 고정 */}
                <div className="flex gap-2 mt-auto">
                  {templateId && selectedBlockSetId !== set.id && (
                    <button
                      type="button"
                      onClick={async () => {
                        if (!confirm(`"${set.name}" 블록 세트를 이 템플릿에 연결하시겠습니까?`)) {
                          return;
                        }
                        try {
                          const { updateCampTemplateAction } = await import("@/app/(admin)/actions/campTemplateActions");
                          // 템플릿 조회
                          const { getCampTemplateById } = await import("@/app/(admin)/actions/campTemplateActions");
                          const templateResult = await getCampTemplateById(templateId);
                          if (!templateResult.success || !templateResult.template) {
                            throw new Error("템플릿을 찾을 수 없습니다.");
                          }
                          
                          // template_data 업데이트
                          const templateData = templateResult.template.template_data || {};
                          const updatedTemplateData = {
                            ...templateData,
                            block_set_id: set.id,
                          };
                          
                          const formData = new FormData();
                          formData.append("name", templateResult.template.name);
                          formData.append("program_type", templateResult.template.program_type);
                          formData.append("description", templateResult.template.description || "");
                          formData.append("status", templateResult.template.status);
                          formData.append("template_data", JSON.stringify(updatedTemplateData));
                          
                          const result = await updateCampTemplateAction(templateId, formData);
                          if (!result.success) {
                            throw new Error(result.error || "템플릿 업데이트에 실패했습니다.");
                          }
                          
                          toast.showSuccess("블록 세트가 템플릿에 연결되었습니다.");
                          router.refresh();
                        } catch (error: any) {
                          toast.showError(error.message || "블록 세트 연결에 실패했습니다.");
                        }
                      }}
                      className="flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                      선택하기
                    </button>
                  )}
                  {templateId ? (
                    <a
                      href={`/admin/time-management/${templateId}/${set.id}`}
                      className={`${selectedBlockSetId === set.id ? 'flex-1 ' : ''}block text-center px-4 py-2 text-sm font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors`}
                    >
                      상세 보기
                    </a>
                  ) : (
                    <a
                      href={`/admin/time-management/global/${set.id}`}
                      className={`${selectedBlockSetId === set.id ? 'flex-1 ' : ''}block text-center px-4 py-2 text-sm font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors`}
                    >
                      상세 보기
                    </a>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div className="flex flex-col gap-6 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center">
          <div className="mx-auto max-w-md">
            <div className="text-6xl">⏰</div>
            <h3 className="text-lg font-semibold text-gray-900">
              등록된 블록 세트가 없습니다
            </h3>
            <p className="text-sm text-gray-500">
              위의 버튼을 사용하여 블록 세트를 추가하세요.
            </p>
            <button
              type="button"
              onClick={() => setCreating(true)}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
            >
              + 새 세트 추가하기
            </button>
          </div>
        </div>
      )}
    </>
  );
}

// TemplateBlockSetCreateForm 컴포넌트
function TemplateBlockSetCreateForm({
  templateId,
  onSuccess,
  onCancel,
  existingCount,
}: {
  templateId: string | null; // null이면 템플릿에 연결되지 않은 블록 세트
  onSuccess: (newSetId?: string) => void | Promise<void>;
  onCancel: () => void;
  existingCount: number;
}) {
  const router = useRouter();
  const toast = useToast();
  const [selectedWeekdays, setSelectedWeekdays] = useState<number[]>([]);
  const [startTime, setStartTime] = useState<string>("");
  const [endTime, setEndTime] = useState<string>("");
  
  const [state, formAction, isPending] = useActionState(
    async (_prev: { error: string | null }, formData: FormData) => {
      try {
        // 세트 생성
        const validation = validateFormData(formData, blockSetSchema);
        if (!validation.success) {
          const firstError = validation.errors.issues[0];
          return { error: firstError?.message || "입력값이 올바르지 않습니다." };
        }

        // template_id는 더 이상 필요 없음 (tenant_id만 사용)
        const result = await createTenantBlockSet(formData);
        
        // 시간 블록이 입력된 경우 추가
        if (selectedWeekdays.length > 0 && startTime && endTime) {
          const { addTenantBlock } = await import("@/app/(admin)/actions/tenantBlockSets");
          for (const day of selectedWeekdays) {
            const blockFormData = new FormData();
            blockFormData.append("day", String(day));
            blockFormData.append("start_time", startTime);
            blockFormData.append("end_time", endTime);
            blockFormData.append("block_set_id", result.blockSetId);
            
            try {
              await addTenantBlock(blockFormData);
            } catch (blockError: any) {
              console.warn("블록 추가 실패:", blockError);
            }
          }
        }
        
        router.refresh();
        onSuccess(result.blockSetId);
        return { error: null };
      } catch (err: any) {
        return { error: err.message || "세트 생성에 실패했습니다." };
      }
    },
    { error: null }
  );

  const toggleWeekday = (day: number) => {
    setSelectedWeekdays((prev) =>
      prev.includes(day) ? prev.filter((d) => d !== day) : [...prev, day]
    );
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="flex flex-col gap-4 bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-lg">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-900">새 블록 세트 추가</h3>
          <button
            type="button"
            onClick={onCancel}
            className="text-gray-400 hover:text-gray-600 transition-colors"
            disabled={isPending}
          >
            <span className="text-2xl">×</span>
          </button>
        </div>
        
        <form action={formAction} className="flex flex-col gap-4">
          {state.error && (
            <p className="text-sm text-red-600 bg-red-50 p-2 rounded">{state.error}</p>
          )}

          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-gray-700">세트 이름</label>
            <input
              type="text"
              name="name"
              placeholder="예: 기본 시간표"
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
              required
              maxLength={100}
            />
          </div>

          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-gray-700">설명 (선택)</label>
            <textarea
              name="description"
              placeholder="세트에 대한 설명을 입력하세요"
              className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
              rows={2}
              maxLength={500}
            />
          </div>

          <div className="flex flex-col gap-3 border-t border-gray-200 pt-4">
            <h4 className="text-sm font-medium text-gray-700">시간 블록 추가 (선택)</h4>
            
            <div className="flex flex-col gap-2">
              <label className="text-sm font-medium text-gray-700">추가할 요일 선택</label>
              <div className="flex flex-wrap gap-2">
                {[
                  { value: 0, label: "일" },
                  { value: 1, label: "월" },
                  { value: 2, label: "화" },
                  { value: 3, label: "수" },
                  { value: 4, label: "목" },
                  { value: 5, label: "금" },
                  { value: 6, label: "토" },
                ].map((day) => (
                  <button
                    key={day.value}
                    type="button"
                    onClick={() => toggleWeekday(day.value)}
                    className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                      selectedWeekdays.includes(day.value)
                        ? "bg-indigo-600 text-white"
                        : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                    }`}
                  >
                    {day.label}요일
                  </button>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">시작 시간</label>
                <input
                  type="time"
                  value={startTime}
                  onChange={(e) => setStartTime(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>

              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">종료 시간</label>
                <input
                  type="time"
                  value={endTime}
                  onChange={(e) => setEndTime(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
            </div>
          </div>

          <div className="flex gap-2">
            <button
              type="submit"
              disabled={isPending}
              className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50"
            >
              {isPending ? "생성 중..." : "생성"}
            </button>
            <button
              type="button"
              onClick={onCancel}
              disabled={isPending}
              className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors disabled:opacity-50"
            >
              취소
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="admin/time-management/[templateId]/[setId]/_components/TemplateBlockSetDetail.tsx">
"use client";

import { useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import TemplateBlockForm from "../../_components/TemplateBlockForm";
import { useToast } from "@/components/ui/ToastProvider";

type TemplateBlockSetDetailProps = {
  templateId: string | null; // null이면 템플릿에 연결되지 않은 블록 세트
  blockSet: {
    id: string;
    name: string;
    description?: string | null;
  };
  blocks: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  isSelected: boolean;
};

const weekdayLabels = ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"];

export default function TemplateBlockSetDetail({
  templateId,
  blockSet,
  blocks,
  isSelected,
}: TemplateBlockSetDetailProps) {
  const router = useRouter();
  const toast = useToast();
  const [showBlockForm, setShowBlockForm] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);

  const handleBlockChange = useCallback(async () => {
    router.refresh();
  }, [router]);

  const handleDelete = async () => {
    if (!confirm(`"${blockSet.name}" 세트를 삭제하시겠습니까? 포함된 모든 블록도 함께 삭제됩니다.`)) {
      return;
    }

    setIsDeleting(true);
    try {
      const { deleteTenantBlockSet } = await import("@/app/(admin)/actions/tenantBlockSets");
      const formData = new FormData();
      formData.append("id", blockSet.id);
      await deleteTenantBlockSet(formData);
      toast.showSuccess("블록 세트가 삭제되었습니다.");
      if (templateId) {
        router.push(`/admin/time-management/${templateId}`);
      } else {
        router.push("/admin/time-management");
      }
    } catch (error: any) {
      toast.showError(error.message || "블록 세트 삭제에 실패했습니다.");
      setIsDeleting(false);
    }
  };

  const handleBlockDelete = async (blockId: string) => {
    if (!confirm("이 블록을 삭제하시겠습니까?")) {
      return;
    }

    try {
      const { deleteTenantBlock } = await import("@/app/(admin)/actions/tenantBlockSets");
      const formData = new FormData();
      formData.append("id", blockId);
      await deleteTenantBlock(formData);
      toast.showSuccess("블록이 삭제되었습니다.");
      router.refresh();
    } catch (error: any) {
      toast.showError(error.message || "블록 삭제에 실패했습니다.");
    }
  };

  return (
    <div className="flex flex-col gap-6">
      {/* 블록 세트 정보 */}
      <div className="flex flex-col gap-6 rounded-lg border border-gray-200 bg-white p-6">
        <div className="flex items-start justify-between">
          <div className="flex flex-col gap-2 flex-1">
            <div className="flex items-center gap-3">
              <h2 className="text-xl font-semibold text-gray-900">{blockSet.name}</h2>
              {isSelected && (
                <span className="inline-block px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 rounded">
                  선택됨
                </span>
              )}
            </div>
            {blockSet.description && (
              <p className="text-sm text-gray-600">{blockSet.description}</p>
            )}
          </div>
          <button
            type="button"
            onClick={handleDelete}
            disabled={isDeleting}
            className="px-4 py-2 text-sm font-medium text-red-700 bg-red-50 rounded-lg hover:bg-red-100 transition-colors disabled:opacity-50"
          >
            {isDeleting ? "삭제 중..." : "세트 삭제"}
          </button>
        </div>

        {/* 블록 목록 */}
        <div className="flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-medium text-gray-900">시간 블록</h3>
            <button
              type="button"
              onClick={() => setShowBlockForm(true)}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
            >
              + 블록 추가
            </button>
          </div>

          {blocks.length > 0 ? (
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {blocks.map((block) => (
                <div
                  key={block.id}
                  className="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 px-4 py-3"
                >
                  <div>
                    <div className="text-sm font-medium text-gray-900">
                      {weekdayLabels[block.day_of_week]}
                    </div>
                    <div className="text-xs text-gray-600">
                      {block.start_time} ~ {block.end_time}
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => handleBlockDelete(block.id)}
                    className="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                    title="블록 삭제"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      className="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              ))}
            </div>
          ) : (
            <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
              <p className="text-sm text-gray-500">등록된 시간 블록이 없습니다.</p>
            </div>
          )}
        </div>
      </div>

      {/* 블록 추가 폼 */}
      {showBlockForm && (
        <TemplateBlockForm
          blockSetId={blockSet.id}
          onClose={() => setShowBlockForm(false)}
          onBlockChange={handleBlockChange}
        />
      )}
    </div>
  );
}
</file>

<file path="admin/time-management/[templateId]/[setId]/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getCampTemplateById } from "@/app/(admin)/actions/campTemplateActions";
import TemplateBlockSetDetail from "./_components/TemplateBlockSetDetail";
import Link from "next/link";

type PageProps = {
  params: Promise<{ templateId: string; setId: string }>;
};

export default async function TemplateBlockSetDetailPage({ params }: PageProps) {
  const { templateId, setId } = await params;
  
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  // 템플릿 조회 및 권한 확인
  const result = await getCampTemplateById(templateId);
  if (!result.success || !result.template) {
    redirect(`/admin/time-management/${templateId}`);
  }

  const supabase = await createSupabaseServerClient();

  // 연결 테이블에서 템플릿에 연결된 블록 세트 확인
  const { data: templateBlockSetLink } = await supabase
    .from("camp_template_block_sets")
    .select("tenant_block_set_id")
    .eq("camp_template_id", templateId)
    .eq("tenant_block_set_id", setId)
    .maybeSingle();

  if (!templateBlockSetLink) {
    redirect(`/admin/time-management/${templateId}`);
  }

  // 테넌트 블록 세트 조회
  const { data: blockSet, error: setError } = await supabase
    .from("tenant_block_sets")
    .select("id, name, description")
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (setError || !blockSet) {
    redirect(`/admin/time-management/${templateId}`);
  }

  // 해당 세트의 블록 조회
  const { data: blocks, error: blocksError } = await supabase
    .from("tenant_blocks")
    .select("id, day_of_week, start_time, end_time")
    .eq("tenant_block_set_id", setId)
    .order("day_of_week", { ascending: true })
    .order("start_time", { ascending: true });

  if (blocksError) {
    console.error("블록 조회 실패:", blocksError);
  }

  // 템플릿 데이터에서 선택된 블록 세트 확인
  const templateData = result.template.template_data;
  const isSelected = templateData?.block_set_id === setId;

  return (
    <section className="mx-auto max-w-7xl px-4 py-8 md:py-10">
      <div className="flex flex-col gap-4">
        <div className="flex items-center gap-3">
          <Link
            href={`/admin/time-management/${templateId}`}
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            ← 시간 관리
          </Link>
        </div>
        <div className="flex flex-col gap-1">
          <h1 className="text-2xl font-semibold text-gray-900">블록 세트 상세</h1>
          <p className="text-sm text-gray-500">
            템플릿: {result.template.name}
          </p>
        </div>
      </div>
      <TemplateBlockSetDetail
        templateId={templateId}
        blockSet={blockSet}
        blocks={(blocks as Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>) ?? []}
        isSelected={isSelected}
      />
    </section>
  );
}
</file>

<file path="admin/time-management/[templateId]/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getCampTemplateById } from "@/app/(admin)/actions/campTemplateActions";
import { getTenantBlockSets } from "@/app/(admin)/actions/tenantBlockSets";
import { getTemplateBlockSet } from "@/app/(admin)/actions/campTemplateBlockSets";
import TemplateBlockSetManagement from "./_components/TemplateBlockSetManagement";
import Link from "next/link";

type TimeManagementPageProps = {
  params: Promise<{ templateId: string }>;
};

export default async function TimeManagementPage({
  params,
}: TimeManagementPageProps) {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const { templateId } = await params;
  const tenantContext = await getTenantContext();
  
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  // 템플릿 조회 및 권한 확인
  const result = await getCampTemplateById(templateId);
  if (!result.success || !result.template) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">템플릿을 찾을 수 없습니다.</p>
        </div>
      </section>
    );
  }

  const template = result.template;

  // 모든 테넌트 블록 세트 목록 조회
  let blockSets: Array<{
    id: string;
    name: string;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  }> = [];

  try {
    blockSets = await getTenantBlockSets();
  } catch (error) {
    console.error("블록 세트 조회 실패:", error);
  }

  // 템플릿에 연결된 블록 세트 조회
  let selectedBlockSetId: string | null = null;
  try {
    const linkedBlockSet = await getTemplateBlockSet(templateId);
    if (linkedBlockSet) {
      selectedBlockSetId = linkedBlockSet.id;
      // 연결된 블록 세트가 blockSets에 없으면 추가
      const hasBlockSet = blockSets.some(set => set.id === linkedBlockSet.id);
      if (!hasBlockSet) {
        blockSets = [linkedBlockSet, ...blockSets];
      }
    }
  } catch (error) {
    console.error("템플릿 블록 세트 조회 실패:", error);
  }

  return (
    <section className="mx-auto w-full max-w-7xl px-4 py-8 md:py-10">
      <div className="mb-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <div className="flex items-center gap-3 mb-2">
              <Link
                href="/admin/time-management"
                className="text-sm text-gray-500 hover:text-gray-700"
              >
                ← 시간 관리 목록
              </Link>
            </div>
            <h1 className="text-2xl font-semibold text-gray-900">시간 관리</h1>
            <p className="mt-1 text-sm text-gray-500">
              템플릿: {template.name}
            </p>
          </div>
        </div>
        <p className="text-sm text-gray-600">
          템플릿에 사용할 블록 세트를 생성하고 관리할 수 있습니다.
        </p>
      </div>

      <TemplateBlockSetManagement
        templateId={templateId}
        initialBlockSets={blockSets}
        selectedBlockSetId={selectedBlockSetId}
      />
    </section>
  );
}
</file>

<file path="admin/time-management/global/[setId]/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import TemplateBlockSetDetail from "../../[templateId]/[setId]/_components/TemplateBlockSetDetail";
import Link from "next/link";

type PageProps = {
  params: Promise<{ setId: string }>;
};

export default async function GlobalBlockSetDetailPage({ params }: PageProps) {
  const { setId } = await params;
  
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    redirect("/login");
  }

  const supabase = await createSupabaseServerClient();

  // 테넌트 블록 세트 조회
  const { data: blockSet, error: setError } = await supabase
    .from("tenant_block_sets")
    .select("id, name, description")
    .eq("id", setId)
    .eq("tenant_id", tenantContext.tenantId)
    .single();

  if (setError || !blockSet) {
    redirect("/admin/time-management");
  }

  // 해당 세트의 블록 조회
  const { data: blocks, error: blocksError } = await supabase
    .from("tenant_blocks")
    .select("id, day_of_week, start_time, end_time")
    .eq("tenant_block_set_id", setId)
    .order("day_of_week", { ascending: true })
    .order("start_time", { ascending: true });

  if (blocksError) {
    console.error("블록 조회 실패:", blocksError);
  }

  return (
    <section className="mx-auto max-w-7xl px-4 py-8 md:py-10">
      <div className="flex flex-col gap-4">
        <div className="flex items-center gap-3">
          <Link
            href="/admin/time-management"
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            ← 시간 관리
          </Link>
        </div>
        <div className="flex flex-col gap-1">
          <h1 className="text-2xl font-semibold text-gray-900">블록 세트 상세</h1>
          <p className="text-sm text-gray-500">
            템플릿에 연결되지 않은 블록 세트
          </p>
        </div>
      </div>
      <TemplateBlockSetDetail
        templateId={null}
        blockSet={blockSet}
        blocks={(blocks as Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>) ?? []}
        isSelected={false}
      />
    </section>
  );
}
</file>

<file path="admin/time-management/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantContext } from "@/lib/tenant/getTenantContext";
import { getTenantBlockSets } from "@/app/(admin)/actions/tenantBlockSets";
import TemplateBlockSetManagement from "./_components/TemplateBlockSetManagement";

export default async function TimeManagementPage() {
  const { role } = await getCurrentUserRole();
  if (role !== "admin" && role !== "consultant") {
    redirect("/login");
  }

  const tenantContext = await getTenantContext();
  if (!tenantContext?.tenantId) {
    return (
      <section className="mx-auto w-full max-w-6xl px-4 py-10">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <p className="text-red-800">기관 정보를 찾을 수 없습니다.</p>
        </div>
      </section>
    );
  }

  // 모든 테넌트 블록 세트 목록 조회
  let blockSets: Array<{
    id: string;
    name: string;
    blocks?: Array<{ id: string; day_of_week: number; start_time: string; end_time: string }>;
  }> = [];

  try {
    blockSets = await getTenantBlockSets();
  } catch (error) {
    console.error("블록 세트 조회 실패:", error);
  }

  return (
    <section className="mx-auto w-full max-w-7xl px-4 py-8 md:py-10">
      <div className="flex flex-col gap-1">
        <h1 className="text-2xl font-semibold text-gray-900">시간 블록 관리</h1>
        <p className="text-sm text-gray-500">
          블록 세트를 생성하고 관리할 수 있습니다. 템플릿을 생성하지 않아도 시간 블록을 생성할 수 있습니다.
        </p>
      </div>

      <TemplateBlockSetManagement
        initialBlockSets={blockSets}
      />
    </section>
  );
}
</file>

<file path="admin/tools/_components/ToolCard.tsx">
"use client";

import { memo } from "react";
import { cn } from "@/lib/cn";

export type ToolCardProps = {
  icon: string;
  title: string;
  description: string;
  buttonText: string;
  buttonDisabled?: boolean;
  onButtonClick?: () => void;
};

function ToolCardComponent({
  icon,
  title,
  description,
  buttonText,
  buttonDisabled = false,
  onButtonClick,
}: ToolCardProps) {
  return (
    <div className="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div className="flex flex-col gap-4">
        <div className="text-2xl">{icon}</div>
        <div className="flex flex-col gap-2">
          <h2 className="text-lg font-semibold text-gray-900">{title}</h2>
          <p className="text-sm text-gray-500">{description}</p>
        </div>
        <button
          onClick={onButtonClick}
          disabled={buttonDisabled}
          className={cn(
            "rounded-lg px-4 py-2 text-sm font-medium transition-colors",
            buttonDisabled
              ? "bg-gray-100 text-gray-500 cursor-not-allowed"
              : "bg-indigo-600 text-white hover:bg-indigo-700"
          )}
        >
          {buttonText}
        </button>
      </div>
    </div>
  );
}

export const ToolCard = memo(ToolCardComponent);
export default ToolCard;
</file>

<file path="admin/tools/page.tsx">
export const dynamic = 'force-dynamic';

import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { isAdminRole } from "@/lib/auth/isAdminRole";
import { PageHeader } from "@/components/layout/PageHeader";
import { ToolCard } from "./_components/ToolCard";

export default async function AdminToolsPage() {
  const { userId, role } = await getCurrentUserRole();

  if (!userId || !isAdminRole(role)) {
    redirect("/login");
  }

  return (
    <div className="p-6 md:p-10">
      <div className="flex flex-col gap-6">
        <PageHeader
          title="관리 도구"
          description="학생 관리와 데이터 처리를 위한 도구를 사용하세요"
        />

        <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
          <ToolCard
            icon="📋"
            title="플랜 대량 생성"
            description="여러 학생에게 동일한 플랜을 일괄 생성합니다."
            buttonText="준비 중"
            buttonDisabled={true}
          />

          <ToolCard
            icon="📊"
            title="성적 일괄 입력"
            description="엑셀 파일을 업로드하여 여러 학생의 성적을 한 번에 입력합니다."
            buttonText="준비 중"
            buttonDisabled={true}
          />

          <ToolCard
            icon="🎯"
            title="목표 관리 도우미"
            description="학생별 목표를 효율적으로 생성하고 관리합니다."
            buttonText="준비 중"
            buttonDisabled={true}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="error.tsx">
"use client";

import { useEffect } from "react";
import { ErrorState } from "@/components/ui/ErrorState";

type ErrorProps = {
  error: Error & { digest?: string };
  reset: () => void;
};

export default function Error({ error, reset }: ErrorProps) {
  useEffect(() => {
    console.error("[admin] 에러 발생", error);
  }, [error]);

  return (
    <div className="mx-auto max-w-6xl px-4 py-10">
      <ErrorState
        title="오류가 발생했습니다"
        message={error.message || "예상치 못한 오류가 발생했습니다."}
        onRetry={reset}
        retryLabel="다시 시도"
        actionHref="/admin/dashboard"
        actionLabel="대시보드로 돌아가기"
      />
    </div>
  );
}
</file>

<file path="layout.tsx">
export const dynamic = 'force-dynamic';

import { ReactNode } from "react";
import { redirect } from "next/navigation";
import { getCurrentUserRole } from "@/lib/auth/getCurrentUserRole";
import { getTenantInfo } from "@/lib/auth/getTenantInfo";
import { RoleBasedLayout } from "@/components/layout/RoleBasedLayout";

export default async function AdminLayout({ children }: { children: ReactNode }) {
  const { userId, role } = await getCurrentUserRole();

  // 로그인 체크만 수행 (각 페이지에서 필요한 권한 체크)
  if (!userId) {
    redirect("/login");
  }

  // 학생인 경우 사이드바와 네비게이션 숨김 (마스터 교재/강의 조회용)
  const isStudent = role === "student";
  const displayRole = role === "consultant" ? "consultant" : "admin";

  // 기관 정보 조회 (Admin/Consultant인 경우)
  const tenantInfo = role === "admin" || role === "consultant" 
    ? await getTenantInfo() 
    : null;

  return (
    <RoleBasedLayout
      role={displayRole}
      dashboardHref="/admin/dashboard"
      roleLabel="Admin"
      showSidebar={!isStudent}
      tenantInfo={tenantInfo}
    >
      {children}
    </RoleBasedLayout>
  );
}
</file>

<file path="loading.tsx">
import { LoadingSkeleton } from "@/components/ui/LoadingSkeleton";

export default function Loading() {
  return (
    <div className="mx-auto max-w-6xl px-4 py-10">
      <LoadingSkeleton />
    </div>
  );
}
</file>

<file path="studentData.ts">
import { createSupabaseServerClient } from "@/lib/supabase/server";
import { getPlansForStudent } from "@/lib/data/studentPlans";
import { getBooks, getLectures, getCustomContents } from "@/lib/data/studentContents";
import { getSessionsInRange } from "@/lib/data/studentSessions";
import { getGoalsForStudent } from "@/lib/data/studentGoals";
import { getWeeklyStudyTimeSummary, getWeeklyPlanSummary } from "@/lib/reports/weekly";
import { getMonthlyReportData } from "@/lib/reports/monthly";

type SupabaseServerClient = Awaited<ReturnType<typeof createSupabaseServerClient>>;

/**
 * 관리자용: 학생의 플랜 목록 조회
 */
export async function getStudentPlansForAdmin(
  studentId: string,
  dateRange?: { start: string; end: string }
) {
  try {
    const filters: Parameters<typeof getPlansForStudent>[0] = {
      studentId,
      tenantId: null,
    };

    if (dateRange) {
      filters.dateRange = dateRange;
    }

    return await getPlansForStudent(filters);
  } catch (error) {
    console.error("[admin/studentData] 플랜 조회 실패", error);
    return [];
  }
}

/**
 * 관리자용: 학생의 학습시간 조회
 */
export async function getStudentStudyTimeForAdmin(
  studentId: string,
  dateRange: { start: Date; end: Date }
) {
  try {
    const supabase = await createSupabaseServerClient();
    return await getWeeklyStudyTimeSummary(supabase, studentId, dateRange.start, dateRange.end);
  } catch (error) {
    console.error("[admin/studentData] 학습시간 조회 실패", error);
    return {
      totalSeconds: 0,
      totalMinutes: 0,
      totalHours: 0,
      byDay: [],
      bySubject: [],
      byContentType: [],
    };
  }
}

/**
 * 관리자용: 학생의 콘텐츠 사용 현황 조회
 */
export async function getStudentContentUsageForAdmin(studentId: string) {
  try {
    const supabase = await createSupabaseServerClient();
    const [books, lectures, customContents] = await Promise.allSettled([
      getBooks(studentId, null),
      getLectures(studentId, null),
      getCustomContents(studentId, null),
    ]);

    // 진행률 조회
    const { data: progressData, error: progressError } = await supabase
      .from("student_content_progress")
      .select("content_type,content_id,progress,completed_amount")
      .eq("student_id", studentId);

    const progressMap = new Map<string, { progress: number; completedAmount: number }>();
    if (!progressError && progressData) {
      progressData.forEach((p) => {
        if (p.content_type && p.content_id) {
          const key = `${p.content_type}:${p.content_id}`;
          progressMap.set(key, {
            progress: p.progress ?? 0,
            completedAmount: p.completed_amount ?? 0,
          });
        }
      });
    }

    return {
      books: books.status === "fulfilled" ? books.value : [],
      lectures: lectures.status === "fulfilled" ? lectures.value : [],
      customContents: customContents.status === "fulfilled" ? customContents.value : [],
      progressMap,
    };
  } catch (error) {
    console.error("[admin/studentData] 콘텐츠 사용 현황 조회 실패", error);
    return {
      books: [],
      lectures: [],
      customContents: [],
      progressMap: new Map(),
    };
  }
}

/**
 * 관리자용: 학생의 성적 변화 조회
 */
export async function getStudentScoreTrendForAdmin(studentId: string) {
  try {
    const supabase = await createSupabaseServerClient();

    // 내신 성적 조회
    const { data: schoolScores, error: schoolError } = await supabase
      .from("student_internal_scores") // student_school_scores → student_internal_scores
      .select("id,grade,semester,subject_name,grade_score,test_date")
      .eq("student_id", studentId)
      .order("test_date", { ascending: true });

    // 모의고사 성적 조회
    const { data: mockScores, error: mockError } = await supabase
      .from("student_mock_scores")
      .select("id,grade,subject_name,grade_score,test_date,exam_type")
      .eq("student_id", studentId)
      .order("test_date", { ascending: true });

    return {
      schoolScores: schoolError ? [] : (schoolScores ?? []),
      mockScores: mockError ? [] : (mockScores ?? []),
    };
  } catch (error) {
    console.error("[admin/studentData] 성적 변화 조회 실패", error);
    return {
      schoolScores: [],
      mockScores: [],
    };
  }
}

/**
 * 관리자용: 학생의 분석 리포트 조회
 */
export async function getStudentAnalysisForAdmin(studentId: string) {
  try {
    const supabase = await createSupabaseServerClient();

    // 이번 주 날짜 범위
    const today = new Date();
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() + mondayOffset);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);

    // 이번 달 날짜 범위
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    monthStart.setHours(0, 0, 0, 0);

    const [weeklyStudyTime, weeklyPlanSummary, monthlyReport] = await Promise.allSettled([
      getWeeklyStudyTimeSummary(supabase, studentId, weekStart, weekEnd),
      getWeeklyPlanSummary(supabase, studentId, weekStart, weekEnd),
      getMonthlyReportData(supabase, studentId, today),
    ]);

    // 위험 분석 조회
    const { data: riskAnalysis, error: riskError } = await supabase
      .from("student_analysis")
      .select("subject,risk_score,recent_grade_trend,consistency_score,mastery_estimate")
      .eq("student_id", studentId)
      .order("risk_score", { ascending: false });

    return {
      weeklyStudyTime:
        weeklyStudyTime.status === "fulfilled" ? weeklyStudyTime.value : null,
      weeklyPlanSummary:
        weeklyPlanSummary.status === "fulfilled" ? weeklyPlanSummary.value : null,
      monthlyReport: monthlyReport.status === "fulfilled" ? monthlyReport.value : null,
      riskAnalysis: riskError ? [] : (riskAnalysis ?? []),
    };
  } catch (error) {
    console.error("[admin/studentData] 분석 리포트 조회 실패", error);
    return {
      weeklyStudyTime: null,
      weeklyPlanSummary: null,
      monthlyReport: null,
      riskAnalysis: [],
    };
  }
}
</file>

</files>
